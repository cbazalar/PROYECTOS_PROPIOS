CREATE OR REPLACE PACKAGE "IMP_PKG_PROCE_LASER" AS

CODIGO_CANAL VARCHAR2(10) := 'VD';
CODIGO_MARCA VARCHAR2(10) := 'T';

w_filas               NUMBER := 1000;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2);
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO.
Fecha Creacion      : 22/11/2010
Fecha Modificacion  : 22/11/2010
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2);
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO.
Fecha Creacion      : 22/11/2010
Fecha Modificacion  : 22/11/2010
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2_PERF(oidSolicitud NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2);
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_oidZona NUMBER
                                   , p_fechaFacturacion IN VARCHAR2);
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU3_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_fechaFacturacion IN VARCHAR2
                                   , p_oidZona NUMBER);
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU4_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_fechaFacturacion IN VARCHAR2
                                   , p_oidZona NUMBER);

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada para mejorar performance.
Fecha Creacion      : 25/01/2011
Fecha Modificacion  : 25/01/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU_PERF(oidSolicitud NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de consolidado modificado por Performance.
Fecha Creacion      : 25/01/2011
Fecha Modificacion  : 25/01/2011
Autor               : Jorge Yepez Reyez - jyepez@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU_ZONA(oidZona NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2, p_fechaFacturacion IN VARCHAR2);


/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el detalle de factura laser.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/


PROCEDURE IMP_PR_REEMP_CARAC_DETAL_FACTU;

/**************************************************************************
Descripcion         : Genera el archivo laser de detalles de factura.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_DETAL_FACTU(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_CCC(p_codigoPais IN VARCHAR2,
                                 p_codigoPeriodo IN VARCHAR2,
                                 p_fechaFacturacion IN VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_CCC_Z(p_codigoPais IN VARCHAR2,
                                 p_codigoPeriodo IN VARCHAR2,
                                 p_fechaFacturacion IN VARCHAR2,
                                 p_oidzona IN NUMBER);
/**************************************************************************
Descripcion         : Genera el archivo laser de detalles de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_DETAL_CCC(p_codigoPais VARCHAR2,
                                       p_nombreArchivo VARCHAR2,
                                       p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el Ultimas Noticias Privilege.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_PRIVI;

/**************************************************************************
Descripcion         : Genera el archivo laser de Ultimas Noticias Privilege.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_PRIVI(p_codigoPais VARCHAR2,
                                   p_nombreArchivo VARCHAR2,
                                   p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que prepara la informacion del paquete
                      documentario generado por SiCC haciendo minimas
                      transformaciones.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el paquete documentario.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_PAQUE_DOCUM;

/**************************************************************************
Descripcion         : Genera el archivo laser del paquete documentario.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_PAQUE_DOCUM(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Genera la boleta de despacho
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_BODES(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);

/**************************************************************************
Descripcion         : Genera la boleta de despacho
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_BDE_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona NUMBER);


/**************************************************************************
Descripcion         : Genera de orden de compra simplificada
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_OCS(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);
/**************************************************************************
Descripcion         : Genera de orden de compra simplificada
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_OCS_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona NUMBER);

/***************************************************************************
Descripcion       : Proceso que genera los cupones de las consultoras que
                    han pasado pedido en un periodo y fecha particular.
Fecha Creacion    : 31/03/2010
Autor             : Carlos Hurtado Ramirez
***************************************************************************/
PROCEDURE IMP_PR_GENER_PAQUE_DOCUM_CUPON(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);

/***************************************************************************
Descripcion       : Proceso que genera los cupones de las consultoras que
                    han pasado pedido en un periodo y fecha particular.
Fecha Creacion    : 31/03/2010
Autor             : Carlos Hurtado Ramirez
***************************************************************************/
PROCEDURE IMP_PR_GENER_PAQUE_DOCUM_CUP_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_oidzona NUMBER,
                                         p_fechaFacturacion VARCHAR2);

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACTU(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FAC_P(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FAC_V(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACV2(p_oidsoli NUMBER);
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACBO(p_oidsoli NUMBER);
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACDL(p_oidsoli NUMBER);
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACP2(p_oidsoli NUMBER);
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACG2(p_oidsoli NUMBER);

/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CREDI(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRD_P(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRD_V(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDV2(p_oidsoli NUMBER);
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO para Bolivia
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDBO(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);

  /**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDG2(p_oidsoli NUMBER);

/**************************************************************************
Descripcion         : Genera la NOTA DEBITO
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_DEBIT(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2);


/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento factura
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_DOCUM_FACTU(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2);
/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento factura
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_DOCUM_FAC_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona          NUMBER
);

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota de credito
                      IMP-15
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_CREDI(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota de credito
                      IMP-15
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_CRE_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oid_zona         NUMBER);

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota de debito
                      IMP-16
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_DEBIT(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota de credito
                      IMP-15
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_DEB_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oid_zona         NUMBER);

/**************************************************************************
Descripcion         : Realiza EL REEMPAZO DE CARACTERES ESPECIALES
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
/***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_DOCUM_FACTU;

/**************************************************************************
Descripcion         : Realiza EL REEMPAZO DE CARACTERES ESPECIALES
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
/***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_NOTA_CREDI;

/**************************************************************************
Descripcion         : Realiza EL REEMPAZO DE CARACTERES ESPECIALES
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
/***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_NOTA_DEBIT;

/**************************************************************************
Descripcion         : Genera el archivo de documento factura laser
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_FACTU_LASER(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Genera el archivo de documento nota crediro
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_NOTA_CREDI(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2);

/**************************************************************************
Descripcion         : Genera el archivo de documento nota debito
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_NOTA_DEBIT(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2);

/***************************************************************************
 Descripcion       : Genera Interfaz de Envio Almacen
 Fecha Creacion    : 22/11/2011
 Autor             : Jose Luis Rodriguez
 ***************************************************************************/
PROCEDURE imp_pr_envio_almac(
  pscodigopais     VARCHAR2,
  pscodigosistema  VARCHAR2,
  pscodigointerfaz VARCHAR2,
  psnombrearchivo  VARCHAR2
);

/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Jorge Yepez
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC_Z(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_oidZona NUMBER
                                   , p_fechaFacturacion IN VARCHAR2);

/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Jorge Yepez
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC(p_oidclie IN NUMBER, p_oidsoli IN NUMBER, p_numlotefact IN VARCHAR2
                                   );


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_ua_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_marca_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_lista_clie(p_oidclie NUMBER, p_oidmens NUMBER, p_oidsoli NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_tipo_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_cuv_clie(p_oidsoli NUMBER, p_oidmens NUMBER) RETURN NUMBER;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_pedid_clie(p_oidsoli NUMBER, p_oidmens NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_direc_clie(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_text_direc(p_oiddire NUMBER, p_xml VARCHAR2) RETURN VARCHAR2;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_text2_direc(p_oiddire NUMBER, p_xml VARCHAR2) RETURN VARCHAR2;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_es_clie_vaca(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve el numero de OCS a enviar a las consultoras
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_devue_num_ocs(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER;

/**************************************************************************
Descripcion : Devuelve el xml con la oportunidad de ahorro de las ultimas
6 campa?as para inclrustarlo en el detalle de factura
Fecha Creacion : 29/04/2013
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_xml_opor_ahor(p_codigoPeriodo VARCHAR,p_oidperi NUMBER,p_oidclie NUMBER) RETURN VARCHAR2;

/**************************************************************************
Descripcion : Devuelve la descripcion del producto de planit
la Hora en formato dd/mm/yyyy
Fecha Creacion : 12/12/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_desc_produ(p_codigoPais VARCHAR,p_oidprod NUMBER) RETURN VARCHAR2;

/**************************************************************************
Descripcion : Devuelve la descripcion del producto de planit
la Hora en formato dd/mm/yyyy
Fecha Creacion : 12/12/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_desc_produ_br(p_codigoPais VARCHAR,p_oidprod NUMBER) RETURN VARCHAR2;

/**************************************************************************
Descripcion         : Obtiene los datos de la factura de referencia  en
                      base al OID documento contable (nota de credito).
Fecha Creacion      : 27/05/2009
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_OBTIE_INFOR_DOCLE_REFER(p_oidDocumento IN NUMBER,
                                         p_serieDocumentoReferencia OUT VARCHAR2,
                                         p_numeroDocumentoReferencia OUT NUMBER,
                                         p_codigoInternoReferencia OUT NUMBER,
                                         p_fechaReferencia OUT DATE,
                                         p_montoReferencia OUT NUMBER,
                                         p_oidTipoDocumentoReferencia OUT NUMBER,
                                         p_tipoDocumentoReferencia OUT VARCHAR2,
                                         p_valnumesolirefe OUT NUMBER,
                                         p_codperirefe OUT VARCHAR
                                         );


/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias. Coorperativo
Fecha Creacion      : 06/06/2013
Fecha Modificacion  : 06/06/2013
Autor               : Sergio Buchelli
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC_CORPO(p_oidclie IN NUMBER, p_oidsoli IN NUMBER, p_numlotefact IN VARCHAR2  );

/**************************************************************************
Descripcion : Proceso que ejecuta el Reporte de Desviaci?n de Pedidos.
Fecha Creacion : 23/10/2013
Fecha Modificacion  : 23/10/2013
Autor : Yahir Rivas Luna
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DESVI_PEDID(p_codigoPais IN VARCHAR2
                                        ,p_promedio IN VARCHAR2
                                        ,p_desviacion IN VARCHAR2
                                        ,p_fechaFacturacion IN VARCHAR2);


                                   

/**************************************************************************
Descripcion       : Procedimiemto de Programa Punto
                    para su insercion en la tabla detalle: IMP_PAQUE_DOCUM_PROGR_PUNTO
                    
Parametros        : Codigo de pais, Codigo de periodo
Fecha Creacion    : 12/01/2016
Autor             : Segundo Leiva Carvallo
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PROGR_PUNTO(psCodPais VARCHAR2,
  psCodigoPeriodo IN VARCHAR2); 

END;
  
/
CREATE OR REPLACE PACKAGE BODY "IMP_PKG_PROCE_LASER" AS

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de consolidado.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       BP.DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.PERD_OID_PERI = oidPeriodo
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.IND_INTE_LARI_GENE = indicadorEnvioLarissa
  AND (numeroLoteFacturacion IS NULL OR CON.NUM_LOTE_FACT = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  )
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER,
                 indicadorGrupo NUMBER) IS
SELECT OID_SOLI_CABE,
       COPA_OID_PARA_GENE,
       ICTP_OID_TIPO_PROG,
       OID_SOLI_POSI,
       VAL_CODI_VENT,
       DES_PROD,
       NUM_UNID_DEMA_REAL,
       NUM_UNID_ATEN,
       VAL_PREC_CATA_UNIT_LOCA,
       VAL_PREC_CATA_TOTA_LOCA,
       VAL_PREC_CONT_UNIT_LOCA,
       VAL_PREC_CONT_TOTA_LOCA,
       VAL_PREC_FACT_TOTA_LOCA,
       VAL_IMPO_DESC_TOTA_LOCA,
       VAL_PORC_DESC,
       VAL_IMPO_IMPU_TOTA_LOCA,
       FOPA_OID_FORM_PAGO,
       VAL_OBSE
FROM (
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       (SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       PSP.FOPA_OID_FORM_PAGO,
       CASE
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 2 --  MAV
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 2 -- PREMIOS (los agrupamos con los MAV)
           WHEN PSP.VAL_PORC_DESC IS NULL OR (PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC = 0)
               THEN 1 -- PRODUCTOS SIN DESCUENTO'
           WHEN PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC > 0
               THEN 0 -- PRODUCTOS CON DESCUENTO'
       END AS IND_GRUP,
       CASE
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Prem.Agot.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN 'Agotado'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN 'Falt.Liq.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN 'Falt.Anunc.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN 'Anul.Mto Max'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Premio'
           WHEN PCS.COD_CLAS_SOLI = 'R1'
               THEN 'At.Rec'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN 'Recuperacion'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
           AND NOT EXISTS (SELECT * FROM PRE_PROD_ALTER_ICE, MAE_PRODU A, MAE_PRODU B WHERE COD_SAP_PPAL=A.COD_SAP and COD_SAP_ALTE=B.COD_SAP AND (PSP.PROD_OID_PROD=A.OID_PROD OR PSP.PROD_OID_PROD=B.OID_PROD))
               THEN 'Reemplazo'
           WHEN EXISTS (
                 SELECT NULL
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 )
               THEN 'Reemplazo'
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 'Gratis'
           WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN 'Prem.LET'
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
)
WHERE IND_GRUP = indicadorGrupo
ORDER BY VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPagoPosterior     NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(1000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro
l_indicadorGenerarDetalleFact VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura');
l_indicadorGenerarDetalleFact2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2');
l_indicadorGenerarDetalleFactP VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFacturaP');

l_cargoFamSegura            NUMBER(12, 2) := 0;
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');

l_cantidadOC      NUMBER:=0;

BEGIN
    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorGenerarDetalleFact IS NULL OR l_indicadorGenerarDetalleFact <> 'S')THEN
        IF(l_indicadorGenerarDetalleFact2 IS NULL OR l_indicadorGenerarDetalleFact2 <> 'S')THEN
                IF(l_indicadorGenerarDetalleFactP IS NULL OR l_indicadorGenerarDetalleFactP <> 'S')THEN
                     RETURN;
                ELSE
                     --IMP_PR_PROCE_DETAL_FACTU_PERF(p_codigoPais,p_codigoPeriodo,p_fechaFacturacion);
                     RETURN;
                END IF;
        ELSE
           IMP_PR_PROCE_DETAL_FACTU2(p_codigoPais,p_codigoPeriodo,p_fechaFacturacion);
           RETURN;
        END IF;
    END IF;

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    -- Obtenemos el valor del ultimo numero de lote de facturacion
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                l_correlativo,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := '<blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := '<campana>' || p_codigoPeriodo || '</campana>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPagoPosterior := 0;

                -- Iteramos por las secciones del detalle
                FOR k IN 0..2
                LOOP

                    -- Iniciamos los subtotales
                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPagoPosterior := 0;

                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe, k);
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;

                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP

                                -- Mostramos el titulo
                                IF j = 1 THEN
                                    IF k = 0 THEN
                                        l_textoActual := '<txt><u>PRODUCTOS CON DESCUENTO</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSIF k = 1 THEN
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS DE REVISTA Y/U OFERTAS ESPECIALES PARA CONSULTORAS</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSE
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS Y/O APOYO DE VTA/PROMOCIONES</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;
                                END IF;

                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;

                                        -- Pago posterior (fraccionado)
                                        l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                l_textoActual := '<txt>';

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Pago Posterior
                                l_textoActual := l_textoActual || trim(to_char(l_pagoPosterior, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<t/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPagoPosterior := l_subtotalPagoPosterior + l_pagoPosterior;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPagoPosterior := l_totalPagoPosterior + l_pagoPosterior;

                            END LOOP;
                        END IF;
                        EXIT WHEN c_detalle%NOTFOUND;
                    END LOOP;

                    -- Cerramos el cursor de detalles
                    CLOSE c_detalle;

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPagoPosterior, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<t/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    END IF;

                END LOOP;

                -- Totales

                -- Al descuento le agregamos el redondeo
                l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPagoPosterior, l_formatoNumerico));
                l_textoActual := l_textoActual || '<t/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := '<pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Obtenemos los valores faltantes
                -- Saldo a favor
                --l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);

                -- Saldo anterior
                --l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');

                -- Restamos al saldo anterior el saldo a favor
                --l_saldoAnterior := l_saldoAnterior - l_saldoFavor;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion;
                --l_totalAPagar := l_totalFactura + l_saldoAnterior - l_totalPagoPosterior;

                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                IF l_indicadorImpuestosGratis = 'S' THEN
                    l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;
                END IF;


                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;

                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;

                END IF;

                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);
                l_saldoAnterior := l_totalAPagar - l_totalFactura - l_cargoFamSegura + l_totalPagoPosterior;

                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea7>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := '<linea8>' || trim(to_char(0, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                ELSE
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                END IF;

                -- Fin Pie
                l_textoActual := '</pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := '</detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;
                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;

END;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO.
Fecha Creacion      : 22/11/2010
Fecha Modificacion  : 22/11/2010
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       0 SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(CON.OID_SOLI_CABE) SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(CON.OID_SOLI_CABE, '200902', 'A') SALDO_ANTERIOR
       0 SALDO_ANTERIOR
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.PERD_OID_PERI = oidPeriodo
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.IND_INTE_LARI_GENE = indicadorEnvioLarissa
  AND (numeroLoteFacturacion IS NULL OR CON.NUM_LOTE_FACT = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  )
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    saldoAnterior           ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    saldoAFavor             ped_solic_cabec_secue.num_secu_fact_diar%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER) IS
/*SELECT OID_SOLI_CABE,
       COPA_OID_PARA_GENE,
       ICTP_OID_TIPO_PROG,
       OID_SOLI_POSI,
       VAL_CODI_VENT,
       DES_PROD,
       NUM_UNID_DEMA_REAL,
       NUM_UNID_ATEN,
       VAL_PREC_CATA_UNIT_LOCA,
       VAL_PREC_CATA_TOTA_LOCA,
       VAL_PREC_CONT_UNIT_LOCA,
       VAL_PREC_CONT_TOTA_LOCA,
       VAL_PREC_FACT_TOTA_LOCA,
       VAL_IMPO_DESC_TOTA_LOCA,
       VAL_PORC_DESC,
       VAL_IMPO_IMPU_TOTA_LOCA,
       IMP_PREC_PUBL,
       FOPA_OID_FORM_PAGO,
       IND_GRUP,
       VAL_OBSE
FROM (*/
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       (SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       POD.IMP_PREC_PUBL,
       PSP.FOPA_OID_FORM_PAGO,
       decode(psc.modu_oid_modu,15,3,nvl(PTO.NUM_SECC_DETA_FACT,2)) IND_GRUP,
       CASE
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Prem.Agot.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN 'Agotado'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN 'Falt.Liq.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN 'Falt.Anu.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN 'Anul.MtoMax'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Premio'
           WHEN PSC.MODU_OID_MODU = '15'
               THEN 'At.Rec'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN 'Recup.'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN 'Reemp.'
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN 'Rmpado.'
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN 'Rmpazo.'  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=POF.Oid_Deta_Ofer)
                 AND rownum=1
                 )
           WHEN TS.Cod_Tipo_Soli='IPLC'
               THEN 'Prem.LET'
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 'Gratis'
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_SUBTI_POSIC PST--,
     --PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  --AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    ind_grupo                   pre_tipo_ofert.num_secc_deta_fact%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;
l_precioCatalogo            NUMBER(12, 2) := 0;
l_PrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_oportunidadAhorro         NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogo    NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_subtotaloportunidadAhorro NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPrecioCatalogo       NUMBER(12, 2) := 0;
l_totalPrecioCatalogoTotal  NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_totalOportunidadAhorro    NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_oportunidadCatalogo       NUMBER(12, 2) := 0;
l_oportunidadRevista        NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro
l_indicadorGenerarDetalleFact2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2');

l_nombreSeccion1 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion1');
l_nombreSeccion2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion2');
l_nombreSeccion3 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion3');
l_nombreSeccion4 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion4');

l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_flagTitulo1     NUMBER:=0;
l_flagTitulo2     NUMBER:=0;
l_flagTitulo3     NUMBER:=0;
l_flagTitulo4     NUMBER:=0;

l_cantidadOC      NUMBER:=0;

BEGIN
    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorGenerarDetalleFact2 IS NULL OR l_indicadorGenerarDetalleFact2 <> 'S')THEN
     RETURN;
    END IF;

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    -- Obtenemos el valor del ultimo numero de lote de facturacion
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';
    delete from IMP_PAQUE_DOCUM_DETAL_FACTU;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                l_flagTitulo1:=0;
                l_flagTitulo2:=0;
                l_flagTitulo3:=0;
                l_flagTitulo4:=0;
                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                l_correlativo,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac2>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := l_textoActual || '<blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                /*
                l_textoActual := '<nombreColumnas><txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_nombreColumna1 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna2 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna3 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna4 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna5 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna6 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna7 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna8 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna9 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna10 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna11 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := '</txt></nombreColumnas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                */
                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPrecioCatalogo := 0;
                l_totalPrecioCatalogoTotal := 0;
                l_totalOportunidadAhorro := 0;
                l_oportunidadRevista:=0;
                l_oportunidadCatalogo:=0;

                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe);
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;
                FOR k IN 0..3
                LOOP

                    -- Iniciamos los subtotales

                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPrecioCatalogo := 0;
                    l_subtotalPrecioCatalogoTotal := 0;
                    l_subtotaloportunidadAhorro := 0;
                    l_oportunidadAhorro := 0;

                    -- Mostramos el titulo


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP
                            if r_detalle(j).ind_grupo=k then

                                IF k = 0 and l_flagTitulo1=0 THEN
                                    l_textoActual := '<txt><u>' || l_nombreSeccion1 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo1:=1;
                                ELSIF k = 1 and l_flagTitulo2=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion2 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo2:=1;
                                ELSIF k = 2 and l_flagTitulo3=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion3 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo3:=1;
                                ELSIF k = 3 and l_flagTitulo4=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion4 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo4:=1;
                                END IF;
                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                    l_oportunidadAhorro := 0;
                                    l_precioCatalogo := 0;
                                    l_PrecioCatalogoTotal := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                        l_oportunidadAhorro := 0;
                                        l_precioCatalogo := 0;
                                        l_PrecioCatalogoTotal := 0;
                                        if r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        end if;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;
                                        if r_detalle(j).ind_grupo=0 then
                                           l_precioCatalogo := l_precioUnitario;
                                           l_PrecioCatalogoTotal := l_precioTotal;
                                           l_oportunidadAhorro := l_descuento;
                                        elsif r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal-l_precioTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        else
                                           l_precioCatalogo := 0;
                                           l_PrecioCatalogoTotal := 0;
                                           l_oportunidadAhorro := 0;
                                        end if;

                                        -- Pago posterior (fraccionado)
                                        --l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                l_textoActual := '<txt>';

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogo, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogoTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || trim(to_char(l_oportunidadAhorro, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPrecioCatalogo := l_subtotalPrecioCatalogo + l_precioCatalogo;
                                l_subtotalPrecioCatalogoTotal := l_subtotalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_subtotaloportunidadAhorro := l_subtotaloportunidadAhorro + l_oportunidadAhorro;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPrecioCatalogo := l_totalPrecioCatalogo + l_precioCatalogo;
                                l_totalPrecioCatalogoTotal := l_totalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_totalOportunidadAhorro := l_totalOportunidadAhorro + l_oportunidadAhorro;

                                /*update ped_solic_posic xx set xx.val_prec_publ_unit_loca=r_detalle(j).imp_prec_publ--*r_detalle(j).num_unid_aten
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;

                                update ped_solic_posic xx set xx.val_prec_publ_tota_loca=l_oportunidadAhorro
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;*/
                            end if;
                            END LOOP;
                        END IF;

                    -- Cerramos el cursor de detalles

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogoTotal, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotaloportunidadAhorro, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        if k=0 then
                           l_oportunidadCatalogo:=l_subtotaloportunidadAhorro;
                        elsif k=1 then
                           l_oportunidadRevista:=l_subtotaloportunidadAhorro;
                        end if;
                    END IF;
                    END LOOP;

                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;

                -- Totales

                -- Al descuento le agregamos el redondeo
                l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogoTotal, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalOportunidadAhorro, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := '<pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Obtenemos los valores faltantes

                -- Saldo a favor
                --l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);
                --l_saldoFavor := r_consolidado(i).saldoAFavor;

                -- Saldo anterior
                --l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');
                --l_saldoAnterior := r_consolidado(i).saldoAnterior;


                --

                --select nvl(sum(imp_pend),0) into l_totalPagoPosterior
                --from ccc_movim_cuent_corri where clie_oid_clie=r_consolidado(i).oid_clie
                --and imp_pend>0 and perd_oid_peri>(select perd_oid_peri from ped_solic_cabec where oid_soli_cabe=r_consolidado(i).oid_soli_cabe);


                -- Restamos al saldo anterior el saldo a favor
                --l_saldoAnterior := l_saldoAnterior - l_saldoFavor;

                BEGIN

                 SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy') into l_fechaVencimiento
                 FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                 WHERE cc.PERD_OID_PERI = cp.oid_peri
                   AND cp.peri_oid_peri = spc.oid_peri
                   AND spc.cod_peri = l_codigoPeriodoSiguiente
                   AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                   AND cc.CACT_OID_ACTI = act.OID_ACTI
                   AND act.COD_ACTI = 'CV';

                EXCEPTION
                    WHEN OTHERS THEN
                    l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');
                END;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion;
                --l_totalAPagar := l_totalFactura + l_saldoAnterior - l_totalPagoPosterior;

                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                IF l_indicadorImpuestosGratis = 'S' THEN
                    l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;
                END IF;

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;


                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;

                END IF;


                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);
                l_saldoAnterior := l_totalAPagar - l_totalFactura - l_cargoFamSegura + l_totalPagoPosterior;


                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea7>' || trim(to_char(0, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := '<linea8>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                ELSE
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := '<linea7>' || trim(to_char(0, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);
                END IF;

                -- Fin Pie
                l_textoActual := '</pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := '</detfac2>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;

                update ped_solic_cabec xx set xx.val_gana_tota_loca=l_oportunidadCatalogo+l_oportunidadRevista
                where oid_soli_cabe=r_consolidado(i).oid_soli_cabe;


                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;

END;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO.
Fecha Creacion      : 22/11/2010
Fecha Modificacion  : 22/11/2010
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2_PERF(oidSolicitud NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       0 SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(CON.OID_SOLI_CABE) SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(CON.OID_SOLI_CABE, '200902', 'A') SALDO_ANTERIOR
       0 SALDO_ANTERIOR
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.PERD_OID_PERI = oidPeriodo
  AND CON.OID_SOLI_CABE = oidSolicitud
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  )
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    saldoAnterior           ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    saldoAFavor             ped_solic_cabec_secue.num_secu_fact_diar%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER) IS
/*SELECT OID_SOLI_CABE,
       COPA_OID_PARA_GENE,
       ICTP_OID_TIPO_PROG,
       OID_SOLI_POSI,
       VAL_CODI_VENT,
       DES_PROD,
       NUM_UNID_DEMA_REAL,
       NUM_UNID_ATEN,
       VAL_PREC_CATA_UNIT_LOCA,
       VAL_PREC_CATA_TOTA_LOCA,
       VAL_PREC_CONT_UNIT_LOCA,
       VAL_PREC_CONT_TOTA_LOCA,
       VAL_PREC_FACT_TOTA_LOCA,
       VAL_IMPO_DESC_TOTA_LOCA,
       VAL_PORC_DESC,
       VAL_IMPO_IMPU_TOTA_LOCA,
       IMP_PREC_PUBL,
       FOPA_OID_FORM_PAGO,
       IND_GRUP,
       VAL_OBSE
FROM (*/
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       (SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       POD.IMP_PREC_PUBL,
       PSP.FOPA_OID_FORM_PAGO,
       decode(psc.modu_oid_modu,15,3,nvl(PTO.NUM_SECC_DETA_FACT,2)) IND_GRUP,
       CASE
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Prem.Agot'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN 'Agotado'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN 'Falt.Liq.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN 'Falt.Anu.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN 'Anul.MtoMax'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Premio'
           WHEN PSC.MODU_OID_MODU = '15'
               THEN 'At.Rec'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN 'Recup.'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN 'Reemp.'
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN 'Rmpado.'
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN 'Rmpazo.'  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=POF.Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 'Gratis'
           WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN 'Prem.LET'
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_SUBTI_POSIC PST--,
     --PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  --AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    ind_grupo                   pre_tipo_ofert.num_secc_deta_fact%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;
l_precioCatalogo            NUMBER(12, 2) := 0;
l_PrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_oportunidadAhorro         NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogo    NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_subtotaloportunidadAhorro NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPrecioCatalogo       NUMBER(12, 2) := 0;
l_totalPrecioCatalogoTotal  NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_totalOportunidadAhorro    NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_oportunidadCatalogo       NUMBER(12, 2) := 0;
l_oportunidadRevista        NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro
l_indicadorGenerarDetalleFact2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2');

l_nombreSeccion1 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion1');
l_nombreSeccion2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion2');
l_nombreSeccion3 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion3');
l_nombreSeccion4 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion4');

l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_flagTitulo1     NUMBER:=0;
l_flagTitulo2     NUMBER:=0;
l_flagTitulo3     NUMBER:=0;
l_flagTitulo4     NUMBER:=0;

l_cantidadOC      NUMBER:=0;

BEGIN
    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorGenerarDetalleFact2 IS NULL OR l_indicadorGenerarDetalleFact2 <> 'S')THEN
     RETURN;
    END IF;

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    -- Obtenemos el valor del ultimo numero de lote de facturacion
    /*
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;*/

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';
    --delete from IMP_PAQUE_DOCUM_DETAL_FACTU;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                l_flagTitulo1:=0;
                l_flagTitulo2:=0;
                l_flagTitulo3:=0;
                l_flagTitulo4:=0;
                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac2>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := l_textoActual || '<blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                /*
                l_textoActual := '<nombreColumnas><txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_nombreColumna1 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna2 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna3 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna4 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna5 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna6 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna7 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna8 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna9 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna10 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna11 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := '</txt></nombreColumnas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                */
                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPrecioCatalogo := 0;
                l_totalPrecioCatalogoTotal := 0;
                l_totalOportunidadAhorro := 0;
                l_oportunidadRevista:=0;
                l_oportunidadCatalogo:=0;

                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe);
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;
                FOR k IN 0..3
                LOOP

                    -- Iniciamos los subtotales

                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPrecioCatalogo := 0;
                    l_subtotalPrecioCatalogoTotal := 0;
                    l_subtotaloportunidadAhorro := 0;
                    l_oportunidadAhorro := 0;

                    -- Mostramos el titulo


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP
                            if r_detalle(j).ind_grupo=k then

                                IF k = 0 and l_flagTitulo1=0 THEN
                                    l_textoActual := '<txt><u>' || l_nombreSeccion1 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo1:=1;
                                ELSIF k = 1 and l_flagTitulo2=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion2 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo2:=1;
                                ELSIF k = 2 and l_flagTitulo3=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion3 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo3:=1;
                                ELSIF k = 3 and l_flagTitulo4=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion4 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo4:=1;
                                END IF;
                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                    l_oportunidadAhorro := 0;
                                    l_precioCatalogo := 0;
                                    l_PrecioCatalogoTotal := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                        l_oportunidadAhorro := 0;
                                        l_precioCatalogo := 0;
                                        l_PrecioCatalogoTotal := 0;
                                        if r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        end if;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;
                                        if r_detalle(j).ind_grupo=0 then
                                           l_precioCatalogo := l_precioUnitario;
                                           l_PrecioCatalogoTotal := l_precioTotal;
                                           l_oportunidadAhorro := l_descuento;
                                        elsif r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal-l_precioTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        else
                                           l_precioCatalogo := 0;
                                           l_PrecioCatalogoTotal := 0;
                                           l_oportunidadAhorro := 0;
                                        end if;

                                        -- Pago posterior (fraccionado)
                                        --l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                l_textoActual := '<txt>';

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogo, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogoTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || trim(to_char(l_oportunidadAhorro, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPrecioCatalogo := l_subtotalPrecioCatalogo + l_precioCatalogo;
                                l_subtotalPrecioCatalogoTotal := l_subtotalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_subtotaloportunidadAhorro := l_subtotaloportunidadAhorro + l_oportunidadAhorro;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPrecioCatalogo := l_totalPrecioCatalogo + l_precioCatalogo;
                                l_totalPrecioCatalogoTotal := l_totalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_totalOportunidadAhorro := l_totalOportunidadAhorro + l_oportunidadAhorro;

                                /*update ped_solic_posic xx set xx.val_prec_publ_unit_loca=r_detalle(j).imp_prec_publ--*r_detalle(j).num_unid_aten
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;

                                update ped_solic_posic xx set xx.val_prec_publ_tota_loca=l_oportunidadAhorro
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;*/
                            end if;
                            END LOOP;
                        END IF;

                    -- Cerramos el cursor de detalles

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogoTotal, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotaloportunidadAhorro, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        if k=0 then
                           l_oportunidadCatalogo:=l_subtotaloportunidadAhorro;
                        elsif k=1 then
                           l_oportunidadRevista:=l_subtotaloportunidadAhorro;
                        end if;
                    END IF;
                    END LOOP;

                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;

                -- Totales

                -- Al descuento le agregamos el redondeo
                l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogoTotal, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalOportunidadAhorro, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := '<pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Obtenemos los valores faltantes

                -- Saldo a favor
                --l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);
                --l_saldoFavor := r_consolidado(i).saldoAFavor;

                -- Saldo anterior
                --l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');
                --l_saldoAnterior := r_consolidado(i).saldoAnterior;


                --select nvl(sum(imp_pend),0) into l_totalPagoPosterior
                --from ccc_movim_cuent_corri where clie_oid_clie=r_consolidado(i).oid_clie
                --and imp_pend>0 and perd_oid_peri>(select perd_oid_peri from ped_solic_cabec where oid_soli_cabe=r_consolidado(i).oid_soli_cabe);


                -- Restamos al saldo anterior el saldo a favor
                --l_saldoAnterior := l_saldoAnterior - l_saldoFavor;

                BEGIN

                 SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy') into l_fechaVencimiento
                 FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                 WHERE cc.PERD_OID_PERI = cp.oid_peri
                   AND cp.peri_oid_peri = spc.oid_peri
                   AND spc.cod_peri = l_codigoPeriodoSiguiente
                   AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                   AND cc.CACT_OID_ACTI = act.OID_ACTI
                   AND act.COD_ACTI = 'CV';

                EXCEPTION

                 WHEN OTHERS THEN
                  l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');

                END;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion;
                --l_totalAPagar := l_totalFactura + l_saldoAnterior - l_totalPagoPosterior;

                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                IF l_indicadorImpuestosGratis = 'S' THEN
                    l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;
                END IF;

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;

                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;

                END IF;


                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);
                l_saldoAnterior := l_totalAPagar - l_totalFactura - l_cargoFamSegura + l_totalPagoPosterior;


                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea7>' || trim(to_char(0, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := '<linea8>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                ELSE
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := '<linea7>' || trim(to_char(0, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);
                END IF;

                -- Fin Pie
                l_textoActual := '</pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := '</detfac2>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;

                update ped_solic_cabec xx set xx.val_gana_tota_loca=l_oportunidadCatalogo+l_oportunidadRevista
                where oid_soli_cabe=r_consolidado(i).oid_soli_cabe;


                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;

END;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU2_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_oidZona NUMBER
                                   , p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER,
                      oidRegi NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.Val_Reca_Flet_Loca,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       mcda.ind_impr_docu imprimefactel,
       mcda.ind_impr_pdoc imprimepaqdoc,
       con.val_tota_gast_admi GASTOS,
       con.val_tota_gast_admi2 GASTOS2,
       (select val_nom1 || ' ' || val_nom2 from mae_clien where oid_clie=zon.clie_oid_clie)  nombreGZ,
       (select val_ape1 || ' ' || val_ape2 from mae_clien where oid_clie=zon.clie_oid_clie)  apellidosGZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)  celular_GZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=3 and rownum=1)  correo_GZ,
       (select decode(y.val_sigl,'RUC',y.val_sigl,'DNI') from mae_tipo_docum y where y.oid_tipo_docu=mci.tdoc_oid_tipo_docu and rownum=1) tipo_docum,
       con.val_impo_impu_tota_loca,
       con.val_impo_desc_flet,
       con.val_impo_desc_3_tota_loca,
       con.val_impo_desc_4_tota_loca,
       (select x1.val_i18n from gen_i18n_sicc_comun x1 where x1.attr_enti='CAR_NIVEL_RIESG' and x1.val_oid=mcda.niri_oid_nive_ries) nr,
       nvl(mc.val_recl_pend,0) val_recl_pend
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     MAE_CLIEN_DATOS_ADICI MCDA,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCDA.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.PERD_OID_PERI = oidPeriodo
  AND ZON.Oid_Zona = oidRegi
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  );
--ORDER BY MC.COD_CLIE,
--         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_reca_flet_loca      ped_solic_cabec.val_reca_flet_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    imprimefactel           mae_clien_datos_adici.ind_impr_docu%TYPE,
    imprimepaqdoc           mae_clien_datos_adici.ind_impr_pdoc%TYPE,
    gastos                  ped_solic_cabec.val_tota_gast_admi%TYPE,
    gastos2                  ped_solic_cabec.val_tota_gast_admi2%TYPE,
    nombresGZ               varchar2(100),
    apellidosGZ             varchar2(100),
    celularGZ               varchar2(100),
    correoGZ               varchar2(100),
    tipo_docum               varchar2(100),
    val_impo_impu_tota_loca  ped_solic_cabec.val_impo_impu_tota_loca%TYPE,
    val_impo_desc_flet       ped_solic_cabec.val_impo_desc_flet%TYPE,
    val_impo_desc_3_tota_loca ped_solic_cabec.val_impo_desc_3_tota_loca%TYPE,
    val_impo_desc_4_tota_loca ped_solic_cabec.val_impo_desc_4_tota_loca%TYPE,
    nr                        gen_i18n_sicc_comun.val_i18n%TYPE,
    val_recl_pend             mae_clien.val_recl_pend%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER
,v_desPremioAgotado VARCHAR2
,v_desAgotado VARCHAR2
,v_desFaltLiq VARCHAR2
,v_desFaltAnun VARCHAR2
,v_desAnulMotMax VARCHAR2
,v_desPremio VARCHAR2
,v_desAtRec VARCHAR2
,v_desRecup VARCHAR2
,v_desReemp VARCHAR2
,v_desGratis VARCHAR2
,v_desPremioLET VARCHAR2
,v_desRecupSemana VARCHAR2
,v_desOfertNavid VARCHAR2
, v_oidestra  NUMBER
,v_desRecuPROL VARCHAR2
,v_desRecuPROL2 VARCHAR2
) IS
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       --(SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       imp_fn_desc_produ(p_codigoPais,psp.prod_oid_prod) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       POD.IMP_PREC_PUBL,
       PSP.FOPA_OID_FORM_PAGO,
       decode(psc.modu_oid_modu,15,3,nvl(PTO.NUM_SECC_DETA_FACT,2)) IND_GRUP,
       psp.val_codi_orig,
       psp.num_unid_orig,
       psp.oid_nive_ofer,
       decode(mp.val_atri_3,'1','C',nvl(psp.ind_dent_fuer_caja_bols,'F')) ind_dent_fuer_caja_bols, 
       CASE
           WHEN exists (select 1 from pre_ofert x where x.oid_ofer=pod.ofer_oid_ofer and x.coes_oid_estr=v_oidestra)
               THEN v_desOfertNavid
           WHEN exists (select 1 from pre_recup_seman x where x.cod_peri=p_codigoPeriodo and x.cod_vent=psp.val_codi_vent) and (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0)
               THEN v_desRecupSemana
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremioAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN v_desAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN v_desFaltLiq
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN v_desFaltAnun
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN v_desAnulMotMax
           /*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'*/
          WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN v_desAgotado
           /*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'*/
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremio
           WHEN PSC.MODU_OID_MODU = '15'
               THEN v_desAtRec
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN v_desRecup
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN ''
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN v_desReemp  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN v_desGratis
           WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN v_desPremioLET
           WHEN psp.ind_recu_prol = '1'
               THEN v_desRecuPROL
           WHEN psp.ind_recu_prol = '2'
               THEN v_desRecuPROL2
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_SUBTI_POSIC PST,
     mae_produ mp
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  and psp.prod_oid_prod=mp.oid_prod
  --AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY OID_NIVE_OFER, VAL_CODI_ORIG, VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    ind_grupo                   pre_tipo_ofert.num_secc_deta_fact%TYPE,
    val_codi_orig               ped_solic_posic.val_codi_orig%TYPE,
    num_unid_orig               ped_solic_posic.num_unid_orig%TYPE,
    oid_nive_ofer               ped_solic_posic.oid_nive_ofer%TYPE,
    ind_dent_fuer_caja_bols     ped_solic_posic.ind_dent_fuer_caja_bols%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_descuento2                NUMBER(12, 2) := 0;
l_dif_desc                  NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;
l_precioCatalogo            NUMBER(12, 2) := 0;
l_PrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_oportunidadAhorro         NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogo    NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_subtotaloportunidadAhorro NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalDescuentos2           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPrecioCatalogo       NUMBER(12, 2) := 0;
l_totalPrecioCatalogoTotal  NUMBER(12, 2) := 0;
l_totalOportunidadAhorro    NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_saldoFlexAnterior         NUMBER(12, 2) := 0;
l_interesFlexipago          NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_oportunidadCatalogo       NUMBER(12, 2) := 0;
l_oportunidadRevista        NUMBER(12, 2) := 0;

l_totalCatalogo2        NUMBER(12, 2) := 0;
l_totalMAV              NUMBER(12, 2) := 0;


l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro
l_indicadorGenerarDetalleFact2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2');

l_nombreSeccion1 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion1');
l_nombreSeccion2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion2');
l_nombreSeccion3 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion3');
l_nombreSeccion4 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion4');

l_desRecupSemana VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecupSemana');
l_desPremioAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioAgotado');
l_desAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAgotado');
l_desFaltLiq VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltLiq');
l_desFaltAnun VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltAnun');
l_desAnulMotMax VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAnulMotMax');
l_desPremio VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremio');
l_desAtRec VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAtRec');
l_desRecup VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecup');
l_desReemp VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desReemp');
l_desGratis VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desGratis');
l_desPremioLET VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioLET');
l_desOfertNavid VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desOfertNavid');
l_desRecuPROL VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecuPROL');
l_desRecuPROL2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecuPROL2');



l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_flagTitulo1     NUMBER:=0;
l_flagTitulo2     NUMBER:=0;
l_flagTitulo3     NUMBER:=0;
l_flagTitulo4     NUMBER:=0;

l_cantidadOC      NUMBER:=0;

lv_indiejec VARCHAR2(10):=nvl(sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_GASTO_ADMIN'),'N');

lv_indiejec2 VARCHAR2(10):=IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','impuestoEstatal');


lv_reemplazoOCS VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorReemplazoOCS');

lv_actividadConf VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadConf'),'CV');

lv_actividadDesp VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadDesp'),'DP');

lv_imprimepaqdoc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimepaqdoc'),'N');

lv_imprimefactel VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimefactel'),'N');

lv_imprimenuevos VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimenuevos'),'N');

lv_redondeoDesc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','redondeoDesc'),'S');


ln_oidestra NUMBER(10):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_ESTRA_NAVID');

ln_diasdesp NUMBER(10):= 0;
ln_diasdesp2 NUMBER(10):= 0;
ln_diasdesp3 NUMBER(10):= 0;


l_fechaCV VARCHAR2(100) := '';
l_fechaDespacho VARCHAR2(100) := '';
l_fechaDespacho_2 VARCHAR2(100) := '';
l_fechaDespacho_3 VARCHAR2(100) := '';
l_fechaDespacho2 VARCHAR2(100) :=  nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indFechaDesp2'),'N');
l_fechaSigFact VARCHAR2(100) := '';
l_fechaSigFact2 VARCHAR2(100) := '';
l_fechaSigFact3 VARCHAR2(100) := '';

lsactividadparametro VARCHAR2(100):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,
                                                                 'STO_ACTIV_RECAR_FLET');
lscodperigastos VARCHAR2(10);

ln_desc_flete VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'descFlete'),'N');

ln_desc_flete2 VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'descFlete2'),'N');

orig_ante VARCHAR2(100):='';

BEGIN


    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;


    -- Obtenemos el valor del ultimo numero de lote de facturacion
    /*
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;*/

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';
    --delete from IMP_PAQUE_DOCUM_DETAL_FACTU;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion, p_oidZona);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                l_flagTitulo1:=0;
                l_flagTitulo2:=0;
                l_flagTitulo3:=0;
                l_flagTitulo4:=0;
                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac2>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := l_textoActual || '<blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                if lv_imprimefactel='S' then
                  if r_consolidado(i).tipo_docum<>'RUC' then
                     r_consolidado(i).imprimefactel:='1';
                  end if;
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- Ind. Impresion FE
                l_textoActual := l_textoActual || '<imprimefactel>' || r_consolidado(i).imprimefactel || '</imprimefactel>';

                if lv_imprimepaqdoc='S' then
                  -- Ind. Impresion
                  l_textoActual := l_textoActual || '<imprimepaqdoc>' || r_consolidado(i).imprimepaqdoc || '</imprimepaqdoc>';

                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                if lv_imprimenuevos='S' then

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaDespacho,l_fechaDespacho_2,l_fechaDespacho_3
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadDesp;
                  exception when others then
                    l_fechaDespacho:=trunc(sysdate);
                    l_fechaDespacho_2:=trunc(sysdate);
                    l_fechaDespacho_3:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaSigFact
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = 'FA';
                  exception when others then
                    l_fechaSigFact:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaCV
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadConf;
                  exception when others then
                    l_fechaCV:=trunc(sysdate);
                  end;


                  l_fechaSigFact2:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,2),'dd/mm/yyyy');

                  l_fechaSigFact3:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,3),'dd/mm/yyyy');

                  ln_diasdesp:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,1,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp2:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,2,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp3:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,3,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));


                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho:=to_char(to_date(l_fechaSigFact,'dd/mm/yyyy')+ln_diasdesp,'dd/mm/yyyy');
                  end if;


                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_2:=to_char(to_date(l_fechaSigFact2,'dd/mm/yyyy')+ln_diasdesp2,'dd/mm/yyyy');
                  end if;

                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_3:=to_char(to_date(l_fechaSigFact3,'dd/mm/yyyy')+ln_diasdesp3,'dd/mm/yyyy');
                  end if;



                  -- Nombre Consultora
                  l_textoActual := l_textoActual || '<nombres>' || r_consolidado(i).val_nom1 || ' ' || r_consolidado(i).val_nom2 || '</nombres>';
                  l_textoActual := l_textoActual || '<apellidos>' || r_consolidado(i).val_ape1 || ' ' || r_consolidado(i).val_ape2 || '</apellidos>';
                  l_textoActual := l_textoActual || '<nombresGZ>' || r_consolidado(i).nombresGZ || '</nombresGZ>';
                  l_textoActual := l_textoActual || '<apellidosGZ>' || r_consolidado(i).apellidosGZ || '</apellidosGZ>';
                  l_textoActual := l_textoActual || '<celularGZ>' || r_consolidado(i).celularGZ || '</celularGZ>';
                  l_textoActual := l_textoActual || '<correoGZ>' || r_consolidado(i).correoGZ || '</correoGZ>';
                  l_textoActual := l_textoActual || '<fechaCV>' || l_fechaCV || '</fechaCV>';
                  l_textoActual := l_textoActual || '<fechaReparto>' || l_fechaDespacho || '</fechaReparto>';
                  l_textoActual := l_textoActual || '<fechaReparto2>' || l_fechaDespacho_2 || '</fechaReparto2>';
                  l_textoActual := l_textoActual || '<fechaReparto3>' || l_fechaDespacho_3 || '</fechaReparto3>';
                  l_textoActual := l_textoActual || '<fechaSigFact>' || l_fechaSigFact || '</fechaSigFact>';
                  l_textoActual := l_textoActual || '<fechaSigFact2>' || l_fechaSigFact2 || '</fechaSigFact2>';
                  l_textoActual := l_textoActual || '<fechaSigFact3>' || l_fechaSigFact3 || '</fechaSigFact3>';
                  l_textoActual := l_textoActual || '<diasDesp>' || ln_diasdesp || '</diasDesp>';
                  l_textoActual := l_textoActual || '<tipo_docum>' || r_consolidado(i).tipo_docum || '</tipo_docum>';
                  l_textoActual := l_textoActual || imp_fn_xml_opor_ahor(p_codigoPeriodo,l_oidPeriodo,r_consolidado(i).oid_clie);
                  l_textoActual := l_textoActual || '<nriesgo>' || r_consolidado(i).nr || '</nriesgo>';
                end if;

                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                l_textoActual := l_textoActual || IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA( r_consolidado(i).cod_clie) ||
              IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA( r_consolidado(i).cod_clie);


                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                /*
                l_textoActual := '<nombreColumnas><txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_nombreColumna1 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna2 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna3 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna4 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna5 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna6 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna7 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna8 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna9 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna10 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna11 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := '</txt></nombreColumnas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                */
                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPrecioCatalogo := 0;
                l_totalPrecioCatalogoTotal := 0;
                l_totalOportunidadAhorro := 0;
                l_oportunidadRevista:=0;
                l_oportunidadCatalogo:=0;
                
                l_totalCatalogo2:=0;
                l_totalMAV:=0;

                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe
                      ,l_desPremioAgotado
                      ,l_desAgotado
                      ,l_desFaltLiq
                      ,l_desFaltAnun
                      ,l_desAnulMotMax
                      ,l_desPremio
                      ,l_desAtRec
                      ,l_desRecup
                      ,l_desReemp
                      ,l_desGratis
                      ,l_desPremioLET
                      ,l_desRecupSemana
                      ,l_desOfertNavid
                      ,ln_oidestra
                      ,l_desRecuPROL
                      ,l_desRecuPROL2
                    );
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;
                FOR k IN 0..3
                LOOP

                    orig_ante:=null;

                    -- Iniciamos los subtotales

                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPrecioCatalogo := 0;
                    l_subtotalPrecioCatalogoTotal := 0;
                    l_subtotaloportunidadAhorro := 0;
                    l_oportunidadAhorro := 0;

                    -- Mostramos el titulo


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP
                            
                            
                            if r_detalle(j).ind_grupo=k then

                                IF k = 0 and l_flagTitulo1=0 THEN
                                    l_textoActual := '<txt><u>' || l_nombreSeccion1 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo1:=1;
                                ELSIF k = 1 and l_flagTitulo2=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion2 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo2:=1;
                                ELSIF k = 2 and l_flagTitulo3=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion3 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo3:=1;
                                ELSIF k = 3 and l_flagTitulo4=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion4 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo4:=1;
                                END IF;
                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                    l_oportunidadAhorro := 0;
                                    l_precioCatalogo := 0;
                                    l_PrecioCatalogoTotal := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                        l_oportunidadAhorro := 0;
                                        l_precioCatalogo := 0;
                                        l_PrecioCatalogoTotal := 0;
                                        if r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        end if;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_descuento2 := r_detalle(j).val_prec_cata_tota_loca*(r_detalle(j).val_porc_desc/100);
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;
                                        if ln_desc_flete2='S' then
                                           l_precioFacturado:=r_detalle(j).val_prec_cata_tota_loca-l_descuento2;
                                        end if;
                                        if r_detalle(j).ind_grupo=0 then
                                           l_precioCatalogo := l_precioUnitario;
                                           l_PrecioCatalogoTotal := l_precioTotal;
                                           l_oportunidadAhorro := l_descuento;
                                            if ln_desc_flete2='S' then
                                               l_oportunidadAhorro := l_descuento2;
                                            end if;
                                        elsif r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal-l_precioTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        else
                                           l_precioCatalogo := 0;
                                           l_PrecioCatalogoTotal := 0;
                                           l_oportunidadAhorro := 0;
                                        end if;

                                        -- Pago posterior (fraccionado)
                                        --l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                if (orig_ante is null and r_detalle(j).val_codi_orig is not null) or (orig_ante is not null and orig_ante<>r_detalle(j).val_codi_orig and r_detalle(j).val_codi_orig is not null) then
 
                                 l_textoActual := '<txt>H' || '<t/>';

                                      -- Codigo de Venta
                                      l_textoActual := l_textoActual || r_detalle(j).val_codi_orig;
                                      l_textoActual := l_textoActual || '<t/>';
      
                                      -- Descripcion
                                      l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Unidades demandadas
                                      l_textoActual := l_textoActual || r_detalle(j).num_unid_orig;
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Unidades atendidas
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio unitario
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio total
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- % Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Importe Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio Catalogo
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Total Precio Catalogo
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Oportunidad de Ahorro
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Total con Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Observaciones
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '</txt>';
                                      DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                
                                end if;
                                
                                l_textoActual := '<txt>';
                                
                                if r_detalle(j).val_codi_orig is not null then
                                   l_textoActual := l_textoActual || 'D<t/>';
                                end if;

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogo, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogoTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || trim(to_char(l_oportunidadAhorro, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                
                                
                                if p_codigoPais<>'BOE' then
                                     l_textoActual := l_textoActual || '</txt>';
                                else 
                                     l_textoActual := l_textoActual || '<tr/>';
                                end if;
                                
                                if p_codigoPais='BOE' then
                                    -- Indicador Fuera de Caja
                                    l_textoActual := l_textoActual || r_detalle(j).ind_dent_fuer_caja_bols;
                                    l_textoActual := l_textoActual || '</txt>';
                                end if;
                                
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPrecioCatalogo := l_subtotalPrecioCatalogo + l_precioCatalogo;
                                l_subtotalPrecioCatalogoTotal := l_subtotalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_subtotaloportunidadAhorro := l_subtotaloportunidadAhorro + l_oportunidadAhorro;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalDescuentos2 := l_totalDescuentos2 + l_descuento2;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPrecioCatalogo := l_totalPrecioCatalogo + l_precioCatalogo;
                                l_totalPrecioCatalogoTotal := l_totalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_totalOportunidadAhorro := l_totalOportunidadAhorro + l_oportunidadAhorro;

                                /*update ped_solic_posic xx set xx.val_prec_publ_unit_loca=r_detalle(j).imp_prec_publ--*r_detalle(j).num_unid_aten
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;

                                update ped_solic_posic xx set xx.val_prec_publ_tota_loca=l_oportunidadAhorro
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;*/
                                
                                orig_ante:=r_detalle(j).val_codi_orig;
                                
                            end if;
                            END LOOP;
                        END IF;

                    -- Cerramos el cursor de detalles

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogoTotal, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotaloportunidadAhorro, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        if k=0 then
                           l_oportunidadCatalogo:=l_subtotaloportunidadAhorro;
                        elsif k=1 then
                           l_oportunidadRevista:=l_subtotaloportunidadAhorro;
                        end if;
                        if k=0 or k=1 then
                           l_totalCatalogo2:=l_totalCatalogo2+l_subtotalCatalogo;
                        end if;
                        if k=2 then
                           l_totalMAV:=l_totalMAV+l_subtotalCatalogo;
                        end if;
                    END IF;
                    END LOOP;

                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;

                
                
                -- Totales

                -- Al descuento le agregamos el redondeo
                if lv_redondeoDesc='S' then
                   l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                end if;


                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogoTotal, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalOportunidadAhorro, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := l_textoActual || '<pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Obtenemos los valores faltantes
                -- Saldo a favor al momento de pasar y fue aplicado
                --l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);
                --l_saldoFavor := r_consolidado(i).saldoAFavor;

                -- Saldo anterior
                --l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');
                --l_saldoAnterior := r_consolidado(i).saldoAnterior;

                -- Restamos al saldo anterior el saldo a favor
                --l_saldoAnterior := l_saldoAnterior - l_saldoFavor;

               BEGIN

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaVencimiento
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = 'CV';

               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');
               END;

               -- Funcionalidad Flexipago
               IF lv_reemplazoOCS='S' THEN
                l_interesFlexipago := NVL(CCC_PKG_GENER.CCC_FN_OBTIE_INTER_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0);
                l_saldoFlexAnterior := ROUND(NVL(CCC_PKG_GENER.CCC_FN_OBTIE_MONTO_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0),2);
               ELSE
                l_interesFlexipago :=0 ;
                l_saldoFlexAnterior := 0;
               END IF;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos+nvl(r_consolidado(i).gastos,0)) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca +  l_interesFlexipago + l_percepcion;


                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                /*
                IF l_indicadorImpuestosGratis = 'S' THEN

                 l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;

                END IF;
                */

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri mcc
                WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                  AND mcc.imp_pend > 0
                  AND mcc.perd_oid_peri > l_oidPeriodo
                  AND mcc.soca_oid_soli_cabe =r_consolidado(i).OID_SOLI_CABE ;


                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;
                else
                    l_cargoFamSegura:=0;

                END IF;



                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior + Cuota Flexipago = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);

                IF lv_indiejec='S' then
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura + nvl(r_consolidado(i).gastos,0) + + nvl(r_consolidado(i).gastos2,0);
                END IF;

                IF lv_indiejec2 is not null then
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura + nvl(r_consolidado(i).val_impo_impu_tota_loca,0);
                END IF;

                begin

                SELECT c.camp_ulti_pedi
                into lscodperigastos
                FROM ccc_detal_consu_gasto_admin c, ped_solic_cabec a
                WHERE c.soca_oid_soli_cabe_deud = a.oid_soli_cabe
                and a.soca_oid_soli_cabe=r_consolidado(i).oid_soli_cabe;

                exception when others then
                          NULL;
                end;


                /********************************************************************
                Saldo Anterior = Total Monto a Pagar - Total Factura + Pagos Posteriores - Cargo Familia Segura - Cuota Flexipago
                **********************************************************************/
                l_saldoAnterior := l_totalAPagar  + l_totalPagoPosterior - l_totalFactura  - l_cargoFamSegura - l_saldoFlexAnterior;

                
                if ln_desc_flete='S' then
                   
                   l_totalFactura:=l_totalFactura-nvl(r_consolidado(i).val_impo_desc_flet,0);
                   
                end if;
                
                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    l_textoActual := l_textoActual || '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := l_textoActual || '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := l_textoActual || '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := l_textoActual || '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca-r_consolidado(i).val_reca_flet_loca, l_formatoNumerico)) || '</linea4>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := l_textoActual || '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := l_textoActual || '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := l_textoActual || '<linea7>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea7>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := l_textoActual || '<linea8>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea8>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := l_textoActual || '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := l_textoActual || '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := l_textoActual || '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := l_textoActual || '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := l_textoActual || '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := l_textoActual || '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := l_textoActual || '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                      -- Gastos Administrativos
                      l_textoActual := l_textoActual || '<linea16>' || trim(to_char(nvl(r_consolidado(i).gastos,0), l_formatoNumerico)) || '</linea16>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                      -- Saldo Flexipago
                      l_textoActual := l_textoActual || '<linea17>' || trim(to_char(l_interesFlexipago, l_formatoNumerico)) || '</linea17>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                      -- Cuota Flexipago
                      l_textoActual := l_textoActual || '<linea18>' || trim(to_char(l_saldoFlexAnterior, l_formatoNumerico)) || '</linea18>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                    IF lsactividadparametro is not null THEN
                        -- Recargo Flete
                        l_textoActual := l_textoActual || '<linea19>' || trim(to_char(nvl(r_consolidado(i).val_reca_flet_loca,0), l_formatoNumerico)) || '</linea19>';
                    END IF;


                      -- Descuento Cabecera
                      l_textoActual := l_textoActual || '<linea20>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0), l_formatoNumerico)) || '</linea20>';

                      -- Campa?a de Gasto Administrativo
                      l_textoActual := l_textoActual || '<linea21>' || lscodperigastos || '</linea21>';

                    -- Descuento Cabecera2
                    l_textoActual := l_textoActual || '<linea22>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0), l_formatoNumerico)) || '</linea22>';

                    -- Reclamos Pendientes
                    l_textoActual := l_textoActual || '<linea23>' || trim(to_char(nvl(r_consolidado(i).val_recl_pend,0), l_formatoNumerico)) || '</linea23>';

                    -- Total Catalogo2
                    l_textoActual := l_textoActual || '<linea24>' || trim(to_char(nvl(l_totalCatalogo2,0), l_formatoNumerico)) || '</linea24>';

                    -- Total MAV
                    l_textoActual := l_textoActual || '<linea25>' || trim(to_char(nvl(l_totalMAV,0), l_formatoNumerico)) || '</linea25>';


                ELSE

                    -- Total Catalogo
                    l_textoActual := l_textoActual || '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := l_textoActual || '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := l_textoActual || '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := l_textoActual || '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := l_textoActual || '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := l_textoActual || '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := l_textoActual || '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := l_textoActual || '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := l_textoActual || '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := l_textoActual || '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := l_textoActual || '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := l_textoActual || '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := l_textoActual || '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := l_textoActual || '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := l_textoActual || '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto
                    l_textoActual := l_textoActual || '<linea16>' || trim(to_char(nvl(r_consolidado(i).val_impo_impu_tota_loca,0), l_formatoNumerico)) || '</linea16>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- subtotal con flete
                    l_textoActual := l_textoActual || '<linea17>' || trim(to_char(l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0), l_formatoNumerico)) || '</linea17>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- subtotal con flete e impuesto
                    l_textoActual := l_textoActual || '<linea18>' || trim(to_char(l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0)+nvl(r_consolidado(i).val_impo_impu_tota_loca,0), l_formatoNumerico)) || '</linea18>';

                    -- descuento flete
                    l_textoActual := l_textoActual || '<linea19>' || trim(to_char(r_consolidado(i).val_impo_desc_flet, l_formatoNumerico)) || '</linea19>';


                    -- Descuento Cabecera
                    l_textoActual := l_textoActual || '<linea20>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0), l_formatoNumerico)) || '</linea20>';

                      -- Gastos Administrativos
                      l_textoActual := l_textoActual || '<linea21>' || trim(to_char(nvl(r_consolidado(i).gastos,0)+nvl(r_consolidado(i).gastos2,0), l_formatoNumerico)) || '</linea21>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Descuento Cabecera2
                    l_textoActual := l_textoActual || '<linea22>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0), l_formatoNumerico)) || '</linea22>';

                    -- Reclamos Pendientes
                    l_textoActual := l_textoActual || '<linea23>' || trim(to_char(nvl(r_consolidado(i).val_recl_pend,0), l_formatoNumerico)) || '</linea23>';

                    -- Total Catalogo2
                    l_textoActual := l_textoActual || '<linea24>' || trim(to_char(nvl(l_totalCatalogo2,0), l_formatoNumerico)) || '</linea24>';

                    -- Total MAV
                    l_textoActual := l_textoActual || '<linea25>' || trim(to_char(nvl(l_totalMAV,0), l_formatoNumerico)) || '</linea25>';



                END IF;

                -- Fin Pie
                l_textoActual := l_textoActual || '</pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := l_textoActual || '</detfac2>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;

                update ped_solic_cabec xx set xx.val_gana_tota_loca=l_oportunidadCatalogo+l_oportunidadRevista
                where oid_soli_cabe=r_consolidado(i).oid_soli_cabe;


                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;
 COMMIT;
END;
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU3_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_fechaFacturacion IN VARCHAR2
                                   , p_oidZona NUMBER) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER,
                      oidRegi NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       0 SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(CON.OID_SOLI_CABE) SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(CON.OID_SOLI_CABE, '200902', 'A') SALDO_ANTERIOR
       0 SALDO_ANTERIOR,
       --con.val_tota_gast_admi GASTOS,
       con.val_impo_rete_desc,
       mcda.ind_impr_docu imprimefactel,
       mcda.ind_impr_pdoc imprimepaqdoc,
       con.val_tota_gast_admi GASTOS,
       (select val_nom1 || ' ' || val_nom2 from mae_clien where oid_clie=zon.clie_oid_clie)  nombreGZ,
       (select val_ape1 || ' ' || val_ape2 from mae_clien where oid_clie=zon.clie_oid_clie)  apellidosGZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)  celular_GZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=3 and rownum=1)  correo_GZ,
       (select decode(y.val_sigl,'RUC',y.val_sigl,'DNI') from mae_tipo_docum y where y.oid_tipo_docu=mci.tdoc_oid_tipo_docu and rownum=1) tipo_docum
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     mae_clien_datos_adici mcda,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCDA.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.PERD_OID_PERI = oidPeriodo
  AND ZON.Oid_Zona = oidRegi
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  );
--ORDER BY MC.COD_CLIE,
--         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    saldoAnterior           ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    saldoAFavor             ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
--    gastos                  ped_solic_cabec.val_tota_gast_admi%TYPE,
    val_impo_rete_desc      ped_solic_cabec.val_impo_rete_desc%TYPE,
    imprimefactel           mae_clien_datos_adici.ind_impr_docu%TYPE,
    imprimepaqdoc           mae_clien_datos_adici.ind_impr_pdoc%TYPE,
    gastos                  ped_solic_cabec.val_tota_gast_admi%TYPE,
    nombresGZ               varchar2(100),
    apellidosGZ             varchar2(100),
    celularGZ               varchar2(100),
    correoGZ               varchar2(100),
    tipo_docum               varchar2(100)

);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER
,v_desPremioAgotado VARCHAR2
,v_desAgotado VARCHAR2
,v_desFaltLiq VARCHAR2
,v_desFaltAnun VARCHAR2
,v_desAnulMotMax VARCHAR2
,v_desPremio VARCHAR2
,v_desAtRec VARCHAR2
,v_desRecup VARCHAR2
,v_desReemp VARCHAR2
,v_desGratis VARCHAR2
,v_desPremioLET VARCHAR2
,v_desOfertNavid VARCHAR2
, v_oidestra  NUMBER
) IS
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       --(SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       imp_fn_desc_produ(p_codigoPais,psp.prod_oid_prod) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       POD.IMP_PREC_PUBL,
       PSP.FOPA_OID_FORM_PAGO,
       psp.val_prec_sin_impu_tota_loca,
       decode(psc.modu_oid_modu,15,3,nvl(PTO.NUM_SECC_DETA_FACT,2)) IND_GRUP,
       psp.val_codi_orig,
       psp.num_unid_orig,
       psp.oid_nive_ofer,
       CASE
           WHEN exists (select 1 from pre_ofert x where x.oid_ofer=pod.ofer_oid_ofer and x.coes_oid_estr=v_oidestra)
               THEN v_desOfertNavid
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremioAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN v_desAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN v_desFaltLiq
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN v_desFaltAnun
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN v_desAnulMotMax
           /*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'*/
          WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN v_desAgotado
           /*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'*/
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremio
           WHEN PSC.MODU_OID_MODU = '15'
               THEN v_desAtRec
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN v_desRecup
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN ''
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN v_desReemp  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN v_desGratis
           WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN v_desPremioLET
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_SUBTI_POSIC PST--,
     --PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  --AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY OID_NIVE_OFER, VAL_CODI_ORIG, VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    val_prec_sin_impu_tota_loca ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    ind_grupo                   pre_tipo_ofert.num_secc_deta_fact%TYPE,
    val_codi_orig               ped_solic_posic.val_codi_orig%TYPE,
    num_unid_orig               ped_solic_posic.num_unid_orig%TYPE,
    oid_nive_ofer               ped_solic_posic.oid_nive_ofer%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;



CURSOR c_detalle1(oidConsolidado NUMBER) IS
SELECT NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       SUM(PSP.val_prec_sin_impu_tota_loca) VAL_PREC_CATA_TOTA_LOCA,
       SUM(PSP.VAL_IMPO_DESC_TOTA_LOCA)
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
GROUP BY NVL(PSP.VAL_PORC_DESC, 0)
ORDER BY NVL(PSP.VAL_PORC_DESC, 0);

TYPE detallerecord1 IS RECORD (
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE
);

TYPE detalletype1 IS TABLE OF detallerecord1;
r_detalle1    detalletype1;


-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;
l_precioCatalogo            NUMBER(12, 2) := 0;
l_PrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_oportunidadAhorro         NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogo    NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_subtotaloportunidadAhorro NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPrecioCatalogo       NUMBER(12, 2) := 0;
l_totalPrecioCatalogoTotal  NUMBER(12, 2) := 0;
l_totalOportunidadAhorro    NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_oportunidadCatalogo       NUMBER(12, 2) := 0;
l_oportunidadRevista        NUMBER(12, 2) := 0;

l_totalCatalogo2        NUMBER(12, 2) := 0;
l_totalMAV              NUMBER(12, 2) := 0;


l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro

l_nombreSeccion1 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion1');
l_nombreSeccion2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion2');
l_nombreSeccion3 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion3');
l_nombreSeccion4 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion4');

l_desPremioAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioAgotado');
l_desAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAgotado');
l_desFaltLiq VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltLiq');
l_desFaltAnun VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltAnun');
l_desAnulMotMax VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAnulMotMax');
l_desPremio VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremio');
l_desAtRec VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAtRec');
l_desRecup VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecup');
l_desReemp VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desReemp');
l_desGratis VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desGratis');
l_desPremioLET VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioLET');
l_desOfertNavid VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desOfertNavid');


l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := '';
l_fechaCV VARCHAR2(100) := '';

l_flagTitulo1     NUMBER:=0;
l_flagTitulo2     NUMBER:=0;
l_flagTitulo3     NUMBER:=0;
l_flagTitulo4     NUMBER:=0;

l_cantidadOC      NUMBER:=0;

lv_indiejec VARCHAR2(10):=nvl(sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_GASTO_ADMIN'),'N');

lv_reemplazoOCS VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorReemplazoOCS');

ln_oidestra NUMBER(10):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_ESTRA_NAVID');



lv_actividadConf VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadConf'),'CV');

lv_actividadDesp VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadDesp'),'DP');

lv_imprimepaqdoc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimepaqdoc'),'N');

lv_imprimefactel VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimefactel'),'N');

lv_imprimenuevos VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimenuevos'),'N');


ln_diasdesp NUMBER(10):= 0;
ln_diasdesp2 NUMBER(10):= 0;
ln_diasdesp3 NUMBER(10):= 0;


l_fechaDespacho VARCHAR2(100) := '';
l_fechaDespacho_2 VARCHAR2(100) := '';
l_fechaDespacho_3 VARCHAR2(100) := '';
l_fechaDespacho2 VARCHAR2(100) :=  nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indFechaDesp2'),'N');
l_fechaSigFact VARCHAR2(100) := '';
l_fechaSigFact2 VARCHAR2(100) := '';
l_fechaSigFact3 VARCHAR2(100) := '';

lsactividadparametro VARCHAR2(100):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,
                                                                 'STO_ACTIV_RECAR_FLET');


l_saldoFlexAnterior         NUMBER(12, 2) := 0;
l_interesFlexipago          NUMBER(12, 2) := 0;

orig_ante VARCHAR2(100):='';

BEGIN


    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;


    -- Obtenemos el valor del ultimo numero de lote de facturacion
    /*
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;*/

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';
    --delete from IMP_PAQUE_DOCUM_DETAL_FACTU;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion, p_oidZona);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                l_flagTitulo1:=0;
                l_flagTitulo2:=0;
                l_flagTitulo3:=0;
                l_flagTitulo4:=0;
                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac3>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := l_textoActual || '<blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                if lv_imprimefactel='S' then
                  -- Ind. Impresion
                  l_textoActual := l_textoActual || '<imprimefactel>' || r_consolidado(i).imprimefactel || '</imprimefactel>';

                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                if lv_imprimepaqdoc='S' then
                  -- Ind. Impresion
                  l_textoActual := l_textoActual || '<imprimepaqdoc>' || r_consolidado(i).imprimepaqdoc || '</imprimepaqdoc>';

                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                if lv_imprimenuevos='S' then

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaDespacho,l_fechaDespacho_2,l_fechaDespacho_3
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadDesp;
                  exception when others then
                    l_fechaDespacho:=trunc(sysdate);
                    l_fechaDespacho_2:=trunc(sysdate);
                    l_fechaDespacho_3:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaSigFact
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = 'FA';
                  exception when others then
                    l_fechaSigFact:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaCV
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadConf;
                  exception when others then
                    l_fechaCV:=trunc(sysdate);
                  end;

                  l_fechaSigFact2:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,2),'dd/mm/yyyy');

                  l_fechaSigFact3:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,3),'dd/mm/yyyy');

                  ln_diasdesp:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,1,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp2:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,2,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp3:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,3,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));


                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho:=to_char(to_date(l_fechaSigFact,'dd/mm/yyyy')+ln_diasdesp,'dd/mm/yyyy');
                  end if;

                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_2:=to_char(to_date(l_fechaSigFact2,'dd/mm/yyyy')+ln_diasdesp2,'dd/mm/yyyy');
                  end if;

                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_3:=to_char(to_date(l_fechaSigFact3,'dd/mm/yyyy')+ln_diasdesp3,'dd/mm/yyyy');
                  end if;

                  -- Nombre Consultora
                  l_textoActual := l_textoActual || '<nombres>' || r_consolidado(i).val_nom1 || ' ' || r_consolidado(i).val_nom2 || '</nombres>';
                  l_textoActual := l_textoActual || '<apellidos>' || r_consolidado(i).val_ape1 || ' ' || r_consolidado(i).val_ape2 || '</apellidos>';
                  l_textoActual := l_textoActual || '<nombresGZ>' || r_consolidado(i).nombresGZ || '</nombresGZ>';
                  l_textoActual := l_textoActual || '<apellidosGZ>' || r_consolidado(i).apellidosGZ || '</apellidosGZ>';
                  l_textoActual := l_textoActual || '<celularGZ>' || r_consolidado(i).celularGZ || '</celularGZ>';
                  l_textoActual := l_textoActual || '<correoGZ>' || r_consolidado(i).correoGZ || '</correoGZ>';
                  l_textoActual := l_textoActual || '<fechaCV>' || l_fechaCV || '</fechaCV>';
                  l_textoActual := l_textoActual || '<fechaReparto>' || l_fechaDespacho || '</fechaReparto>';
                  l_textoActual := l_textoActual || '<fechaReparto2>' || l_fechaDespacho_2 || '</fechaReparto2>';
                  l_textoActual := l_textoActual || '<fechaReparto3>' || l_fechaDespacho_3 || '</fechaReparto3>';
                  l_textoActual := l_textoActual || '<fechaSigFact>' || l_fechaSigFact || '</fechaSigFact>';
                  l_textoActual := l_textoActual || '<fechaSigFact2>' || l_fechaSigFact2 || '</fechaSigFact2>';
                  l_textoActual := l_textoActual || '<fechaSigFact3>' || l_fechaSigFact3 || '</fechaSigFact3>';
                  l_textoActual := l_textoActual || '<diasDesp>' || ln_diasdesp || '</diasDesp>';
                  l_textoActual := l_textoActual || '<tipo_docum>' || r_consolidado(i).tipo_docum || '</tipo_docum>';
                  l_textoActual := l_textoActual || imp_fn_xml_opor_ahor(p_codigoPeriodo,l_oidPeriodo,r_consolidado(i).oid_clie);
                end if;

                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                /*
                l_textoActual := '<nombreColumnas><txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_nombreColumna1 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna2 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna3 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna4 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna5 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna6 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna7 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna8 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna9 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna10 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                l_textoActual := l_nombreColumna11 || '<tc/>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := '</txt></nombreColumnas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                */
                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPrecioCatalogo := 0;
                l_totalPrecioCatalogoTotal := 0;
                l_totalOportunidadAhorro := 0;
                l_oportunidadRevista:=0;
                l_oportunidadCatalogo:=0;

                l_totalCatalogo2:=0;
                l_totalMAV:=0;


                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe
                      ,l_desPremioAgotado
                      ,l_desAgotado
                      ,l_desFaltLiq
                      ,l_desFaltAnun
                      ,l_desAnulMotMax
                      ,l_desPremio
                      ,l_desAtRec
                      ,l_desRecup
                      ,l_desReemp
                      ,l_desGratis
                      ,l_desPremioLET
                      ,l_desOfertNavid
                      ,ln_oidestra
                    );
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;
                FOR k IN 0..3
                LOOP

                    -- Iniciamos los subtotales

                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPrecioCatalogo := 0;
                    l_subtotalPrecioCatalogoTotal := 0;
                    l_subtotaloportunidadAhorro := 0;
                    l_oportunidadAhorro := 0;

                    -- Mostramos el titulo


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP
                            if r_detalle(j).ind_grupo=k then

                                IF k = 0 and l_flagTitulo1=0 THEN
                                    l_textoActual := '<txt><u>' || l_nombreSeccion1 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo1:=1;
                                ELSIF k = 1 and l_flagTitulo2=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion2 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo2:=1;
                                ELSIF k = 2 and l_flagTitulo3=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion3 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo3:=1;
                                ELSIF k = 3 and l_flagTitulo4=0 THEN
                                    l_textoActual := '<txt/>';
                                    l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion4 || '</u></txt><txt><t/></txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo4:=1;
                                END IF;
                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                    l_oportunidadAhorro := 0;
                                    l_precioCatalogo := 0;
                                    l_PrecioCatalogoTotal := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                        l_oportunidadAhorro := 0;
                                        l_precioCatalogo := 0;
                                        l_PrecioCatalogoTotal := 0;
                                        if r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        end if;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;
                                        if r_detalle(j).ind_grupo=0 then
                                           l_precioCatalogo := l_precioUnitario;
                                           l_PrecioCatalogoTotal := l_precioTotal;
                                           l_oportunidadAhorro := l_descuento;
                                        elsif r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal-l_precioTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        else
                                           l_precioCatalogo := 0;
                                           l_PrecioCatalogoTotal := 0;
                                           l_oportunidadAhorro := 0;
                                        end if;

                                        -- Pago posterior (fraccionado)
                                        --l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                if (orig_ante is null and r_detalle(j).val_codi_orig is not null) or (orig_ante is not null and orig_ante<>r_detalle(j).val_codi_orig and r_detalle(j).val_codi_orig is not null) then
 
                                 l_textoActual := '<txt>H' || '<t/>';

                                      -- Codigo de Venta
                                      l_textoActual := l_textoActual || r_detalle(j).val_codi_orig;
                                      l_textoActual := l_textoActual || '<t/>';
      
                                      -- Descripcion
                                      l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Unidades demandadas
                                      l_textoActual := l_textoActual || r_detalle(j).num_unid_orig;
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Unidades atendidas
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio unitario
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio total
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- % Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Importe Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Precio Catalogo
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Total Precio Catalogo
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Oportunidad de Ahorro
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Total con Descuento
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '<tr/>';
      
                                      -- Observaciones
                                      l_textoActual := l_textoActual || '';
                                      l_textoActual := l_textoActual || '</txt>';
                                      DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                
                                end if;
                                
                                l_textoActual := '<txt>';
                                
                                if r_detalle(j).val_codi_orig is not null then
                                   l_textoActual := l_textoActual || 'D<t/>';
                                end if;

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(r_detalle(j).val_prec_sin_impu_tota_loca, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogo, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogoTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || trim(to_char(l_oportunidadAhorro, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPrecioCatalogo := l_subtotalPrecioCatalogo + l_precioCatalogo;
                                l_subtotalPrecioCatalogoTotal := l_subtotalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_subtotaloportunidadAhorro := l_subtotaloportunidadAhorro + l_oportunidadAhorro;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPrecioCatalogo := l_totalPrecioCatalogo + l_precioCatalogo;
                                l_totalPrecioCatalogoTotal := l_totalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_totalOportunidadAhorro := l_totalOportunidadAhorro + l_oportunidadAhorro;

                                /*update ped_solic_posic xx set xx.val_prec_publ_unit_loca=r_detalle(j).imp_prec_publ--*r_detalle(j).num_unid_aten
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;

                                update ped_solic_posic xx set xx.val_prec_publ_tota_loca=l_oportunidadAhorro
                                where oid_soli_posi=r_detalle(j).oid_soli_posi;*/
                            end if;

                                orig_ante:=r_detalle(j).val_codi_orig;

                            END LOOP;
                        END IF;

                    -- Cerramos el cursor de detalles

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogoTotal, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotaloportunidadAhorro, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        if k=0 then
                           l_oportunidadCatalogo:=l_subtotaloportunidadAhorro;
                        elsif k=1 then
                           l_oportunidadRevista:=l_subtotaloportunidadAhorro;
                        end if;
                        if k=0 or k=1 then
                           l_totalCatalogo2:=l_totalCatalogo2+l_subtotalCatalogo;
                        end if;
                        if k=2 then
                           l_totalMAV:=l_totalMAV+l_subtotalCatalogo;
                        end if;
                    END IF;
                    END LOOP;

                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;



                -- Totales

                -- Al descuento le agregamos el redondeo
                --l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogoTotal, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalOportunidadAhorro, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Inicio Detalle1
                l_textoActual := l_textoActual || '<detalle1>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Iteramos por las secciones del detalle
                    OPEN c_detalle1(r_consolidado(i).oid_soli_cabe);
                    LOOP
                        FETCH c_detalle1 BULK COLLECT
                        INTO r_detalle1 LIMIT w_filas;

                        IF  r_detalle1.COUNT > 0 THEN
                            FOR j IN r_detalle1.FIRST..r_detalle1.LAST
                            LOOP
                                l_textoActual := l_textoActual || '<txt>';

                                -- Porcentaje
                                l_textoActual := l_textoActual || r_detalle1(j).val_porc_desc;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Total Catalogo
                                l_textoActual := l_textoActual || trim(to_char(r_detalle1(j).val_prec_cata_tota_loca, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total Descuento
                                l_textoActual := l_textoActual || trim(to_char(r_detalle1(j).val_impo_desc_tota_loca, l_formatoNumerico));
                                l_textoActual := l_textoActual || '</txt>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                            end loop;
                         end if;

                        EXIT WHEN c_detalle1%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle1;

                -- Fin Detalle1
                l_textoActual := l_textoActual || '</detalle1>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := l_textoActual || '<pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Obtenemos los valores faltantes
                -- Saldo a favor al momento de pasar y fue aplicado
                --l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);
                --l_saldoFavor := r_consolidado(i).saldoAFavor;

                -- Saldo anterior
                --l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');
                --l_saldoAnterior := r_consolidado(i).saldoAnterior;

                -- Restamos al saldo anterior el saldo a favor
                --l_saldoAnterior := l_saldoAnterior - l_saldoFavor;

               BEGIN

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaVencimiento
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = p_codigoPeriodo
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = 'V1';

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaCV
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = 'RE';

               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaCV:=to_char(sysdate,'dd/mm/yyyy');
               END;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos+nvl(r_consolidado(i).gastos,0)) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion+nvl(r_consolidado(i).val_impo_rete_desc,0);


                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                /*
                IF l_indicadorImpuestosGratis = 'S' THEN

                 l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;

                END IF;
                */

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;


                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;
                 else
                     l_cargoFamSegura:=0;

                END IF;


                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);

                IF lv_indiejec='S' THEN
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura+nvl(r_consolidado(i).gastos,0);
                END IF;

                l_saldoAnterior := l_totalAPagar - l_totalFactura - nvl(r_consolidado(i).gastos,0) - l_cargoFamSegura + l_totalPagoPosterior;



                -- En Peru el pie es diferente al resto de paises por las percepciones

                    -- Total Catalogo
                    l_textoActual := l_textoActual || '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := l_textoActual || '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := l_textoActual || '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos+nvl(r_consolidado(i).val_impo_rete_desc,0), l_formatoNumerico)) || '</linea3>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := l_textoActual || '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := l_textoActual || '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := l_textoActual || '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := l_textoActual || '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := l_textoActual || '<linea8>' || trim(to_char(nvl(r_consolidado(i).gastos,0), l_formatoNumerico)) || '</linea8>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := l_textoActual || '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := l_textoActual || '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Catalogo
                    l_textoActual := l_textoActual || '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Revista
                    l_textoActual := l_textoActual || '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Oportunidad Total
                    l_textoActual := l_textoActual || '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Mensaje
                    l_textoActual := l_textoActual || '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha Vencimiento
                    l_textoActual := l_textoActual || '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Descuento Total
                    l_textoActual := l_textoActual || '<linea16>' || trim(to_char(l_totalDescuentos-nvl(r_consolidado(i).val_impo_rete_desc,0), l_formatoNumerico)) || '</linea16>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Retencion
                    l_textoActual := l_textoActual || '<linea17>' || trim(to_char(nvl(r_consolidado(i).val_impo_rete_desc,0), l_formatoNumerico)) || '</linea17>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha CV
                    l_textoActual := l_textoActual || '<linea18>' || trim(to_char(nvl(r_consolidado(i).val_impo_rete_desc,0), l_formatoNumerico)) || '</linea18>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Fecha V1
                    l_textoActual := l_textoActual || '<linea19>' || trim(l_fechaCV) || '</linea19>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                l_interesFlexipago := NVL(CCC_PKG_GENER.CCC_FN_OBTIE_INTER_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0);
                l_saldoFlexAnterior := ROUND(NVL(CCC_PKG_GENER.CCC_FN_OBTIE_MONTO_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0),2);

                      -- Saldo Flexipago
                      l_textoActual := l_textoActual || '<linea20>' || trim(to_char(l_interesFlexipago, l_formatoNumerico)) || '</linea20>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                      -- Cuota Flexipago
                      l_textoActual := l_textoActual || '<linea21>' || trim(to_char(l_saldoFlexAnterior, l_formatoNumerico)) || '</linea21>';
                      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                      --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Catalogo2
                    l_textoActual := l_textoActual || '<linea24>' || trim(to_char(nvl(l_totalCatalogo2,0), l_formatoNumerico)) || '</linea24>';

                    -- Total MAV
                    l_textoActual := l_textoActual || '<linea25>' || trim(to_char(nvl(l_totalMAV,0), l_formatoNumerico)) || '</linea25>';


                -- Fin Pie
                l_textoActual := l_textoActual || '</pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := l_textoActual || '</detfac3>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;

                update ped_solic_cabec xx set xx.val_gana_tota_loca=l_oportunidadCatalogo+l_oportunidadRevista
                where oid_soli_cabe=r_consolidado(i).oid_soli_cabe;


                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;
 COMMIT;
END;
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de factura modificada por Proyecto UNO y
                      optimizada para lanzarse en paralelo por region.
Fecha Creacion      : 13/09/2011
Fecha Modificacion  : 13/09/2011
Autor               : Jorge Yepez Reyes - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU4_REGI(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_fechaFacturacion IN VARCHAR2
                                   , p_oidZona NUMBER) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER,
                      oidRegi NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_IMPU_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       0 SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(CON.OID_SOLI_CABE) SALDO_A_FAVOR,
       --IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(CON.OID_SOLI_CABE, '200902', 'A') SALDO_ANTERIOR
       0 SALDO_ANTERIOR,
       con.val_tota_gast_admi GASTOS,
       con.val_impo_rete_desc,
       nvl(
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=con.clie_oid_clie and x.ticm_oid_tipo_comu=1 and rownum=1),
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=con.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)
       )  TEL_CLIE,
       (select val_nom1 || ' ' || val_nom2 || ' ' || val_ape1 || ' ' || val_ape2 from mae_clien where oid_clie=zon.clie_oid_clie)  GERENTE,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)  CEL_GERENTE,
       (select val_nom1 || ' ' || val_nom2 || ' ' || val_ape1 || ' ' || val_ape2 from mae_clien where oid_clie=sec.clie_oid_clie)  EJECUTIVA,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=sec.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)  CEL_EJECUTIVA,
       (select num_docu_cont_inte from fac_docum_conta_cabec where soca_oid_soli_cabe=con.oid_soli_cabe and tido_oid_tipo_docu=1 and rownum=1) factura,
       mcda.ind_impr_pdoc
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     mae_clien_datos_adici mcda,
     PED_SOLIC_CABEC CON,
     --fac_docum_conta_cabec fdc,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  and MC.OID_CLIE = mcda.CLIE_OID_CLIE
  --and con.oid_soli_cabe=fdc.soca_oid_soli_cabe
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  --and fdc.tido_oid_tipo_docu=1
  AND CON.PERD_OID_PERI = oidPeriodo
  AND ZON.Oid_Zona = oidRegi
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  );
--ORDER BY MC.COD_CLIE,
--         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_impu_tota_loca ped_solic_cabec.val_impo_impu_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    saldoAnterior           ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    saldoAFavor             ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    gastos                  ped_solic_cabec.val_tota_gast_admi%TYPE,
    val_impo_rete_desc      ped_solic_cabec.val_impo_rete_desc%TYPE,
    tel_clie                 varchar2(100),
    gerente                 varchar2(100),
    cel_gerente                 varchar2(100),
    ejecutiva               varchar2(100),
    cel_ejecutiva               varchar2(100),
    numero_factura              varchar2(100),
    ind_impr_pdoc               varchar2(10)
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER
,v_desPremioAgotado VARCHAR2
,v_desAgotado VARCHAR2
,v_desFaltLiq VARCHAR2
,v_desFaltAnun VARCHAR2
,v_desAnulMotMax VARCHAR2
,v_desPremio VARCHAR2
,v_desAtRec VARCHAR2
,v_desRecup VARCHAR2
,v_desReemp VARCHAR2
,v_desGratis VARCHAR2
,v_desPremioLET VARCHAR2
,v_desOfertNavid VARCHAR2
, v_oidestra  NUMBER
) IS
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       --(SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       imp_fn_desc_produ(p_codigoPais,psp.prod_oid_prod) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       decode(psp.val_prec_cata_unit_loca,0,0,PSP.VAL_PREC_FACT_TOTA_LOCA) VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       decode(psp.num_unid_compr,0,0,decode(psp.val_prec_cata_unit_loca,0,0,NVL(PSP.VAL_PORC_DESC, 0))) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       case when psp.val_prec_cata_unit_loca=0 then psp.val_prec_cata_tota_loca
         when pto.num_secc_deta_fact=0 then psp.val_impo_desc_tota_loca
         when pto.num_secc_deta_fact=1 then psp.val_impo_desc_tota_loca--(nvl(pod.imp_prec_publ,0)*psp.num_unid_aten)-psp.val_prec_cata_tota_loca
         else psp.val_impo_desc_tota_loca
         end
         IMP_PREC_PUBL,
       psp.val_prec_sin_impu_tota_loca,
       psp.val_codi_orig,
       psp.num_unid_orig,
       psp.oid_nive_ofer,
       case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end des_cata,
       sum(PSP.NUM_UNID_DEMA_REAL) over (partition by               case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end) UNID_SOLI_CATA,
       sum(PSP.NUM_UNID_DEMA_REAL) over () UNID_SOLI_TOTA,
       sum(PSP.NUM_UNID_ATEN) over (partition by               case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end) UNID_ATEN_CATA,
       sum(PSP.NUM_UNID_ATEN) over () UNID_ATEN_TOTA,
       sum(PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN) over (partition by        case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end) PREC_CATA,
       sum(PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN) over () PREC_TOTA,
       sum(decode(psp.val_prec_cata_unit_loca,0,0,PSP.VAL_PREC_FACT_TOTA_LOCA)) over (partition by        case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end) TOTA_CATA,
       sum(decode(psp.val_prec_cata_unit_loca,0,0,PSP.VAL_PREC_FACT_TOTA_LOCA)) over () TOTA_TOTA,
       sum(       case when psp.val_prec_cata_unit_loca=0 then psp.val_prec_cata_tota_loca
         when pto.num_secc_deta_fact=0 then psp.val_impo_desc_tota_loca
         when pto.num_secc_deta_fact=1 then psp.val_impo_desc_tota_loca--(nvl(pod.imp_prec_publ,0)*psp.num_unid_aten)-psp.val_prec_cata_tota_loca
         else psp.val_impo_desc_tota_loca
         end) over (partition by        case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end) OPOR_CATA,
       sum(       case when psp.val_prec_cata_unit_loca=0 then psp.val_prec_cata_tota_loca
         when pto.num_secc_deta_fact=0 then psp.val_impo_desc_tota_loca
         when pto.num_secc_deta_fact=1 then psp.val_impo_desc_tota_loca--(nvl(pod.imp_prec_publ,0)*psp.num_unid_aten)-psp.val_prec_cata_tota_loca
         else psp.val_impo_desc_tota_loca
         end) over () OPOR_TOTA,
              CASE
           WHEN exists (select 1 from pre_ofert x where x.oid_ofer=pod.ofer_oid_ofer and x.coes_oid_estr=v_oidestra)
               THEN v_desOfertNavid
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremioAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN v_desAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN v_desFaltLiq
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN v_desFaltAnun
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.STPO_OID_SUBT_POSI = 21
               THEN v_desAnulMotMax
           /*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'*/
          WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN v_desAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No Cumple'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremio
           WHEN PSC.MODU_OID_MODU = '15'
               THEN v_desAtRec
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN v_desRecup
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN v_desReemp  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_CODIG_ALTER PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_ALTE
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN v_desReemp  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN v_desGratis
           /*WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN v_desPremioLET*/
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PED_SUBTI_POSIC PST,
     PED_TIPO_POSIC PTP,
     ped_tipo_solic_pais PTSP,
     ped_tipo_solic TS,
     PRE_TIPO_OFERT PTO,
     pre_catal CAT,
     mae_produ mp
     --PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER(+)
  and pod.tofe_oid_tipo_ofer=pto.oid_tipo_ofer(+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  and psp.prod_oid_prod=mp.oid_prod
  and psc.tspa_oid_tipo_soli_pais=ptsp.oid_tipo_soli_pais
  and ptsp.tsol_oid_tipo_soli=ts.oid_tipo_soli
  and psp.stpo_oid_subt_posi=pst.oid_subt_posi(+)
  and psp.tpos_oid_tipo_posi=ptp.oid_tipo_posi(+)
  and pod.ocat_oid_catal=cat.oid_cata(+)
  and psc.modu_oid_modu<>13
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado

--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY               case
       when exists (select 1 from fac_tipo_ofert_exclu x
                 where x.tofe_oid_tipo_ofer=pod.tofe_oid_tipo_ofer) then (select lpad(cod_cata,2,'0') || des_cata from pre_catal where cod_cata='2')
       when nvl(mp.val_atri_3,0)=1 then '99CARGO POR USO FLEXIPAGO'
       when psp.val_prec_cata_unit_loca=0 then '97ADICIONALMENTE ESTA CAMPA?A GANASTE'
       else  lpad(cat.cod_cata,2,'0') || cat.des_cata
       end, psp.oid_nive_ofer, psp.val_codi_orig, psp.val_codi_vent;


TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    val_prec_sin_impu_tota_loca ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    val_codi_orig               ped_solic_posic.val_codi_orig%TYPE,
    num_unid_orig               ped_solic_posic.num_unid_orig%TYPE,
    oid_nive_ofer               ped_solic_posic.oid_nive_ofer%TYPE,
    des_cata                    pre_catal.des_cata%TYPE,
    unid_soli_cata              ped_solic_posic.num_unid_dema_real%TYPE,
    unid_soli_tota              ped_solic_posic.num_unid_dema_real%TYPE,
    unid_aten_cata              ped_solic_posic.num_unid_dema_real%TYPE,
    unid_aten_tota              ped_solic_posic.num_unid_dema_real%TYPE,
    prec_cata                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    prec_tota                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    tota_cata                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    tota_tota                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    opor_cata                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    opor_tota                   ped_solic_posic.val_prec_sin_impu_tota_loca%TYPE,
    val_obse                    VARCHAR2(500)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;


-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
--l_oidCanal                  NUMBER;
--l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;


l_totalFactura              NUMBER(12, 2) := 0;
l_totalAhorro               NUMBER(12, 2) := 0;

l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
cupon                       NUMBER(12, 2) := 0;
saldo_cupon                 NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;


l_catalogo_anterior         VARCHAR2(100);

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'999,999,999');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro

l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := '';
l_fechaCV VARCHAR2(100) := '';
l_fechaDespacho VARCHAR2(100) := '';
l_fechaDespacho2 VARCHAR2(100) := '';


l_cantidadOC      NUMBER:=0;

lv_indiejec VARCHAR2(10):=nvl(sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_GASTO_ADMIN'),'N');

lv_reemplazoOCS VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorReemplazoOCS');

lv_actividadConf VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadConf'),'CV');

lv_actividadVenc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadVenc'),'CP');

lv_actividadDesp VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadDesp'),'FA');

lv_imprimepaqdoc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimepaqdoc'),'N');


l_desRecupSemana VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecupSemana');
l_desPremioAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioAgotado');
l_desAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAgotado');
l_desFaltLiq VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltLiq');
l_desFaltAnun VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltAnun');
l_desAnulMotMax VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAnulMotMax');
l_desPremio VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremio');
l_desAtRec VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAtRec');
l_desRecup VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecup');
l_desReemp VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desReemp');
l_desGratis VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desGratis');
l_desPremioLET VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioLET');
l_desOfertNavid VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desOfertNavid');

ln_oidestra NUMBER(10):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_ESTRA_NAVID');

--ln_diasdesp NUMBER(10):= 0;
ln_diasdesp2 NUMBER(10):= 0;
ln_diasdesp3 NUMBER(10):= 0;


--l_fechaDespacho VARCHAR2(100) := '';
l_fechaDespacho_2 VARCHAR2(100) := '';
l_fechaDespacho_3 VARCHAR2(100) := '';

--l_fechaDespacho2 VARCHAR2(100) :=  nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indFechaDesp2'),'N');

--l_fechaSigFact VARCHAR2(100) := '';
l_fechaSigFact2 VARCHAR2(100) := '';
l_fechaSigFact3 VARCHAR2(100) := '';

orig_ante VARCHAR2(100):='';


BEGIN



    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, 2003, 2001);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;



    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';
    --delete from IMP_PAQUE_DOCUM_DETAL_FACTU;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion, p_oidZona);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                --Se inicializa la variabla CLOB en Memoria
                DBMS_LOB.CREATETEMPORARY(l_clob, TRUE);

                -- Insertamos el registro y obtenemos la referencia al CLOB
                /*INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;*/


               BEGIN

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaVencimiento
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = lv_actividadVenc;

               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');
               END;

               BEGIN

                --<DEMORA> ESTA FUNCION fac_pkg_proc.ped_fn_obt_dias_fecha_ent demora bastante EN PROD
                SELECT to_char(cc.fec_inic,'dd/mm/yyyy'), to_char(cc.FEC_INIC+fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,1,l_codigoPeriodoSiguiente, cc.FEC_INIC),'dd/mm/yyyy')
                INTO l_fechaDespacho2, l_fechaDespacho
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = lv_actividadDesp;

		              l_fechaSigFact2:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,2),'dd/mm/yyyy');

                  l_fechaSigFact3:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,3),'dd/mm/yyyy');

                  ln_diasdesp2:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,2,l_codigoPeriodoSiguiente, to_date(l_fechaDespacho2,'dd/mm/yyyy'));
                  ln_diasdesp3:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,3,l_codigoPeriodoSiguiente, to_date(l_fechaDespacho2,'dd/mm/yyyy'));




                  --if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_2:=to_char(to_date(l_fechaSigFact2,'dd/mm/yyyy')+ln_diasdesp2,'dd/mm/yyyy');
                  --end if;

                  --if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_3:=to_char(to_date(l_fechaSigFact3,'dd/mm/yyyy')+ln_diasdesp3,'dd/mm/yyyy');
                  --end if;


               update ped_segui_pedid a
               set a.fec_sigu_entr=to_date(l_fechaDespacho,'dd/mm/yyyy'),
               a.fec_sigu_fact=to_date(l_fechaDespacho2 ,'dd/mm/yyyy')
               where a.soca_oid_soli_cabe=r_consolidado(i).oid_soli_cabe;

               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaDespacho:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaDespacho2:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaSigFact2:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaSigFact3:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaDespacho_2:=to_char(sysdate,'dd/mm/yyyy');
                 l_fechaDespacho_3:=to_char(sysdate,'dd/mm/yyyy');
               END;


               BEGIN

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaCV
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = lv_actividadConf;


               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaCV:=to_char(sysdate,'dd/mm/yyyy');
               END;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac4>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_textoActual || IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA( r_consolidado(i).cod_clie) ||
                IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA( r_consolidado(i).cod_clie);

                -- Inicio Cabecera
                l_textoActual := l_textoActual || '<blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || substr(r_consolidado(i).cod_zona,1,2);
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona;
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc;
                --l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                --l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';


                -- Documento de Identidad
                l_textoActual := l_textoActual || '<tel_con>' || r_consolidado(i).tel_clie || '</tel_con>';

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fecha Entrega
                l_textoActual := l_textoActual || '<fecha_entrega>' || trim(l_fechaDespacho) || '</fecha_entrega>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fecha pago
                l_textoActual := l_textoActual || '<fecha_pago>' || trim(l_fechaVencimiento) || '</fecha_pago>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fecha Conf
                l_textoActual := l_textoActual || '<fecha_conf>' || trim(l_fechaCV) || '</fecha_conf>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                  l_textoActual := l_textoActual || '<fechaReparto>' || l_fechaDespacho || '</fechaReparto>';
                  l_textoActual := l_textoActual || '<fechaReparto2>' || l_fechaDespacho_2 || '</fechaReparto2>';
                  l_textoActual := l_textoActual || '<fechaReparto3>' || l_fechaDespacho_3 || '</fechaReparto3>';
                  l_textoActual := l_textoActual || '<fechaSigFact>' || l_fechaDespacho2 || '</fechaSigFact>';
                  l_textoActual := l_textoActual || '<fechaSigFact2>' || l_fechaSigFact2 || '</fechaSigFact2>';
                  l_textoActual := l_textoActual || '<fechaSigFact3>' || l_fechaSigFact3 || '</fechaSigFact3>';
                  l_textoActual := l_textoActual || '<diasDesp>' || fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,1,l_codigoPeriodoSiguiente, to_date(l_fechaDespacho2,'dd/mm/yyyy')) || '</diasDesp>';

                -- Nombre Gerente
                l_textoActual := l_textoActual || '<nom_geren>' || r_consolidado(i).gerente || '</nom_geren>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Celular Gerente
                l_textoActual := l_textoActual || '<cel_geren>' || r_consolidado(i).cel_gerente || '</cel_geren>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Nombre Ejecutiva
                l_textoActual := l_textoActual || '<nom_ejec>' || r_consolidado(i).ejecutiva || '</nom_ejec>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Celular Ejecutiva
                l_textoActual := l_textoActual || '<cel_ejec>' || r_consolidado(i).cel_ejecutiva || '</cel_ejec>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Numero de Factura
                l_textoActual := l_textoActual || '<num_fac>' || r_consolidado(i).numero_factura || '</num_fac>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                if lv_imprimepaqdoc='S' then
                  -- Ind. Impresion
                  l_textoActual := l_textoActual || '<imprimepaqdoc>' || r_consolidado(i).ind_impr_pdoc || '</imprimepaqdoc>';

                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;


                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := l_textoActual || '<cuerpo>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);



                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe
                      ,l_desPremioAgotado
                      ,l_desAgotado
                      ,l_desFaltLiq
                      ,l_desFaltAnun
                      ,l_desAnulMotMax
                      ,l_desPremio
                      ,l_desAtRec
                      ,l_desRecup
                      ,l_desReemp
                      ,l_desGratis
                      ,l_desPremioLET
                      ,l_desOfertNavid
                      ,ln_oidestra
                    );
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT 1000;


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP

                                if nvl(l_catalogo_anterior,'X')<>r_detalle(j).des_cata and j<>r_detalle.FIRST then
                                -- Cerramos el cursor de detalles
                                   l_textoActual := '</catalogo>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                end if;

                                if nvl(l_catalogo_anterior,'X')<>r_detalle(j).des_cata then
                                       l_textoActual := '<catalogo>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<nombre>' || substr(r_detalle(j).des_cata,3) || '</nombre>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<total_solic>' || r_detalle(j).UNID_SOLI_CATA || '</total_solic>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<total_aten>' || r_detalle(j).UNID_ATEN_CATA || '</total_aten>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<total_total_cata>' || r_detalle(j).PREC_CATA || '</total_total_cata>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<total_valor_pagar>' || r_detalle(j).TOTA_CATA || '</total_valor_pagar>';
                                       --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       l_textoActual := l_textoActual || '<total_oport_ahorro>' || r_detalle(j).OPOR_CATA || '</total_oport_ahorro>';
                                       DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                end if;


                               if (orig_ante is null and r_detalle(j).val_codi_orig is not null) or (orig_ante is not null and orig_ante<>r_detalle(j).val_codi_orig and r_detalle(j).val_codi_orig is not null) then
 
                                 l_textoActual := '<detalle>';
                                 --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '<tiporeg>H</tiporeg>';
                     
                                -- Codigo de Venta
                                l_textoActual := l_textoActual || '<CUV>' || r_detalle(j).val_codi_orig || '</CUV>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Descripcion
                                l_textoActual := l_textoActual || '<Descripcion>' || r_detalle(j).des_prod || '</Descripcion>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || '<solicitado>' || r_detalle(j).num_unid_orig || '</solicitado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || '<atendido></atendido>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Precio unitario
                                l_textoActual := l_textoActual || '<unit_cata></unit_cata>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Precio total
                                l_textoActual := l_textoActual || '<tota_cata></tota_cata>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- % Descuento
                                l_textoActual := l_textoActual || '<porc_desc></porc_desc>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || '<valor_pagar></valor_pagar>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || '<oport_ahorro></oport_ahorro>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Observaciones
                                l_textoActual := l_textoActual || '<val_obse></val_obse>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 l_textoActual := l_textoActual || '</detalle>';
                                 DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                
                                end if;
                                
                                

                                 l_textoActual := '<detalle>';
                                 --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if r_detalle(j).val_codi_orig is not null then
                                   l_textoActual := l_textoActual || '<tiporeg>D</tiporeg>';
                                end if;


                                -- Codigo de Venta
                                l_textoActual := l_textoActual || '<CUV>' || r_detalle(j).val_codi_vent || '</CUV>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Descripcion
                                l_textoActual := l_textoActual || '<Descripcion>' || r_detalle(j).des_prod || '</Descripcion>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || '<solicitado>' || r_detalle(j).num_unid_dema_real || '</solicitado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || '<atendido>' || r_detalle(j).num_unid_aten || '</atendido>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Precio unitario
                                l_textoActual := l_textoActual || '<unit_cata>' || trim(to_char(r_detalle(j).val_prec_cata_unit_loca , l_formatoNumerico)) || '</unit_cata>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Precio total
                                l_textoActual := l_textoActual || '<tota_cata>' || trim(to_char(r_detalle(j).val_prec_cata_tota_loca, l_formatoNumerico)) || '</tota_cata>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- % Descuento
                                l_textoActual := l_textoActual || '<porc_desc>' || r_detalle(j).val_porc_desc || '</porc_desc>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || '<valor_pagar>' || trim(to_char(r_detalle(j).val_prec_fact_tota_loca, l_formatoNumerico)) || '</valor_pagar>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || '<oport_ahorro>' || trim(to_char(nvl(r_detalle(j).imp_prec_publ,0), l_formatoNumerico)) || '</oport_ahorro>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                -- Observaciones
                                l_textoActual := l_textoActual || '<val_obse>' || r_detalle(j).val_obse || '</val_obse>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 l_textoActual := l_textoActual || '</detalle>';
                                 DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                 l_catalogo_anterior:=r_detalle(j).des_cata;
                                 l_totalFactura:=r_detalle(j).prec_tota;
                                 l_totalAhorro:=r_detalle(j).opor_tota;

                                 orig_ante:=r_detalle(j).val_codi_orig;

                            END LOOP;
                        END IF;



                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;

                    l_textoActual := '</catalogo>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_textoActual := l_textoActual || '</cuerpo>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Pie
                l_textoActual := l_textoActual || '<pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);




                --l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion+nvl(r_consolidado(i).val_impo_rete_desc,0);


                -- Obtenemos los Pagos Posteriores
                /*SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;*/


                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;
                else
                    l_cargoFamSegura:=0;

                END IF;


                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                --<DEMORA> ESTA FUNCION CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER demora bastante EN PROD
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);

                BEGIN
                  SELECT SUM(ccc_detal_cupon_trami_depur.imp_deta)
                    INTO cupon
                    FROM mae_clien,
                         ccc_detal_cupon_trami_depur,
                         ccc_situa_cupon
                   WHERE ((ccc_situa_cupon.oid_situ_cupo = ccc_detal_cupon_trami_depur.sicu_oid_situ_cupo) AND
                         (ccc_situa_cupon.cod_situ_cupo = 'T') AND
                         (mae_clien.oid_clie = ccc_detal_cupon_trami_depur.clie_oid_clie) AND
                         (mae_clien.oid_clie = r_consolidado(i).oid_clie));
                  IF cupon IS NULL THEN
                    cupon := 0;
                  END IF;
                EXCEPTION
                  WHEN no_data_found THEN
                    cupon := 0;
                END;

                l_totalAPagar:=l_totalAPagar-cupon;

                saldo_cupon:=l_totalAPagar;

                saldo_cupon:=trunc(saldo_cupon/100)*100;


                if saldo_cupon<0 then
                   saldo_cupon:=0;
                end if;

               update ped_segui_pedid a
               set a.val_mont_cupo=saldo_cupon
               where a.soca_oid_soli_cabe=r_consolidado(i).oid_soli_cabe;

                /*IF lv_indiejec='S' THEN
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura+nvl(r_consolidado(i).gastos,0);
                END IF;*/

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;

                l_saldoAnterior := l_totalAPagar - (l_totalFactura-l_totalAhorro+r_consolidado(i).val_impo_flet_tota_loca+l_cargoFamSegura+nvl(r_consolidado(i).gastos,0));



                    -- Total Catalogo
                    l_textoActual := l_textoActual || '<subtotal>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</subtotal>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := l_textoActual || '<descuentos>' || trim(to_char(l_totalAhorro, l_formatoNumerico)) || '</descuentos>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := l_textoActual || '<subtotalfac>' || trim(to_char(l_totalFactura-l_totalAhorro, l_formatoNumerico)) || '</subtotalfac>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := l_textoActual || '<fletes>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</fletes>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := l_textoActual || '<familia>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</familia>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto
                    l_textoActual := l_textoActual || '<iva>' || trim(to_char(r_consolidado(i).val_impo_impu_tota_loca, l_formatoNumerico)) || '</iva>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total a pagar
                    l_textoActual := l_textoActual || '<total_pagar>' || trim(to_char(l_totalFactura-l_totalAhorro+r_consolidado(i).val_impo_flet_tota_loca+l_cargoFamSegura+nvl(r_consolidado(i).gastos,0), l_formatoNumerico)) || '</total_pagar>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Ahorro
                    l_textoActual := l_textoActual || '<total_oport_ahorro>' || trim(to_char(l_totalAhorro, l_formatoNumerico)) || '</total_oport_ahorro>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo Anterior
                    l_textoActual := l_textoActual || '<saldo_anterior>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</saldo_anterior>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := l_textoActual || '<pagos_posteriores>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</pagos_posteriores>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo Cupon
                    l_textoActual := l_textoActual || '<saldo_cupon>' || trim(to_char(saldo_cupon, l_formatoNumerico)) || '</saldo_cupon>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                    -- Intereses de Mora
                    l_textoActual := l_textoActual || '<inter_mora>' || trim(to_char(nvl(r_consolidado(i).gastos,0), l_formatoNumerico)) || '</inter_mora>';
                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Pie
                l_textoActual := l_textoActual || '</pie>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                --DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := l_textoActual || '</detfac4>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                                 l_catalogo_anterior:=null;
                                 l_totalFactura:=null;
                                 l_totalAhorro:=null;

                --Se inserta el CLOB en memoria a BD
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                l_CLOB);

                --Se libera la variabla CLOB de Memoria
                DBMS_LOB.FREETEMPORARY(l_CLOB);

                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;
 COMMIT;
END;
/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de consolidado modificado por Performance.
Fecha Creacion      : 25/01/2011
Fecha Modificacion  : 25/01/2011
Autor               : Jorge Yepez Reyez - jyepez@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU_PERF(oidSolicitud NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2) IS

CURSOR c_consolidados IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       BP.DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.OID_SOLI_CABE = oidSolicitud
  AND CON.NUM_UNID_ATEN_TOTA > 0
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER,
                 indicadorGrupo NUMBER) IS
SELECT OID_SOLI_CABE,
       COPA_OID_PARA_GENE,
       ICTP_OID_TIPO_PROG,
       OID_SOLI_POSI,
       VAL_CODI_VENT,
       DES_PROD,
       NUM_UNID_DEMA_REAL,
       NUM_UNID_ATEN,
       VAL_PREC_CATA_UNIT_LOCA,
       VAL_PREC_CATA_TOTA_LOCA,
       VAL_PREC_CONT_UNIT_LOCA,
       VAL_PREC_CONT_TOTA_LOCA,
       VAL_PREC_FACT_TOTA_LOCA,
       VAL_IMPO_DESC_TOTA_LOCA,
       VAL_PORC_DESC,
       VAL_IMPO_IMPU_TOTA_LOCA,
       FOPA_OID_FORM_PAGO,
       VAL_OBSE
FROM (
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       NVL(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       (SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       PSP.FOPA_OID_FORM_PAGO,
       CASE
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 2 --  MAV
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 2 -- PREMIOS (los agrupamos con los MAV)
           WHEN PSP.VAL_PORC_DESC IS NULL OR (PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC = 0)
               THEN 1 -- PRODUCTOS SIN DESCUENTO'
           WHEN PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC > 0
               THEN 0 -- PRODUCTOS CON DESCUENTO'
       END AS IND_GRUP,
       CASE
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Prem.Agot.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN 'Agotado'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN 'Falt.Liq.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN 'Falt.Anunc.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN 'Anul.Mto Max'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Premio'
           WHEN PCS.COD_CLAS_SOLI = 'R1'
               THEN 'At.Rec'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN 'Recuperacion'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
           AND NOT EXISTS (SELECT * FROM PRE_PROD_ALTER_ICE, MAE_PRODU A, MAE_PRODU B WHERE COD_SAP_PPAL=A.COD_SAP and COD_SAP_ALTE=B.COD_SAP AND (PSP.PROD_OID_PROD=A.OID_PROD OR PSP.PROD_OID_PROD=B.OID_PROD))
               THEN 'Reemplazo'
           WHEN EXISTS (
                 SELECT NULL
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 )
               THEN 'Reemplazo'
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 'Gratis'
           WHEN TS.Cod_Tipo_Soli='IPLC'
               THEN 'Prem.LET'
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_CLASE_SOLIC PCS
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
)
WHERE IND_GRUP = indicadorGrupo
ORDER BY VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPagoPosterior     NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(1000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);

l_modu_oid_modu    NUMBER(12);
--nuevo parametro
l_indicadorGenerarDetalleFactP VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFacturaP');
l_indicadorGenerarDetalleFac2P VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2P');

l_cargoFamSegura            NUMBER(12, 2) := 0;
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');

l_incfechaVencimiento   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'incluyeFechaVenc'),'N');

l_oidPeriodoSgte                NUMBER;
l_codPeriodoSgte                VARCHAR2(6);
l_oidActividad                  NUMBER;
l_fechaVencimiento              VARCHAR2(10);
l_codigoPeriodo                 VARCHAR2(25);
l_codigoActividadVencimiento    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'codigoActividadVencimiento');


BEGIN
    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorGenerarDetalleFactP IS NULL OR l_indicadorGenerarDetalleFactP <> 'S')THEN
         IF(l_indicadorGenerarDetalleFac2P IS NULL OR l_indicadorGenerarDetalleFac2P <> 'S')THEN
              RETURN;
         ELSE
              IMP_PR_PROCE_DETAL_FACTU2_PERF(oidSolicitud,p_codigoPais,
                                   p_codigoPeriodo);
              RETURN;
         END IF;
    END IF;

    select  modu_oid_modu into l_modu_oid_modu from ped_solic_cabec where oid_soli_cabe=oidSolicitud;

    if l_modu_oid_modu=15 then
              RETURN;
    end if;

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    -- Obtenemos el valor del ultimo numero de lote de facturacion
    /*IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;*/

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';

    -- Abrimos el cursor principal
    OPEN c_consolidados;
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := '<blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := '<campana>' || p_codigoPeriodo || '</campana>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPagoPosterior := 0;

                -- Iteramos por las secciones del detalle
                FOR k IN 0..2
                LOOP

                    -- Iniciamos los subtotales
                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPagoPosterior := 0;

                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe, k);
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;

                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP

                                -- Mostramos el titulo
                                IF j = 1 THEN
                                    IF k = 0 THEN
                                        l_textoActual := '<txt><u>PRODUCTOS CON DESCUENTO</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSIF k = 1 THEN
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS DE REVISTA Y/U OFERTAS ESPECIALES PARA CONSULTORAS</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSE
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS Y/O APOYO DE VTA/PROMOCIONES</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;
                                END IF;

                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;

                                        -- Pago posterior (fraccionado)
                                        l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                l_textoActual := '<txt>';

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Pago Posterior
                                l_textoActual := l_textoActual || trim(to_char(l_pagoPosterior, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<t/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPagoPosterior := l_subtotalPagoPosterior + l_pagoPosterior;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPagoPosterior := l_totalPagoPosterior + l_pagoPosterior;

                            END LOOP;
                        END IF;
                        EXIT WHEN c_detalle%NOTFOUND;
                    END LOOP;

                    -- Cerramos el cursor de detalles
                    CLOSE c_detalle;

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPagoPosterior, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<t/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    END IF;

                END LOOP;

                -- Totales

                -- Al descuento le agregamos el redondeo
                l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPagoPosterior, l_formatoNumerico));
                l_textoActual := l_textoActual || '<t/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := '<pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                /*
                -- Obtenemos los valores faltantes

                -- Saldo a favor
                l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);

                -- Saldo anterior
                l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');

                -- Restamos al saldo anterior el saldo a favor
                l_saldoAnterior := l_saldoAnterior - l_saldoFavor;
                */

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion;
                --l_totalAPagar := l_totalFactura + l_saldoAnterior - l_totalPagoPosterior;

                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                IF l_indicadorImpuestosGratis = 'S' THEN
                    l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;
                END IF;

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;

                IF l_indicadorCargoFamSegura='S' THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                    ccc_movim_cuent_corri mcc,
                    ccc_proce cp,
                    ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;

                END IF;

                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);
                l_saldoAnterior := l_totalAPagar - l_totalFactura - l_cargoFamSegura + l_totalPagoPosterior;


                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea7>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := '<linea8>' || trim(to_char(0, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                ELSE
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                    if l_incfechaVencimiento='S' then


                        -- Obtenemos el OID del periodo siguiente
                        l_codPeriodoSgte := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);
                        l_oidPeriodoSgte := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(l_codPeriodoSgte, l_oidMarca, l_oidCanal);

                        -- Obtenemos el OID de la actividad
                        SELECT ACT.OID_ACTI
                        INTO l_oidActividad
                        FROM CRA_ACTIV ACT
                        WHERE ACT.PAIS_OID_PAIS = l_oidPais
                        AND ACT.MARC_OID_MARC = l_oidMarca
                        AND ACT.CANA_OID_CANA = l_oidCanal
                        AND ACT.COD_ACTI = l_codigoActividadVencimiento; -- Cupon de Vencimiento


                        -- Obtenemos la fecha de vencimiento de la zona del cliente
                        BEGIN
                            SELECT TO_CHAR(CRO.FEC_INIC,'DD/MM/YYYY')
                            INTO l_fechaVencimiento
                            FROM CRA_CRONO CRO
                            WHERE CRO.ZZON_OID_ZONA = (select max(oid_zona) from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                            AND CRO.PERD_OID_PERI = l_oidPeriodoSgte
                            AND CRO.CACT_OID_ACTI = l_oidActividad;
                        EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            l_fechaVencimiento := TO_CHAR(TRUNC(SYSDATE),'DD/MM/YYYY');
                        END;
                        -- Fecha Vencimiento
                        l_textoActual := '<linea11>' || trim(l_fechaVencimiento) || '</linea11>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);
                    end if;


                END IF;

                -- Fin Pie
                l_textoActual := '</pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := '</detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;
                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;

END;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de consolidado modificado por Performance.
Fecha Creacion      : 25/01/2011
Fecha Modificacion  : 25/01/2011
Autor               : Jorge Yepez Reyez - jyepez@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_FACTU_ZONA(oidZona NUMBER,p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2, p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       BP.DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.PERD_OID_PERI = oidPeriodo
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.zzon_oid_zona = oidZona
  AND CON.NUM_UNID_ATEN_TOTA > 0
    AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  )
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER,
                 indicadorGrupo NUMBER) IS
SELECT OID_SOLI_CABE,
       COPA_OID_PARA_GENE,
       ICTP_OID_TIPO_PROG,
       OID_SOLI_POSI,
       VAL_CODI_VENT,
       DES_PROD,
       NUM_UNID_DEMA_REAL,
       NUM_UNID_ATEN,
       VAL_PREC_CATA_UNIT_LOCA,
       VAL_PREC_CATA_TOTA_LOCA,
       VAL_PREC_CONT_UNIT_LOCA,
       VAL_PREC_CONT_TOTA_LOCA,
       VAL_PREC_FACT_TOTA_LOCA,
       VAL_IMPO_DESC_TOTA_LOCA,
       VAL_PORC_DESC,
       VAL_IMPO_IMPU_TOTA_LOCA,
       FOPA_OID_FORM_PAGO,
       VAL_OBSE
FROM (
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       NVL(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       (SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       PSP.FOPA_OID_FORM_PAGO,
       CASE
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 2 --  MAV
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 2 -- PREMIOS (los agrupamos con los MAV)
           WHEN PSP.VAL_PORC_DESC IS NULL OR (PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC = 0)
               THEN 1 -- PRODUCTOS SIN DESCUENTO'
           WHEN PSP.VAL_PORC_DESC IS NOT NULL AND PSP.VAL_PORC_DESC > 0
               THEN 0 -- PRODUCTOS CON DESCUENTO'
       END AS IND_GRUP,
       CASE
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Prem.Agot.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN 'Agotado'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN 'Falt.Liq.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN 'Falt.Anunc.'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN 'Anul.Mto Max'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN 'Premio'
           WHEN PCS.COD_CLAS_SOLI = 'R1'
               THEN 'At.Rec'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN 'Recuperacion'
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
           AND NOT EXISTS (SELECT * FROM PRE_PROD_ALTER_ICE, MAE_PRODU A, MAE_PRODU B WHERE COD_SAP_PPAL=A.COD_SAP and COD_SAP_ALTE=B.COD_SAP AND (PSP.PROD_OID_PROD=A.OID_PROD OR PSP.PROD_OID_PROD=B.OID_PROD))
               THEN 'Reemplazo'
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN 'Reemp.'  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN 'Gratis'
           WHEN TS.Cod_Tipo_Soli='IPLC'
               THEN 'Prem.LET'
           ELSE ''
        END AS VAL_OBSE
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_CLASE_SOLIC PCS,
     PED_SUBTI_POSIC PST--,
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
)
WHERE IND_GRUP = indicadorGrupo
ORDER BY VAL_CODI_VENT;


TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    val_obse                    VARCHAR2(1000)
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPagoPosterior     NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
l_clob                      CLOB;
l_textoActual               VARCHAR2(1000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);

l_modu_oid_modu    NUMBER(12);
--nuevo parametro
l_indicadorGenerarDetalleFact VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura');

l_cargoFamSegura            NUMBER(12, 2) := 0;
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');

l_incfechaVencimiento   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'incluyeFechaVenc'),'N');

l_oidPeriodoSgte                NUMBER;
l_codPeriodoSgte                VARCHAR2(6);
l_oidActividad                  NUMBER;
l_fechaVencimiento              VARCHAR2(10);
l_codigoPeriodo                 VARCHAR2(25);
l_codigoActividadVencimiento    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'codigoActividadVencimiento');

l_cantidadOC      NUMBER:=0;

BEGIN

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    -- Obtenemos el valor del ultimo numero de lote de facturacion
    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = l_oidPeriodo
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
           AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := null;
        END;
    END IF;

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_DETAL_FACTU';

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_DETAL_FACTU (
                COR_PADO_DEFA,
                COD_CONS,
                VAL_NUME_SOLI,
                XML_DETA_FACT)
                VALUES(
                r_consolidado(i).oid_soli_cabe,
                r_consolidado(i).cod_clie,
                r_consolidado(i).val_nume_soli,
                EMPTY_CLOB())
                RETURNING XML_DETA_FACT INTO l_clob;

                -- Inicio Detalle de Factura
                l_textoActual := '<detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Inicio Cabecera
                l_textoActual := '<blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Numero Pedido
                l_textoActual := '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := '<campana>' || p_codigoPeriodo || '</campana>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Cabecera
                l_textoActual := '</blqcab>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPagoPosterior := 0;

                -- Iteramos por las secciones del detalle
                FOR k IN 0..2
                LOOP

                    -- Iniciamos los subtotales
                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPagoPosterior := 0;

                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe, k);
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;

                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP

                                -- Mostramos el titulo
                                IF j = 1 THEN
                                    IF k = 0 THEN
                                        l_textoActual := '<txt><u>PRODUCTOS CON DESCUENTO</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSIF k = 1 THEN
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS DE REVISTA Y/U OFERTAS ESPECIALES PARA CONSULTORAS</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    ELSE
                                        l_textoActual := '<txt/>';
                                        l_textoActual := l_textoActual || '<txt><u>PRODUCTOS Y/O APOYO DE VTA/PROMOCIONES</u></txt><txt><t/></txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;
                                END IF;

                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;

                                        -- Pago posterior (fraccionado)
                                        l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                l_textoActual := '<txt>';

                                -- Codigo de Venta
                                l_textoActual := l_textoActual || r_detalle(j).val_codi_vent;
                                l_textoActual := l_textoActual || '<t/>';

                                -- Descripcion
                                l_textoActual := l_textoActual || r_detalle(j).des_prod;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades demandadas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_dema_real;
                                l_textoActual := l_textoActual || '<tc/>';

                                -- Unidades atendidas
                                l_textoActual := l_textoActual || r_detalle(j).num_unid_aten;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<tr/>';

                                -- Pago Posterior
                                l_textoActual := l_textoActual || trim(to_char(l_pagoPosterior, l_formatoNumerico));
                                l_textoActual := l_textoActual || '<t/>';

                                -- Observaciones
                                l_textoActual := l_textoActual || r_detalle(j).val_obse;
                                l_textoActual := l_textoActual || '</txt>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPagoPosterior := l_subtotalPagoPosterior + l_pagoPosterior;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPagoPosterior := l_totalPagoPosterior + l_pagoPosterior;

                            END LOOP;
                        END IF;
                        EXIT WHEN c_detalle%NOTFOUND;
                    END LOOP;

                    -- Cerramos el cursor de detalles
                    CLOSE c_detalle;

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPagoPosterior, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<t/>';
                        l_textoActual := l_textoActual || '</txt>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    END IF;

                END LOOP;

                -- Totales

                -- Al descuento le agregamos el redondeo
                l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;

                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPagoPosterior, l_formatoNumerico));
                l_textoActual := l_textoActual || '<t/>';
                l_textoActual := l_textoActual || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                -- Inicio Pie
                l_textoActual := '<pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                /*
                -- Obtenemos los valores faltantes

                -- Saldo a favor
                l_saldoFavor := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_FAVOR(r_consolidado(i).oid_soli_cabe);

                -- Saldo anterior
                l_saldoAnterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_TOTAL_PAGO_POSTE(r_consolidado(i).oid_soli_cabe, l_codigoPeriodoSiguiente, 'A');

                -- Restamos al saldo anterior el saldo a favor
                l_saldoAnterior := l_saldoAnterior - l_saldoFavor;
                */

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca + l_percepcion;
                --l_totalAPagar := l_totalFactura + l_saldoAnterior - l_totalPagoPosterior;

                -- En caso el pais este configurado para cobrar el impuesto por las promociones
                IF l_indicadorImpuestosGratis = 'S' THEN
                    l_totalAPagar := l_totalAPagar + l_totalImpuestosGratis;
                END IF;

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri
                WHERE clie_oid_clie = r_consolidado(i).oid_clie
                  AND imp_pend > 0
                  AND perd_oid_peri > l_oidPeriodo ;

                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                   SELECT NVL(SUM(mcc.imp_movi),0)
                   INTO l_cargoFamSegura
                        FROM ccc_movim_cuent_corri mcc,
                             ccc_proce cp,
                             ccc_subpr su
                        WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                        AND mcc.perd_oid_peri = l_oidPeriodo
                        AND mcc.subp_oid_subp_crea = su.Oid_Subp
                        AND su.ccpr_Oid_Proc = cp.oid_proc
                        AND cp.cod_proc = 'CCC007'
                        AND su.cod_subp = 7;

                END IF;

                /********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior = Total Monto a Pagar
                **********************************************************************/
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);
                l_saldoAnterior := l_totalAPagar - l_totalFactura - l_cargoFamSegura + l_totalPagoPosterior;


                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Percepciones
                    l_textoActual := '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea7>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios
                    l_textoActual := '<linea8>' || trim(to_char(0, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                ELSE
                    -- Total Catalogo
                    l_textoActual := '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Descuentos (Incluimos el redondeo)
                    l_textoActual := '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Facturado
                    l_textoActual := '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Flete
                    l_textoActual := '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Total Factura
                    l_textoActual := '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Pagos Posteriores
                    l_textoActual := '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Abono Atencion de Servicios (No se visualiza)
                    l_textoActual := '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    l_textoActual := '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Saldo anterior
                    l_textoActual := '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                    -- Importe Total
                    l_textoActual := '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);


                    if l_incfechaVencimiento='S' then


                        -- Obtenemos el OID del periodo siguiente
                        l_codPeriodoSgte := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);
                        l_oidPeriodoSgte := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(l_codPeriodoSgte, l_oidMarca, l_oidCanal);

                        -- Obtenemos el OID de la actividad
                        SELECT ACT.OID_ACTI
                        INTO l_oidActividad
                        FROM CRA_ACTIV ACT
                        WHERE ACT.PAIS_OID_PAIS = l_oidPais
                        AND ACT.MARC_OID_MARC = l_oidMarca
                        AND ACT.CANA_OID_CANA = l_oidCanal
                        AND ACT.COD_ACTI = l_codigoActividadVencimiento; -- Cupon de Vencimiento


                        -- Obtenemos la fecha de vencimiento de la zona del cliente
                        BEGIN
                            SELECT TO_CHAR(CRO.FEC_INIC,'DD/MM/YYYY')
                            INTO l_fechaVencimiento
                            FROM CRA_CRONO CRO
                            WHERE CRO.ZZON_OID_ZONA = (select max(oid_zona) from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                            AND CRO.PERD_OID_PERI = l_oidPeriodoSgte
                            AND CRO.CACT_OID_ACTI = l_oidActividad;
                        EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            l_fechaVencimiento := TO_CHAR(TRUNC(SYSDATE),'DD/MM/YYYY');
                        END;
                        -- Fecha Vencimiento
                        l_textoActual := '<linea11>' || trim(l_fechaVencimiento) || '</linea11>';
                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                        DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);
                    end if;


                END IF;

                -- Fin Pie
                l_textoActual := '</pie>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                DBMS_LOB.writeappend(l_CLOB, LENGTH(l_cambioLineaRetornoCarro), l_cambioLineaRetornoCarro);

                -- Fin Detalle de Factura
                l_textoActual := '</detfac>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                l_correlativo := l_correlativo + 1;
                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;

END;

/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el detalle de factura laser.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_DETAL_FACTU IS

-- Variables a utilizar
l_clob              CLOB;
l_correlativo       NUMBER;

CURSOR c_paquetes IS
SELECT COR_PADO_DEFA,
       XML_DETA_FACT
FROM IMP_PAQUE_DOCUM_DETAL_FACTU;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
        OPEN c_caracteres;
        LOOP
        FETCH c_caracteres INTO r_caracteres;
        EXIT WHEN c_caracteres%NOTFOUND;

            l_startPos := 1;
            l_longitud := LENGTH(r_caracteres.VAL_REEM);
            l_pos := INSTR(r_paquetes.XML_DETA_FACT, r_caracteres.VAL_CARA, l_startPos);
            WHILE(l_pos != 0) LOOP

                SELECT XML_DETA_FACT
                INTO l_clob
                FROM IMP_PAQUE_DOCUM_DETAL_FACTU
                WHERE COR_PADO_DEFA = r_paquetes.COR_PADO_DEFA
                FOR UPDATE;

                -- Reemplazamos el texto en el clob
                IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                l_startPos := l_pos + l_longitud;
                l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
            END LOOP;
        END LOOP;
        CLOSE c_caracteres;
        COMMIT;

    END LOOP;
    CLOSE c_paquetes;

END;


/**************************************************************************
Descripcion         : Genera el archivo laser de detalles de factura.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_DETAL_FACTU(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2) IS

CURSOR c_paquete IS
select '<pd>' || x.xml_deta_fact || '</pd>' xml_paqu_docu
from imp_paque_docum_detal_factu x
order by x.cor_pado_defa;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

BEGIN

    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete;
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_DETAL_FACTU: '||substr(sqlerrm,1,250));

END;


/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_CCC(p_codigoPais IN VARCHAR2,
                                 p_codigoPeriodo IN VARCHAR2,
                                 p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_clientes(oidPeriodo NUMBER) IS
SELECT DISTINCT
       MC.OID_CLIE,
       MC.COD_CLIE
FROM PED_SOLIC_CABEC CON,
     MAE_CLIEN MC,
     PED_TIPO_SOLIC_PAIS PTSP,
     PED_TIPO_SOLIC PTS,
     SEG_PAIS
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND CON.FEC_FACT = TO_DATE (p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.PERD_OID_PERI = oidPeriodo
  AND SEG_PAIS.COD_PAIS = p_codigoPais
  AND PTSP.TSOL_OID_TIPO_SOLI = PTS.OID_TIPO_SOLI
  AND CON.TSPA_OID_TIPO_SOLI_PAIS = PTSP.OID_TIPO_SOLI_PAIS
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND PTS.COD_TIPO_SOLI = 'C1' -- Consolidado O/C Consultora
ORDER BY MC.COD_CLIE;

TYPE clienterecord IS RECORD (
    oid_clie    mae_clien.oid_clie%TYPE,
    cod_clie    mae_clien.cod_clie%TYPE
);

TYPE clientetype IS TABLE OF clienterecord;
r_cliente    clientetype;

CURSOR c_ctacte(oidCliente NUMBER,
                numeroDetalles NUMBER) IS
SELECT *
FROM (
SELECT FEC_EMIS,
       CAM_REFE,
       TIP_MOVI,
       NUM_DOCU,
       FEC_VENC,
       FEC_PAGO,
       IMP_CARG,
       IMP_ABON,
       IMP_MOVI
FROM (
    SELECT FEC_EMIS,
           CAM_REFE,
           TIP_MOVI,
           NUM_DOCU,
           FEC_VENC,
           FEC_PAGO,
           IMP_CARG,
           IMP_ABON,
           DECODE(IMP_CARG, NULL, IMP_ABON, -1 * IMP_CARG) IMP_MOVI
    FROM (
        SELECT MCC.FEC_DOCU FEC_EMIS,
               nvl((
               select z.cod_peri
               from ped_solic_cabec x, cra_perio y, seg_perio_corpo z
               where x.perd_oid_peri=y.oid_peri and y.peri_oid_peri=z.oid_peri
               and x.oid_soli_cabe=mcc.soca_oid_soli_cabe
               ),SPC.COD_PERI) CAM_REFE,
               CASE
                   WHEN MCC.TCAB_OID_TCAB_CREA = 2001 THEN
                   CASE
                       WHEN EXISTS (
                            SELECT OID_SOLI_CABE
                              FROM PED_SOLIC_CABEC P,
                                   PED_TIPO_SOLIC_PAIS TP,
                                   PED_TIPO_SOLIC T
                             WHERE P.SOCA_OID_SOLI_CABE = MCC.SOCA_OID_SOLI_CABE
                               AND P.TSPA_OID_TIPO_SOLI_PAIS = TP.OID_TIPO_SOLI_PAIS
                               AND TP.TSOL_OID_TIPO_SOLI = T.OID_TIPO_SOLI
                               AND P.IND_OC = 1
                               AND T.IND_SOLI_NEGA = 0)
                       THEN 'Pedido'
                       ELSE
                           CASE
                               WHEN MCC.IMP_MOVI > 0 THEN
                                   'Atencion de Servicio'
                               ELSE
                                   NVL((SELECT 'C'
                                             || PERIOCORPO.COD_PERI
                                             || ' '
                                             || OPERA.VAL_DESC_LARG
                                             || ' NRO.'
                                             || CABECRECLA.NUM_RECL AS DESCRIP
                                        FROM PED_SOLIC_CABEC CONS,
                                             PED_SOLIC_CABEC SOLICRECLA,
                                             PED_SOLIC_CABEC SOLICORIGEN,
                                             REC_SOLIC_OPERA SOLICOPERA,
                                             REC_OPERA_RECLA OPERARECLA,
                                             REC_CABEC_RECLA CABECRECLA,
                                             REC_TIPOS_OPERA TIPOSOPERA,
                                             REC_OPERA OPERA,
                                             CRA_PERIO PERIO,
                                             SEG_PERIO_CORPO PERIOCORPO
                                       WHERE CONS.OID_SOLI_CABE = MCC.SOCA_OID_SOLI_CABE
                                         AND CONS.OID_SOLI_CABE = SOLICRECLA.SOCA_OID_SOLI_CABE
                                         AND SOLICRECLA.SOCA_OID_DOCU_REFE IS NOT NULL
                                         AND SOLICRECLA.OID_SOLI_CABE = SOLICOPERA.SOCA_OID_SOLI_CABE
                                         AND SOLICOPERA.OPRE_OID_OPER_RECL = OPERARECLA.OID_OPER_RECL
                                         AND OPERARECLA.CARE_OID_CABE_RECL = CABECRECLA.OID_CABE_RECL
                                         AND OPERARECLA.TIOP_OID_TIPO_OPER = TIPOSOPERA.OID_TIPO_OPER
                                         AND TIPOSOPERA.ROPE_OID_OPER = OPERA.OID_OPER
                                         AND SOLICRECLA.SOCA_OID_DOCU_REFE = SOLICORIGEN.OID_SOLI_CABE
                                         AND SOLICORIGEN.PERD_OID_PERI = PERIO.OID_PERI
                                         AND PERIO.PERI_OID_PERI = PERIOCORPO.OID_PERI
                                         AND ROWNUM = 1)
                                     , 'CDR'
                                   )
                           END
                   END
                   ELSE GEN.VAL_I18N
               END TIP_MOVI,
               MCC.SOCA_OID_SOLI_CABE SOCA_OID_SOLI_CABE,
               MCC.NUM_IDEN_CUOT NUM_DOCU,
               MCC.FEC_VENC FEC_VENC,
               NULL FEC_PAGO,
               CASE
                   WHEN (MCC.IMP_MOVI > 0) THEN MCC.IMP_MOVI
                   ELSE NULL
               END IMP_CARG,
               CASE
                  WHEN (MCC.IMP_MOVI > 0) THEN NULL
                  ELSE ABS(MCC.IMP_MOVI)
               END IMP_ABON
         FROM CCC_MOVIM_CUENT_CORRI MCC,
              CCC_SUBPR CS,
              CCC_TIPO_ABONO_SUBPR TAS,
              CCC_TIPO_CARGO_ABONO TCA,
              GEN_I18N_SICC_PAIS GEN,
              CRA_PERIO CP,
              SEG_PERIO_CORPO SPC
        WHERE MCC.SUBP_OID_SUBP_CREA = CS.OID_SUBP
          AND CS.OID_SUBP = TAS.SUBP_OID_SUBP
          AND TAS.TCAB_OID_TCAB = TCA.OID_TIPO_CARG_ABON
          AND GEN.ATTR_ENTI LIKE 'CCC_TIPO_CARGO_ABONO'
          AND GEN.VAL_OID = TCA.OID_TIPO_CARG_ABON
          AND MCC.PERD_OID_PERI = CP.OID_PERI
          AND CP.PERI_OID_PERI = SPC.OID_PERI
          AND MCC.CLIE_OID_CLIE = oidCliente
        /*AND ROWNUM = 1*/
        UNION ALL
        SELECT MB.FEC_PROC FEC_EMIS,
               NULL OID_PERI,
               CCB.DES_CC TIP_MOVI,
               MB.OID_MOVI_BANC SOCA_OID_SOLI_CABE,
               MB.NUM_LOTE NUM_DOCU,
               NULL FEC_VENC,
               MB.FEC_PAGO FEC_PAGO,
               NULL IMP_CARG,
               MB.IMP_PAGO IMP_ABON
          FROM CCC_MOVIM_BANCA MB,
               CCC_CUENT_CORRI_BANCA CCB
         WHERE MB.CCBA_OID_CC_BANC = CCB.OID_CUEN_CORR_BANC
           AND MB.COD_IDEN_PROC = 'P'
           AND MB.CLIE_OID_CLIE = oidCliente
    )
    WHERE FEC_EMIS <= TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
    ORDER BY 1 DESC
) X
WHERE ROWNUM <= numeroDetalles
)
ORDER BY 1 ASC;

TYPE ctacterecord IS RECORD (
    fec_movi    DATE,
    cam_refe    VARCHAR2(6),
    tip_movi    VARCHAR2(100),
    num_docu    NUMBER,
    fec_venc    DATE,
    fec_pago    DATE,
    imp_carg    NUMBER(12, 2),
    imp_abon    NUMBER(12, 2),
    imp_movi    NUMBER(12, 2)
);

TYPE ctactetype IS TABLE OF ctacterecord;
r_ctacte    ctactetype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;

l_clob                      CLOB;
l_textoActual               VARCHAR2(1000) := '';
--l_formatoNumerico           VARCHAR2(100) := '9999999G990D00';
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_numeroDetallesCtaCte      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesCtaCte');
l_indicadorGenerarCtaCteLaser      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarCtaCteLaser');
l_numeroDetalles            NUMBER := 5;
l_saldoActual               NUMBER(12, 2) := 0;

BEGIN


        IF nvl(l_indicadorGenerarCtaCteLaser,'N')<>'S' then
           RETURN;
        end if;

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);


    IMP_PR_GENER_PAQUE_DOCUM_CUPON(p_codigoPais,
                                         p_codigoPeriodo,
                                         p_fechaFacturacion);



    BEGIN


        IF l_numeroDetallesCtaCte IS NOT NULL THEN
            l_numeroDetalles := TO_NUMBER(l_numeroDetallesCtaCte);
        END IF;
    EXCEPTION WHEN OTHERS THEN
        l_numeroDetalles := 5; -- Valor por defecto
    END;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_CTACT';

    -- Abrimos el cursor principal
    OPEN c_clientes(l_oidPeriodo);
    LOOP
        FETCH c_clientes BULK COLLECT
        INTO r_cliente LIMIT w_filas;

        IF  r_cliente.COUNT > 0 THEN
            FOR i IN r_cliente.FIRST..r_cliente.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_LASER_CTACT (
                COD_CLIE,
                XML_CUEN_CORR)
                VALUES(
                r_cliente(i).cod_clie,
                EMPTY_CLOB())
                RETURNING XML_CUEN_CORR INTO l_clob;

                -- Inicio Detalle de Cuenta Corriente
                l_textoActual := '<detctacte>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Obtenemos el saldo actual
                l_saldoActual := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_INICI(r_cliente(i).oid_clie, l_numeroDetalles, p_fechaFacturacion);

                l_textoActual := '<txt>SALDO ANTERIOR<t/><t/><t/><t/><tr/><tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_saldoActual, l_formatoNumerico)) || '</txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                OPEN c_ctacte(r_cliente(i).oid_clie, l_numeroDetalles);
                LOOP
                    FETCH c_ctacte BULK COLLECT
                    INTO r_ctacte LIMIT w_filas;

                    IF  r_ctacte.COUNT > 0 THEN
                        FOR j IN r_ctacte.FIRST..r_ctacte.LAST
                        LOOP

                            l_textoActual := '<txt>';

                            -- Fecha de emision
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_movi, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<t/>';

                            -- Periodo
                            l_textoActual := l_textoActual || r_ctacte(j).cam_refe;
                            l_textoActual := l_textoActual || '<t/>';

                            -- Descripcion
                            l_textoActual := l_textoActual || r_ctacte(j).tip_movi;
                            l_textoActual := l_textoActual || '<t/>';

                            -- Fecha Vencimiento
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_venc, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<t/>';

                            -- Fecha Pago
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_pago, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Cargo
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).imp_carg, l_formatoNumerico));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Abono
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).imp_abon, l_formatoNumerico));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Valor Actual
                            l_saldoActual := l_saldoActual - r_ctacte(j).imp_movi;
                            l_textoActual := l_textoActual || trim(to_char(l_saldoActual, l_formatoNumerico));
                            l_textoActual := l_textoActual || '</txt>';

                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                        END LOOP;
                    END IF;
                    EXIT WHEN c_ctacte%NOTFOUND;
                END LOOP;

                -- Cerramos el cursor de detalles
                CLOSE c_ctacte;

                -- Fin Detalle de Cuenta Corriente
                l_textoActual := '</detctacte>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_clientes%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_clientes;

END;

/**************************************************************************
Descripcion         : Proceso que obtiene la informacion para generar la
                      seccion de detalle de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_DETAL_CCC_Z(p_codigoPais IN VARCHAR2,
                                 p_codigoPeriodo IN VARCHAR2,
                                 p_fechaFacturacion IN VARCHAR2,
                                 p_oidzona IN NUMBER) IS

CURSOR c_clientes(oidPeriodo NUMBER) IS
SELECT DISTINCT
       MC.OID_CLIE,
       MC.COD_CLIE
FROM PED_SOLIC_CABEC CON,
     MAE_CLIEN MC,
     PED_TIPO_SOLIC_PAIS PTSP,
     PED_TIPO_SOLIC PTS,
     SEG_PAIS
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND CON.FEC_FACT = TO_DATE (p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.PERD_OID_PERI = oidPeriodo
  AND CON.Zzon_Oid_Zona=p_oidzona
  AND SEG_PAIS.COD_PAIS = p_codigoPais
  AND PTSP.TSOL_OID_TIPO_SOLI = PTS.OID_TIPO_SOLI
  AND CON.TSPA_OID_TIPO_SOLI_PAIS = PTSP.OID_TIPO_SOLI_PAIS
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND PTS.COD_TIPO_SOLI = 'C1' -- Consolidado O/C Consultora
ORDER BY MC.COD_CLIE;

TYPE clienterecord IS RECORD (
    oid_clie    mae_clien.oid_clie%TYPE,
    cod_clie    mae_clien.cod_clie%TYPE
);

TYPE clientetype IS TABLE OF clienterecord;
r_cliente    clientetype;

CURSOR c_ctacte(oidCliente NUMBER,
                numeroDetalles NUMBER) IS
SELECT *
FROM (
SELECT FEC_EMIS,
       CAM_REFE,
       TIP_MOVI,
       NUM_DOCU,
       FEC_VENC,
       FEC_PAGO,
       IMP_CARG,
       IMP_ABON,
       IMP_MOVI
FROM (
    SELECT FEC_EMIS,
           CAM_REFE,
           TIP_MOVI,
           NUM_DOCU,
           FEC_VENC,
           FEC_PAGO,
           IMP_CARG,
           IMP_ABON,
           DECODE(IMP_CARG, NULL, IMP_ABON, -1 * IMP_CARG) IMP_MOVI
    FROM (
        SELECT MCC.FEC_DOCU FEC_EMIS,
               nvl((
               select z.cod_peri
               from ped_solic_cabec x, cra_perio y, seg_perio_corpo z
               where x.perd_oid_peri=y.oid_peri and y.peri_oid_peri=z.oid_peri
               and x.oid_soli_cabe=mcc.soca_oid_soli_cabe
               ),SPC.COD_PERI) CAM_REFE,
               CASE
                   WHEN MCC.TCAB_OID_TCAB_CREA = 2001 THEN
                   CASE
                       WHEN EXISTS (
                            SELECT OID_SOLI_CABE
                              FROM PED_SOLIC_CABEC P,
                                   PED_TIPO_SOLIC_PAIS TP,
                                   PED_TIPO_SOLIC T
                             WHERE P.SOCA_OID_SOLI_CABE = MCC.SOCA_OID_SOLI_CABE
                               AND P.TSPA_OID_TIPO_SOLI_PAIS = TP.OID_TIPO_SOLI_PAIS
                               AND TP.TSOL_OID_TIPO_SOLI = T.OID_TIPO_SOLI
                               AND P.IND_OC = 1
                               AND T.IND_SOLI_NEGA = 0)
                       THEN 'Pedido'
                       ELSE
                           CASE
                               WHEN MCC.IMP_MOVI > 0 THEN
                                   'Atencion de Servicio'
                               ELSE
                                   NVL((SELECT 'C'
                                             || PERIOCORPO.COD_PERI
                                             || ' '
                                             || OPERA.VAL_DESC_LARG
                                             || ' NRO.'
                                             || CABECRECLA.NUM_RECL AS DESCRIP
                                        FROM PED_SOLIC_CABEC CONS,
                                             PED_SOLIC_CABEC SOLICRECLA,
                                             PED_SOLIC_CABEC SOLICORIGEN,
                                             REC_SOLIC_OPERA SOLICOPERA,
                                             REC_OPERA_RECLA OPERARECLA,
                                             REC_CABEC_RECLA CABECRECLA,
                                             REC_TIPOS_OPERA TIPOSOPERA,
                                             REC_OPERA OPERA,
                                             CRA_PERIO PERIO,
                                             SEG_PERIO_CORPO PERIOCORPO
                                       WHERE CONS.OID_SOLI_CABE = MCC.SOCA_OID_SOLI_CABE
                                         AND CONS.OID_SOLI_CABE = SOLICRECLA.SOCA_OID_SOLI_CABE
                                         AND SOLICRECLA.SOCA_OID_DOCU_REFE IS NOT NULL
                                         AND SOLICRECLA.OID_SOLI_CABE = SOLICOPERA.SOCA_OID_SOLI_CABE
                                         AND SOLICOPERA.OPRE_OID_OPER_RECL = OPERARECLA.OID_OPER_RECL
                                         AND OPERARECLA.CARE_OID_CABE_RECL = CABECRECLA.OID_CABE_RECL
                                         AND OPERARECLA.TIOP_OID_TIPO_OPER = TIPOSOPERA.OID_TIPO_OPER
                                         AND TIPOSOPERA.ROPE_OID_OPER = OPERA.OID_OPER
                                         AND SOLICRECLA.SOCA_OID_DOCU_REFE = SOLICORIGEN.OID_SOLI_CABE
                                         AND SOLICORIGEN.PERD_OID_PERI = PERIO.OID_PERI
                                         AND PERIO.PERI_OID_PERI = PERIOCORPO.OID_PERI
                                         AND ROWNUM = 1)
                                     , 'CDR'
                                   )
                           END
                   END
                   ELSE GEN.VAL_I18N
               END TIP_MOVI,
               MCC.SOCA_OID_SOLI_CABE SOCA_OID_SOLI_CABE,
               MCC.NUM_IDEN_CUOT NUM_DOCU,
               MCC.FEC_VENC FEC_VENC,
               NULL FEC_PAGO,
               CASE
                   WHEN (MCC.IMP_MOVI > 0) THEN MCC.IMP_MOVI
                   ELSE NULL
               END IMP_CARG,
               CASE
                  WHEN (MCC.IMP_MOVI > 0) THEN NULL
                  ELSE ABS(MCC.IMP_MOVI)
               END IMP_ABON
         FROM CCC_MOVIM_CUENT_CORRI MCC,
              CCC_SUBPR CS,
              CCC_TIPO_ABONO_SUBPR TAS,
              CCC_TIPO_CARGO_ABONO TCA,
              GEN_I18N_SICC_PAIS GEN,
              CRA_PERIO CP,
              SEG_PERIO_CORPO SPC
        WHERE MCC.SUBP_OID_SUBP_CREA = CS.OID_SUBP
          AND CS.OID_SUBP = TAS.SUBP_OID_SUBP
          AND TAS.TCAB_OID_TCAB = TCA.OID_TIPO_CARG_ABON
          AND GEN.ATTR_ENTI LIKE 'CCC_TIPO_CARGO_ABONO'
          AND GEN.VAL_OID = TCA.OID_TIPO_CARG_ABON
          AND MCC.PERD_OID_PERI = CP.OID_PERI
          AND CP.PERI_OID_PERI = SPC.OID_PERI
          AND MCC.CLIE_OID_CLIE = oidCliente
        /*AND ROWNUM = 1*/
        UNION ALL
        SELECT MB.FEC_PROC FEC_EMIS,
               NULL OID_PERI,
               CCB.DES_CC TIP_MOVI,
               MB.OID_MOVI_BANC SOCA_OID_SOLI_CABE,
               MB.NUM_LOTE NUM_DOCU,
               NULL FEC_VENC,
               MB.FEC_PAGO FEC_PAGO,
               NULL IMP_CARG,
               MB.IMP_PAGO IMP_ABON
          FROM CCC_MOVIM_BANCA MB,
               CCC_CUENT_CORRI_BANCA CCB
         WHERE MB.CCBA_OID_CC_BANC = CCB.OID_CUEN_CORR_BANC
           AND MB.COD_IDEN_PROC = 'P'
           AND MB.CLIE_OID_CLIE = oidCliente
    )
    WHERE FEC_EMIS <= TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
    ORDER BY 1 DESC
) X
WHERE ROWNUM <= numeroDetalles
)
ORDER BY 1 ASC;

TYPE ctacterecord IS RECORD (
    fec_movi    DATE,
    cam_refe    VARCHAR2(6),
    tip_movi    VARCHAR2(100),
    num_docu    NUMBER,
    fec_venc    DATE,
    fec_pago    DATE,
    imp_carg    NUMBER(12, 2),
    imp_abon    NUMBER(12, 2),
    imp_movi    NUMBER(12, 2)
);

TYPE ctactetype IS TABLE OF ctacterecord;
r_ctacte    ctactetype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;

l_clob                      CLOB;
l_textoActual               VARCHAR2(20000) := '';
--l_formatoNumerico           VARCHAR2(100) := '9999999G990D00';
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_numeroDetallesCtaCte      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesCtaCte');
l_numeroDetalles            NUMBER := 5;
l_saldoActual               NUMBER(12, 2) := 0;

BEGIN

    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);


    /*IMP_PR_GENER_PAQUE_DOCUM_CUPON(p_codigoPais,
                                         p_codigoPeriodo,
                                         p_fechaFacturacion);*/


    BEGIN
        IF l_numeroDetallesCtaCte IS NOT NULL THEN
            l_numeroDetalles := TO_NUMBER(l_numeroDetallesCtaCte);
        END IF;
    EXCEPTION WHEN OTHERS THEN
        l_numeroDetalles := 5; -- Valor por defecto
    END;


    -- Abrimos el cursor principal
    OPEN c_clientes(l_oidPeriodo);
    LOOP
        FETCH c_clientes BULK COLLECT
        INTO r_cliente LIMIT w_filas;

        IF  r_cliente.COUNT > 0 THEN
            FOR i IN r_cliente.FIRST..r_cliente.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM_LASER_CTACT (
                COD_CLIE,
                XML_CUEN_CORR)
                VALUES(
                r_cliente(i).cod_clie,
                EMPTY_CLOB())
                RETURNING XML_CUEN_CORR INTO l_clob;

                -- Inicio Detalle de Cuenta Corriente
                l_textoActual := '<detctacte>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Obtenemos el saldo actual
                l_saldoActual := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_SALDO_INICI(r_cliente(i).oid_clie, l_numeroDetalles, p_fechaFacturacion);

                l_textoActual := l_textoActual || '<txt>SALDO ANTERIOR<t/><t/><t/><t/><tr/><tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_saldoActual, l_formatoNumerico)) || '</txt>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                OPEN c_ctacte(r_cliente(i).oid_clie, l_numeroDetalles);
                LOOP
                    FETCH c_ctacte BULK COLLECT
                    INTO r_ctacte LIMIT w_filas;

                    IF  r_ctacte.COUNT > 0 THEN
                        FOR j IN r_ctacte.FIRST..r_ctacte.LAST
                        LOOP

                            l_textoActual := l_textoActual || '<txt>';

                            -- Fecha de emision
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_movi, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<t/>';

                            -- Periodo
                            l_textoActual := l_textoActual || r_ctacte(j).cam_refe;
                            l_textoActual := l_textoActual || '<t/>';

                            -- Descripcion
                            l_textoActual := l_textoActual || r_ctacte(j).tip_movi;
                            l_textoActual := l_textoActual || '<t/>';

                            -- Fecha Vencimiento
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_venc, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<t/>';

                            -- Fecha Pago
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).fec_pago, 'dd/mm/yyyy'));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Cargo
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).imp_carg, l_formatoNumerico));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Abono
                            l_textoActual := l_textoActual || trim(to_char(r_ctacte(j).imp_abon, l_formatoNumerico));
                            l_textoActual := l_textoActual || '<tr/>';

                            -- Valor Actual
                            l_saldoActual := l_saldoActual - r_ctacte(j).imp_movi;
                            l_textoActual := l_textoActual || trim(to_char(l_saldoActual, l_formatoNumerico));
                            l_textoActual := l_textoActual || '</txt>';

                            --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                        END LOOP;
                    END IF;
                    EXIT WHEN c_ctacte%NOTFOUND;
                END LOOP;

                -- Cerramos el cursor de detalles
                CLOSE c_ctacte;

                -- Fin Detalle de Cuenta Corriente
                l_textoActual := l_textoActual || '</detctacte>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_clientes%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_clientes;

END;
/**************************************************************************
Descripcion         : Genera el archivo laser de detalles de cuenta corriente.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_DETAL_CCC(p_codigoPais VARCHAR2,
                                       p_nombreArchivo VARCHAR2,
                                       p_directorio VARCHAR2) IS

CURSOR c_paquete IS
select '<pd><ccon>' || x.cod_clie || '</ccon>' || x.xml_cuen_corr || '</pd>' xml_paqu_docu
from imp_paque_docum_laser_ctact x
order by x.cod_clie;

CURSOR c_paquete2 IS
select '<pd><frmecc>' || y.xml_cons || x.xml_cuen_corr || '</frmecc></pd>' xml_paqu_docu
from imp_paque_docum_laser_ctact x, IMP_PAQUE_DOCUM_CUPON y
where x.cod_clie=y.cod_clie
order by x.cod_clie;


r_paquete c_paquete%ROWTYPE;


l_indicadorCuponLaserVE     VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCuponLaserVE'),'N');


-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

BEGIN



    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor

    if l_indicadorCuponLaserVE is null or l_indicadorCuponLaserVE='N' then

    OPEN c_paquete;
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    else


    OPEN c_paquete2;
    LOOP
        FETCH c_paquete2 INTO r_paquete;
        EXIT WHEN c_paquete2%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete2;


    end if;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_DETAL_CCC: '||substr(sqlerrm,1,250));

END;


/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el Ultimas Noticias Privilege.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_PRIVI IS

-- Variables a utilizar
l_clob              CLOB;

CURSOR c_paquetes IS
SELECT COD_CONS,
       XML_CONS
FROM IMP_PAQUE_DOCUM_PRIVI;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;
l_ampersand  VARCHAR2(5) := CHR(38) || 'amp;';

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        -- A diferencia de otros procesos similares, validamos la existencia
        -- de la cadena equivalente al empersand como se?al de que ya se hizo
        -- el reemplazo, esto debido a que la generacion de este formato laser
        -- se realiza por otro proceso (Generacion de Archivos Privilege)
        IF INSTR(r_paquetes.XML_CONS, l_ampersand, 1) = 0 THEN

            /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
            OPEN c_caracteres;
            LOOP
            FETCH c_caracteres INTO r_caracteres;
            EXIT WHEN c_caracteres%NOTFOUND;

                l_startPos := 1;
                l_longitud := LENGTH(r_caracteres.VAL_REEM);
                l_pos := INSTR(r_paquetes.XML_CONS, r_caracteres.VAL_CARA, l_startPos);
                WHILE(l_pos != 0) LOOP

                    SELECT XML_CONS
                    INTO l_clob
                    FROM IMP_PAQUE_DOCUM_PRIVI
                    WHERE COD_CONS = r_paquetes.COD_CONS
                    FOR UPDATE;

                    -- Reemplazamos el texto en el clob
                    IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                    l_startPos := l_pos + l_longitud;
                    l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
                END LOOP;
            END LOOP;
            CLOSE c_caracteres;
            COMMIT;

        END IF;

    END LOOP;
    CLOSE c_paquetes;

END;


/**************************************************************************
Descripcion         : Genera el archivo laser de Ultimas Noticias Privilege.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_PRIVI(p_codigoPais VARCHAR2,
                                   p_nombreArchivo VARCHAR2,
                                   p_directorio VARCHAR2) IS

CURSOR c_paquete IS
select '<pd>' || x.xml_cons || '</pd>' xml_paqu_docu
from imp_paque_docum_privi x
order by x.cod_cons;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

BEGIN

    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete;
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_PRIVI: '||substr(sqlerrm,1,250));

END;


/**************************************************************************
Descripcion         : Proceso que prepara la informacion del paquete
                      documentario generado por SiCC haciendo minimas
                      transformaciones.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais
    p_codigoPeriodo         : Periodo del cupon
    p_fechaFacturacion      : Fecha de Facturacion
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2,
                                   p_fechaFacturacion IN VARCHAR2) IS

CURSOR c_paqdoc IS
SELECT PDS.COR_PDSI,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(MC.OID_CLIE, 'TF'),
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(MC.OID_CLIE, 'TM'),
       PDS.VAL_NUME_SOLI,
       PDS.IND_PEDI_SERV,
       PDS.XML_CONS,
       PDPO.XML_MENS_PUNT
FROM IMP_PAQUE_DOCUM_SICC PDS,
     IMP_PAQUE_DOCUM_PUNTA_OBTEN PDPO,
     MAE_CLIEN MC
WHERE PDS.COD_CLIE = MC.COD_CLIE
  AND PDS.COD_CLIE = PDPO.COD_CLIE (+);

TYPE paqdocrecord IS RECORD (
    cor_pdsi            imp_paque_docum_sicc.cor_pdsi%TYPE,
    cod_clie            mae_clien.cod_clie%TYPE,
    cod_digi_ctrl       mae_clien.cod_digi_ctrl%TYPE,
    num_tele_fijo       mae_clien_comun.val_text_comu%TYPE,
    num_tele_movi       mae_clien_comun.val_text_comu%TYPE,
    val_nume_soli       imp_paque_docum_sicc.val_nume_soli%TYPE,
    ind_pedi_serv       imp_paque_docum_sicc.ind_pedi_serv%TYPE,
    xml_cons            clob,
    xml_mens_punt       clob
);

TYPE paqdoctype IS TABLE OF paqdocrecord;
r_paqdoc    paqdoctype;

-- Variables usadas para la compaginacion
l_tagInicio                 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagInicio');
l_tagFin                    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagFin');
l_tagBoletaDespacho         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagBoletaDespacho');
l_tagPuntajeLideres         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagPuntajeLideres');

-- Variables usadas para la inclusion del telefono en la boleta de despacho
l_indicadorTelefono         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorTelefono');
l_tagTelefono               VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagTelefono');
l_textoTelefono             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoTelefono');

-- Variables usadas para la inclusion del tag de saludo por cumplea?os
l_indicadorCumpleanos       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorCumpleanos');
l_tagCumpleanosApertura     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosApertura');
l_tagCumpleanosCierre       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosCierre');

-- Variable usada para la inclusion del digito de control
l_indicadorDigitoCtrlOCS    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorDigitoCtrlOCS');

-- Division de Paquete Documentario
l_tagBoletaDespachoApertura VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagBoletaDespachoApertura');
l_tagBoletaDespachoCierre   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagBoletaDespachoCierre');
l_tagCabeceraBoletaApertura VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCabeceraBoletaDepachoApertura');

-- Variables usadas para la identificacion de pedidos de servicio
l_indicadorPedidoServicio   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorPedidoServicio');
l_tagInicioPedidoServicio   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagInicioPedidoServicio');

lv_reemplazoDireccion VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorReemplazoDireccionDespacho');


l_clob                  CLOB;
l_posicion              NUMBER;
l_textoOriginal         VARCHAR2(4000);
l_textoReemplazo        VARCHAR2(4000);
l_tagsAdicionalesBD     VARCHAR2(4000);

BEGIN

    -- Elimina todos las filas de la Tabla IMP_PAQUE_DOCUM
    EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM';

    -- Abrimos el cursor principal
    OPEN c_paqdoc;
    LOOP
        FETCH c_paqdoc BULK COLLECT
        INTO r_paqdoc LIMIT w_filas;

        IF  r_paqdoc.COUNT > 0 THEN
            FOR i IN r_paqdoc.FIRST..r_paqdoc.LAST
            LOOP

                -- Insertamos el registro y obtenemos la referencia al CLOB
                INSERT INTO IMP_PAQUE_DOCUM (
                COR_PADO,
                COD_CLIE,
                VAL_NUME_SOLI,
                XML_CONS)
                VALUES(
                r_paqdoc(i).cor_pdsi,
                r_paqdoc(i).cod_clie,
                r_paqdoc(i).val_nume_soli,
                r_paqdoc(i).xml_cons)
                RETURNING XML_CONS INTO l_clob;

                -- Agregamos los tags para las clasificaciones configuradas
                -- y los estados de la consultora tambien configuradas
                IF l_tagBoletaDespachoApertura IS NOT NULL AND LENGTH(l_tagBoletaDespachoApertura) > 0 THEN
                    -- Obtenemos los tags a agregar
                    l_tagsAdicionalesBD := IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA(r_paqdoc(i).cod_clie) ||
                                           IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA(r_paqdoc(i).cod_clie);

                    -- Solo reemplazamos si existen valores para los tags de boleta de despacho
                    IF l_tagsAdicionalesBD IS NOT NULL AND LENGTH(l_tagsAdicionalesBD) > 0 THEN
                        -- Obtenemos la posicion de formato de boleta de despacho
                        l_posicion := DBMS_LOB.INSTR(l_clob, l_tagBoletaDespachoApertura);
                        IF l_posicion != 0 THEN

                            -- Reemplazamos el tag de inicio de boleta de despacho por
                            -- el mismo valor mas los tags de clasificacion y estado
                            l_textoOriginal := l_tagBoletaDespachoApertura;
                            l_textoReemplazo := l_tagBoletaDespachoApertura || l_tagsAdicionalesBD;
                            IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo, l_posicion);

                        END IF;
                    END IF;

                END IF;

                -- Agregamos el digito de control
                IF l_indicadorDigitoCtrlOCS = 'S' THEN
                    -- Obtenemos la posicion de formato de orden de compra
                    l_posicion := DBMS_LOB.INSTR(l_clob, '<frmocs>');
                    IF l_posicion != 0 THEN

                        -- Reemplazamos el texto de fin del tag del codigo
                        -- de la consultora incluyendo el digito de control
                        l_textoOriginal := '</ccon>';
                        l_textoReemplazo := r_paqdoc(i).cod_digi_ctrl || '</ccon>';
                        IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo, l_posicion);

                    END IF;
                END IF;

                -- Agregamos el telefono
                IF l_indicadorTelefono = 'S'AND
                   l_tagTelefono IS NOT NULL AND
                   (r_paqdoc(i).num_tele_fijo IS NOT NULL OR r_paqdoc(i).num_tele_movi IS NOT NULL)  THEN
                    -- Obtenemos la posicion de formato de orden de compra
                    l_posicion := DBMS_LOB.INSTR(l_clob, '<frmbd>');
                    IF l_posicion != 0 THEN

                        -- Reemplazamos el texto de fin del tag del codigo
                        -- de la consultora incluyendo el digito de control
                        l_textoOriginal := l_tagTelefono;
                        l_textoReemplazo := l_textoTelefono || r_paqdoc(i).num_tele_fijo || '/' || r_paqdoc(i).num_tele_movi || l_tagTelefono;
                        IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo, l_posicion);

                    END IF;
                END IF;

                -- Mensaje de lideres
                IF l_tagPuntajeLideres IS NOT NULL AND
                   INSTR(r_paqdoc(i).xml_cons, l_tagPuntajeLideres) != 0 AND
                   LENGTH(r_paqdoc(i).xml_mens_punt) > 0 THEN

                    -- Incluimos el mensaje del puntaje de concurso de lideres
                    l_textoOriginal := l_tagPuntajeLideres;
                    l_textoReemplazo := l_tagPuntajeLideres || r_paqdoc(i).xml_mens_punt;
                    IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo);

                END IF;

                -- Tag de Pedido de Servicio
                IF l_indicadorPedidoServicio = 'S' AND
                   r_paqdoc(i).ind_pedi_serv = 'S' THEN

                    -- Reemplazamos el tag de inicio del paqdoc
                    l_textoOriginal := l_tagInicio;
                    l_textoReemplazo := l_tagInicioPedidoServicio;
                    IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo);

                END IF;

                commit;

            END LOOP;

        END IF;

        EXIT WHEN c_paqdoc%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_paqdoc;

    IF lv_reemplazoDireccion = 'S' THEN
         IMP_PKG_PROCE_COMPA.IMP_PR_REEMP_DIREC_BOLET_DESPA;
    END IF;

    IMP_PKG_PROCE_COMPA.IMP_PR_REEMP_DATOS_OCS(p_codigoPais);

END;


/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales en
                      el paquete documentario.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_PAQUE_DOCUM IS

-- Variables a utilizar
l_clob              CLOB;

CURSOR c_paquetes IS
SELECT COR_PADO,
       NUM_PADO,
       XML_CONS
FROM IMP_PAQUE_DOCUM;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
        OPEN c_caracteres;
        LOOP
        FETCH c_caracteres INTO r_caracteres;
        EXIT WHEN c_caracteres%NOTFOUND;

            l_startPos := 1;
            l_longitud := LENGTH(r_caracteres.VAL_REEM);
            l_pos := INSTR(r_paquetes.XML_CONS, r_caracteres.VAL_CARA, l_startPos);
            WHILE(l_pos != 0) LOOP

                SELECT XML_CONS
                INTO l_clob
                FROM IMP_PAQUE_DOCUM
                WHERE COR_PADO = r_paquetes.COR_PADO
                AND NUM_PADO = r_paquetes.NUM_PADO
                FOR UPDATE;

                -- Reemplazamos el texto en el clob
                IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                l_startPos := l_pos + l_longitud;
                l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
            END LOOP;
        END LOOP;
        CLOSE c_caracteres;
        COMMIT;

    END LOOP;
    CLOSE c_paquetes;

END;


/**************************************************************************
Descripcion         : Genera el archivo laser del paquete documentario.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_PAQUE_DOCUM(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2) IS
CURSOR c_paquete IS
select x.xml_cons xml_paqu_docu
from imp_paque_docum x
order by x.cor_pado;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

BEGIN

    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete;
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_PAQUE_DOCUM: '||substr(sqlerrm,1,250));

END;

/**************************************************************************
Descripcion         : Genera la boleta de despacho
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_BODES(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_boletaDespacho(oidPais NUMBER,
                        oidPeriodo NUMBER,
                        indicadorEnvioLarissa VARCHAR2,
                        numeroLoteFacturacion NUMBER) IS
select con.oid_soli_cabe,
       mc.oid_clie,
       mc.cod_clie,
       mc.val_ape1 || ' ' || mc.val_ape2 || ', ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       sec.num_secu_fact_diar,
       con.val_nume_soli,
       imp_pkg_proce_laser.imp_fn_obtiene_text_direc(imp_pkg_proce_laser.imp_fn_obtiene_direc_clie(p_codigoPais,mc.oid_clie),'') as val_dir1,
       imp_pkg_proce_laser.imp_fn_obtiene_text2_direc(imp_pkg_proce_laser.imp_fn_obtiene_direc_clie(p_codigoPais,mc.oid_clie),'') as val_dir2,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TF')  || '/' ||
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TM')) val_tele,
       zon.oid_zona,
       zse.cod_secc,
       zon.cod_zona,
       ter.cod_terr,
       to_char(con.fec_fact, 'dd/mm/yyyy') fec_emis,
       con.num_unid_aten_tota,
       con.val_tota_paga_loca ,
       (select nvl(sum(num_unid_aten), 0)
        from ped_solic_cabec psc,
             ped_solic_posic psp
        where psc.oid_soli_cabe = psp.soca_oid_soli_cabe
          and psp.ind_dent_fuer_caja_bols != 'C'
          and psp.num_unid_aten > 0
          and psc.soca_oid_soli_cabe = con.oid_soli_cabe
       ) num_unid_fuer_caja_tota,
       (select z.dir_buzo from sto_acopi_cober z where z.cod_terr=ter.cod_terr) dirbuz
from mae_clien mc,
     ped_solic_cabec con,
     ped_solic_cabec_secue sec,
     zon_zona zon,
     zon_terri_admin zta,
     zon_secci zse,
     zon_terri ter
where mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and con.terr_oid_terr = ter.oid_terr
  and con.ztad_oid_terr_admi = zta.oid_terr_admi
  and zta.zscc_oid_secc = zse.oid_secc
  and con.pais_oid_pais = oidPais
  and con.perd_oid_peri = oidPeriodo
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and con.oid_soli_cabe = sec.soca_oid_soli_cabe
  and con.num_unid_aten_tota > 0
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  )
order by sec.num_secu_zona_ruta,
         sec.num_secu_fact_diar;

r_boletaDespacho c_boletaDespacho%ROWTYPE;

CURSOR c_detalleBoleta(oidConsolidado NUMBER) IS
select psp.cod_posi,
       psp.num_unid_aten,
       decode(psc.ictp_oid_tipo_prog, null, psp.ind_dent_fuer_caja_bols, 'P') ind_dent_fuer_caja_bols,
       mp.cod_sap,
       nvl(psp.val_codi_vent, psp.val_codi_vent_fict) val_codi_vent,
       trim((select val_i18n from gen_i18n_sicc_pais i18n where i18n.attr_enti = 'MAE_PRODU' and i18n.val_oid = mp.oid_prod and i18n.idio_oid_idio = 1)) des_prod
from ped_solic_cabec con,
     ped_solic_cabec psc,
     ped_solic_posic psp,
     mae_produ mp
where con.oid_soli_cabe = psc.soca_oid_soli_cabe
  and psc.oid_soli_cabe = psp.soca_oid_soli_cabe
  and psp.prod_oid_prod = mp.oid_prod
  and con.oid_soli_cabe = oidConsolidado
  and psp.ind_dent_fuer_caja_bols != 'C'
  and psp.num_unid_aten > 0
order by psp.cod_posi;

r_detalleBoleta c_detalleBoleta%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_contadorDetalles              NUMBER := 0;

-- Variables usadas para la inclusion del telefono en la boleta de despacho
l_indicadorTelefono         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorTelefono');
l_textoTelefono             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoTelefono');

-- Variables usadas para la inclusion del tag de saludo por cumplea?os
l_indicadorCumpleanos       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorCumpleanos');
l_tagCumpleanosApertura     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosApertura');
l_tagCumpleanosCierre       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosCierre');

--NUEVO PARAMETRO
l_indicadorBoletaDespacho   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarBoletaDespacho');
BEGIN

    -- SE VALIDARA SI EL PARAMETRO ESTA ACTIVO 'S' , si no esta activo NO se realizara el proceso de generacion de boleta despacho
    IF(l_indicadorBoletaDespacho IS NULL OR l_indicadorBoletaDespacho<>'S')THEN
      RETURN;
    END IF;

    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    -- Elimina todos las filas de la Tabla IMP_PAQUE_DOCUM_BOLET_DESPA
    DELETE FROM IMP_PAQUE_DOCUM_BOLET_DESPA;
    OPEN c_boletaDespacho(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
    FETCH c_boletaDespacho INTO r_boletaDespacho;
    EXIT WHEN c_boletaDespacho%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_BOLET_DESPA(
            COR_PDBD,
            COD_CLIE,
            VAL_NUME_SOLI,
            XML_CONS
            )
            VALUES (
            l_correlativo,
            r_boletaDespacho.cod_clie,
            r_boletaDespacho.val_nume_soli,
            EMPTY_CLOB())
            RETURNING XML_CONS INTO l_clob;

            -- Inicio del paquete
            l_textoActual := '<frmbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            l_textoActual := IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA( r_boletaDespacho.cod_clie) ||
              IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA( r_boletaDespacho.cod_clie);

            IF( l_textoActual IS NOT NULL AND LENGTH(l_textoActual) > 0) THEN
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Inicio boleta Despacho
            l_textoActual := '<pbd1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio cabecera
            l_textoActual := '<blqcab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Saludo de cumplea?os
            IF l_indicadorCumpleanos = 'S' AND IMP_PKG_PROCE_COMPA.IMP_FN_VALID_CUMPL(r_boletaDespacho.cod_clie) != 0 THEN
                l_textoActual := l_tagCumpleanosApertura || l_tagCumpleanosCierre;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Numero de Secuencia
            l_textoActual := '<nsec>' || r_boletaDespacho.num_secu_fact_diar || '</nsec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Chequeo de Pedido
            l_textoActual := '<chq></chq>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_boletaDespacho.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_boletaDespacho.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_boletaDespacho.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_boletaDespacho.cod_secc || ' - ' || r_boletaDespacho.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 1
            l_textoActual := '<dir1>' || nvl(r_boletaDespacho.dirbuz,r_boletaDespacho.val_dir1) || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
            IF l_indicadorTelefono = 'S'AND
               (r_boletaDespacho.val_tele IS NOT NULL)  THEN
                if r_boletaDespacho.dirbuz is null then
                   l_textoActual := '<dir2>' ||  r_boletaDespacho.val_dir2 || l_textoTelefono || r_boletaDespacho.val_tele || '</dir2>';
                else
                   l_textoActual := '<dir2>' ||  l_textoTelefono || r_boletaDespacho.val_tele || '</dir2>';
                end if;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            ELSE
                if r_boletaDespacho.dirbuz is null then
                   l_textoActual := '<dir2>' ||  r_boletaDespacho.val_dir2 || '</dir2>';
                else
                   l_textoActual := '<dir2>' || '</dir2>';
                end if;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Nunero Boleta Despacho
            l_textoActual := '<nbd>' || r_boletaDespacho.val_nume_soli || '</nbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Periodo
            l_textoActual := '<fcam>' || l_codigoPeriodo || '</fcam>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha
            l_textoActual := '<femi>' || r_boletaDespacho.fec_emis || '</femi>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Cabecera
            l_textoActual := '</blqcab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio Bloque Numero de Paquetes
            l_textoActual := '<blqimp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Numero total de unidades atendidas
            l_textoActual := '<txt>' || r_boletaDespacho.num_unid_aten_tota || '</txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Separador
            l_textoActual := '<txt/>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Monto del Pedido
            l_textoActual := '<txt>' || r_boletaDespacho.val_tota_paga_loca || '</txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Separador
            l_textoActual := '<txt/><txt></txt><txt></txt><txt/><txt></txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Bloque Numero de Paquetes
            l_textoActual := '</blqimp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio de detalle de Boleta de Despacho
            l_textoActual := '<detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            l_contadorDetalles := 0;

            OPEN c_detalleBoleta(r_boletaDespacho.oid_soli_cabe);
            LOOP
            FETCH c_detalleBoleta INTO r_detalleBoleta;
            EXIT WHEN c_detalleBoleta%NOTFOUND;
            BEGIN

                IF l_contadorDetalles = 0 THEN
                    l_textoActual := '<txt>SE ADJUNTAN ' || r_boletaDespacho.num_unid_fuer_caja_tota || ' UNIDADES FUERA DE LA CAJA Y/O PREMIOS</txt>';
                    l_textoActual := l_textoActual || '<txt>SIRVASE VERIFICAR: </txt>';
                    l_textoActual := l_textoActual || '<txt>UNID<t/>IND<t/>DESCRIPCION DE PRODUCTO<t/><t/><t/><t/><t/><t/><t/>UNID<t/>IND<t/>DESCRIPCION DE PRODUCTO</txt>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                IF MOD(l_contadorDetalles, 2) = 0 THEN
                    l_textoActual := '<txt>' || r_detalleBoleta.num_unid_aten || '<t/>' || r_detalleBoleta.ind_dent_fuer_caja_bols || '<t/>' || r_detalleBoleta.des_prod;
                    l_textoActual := l_textoActual || '<t/><t/><t/><t/><t/><t/><t/>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                IF MOD(l_contadorDetalles, 2) != 0 THEN
                    l_textoActual := r_detalleBoleta.num_unid_aten || '<t/>' || r_detalleBoleta.ind_dent_fuer_caja_bols || '<t/>' || r_detalleBoleta.des_prod || '</txt>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                l_contadorDetalles := l_contadorDetalles + 1;

            END;
            END LOOP;
            CLOSE c_detalleBoleta;

            -- En caso el numero de detalles haya sido impar agregamos los ultimos campos vacios
            IF MOD(l_contadorDetalles, 2) != 0 THEN
                l_textoActual := '<t/><t/></txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Fin de detalle de Boleta de Despacho
            l_textoActual := '</detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin boletaDespacho
            l_textoActual := '</pbd1></frmbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_boletaDespacho;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_BODES: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_BODES;

/**************************************************************************
Descripcion         : Genera la boleta de despacho
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_BDE_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_boletaDespacho(oidPais NUMBER,
                        oidPeriodo NUMBER,
                        indicadorEnvioLarissa VARCHAR2,
                        numeroLoteFacturacion NUMBER,
                        indicadorDir2 VARCHAR2
                        ) IS
select con.oid_soli_cabe,
       mc.oid_clie,
       mc.cod_clie,
       mc.val_ape1 || ' ' || mc.val_ape2 || ', ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       sec.num_secu_fact_diar,
       con.val_nume_soli,
       --trim(stv.des_abrv_tipo_via)  || ' ' || trim(mcd.val_nomb_via) || ' ' || trim(mcd.num_ppal) || trim(mcd.val_obse) val_dir1,
       imp_pkg_proce_laser.imp_fn_obtiene_text_direc(imp_pkg_proce_laser.imp_fn_obtiene_direc_clie(p_codigoPais,mc.oid_clie),'') as val_dir1,
       decode(indicadorDir2,'S',imp_pkg_proce_laser.imp_fn_obtiene_text2_direc(imp_pkg_proce_laser.imp_fn_obtiene_direc_clie(p_codigoPais,mc.oid_clie),''),'') as val_dir2,
       /*trim('/' from
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 4) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 3) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 2) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 1)) val_dir2,*/
       trim('/' from
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TF')  || '/' ||
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TM')) val_tele,
       zon.oid_zona,
       zse.cod_secc,
       zon.cod_zona,
       ter.cod_terr,
       to_char(con.fec_fact, 'dd/mm/yyyy') fec_emis,
       con.num_unid_aten_tota,
       con.val_tota_paga_loca ,
       (select nvl(sum(num_unid_aten), 0)
        from ped_solic_cabec psc,
             ped_solic_posic psp
        where psc.oid_soli_cabe = psp.soca_oid_soli_cabe
          and psp.ind_dent_fuer_caja_bols != 'C'
          and psp.num_unid_aten > 0
          and psc.soca_oid_soli_cabe = con.oid_soli_cabe
       ) num_unid_fuer_caja_tota,
       (select z.dir_buzo from sto_acopi_cober z where ltrim(z.cod_terr)=ter.cod_terr and rownum=1) dirbuz,
       (select z.num_docu_cont_inte from fac_docum_conta_cabec z where z.soca_oid_soli_cabe=con.oid_soli_cabe and tido_oid_tipo_docu in (1,29) and rownum=1) doclega,
       to_char(psep.fec,'dd/mm/yyyy') fecent,
       (select cod_alma from bel_almac where oid_alma=con.almc_oid_alma) almacen
from mae_clien mc,
--     mae_clien_direc mcd,
--     seg_tipo_via stv,
     ped_solic_cabec con,
     ped_solic_cabec_secue sec,
     ped_segui_pedid psep,
     zon_zona zon,
     zon_terri_admin zta,
     zon_secci zse,
     zon_terri ter
where --mc.oid_clie = mcd.clie_oid_clie
--  and mcd.tivi_oid_tipo_via = stv.oid_tipo_via (+)
--  and mcd.ind_elim = 0
--  and mcd.ind_dire_ppal = 1
  --and
  mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and con.oid_soli_cabe=psep.soca_oid_soli_cabe(+)
  and con.terr_oid_terr = ter.oid_terr
  and con.ztad_oid_terr_admi = zta.oid_terr_admi
  and zta.zscc_oid_secc = zse.oid_secc
  and con.pais_oid_pais = oidPais
  and con.perd_oid_peri = oidPeriodo
  and con.zzon_oid_zona = p_oidzona
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and con.oid_soli_cabe = sec.soca_oid_soli_cabe
  and con.num_unid_aten_tota > 0
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  )
order by sec.num_secu_zona_ruta,
         sec.num_secu_fact_diar;

r_boletaDespacho c_boletaDespacho%ROWTYPE;

CURSOR c_detalleBoleta(oidConsolidado NUMBER) IS
select psp.cod_posi,
       psp.num_unid_aten,
       decode(psc.ictp_oid_tipo_prog, null, psp.ind_dent_fuer_caja_bols, 'P') ind_dent_fuer_caja_bols,
       mp.cod_sap,
       nvl(psp.val_codi_vent, psp.val_codi_vent_fict) val_codi_vent,
       trim((select val_i18n from gen_i18n_sicc_pais i18n where i18n.attr_enti = 'MAE_PRODU' and i18n.val_oid = mp.oid_prod and i18n.idio_oid_idio = 1)) des_prod
from ped_solic_cabec con,
     ped_solic_cabec psc,
     ped_solic_posic psp,
     mae_produ mp
where con.oid_soli_cabe = psc.soca_oid_soli_cabe
  and psc.oid_soli_cabe = psp.soca_oid_soli_cabe
  and psp.prod_oid_prod = mp.oid_prod
  and con.oid_soli_cabe = oidConsolidado
  and psp.ind_dent_fuer_caja_bols != 'C'
  and psp.num_unid_aten > 0
  and nvl(mp.val_atri_3,'0') <> '1'
order by psp.cod_posi;

r_detalleBoleta c_detalleBoleta%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_contadorDetalles              NUMBER := 0;

-- Variables usadas para la inclusion del telefono en la boleta de despacho
l_indicadorTelefono         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorTelefono');
l_textoTelefono             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoTelefono');

-- Variables usadas para la inclusion del tag de saludo por cumplea?os
l_indicadorCumpleanos       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorCumpleanos');
l_tagCumpleanosApertura     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosApertura');
l_tagCumpleanosCierre       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosCierre');

--NUEVO PARAMETRO
indicadorDir2BoletaDespacho   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorDir2BoletaDespacho');

--NUEVO PARAMETRO
indicadorFechaEntrega   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorFechaEntrega'),'N');

BEGIN


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    OPEN c_boletaDespacho(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion, indicadorDir2BoletaDespacho);
    LOOP
    FETCH c_boletaDespacho INTO r_boletaDespacho;
    EXIT WHEN c_boletaDespacho%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_BOLET_DESPA(
            COR_PDBD,
            COD_CLIE,
            VAL_NUME_SOLI,
            XML_CONS
            )
            VALUES (
            r_boletaDespacho.val_nume_soli,
            r_boletaDespacho.cod_clie,
            r_boletaDespacho.val_nume_soli,
            EMPTY_CLOB())
            RETURNING XML_CONS INTO l_clob;

            -- Inicio del paquete
            l_textoActual := '<frmbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            l_textoActual := IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA( r_boletaDespacho.cod_clie) ||
              IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA( r_boletaDespacho.cod_clie);

            IF( l_textoActual IS NOT NULL AND LENGTH(l_textoActual) > 0) THEN
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Inicio boleta Despacho
            l_textoActual := '<pbd1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio cabecera
            l_textoActual := '<blqcab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Saludo de cumplea?os
            IF l_indicadorCumpleanos = 'S' AND IMP_PKG_PROCE_COMPA.IMP_FN_VALID_CUMPL(r_boletaDespacho.cod_clie) != 0 THEN
                l_textoActual := l_tagCumpleanosApertura || l_tagCumpleanosCierre;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Numero de Secuencia
            l_textoActual := '<nsec>' || r_boletaDespacho.num_secu_fact_diar || '</nsec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Chequeo de Pedido
            l_textoActual := '<chq></chq>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_boletaDespacho.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_boletaDespacho.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_boletaDespacho.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_boletaDespacho.cod_secc || ' - ' || r_boletaDespacho.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 1
            l_textoActual := '<dir1>' || nvl(r_boletaDespacho.dirbuz,r_boletaDespacho.val_dir1) || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
            IF l_indicadorTelefono = 'S'AND
               (r_boletaDespacho.val_tele IS NOT NULL)  THEN
                if r_boletaDespacho.dirbuz is null then
                   l_textoActual := '<dir2>' ||  r_boletaDespacho.val_dir2 || l_textoTelefono || r_boletaDespacho.val_tele || '</dir2>';
                else
                   l_textoActual := '<dir2>' ||  l_textoTelefono || r_boletaDespacho.val_tele || '</dir2>';
                end if;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            ELSE
                if r_boletaDespacho.dirbuz is null then
                   l_textoActual := '<dir2>' ||  r_boletaDespacho.val_dir2 || '</dir2>';
                else
                   l_textoActual := '<dir2>' || '</dir2>';
                end if;
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Nunero Boleta Despacho
            l_textoActual := '<nbd>' || r_boletaDespacho.val_nume_soli || '</nbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Periodo
            l_textoActual := '<fcam>' || l_codigoPeriodo || '</fcam>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha
            l_textoActual := '<femi>' || r_boletaDespacho.fec_emis || '</femi>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            if indicadorFechaEntrega='S'  then

              -- Fecha Entrega
              l_textoActual := '<feen>' || r_boletaDespacho.fecent || '</feen>';
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

              -- Fecha Entrega
              l_textoActual := '<doclega>' || r_boletaDespacho.doclega || '</doclega>';
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

              -- Almacen
              l_textoActual := '<almacen>' || r_boletaDespacho.almacen || '</almacen>';
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            end if;


            -- Fin Cabecera
            l_textoActual := '</blqcab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio Bloque Numero de Paquetes
            l_textoActual := '<blqimp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Numero total de unidades atendidas
            l_textoActual := '<txt>' || r_boletaDespacho.num_unid_aten_tota || '</txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Separador
            l_textoActual := '<txt/>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Monto del Pedido
            l_textoActual := '<txt>' || r_boletaDespacho.val_tota_paga_loca || '</txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Separador
            l_textoActual := '<txt/><txt></txt><txt></txt><txt/><txt></txt>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Bloque Numero de Paquetes
            l_textoActual := '</blqimp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio de detalle de Boleta de Despacho
            l_textoActual := '<detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            l_contadorDetalles := 0;

            OPEN c_detalleBoleta(r_boletaDespacho.oid_soli_cabe);
            LOOP
            FETCH c_detalleBoleta INTO r_detalleBoleta;
            EXIT WHEN c_detalleBoleta%NOTFOUND;
            BEGIN

                IF l_contadorDetalles = 0 THEN
                    l_textoActual := '<txt>SE ADJUNTAN ' || r_boletaDespacho.num_unid_fuer_caja_tota || ' UNIDADES FUERA DE LA CAJA Y/O PREMIOS</txt>';
                    l_textoActual := l_textoActual || '<txt>SIRVASE VERIFICAR: </txt>';
                    l_textoActual := l_textoActual || '<txt>UNID<t/>IND<t/>DESCRIPCION DE PRODUCTO<t/><t/><t/><t/><t/><t/><t/>UNID<t/>IND<t/>DESCRIPCION DE PRODUCTO</txt>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                IF MOD(l_contadorDetalles, 2) = 0 THEN
                    l_textoActual := '<txt>' || r_detalleBoleta.num_unid_aten || '<t/>' || r_detalleBoleta.ind_dent_fuer_caja_bols || '<t/>' || r_detalleBoleta.des_prod;
                    l_textoActual := l_textoActual || '<t/><t/><t/><t/><t/><t/><t/>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                IF MOD(l_contadorDetalles, 2) != 0 THEN
                    l_textoActual := r_detalleBoleta.num_unid_aten || '<t/>' || r_detalleBoleta.ind_dent_fuer_caja_bols || '<t/>' || r_detalleBoleta.des_prod || '</txt>';
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;

                l_contadorDetalles := l_contadorDetalles + 1;

            END;
            END LOOP;
            CLOSE c_detalleBoleta;

            -- En caso el numero de detalles haya sido impar agregamos los ultimos campos vacios
            IF MOD(l_contadorDetalles, 2) != 0 THEN
                l_textoActual := '<t/><t/></txt>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

            -- Fin de detalle de Boleta de Despacho
            l_textoActual := '</detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin boletaDespacho
            l_textoActual := '</pbd1></frmbd>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


           -- l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_boletaDespacho;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_BDE_Z: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_BDE_Z;


/**************************************************************************
Descripcion         : Genera la orden compra simplificada
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_OCS(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_ordenCompra(oidPais NUMBER,
                        oidPeriodo NUMBER,
                        indicadorEnvioLarissa VARCHAR2,
                        numeroLoteFacturacion NUMBER) IS
select mc.cod_clie,
       mc.cod_digi_ctrl,
       mc.val_ape1 || ' ' || mc.val_ape2 || ', ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       stv.des_abrv_tipo_via  || ' ' || mcd.val_nomb_via || ' ' || mcd.num_ppal || mcd.val_obse val_dir1,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 4) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 3) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 2) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 1)) val_dir2,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TF')  || '/' ||
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TM')) val_tele,
       con.val_nume_soli,
       reg.cod_regi,
       zon.cod_zona,
       zse.cod_secc,
       ter.cod_terr
from mae_clien mc,
     mae_clien_direc mcd,
     seg_tipo_via stv,
     ped_solic_cabec con,
     ped_solic_cabec_secue sec,
     zon_regio reg,
     zon_zona zon,
     zon_terri_admin zta,
     zon_secci zse,
     zon_terri ter
where mc.oid_clie = mcd.clie_oid_clie
  and mcd.tivi_oid_tipo_via = stv.oid_tipo_via (+)
  and mcd.ind_elim = 0
  and mcd.ind_dire_ppal = 1
  and mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and reg.oid_regi = zon.zorg_oid_regi
  and con.terr_oid_terr = ter.oid_terr
  and con.ztad_oid_terr_admi = zta.oid_terr_admi
  and zta.zscc_oid_secc = zse.oid_secc
  and con.pais_oid_pais = oidPais
  and con.perd_oid_peri = oidPeriodo
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and con.oid_soli_cabe = sec.soca_oid_soli_cabe
  and con.num_unid_aten_tota > 0
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  )
order by sec.num_secu_zona_ruta,
         sec.num_secu_fact_diar;

r_ordenCompra c_ordenCompra%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorDigitoCtrlOCS        VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorDigitoCtrlOCS');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_contadorDetalles              NUMBER := 0;

-- Variables usadas para la inclusion del telefono en la boleta de despacho
l_indicadorTelefono         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorTelefono');
l_textoTelefono             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoTelefono');

-- Variables usadas para la inclusion del tag de saludo por cumplea?os
l_indicadorCumpleanos       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorCumpleanos');
l_tagCumpleanosApertura     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosApertura');
l_tagCumpleanosCierre       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosCierre');
--NUEVO PARAMETRO
l_indicadorGenerarOCS       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarOCS');

l_indtelenOCS       VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'l_indtelenOCS'),'S');
BEGIN

    -- SE VALIDARA SI EL PARAMETRO ESTA ACTIVO 'S' , si no esta activo NO se realizara el proceso de generacion de la OCS
    IF(l_indicadorGenerarOCS IS NULL OR l_indicadorGenerarOCS<>'S')THEN
      RETURN;
    END IF;

    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    -- Elimina todos las filas de la Tabla IMP_PAQUE_DOCUM_BOLET_OCOSI
    DELETE FROM IMP_PAQUE_DOCUM_OCS;

    OPEN c_ordenCompra(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
    FETCH c_ordenCompra INTO r_ordenCompra;
    EXIT WHEN c_ordenCompra%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_OCS(
            COR_OCOS,
            COD_CLIE,
            VAL_NUME_SOLI,
            XML_CONS
            )
            VALUES (
            l_correlativo,
            r_ordenCompra.cod_clie,
            r_ordenCompra.val_nume_soli,
            EMPTY_CLOB())
            RETURNING XML_CONS INTO l_clob;

            -- Inicio de orden compra simplificada
            l_textoActual := '<frmocs>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio cabecera
            l_textoActual := '<blqcon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            -- codigo region
            l_textoActual := '<creg>' || r_ordenCompra.cod_regi || '</creg>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_ordenCompra.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Seccion
            l_textoActual := '<csec>' || r_ordenCompra.cod_secc || '</csec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            -- Territorio
            l_textoActual := '<cter>' || r_ordenCompra.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            IF(l_indicadorDigitoCtrlOCS = 'S' ) THEN
               l_textoActual := '<ccon>' || r_ordenCompra.cod_clie || r_ordenCompra.cod_digi_ctrl  ||'</ccon>';
               DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            ELSE
              l_textoActual := '<ccon>' || r_ordenCompra.cod_clie || '</ccon>';
               DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

              -- Nombre Cliente
             l_textoActual := '<ncon>' || r_ordenCompra.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            -- Direccion 1
            l_textoActual := '<dir1>' || r_ordenCompra.val_dir1 || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
             l_textoActual := '<dir2>' || r_ordenCompra.val_dir2 || '</dir2>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

           -- tcon
           if l_indtelenOCS='S' then
             l_textoActual := '<tcon>' || r_ordenCompra.val_tele || '</tcon>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
           else
             l_textoActual := '<tcon></tcon>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
           end if;

            -- Fin Cabecera
            l_textoActual := '</blqcon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            -- Fin orden compra simplificada
            l_textoActual := '</frmocs>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_ordenCompra;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_OCS: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_OCS;

/**************************************************************************
Descripcion         : Genera la orden compra simplificada
Fecha Creacion      : 04/10/2010
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_OCS_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_ordenCompra(oidPais NUMBER,
                        oidPeriodo NUMBER,
                        indicadorEnvioLarissa VARCHAR2,
                        numeroLoteFacturacion NUMBER) IS
select mc.cod_clie,
       mc.oid_clie,
       mc.cod_digi_ctrl,
       mc.val_ape1 || ' ' || mc.val_ape2 || ' ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       stv.des_abrv_tipo_via  || ' ' || mcd.val_nomb_via || ' ' || mcd.num_ppal || mcd.val_obse val_dir1,
       mcd.val_barr,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 4) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 3) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 2) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(con.pais_oid_pais, mc.oid_clie, 1)) val_dir2,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TF')  || '/' ||
       GEN_PKG_GENER.GEN_FN_CLIEN_TEXTO_COMUN(mc.oid_clie, 'TM')) val_tele,
       con.val_nume_soli,
       reg.cod_regi,
       zon.cod_zona,
       zse.cod_secc,
       ter.cod_terr
from mae_clien mc,
     mae_clien_direc mcd,
     seg_tipo_via stv,
     ped_solic_cabec con,
     ped_solic_cabec_secue sec,
     zon_regio reg,
     zon_zona zon,
     zon_terri_admin zta,
     zon_secci zse,
     zon_terri ter
where mc.oid_clie = mcd.clie_oid_clie
  and mcd.tivi_oid_tipo_via = stv.oid_tipo_via (+)
  and mcd.ind_elim = 0
  and mcd.ind_dire_ppal = 1
  and mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and con.zzon_oid_zona = p_oidzona
  and reg.oid_regi = zon.zorg_oid_regi
  and con.terr_oid_terr = ter.oid_terr
  and con.ztad_oid_terr_admi = zta.oid_terr_admi
  and zta.zscc_oid_secc = zse.oid_secc
  and con.pais_oid_pais = oidPais
  and con.perd_oid_peri = oidPeriodo
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and con.oid_soli_cabe = sec.soca_oid_soli_cabe
  and con.num_unid_aten_tota > 0
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  )
order by sec.num_secu_zona_ruta,
         sec.num_secu_fact_diar;

r_ordenCompra c_ordenCompra%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorDigitoCtrlOCS        VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorDigitoCtrlOCS');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_contadorDetalles              NUMBER := 0;

-- Variables usadas para la inclusion del telefono en la boleta de despacho
l_indicadorTelefono         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorTelefono');
l_textoTelefono             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoTelefono');

-- Variables usadas para la inclusion del tag de saludo por cumplea?os
l_indicadorCumpleanos       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorCumpleanos');
l_tagCumpleanosApertura     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosApertura');
l_tagCumpleanosCierre       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagCumpleanosCierre');
--NUEVO PARAMETRO
l_indicadorGenerarOCS       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarOCS');

l_indtelenOCS       VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'l_indtelenOCS'),'S');

l_indcopiaOCS       VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indcopiaOCS'),'N');

BEGIN


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;


    OPEN c_ordenCompra(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
    FETCH c_ordenCompra INTO r_ordenCompra;
    EXIT WHEN c_ordenCompra%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_OCS(
            COR_OCOS,
            COD_CLIE,
            VAL_NUME_SOLI,
            XML_CONS
            )
            VALUES (
            r_ordenCompra.val_nume_soli,
            r_ordenCompra.cod_clie,
            r_ordenCompra.val_nume_soli,
            EMPTY_CLOB())
            RETURNING XML_CONS INTO l_clob;

            -- Inicio de orden compra simplificada
            l_textoActual := '<frmocs>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio cabecera
            l_textoActual := '<blqcon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            if l_indcopiaOCS='S' then

              -- numero de ocs
              l_textoActual := '<barrio>' || r_ordenCompra.Val_Barr || '</barrio>';
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


              -- barrio
              l_textoActual := '<copias>' || imp_fn_devue_num_ocs(p_codigoPais,r_ordenCompra.Oid_Clie) || '</copias>';
              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            end if;

            -- codigo region
            l_textoActual := '<creg>' || r_ordenCompra.cod_regi || '</creg>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_ordenCompra.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Seccion
            l_textoActual := '<csec>' || r_ordenCompra.cod_secc || '</csec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            -- Territorio
            l_textoActual := '<cter>' || r_ordenCompra.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            IF(l_indicadorDigitoCtrlOCS = 'S' ) THEN
               l_textoActual := '<ccon>' || r_ordenCompra.cod_clie || r_ordenCompra.cod_digi_ctrl  ||'</ccon>';
               DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            ELSE
              l_textoActual := '<ccon>' || r_ordenCompra.cod_clie || '</ccon>';
               DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            END IF;

              -- Nombre Cliente
             l_textoActual := '<ncon>' || r_ordenCompra.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            -- Direccion 1
            l_textoActual := '<dir1>' || r_ordenCompra.val_dir1 || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
             l_textoActual := '<dir2>' || r_ordenCompra.val_dir2 || '</dir2>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

           -- tcon
           if l_indtelenOCS='S' then
             l_textoActual := '<tcon>' || r_ordenCompra.val_tele || '</tcon>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
           else
             l_textoActual := '<tcon></tcon>';
             DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
           end if;

            -- Fin Cabecera
            l_textoActual := '</blqcon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


            -- Fin orden compra simplificada
            l_textoActual := '</frmocs>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            --l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_ordenCompra;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_OCS_Z: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_OCS_Z;
/***************************************************************************
Descripcion       : Proceso que genera los cupones de las consultoras que
                    han pasado pedido en un periodo y fecha particular.
Fecha Creacion    : 31/03/2010
Autor             : Carlos Hurtado Ramirez
***************************************************************************/
PROCEDURE IMP_PR_GENER_PAQUE_DOCUM_CUPON(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2) IS

CURSOR c_cupon(oidPais NUMBER,
               oidPeriodo NUMBER,
               indicadorEnvioLarissa VARCHAR2,
               numeroLoteFacturacion NUMBER) IS
select mc.oid_clie,
       mc.cod_digi_ctrl,
       mc.cod_clie,
       mc.val_ape1 || ' ' || mc.val_ape2 || ', ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       stv.des_abrv_tipo_via  || ' ' || mcd.val_nomb_via || ' ' || mcd.num_ppal val_dir1,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 4) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 3) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 2) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 1)) val_dir2,
       zon.oid_zona,
       zon.cod_zona,
       ter.cod_terr
from mae_clien mc,
     mae_clien_direc mcd,
     seg_tipo_via stv,
     ped_solic_cabec con,
     zon_zona zon,
     zon_terri ter
where mc.oid_clie = mcd.clie_oid_clie
  and mcd.tivi_oid_tipo_via = stv.oid_tipo_via (+)
  and mcd.ind_elim = 0
  and mcd.ind_dire_ppal = 1
  and mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and con.terr_oid_terr = ter.oid_terr
  and con.perd_oid_peri = oidPeriodo
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.num_unid_aten_tota>0
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  );

r_cupon c_cupon%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidPeriodoSgte                NUMBER;
l_codPeriodoSgte                VARCHAR2(6);
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_oidActividad                  NUMBER;
l_fechaVencimiento              DATE;
l_codigoPeriodo                 VARCHAR2(25);
l_saldoCupon                    NUMBER(12,2) := 0.00;
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_codigoActividadVencimiento    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'codigoActividadVencimiento');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_digiver                       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'digiVer');

BEGIN

    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    -- Obtenemos el OID del periodo siguiente
    l_codPeriodoSgte := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);
    l_oidPeriodoSgte := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(l_codPeriodoSgte, l_oidMarca, l_oidCanal);

    -- Obtenemos el OID de la actividad
    SELECT ACT.OID_ACTI
    INTO l_oidActividad
    FROM CRA_ACTIV ACT
    WHERE ACT.PAIS_OID_PAIS = l_oidPais
    AND ACT.MARC_OID_MARC = l_oidMarca
    AND ACT.CANA_OID_CANA = l_oidCanal
    AND ACT.COD_ACTI = l_codigoActividadVencimiento; -- Cupon de Vencimiento

    -- Elimina todos las filas de la Tabla IMP_PAQUE_DOCUM_CUPON
    EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_CUPON';

    OPEN c_cupon(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
    FETCH c_cupon INTO r_cupon;
    EXIT WHEN c_cupon%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_CUPON
            VALUES (
            l_correlativo,
            EMPTY_CLOB(),
            r_cupon.cod_clie)
            RETURNING XML_CONS INTO l_clob;

            -- Obtenemos la fecha de vencimiento de la zona del cliente
            BEGIN
                SELECT CRO.FEC_INIC
                INTO l_fechaVencimiento
                FROM CRA_CRONO CRO
                WHERE CRO.ZZON_OID_ZONA = r_cupon.oid_zona
                AND CRO.PERD_OID_PERI = l_oidPeriodoSgte
                AND CRO.CACT_OID_ACTI = l_oidActividad;
            EXCEPTION
            WHEN NO_DATA_FOUND THEN
                l_fechaVencimiento := TRUNC(SYSDATE);
            END;

            -- Obtenemos el valor del saldo para el cliente
            --l_saldoCupon := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_VENCI(r_cupon.oid_clie, l_fechaVencimiento);
            l_saldoCupon := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_cupon.oid_clie,l_codPeriodoSgte);

            if l_saldoCupon<0 then
              l_saldoCupon:=0;
            end if;

/*
            -- Inicio Cupon
            l_textoActual := '<frmecc>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
*/
            -- Inicio cabecera
            l_textoActual := '<cab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_cupon.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Verificador
            if nvl(l_digiver,'N')='S' then
            l_textoActual := '<dver>' || r_cupon.cod_digi_ctrl || '</dver>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            end if;

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_cupon.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_cupon.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Periodo
            l_textoActual := '<fcam>' || l_codigoPeriodo || '</fcam>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_cupon.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 1
            l_textoActual := '<dir1>' || r_cupon.val_dir1 || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
            l_textoActual := '<dir2>' || r_cupon.val_dir2 || '</dir2>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha
            l_textoActual := '<fec>' || p_fechaFacturacion || '</fec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Cabecera
            l_textoActual := '</cab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio Bloque Cupon
            l_textoActual := '<blqcp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_cupon.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_cupon.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_cupon.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_cupon.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Saldo
            l_textoActual := '<saldo>' || l_saldoCupon || '</saldo>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha Facturacion
            l_textoActual := '<fec>' || p_fechaFacturacion || '</fec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha Vencimiento
            l_textoActual := '<fecven>' || to_char(l_fechaVencimiento, 'dd/mm/yyyy') || '</fecven>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Bloque Cupon
            l_textoActual := '</blqcp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

/*            -- Detalle Vacio
            l_textoActual := '<detalle><txt><t/><tr/><tr/><tr/></txt><txt><t/><tr/><tr/><tr/></txt></detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Cupon
            l_textoActual := '</frmecc>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
*/
            l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_cupon;

END;

/***************************************************************************
Descripcion       : Proceso que genera los cupones de las consultoras que
                    han pasado pedido en un periodo y fecha particular.
Fecha Creacion    : 31/03/2010
Autor             : Carlos Hurtado Ramirez
***************************************************************************/
PROCEDURE IMP_PR_GENER_PAQUE_DOCUM_CUP_Z(p_codigoPais VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_oidzona NUMBER,
                                         p_fechaFacturacion VARCHAR2) IS

CURSOR c_cupon(oidPais NUMBER,
               oidPeriodo NUMBER,
               indicadorEnvioLarissa VARCHAR2,
               numeroLoteFacturacion NUMBER) IS
select mc.oid_clie,
       mc.cod_digi_ctrl,
       mc.cod_clie,
       mc.val_ape1 || ' ' || mc.val_ape2 || ', ' || mc.val_nom1 || ' ' || mc.val_nom2 nom_clie,
       stv.des_abrv_tipo_via  || ' ' || mcd.val_nomb_via || ' ' || mcd.num_ppal val_dir1,
       trim('/' from
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 4) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 3) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 2) || '/' ||
       GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(oidPais, mc.oid_clie, 1)) val_dir2,
       zon.oid_zona,
       zon.cod_zona,
       ter.cod_terr,
       con.oid_soli_cabe,
       nvl(mc.val_recl_pend,0) val_recl_pend
from mae_clien mc,
     mae_clien_direc mcd,
     seg_tipo_via stv,
     ped_solic_cabec con,
     zon_zona zon,
     zon_terri ter
where mc.oid_clie = mcd.clie_oid_clie
  and mcd.tivi_oid_tipo_via = stv.oid_tipo_via (+)
  and mcd.ind_elim = 0
  and mcd.ind_dire_ppal = 1
  and mc.oid_clie = con.clie_oid_clie
  and con.zzon_oid_zona = zon.oid_zona
  and con.terr_oid_terr = ter.oid_terr
  and con.perd_oid_peri = oidPeriodo
  and zon.oid_zona=p_oidzona
  and con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
  and con.num_unid_aten_tota>0
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  and exists (
      select null
      from int_lar_tipo_solici_pedido_dis l
      where l.tspa_oid_tipo_soli_pais = con.tspa_oid_tipo_soli_pais
  );

r_cupon c_cupon%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidPeriodoSgte                NUMBER;
l_codPeriodoSgte                VARCHAR2(6);
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_oidActividad                  NUMBER;
l_fechaVencimiento              DATE;
l_codigoPeriodo                 VARCHAR2(25);
l_saldoCupon                    NUMBER(12,2) := 0.00;
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote    ');
l_codigoActividadVencimiento    VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'codigoActividadVencimiento');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';
l_digiver                       VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'digiVer');
l_redondeo                      VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'IndRedondeo'),'N');
l_recPend                       VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'IndRecPendCupon'),'N');


BEGIN

    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    -- Obtenemos el OID del periodo siguiente
    l_codPeriodoSgte := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);
    l_oidPeriodoSgte := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(l_codPeriodoSgte, l_oidMarca, l_oidCanal);

    -- Obtenemos el OID de la actividad
    SELECT ACT.OID_ACTI
    INTO l_oidActividad
    FROM CRA_ACTIV ACT
    WHERE ACT.PAIS_OID_PAIS = l_oidPais
    AND ACT.MARC_OID_MARC = l_oidMarca
    AND ACT.CANA_OID_CANA = l_oidCanal
    AND ACT.COD_ACTI = l_codigoActividadVencimiento; -- Cupon de Vencimiento

    -- Elimina todos las filas de la Tabla IMP_PAQUE_DOCUM_CUPON
    --EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_PAQUE_DOCUM_CUPON';

    OPEN c_cupon(l_oidPais, l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion);
    LOOP
    FETCH c_cupon INTO r_cupon;
    EXIT WHEN c_cupon%NOTFOUND;
        BEGIN

            INSERT INTO IMP_PAQUE_DOCUM_CUPON
            VALUES (
            r_cupon.oid_soli_cabe,
            EMPTY_CLOB(),
            r_cupon.cod_clie)
            RETURNING XML_CONS INTO l_clob;

            -- Obtenemos la fecha de vencimiento de la zona del cliente
            BEGIN
                SELECT CRO.FEC_INIC
                INTO l_fechaVencimiento
                FROM CRA_CRONO CRO
                WHERE CRO.ZZON_OID_ZONA = r_cupon.oid_zona
                AND CRO.PERD_OID_PERI = l_oidPeriodoSgte
                AND CRO.CACT_OID_ACTI = l_oidActividad;
            EXCEPTION
            WHEN NO_DATA_FOUND THEN
                l_fechaVencimiento := TRUNC(SYSDATE);
            END;

            -- Obtenemos el valor del saldo para el cliente
            --l_saldoCupon := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_VENCI(r_cupon.oid_clie, l_fechaVencimiento);
            l_saldoCupon := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_cupon.oid_clie,l_codPeriodoSgte);


            if l_saldoCupon<0 then
              l_saldoCupon:=0;
            end if;

            if l_redondeo='S' then
              l_saldoCupon:=round(l_saldoCupon/100,0)*100;
            end if;


            if l_recPend='S' then
              l_saldoCupon:=l_saldoCupon-r_cupon.val_recl_pend;
            end if;
            
            

/*
            -- Inicio Cupon
            l_textoActual := '<frmecc>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
*/
            -- Inicio cabecera
            l_textoActual := '<cab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_cupon.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Verificador
            if nvl(l_digiver,'N')='S' then
            l_textoActual := '<dver>' || r_cupon.cod_digi_ctrl || '</dver>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            end if;

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_cupon.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_cupon.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Periodo
            l_textoActual := '<fcam>' || l_codigoPeriodo || '</fcam>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_cupon.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 1
            l_textoActual := '<dir1>' || r_cupon.val_dir1 || '</dir1>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Direccion 2
            l_textoActual := '<dir2>' || r_cupon.val_dir2 || '</dir2>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha
            l_textoActual := '<fec>' || p_fechaFacturacion || '</fec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Cabecera
            l_textoActual := '</cab>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Inicio Bloque Cupon
            l_textoActual := '<blqcp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Codigo Cliente
            l_textoActual := '<ccon>' || r_cupon.cod_clie || '</ccon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Nombre Cliente
            l_textoActual := '<ncon>' || r_cupon.nom_clie || '</ncon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Zona
            l_textoActual := '<czon>' || r_cupon.cod_zona || '</czon>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Territorio
            l_textoActual := '<cter>' || r_cupon.cod_terr || '</cter>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Saldo
            l_textoActual := '<saldo>' || l_saldoCupon || '</saldo>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha Facturacion
            l_textoActual := '<fec>' || p_fechaFacturacion || '</fec>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fecha Vencimiento
            l_textoActual := '<fecven>' || to_char(l_fechaVencimiento, 'dd/mm/yyyy') || '</fecven>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Bloque Cupon
            l_textoActual := '</blqcp>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

/*            -- Detalle Vacio
            l_textoActual := '<detalle><txt><t/><tr/><tr/><tr/></txt><txt><t/><tr/><tr/><tr/></txt></detalle>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

            -- Fin Cupon
            l_textoActual := '</frmecc>';
            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
*/
            l_correlativo := l_correlativo + 1;

        END;
    END LOOP;
    CLOSE c_cupon;

END;


/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACTU(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);

    ln_desc_flete VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'descFlete'),'N');

    ln_tipo_fact VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tipoFactCR'),'1');

    l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');

CURSOR c_facturaCabecera IS
  SELECT x.VAL_NUME_SOLI,
             x.OID_CABE,
             x.NUM_DOCU_LEGA,
             x.COD_PAIS,
             x.DES_PAIS,
             x.FEC_EMIS,
             x.NUM_DOCU_CONT_INTE,
             x.OID_CLIE,
             x.COD_CLIE,
             x.COD_PERI,
             x.COD_REGI,
             x.COD_ZONA,
             x.COD_TERR,
             x.NOM_COMP,
             x.VAL_DIRE_COMP,
             x.VAL_NUME_IDEN_FISC,
             x.IMP_DESC_TOTA_LOCA,
             x.IMP_IMPU_TOTA_LOCA,
             x.IMP_FLET_TOTA_LOCA,
             x.VAL_TOTA_PAGA_LOCA,
             x.SUM_PCON_TOTA_LOCA,
             x.SUM_PNET_TOTA_FACT,
             x.SUM_SIMP_TOTA_FACT,
             x.SUM_NUM_UNID_ATEN,
             x.SUM_TOTA_LETR,
             x.VAL_TASA_IMPU,
             x.IND_TASA_IMPU,
             x.VAL_DESC,
            -- VAL_PROM,
             x.VAL_TOTA,
             x.VAL_IMPO_VENT,
             x.VAL_BASE_IMPO,
             NVL(x.COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(x.VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             x.COD_TIPO_DOCU,
             x.VAL_SERI_DOCU_LEGA,
             a.val_impo_desc_flet,
             (select sum(imp_impu_tota_loca) from fac_docum_conta_linea x where x.dcca_oid_cabe=a.oid_cabe) IMPU,
             a.val_tota_paga_loca TOTA
          FROM IMP_PAQUE_GENER_DOCUM_LASER x , fac_docum_conta_cabec a
          where x.oid_cabe=a.oid_cabe
          ORDER BY COD_CLIE, OID_CABE;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER, indicador VARCHAR) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT--,
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        and  (x.val_prec_cata_tota_loca>0 or indicador<>'S')
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX
     WHERE ROWNUM <= filaFin)
  WHERE ROWNUM >= filaInicio    ;

r_detalleFactura c_detalleFactura%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN

            --OBTENEMOS EL TOTAL DE PAGUNAS POR OID CABECERA
            SELECT COUNT(1)   into l_sizeDetalle
            FROM FAC_DOCUM_CONTA_LINEA X,
                 (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
                 PED_SOLIC_POSIC Z,
                 PRE_OFERT_DETAL P
           WHERE X.PROD_OID_PROD = Y.VAL_OID
            AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
            AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
            AND  NOT EXISTS (SELECT NULL
                             FROM FAC_TIPO_OFERT_EXCLU O
                             WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
            AND  X.DCCA_OID_CABE = r_facturaCabecera.OID_CABE
            AND  X.NUM_UNID_ATEN > 0;

          IF(l_sizeDetalle > 0) THEN
                    l_totalPaginas := ROUND(l_sizeDetalle/ TO_NUMBER(l_numFilas));

                    if(l_totalPaginas = 0) then
                        l_totalPaginas:=1;
                    end if;

                    l_filaInicio := 1;
                    l_filaFin := TO_NUMBER(l_numFilas);

                    FOR pag IN 1 .. l_totalPaginas LOOP

                            l_codClie:= r_facturaCabecera.COD_CLIE;
                            IF (l_codClie <> auxCodClie OR auxCodClie IS NULL) THEN

                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.COD_CLIE,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin,ln_desc_flete);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       /* l_textoActual := '<txt>SubTotal<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) Descuentos<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                      --  l_textoActual := '<txt>(+) Promociones<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROM,'999999999990.99'))||'</txt>';
                                       -- DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Monto Afecto '||r_facturaCabecera.IND_TASA_IMPU||'<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_BASE_IMPO,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) '||r_facturaCabecera.IND_TASA_IMPU ||' '||r_facturaCabecera.VAL_TASA_IMPU
                                                                    ||'%<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>(+) Flete <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        --l_textoActual := '<txt>(-) Promociones <t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROMO,'999999999990.99'))||'</txt>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*/
                                        if ln_tipo_fact='1' then
                                        
                                              l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt><t/>-------------</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                              ||'%<t/>'
                                                              ||TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
      
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              if ln_desc_flete='S' then
                                                   l_textoActual := '<txt>(-) CREDITO IVA FLETE <t/>'||TRIM(TO_CHAR(r_facturaCabecera.val_impo_desc_flet,'999999999990.99'))||'</txt>';
                                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                                    r_facturaCabecera.VAL_TOTA:=r_facturaCabecera.VAL_TOTA-nvl(r_facturaCabecera.val_impo_desc_flet,0);
                                              end if;
      
                                              l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              l_textoActual := '</pie>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<total>'|| r_facturaCabecera.SUM_TOTA_LETR ||'</total> ';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              
                                       else
                                              l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                              ||'%<t/>'
                                                              ||TRIM(TO_CHAR(r_facturaCabecera.IMPU,l_formatoNumerico))||'</txt>';
      
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt><t/>-------------</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT+r_facturaCabecera.IMPU,l_formatoNumerico)) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                              l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              if ln_desc_flete='S' then
                                                   l_textoActual := '<txt>(-) CREDITO IVA FLETE <t/>'||TRIM(TO_CHAR(r_facturaCabecera.val_impo_desc_flet,l_formatoNumerico))||'</txt>';
                                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                                    r_facturaCabecera.VAL_TOTA:=r_facturaCabecera.VAL_TOTA-nvl(r_facturaCabecera.val_impo_desc_flet,0);
                                              end if;
      
                                              l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.TOTA,l_formatoNumerico)) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              l_textoActual := '</pie>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<total>'|| UPPER(GEN_FN_NUME_TO_TEXT(TRUNC(ABS(r_facturaCabecera.TOTA)))) || ' y ' || TO_CHAR(ABS((r_facturaCabecera.TOTA - TRUNC(r_facturaCabecera.TOTA))) * 100) || '/100 COLONES' ||'</total> ';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              
                                              
                                       end if;
                                    END IF;

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            else
                                -- si se trata de la misma consultora
                                SELECT XML_LASE_FACT INTO l_clob
                                FROM  IMP_PAQUE_DOCUM_LASER_FACTU
                                WHERE   COD_CLIE= r_facturaCabecera.COD_CLIE FOR UPDATE;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin, ln_desc_flete);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/


                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       /* l_textoActual := '<txt>SubTotal<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) Descuentos<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                      --  l_textoActual := '<txt>(+) Promociones<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROM,'999999999990.99'))||'</txt>';
                                       -- DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Monto Afecto '||r_facturaCabecera.IND_TASA_IMPU||'<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_BASE_IMPO,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) '||r_facturaCabecera.IND_TASA_IMPU ||' '||r_facturaCabecera.VAL_TASA_IMPU
                                                                    ||'%<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>(+) Flete <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        --l_textoActual := '<txt>(-) Promociones <t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROMO,'999999999990.99'))||'</txt>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*/

                                        if ln_tipo_fact='1' then
                                        
                                              l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt><t/>-------------</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                              ||'%<t/>'
                                                              ||TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
      
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              if ln_desc_flete='S' then
                                                   l_textoActual := '<txt>(-) CREDITO IVA FLETE <t/>'||TRIM(TO_CHAR(r_facturaCabecera.val_impo_desc_flet,'999999999990.99'))||'</txt>';
                                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                                    r_facturaCabecera.VAL_TOTA:=r_facturaCabecera.VAL_TOTA-nvl(r_facturaCabecera.val_impo_desc_flet,0);
                                              end if;
      
                                              l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              l_textoActual := '</pie>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<total>'|| r_facturaCabecera.SUM_TOTA_LETR ||'</total> ';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        else
                                              l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                              ||'%<t/>'
                                                              ||TRIM(TO_CHAR(r_facturaCabecera.IMPU,l_formatoNumerico))||'</txt>';
      
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt><t/>-------------</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT+r_facturaCabecera.IMPU,l_formatoNumerico)) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                              l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,l_formatoNumerico))||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              if ln_desc_flete='S' then
                                                   l_textoActual := '<txt>(-) CREDITO IVA FLETE <t/>'||TRIM(TO_CHAR(r_facturaCabecera.val_impo_desc_flet,l_formatoNumerico))||'</txt>';
                                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                                    r_facturaCabecera.VAL_TOTA:=r_facturaCabecera.VAL_TOTA-nvl(r_facturaCabecera.val_impo_desc_flet,0);
                                              end if;
      
                                              l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.TOTA,l_formatoNumerico)) ||'</txt>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      
                                              l_textoActual := '</pie>';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                              l_textoActual := '<total>'|| UPPER(GEN_FN_NUME_TO_TEXT(TRUNC(ABS(r_facturaCabecera.TOTA)))) || ' y ' || TO_CHAR(ABS((r_facturaCabecera.TOTA - TRUNC(r_facturaCabecera.TOTA))) * 100) || '/100 COLONES'  ||'</total> ';
                                              DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        
                                        end if;
                                    END IF;

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            end if;

                            auxCodClie:= l_codClie;
                            l_filaInicio := l_filaInicio + TO_NUMBER(l_numFilas);
                            l_filaFin :=  l_filaFin +TO_NUMBER(l_numFilas);

                   END LOOP;
           END IF;
        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACTU: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACTU;

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FAC_P(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             IMP_PAQUE_GENER_DOCUM_LASER.OID_CABE,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_LEGA,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_PAIS,
             IMP_PAQUE_GENER_DOCUM_LASER.DES_PAIS,
             IMP_PAQUE_GENER_DOCUM_LASER.FEC_EMIS,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_CONT_INTE,
             IMP_PAQUE_GENER_DOCUM_LASER.OID_CLIE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_CLIE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_PERI,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_REGI,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_ZONA,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_TERR,
             IMP_PAQUE_GENER_DOCUM_LASER.NOM_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_DIRE_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_IDEN_FISC,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_DESC_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_IMPU_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_FLET_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TOTA_PAGA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_PCON_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_PNET_TOTA_FACT,
             fac_docum_conta_cabec.val_prec_cata_tota_loca+fac_docum_conta_cabec.val_prec_cont_tota_loca SUM_SIMP_TOTA_FACT,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_NUM_UNID_ATEN,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_TOTA_LETR,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TASA_IMPU,
             IMP_PAQUE_GENER_DOCUM_LASER.IND_TASA_IMPU,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_DESC,
            -- VAL_PROM,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TOTA,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_IMPO_VENT,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_BASE_IMPO,
             NVL(IMP_PAQUE_GENER_DOCUM_LASER.COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_TIPO_DOCU,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_SERI_DOCU_LEGA

          FROM IMP_PAQUE_GENER_DOCUM_LASER, fac_docum_conta_cabec
          where IMP_PAQUE_GENER_DOCUM_LASER.oid_cabe=fac_docum_conta_cabec.oid_cabe
          ORDER BY COD_CLIE, OID_CABE;





r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT--,
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX
     WHERE ROWNUM <= filaFin)
  WHERE ROWNUM >= filaInicio    ;

r_detalleFactura c_detalleFactura%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    --limpiamos temporal de factura
    EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_FACTU');
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN

            --OBTENEMOS EL TOTAL DE PAGUNAS POR OID CABECERA
            SELECT COUNT(1)   into l_sizeDetalle
            FROM FAC_DOCUM_CONTA_LINEA X,
                 (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
                 PED_SOLIC_POSIC Z,
                 PRE_OFERT_DETAL P
           WHERE X.PROD_OID_PROD = Y.VAL_OID
            AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
            AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
            AND  NOT EXISTS (SELECT NULL
                             FROM FAC_TIPO_OFERT_EXCLU O
                             WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
            AND  X.DCCA_OID_CABE = r_facturaCabecera.OID_CABE
            AND  X.NUM_UNID_ATEN > 0;

          IF(l_sizeDetalle > 0) THEN
                    l_totalPaginas := ROUND(l_sizeDetalle/ TO_NUMBER(l_numFilas));

                    if(l_totalPaginas = 0) then
                        l_totalPaginas:=1;
                    end if;

                    l_filaInicio := 1;
                    l_filaFin := TO_NUMBER(l_numFilas);

                    FOR pag IN 1 .. l_totalPaginas LOOP

                            l_codClie:= r_facturaCabecera.COD_CLIE;
                            IF (l_codClie <> auxCodClie OR auxCodClie IS NULL) THEN

                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.COD_CLIE,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.Val_Prec_Cata_Unit_Loca+r_detalleFactura.Val_Prec_Cont_Unit_Loca,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.Val_Prec_Cata_Tota_Loca+r_detalleFactura.Val_Prec_Cont_Tota_Loca,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       /* l_textoActual := '<txt>SubTotal<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) Descuentos<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                      --  l_textoActual := '<txt>(+) Promociones<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROM,'999999999990.99'))||'</txt>';
                                       -- DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Monto Afecto '||r_facturaCabecera.IND_TASA_IMPU||'<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_BASE_IMPO,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) '||r_facturaCabecera.IND_TASA_IMPU ||' '||r_facturaCabecera.VAL_TASA_IMPU
                                                                    ||'%<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>(+) Flete <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        --l_textoActual := '<txt>(-) Promociones <t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROMO,'999999999990.99'))||'</txt>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*/

                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.Imp_Desc_Tota_Loca,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT-r_facturaCabecera.Imp_Desc_Tota_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_facturaCabecera.Imp_Impu_Tota_Loca,'999999999990.99'))||'</txt>';

                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.Val_Tota_Paga_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_facturaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            else
                                -- si se trata de la misma consultora
                                SELECT XML_LASE_FACT INTO l_clob
                                FROM  IMP_PAQUE_DOCUM_LASER_FACTU
                                WHERE   COD_CLIE= r_facturaCabecera.COD_CLIE FOR UPDATE;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.Val_Prec_Cata_Unit_Loca+r_detalleFactura.Val_Prec_Cont_Unit_Loca,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.Val_Prec_Cata_Tota_Loca+r_detalleFactura.Val_Prec_Cont_Tota_Loca,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/


                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       /* l_textoActual := '<txt>SubTotal<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) Descuentos<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                      --  l_textoActual := '<txt>(+) Promociones<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROM,'999999999990.99'))||'</txt>';
                                       -- DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Monto Afecto '||r_facturaCabecera.IND_TASA_IMPU||'<t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_BASE_IMPO,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) '||r_facturaCabecera.IND_TASA_IMPU ||' '||r_facturaCabecera.VAL_TASA_IMPU
                                                                    ||'%<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>(+) Flete <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        --l_textoActual := '<txt>(-) Promociones <t/>'||TRIM(TO_CHAR(r_facturaCabecera.VAL_PROMO,'999999999990.99'))||'</txt>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*/


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_facturaCabecera.Imp_Desc_Tota_Loca,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL FACTURA<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.SUM_SIMP_TOTA_FACT-r_facturaCabecera.Imp_Desc_Tota_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_facturaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_facturaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';

                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>Total Factura<t/>'|| TRIM(TO_CHAR(r_facturaCabecera.Val_Tota_Paga_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_facturaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            end if;

                            auxCodClie:= l_codClie;
                            l_filaInicio := l_filaInicio + TO_NUMBER(l_numFilas);
                            l_filaFin :=  l_filaFin +TO_NUMBER(l_numFilas);

                   END LOOP;
           END IF;
        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FAC_P: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FAC_P;
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FAC_V(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             IMP_PAQUE_GENER_DOCUM_LASER.OID_CABE,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_LEGA,
             COD_PAIS,
             DES_PAIS,
             IMP_PAQUE_GENER_DOCUM_LASER.FEC_EMIS,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             NOM_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_DIRE_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_IDEN_FISC,
             --IMP_PAQUE_GENER_DOCUM_LASER.IMP_DESC_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_IMPU_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_FLET_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TOTA_PAGA_LOCA,
             SUM_PCON_TOTA_LOCA,
             SUM_PNET_TOTA_FACT,
             SUM_SIMP_TOTA_FACT,
             SUM_NUM_UNID_ATEN,
             SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             IND_TASA_IMPU,
             VAL_DESC,
            -- VAL_PROM,
             VAL_TOTA,
             VAL_IMPO_VENT,
             VAL_BASE_IMPO,
             NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             COD_TIPO_DOCU,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_SERI_DOCU_LEGA,
             FAC_DOCUM_CONTA_CABEC.val_prec_cata_tota_loca+FAC_DOCUM_CONTA_CABEC.val_prec_cont_tota_loca TOTPROD,
             FAC_DOCUM_CONTA_CABEC.IMP_DESC_TOTA_LOCA-(FAC_DOCUM_CONTA_CABEC.VAL_TOTA_PAGA_LOCA-((FAC_DOCUM_CONTA_CABEC.val_prec_cata_tota_loca+FAC_DOCUM_CONTA_CABEC.val_prec_cont_tota_loca)-FAC_DOCUM_CONTA_CABEC.IMP_DESC_TOTA_LOCA+FAC_DOCUM_CONTA_CABEC.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA
          FROM IMP_PAQUE_GENER_DOCUM_LASER, FAC_DOCUM_CONTA_CABEC
          WHERE IMP_PAQUE_GENER_DOCUM_LASER.OID_CABE=FAC_DOCUM_CONTA_CABEC.Oid_Cabe
          and FAC_DOCUM_CONTA_CABEC.Num_Unid_Aten_Tota>0
          ORDER BY COD_CLIE, OID_CABE;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             Z.Val_Codi_Vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX)
     --WHERE ROWNUM <= filaFin)
  --WHERE ROWNUM >= filaInicio
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;


CURSOR c_detalleFactura1(oidConsolidado NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             neg.cod_nego COD,
             gen.VAL_I18N DES_PROD,
             sum(X.NUM_UNID_ATEN) NUM_UNID_ATEN,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_CATA_UNIT_FACT,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_SIN_IMPU_TOTA_FACT,
             sum(decode(nvl(x.imp_desc_sin_impu_tota_loca,0),0,x.val_prec_cont_tota_loca,nvl(x.imp_desc_sin_impu_tota_loca,0))) IMP_DESC_TOTA_FACT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P,
             mae_produ mp,
             mae_negoc neg,
             gen_i18n_sicc_pais gen
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and x.prod_oid_prod=mp.oid_prod
        and mp.nego_oid_nego=neg.oid_nego(+)
        and neg.oid_nego=gen.val_oid and gen.attr_enti='MAE_NEGOC'
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       group by x.dcca_oid_cabe,neg.cod_nego, gen.val_i18n
  ;



r_detalleFactura1 c_detalleFactura1%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    --limpiamos temporal de factura
    EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_FACTU');
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.oid_cabe,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_facturaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_facturaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_facturaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if l_modelo='1' then

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.VAL_CODI_VENT || '     ' || r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99')) || '(D-' || r_detalleFactura.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;

                                else

                                OPEN c_detalleFactura1( r_facturaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleFactura1 INTO r_detalleFactura1;
                                EXIT WHEN c_detalleFactura1%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura1.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura1.COD || '     ' || r_detalleFactura1.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura1.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura1.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99')) || '(D-' || TRIM(TO_CHAR(r_detalleFactura1.IMP_DESC_TOTA_FACT,'999999999990.99')) || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura1;

                                end if;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS
/*
                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;
*/
                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(r_facturaCabecera.Totprod,'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_DESC_TOTA_LOCA,'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA_PAGA_LOCA,'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_IMPU_TOTA_LOCA,'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FAC_V: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FAC_V;

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACV2(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             --a.OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             b.VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             a.VAL_SERI_DOCU_LEGA,
             (select cod_alma from bel_almac where oid_alma=b.almc_oid_alma) almacen
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.Num_Unid_Aten_Tota>0
          and a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=1
          and b.oid_soli_cabe=p_oidsoli;
          --ORDER BY COD_CLIE, OID_CABE;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             Z.Val_Codi_Vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX)
     --WHERE ROWNUM <= filaFin)
  --WHERE ROWNUM >= filaInicio
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;

CURSOR c_detalleFactura1(oidConsolidado NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             neg.cod_nego COD,
             gen.VAL_I18N DES_PROD,
             sum(X.NUM_UNID_ATEN) NUM_UNID_ATEN,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_CATA_UNIT_FACT,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_SIN_IMPU_TOTA_FACT,
             sum(decode(nvl(x.imp_desc_sin_impu_tota_loca,0),0,x.val_prec_cont_tota_loca,nvl(x.imp_desc_sin_impu_tota_loca,0))) IMP_DESC_TOTA_FACT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P,
             mae_produ mp,
             mae_negoc neg,
             gen_i18n_sicc_pais gen
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and x.prod_oid_prod=mp.oid_prod
        and mp.nego_oid_nego=neg.oid_nego(+)
        and neg.oid_nego=gen.val_oid and gen.attr_enti='MAE_NEGOC'
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       group by x.dcca_oid_cabe, neg.cod_nego, gen.val_i18n
  ;



r_detalleFactura1 c_detalleFactura1%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_FACTU');
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.oid_cabe,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_facturaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_facturaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_facturaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<almacen>' || r_facturaCabecera.almacen ||'</almacen>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if l_modelo='1' then

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.VAL_CODI_VENT || '     ' || r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99')) || '(D-' || r_detalleFactura.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;

                                else
                                OPEN c_detalleFactura1( r_facturaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleFactura1 INTO r_detalleFactura1;
                                EXIT WHEN c_detalleFactura1%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura1.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura1.COD || '     ' || r_detalleFactura1.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura1.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura1.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99')) || '(D-' || TRIM(TO_CHAR(r_detalleFactura1.IMP_DESC_TOTA_FACT,'999999999990.99')) || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura1;

                                end if;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS
/*
                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;
*/
                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(r_facturaCabecera.TOTPROD,'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_DESC_TOTA_LOCA,'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA_PAGA_LOCA,'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_IMPU_TOTA_LOCA,'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACV2: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACV2;
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACBO(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             --a.OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_ape1 || ' ' || f.val_ape2 || ' ' || f.val_nom1 || ' ' || f.val_nom2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_NNAL,
             a.VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_tota_gast_admi, 
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             b.VAL_TASA_IMPU,
             a.VAL_SERI_DOCU_LEGA,
             a.val_nume_auto,
             a.val_llav
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.Num_Unid_Aten_Tota>0
          and a.val_tota_paga_loca>0
          and a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=1
          and b.oid_soli_cabe=p_oidsoli;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             NVL(X.IMP_DESC_TOTA_LOCA,0) IMP_DESC_TOTA_LOCA,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             lpad(decode(Z.Val_Codi_Vent, null, z.val_codi_vent_fict, z.Val_Codi_Vent),5,'0') Val_Codi_Vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;



-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   varchar2(32600) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_control               VARCHAR2(50);

l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');

BEGIN
    auxCodClie:=NULL;

    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.oid_cabe,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;

                                l_control:=fac_pkg_gener.FAC_FN_GENER_CODIG_CTROL(r_facturaCabecera.val_tota_paga_loca, r_facturaCabecera.val_nume_auto, r_facturaCabecera.num_docu_cont_inte, trim(TRANSLATE (nvl(r_facturaCabecera.VAL_NUME_IDEN_FISC,r_facturaCabecera.VAL_NUME_IDEN_NNAL), 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',' ')), to_char(r_facturaCabecera.fec_fact,'dd/mm/yyyy'), r_facturaCabecera.val_llav);
                                
                                update fac_docum_conta_cabec a set a.val_nume_cont=l_control
                                where a.oid_cabe=r_facturaCabecera.oid_cabe;

                                update fac_regis_unico_venta a set a.val_nume_cont=l_control
                                where a.dcca_oid_cabe=r_facturaCabecera.oid_cabe;

                                -- Inicio del paquete
                                l_textoActual := '<FacturaQR>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '<Documento>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := l_textoActual || '<Encabezado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque Consultora
                                l_textoActual := l_textoActual || '<EConsultora>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NombreConsultora>' || r_facturaCabecera.NOM_COMP ||'</NombreConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoConsultora>' || r_facturaCabecera.COD_CLIE || '</CodigoConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<DocumentoConsultora>' || trim(TRANSLATE (nvl(r_facturaCabecera.VAL_NUME_IDEN_FISC,r_facturaCabecera.VAL_NUME_IDEN_NNAL), 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',' ')) ||'</DocumentoConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Consultora
                                l_textoActual := l_textoActual || '</EConsultora>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque Factura
                                l_textoActual := l_textoActual || '<IdFactura>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroFactura>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</NumeroFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<FechaDeFactura>'|| to_char(r_facturaCabecera.fec_fact,'yyyymmdd') || '</FechaDeFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroPedido>'|| r_facturaCabecera.VAL_NUME_SOLI  ||'</NumeroPedido>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CampanaProceso>' || r_facturaCabecera.COD_PERI ||'</CampanaProceso>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoControl>'|| l_control  ||'</CodigoControl>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Factura
                                l_textoActual := l_textoActual || '</IdFactura>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque Totales
                                l_textoActual := l_textoActual || '<TotalFac>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := l_textoActual || '<TotalMontoFlete>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,l_formatoNumerico)) || '</TotalMontoFlete>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoInteres>' || TRIM(TO_CHAR(r_facturaCabecera.val_tota_gast_admi,l_formatoNumerico)) || '</TotalMontoInteres>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoFactura>' || TRIM(TO_CHAR(r_facturaCabecera.val_tota_paga_loca,l_formatoNumerico)) || '</TotalMontoFactura>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoFacturaLetras>' || UPPER(GEN_FN_NUME_TO_TEXT(TRUNC(r_facturaCabecera.VAL_TOTA_PAGA_LOCA))) || ' ' || TO_CHAR((r_facturaCabecera.VAL_TOTA_PAGA_LOCA - TRUNC(r_facturaCabecera.VAL_TOTA_PAGA_LOCA)) * 100)  || '/100 BOLIVIANOS' || '</TotalMontoFacturaLetras>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Totales
                                l_textoActual := l_textoActual || '</TotalFac>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                                l_textoActual := l_textoActual || '</Encabezado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := l_textoActual || '<Detalles>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                l_textoActual := '<LinDetalle>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroLin>' || r_detalleFactura.NUM_LINEA || '</NumeroLin>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoCUV>' || r_detalleFactura.Val_Codi_Vent || '</CodigoCUV>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<UnidadesAtendidas>' || r_detalleFactura.NUM_UNID_ATEN || '</UnidadesAtendidas>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<DescripcionProd>' || r_detalleFactura.DES_PROD || '</DescripcionProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoCatalogoProd>' || case when r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA=0 then '+' else TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA,l_formatoNumerico)) end || '</MontoCatalogoProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoTotalProd>' || case when r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA=0 then NULL else TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_TOTA_LOCA,l_formatoNumerico)) end || '</MontoTotalProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoPorcentDcto>' || case when r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA=0 then NULL else r_detalleFactura.VAL_PORC_DESC end || '</MontoPorcentDcto>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoNetoProd>' || case when r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA=0 then NULL else TRIM(TO_CHAR((r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA*r_detalleFactura.NUM_UNID_ATEN) - r_detalleFactura.IMP_DESC_TOTA_LOCA,l_formatoNumerico)) end || '</MontoNetoProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '</LinDetalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;


                                -- Fin de detalle Factura
                                l_textoActual := '</Detalles>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --

                                 --FIN FACTURA
                                l_textoActual := l_textoActual || '</Documento>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '</FacturaQR>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                
                                commit;

        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACBO: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACBO;
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACDL(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             --a.OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             b.VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             a.VAL_SERI_DOCU_LEGA
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.Num_Unid_Aten_Tota>0
          and a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=1
          and b.oid_soli_cabe=p_oidsoli;
          --ORDER BY COD_CLIE, OID_CABE;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA+X.VAL_PREC_CONT_UNIT_LOCA VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA+X.VAL_PREC_CONT_TOTA_LOCA VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             nvl(Z.Val_Codi_Vent, z.val_codi_vent_fict) Val_Codi_Vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER(+)
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX)
     --WHERE ROWNUM <= filaFin)
  --WHERE ROWNUM >= filaInicio
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_FACTU');
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.cod_clie,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_facturaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_facturaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_facturaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<item>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                   l_textoActual := '<CUV>' || r_detalleFactura.VAL_CODI_VENT || '</CUV> ';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                   l_textoActual := '<DES_PROD>' || r_detalleFactura.DES_PROD || '</DES_PROD>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                   l_textoActual := '<UNID_ATEN>' || r_detalleFactura.NUM_UNID_ATEN || '</UNID_ATEN>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                   l_textoActual := '<PREC_UNIT>' || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_LOCA,'999999999990.99')) || '</PREC_UNIT>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                   l_textoActual := '<PREC_TOTA>' || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_TOTA_LOCA,'999999999990.99')) || '</PREC_TOTA>';
                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/
                                   l_textoActual :=  '</item>';

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;


                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS
/*
                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;
*/
                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(r_facturaCabecera.TOTPROD,'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_DESC_TOTA_LOCA,'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA_PAGA_LOCA,'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_IMPU_TOTA_LOCA,'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<letras>' || GEN_FN_NUME_TO_TEXT(TRUNC(r_facturaCabecera.VAL_TOTA_PAGA_LOCA)) || ' y ' || TO_CHAR((r_facturaCabecera.VAL_TOTA_PAGA_LOCA - TRUNC(r_facturaCabecera.VAL_TOTA_PAGA_LOCA)) * 100)  || '/100 RD$' || '</letras>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACDL: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACDL;

/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACP2(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
select
cab.oid_cabe,
'<factura>' ||
'<blqcab>' ||
'<tipo>'|| ftd.des_tipo_docu || '</tipo>' ||
'<RAZSOC>'  ||trim( rpad('CETCO S.A.',100,' ')) || '</RAZSOC>' ||
'<OFPRDI>' || trim (rpad('AV. CANAVAL Y MOREYRA 522 1401',50,' ')) || '</OFPRDI>' ||
'<OFPRUDP>' || trim(rpad('URB. EL PALOMAR - SAN ISIDRO, LIMA',50,' ')) || '</OFPRUDP>' ||
'<OFPRTL>' || trim(rpad('TELF.: 211 3400',50,' ')) || '</OFPRTL>' ||
'<PTEMDI>' || trim(rpad('AV. SAN GENARO 150',50,' ')) || '</PTEMDI>' ||
'<PTEMUDP>' || trim (rpad('URB. MOLITALIA - LOS OLIVOS, LIMA',50,' ')) || '</PTEMUDP>' ||
 '<RUCEMP>' || trim(rpad('20100123763',11,' ')) || '</RUCEMP>' ||
'<NUDOLE>' || trim( rpad('B'||cab.val_seri_docu_lega||'-'||cab.num_docu_cont_inte,13,' ')) || '</NUDOLE>' ||
 '<BOLDES>' || trim(rpad(con.val_nume_soli,30,' ')) || '</BOLDES>' ||
 '<CAMPAN>' || trim( rpad(spc.cod_peri,50,' ')) || '</CAMPAN>' ||
'<FECEMI>' || to_char(CON.FEC_FACT,'yyyy-mm-dd')  || '</FECEMI>' ||
'<ZONTER>' || trim(rpad(ZON.COD_ZONA || '-' || TER.COD_TERR,50,' ') ) || '</ZONTER>'  ||
'<CODCLI>' || trim ( rpad(mc.cod_clie,50,' ')) || '</CODCLI>' ||
'<NOMCLI>'  || trim ( rpad(cab.val_ape1||' '||cab.val_ape2||' '||cab.val_nom1||' '||cab.val_nom2,100,' ')) || '</NOMCLI>' ||
'<NUIDCL>' || trim( rpad(cab.val_nume_iden_fisc,15,' ')) || '</NUIDCL>' ||
'<DIRCLI>' || trim(  rpad(cab.val_dire_comp,100,' ')) || '</DIRCLI>' ||
'<UBIGEO>'||trim(rpad(           GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(cab.pais_OID_PAIS, mc.OID_CLIE, 4) || '/' ||
           GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(cab.pais_OID_PAIS, mc.OID_CLIE, 3) || '/' ||
           GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(cab.pais_OID_PAIS, mc.OID_CLIE, 2) || '/' ||
           GEN_PKG_GENER.GEN_FN_DESCR_ESTRU_GEOPO(cab.pais_OID_PAIS, mc.OID_CLIE, 1)
,240,' ')) ||'</UBIGEO>' ||
'<NOTA_1>' || TRIM(rpad(decode(ictp.cod_tipo_prog,NULL,'NOTA: OPERACION SUJETA A PERCEPCION DEL IGV','NOTA: TRANSFERENCIA GRATUITA'),50,' ')) ||'</NOTA_1>' ||
'<NOTA_2>' || TRIM(rpad(decode(ictp.cod_tipo_prog,NULL,'','NOTA: BONIF X HABER ALCANZ. VOL. DE COMP'),50,' ')) || '</NOTA_2>' ||
'</blqcab>' ||
'<cuerpo>' as cabecera_f,

'</cuerpo>' ||
'<pie>' ||
'<TOTPRO>'  || trim (rpad((SELECT SUM(SP.NUM_UNID_ATEN) FROM FAC_DOCUM_CONTA_LINEA SP WHERE SP.DCCA_OID_CABE = CAB.OID_CABE AND SP.IND_NO_IMPR = '0'),50,' ')) || '</TOTPRO>' ||
'<TOOPGR>'   || trim( rpad(ltrim(TO_CHAR(cab.val_prec_cont_tota_loca, '9999999990.00')),50,' ')) || '</TOOPGR>' ||
'<OPEGRA>'  || trim(rpad(ltrim(TO_CHAR(nvl(cab.VAL_PREC_NETO_TOTA_LOCA,0)+nvl(cab.VAL_TOTA_GAST_ADMI_SIN_IMPU,0), '9999999990.00')),15,' ')) || '</OPEGRA>' ||
'<SUMIGV>'  || trim( rpad(ltrim(TO_CHAR(cab.imp_impu_tota_loca, '9999999990.00')),15,' ')) || '</SUMIGV>' ||
'<IMTOVE>'  || trim( rpad(ltrim(TO_CHAR(cab.val_tota_paga_loca, '9999999990.00')),15,' ')) || '</IMTOVE>' ||
'<LEYE_1>'   || trim (rpad(GEN_FN_NUME_TO_TEXT(cab.val_tota_paga_loca) || ' y ' || TO_CHAR((cab.val_tota_paga_loca - TRUNC(cab.val_tota_paga_loca)) * 100)  || '/100 NUEVOS SOLES',100,' ')) || '</LEYE_1>' ||
'<TOTCAT>'  || trim (rpad(ltrim(TO_CHAR(cab.val_tota_paga_loca-cab.imp_flet_tota_loca+cab.imp_desc_tota_loca- nvl(cab.val_tota_gast_admi,0), '9999999990.00')),50,' ')) || '</TOTCAT>' ||
'<DESCUE>' || trim( rpad(ltrim(TO_CHAR(cab.imp_desc_tota_loca-cab.val_prec_cont_tota_loca, '9999999990.00')),50,' ') ) || '</DESCUE>' ||
'<BONIFI>' ||  trim(rpad(ltrim(TO_CHAR(cab.val_prec_cont_tota_loca, '9999999990.00')),50,' ')) || '</BONIFI>' ||
'<BAIMPE>' || trim(rpad(ltrim(TO_CHAR(cab.val_tota_paga_loca-cab.imp_flet_tota_loca - nvl(cab.val_tota_gast_admi,0), '9999999990.00')),50,' ')) || '</BAIMPE>'  ||
'<PERCEP>'   || trim( rpad(ltrim(to_char(round((cab.val_tota_paga_loca - cab.imp_flet_tota_loca) * 0.02,2),'9999999990.00')),15,' '))|| '</PERCEP>' ||
'<TOTPAG>' ||  trim(rpad(ltrim(to_char(round(cab.val_tota_paga_loca + ((cab.val_tota_paga_loca - cab.imp_flet_tota_loca) * 0.02),2), '9999999990.00')) ,15, ' ' ) )|| '</TOTPAG>' ||
'<OBSE_1>'  || trim(rpad('Representacion impresa de la boleta de venta electronica',100,' ')) || '</OBSE_1>' ||
'<OBSE_2>' || trim(rpad('Autorizado mediante Resolucion N? xxxxxxxxx',100,' ')) || '</OBSE_2>' ||
'</pie>' ||
'</factura>' as cuerpo_f
  FROM FAC_DOCUM_CONTA_CABEC CAB,
       FAC_TIPO_DOCUM        FTD,
       MAE_CLIEN             MC,
       PED_SOLIC_CABEC       CON,
       PED_TASA_IMPUE        PTI,
       ZON_REGIO             REG,
       ZON_ZONA              ZON,
       ZON_SECCI             SEC,
       ZON_TERRI             TER,
       SEG_PAIS              SP,
       CRA_PERIO             CP,
       SEG_PERIO_CORPO       SPC,
       INC_CONCU_TIPO_PROG    ICTP
 WHERE SP.OID_PAIS = MC.PAIS_OID_PAIS
   AND MC.OID_CLIE = CON.CLIE_OID_CLIE
   AND CON.OID_SOLI_CABE = CAB.SOCA_OID_SOLI_CABE
   and cab.ictp_oid_tipo_prog=ictp.oid_tipo_prog(+)
   AND CON.TAIM_OID_TASA_IMPU = PTI.OID_TASA_IMPU
   AND CAB.TIDO_OID_TIPO_DOCU = FTD.OID_TIPO_DOCU
   AND CAB.ZORG_OID_REGI = REG.OID_REGI
   AND CAB.ZZON_OID_ZONA = ZON.OID_ZONA
   AND CAB.ZSCC_OID_SECC = SEC.OID_SECC
   AND CAB.TERR_OID_TERR = TER.OID_TERR
   AND CP.PERI_OID_PERI = SPC.OID_PERI
   and con.perd_oid_peri=cp.oid_peri
   and con.oid_soli_cabe=p_oidsoli
   AND EXISTS
       (SELECT NULL
          FROM FAC_DOCUM_CONTA_LINEA DET,
               PED_SOLIC_POSIC       PSP,
               PRE_OFERT_DETAL       POD
         WHERE DET.SOPO_OID_SOLI_POSI = PSP.OID_SOLI_POSI
           AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER(+)
           AND DET.NUM_UNID_ATEN > 0
           AND DET.DCCA_OID_CABE = CAB.OID_CABE
           AND NOT EXISTS
         (SELECT NULL
                  FROM FAC_TIPO_OFERT_EXCLU TOE
                 WHERE TOE.TOFE_OID_TIPO_OFER = POD.TOFE_OID_TIPO_OFER));

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidCabe NUMBER) IS
select
'<detalle>' ||
'<CODSAP>' || MP.COD_SAP || '</CODSAP>' ||
'<UNIMED>NIU</UNIMED>' ||
'<CANTID>' || dcl.num_unid_aten || '</CANTID>' ||
'<DESCRI>' || trim(rpad(TRIM((SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = dcl.PROD_OID_PROD)),250,' ')) || '</DESCRI>' ||
'<CODVEN>' || trim(rpad(SUBSTR(SPC.COD_PERI, -2, 2) || nvl(sp.VAL_CODI_VENT,sp.val_codi_vent_fict) || DECODE(SP.VAL_PREC_CATA_UNIT_LOCA, 0, '0', '8'),30,' '))
|| decode(ICTP.Cod_Tipo_Prog,'B',' Bonificacion(es) otorgada(s) por haber alcanzado el volumen de compra requerido en el periodo. C' || SUBSTR(spc1.cod_peri, 5, 2) || '/' || SUBSTR(spc1.cod_peri, 1, 4) || ' al C' || SUBSTR(spc2.cod_peri, 5, 2) || '/' || SUBSTR(spc2.cod_peri, 1, 4) || ' del programa ' || cpg.num_conc,NULL)
|| '</CODVEN>' ||
'<PRVEUN>' || trim(rpad(ltrim(to_char(decode(dcl.val_prec_cata_unit_loca, 0, 0,dcl.val_prec_cata_unit_loca), '9999999990.00')),15,' ')) || '</PRVEUN>'||
'<PRCAUN>' || trim( rpad(ltrim(to_char(decode(cab.tido_oid_tipo_docu,1,dcl.val_prec_sin_impu_unit,dcl.val_prec_cata_unit_loca+dcl.val_prec_cont_unit_loca), '9999999990.00')),100,' ')) || '</PRCAUN>' ||
'<PRCUCD>' || trim(rpad(ltrim(to_char(decode(cab.tido_oid_tipo_docu,1,dcl.val_prec_neto_unit_loca,dcl.val_prec_fact_unit_loca), '9999999990.00')),100,' ') ) ||  '</PRCUCD>' ||
'<PRCACD>' || trim(rpad(ltrim(to_char(decode(cab.tido_oid_tipo_docu,1,dcl.val_prec_neto_tota_loca,dcl.val_prec_fact_tota_loca), '9999999990.00')),100,' ') ) || '</PRCACD>' ||
'<LOTPRD>LOTE1-LOTE2</LOTPRD>' ||
'</detalle>' as detalle_f
  FROM FAC_DOCUM_CONTA_CABEC CAB,
       fac_docum_conta_linea dcl,
       ped_solic_posic sp,
       CRA_PERIO CP,
     SEG_PERIO_CORPO SPC,
     mAE_PRODU MP,
     INC_CONCU_PARAM_GENER CPG,
     CRA_PERIO CP1,
     SEG_PERIO_CORPO SPC1,
     CRA_PERIO CP2,
     SEG_PERIO_CORPO SPC2,
     PED_SOLIC_CABEC       PSC,
     INC_CONCU_TIPO_PROG    ICTP
 WHERE dcl.dcca_oid_cabe = cab.oid_cabe
   and dcl.num_unid_aten <> 0
   and dcl.ind_no_impr = '0'
   and sp.oid_soli_posi = dcl.sopo_oid_soli_posi
   AND CP.PERI_OID_PERI = SPC.OID_PERI
   and cp.oid_peri = cab.perd_oid_peri
   AND SP.PROD_OID_PROD = MP.OID_PROD
   and cab.oid_cabe=oidCabe
   and cab.ictp_oid_tipo_prog=ictp.oid_tipo_prog(+)
   and sp.soca_oid_soli_cabe=psc.oid_soli_cabe
   and psc.copa_oid_para_gene=cpg.oid_para_gral(+)
   and cpg.perd_oid_peri_desd=cp1.oid_peri(+)
   and cp1.peri_oid_peri=spc1.oid_peri(+)
   and cpg.perd_oid_peri_hast=cp2.oid_peri(+)
   and cp2.peri_oid_peri=spc2.oid_peri(+)
union
select
'<detalle>' ||
'<CODSAP> </CODSAP>' ||
'<UNIMED>ZZ</UNIMED>' ||
'<CANTID>1</CANTID>' ||
'<DESCRI>FLETE/EMBALAJE</DESCRI>' ||
'<CODVEN> </CODVEN>' ||
'<PRVEUN>' || trim(rpad(ltrim(to_char(nvl(cab.IMP_FLET_TOTA_LOCA,0), '9999999990.00')),15,' ')) || '</PRVEUN>' ||
'<PRCAUN>' || trim(rpad(ltrim(to_char(nvl(cab.IMP_FLET_TOTA_LOCA,0), '9999999990.00')),100,' ')) || '</PRCAUN>' ||
'<PRCUCD>' || trim(rpad(ltrim(to_char(nvl(cab.IMP_FLET_TOTA_LOCA,0), '9999999990.00')),100,' ') ) ||  '</PRCUCD>' ||
'<PRCACD>' || trim(rpad(ltrim(to_char(nvl(cab.IMP_FLET_TOTA_LOCA,0), '9999999990.00')),100,' ') ) || '</PRCACD>' ||
'<LOTPRD> </LOTPRD>' ||
'</detalle>' as detalle_f
FROM FAC_DOCUM_CONTA_CABEC CAB
 WHERE cab.oid_cabe=oidCabe
UNION
select
'<detalle>' ||
'<CODSAP> </CODSAP>' ||
'<UNIMED>ZZ</UNIMED>' ||
'<CANTID>1</CANTID>' ||
'<DESCRI>GASTOS ADMINISTRATIVOS Y DE COBRANZA</DESCRI>' ||
'<CODVEN> </CODVEN>' ||
'<PRVEUN>' || trim(rpad(ltrim(to_char(nvl(cab.VAL_TOTA_GAST_ADMI,0), '9999999990.00')),15,' ')) || '</PRVEUN>' ||
'<PRCAUN>' || trim(rpad(ltrim(to_char(nvl(cab.VAL_TOTA_GAST_ADMI,0), '9999999990.00')),100,' ')) || '</PRCAUN>' ||
'<PRCUCD>' || trim(rpad(ltrim(to_char(nvl(cab.VAL_TOTA_GAST_ADMI,0), '9999999990.00')),100,' ') ) ||  '</PRCUCD>' ||
'<PRCACD>' || trim(rpad(ltrim(to_char(nvl(cab.VAL_TOTA_GAST_ADMI,0), '9999999990.00')),100,' ') ) || '</PRCACD>' ||
'<LOTPRD> </LOTPRD>' ||
'</detalle>' as detalle_f
FROM FAC_DOCUM_CONTA_CABEC CAB
 WHERE cab.oid_cabe=oidCabe;


r_detalleFactura c_detalleFactura%ROWTYPE;



-- Variables locales
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';


BEGIN



    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.oid_cabe,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;

              DBMS_LOB.writeappend(l_clob, LENGTH(r_facturaCabecera.cabecera_f), r_facturaCabecera.cabecera_f);

          OPEN c_detalleFactura( r_facturaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

             DBMS_LOB.writeappend(l_clob, LENGTH(r_detalleFactura.detalle_f), r_detalleFactura.detalle_f);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;

          DBMS_LOB.writeappend(l_clob, LENGTH(r_facturaCabecera.cuerpo_f), r_facturaCabecera.cuerpo_f);
        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACP2: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACP2;
/**************************************************************************
Descripcion         : Genera la FACTURA
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_DOCUM_FACG2(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             --a.OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             b.VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             a.VAL_SERI_DOCU_LEGA
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.Num_Unid_Aten_Tota>0
          and a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=1
          and b.oid_soli_cabe=p_oidsoli;
          --ORDER BY COD_CLIE, OID_CABE;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             Z.Val_Codi_Vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX)
     --WHERE ROWNUM <= filaFin)
  --WHERE ROWNUM >= filaInicio
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

BEGIN
    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_PAQUE_DOCUM_LASER_FACTU');
    auxCodClie:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


                                  INSERT INTO IMP_PAQUE_DOCUM_LASER_FACTU (
                                        COD_CLIE,
                                        XML_LASE_FACT)
                                  VALUES ( r_facturaCabecera.oid_cabe,
                                         EMPTY_CLOB())
                                  RETURNING XML_LASE_FACT INTO l_clob;


                                -- Inicio del paquete
                                l_textoActual := '<factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numfact>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</numfact>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_facturaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_facturaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_facturaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_facturaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_facturaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_facturaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_facturaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<codconsultora>' || r_facturaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_facturaCabecera.COD_ZONA || ' - ' || r_facturaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_facturaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_facturaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_facturaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_facturaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleFactura.NUM_UNID_ATEN || '<t/>'|| r_detalleFactura.VAL_CODI_VENT || '     ' || r_detalleFactura.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleFactura.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99')) || '(D-' || r_detalleFactura.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS
/*
                                        IF( pag = l_totalPaginas ) THEN
                                            l_textoActual := '<txt>-----</txt>';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                            l_textoActual := '<txt>'|| r_facturaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                            DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        END IF;
*/
                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(r_facturaCabecera.TOTPROD,'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_DESC_TOTA_LOCA,'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(r_facturaCabecera.VAL_TOTA_PAGA_LOCA,'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(r_facturaCabecera.IMP_IMPU_TOTA_LOCA,'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfactlet>' || UPPER(GEN_FN_NUME_TO_TEXT(TRUNC(r_facturaCabecera.VAL_TOTA_PAGA_LOCA))) || '</totfactlet>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                 --FIN FACTURA
                                l_textoActual := '</factura>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_facturaCabecera;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_DOCUM_FACG2: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_DOCUM_FACG2;
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CREDI(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT VAL_NUME_SOLI,
             OID_CABE,
             NUM_DOCU_LEGA,
             COD_PAIS,
             DES_PAIS,
             FEC_EMIS,
             NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             NOM_COMP,
             VAL_DIRE_COMP,
             VAL_NUME_IDEN_FISC,
             IMP_DESC_TOTA_LOCA,
             IMP_IMPU_TOTA_LOCA,
             IMP_FLET_TOTA_LOCA,
             VAL_TOTA_PAGA_LOCA,
             SUM_PCON_TOTA_LOCA,
             SUM_PNET_TOTA_FACT,
             SUM_SIMP_TOTA_FACT,
             SUM_NUM_UNID_ATEN,
             SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             IND_TASA_IMPU,
             VAL_DESC,
            -- VAL_PROM,
             VAL_TOTA,
             VAL_IMPO_VENT,
             VAL_BASE_IMPO,
             NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             COD_TIPO_DOCU,
             VAL_SERI_DOCU_LEGA
          FROM IMP_PAQUE_GENER_DOCUM_LASER
          ORDER BY COD_CLIE, OID_CABE;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT--,
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA) AX
     WHERE ROWNUM <= filaFin)
  WHERE ROWNUM >= filaInicio    ;

r_detalleNota c_detalleNota%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaCredito');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_procesar              BOOLEAN := FALSE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_CREDITO            CONSTANT VARCHAR(3) :='NC';
l_maxOidCabe            NUMBER(12);

BEGIN
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NOCRE(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN

            --OBTENEMOS EL TOTAL DE PAGUNAS POR OID CABECERA
            SELECT COUNT(1)   into l_sizeDetalle
            FROM FAC_DOCUM_CONTA_LINEA X,
                 (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
           WHERE X.PROD_OID_PROD = Y.VAL_OID
            AND  X.DCCA_OID_CABE = r_notaCabecera.OID_CABE
            AND  X.NUM_UNID_ATEN <> 0;

          IF(l_sizeDetalle > 0) THEN
                    l_totalPaginas := ROUND(l_sizeDetalle/ TO_NUMBER(l_numFilas));

                    if(l_totalPaginas = 0) then
                        l_totalPaginas:=1;
                    end if;

                    l_filaInicio := 1;
                    l_filaFin := TO_NUMBER(l_numFilas);

                    FOR pag IN 1 .. l_totalPaginas LOOP

                            l_oidCabe:= r_notaCabecera.OID_CABE;
                            IF (l_oidCabe <> auxOideCabe OR auxOideCabe IS NULL) THEN

                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               l_oidCabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               r_notaCabecera.COD_TIPO_DOCU,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               r_notaCabecera.COD_PERI,
                                               r_notaCabecera.VAL_NUME_SOLI_REFE,
                                               r_notaCabecera.COD_PERI_REFE,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_emis)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA CREDITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            else
                                -- si se trata de la mismo oid de cabecera
                                SELECT XML_NOTA_CRED INTO l_clob
                                FROM  IMP_NOTA_CREDI_LASER
                                WHERE   OID_CABE= r_notaCabecera.OID_CABE FOR UPDATE;
                                -- Inicio del paquete de nuevo

                                 l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA CREDITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                            end if;

                            auxOideCabe:= l_oidCabe;
                            l_filaInicio := l_filaInicio + TO_NUMBER(l_numFilas);
                            l_filaFin :=  l_filaFin +TO_NUMBER(l_numFilas);
                            l_procesar:=TRUE;

                   END LOOP;
           END IF;
        END;
    END LOOP;
    CLOSE c_notaCabecera;


    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.cod_pais = p_codigoPais
                                  AND icdc.Cod_Tipo_Docu = NOTA_CREDITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_PAIS = p_codigoPais
          AND IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
                                      AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO;


  END IF;

   -- Validamos el parametro de actualizacion de numeros de documento legal
   l_indicadorActuDocuLega := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorActualizarDocumentoLegal');

  -- Dependiendo del parametro, actualizamos el numero de documento legal en las notas de credito
  IF l_indicadorActuDocuLega IS NOT NULL AND l_indicadorActuDocuLega = 'S' THEN
      IMP_PKG_PROCE_COMPA.IMP_PR_ACTUA_NUMER_DOCUM_NOTCR;
  END IF;

 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CREDI: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CREDI;
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRD_P(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_SOLI,
             IMP_PAQUE_GENER_DOCUM_LASER.OID_CABE,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_LEGA,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_PAIS,
             IMP_PAQUE_GENER_DOCUM_LASER.DES_PAIS,
             IMP_PAQUE_GENER_DOCUM_LASER.FEC_EMIS,
             IMP_PAQUE_GENER_DOCUM_LASER.NUM_DOCU_CONT_INTE,
             IMP_PAQUE_GENER_DOCUM_LASER.OID_CLIE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_CLIE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_PERI,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_REGI,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_ZONA,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_TERR,
             IMP_PAQUE_GENER_DOCUM_LASER.NOM_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_DIRE_COMP,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_IDEN_FISC,
             fac_docum_conta_cabec.IMP_DESC_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_IMPU_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.IMP_FLET_TOTA_LOCA,
             --IMP_PAQUE_GENER_DOCUM_LASER.VAL_TOTA_PAGA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_PCON_TOTA_LOCA,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_PNET_TOTA_FACT,
             fac_docum_conta_cabec.val_prec_cata_tota_loca+fac_docum_conta_cabec.val_prec_cont_tota_loca SUM_SIMP_TOTA_FACT,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_NUM_UNID_ATEN,
             IMP_PAQUE_GENER_DOCUM_LASER.SUM_TOTA_LETR,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TASA_IMPU,
             IMP_PAQUE_GENER_DOCUM_LASER.IND_TASA_IMPU,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_DESC,
            -- VAL_PROM,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_TOTA,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_IMPO_VENT,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_BASE_IMPO,
             NVL(IMP_PAQUE_GENER_DOCUM_LASER.COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(IMP_PAQUE_GENER_DOCUM_LASER.VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             IMP_PAQUE_GENER_DOCUM_LASER.COD_TIPO_DOCU,
             IMP_PAQUE_GENER_DOCUM_LASER.VAL_SERI_DOCU_LEGA,
             fac_docum_conta_cabec.val_tota_paga_loca
          FROM IMP_PAQUE_GENER_DOCUM_LASER ,
          fac_docum_conta_cabec
          where IMP_PAQUE_GENER_DOCUM_LASER.oid_cabe=fac_docum_conta_cabec.oid_cabe
          ORDER BY COD_CLIE, OID_CABE;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT--,
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA) AX
     WHERE ROWNUM <= filaFin)
  WHERE ROWNUM >= filaInicio    ;

r_detalleNota c_detalleNota%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaCredito');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_procesar              BOOLEAN := FALSE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_CREDITO            CONSTANT VARCHAR(3) :='NC';
l_maxOidCabe            NUMBER(12);

BEGIN
    --limpiamos temporal de factura
    EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_NOTA_CREDI_LASER');
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NOCRE(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN

            --OBTENEMOS EL TOTAL DE PAGUNAS POR OID CABECERA
            SELECT COUNT(1)   into l_sizeDetalle
            FROM FAC_DOCUM_CONTA_LINEA X,
                 (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
           WHERE X.PROD_OID_PROD = Y.VAL_OID
            AND  X.DCCA_OID_CABE = r_notaCabecera.OID_CABE
            AND  X.NUM_UNID_ATEN <> 0;

          IF(l_sizeDetalle > 0) THEN
                    l_totalPaginas := ROUND(l_sizeDetalle/ TO_NUMBER(l_numFilas));

                    if(l_totalPaginas = 0) then
                        l_totalPaginas:=1;
                    end if;

                    l_filaInicio := 1;
                    l_filaFin := TO_NUMBER(l_numFilas);

                    FOR pag IN 1 .. l_totalPaginas LOOP

                            l_oidCabe:= r_notaCabecera.OID_CABE;
                            IF (l_oidCabe <> auxOideCabe OR auxOideCabe IS NULL) THEN

                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               l_oidCabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               r_notaCabecera.COD_TIPO_DOCU,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               r_notaCabecera.COD_PERI,
                                               r_notaCabecera.VAL_NUME_SOLI_REFE,
                                               r_notaCabecera.COD_PERI_REFE,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_emis)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.Val_Prec_Cata_Unit_Loca+r_detalleNota.Val_Prec_Cont_Unit_Loca,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.Val_Prec_Cata_Tota_Loca+r_detalleNota.Val_Prec_Cont_Tota_Loca,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.Imp_Desc_Tota_Loca,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA CREDITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT-r_notaCabecera.Imp_Desc_Tota_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.Val_Tota_Paga_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            else
                                -- si se trata de la mismo oid de cabecera
                                SELECT XML_NOTA_CRED INTO l_clob
                                FROM  IMP_NOTA_CREDI_LASER
                                WHERE   OID_CABE= r_notaCabecera.OID_CABE FOR UPDATE;
                                -- Inicio del paquete de nuevo

                                 l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.Val_Prec_Cata_Unit_Loca+r_detalleNota.Val_Prec_Cont_Unit_Loca,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.Val_Prec_Cata_Tota_Loca+r_detalleNota.Val_Prec_Cont_Tota_Loca,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.Imp_Desc_Tota_Loca,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA CREDITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT-r_notaCabecera.Imp_Desc_Tota_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.Val_Tota_Paga_Loca,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                            end if;

                            auxOideCabe:= l_oidCabe;
                            l_filaInicio := l_filaInicio + TO_NUMBER(l_numFilas);
                            l_filaFin :=  l_filaFin +TO_NUMBER(l_numFilas);
                            l_procesar:=TRUE;

                   END LOOP;
           END IF;
        END;
    END LOOP;
    CLOSE c_notaCabecera;


    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.cod_pais = p_codigoPais
                                  AND icdc.Cod_Tipo_Docu = NOTA_CREDITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_PAIS = p_codigoPais
          AND IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
                                      AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO;


  END IF;

   -- Validamos el parametro de actualizacion de numeros de documento legal
   l_indicadorActuDocuLega := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorActualizarDocumentoLegal');

  -- Dependiendo del parametro, actualizamos el numero de documento legal en las notas de credito
  IF l_indicadorActuDocuLega IS NOT NULL AND l_indicadorActuDocuLega = 'S' THEN
      IMP_PKG_PROCE_COMPA.IMP_PR_ACTUA_NUMER_DOCUM_NOTCR;
  END IF;

 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CREDI: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CRD_P;

/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRD_V(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT VAL_NUME_SOLI,
             OID_CABE,
             NUM_DOCU_LEGA,
             COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             VAL_DIRE_COMP,
             VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             VAL_SERI_DOCU_LEGA,
             (select cod_alma from bel_almac where oid_alma=b.almc_oid_alma) almacen
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          --and i.ind_borr=0
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.num_unid_aten_tota<>0
          and a.tido_oid_tipo_docu=32
          --and a.oid_cabe=p_oidsoli;
          AND a.OID_CABE > (SELECT icdc.val_ulti_oid_cabe
                      FROM IMP_CONTR_DOCUM_CONTA icdc
                      WHERE icdc.Cod_Tipo_Docu = 'NC')
          ORDER BY b.almc_oid_alma,a.oid_cabe;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER) IS
      SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             z.val_codi_vent
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
             , ped_solic_posic z
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and  x.sopo_oid_soli_posi=z.oid_soli_posi
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA;

r_detalleNota c_detalleNota%ROWTYPE;

CURSOR c_detalleFactura1(oidConsolidado NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             neg.cod_nego COD,
             gen.VAL_I18N DES_PROD,
             sum(X.NUM_UNID_ATEN) NUM_UNID_ATEN,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_CATA_UNIT_FACT,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_SIN_IMPU_TOTA_FACT,
             sum(decode(nvl(x.imp_desc_sin_impu_tota_loca,0),0,x.val_prec_cont_tota_loca,nvl(x.imp_desc_sin_impu_tota_loca,0))) IMP_DESC_TOTA_FACT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P,
             mae_produ mp,
             mae_negoc neg,
             gen_i18n_sicc_pais gen
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and x.prod_oid_prod=mp.oid_prod
        and mp.nego_oid_nego=neg.oid_nego(+)
        and neg.oid_nego=gen.val_oid and gen.attr_enti='MAE_NEGOC'
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       group by x.dcca_oid_cabe,neg.cod_nego, gen.val_i18n
  ;



r_detalleFactura1 c_detalleFactura1%ROWTYPE;

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');


-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaCredito');

l_actualiza   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'actualizaInternoNC'),'N');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_docinte            NUMBER;
--l_filaFin               NUMBER;

l_procesar              BOOLEAN := TRUE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_CREDITO            CONSTANT VARCHAR(3) :='NC';
l_maxOidCabe            NUMBER(12);

-- Variables para obtener los datos de reclamo
l_numeroReclamo             NUMBER := 0;
l_descripcionOperacion      VARCHAR2(100);

-- Variables para obtener los datos del documento legal de origen
l_fechaFactura              DATE;
l_serieLegalFactura         VARCHAR2(10);
l_numeroLegalFactura        NUMBER(9);
l_codigoInternoFactura      NUMBER(9);
l_montoFactura              NUMBER(12, 2);
l_oidTipoDocumentoFactura   NUMBER(12);
l_tipoDocumentoFactura      VARCHAR2(3);
l_valnumesoli               NUMBER(12);
l_codperi                   VARCHAR2(10);


BEGIN

    select VAL_ULTI_NUME_DOCU_INTE
    into l_docinte
    from fac_docum_subac a where a.tido_oid_tipo_docu=32;


    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_NOTA_CREDI_LASER');
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NOCRE(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);

    delete from IMP_NOTA_CREDI_LASER;


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN


                l_docinte:=l_docinte+1;
                if l_actualiza='S' then
                   r_notaCabecera.NUM_DOCU_CONT_INTE:=l_docinte;
                end if;

                -- Inicializamos las variables
                l_numeroReclamo := 0;
                l_descripcionOperacion := NULL;
                l_serieLegalFactura := NULL;
                l_numeroLegalFactura := 0;
                l_codigoInternoFactura := 0;
                l_fechaFactura := NULL;
                l_montoFactura := 0;
                l_oidTipoDocumentoFactura := 0;
                l_tipoDocumentoFactura := NULL;
                l_valnumesoli := 0;
                l_codperi := NULL;

                -- Obtenemos los datos del reclamo
                imp_pkg_proce_matri.IMP_PR_OBTIE_INFOR_RECLA(r_notaCabecera.oid_Cabe ,
                                         l_numeroReclamo,
                                         l_descripcionOperacion);

                -- Obtenemos los datos de la factura del documento de origen
                IMP_PR_OBTIE_INFOR_DOCLE_REFER(r_notaCabecera.oid_Cabe,
                                               l_serieLegalFactura,
                                               l_numeroLegalFactura,
                                               l_codigoInternoFactura,
                                               l_fechaFactura,
                                               l_montoFactura,
                                               l_oidTipoDocumentoFactura,
                                               l_tipoDocumentoFactura,
                                               l_valnumesoli,
                                               l_codperi);


                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               '',--p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               r_notaCabecera.oid_Cabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               null,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               null,
                                               null,
                                               null,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_fact)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_notaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_notaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_notaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  l_codperi || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  l_valnumesoli || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<motivo>' || l_descripcionOperacion || ' ' || l_numeroReclamo ||'</motivo>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<referencia>' || 'Documento que lo soporta: Nro.Factura ';
                                    IF l_numeroLegalFactura <> 0 THEN
                                        l_textoActual := l_textoActual || l_numeroLegalFactura;
                                    ELSE
                                        l_textoActual := l_textoActual || 'POR ASIGNAR';
                                    END IF;
                                    l_textoActual := l_textoActual
                                                     || ' de fecha '  || TO_CHAR(l_fechaFactura, 'DD/MM/YYYY')
                                                     || ' por Bs.F. ' || TRIM(TO_CHAR(l_montoFactura, '9999999990.00')) || '</referencia>';
                                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<almacen>' || r_notaCabecera.almacen ||'</almacen>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if l_modelo=1 then

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || abs(r_detalleNota.NUM_UNID_ATEN) || '<t/>'|| r_detalleNota.VAL_CODI_VENT || '     ' || r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_CATA_UNIT_FACT),'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT),'999999999990.99')) || '(D-' || r_detalleNota.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;

                                else

                                OPEN c_detalleFactura1( r_notaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleFactura1 INTO r_detalleFactura1;
                                EXIT WHEN c_detalleFactura1%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || abs(r_detalleFactura1.NUM_UNID_ATEN) || '<t/>'|| r_detalleFactura1.COD || '     ' || r_detalleFactura1.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleFactura1.VAL_PREC_CATA_UNIT_FACT),'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleFactura1.VAL_PREC_SIN_IMPU_TOTA_FACT),'999999999990.99')) || '(D-' || TRIM(TO_CHAR(abs(r_detalleFactura1.IMP_DESC_TOTA_FACT),'999999999990.99')) || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura1;

                                end if;


                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(abs(r_notaCabecera.Totprod),'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_DESC_TOTA_LOCA),'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_FLET_TOTA_LOCA),'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(abs(r_notaCabecera.VAL_TOTA_PAGA_LOCA),'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_IMPU_TOTA_LOCA),'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if l_actualiza='S' then
                                   update fac_docum_conta_cabec set num_docu_cont_inte=l_docinte where oid_cabe=r_notaCabecera.oid_cabe;
                                   update fac_regis_unico_venta set num_docu_cont_inte=l_docinte where dcca_oid_cabe=r_notaCabecera.oid_cabe;
                                end if;

        END;
    END LOOP;
    CLOSE c_notaCabecera;


    if l_actualiza='S' then
       update fac_docum_subac a set a.val_ulti_nume_docu_inte=l_docinte where tido_oid_tipo_docu=32;
    end if ;


/*
    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.Cod_Tipo_Docu = NOTA_CREDITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO;


  END IF;
*/
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CRD_V: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CRD_V;


/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDV2(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT VAL_NUME_SOLI,
             OID_CABE,
             NUM_DOCU_LEGA,
             COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             VAL_DIRE_COMP,
             VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             VAL_SERI_DOCU_LEGA,
             (select cod_alma from bel_almac where oid_alma=b.almc_oid_alma) almacen
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          --and i.ind_borr=0
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.num_unid_aten_tota<>0
          and a.tido_oid_tipo_docu=32
          and a.oid_cabe=p_oidsoli;
--          ORDER BY fac_docum_conta_cabec.NUM_DOCU_CONT_INTE;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
      SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             z.val_codi_vent
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
             , ped_solic_posic z
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and  x.sopo_oid_soli_posi=z.oid_soli_posi
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA;

r_detalleNota c_detalleNota%ROWTYPE;

CURSOR c_detalleFactura1(oidConsolidado NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             neg.cod_nego COD,
             gen.VAL_I18N DES_PROD,
             sum(X.NUM_UNID_ATEN) NUM_UNID_ATEN,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_CATA_UNIT_FACT,
             sum(decode(x.val_prec_cata_tota_loca,0,x.val_prec_cont_tota_loca,x.val_prec_sin_impu_tota_loca)) VAL_PREC_SIN_IMPU_TOTA_FACT,
             sum(decode(nvl(x.imp_desc_sin_impu_tota_loca,0),0,x.val_prec_cont_tota_loca,nvl(x.imp_desc_sin_impu_tota_loca,0))) IMP_DESC_TOTA_FACT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P,
             mae_produ mp,
             mae_negoc neg,
             gen_i18n_sicc_pais gen
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and x.prod_oid_prod=mp.oid_prod
        and mp.nego_oid_nego=neg.oid_nego(+)
        and neg.oid_nego=gen.val_oid and gen.attr_enti='MAE_NEGOC'
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       group by x.dcca_oid_cabe,neg.cod_nego, gen.val_i18n
  ;



r_detalleFactura1 c_detalleFactura1%ROWTYPE;

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');


-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaCredito');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_procesar              BOOLEAN := TRUE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_CREDITO            CONSTANT VARCHAR(3) :='NC';
l_maxOidCabe            NUMBER(12);

-- Variables para obtener los datos de reclamo
l_numeroReclamo             NUMBER := 0;
l_descripcionOperacion      VARCHAR2(100);

-- Variables para obtener los datos del documento legal de origen
l_fechaFactura              DATE;
l_serieLegalFactura         VARCHAR2(10);
l_numeroLegalFactura        NUMBER(9);
l_codigoInternoFactura      NUMBER(9);
l_montoFactura              NUMBER(12, 2);
l_oidTipoDocumentoFactura   NUMBER(12);
l_tipoDocumentoFactura      VARCHAR2(3);
l_valnumesoli               NUMBER(12);
l_codperi                   VARCHAR2(10);


BEGIN
    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_NOTA_CREDI_LASER');
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NOCRE(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN

                -- Inicializamos las variables
                l_numeroReclamo := 0;
                l_descripcionOperacion := NULL;
                l_serieLegalFactura := NULL;
                l_numeroLegalFactura := 0;
                l_codigoInternoFactura := 0;
                l_fechaFactura := NULL;
                l_montoFactura := 0;
                l_oidTipoDocumentoFactura := 0;
                l_tipoDocumentoFactura := NULL;
                l_valnumesoli := 0;
                l_codperi := NULL;

                -- Obtenemos los datos del reclamo
                imp_pkg_proce_matri.IMP_PR_OBTIE_INFOR_RECLA(r_notaCabecera.oid_Cabe ,
                                         l_numeroReclamo,
                                         l_descripcionOperacion);

                -- Obtenemos los datos de la factura del documento de origen
                IMP_PR_OBTIE_INFOR_DOCLE_REFER(r_notaCabecera.oid_Cabe,
                                               l_serieLegalFactura,
                                               l_numeroLegalFactura,
                                               l_codigoInternoFactura,
                                               l_fechaFactura,
                                               l_montoFactura,
                                               l_oidTipoDocumentoFactura,
                                               l_tipoDocumentoFactura,
                                               l_valnumesoli,
                                               l_codperi);


                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               '',--p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               r_notaCabecera.oid_Cabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               null,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               null,
                                               null,
                                               null,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_fact)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_notaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_notaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_notaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  l_codperi || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  l_valnumesoli || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<motivo>' || l_descripcionOperacion || ' ' || l_numeroReclamo ||'</motivo>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<referencia>' || 'Documento que lo soporta: Nro.Factura ';
                                    IF l_numeroLegalFactura <> 0 THEN
                                        l_textoActual := l_textoActual || l_numeroLegalFactura;
                                    ELSE
                                        l_textoActual := l_textoActual || 'POR ASIGNAR';
                                    END IF;
                                    l_textoActual := l_textoActual
                                                     || ' de fecha '  || TO_CHAR(l_fechaFactura, 'DD/MM/YYYY')
                                                     || ' por Bs.F. ' || TRIM(TO_CHAR(l_montoFactura, '9999999990.00')) || '</referencia>';
                                    DBMS_LOB.writeappend(l_CLOB, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<almacen>' || r_notaCabecera.almacen ||'</almacen>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                if l_modelo=1 then

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || abs(r_detalleNota.NUM_UNID_ATEN) || '<t/>'|| r_detalleNota.VAL_CODI_VENT || '     ' || r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_CATA_UNIT_FACT),'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT),'999999999990.99')) || '(D-' || r_detalleNota.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;

                                else

                                OPEN c_detalleFactura1( r_notaCabecera.OID_CABE);
                                LOOP
                                FETCH c_detalleFactura1 INTO r_detalleFactura1;
                                EXIT WHEN c_detalleFactura1%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || abs(r_detalleFactura1.NUM_UNID_ATEN) || '<t/>'|| r_detalleFactura1.COD || '     ' || r_detalleFactura1.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleFactura1.VAL_PREC_CATA_UNIT_FACT),'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleFactura1.VAL_PREC_SIN_IMPU_TOTA_FACT),'999999999990.99')) || '(D-' || TRIM(TO_CHAR(abs(r_detalleFactura1.IMP_DESC_TOTA_FACT),'999999999990.99')) || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleFactura1;

                                end if;


                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(abs(r_notaCabecera.Totprod),'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_DESC_TOTA_LOCA),'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_FLET_TOTA_LOCA),'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(abs(r_notaCabecera.VAL_TOTA_PAGA_LOCA),'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_IMPU_TOTA_LOCA),'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_notaCabecera;

/*
    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.Cod_Tipo_Docu = NOTA_CREDITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO;


  END IF;
*/

 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CRDV2: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CRDV2;
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO para Bolivia
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDBO(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_facturaCabecera IS
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             b.clie_OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_ape1 || ' ' || f.val_ape2 || ' ' || f.val_nom1 || ' ' || f.val_nom2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_FISC,
             a.VAL_NUME_IDEN_NNAL,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_tota_gast_admi,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             b.VAL_TASA_IMPU,
             a.VAL_SERI_DOCU_LEGA,
             n.num_cont_docu_lega,
             n.val_seri_docu_refe,
             n.fec_emis_refe,
             n.val_nume_docu_refe,
             n.fec_limi_refe,
             n.val_nume_auto_refe,
             n.val_llav_refe,
             n.val_nume_cont_refe,
             a.val_nume_auto,
             a.val_llav            
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          , fac_regis_unico_venta n, ped_tipo_solic_pais o, ped_tipo_solic p
          where a.Num_Unid_Aten_Tota<>0
          and a.pais_oid_pais=c.oid_pais
          and b.tspa_oid_tipo_soli_pais=o.oid_tipo_soli_pais
          and o.tsol_oid_tipo_soli=p.oid_tipo_soli
          and p.ind_anul=1
          and to_char(a.fec_fact,'mmyyyy')>to_char(n.fec_emis_refe,'mmyyyy')
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=32
          and a.fec_fact=to_date(p_fechaFacturacion,'dd/mm/yyyy')
          --AND a.OID_CABE > (SELECT icdc.val_ulti_oid_cabe
          --            FROM IMP_CONTR_DOCUM_CONTA icdc
          --            WHERE icdc.Cod_Tipo_Docu = 'NC')          
          and a.oid_cabe=n.dcca_oid_cabe
/*union
  SELECT VAL_NUME_SOLI,
             a.OID_CABE,
             a.NUM_DOCU_LEGA,
             --COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             b.clie_OID_CLIE,
             f.COD_CLIE,
             h.COD_PERI,
             m.COD_REGI,
             l.COD_ZONA,
             j.COD_TERR,
             f.val_ape1 || ' ' || f.val_ape2 || ' ' || f.val_nom1 || ' ' || f.val_nom2 NOM_COMP,
             a.VAL_DIRE_COMP,
             a.VAL_NUME_IDEN_FISC,
             a.VAL_NUME_IDEN_NNAL,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_tota_gast_admi,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             b.VAL_TASA_IMPU,
             a.VAL_SERI_DOCU_LEGA,
             n.num_cont_docu_lega,
             n.val_seri_docu_refe,
             n.fec_emis_refe,
             n.val_nume_docu_refe,
             n.fec_limi_refe,
             n.val_nume_auto_refe,
             n.val_llav_refe,
             n.val_nume_cont_refe,
             a.val_nume_auto,
             a.val_llav            
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          , fac_regis_unico_venta n, ped_tipo_solic_pais o, ped_tipo_solic p, mae_tipo_docum q
          where a.Num_Unid_Aten_Tota<>0
          and a.pais_oid_pais=c.oid_pais
          and b.tdoc_oid_tipo_docu=q.oid_tipo_docu
          and q.ind_doc_iden_fisc='1'
          and b.tspa_oid_tipo_soli_pais=o.oid_tipo_soli_pais
          and o.tsol_oid_tipo_soli=p.oid_tipo_soli
          and p.ind_anul=0
          --and to_char(a.fec_fact,'mmyyyy')>to_char(n.fec_emis_refe,'mmyyyy')
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.tido_oid_tipo_docu=32
          and a.fec_fact=to_date(p_fechaFacturacion,'dd/mm/yyyy')
          --AND a.OID_CABE > (SELECT icdc.val_ulti_oid_cabe
          --            FROM IMP_CONTR_DOCUM_CONTA icdc
          --            WHERE icdc.Cod_Tipo_Docu = 'NC')  
          and a.oid_cabe=n.dcca_oid_cabe  */        
          ;

r_facturaCabecera c_facturaCabecera%ROWTYPE;

CURSOR c_detalleFactura(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
       SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             lpad(decode(Z.Val_Codi_Vent, NULL, z.val_codi_vent_fict, z.val_codi_vent),5,'0') val_codi_vent
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y,
             PED_SOLIC_POSIC Z,
             PRE_OFERT_DETAL P
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.SOPO_OID_SOLI_POSI = Z.OID_SOLI_POSI
        AND  Z.OFDE_OID_DETA_OFER = P.OID_DETA_OFER(+)
        AND  NOT EXISTS (SELECT NULL
                         FROM FAC_TIPO_OFERT_EXCLU O
                         WHERE O.TOFE_OID_TIPO_OFER = P.TOFE_OID_TIPO_OFER)
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA
  ;

r_detalleFactura c_detalleFactura%ROWTYPE;



-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   varchar2(32600) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesFactura');

l_modelo   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'modeloFacturaVE'),'1');

l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxCodClie              VARCHAR2(15);
l_codClie               VARCHAR2(15);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_control               VARCHAR2(50);

l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');

l_oid_docu_suba             NUMBER(12) := 0;
l_num_docu_cont_inte        NUMBER(12) := 0;
l_anio                      NUMBER(12) := 0;
l_val_seri_docu_lega        VARCHAR2(15);
l_val_nume_auto             VARCHAR2(15);

    l_val_llave               fac_docum_subac.val_llav%TYPE;
    l_fecha_limite            fac_docum_subac.fec_limi%TYPE;


BEGIN
    auxCodClie:=NULL;

    

    OPEN c_facturaCabecera;
    LOOP
    FETCH c_facturaCabecera INTO r_facturaCabecera;
    EXIT WHEN c_facturaCabecera%NOTFOUND;
        BEGIN


              if r_facturaCabecera.NUM_DOCU_CONT_INTE is null then
              
              select max(a.oid_docu_suba)
              into l_oid_docu_suba
              from fac_docum_subac a
              where a.tido_oid_tipo_docu=32
              ;

              select a.val_ulti_nume_docu_inte+1, a.val_ulti_ejer_docu_inte, a.val_seri_docu_lega, a.val_nume_auto, a.val_llav, a.fec_limi
              into l_num_docu_cont_inte, l_anio, l_val_seri_docu_lega, l_val_nume_auto, l_val_llave, l_fecha_limite
              from fac_docum_subac a
              where a.oid_docu_suba=l_oid_docu_suba;

              update fac_docum_subac set val_ulti_nume_docu_inte=l_num_docu_cont_inte
              where oid_docu_suba=l_oid_docu_suba;

              update fac_regis_unico_venta a
              set a.num_docu_cont_inte=l_num_docu_cont_inte
              , a.val_nume_auto=l_val_nume_auto
              , a.val_seri_docu_lega=l_val_seri_docu_lega
              , a.val_nume_docu_lega=l_num_docu_cont_inte
              , a.val_llav           = l_val_llave
              , a.fec_limi           = l_fecha_limite
              where dcca_oid_cabe=r_facturaCabecera.oid_cabe
              ;


              update fac_docum_conta_cabec a
              set a.num_docu_cont_inte=l_num_docu_cont_inte
              , a.val_nume_auto=l_val_nume_auto
              , a.val_seri_docu_lega=l_val_seri_docu_lega
              , a.num_docu_lega=l_num_docu_cont_inte
              , a.val_llav           = l_val_llave
              , a.fec_limi           = l_fecha_limite
              where oid_cabe=r_facturaCabecera.oid_cabe
              ;
              
              r_facturaCabecera.NUM_DOCU_CONT_INTE:=l_num_docu_cont_inte;

              end if;

                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               '',--p_codigoPais,
                                               r_facturaCabecera.clie_OID_CLIE,
                                               r_facturaCabecera.COD_CLIE,
                                               r_facturaCabecera.oid_Cabe,
                                               r_facturaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_facturaCabecera.NUM_DOCU_CONT_INTE,
                                               null,
                                               r_facturaCabecera.VAL_NUME_SOLI,
                                               null,
                                               null,
                                               null,
                                               r_facturaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_facturaCabecera.fec_fact)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                l_control:=fac_pkg_gener.FAC_FN_GENER_CODIG_CTROL(abs(r_facturaCabecera.val_tota_paga_loca), r_facturaCabecera.val_nume_auto, r_facturaCabecera.num_docu_cont_inte, trim(TRANSLATE (nvl(r_facturaCabecera.VAL_NUME_IDEN_FISC,r_facturaCabecera.VAL_NUME_IDEN_NNAL), 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',' ')), to_char(r_facturaCabecera.fec_fact,'dd/mm/yyyy'), r_facturaCabecera.val_llav);
                                
                                update fac_docum_conta_cabec a set a.val_nume_cont=l_control
                                where a.oid_cabe=r_facturaCabecera.oid_cabe;

                                update fac_regis_unico_venta a set a.val_nume_cont=l_control
                                where a.dcca_oid_cabe=r_facturaCabecera.oid_cabe;



                                -- Inicio del paquete
                                l_textoActual := '<NotasCD>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '<Documento>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := l_textoActual || '<Encabezado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                --Inicio Bloque Factura Origen
                                l_textoActual := l_textoActual || '<FacturaOrigen>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroFactura>' || r_facturaCabecera.val_nume_docu_refe ||'</NumeroFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<FechaDeFactura>' || to_char(r_facturaCabecera.fec_emis_refe,'yyyymmdd') || '</FechaDeFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroAutorizacionFactura>' || r_facturaCabecera.val_nume_auto_refe ||'</NumeroAutorizacionFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<FechaLimiteEmisionFactura>' || to_char(r_facturaCabecera.fec_limi_refe, 'yyyymmdd') ||'</FechaLimiteEmisionFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoControlFactura>' || r_facturaCabecera.val_nume_cont_refe ||'</CodigoControlFactura>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Factura Origen
                               l_textoActual := l_textoActual || '</FacturaOrigen>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                --Inicio Bloque Consultora
                                l_textoActual := l_textoActual || '<EConsultora>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NombreConsultora>' || r_facturaCabecera.NOM_COMP ||'</NombreConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoConsultora>' || r_facturaCabecera.COD_CLIE || '</CodigoConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<DocumentoConsultora>' || trim(TRANSLATE (nvl(r_facturaCabecera.VAL_NUME_IDEN_FISC,r_facturaCabecera.VAL_NUME_IDEN_NNAL), 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',' ')) ||'</DocumentoConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<DireccionConsultora>' || r_facturaCabecera.VAL_DIRE_COMP ||'</DireccionConsultora>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Consultora
                                l_textoActual := l_textoActual || '</EConsultora>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque Factura
                                l_textoActual := l_textoActual || '<IdNotaCD>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroNotaCD>'|| r_facturaCabecera.NUM_DOCU_LEGA  ||'</NumeroNotaCD>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<FechaDeNotaCD>'|| to_char(r_facturaCabecera.fec_fact,'yyyymmdd') || '</FechaDeNotaCD>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CampanaProceso>'|| r_facturaCabecera.cod_peri  ||'</CampanaProceso>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoControl>'|| l_control  ||'</CodigoControl>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Factura
                                l_textoActual := l_textoActual || '</IdNotaCD>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque Totales
                                l_textoActual := l_textoActual || '<TotalNCD>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := l_textoActual || '<TotalMontoFlete>' || TRIM(TO_CHAR(abs(r_facturaCabecera.IMP_FLET_TOTA_LOCA),l_formatoNumerico)) || '</TotalMontoFlete>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoInteres>' || TRIM(TO_CHAR(nvl(abs(r_facturaCabecera.val_tota_gast_admi),0),l_formatoNumerico)) || '</TotalMontoInteres>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoNCD>' || TRIM(TO_CHAR(abs(r_facturaCabecera.VAL_TOTA_PAGA_LOCA),l_formatoNumerico)) || '</TotalMontoNCD>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoNCDLetras>' || UPPER(GEN_FN_NUME_TO_TEXT(TRUNC(abs(r_facturaCabecera.VAL_TOTA_PAGA_LOCA)))) || ' ' || TO_CHAR((abs(r_facturaCabecera.VAL_TOTA_PAGA_LOCA) - TRUNC(abs(r_facturaCabecera.VAL_TOTA_PAGA_LOCA))) * 100)  || '/100 BOLIVIANOS' || '</TotalMontoNCDLetras>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := l_textoActual || '<TotalMontoEfectivoDebito13>' || TRIM(TO_CHAR(abs(r_facturaCabecera.VAL_TOTA_PAGA_LOCA)*0.13,l_formatoNumerico)) || '</TotalMontoEfectivoDebito13>';
                                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Fin Bloque Totales
                                l_textoActual := l_textoActual || '</TotalNCD>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                                l_textoActual := l_textoActual || '</Encabezado>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := l_textoActual || '<Detalles>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleFactura( r_facturaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleFactura INTO r_detalleFactura;
                                EXIT WHEN c_detalleFactura%NOTFOUND;
                                BEGIN

                                l_textoActual := l_textoActual || '<LinDetalle>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<NumeroLin>' || r_detalleFactura.NUM_LINEA || '</NumeroLin>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<CodigoCUV>' || r_detalleFactura.val_codi_vent || '</CodigoCUV>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<UnidadesProcesadas>' || abs(r_detalleFactura.NUM_unid_aten) || '</UnidadesProcesadas>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<DescripcionProd>' || r_detalleFactura.des_prod || '</DescripcionProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoCatalogoProd>' || case when r_detalleFactura.val_prec_cata_unit_loca=0 then '+' else TRIM(TO_CHAR(abs(r_detalleFactura.val_prec_cata_unit_loca),l_formatoNumerico)) end || '</MontoCatalogoProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoTotalProd>' || case when r_detalleFactura.val_prec_cata_unit_loca=0 then NULL else TRIM(TO_CHAR(abs(r_detalleFactura.val_prec_cata_tota_loca),l_formatoNumerico)) end || '</MontoTotalProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoPorcentDcto>' || case when r_detalleFactura.val_prec_cata_unit_loca=0 then NULL else TRIM(TO_CHAR(r_detalleFactura.VAL_PORC_DESC,l_formatoNumerico)) end || '</MontoPorcentDcto>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := l_textoActual || '<MontoNetoProd>' || case when r_detalleFactura.val_prec_cata_unit_loca=0 then NULL else TRIM(TO_CHAR(abs(r_detalleFactura.val_prec_cata_tota_loca-r_detalleFactura.imp_desc_tota_loca),l_formatoNumerico)) end || '</MontoNetoProd>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '</LinDetalle>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                END;
                                END LOOP;
                                CLOSE c_detalleFactura;


                                -- Fin de detalle Factura
                                l_textoActual := l_textoActual || '</Detalles>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --

                                 --FIN FACTURA
                                l_textoActual := l_textoActual || '</Documento>';
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := l_textoActual || '</NotasCD>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                               commit;
        END;
    END LOOP;
    CLOSE c_facturaCabecera;

 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CRDBO: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CRDBO;
/**************************************************************************
Descripcion         : Genera la NOTA CREDITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_CRDG2(p_oidsoli NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT VAL_NUME_SOLI,
             OID_CABE,
             NUM_DOCU_LEGA,
             COD_PAIS,
             d.val_i18n DES_PAIS,
             a.FEC_FACT,
             a.NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             f.val_nom1 || ' ' || f.val_nom2 || ' ' || f.val_ape1 || ' ' || f.val_ape2 NOM_COMP,
             VAL_DIRE_COMP,
             VAL_NUME_IDEN_FISC,
             a.IMP_DESC_TOTA_LOCA-(a.VAL_TOTA_PAGA_LOCA-((a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca)-a.IMP_DESC_TOTA_LOCA+a.IMP_FLET_TOTA_LOCA)) IMP_DESC_TOTA_LOCA,
             a.IMP_IMPU_TOTA_LOCA,
             a.IMP_FLET_TOTA_LOCA,
             a.VAL_TOTA_PAGA_LOCA,
             a.val_prec_cata_tota_loca+a.val_prec_cont_tota_loca TOTPROD,
             --SUM_PCON_TOTA_LOCA,
             --SUM_PNET_TOTA_FACT,
             --SUM_SIMP_TOTA_FACT,
             --SUM_NUM_UNID_ATEN,
             --SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             --IND_TASA_IMPU,
             --VAL_DESC,
            -- VAL_PROM,
             --VAL_TOTA,
             --VAL_IMPO_VENT,
             --VAL_BASE_IMPO,
             --NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             --NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             --COD_TIPO_DOCU,
             VAL_SERI_DOCU_LEGA
          FROM FAC_DOCUM_CONTA_CABEC a, ped_solic_cabec b, seg_pais c
          , gen_i18n_sicc_comun d, mae_clien_direc e, mae_clien f
          , cra_perio g, seg_perio_corpo h
          , zon_terri_admin i, zon_terri j, zon_secci k, zon_zona l, zon_regio m
          where a.pais_oid_pais=c.oid_pais
          and c.oid_pais=d.val_oid and d.attr_enti='SEG_PAIS'
          and a.soca_oid_soli_cabe=b.oid_soli_cabe
          and a.cldi_oid_clie_dire=e.oid_clie_dire
          and i.ind_borr=0
          and e.clie_oid_clie=f.oid_clie
          and a.perd_oid_peri=g.oid_peri
          and g.peri_oid_peri=h.oid_peri
          and b.ztad_oid_terr_admi=i.oid_terr_admi
          and i.terr_oid_terr=j.oid_terr and i.zscc_oid_secc=k.oid_secc
          and k.zzon_oid_zona=l.oid_zona
          and l.zorg_oid_regi=m.oid_regi
          and a.num_unid_aten_tota<>0
          and a.tido_oid_tipo_docu=32
          and a.oid_cabe=p_oidsoli;
--          ORDER BY fac_docum_conta_cabec.NUM_DOCU_CONT_INTE;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
      SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT,
             z.val_codi_vent
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
             , ped_solic_posic z
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        and  x.sopo_oid_soli_posi=z.oid_soli_posi
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN <> 0
       ORDER BY X.NUM_LINEA;

r_detalleNota c_detalleNota%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaCredito');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_procesar              BOOLEAN := TRUE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_CREDITO            CONSTANT VARCHAR(3) :='NC';
l_maxOidCabe            NUMBER(12);

-- Variables para obtener los datos de reclamo
l_numeroReclamo             NUMBER := 0;
l_descripcionOperacion      VARCHAR2(100);

-- Variables para obtener los datos del documento legal de origen
l_fechaFactura              DATE;
l_serieLegalFactura         VARCHAR2(10);
l_numeroLegalFactura        NUMBER(9);
l_codigoInternoFactura      NUMBER(9);
l_montoFactura              NUMBER(12, 2);
l_oidTipoDocumentoFactura   NUMBER(12);
l_tipoDocumentoFactura      VARCHAR2(3);

BEGIN
    --limpiamos temporal de factura
    --EXECUTE IMMEDIATE(' TRUNCATE TABLE IMP_NOTA_CREDI_LASER');
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    --IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NOCRE(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    --l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    --l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    --l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    --l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    --l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN

                -- Inicializamos las variables
                l_numeroReclamo := 0;
                l_descripcionOperacion := NULL;
                l_serieLegalFactura := NULL;
                l_numeroLegalFactura := 0;
                l_codigoInternoFactura := 0;
                l_fechaFactura := NULL;
                l_montoFactura := 0;
                l_oidTipoDocumentoFactura := 0;
                l_tipoDocumentoFactura := NULL;

                -- Obtenemos los datos del reclamo
                imp_pkg_proce_matri.IMP_PR_OBTIE_INFOR_RECLA(r_notaCabecera.oid_Cabe ,
                                         l_numeroReclamo,
                                         l_descripcionOperacion);

                -- Obtenemos los datos de la factura del documento de origen
                imp_pkg_proce_matri.IMP_PR_OBTIE_INFOR_DOCLE_REFER(r_notaCabecera.oid_Cabe,
                                               l_serieLegalFactura,
                                               l_numeroLegalFactura,
                                               l_codigoInternoFactura,
                                               l_fechaFactura,
                                               l_montoFactura,
                                               l_oidTipoDocumentoFactura,
                                               l_tipoDocumentoFactura);


                                  INSERT INTO IMP_NOTA_CREDI_LASER (COR_NOTA_CRED,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_CRED,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_credi_XML.Nextval,
                                               '',--p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               r_notaCabecera.oid_Cabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               null,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               null,
                                               null,
                                               null,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_fact)
                                  RETURNING XML_NOTA_CRED INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotcre>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotcre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numint>'|| r_notaCabecera.NUM_DOCU_CONT_INTE  ||'</numint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numped>'|| r_notaCabecera.VAL_NUME_SOLI  ||'</numped>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcedula>'|| r_notaCabecera.VAL_NUME_IDEN_FISC  ||'</numcedula>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_fact,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_fact,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_fact,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<fecref>' || l_fechaFactura || '</fecref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>' || l_numeroLegalFactura || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<motivo>' || l_descripcionOperacion || ' ' || l_numeroReclamo ||'</motivo>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || abs(r_detalleNota.NUM_UNID_ATEN) || '<t/>'|| r_detalleNota.VAL_CODI_VENT || '     ' || r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_CATA_UNIT_FACT),'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(abs(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT),'999999999990.99')) || '(D-' || r_detalleNota.VAL_PORC_DESC || ')';

                                   l_textoActual := l_textoActual ||  '</txt>';
                                       /* IF(c_detalleFactura.IND_PROD_GRAT='S') THEN
                                            l_textoActual := l_textoActual ||  'Prom.</txt>';
                                        ELSE
                                            l_textoActual := l_textoActual ||  '</txt>';
                                        END IF;*/

                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totprod>' || TRIM(TO_CHAR(abs(r_notaCabecera.Totprod),'999999999990.99')) || '</totprod>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totdesc>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_DESC_TOTA_LOCA),'999999999990.99')) || '</totdesc>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totgast>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_FLET_TOTA_LOCA),'999999999990.99')) || '</totgast>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totfact>' || TRIM(TO_CHAR(abs(r_notaCabecera.VAL_TOTA_PAGA_LOCA),'999999999990.99')) || '</totfact>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '<totimp>' || TRIM(TO_CHAR(abs(r_notaCabecera.IMP_IMPU_TOTA_LOCA),'999999999990.99')) || '</totimp>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                 --FIN NOTA CREDIO
                                l_textoActual := '</notcre>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

        END;
    END LOOP;
    CLOSE c_notaCabecera;

/*
    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.Cod_Tipo_Docu = NOTA_CREDITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_CREDITO;


  END IF;
*/

 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_CRDG2: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_CRDG2;
/**************************************************************************
Descripcion         : Genera la NOTA DEBITO
Fecha Creacion      : 21/07/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_PROCE_PAQUE_NOTA_DEBIT(p_codigoPais VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo VARCHAR2,
                                         p_fechaFacturacion VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_notaCabecera IS
  SELECT VAL_NUME_SOLI,
             OID_CABE,
             NUM_DOCU_LEGA,
             COD_PAIS,
             DES_PAIS,
             FEC_EMIS,
             NUM_DOCU_CONT_INTE,
             OID_CLIE,
             COD_CLIE,
             COD_PERI,
             COD_REGI,
             COD_ZONA,
             COD_TERR,
             NOM_COMP,
             VAL_DIRE_COMP,
             VAL_NUME_IDEN_FISC,
             IMP_DESC_TOTA_LOCA,
             IMP_IMPU_TOTA_LOCA,
             IMP_FLET_TOTA_LOCA,
             VAL_TOTA_PAGA_LOCA,
             SUM_PCON_TOTA_LOCA,
             SUM_PNET_TOTA_FACT,
             SUM_SIMP_TOTA_FACT,
             SUM_NUM_UNID_ATEN,
             SUM_TOTA_LETR,
             VAL_TASA_IMPU,
             IND_TASA_IMPU,
             VAL_DESC,
            -- VAL_PROM,
             VAL_TOTA,
             VAL_IMPO_VENT,
             VAL_BASE_IMPO,
             NVL(COD_PERI_REFE, ' ') COD_PERI_REFE,
             NVL(VAL_NUME_SOLI_REFE, 0) VAL_NUME_SOLI_REFE,
             COD_TIPO_DOCU,
             VAL_SERI_DOCU_LEGA
          FROM IMP_PAQUE_GENER_DOCUM_LASER
          ORDER BY COD_CLIE, OID_CABE;

r_notaCabecera c_notaCabecera%ROWTYPE;

CURSOR c_detalleNota(oidConsolidado NUMBER,filaInicio NUMBER, filaFin NUMBER) IS
  SELECT * FROM
     (SELECT AX.*,
           ROWNUM  RNUM
     FROM
      (SELECT   X.DCCA_OID_CABE,
             X.OID OID_LINE,
             X.NUM_LINEA,
             X.NUM_UNID_ATEN,
             X.PROD_OID_PROD,
             Y.VAL_I18N DES_PROD,
             X.VAL_PREC_CATA_UNIT_LOCA,
             X.VAL_PREC_CATA_TOTA_LOCA,
             X.VAL_PREC_CONT_UNIT_LOCA,
             X.VAL_PREC_CONT_TOTA_LOCA,
             X.IMP_DESC_UNIT_LOCA,
             X.IMP_DESC_TOTA_LOCA,
             X.VAL_PREC_FACT_UNIT_LOCA,
             X.VAL_PREC_FACT_TOTA_LOCA,
             X.IMP_IMPU_UNIT_LOCA,
             X.IMP_IMPU_TOTA_LOCA,
             X.VAL_PREC_NETO_UNIT_LOCA,
             X.VAL_PREC_NETO_TOTA_LOCA,
             NVL(X.VAL_PORC_DESC, 0) VAL_PORC_DESC,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_SIN_IMPU_UNIT,  X.VAL_PREC_CATA_UNIT_LOCA) VAL_PREC_CATA_UNIT_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, X.VAL_PREC_SIN_IMPU_TOTA_LOCA, X.VAL_PREC_SIN_IMPU_TOTA_LOCA) VAL_PREC_SIN_IMPU_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, X.VAL_PREC_CONT_TOTA_LOCA, X.IMP_DESC_SIN_IMPU_TOTA_LOCA) IMP_DESC_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_UNIT_LOCA, 0, 0, X.VAL_PREC_NETO_TOTA_LOCA) VAL_PREC_NETO_TOTA_FACT,
             DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 0, X.IMP_IMPU_TOTA_LOCA) IMP_IMPU_TOTA_FACT--,
           --  DECODE(X.VAL_PREC_CATA_TOTA_LOCA, 0, 'S', 'N') IND_PROD_GRAT
        FROM FAC_DOCUM_CONTA_LINEA X,
             (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
       WHERE X.PROD_OID_PROD = Y.VAL_OID
        AND  X.DCCA_OID_CABE = oidConsolidado
        AND  X.NUM_UNID_ATEN > 0
       ORDER BY X.NUM_LINEA) AX
     WHERE ROWNUM <= filaFin)
  WHERE ROWNUM >= filaInicio    ;

r_detalleNota c_detalleNota%ROWTYPE;

-- Variables locales
l_oidPais                       NUMBER;
l_oidPeriodo                    NUMBER;
l_oidCanal                      NUMBER;
l_oidMarca                      NUMBER;
l_codigoPeriodo                 VARCHAR2(25);
l_correlativo                   NUMBER := 1;
l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_numeroLoteFacturacion         NUMBER;
l_clob                          CLOB;
l_textoActual                   VARCHAR2(1000) := '';

--NUEVO PARAMETRO
l_numFilas   VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'numeroDetallesNotaDebito');
l_totalPaginas              NUMBER;
l_sizeDetalle               NUMBER;

auxOideCabe             NUMBER(12);
l_oidCabe               NUMBER(12);

l_filaInicio            NUMBER;
l_filaFin               NUMBER;

l_procesar              BOOLEAN := FALSE;
l_indicadorActuDocuLega VARCHAR2(50);
NOTA_DEBITO  CONSTANT VARCHAR(3) :='ND';
l_maxOidCabe            NUMBER(12);

BEGIN
    auxOideCabe:=NULL;

    --inicamos con el caculo de la cabecera
    IMP_PKG_PROCE_COMPA.IMP_PR_CALCU_DOCUM_LASER_NODEB(p_codigoPais);


    -- Obtenemos los OIDs necesarios
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodo := SUBSTR(p_codigoPeriodo, 5, 2) || '/' || SUBSTR(p_codigoPeriodo, 1, 4);


    OPEN c_notaCabecera;
    LOOP
    FETCH c_notaCabecera INTO r_notaCabecera;
    EXIT WHEN c_notaCabecera%NOTFOUND;
        BEGIN

            --OBTENEMOS EL TOTAL DE PAGUNAS POR OID CABECERA
            SELECT COUNT(1)   into l_sizeDetalle
            FROM FAC_DOCUM_CONTA_LINEA X,
                 (SELECT VAL_I18N, VAL_OID FROM GEN_I18N_SICC WHERE ATTR_ENTI = 'MAE_PRODU') Y
           WHERE X.PROD_OID_PROD = Y.VAL_OID
            AND  X.DCCA_OID_CABE = r_notaCabecera.OID_CABE
            AND  X.NUM_UNID_ATEN > 0;

          IF(l_sizeDetalle > 0) THEN
                    l_totalPaginas := ROUND(l_sizeDetalle/ TO_NUMBER(l_numFilas));

                    if(l_totalPaginas = 0) then
                        l_totalPaginas:=1;
                    end if;

                    l_filaInicio := 1;
                    l_filaFin := TO_NUMBER(l_numFilas);

                    FOR pag IN 1 .. l_totalPaginas LOOP

                            l_oidCabe:= r_notaCabecera.OID_CABE;
                            IF (l_oidCabe <> auxOideCabe OR auxOideCabe IS NULL) THEN

                                  INSERT INTO IMP_NOTA_DEBIT_LASER (COR_NOTA_DEBI,
                                                                   COD_PAIS,
                                                                   OID_CLIE,
                                                                   COD_CLIE,
                                                                   OID_CABE,
                                                                   VAL_SERI_DOCU_LEGA,
                                                                   NUM_DOCU_CONT_INTE,
                                                                   COD_TIPO_DOCU,
                                                                   VAL_NUME_SOLI,
                                                                   COD_PERI,
                                                                   VAL_NUME_SOLI_REFE,
                                                                   COD_PERI_REFE,
                                                                   NUM_DOCU_LEGA,
                                                                   XML_NOTA_DEBI,
                                                                   FEC_EMIS)
                                   VALUES
                                              (imp_seq_nota_debit_XML.Nextval,
                                               p_codigoPais,
                                               r_notaCabecera.OID_CLIE,
                                               r_notaCabecera.COD_CLIE,
                                               l_oidCabe,
                                               r_notaCabecera.VAL_SERI_DOCU_LEGA,
                                               r_notaCabecera.NUM_DOCU_CONT_INTE,
                                               r_notaCabecera.COD_TIPO_DOCU,
                                               r_notaCabecera.VAL_NUME_SOLI,
                                               r_notaCabecera.COD_PERI,
                                               r_notaCabecera.VAL_NUME_SOLI_REFE,
                                               r_notaCabecera.COD_PERI_REFE,
                                               r_notaCabecera.NUM_DOCU_LEGA,
                                               EMPTY_CLOB(),
                                               r_notaCabecera.fec_emis)
                                  RETURNING XML_NOTA_DEBI INTO l_clob;

                                -- Inicio del paquete
                                l_textoActual := '<notdeb>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotdeb>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotdeb>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA DEBITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notdeb>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                            else
                                -- si se trata de la mismo oid de cabecera
                                SELECT XML_NOTA_DEBI INTO l_clob
                                FROM  IMP_NOTA_DEBIT_LASER
                                WHERE   OID_CABE= r_notaCabecera.OID_CABE FOR UPDATE;
                                -- Inicio del paquete de nuevo

                                 l_textoActual := '<notdeb>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --Inicio Bloque cabecera
                                l_textoActual := '<blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numnotdeb>'|| r_notaCabecera.NUM_DOCU_LEGA  ||'</numnotdeb>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                    l_textoActual := '<lugar>' || r_notaCabecera.DES_PAIS || '</lugar>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<dia>'|| to_char(r_notaCabecera.fec_emis,'dd') || '</dia>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<mes>' || to_char(r_notaCabecera.fec_emis,'mm') || '</mes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<ano>' || to_char(r_notaCabecera.fec_emis,'yyyy') || '</ano>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<pag>Pag. '|| pag || ' / ' || l_totalPaginas || '</pag>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<camref>'||  r_notaCabecera.COD_PERI_REFE || '</camref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numdocref>'||  r_notaCabecera.VAL_NUME_SOLI_REFE || '</numdocref>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numcodint>'||  r_notaCabecera.NUM_DOCU_CONT_INTE || '</numcodint>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<numboldes>'||  r_notaCabecera.VAL_NUME_SOLI || '</numboldes>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    --
                                    l_textoActual := '<codconsultora>' || r_notaCabecera.COD_CLIE || '</codconsultora>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<territorio>' || r_notaCabecera.COD_ZONA || ' - ' || r_notaCabecera.COD_TERR ||'</territorio>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<documento>' || r_notaCabecera.VAL_NUME_IDEN_FISC ||'</documento>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<nombre>' || r_notaCabecera.NOM_COMP ||'</nombre>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<campana>' || r_notaCabecera.COD_PERI ||'</campana>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    l_textoActual := '<direccion>' || r_notaCabecera.VAL_DIRE_COMP ||'</direccion>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_textoActual := '</blqcab>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                               --FIN Bloque cabecera

                               --INICIO BLOQUE DETALLE
                                l_textoActual := '<detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                OPEN c_detalleNota( r_notaCabecera.OID_CABE,l_filaInicio,l_filaFin);
                                LOOP
                                FETCH c_detalleNota INTO r_detalleNota;
                                EXIT WHEN c_detalleNota%NOTFOUND;
                                BEGIN

                                   l_textoActual := '<txt>' || r_detalleNota.NUM_UNID_ATEN || '<t/>'|| r_detalleNota.DES_PROD||'<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_CATA_UNIT_FACT,'999999999990.99')) || '<tr/> ';
                                   l_textoActual := l_textoActual || TRIM(TO_CHAR(r_detalleNota.VAL_PREC_SIN_IMPU_TOTA_FACT,'999999999990.99'));--|| '<tr/> ';

                                   l_textoActual := l_textoActual ||  '</txt>';


                                   DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                END;
                                END LOOP;
                                CLOSE c_detalleNota;
                                -- SI NOS ENCONTRAMOS EN LA ULTIMA PAGINA PONEMOS TODAS LAS UNIDADES ATENDIDAS

                                IF( pag = l_totalPaginas ) THEN
                                    l_textoActual := '<txt>-----</txt>';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_textoActual := '<txt>'|| r_notaCabecera.SUM_NUM_UNID_ATEN ||'</txt> ';
                                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                END IF;

                                -- Fin de detalle Factura
                                l_textoActual := '</detalle>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                --
                                    IF( pag = l_totalPaginas ) THEN
                                        l_textoActual := '<pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                                        l_textoActual := '<txt>SUBTOTAL PRODUCTO LINEA<t/>'||TRIM(TO_CHAR(r_notaCabecera.SUM_SIMP_TOTA_FACT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(-) DESCUENTOS<t/>'||TRIM(TO_CHAR(r_notaCabecera.VAL_DESC,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>SUBTOTAL NOTA DEBITO<t/>'|| TRIM(TO_CHAR(r_notaCabecera.SUM_PNET_TOTA_FACT,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) IMP VENTAS '|| r_notaCabecera.VAL_TASA_IMPU
                                                        ||'%<t/>'
                                                        ||TRIM(TO_CHAR(r_notaCabecera.VAL_IMPO_VENT,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt>(+) FLETES Y SERV. <t/>'||TRIM(TO_CHAR(r_notaCabecera.IMP_FLET_TOTA_LOCA,'999999999990.99'))||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<txt><t/>-------------</txt><txt>TOTAL ABONADO EN SU CTA. CTE<t/>'|| TRIM(TO_CHAR(r_notaCabecera.VAL_TOTA,'999999999990.99')) ||'</txt>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                        l_textoActual := '</pie>';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                        l_textoActual := '<total>'|| r_notaCabecera.SUM_TOTA_LETR ||'</total> ';
                                        DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    END IF;

                                 --FIN NOTA CREDIO
                                l_textoActual := '</notdeb>';
                                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                            end if;

                            auxOideCabe:= l_oidCabe;
                            l_filaInicio := l_filaInicio + TO_NUMBER(l_numFilas);
                            l_filaFin :=  l_filaFin +TO_NUMBER(l_numFilas);
                            l_procesar:=TRUE;

                   END LOOP;
           END IF;
        END;
    END LOOP;
    CLOSE c_notaCabecera;


    --
   IF(l_procesar)THEN
     FOR c_notaCreditio IN (SELECT icdc.*
                            FROM IMP_CONTR_DOCUM_CONTA icdc
                            WHERE icdc.cod_pais = p_codigoPais
                                  AND icdc.Cod_Tipo_Docu = NOTA_DEBITO) LOOP

       SELECT MAX(IMP_NOTA_CREDI_LASER.OID_CABE)
         INTO l_maxOidCabe
         FROM IMP_NOTA_CREDI_LASER
        WHERE IMP_NOTA_CREDI_LASER.COD_PAIS = p_codigoPais
          AND IMP_NOTA_CREDI_LASER.COD_TIPO_DOCU = c_notaCreditio.Cod_Tipo_Docu_Cont;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE,
              VAL_ULTI_OID_CABE = l_maxOidCabe
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU_CONT = c_notaCreditio.Cod_Tipo_Docu_Cont;

      END LOOP;

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(IMP_CONTR_DOCUM_CONTA.VAL_ULTI_OID_CABE)
                                     FROM IMP_CONTR_DOCUM_CONTA
                                    WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
                                      AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_DEBITO)
        WHERE IMP_CONTR_DOCUM_CONTA.COD_PAIS = p_codigoPais
          AND IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = NOTA_DEBITO;


  END IF;

   -- Validamos el parametro de actualizacion de numeros de documento legal
   l_indicadorActuDocuLega := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorActualizarDocumentoLegal');

  -- Dependiendo del parametro, actualizamos el numero de documento legal en las notas de credito
  IF l_indicadorActuDocuLega IS NOT NULL AND l_indicadorActuDocuLega = 'S' THEN
      IMP_PKG_PROCE_COMPA.IMP_PR_ACTUA_NUMER_DOCUM_NOTDE;
  END IF;
 EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_PAQUE_NOTA_DEBIT: '||substr(sqlerrm,1,250));
END IMP_PR_PROCE_PAQUE_NOTA_DEBIT;




/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento factura
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_DOCUM_FACTU(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);

BEGIN
    --EXECUTAMOS  EL PROCESO QUE GENERA LA INFORMACION
        IF p_codigoPais='VEL' or p_codigoPais='VEE' then
           IMP_PR_PROCE_PAQUE_DOCUM_FAC_V(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
        ELSE
           IF p_codigoPais='PAL' then
              IMP_PR_PROCE_PAQUE_DOCUM_FAC_P(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
           ELSE
              IMP_PR_PROCE_PAQUE_DOCUM_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
           END IF;
        END IF;
    --REEMPLAZAMOS CARACTERES ESPECIALES
        IMP_PR_REEMP_CARAC_DOCUM_FACTU;
    --GENERAMOS EL ARCHIVO
       if p_nombreArchivo is not null then
           IMP_PR_GENER_ARCHI_FACTU_LASER(p_codigoPais,p_nombreArchivo,p_directorio);
       end if;
EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_DOCUM_FACTU: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_DOCUM_FACTU;

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento factura
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_DOCUM_FAC_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oidzona          NUMBER
)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);

CURSOR c_cons(p_oidperi NUMBER, p_fecfact VARCHAR2, numeroLoteFacturacion NUMBER, indicadorEnvioLarissa NUMBER) IS
select a.oid_soli_cabe
from ped_solic_cabec a
where a.perd_oid_peri=p_oidperi
and a.fec_fact=to_date(p_fecfact,'dd/mm/yyyy')
and a.num_unid_aten_tota>0
and a.ind_ts_no_conso=0
AND a.IND_INTE_LARI_GENE = indicadorEnvioLarissa
AND (numeroLoteFacturacion IS NULL OR a.NUM_LOTE_FACT = numeroLoteFacturacion)
and a.zzon_oid_zona=p_oidzona
and a.tspa_oid_tipo_soli_pais in
(
select x.oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
where x.tsol_oid_tipo_soli=y.oid_tipo_soli
and y.ind_cons=1 and y.ind_soli_nega=0
)
;

r_cons c_cons%ROWTYPE;

    ln_oidperi    NUMBER(10);
    lv_fecfact   varchar2(20);

    lv_codpais   varchar2(20);
    lv_codperi   varchar2(20);
    l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
    l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
    l_numeroLoteFacturacion         NUMBER;
begin

    ln_oidperi := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(p_codigoPeriodo);



    SELECT z.cod_pais   into lv_codpais
                                   FROM cra_perio       x,
                                        seg_perio_corpo y,
                                        bas_ctrl_fact   z
                                  WHERE x.peri_oid_peri = y.oid_peri
                                    AND y.cod_peri = z.cod_peri
                                    AND z.ind_camp_act = 1
                                    AND z.sta_camp = 0;


    IF (l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN
        BEGIN
          SELECT MAX(con.num_lote_fact)
          INTO l_numeroLoteFacturacion
          FROM ped_solic_cabec con,
               int_lar_tipo_solici_pedido_dis tspd
         WHERE con.perd_oid_peri = ln_oidperi
           AND con.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
           AND con.ind_inte_lari_gene = l_indicadorEnvioLarissa
           AND con.ind_ts_no_conso = 0
           AND (con.ind_pedi_prue = 0 OR con.ind_pedi_prue IS NULL)
           AND con.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais;
           --AND con.pais_oid_pais = l_oidPais;
        EXCEPTION
        WHEN OTHERS THEN
            l_numeroLoteFacturacion := NULL;
        END;
    END IF;



    OPEN c_cons(ln_oidperi,p_fechaFacturacion,l_numeroLoteFacturacion,l_indicadorEnvioLarissa);
    LOOP
    FETCH c_cons INTO r_cons;
    EXIT WHEN c_cons%NOTFOUND;

        IF p_codigoPais='VEL' or p_codigoPais='VEE' then
           IMP_PR_PROCE_PAQUE_DOCUM_FACV2(r_cons.oid_soli_cabe);
        ELSE
            IF p_codigoPais='GTE' then
               IMP_PR_PROCE_PAQUE_DOCUM_FACG2(r_cons.oid_soli_cabe);
            ELSE
                IF p_codigoPais='PE' then
                   IMP_PR_PROCE_PAQUE_DOCUM_FACP2(r_cons.oid_soli_cabe);
                else
                IF p_codigoPais='DOL' then
                   IMP_PR_PROCE_PAQUE_DOCUM_FACDL(r_cons.oid_soli_cabe);
                else
                    IF p_codigoPais='BOE' then
                       IMP_PR_PROCE_PAQUE_DOCUM_FACBO(r_cons.oid_soli_cabe);
                    else
                        return;
                    end if;
                end if;
                END IF;
              end if;
           --IMP_PR_PROCE_PAQUE_DOCUM_FACTU(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
        END IF;
    --REEMPLAZAMOS CARACTERES ESPECIALES
    --    IMP_PR_REEMP_CARAC_DOCUM_FACTU;
    --GENERAMOS EL ARCHIVO
       --IMP_PR_GENER_ARCHI_FACTU_LASER(p_codigoPais,p_nombreArchivo,p_directorio);

    END LOOP;
    CLOSE c_cons;

EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_DOCUM_FACZ: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_DOCUM_FAC_Z;
/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota credito
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_CREDI(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);

BEGIN
    --EXECUTAMOS  EL PROCESO QUE GENERA LA INFORMACION
        IF p_codigoPais='VEL' or p_codigoPais='VEE' then
                IMP_PR_PROCE_PAQUE_NOTA_CRD_V(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
        ELSE
            if p_codigoPais='PAL' then
                IMP_PR_PROCE_PAQUE_NOTA_CRD_P(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
            else
                if p_codigoPais='BOE' then
                   IMP_PR_PROCE_PAQUE_NOTA_CRDBO(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
                else
                    NULL;   
                end if;
            end if;
        END IF;
    --REEMPLAZAMOS CARACTERES ESPECIALES
        IMP_PR_REEMP_CARAC_NOTA_CREDI;
    --GENERAMOS EL ARCHIVO
       if p_nombreArchivo is not null then
       IMP_PR_GENER_ARCHI_NOTA_CREDI(p_codigoPais,p_nombreArchivo,p_directorio);
       end if;
EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_NOTA_CREDI: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_NOTA_CREDI;

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota credito
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_CRE_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oid_zona         NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_cons IS
     SELECT CON.VAL_NUME_SOLI,
            DOC_CONT.OID_CABE,
            NVL(DOC_CONT.NUM_DOCU_LEGA, DOC_CONT.NUM_DOCU_CONT_INTE) NUM_DOCU_LEGA,
            BAS_PAIS.COD_PAIS,
            BAS_PAIS.DES_PAIS,
            DOC_CONT.FEC_FACT,
            DOC_CONT.NUM_DOCU_CONT_INTE,
            MC.OID_CLIE,
            MC.COD_CLIE,
            SEG_PERIO_CORPO.COD_PERI,
            ZON_REGIO.COD_REGI,
            ZON_ZONA.COD_ZONA,
            ZON_TERRI.COD_TERR,
            DOC_CONT.VAL_APE1 || ' ' || DOC_CONT.VAL_APE2 || ', ' ||            DOC_CONT.VAL_NOM1 || ' ' || DOC_CONT.VAL_NOM2 NOM_COMP,
            DOC_CONT.VAL_DIRE_COMP,
            DOC_CONT.VAL_NUME_IDEN_FISC,
            DOC_CONT.IMP_DESC_TOTA_LOCA,
            DOC_CONT.IMP_IMPU_TOTA_LOCA,
            DOC_CONT.IMP_FLET_TOTA_LOCA,
            DOC_CONT.VAL_TOTA_PAGA_LOCA,
            NULL COD_PERI_REFE,
            NULL VAL_NUME_SOLI_REFE,
            FAC_TIPO_DOCUM.COD_TIPO_DOCU COD_TIPO_DOCU,
            DOC_CONT.VAL_SERI_DOCU_LEGA
       FROM FAC_DOCUM_CONTA_CABEC DOC_CONT,
            FAC_TIPO_DOCUM,
            PED_SOLIC_CABEC CON,
            CRA_PERIO,
            SEG_PERIO_CORPO,
            MAE_CLIEN MC,
            BAS_PAIS,
            SEG_PAIS,
            ZON_TERRI,
            ZON_ZONA,
            ZON_REGIO
      WHERE DOC_CONT.SOCA_OID_SOLI_CABE = CON.OID_SOLI_CABE
        AND DOC_CONT.TIDO_OID_TIPO_DOCU = FAC_TIPO_DOCUM.OID_TIPO_DOCU
        AND DOC_CONT.PERD_OID_PERI = CRA_PERIO.OID_PERI
        AND CRA_PERIO.PERI_OID_PERI = SEG_PERIO_CORPO.OID_PERI
        AND CON.CLIE_OID_CLIE = MC.OID_CLIE
        AND FAC_TIPO_DOCUM.COD_TIPO_DOCU = '021'
        AND DOC_CONT.TERR_OID_TERR = ZON_TERRI.OID_TERR
        AND DOC_CONT.ZZON_OID_ZONA = ZON_ZONA.OID_ZONA
        AND DOC_CONT.ZORG_OID_REGI = ZON_REGIO.OID_REGI
        AND SEG_PAIS.OID_PAIS = DOC_CONT.PAIS_OID_PAIS
        AND BAS_PAIS.COD_PAIS = SEG_PAIS.COD_PAIS
        and con.zzon_oid_zona=p_oid_zona
        AND DOC_CONT.NUM_DOCU_CONT_INTE IS NOT NULL
        AND DOC_CONT.Num_Unid_Aten_Tota<>0
        AND DOC_CONT.OID_CABE > (SELECT icdc.val_ulti_oid_cabe
                      FROM IMP_CONTR_DOCUM_CONTA icdc
                      WHERE icdc.Cod_Tipo_Docu = 'NC');

r_cons c_cons%ROWTYPE;
    ln_oidperi    NUMBER(10);
    lv_fecfact   varchar2(20);

    lv_codpais   varchar2(20);
    lv_codperi   varchar2(20);

BEGIN
    ln_oidperi := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(p_codigoPeriodo);

    SELECT z.cod_pais   into lv_codpais
                                   FROM cra_perio       x,
                                        seg_perio_corpo y,
                                        bas_ctrl_fact   z
                                  WHERE x.peri_oid_peri = y.oid_peri
                                    AND y.cod_peri = z.cod_peri
                                    AND z.ind_camp_act = 1
                                    AND z.sta_camp = 0;


    OPEN c_cons;
    LOOP
    FETCH c_cons INTO r_cons;
    EXIT WHEN c_cons%NOTFOUND;

    --EXECUTAMOS  EL PROCESO QUE GENERA LA INFORMACION
        IF p_codigoPais='VEL' or p_codigoPais='VEE' then
                IMP_PR_PROCE_PAQUE_NOTA_CRDV2(r_cons.oid_cabe);
        ELSE
            IF p_codigoPais='GTE' then
                    IMP_PR_PROCE_PAQUE_NOTA_CRDG2(r_cons.oid_cabe);
            else
                        return;
            end if;
        END IF;
    --REEMPLAZAMOS CARACTERES ESPECIALES
    --    IMP_PR_REEMP_CARAC_NOTA_CREDI;
    --GENERAMOS EL ARCHIVO
    --   IMP_PR_GENER_ARCHI_NOTA_CREDI(p_codigoPais,p_nombreArchivo,p_directorio);

    END LOOP;
    CLOSE c_cons;


EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_NOTA_CRE_Z: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_NOTA_CRE_Z;

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota credito
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_DEBIT(p_codigoPais       VARCHAR2,
                                         p_codigoMarca      VARCHAR2,
                                         p_codigoCanal      VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_nombreArchivo    VARCHAR2,
                                         p_directorio VARCHAR2)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);

BEGIN
    --EXECUTAMOS  EL PROCESO QUE GENERA LA INFORMACION
        IMP_PR_PROCE_PAQUE_NOTA_DEBIT(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
    --REEMPLAZAMOS CARACTERES ESPECIALES
        IMP_PR_REEMP_CARAC_NOTA_DEBIT;
    --GENERAMOS EL ARCHIVO
       IMP_PR_GENER_ARCHI_NOTA_DEBIT(p_codigoPais,p_nombreArchivo,p_directorio);

EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_NOTA_DEBIT: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_NOTA_DEBIT;

/**************************************************************************
Descripcion         : Realiza el envio del archivo de documento nota credito
                      IMP-14
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_codigoPeriodo         : Codigo periodo
    p_fechaFacturacion     : Fecha Facturacion
/**************************************************************************/
PROCEDURE IMP_PR_ENVIO_PAQUE_NOTA_DEB_Z(p_codigoPais       VARCHAR2,
                                         p_codigoPeriodo    VARCHAR2,
                                         p_fechaFacturacion VARCHAR2,
                                         p_oid_zona         NUMBER)
IS
w_Filas NUMBER := 1000;
ls_sqlerrm   VARCHAR2(150);


CURSOR c_cons IS
     SELECT CON.VAL_NUME_SOLI,
            DOC_CONT.OID_CABE,
            NVL(DOC_CONT.NUM_DOCU_LEGA, DOC_CONT.NUM_DOCU_CONT_INTE) NUM_DOCU_LEGA,
            BAS_PAIS.COD_PAIS,
            BAS_PAIS.DES_PAIS,
            DOC_CONT.FEC_FACT,
            DOC_CONT.NUM_DOCU_CONT_INTE,
            MC.OID_CLIE,
            MC.COD_CLIE,
            SEG_PERIO_CORPO.COD_PERI,
            ZON_REGIO.COD_REGI,
            ZON_ZONA.COD_ZONA,
            ZON_TERRI.COD_TERR,
            DOC_CONT.VAL_APE1 || ' ' || DOC_CONT.VAL_APE2 || ', ' ||            DOC_CONT.VAL_NOM1 || ' ' || DOC_CONT.VAL_NOM2 NOM_COMP,
            DOC_CONT.VAL_DIRE_COMP,
            DOC_CONT.VAL_NUME_IDEN_FISC,
            DOC_CONT.IMP_DESC_TOTA_LOCA,
            DOC_CONT.IMP_IMPU_TOTA_LOCA,
            DOC_CONT.IMP_FLET_TOTA_LOCA,
            DOC_CONT.VAL_TOTA_PAGA_LOCA,
            NULL COD_PERI_REFE,
            NULL VAL_NUME_SOLI_REFE,
            FAC_TIPO_DOCUM.COD_TIPO_DOCU COD_TIPO_DOCU,
            DOC_CONT.VAL_SERI_DOCU_LEGA
       FROM FAC_DOCUM_CONTA_CABEC DOC_CONT,
            FAC_TIPO_DOCUM,
            PED_SOLIC_CABEC CON,
            CRA_PERIO,
            SEG_PERIO_CORPO,
            MAE_CLIEN MC,
            BAS_PAIS,
            SEG_PAIS,
            ZON_TERRI,
            ZON_ZONA,
            ZON_REGIO
      WHERE DOC_CONT.SOCA_OID_SOLI_CABE = CON.OID_SOLI_CABE
        AND DOC_CONT.TIDO_OID_TIPO_DOCU = FAC_TIPO_DOCUM.OID_TIPO_DOCU
        AND DOC_CONT.PERD_OID_PERI = CRA_PERIO.OID_PERI
        AND CRA_PERIO.PERI_OID_PERI = SEG_PERIO_CORPO.OID_PERI
        AND CON.CLIE_OID_CLIE = MC.OID_CLIE
        AND FAC_TIPO_DOCUM.COD_TIPO_DOCU = '023'
        AND DOC_CONT.TERR_OID_TERR = ZON_TERRI.OID_TERR
        AND DOC_CONT.ZZON_OID_ZONA = ZON_ZONA.OID_ZONA
        AND DOC_CONT.ZORG_OID_REGI = ZON_REGIO.OID_REGI
        AND SEG_PAIS.OID_PAIS = DOC_CONT.PAIS_OID_PAIS
        AND BAS_PAIS.COD_PAIS = SEG_PAIS.COD_PAIS
        and con.zzon_oid_zona=p_oid_zona
        AND DOC_CONT.NUM_DOCU_CONT_INTE IS NOT NULL
        AND ((DOC_CONT.IND_IMPR = 1) OR
            (DOC_CONT.IND_IMPR = 0 AND
            DOC_CONT.VAL_PREC_CATA_TOTA_LOCA < 0))
        AND DOC_CONT.OID_CABE > (SELECT icdc.val_ulti_oid_cabe
                      FROM IMP_CONTR_DOCUM_CONTA icdc
                      WHERE icdc.Cod_Tipo_Docu = 'ND');

r_cons c_cons%ROWTYPE;
    ln_oidperi    NUMBER(10);
    lv_fecfact   varchar2(20);

    lv_codpais   varchar2(20);
    lv_codperi   varchar2(20);

BEGIN
    ln_oidperi := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(p_codigoPeriodo);

    SELECT z.cod_pais   into lv_codpais
                                   FROM cra_perio       x,
                                        seg_perio_corpo y,
                                        bas_ctrl_fact   z
                                  WHERE x.peri_oid_peri = y.oid_peri
                                    AND y.cod_peri = z.cod_peri
                                    AND z.ind_camp_act = 1
                                    AND z.sta_camp = 0;


    OPEN c_cons;
    LOOP
    FETCH c_cons INTO r_cons;
    EXIT WHEN c_cons%NOTFOUND;

    --EXECUTAMOS  EL PROCESO QUE GENERA LA INFORMACION
        IF p_codigoPais='VEL' or p_codigoPais='VEE' then
                IMP_PR_PROCE_PAQUE_NOTA_CRDV2(r_cons.oid_cabe);
    --    ELSE
    --            IMP_PR_PROCE_PAQUE_NOTA_CREDI(p_codigoPais,p_codigoMarca,p_codigoCanal,p_codigoPeriodo,p_fechaFacturacion);
        END IF;
    --REEMPLAZAMOS CARACTERES ESPECIALES
    --    IMP_PR_REEMP_CARAC_NOTA_CREDI;
    --GENERAMOS EL ARCHIVO
    --   IMP_PR_GENER_ARCHI_NOTA_CREDI(p_codigoPais,p_nombreArchivo,p_directorio);

    END LOOP;
    CLOSE c_cons;


EXCEPTION
  WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_PAQUE_NOTA_DEB_Z: '||substr(sqlerrm,1,250));
END IMP_PR_ENVIO_PAQUE_NOTA_DEB_Z;

/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_DOCUM_FACTU IS

-- Variables a utilizar
l_clob              CLOB;

CURSOR c_paquetes IS
SELECT COD_CLIE,
       XML_LASE_FACT
FROM IMP_PAQUE_DOCUM_LASER_FACTU;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
        OPEN c_caracteres;
        LOOP
        FETCH c_caracteres INTO r_caracteres;
        EXIT WHEN c_caracteres%NOTFOUND;

            l_startPos := 1;
            l_longitud := LENGTH(r_caracteres.VAL_REEM);
            l_pos := INSTR(r_paquetes.XML_LASE_FACT, r_caracteres.VAL_CARA, l_startPos);
            WHILE(l_pos != 0) LOOP

                SELECT XML_LASE_FACT
                INTO l_clob
                FROM IMP_PAQUE_DOCUM_LASER_FACTU
                WHERE COD_CLIE = r_paquetes.COD_CLIE
                FOR UPDATE;

                -- Reemplazamos el texto en el clob
                IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                l_startPos := l_pos + l_longitud;
                l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
            END LOOP;
        END LOOP;
        CLOSE c_caracteres;
        COMMIT;

    END LOOP;
    CLOSE c_paquetes;

END IMP_PR_REEMP_CARAC_DOCUM_FACTU;


/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_NOTA_CREDI IS

-- Variables a utilizar
l_clob              CLOB;

CURSOR c_paquetes IS
SELECT COR_NOTA_CRED,
       XML_NOTA_CRED
FROM IMP_NOTA_CREDI_LASER;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
        OPEN c_caracteres;
        LOOP
        FETCH c_caracteres INTO r_caracteres;
        EXIT WHEN c_caracteres%NOTFOUND;

            l_startPos := 1;
            l_longitud := LENGTH(r_caracteres.VAL_REEM);
            l_pos := INSTR(r_paquetes.XML_NOTA_CRED, r_caracteres.VAL_CARA, l_startPos);
            WHILE(l_pos != 0) LOOP

                SELECT XML_NOTA_CRED
                INTO l_clob
                FROM IMP_NOTA_CREDI_LASER
                WHERE COR_NOTA_CRED = r_paquetes.COR_NOTA_CRED
                FOR UPDATE;

                -- Reemplazamos el texto en el clob
                IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                l_startPos := l_pos + l_longitud;
                l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
            END LOOP;
        END LOOP;
        CLOSE c_caracteres;
        COMMIT;

    END LOOP;
    CLOSE c_paquetes;

END IMP_PR_REEMP_CARAC_NOTA_CREDI;

/**************************************************************************
Descripcion         : Proceso que reemplaza los caracteres especiales
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
***************************************************************************/
PROCEDURE IMP_PR_REEMP_CARAC_NOTA_DEBIT IS

-- Variables a utilizar
l_clob              CLOB;

CURSOR c_paquetes IS
SELECT COR_NOTA_DEBI,
       XML_NOTA_DEBI
FROM IMP_NOTA_DEBIT_LASER;

r_paquetes c_paquetes%ROWTYPE;

CURSOR c_caracteres IS
SELECT VAL_CARA, VAL_REEM
FROM IMP_CARAC_REEMP
WHERE EST_CARE = '1'
ORDER BY ORD_REEM;

r_caracteres c_caracteres%ROWTYPE;

l_pos    NUMBER := 1;
l_startPos   NUMBER := 1;
l_longitud   NUMBER;

BEGIN

    /* Iteramos sobre cada una de las lineas del paquete documentario */
    OPEN c_paquetes;
    LOOP
    FETCH c_paquetes INTO r_paquetes;
    EXIT WHEN c_paquetes%NOTFOUND;

        /* Iteramos sobre cada uno de los caracteres especiales a reemplazar */
        OPEN c_caracteres;
        LOOP
        FETCH c_caracteres INTO r_caracteres;
        EXIT WHEN c_caracteres%NOTFOUND;

            l_startPos := 1;
            l_longitud := LENGTH(r_caracteres.VAL_REEM);
            l_pos := INSTR(r_paquetes.XML_NOTA_DEBI, r_caracteres.VAL_CARA, l_startPos);
            WHILE(l_pos != 0) LOOP

                SELECT XML_NOTA_DEBI
                INTO l_clob
                FROM IMP_NOTA_DEBIT_LASER
                WHERE COR_NOTA_DEBI = r_paquetes.COR_NOTA_DEBI
                FOR UPDATE;

                -- Reemplazamos el texto en el clob
                IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, r_caracteres.VAL_CARA, r_caracteres.VAL_REEM, l_startPos);

                l_startPos := l_pos + l_longitud;
                l_pos := INSTR(l_clob, r_caracteres.VAL_CARA, l_startPos);
            END LOOP;
        END LOOP;
        CLOSE c_caracteres;
        COMMIT;

    END LOOP;
    CLOSE c_paquetes;

END IMP_PR_REEMP_CARAC_NOTA_DEBIT;


/**************************************************************************
Descripcion         : Genera el archivo de nota de credito
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_FACTU_LASER(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2) IS

CURSOR c_paquete(p_inicio VARCHAR, p_fin VARCHAR) IS
select p_inicio || x.XML_LASE_FACT || p_fin xml_paqu_docu
from imp_paque_docum_laser_factu x
order by x.COD_CLIE;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

l_iniciodocu                VARCHAR2(100);
l_findocu                VARCHAR2(100);

l_auto                   VARCHAR2(100);
l_leyenda                   VARCHAR2(255);
l_fecha                  DATE;

BEGIN

     l_iniciodocu:=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tagInicio'),'<pd>');
     l_findocu:=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tagFin'),'</pd>');

        IMP_PR_REEMP_CARAC_DOCUM_FACTU;

    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';
    
    if p_codigoPais='BOE' then
       
       SELECT a.val_nume_auto, a.fec_limi, a.val_obse
      INTO l_auto, l_fecha, l_leyenda
      FROM fac_docum_subac a
     WHERE a.tido_oid_tipo_docu = 1
       AND a.sbac_oid_sbac = 888;
       
       l_inicioArchivo:='<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<EnvioFAC>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<SetFacturas>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<DosificacionFacturas>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<NumeroAutorizacion>' || l_auto || '</NumeroAutorizacion>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<FechaLimiteEmision>' || to_char(l_fecha,'yyyymmdd') || '</FechaLimiteEmision>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<LeyendaDeFactura>' || l_leyenda || '</LeyendaDeFactura>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '</DosificacionFacturas>';

       l_finArchivo    := '</SetFacturas></EnvioFAC>';
       
       l_iniciodocu := '';
       l_findocu := '';
       
    end if;

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete(l_iniciodocu,l_findocu);
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_FACTU_LASER: '||substr(sqlerrm,1,250));

END IMP_PR_GENER_ARCHI_FACTU_LASER;


/**************************************************************************
Descripcion         : Genera el archivo de nota de credito
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_NOTA_CREDI(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2) IS

CURSOR c_paquete(p_inicio VARCHAR, p_fin VARCHAR) IS
select p_inicio || x.XML_NOTA_CRED || p_fin xml_paqu_docu
from imp_nota_credi_laser x
order by x.num_docu_cont_inte;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

l_iniciodocu                VARCHAR2(100);
l_findocu                VARCHAR2(100);

l_auto                   VARCHAR2(100);
l_fecha                  DATE;
l_leyenda                   VARCHAR2(255);


BEGIN
   IMP_PR_REEMP_CARAC_NOTA_CREDI;

     l_iniciodocu:=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tagInicio'),'<pd>');
     l_findocu:=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tagFin'),'</pd>');


    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    if p_codigoPais='BOE' then

       SELECT a.val_nume_auto, a.fec_limi, a.val_obse
      INTO l_auto, l_fecha, l_leyenda
      FROM fac_docum_subac a
     WHERE a.tido_oid_tipo_docu = 32
       AND a.sbac_oid_sbac = 888;

       
       l_inicioArchivo:='<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<EnvioNCD>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<SetNotasCD>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<DosificacionNotasCD>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<NumeroAutorizacion>' || l_auto || '</NumeroAutorizacion>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<FechaLimiteEmision>' || to_char(l_fecha,'yyyymmdd') || '</FechaLimiteEmision>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '<LeyendaDeNotasCD>' || l_leyenda || '</LeyendaDeNotasCD>' || l_cambioLineaRetornoCarro;
       l_inicioArchivo := l_inicioArchivo || '</DosificacionNotasCD>';

       l_finArchivo    := '</SetNotasCD></EnvioNCD>';
       
       l_iniciodocu := '';
       l_findocu := '';
       
    end if;


    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete(l_iniciodocu,l_findocu);
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);


       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ANTE_OID_CABE = VAL_ULTI_OID_CABE
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = 'NC';

       UPDATE IMP_CONTR_DOCUM_CONTA
          SET VAL_ULTI_OID_CABE = (SELECT MAX(x.oid_cabe)
                                     FROM imp_nota_credi_laser x
                                    )
        WHERE IMP_CONTR_DOCUM_CONTA.COD_TIPO_DOCU = 'NC';



EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_NOTA_CREDI: '||substr(sqlerrm,1,250));

END IMP_PR_GENER_ARCHI_NOTA_CREDI;


/**************************************************************************
Descripcion         : Genera el archivo de documento nota de debito
Fecha Creacion      : 10/11/2011
Autor               : Sergio Buchelli
Parametros Entrada  :
    p_codigoPais            : Codigo del pais.
    p_nombreArchivo         : Nombre del archivo de texto.
    p_directorio            : Ruta de generacion del archivo.
***************************************************************************/
PROCEDURE IMP_PR_GENER_ARCHI_NOTA_DEBIT(p_codigoPais VARCHAR2,
                                         p_nombreArchivo VARCHAR2,
                                         p_directorio VARCHAR2) IS

CURSOR c_paquete IS
select '<pd>' || x.XML_NOTA_DEBI || '</pd>' xml_paqu_docu
from imp_nota_debit_laser x
order by x.COD_CLIE;

r_paquete c_paquete%ROWTYPE;

-- Variables para la escritura del archivo
l_output         UTL_FILE.file_type;
l_amt            NUMBER DEFAULT 4000;
l_offset         NUMBER DEFAULT 1;
l_length         NUMBER := 0 ;
x                VARCHAR2(32000);

-- Variable a contener el mensaje de la excepcion a lanzar
l_mensajeError              VARCHAR2(500);
l_inicioArchivo             VARCHAR2(500);
l_finArchivo                VARCHAR2(500);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);

BEGIN
        IMP_PR_REEMP_CARAC_NOTA_DEBIT;

    -- Creamos la referencia al archivo
    l_output := UTL_FILE.fopen (p_directorio, p_nombreArchivo, 'wb', 32760);

    -- Creamos las cadenas de inicio y fin del archivo
    l_inicioArchivo := '<?xml version="1.0" encoding="iso-8859-1"?>' || l_cambioLineaRetornoCarro;
    l_inicioArchivo := l_inicioArchivo || '<spoolpd>' || l_cambioLineaRetornoCarro;
    l_finArchivo    := '</spoolpd>';

    -- Escribimos los caracteres de inicio de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_inicioArchivo), TRUE);

    -- Iteramos sobre el cursor
    OPEN c_paquete;
    LOOP
        FETCH c_paquete INTO r_paquete;
        EXIT WHEN c_paquete%NOTFOUND;
        l_length := DBMS_LOB.GETLENGTH(r_paquete.xml_paqu_docu);
        l_offset := 1;
        l_amt := 4000;

        -- Escribimos los bloques en el archivo
        WHILE (l_offset <= l_length) LOOP
            IF (l_amt > (l_length - l_offset)) THEN l_amt := l_length - l_offset + 1; END IF;
            dbms_lob.read (r_paquete.xml_paqu_docu, l_amt, l_offset, x);
            UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(x), TRUE);
            l_offset := l_offset + l_amt;
            x := null;
        END LOOP;

        -- Escribimos el salto de linea
        UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_cambioLineaRetornoCarro), TRUE);

    END LOOP;

    -- Cerramos el cursor
    CLOSE c_paquete;

    -- Escribimos los caracteres de fin de archivo
    UTL_FILE.PUT_raw(l_output, utl_raw.cast_to_raw(l_finArchivo), TRUE);

    -- Cerramos el archivo
    UTL_FILE.fclose (l_output);

EXCEPTION
WHEN UTL_FILE.INTERNAL_ERROR THEN
    l_mensajeError:= 'ERROR INTERNO DEL MANEJADOR DE ARCHIVOS';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
    l_mensajeError:= 'EL ARCHIVO NO ESTA ABIERTO O NO ES VALIDO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_MODE THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.WRITE_ERROR THEN
       l_mensajeError:= 'ERROR AL ESCRIBIR EN EL ARCHIVO O NO HAY ESPACIO EN DISCO';
       RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_OPERATION THEN
    l_mensajeError:= 'MODO INVALIDO AL ABRIR EL ARCHIVO';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN UTL_FILE.INVALID_PATH THEN
    l_mensajeError:= 'ERROR EN LA RUTA DEL ARCHIVO, ARCHIVO NO ES ACCESIBLE';
    RAISE_APPLICATION_ERROR(-20123, l_mensajeError);

WHEN OTHERS THEN
     RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_GENER_ARCHI_NOTA_DEBIT: '||substr(sqlerrm,1,250));

END IMP_PR_GENER_ARCHI_NOTA_DEBIT;

/***************************************************************************
 Descripcion       : Genera Interfaz de Envio Almacen
 Fecha Creacion    : 22/11/2011
 Autor             : Jose Luis Rodriguez
 ***************************************************************************/
PROCEDURE imp_pr_envio_almac(
  pscodigopais     VARCHAR2,
  pscodigosistema  VARCHAR2,
  pscodigointerfaz VARCHAR2,
  psnombrearchivo  VARCHAR2 )
IS

  CURSOR c_interfaz IS
    SELECT b.cod_zona,
           nvl((SELECT liac_oid_conf_lafp_cabe
                  FROM ape_confi_liafp_detal
                 WHERE zzon_oid_zona = oid_zona),1) Almacen
      FROM zon_zona b
     WHERE b.ind_acti = 1;

  TYPE interfazrec IS RECORD(
    codigoZona    zon_zona.cod_zona%TYPE,
    almacen       VARCHAR2(1)
  );

  TYPE interfazrectab IS TABLE OF interfazrec;
  interfazrecord interfazrectab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
  ln_sqlcode     NUMBER(10);
  ls_sqlerrm     VARCHAR2(1000);

BEGIN

  /* Generando Archivo de Texto (Detalle) */
  lbAbrirUtlFile := TRUE;

  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo,
                                                 V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazRecord.COUNT > 0 THEN
          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

            lsLinea :=  interfazRecord(x).codigoZona           ||';'||
                        interfazRecord(x).almacen;

            UTL_FILE.PUT_LINE (V_HANDLE, lslinea);

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
    utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,250);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_ENVIO_ALMAC: '||ls_sqlerrm);
END imp_pr_envio_almac;

/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Jorge Yepez
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC_Z(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_oidZona NUMBER
                                   , p_fechaFacturacion IN VARCHAR2)
IS

  W_FILAS       NUMBER := 1000 ;
  l_oidPeriodo  NUMBER;
  l_oidPais     NUMBER;
  l_oidCanal    NUMBER;
  l_oidMarca    NUMBER;
  l_indicadorEnvioLarissa         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
  l_indicadorEnvioUltimoLote      VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
  l_numeroLoteFacturacion         NUMBER;

CURSOR c_consolidados(oidPeriodo NUMBER,
                      oidRegi NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       con.num_lote_fact
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  and (l_numeroLoteFacturacion is null or con.num_lote_fact = l_numeroLoteFacturacion)
  AND CON.PERD_OID_PERI = oidPeriodo
  AND ZON.Oid_Zona = oidRegi
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  )
ORDER BY MC.COD_CLIE,
         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    num_lote_fact           ped_solic_cabec.num_lote_fact%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;


lsValor BAS_PARAM_PAIS.VAL_PARA%TYPE;
-- Variables locales

BEGIN

    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);

    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    BEGIN
        SELECT VAL_PARA into lsValor
        FROM BAS_PARAM_PAIS
        WHERE COD_PAIS= p_codigoPais
         AND COD_SIST = 'MSG'
          AND COD_PARA='003';
    EXCEPTION
      WHEN OTHERS  THEN
           lsValor :='';
   END;
    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, p_oidZona);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                 if(lsValor = 1) then
                    IMP_PR_PROCE_ULTIM_NOTIC_CORPO(r_consolidado(i).oid_clie, r_consolidado(i).oid_soli_cabe,r_consolidado(i).num_lote_fact);
                 else
                IMP_PR_PROCE_ULTIM_NOTIC(r_consolidado(i).oid_clie, r_consolidado(i).oid_soli_cabe,r_consolidado(i).num_lote_fact);
                 end if;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;
 COMMIT;
END IMP_PR_PROCE_ULTIM_NOTIC_Z;

/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias.
Fecha Creacion      : 11/05/2010
Fecha Modificacion  : 11/05/2010
Autor               : Jorge Yepez
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC(p_oidclie IN NUMBER, p_oidsoli IN NUMBER, p_numlotefact IN VARCHAR2
                                   )
IS

  W_FILAS             NUMBER := 1000 ;
  ls_patron           NUMBER(12);
  ls_codpatr_antg           VARCHAR(100):=' ';
  ls_codsecc_antg           VARCHAR(100):=' ';
  ls_vallite_antg           VARCHAR(100):=' ';
  ls_mensaje                VARCHAR(10000):=' ';
  ls_mensbloq               VARCHAR(10000):=' ';
  ls_mensfijo               VARCHAR(10000):=' ';
  ls_mensvar                VARCHAR(10000):=' ';
  ls_menstemp                VARCHAR(10000):=' ';

  l_clob                      CLOB;
  l_indexinibloque            NUMBER;
  l_indexfinbloque            NUMBER;
  l_textoActual               VARCHAR2(20000) := '';

l_tagPuntajeLideres         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagPuntajeLideres');
l_textoOriginal VARCHAR2(200);
 l_textoReemplazo VARCHAR2(200);
 lc_xml_mens_punt CLOB;


CURSOR c_patron IS
         select a.patr_oid_patr
         --into ls_patron
         from msg_patro_perio a where a.peri_oid_peri=
         (select x.oid_peri from bas_ctrl_fact y, seg_perio_corpo x
         where y.cod_peri=x.cod_peri and y.sta_camp=0 and y.ind_camp_act=1
         );


TYPE patronrecord IS RECORD (
    patr_oid_patr                msg_patro.oid_patr%TYPE
);

TYPE patrontype IS TABLE OF patronrecord;
r_patron    patrontype;





CURSOR c_mensaje(oidPatron NUMBER) IS
          SELECT A.OID_PATR,
             substr(A.COD_PATR,1,4) COD_PATR,
             A.DES_PATR,
             A.FORS_OID_FORM,
             B.COD_FORM,
             A.MEEP_OID_MEDI_ENVI_PAIS,
             D.DES_MEDI_ENVI,
             A.IND_ACTI,
             A.IND_PATR_PERI,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.PATR_OID_PATR_ORIG
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) PATR_OID_PATR_ORIG,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.PERI_OID_PERI
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) PERI_OID_PERI,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.OID_PATR_PERI
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) OID_PATR_PERI,
             A.PAIS_OID_PAIS,
             F.PATR_OID_PATR,
             F.OID_PATR_SECC,
             F.COD_SECC,
             F.NUM_ORDE_SECC,
             F.METC_OID_META,
             G.VAL_LITE_IDEN,
             H.VAL_I18N,
             I.MENS_OID_MENS,
             I.NUM_ORDE_IMPR,
             J.VAL_TEXT,
             j.tmen_oid_tipo_mens
        FROM MSG_PATRO            A,
             FAC_FORMU            B,
             MSG_MEDIO_ENVIO_PAIS C,
             MSG_MEDIO_ENVIO      D,
             MSG_PATRO_SECCI      F,
             MSG_METAC            G,
             V_GEN_I18N_SICC      H,
             MSG_PATRO_MENSA      I,
             MSG_MENSA            J
       WHERE A.OID_PATR = oidPatron
         AND A.IND_ACTI = 1
         AND B.OID_FORM = A.FORS_OID_FORM
         AND C.OID_MEDI_ENVI_PAIS = A.MEEP_OID_MEDI_ENVI_PAIS
         AND D.OID_MEDI_ENVI = C.MEEN_OID_MEDI_ENVI
         AND F.PATR_OID_PATR = A.OID_PATR
         AND F.METC_OID_META = G.OID_META(+)
         AND G.OID_META = H.VAL_OID(+)
         AND H.ATTR_ENTI(+) = 'MSG_METAC'
         AND H.IDIO_OID_IDIO(+) = 1
         AND I.PASE_OID_PATR_SECC = F.OID_PATR_SECC
         AND J.OID_MENS = I.MENS_OID_MENS
         and imp_fn_mens_ua_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_marca_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_lista_clie(p_oidclie, j.oid_mens,p_oidsoli)=1
         and imp_fn_mens_tipo_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_cuv_clie(p_oidsoli, j.oid_mens)=1
         and imp_fn_mens_pedid_clie(p_oidsoli, j.oid_mens)=1
       ORDER BY F.NUM_ORDE_SECC, I.NUM_ORDE_IMPR;


TYPE mensajerecord IS RECORD (
    oid_patr                msg_patro.oid_patr%TYPE,
    cod_patr                msg_patro.cod_patr%TYPE,
    des_patr                msg_patro.des_patr%TYPE,
    FORS_OID_FORM           msg_patro.FORS_OID_FORM%TYPE,
    cod_form                fac_formu.cod_form%TYPE,
    MEEP_OID_MEDI_ENVI_PAIS msg_patro.MEEP_OID_MEDI_ENVI_PAIS%TYPE,
    DES_MEDI_ENVI           MSG_MEDIO_ENVIO.DES_MEDI_ENVI%TYPE,
    IND_ACTI                msg_patro.IND_ACTI%TYPE,
    IND_PATR_PERI           msg_patro.IND_PATR_PERI%TYPE,
    PATR_OID_PATR_ORIG      MSG_PATRO_PERIO.PATR_OID_PATR_ORIG%TYPE,
    PERI_OID_PERI           MSG_PATRO_PERIO.PERI_OID_PERI%TYPE,
    OID_PATR_PERI           MSG_PATRO_PERIO.OID_PATR_PERI%TYPE,
    PAIS_OID_PAIS           msg_patro.PAIS_OID_PAIS%TYPE,
    PATR_OID_PATR           MSG_PATRO_SECCI.PATR_OID_PATR%TYPE,
    OID_PATR_SECC           MSG_PATRO_SECCI.OID_PATR_SECC%TYPE,
    COD_SECC                MSG_PATRO_SECCI.COD_SECC%TYPE,
    NUM_ORDE_SECC           MSG_PATRO_SECCI.NUM_ORDE_SECC%TYPE,
    METC_OID_META           MSG_PATRO_SECCI.METC_OID_META%TYPE,
    VAL_LITE_IDEN           MSG_METAC.VAL_LITE_IDEN%TYPE,
    VAL_I18N                GEN_I18N_SICC_PAIS.VAL_I18N%TYPE,
    MENS_OID_MENS           MSG_PATRO_MENSA.MENS_OID_MENS%TYPE,
    NUM_ORDE_IMPR           MSG_PATRO_MENSA.NUM_ORDE_IMPR%TYPE,
    VAL_TEXT                MSG_MENSA.VAL_TEXT%TYPE,
    tmen_oid_tipo_mens      MSG_MENSA.tmen_oid_tipo_mens%TYPE
);

TYPE mensajetype IS TABLE OF mensajerecord;
r_mensaje    mensajetype;




CURSOR c_buzon(p_oidmens NUMBER,p_oidclie NUMBER,p_oidsoli NUMBER) IS
          SELECT A.Oid_Buzo_Mens,
          a.dato_vari_01,
          a.dato_vari_02,
          a.dato_vari_03,
          a.dato_vari_04,
          a.dato_vari_05,
          a.dato_vari_06,
          a.dato_vari_07,
          a.dato_vari_08,
          a.dato_vari_09,
          a.dato_vari_10,
          a.dato_vari_11,
          a.dato_vari_12,
          a.dato_vari_13,
          a.dato_vari_14,
          a.dato_vari_15,
          a.dato_vari_16,
          a.dato_vari_17,
          a.dato_vari_18,
          a.dato_vari_19,
          a.dato_vari_20
        FROM MSG_BUZON_MENSA A
       WHERE A.Mens_Oid_Mens=p_oidmens
       and (a.peri_oid_peri is null or a.peri_oid_peri=(select peri_oid_peri from cra_perio where oid_peri=(select perd_oid_peri from ped_solic_cabec where oid_soli_cabe=p_oidsoli)))
       AND a.clie_oid_clie=p_oidclie
       and (a.ind_acti=1 or a.num_lote_impr=p_numlotefact)
       ;


TYPE buzonrecord IS RECORD (
    oid_buzo_mens           msg_buzon_mensa.oid_buzo_mens%TYPE,
    dato_vari_01            msg_buzon_mensa.dato_vari_01%TYPE,
    dato_vari_02            msg_buzon_mensa.dato_vari_02%TYPE,
    dato_vari_03            msg_buzon_mensa.dato_vari_03%TYPE,
    dato_vari_04            msg_buzon_mensa.dato_vari_04%TYPE,
    dato_vari_05            msg_buzon_mensa.dato_vari_05%TYPE,
    dato_vari_06            msg_buzon_mensa.dato_vari_06%TYPE,
    dato_vari_07            msg_buzon_mensa.dato_vari_07%TYPE,
    dato_vari_08            msg_buzon_mensa.dato_vari_08%TYPE,
    dato_vari_09            msg_buzon_mensa.dato_vari_09%TYPE,
    dato_vari_10            msg_buzon_mensa.dato_vari_10%TYPE,
    dato_vari_11            msg_buzon_mensa.dato_vari_11%TYPE,
    dato_vari_12            msg_buzon_mensa.dato_vari_12%TYPE,
    dato_vari_13            msg_buzon_mensa.dato_vari_13%TYPE,
    dato_vari_14            msg_buzon_mensa.dato_vari_14%TYPE,
    dato_vari_15            msg_buzon_mensa.dato_vari_15%TYPE,
    dato_vari_16            msg_buzon_mensa.dato_vari_16%TYPE,
    dato_vari_17            msg_buzon_mensa.dato_vari_17%TYPE,
    dato_vari_18            msg_buzon_mensa.dato_vari_18%TYPE,
    dato_vari_19            msg_buzon_mensa.dato_vari_19%TYPE,
    dato_vari_20            msg_buzon_mensa.dato_vari_20%TYPE
);

TYPE buzontype IS TABLE OF buzonrecord;
r_buzon    buzontype;

BEGIN

    --Se inicializa la variabla CLOB en Memoria
    DBMS_LOB.CREATETEMPORARY(l_clob, TRUE);

    /*INSERT INTO IMP_PAQUE_DOCUM_UNOT (
    COR_UNOT,
    COD_CLIE,
    VAL_NUME_SOLI,
    XML_UNOT)
    VALUES(
    p_oidsoli,
    (select cod_clie from mae_clien where oid_clie=p_oidclie),
    (select val_nume_soli from ped_solic_cabec where oid_soli_cabe=p_oidsoli),
    EMPTY_CLOB())
    RETURNING XML_UNOT INTO l_clob;*/



-- Abrimos el cursor de patrones del periodo
OPEN c_patron;
LOOP
    FETCH c_patron BULK COLLECT
    INTO r_patron LIMIT w_filas;

    IF  r_patron.COUNT > 0 THEN

        FOR y IN r_patron.FIRST..r_patron.LAST
        LOOP



    -- Abrimos el cursor principal
    OPEN c_mensaje(r_patron(y).patr_oid_patr);
    LOOP
        FETCH c_mensaje BULK COLLECT
        INTO r_mensaje LIMIT w_filas;

        IF  r_mensaje.COUNT > 0 THEN

            FOR i IN r_mensaje.FIRST..r_mensaje.LAST
            LOOP

                l_textoActual:='';

                -- Cerramos el patron
                if r_mensaje(i).cod_patr<>ls_codpatr_antg and i<>1 then
                  l_textoActual := l_textoActual || '</' || ls_codpatr_antg || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- Abrimos el patron
                if r_mensaje(i).cod_patr<>ls_codpatr_antg then
                  l_textoActual := l_textoActual || '<' || substr(r_mensaje(i).cod_patr,1,4) || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- cerramos la seccion
                if r_mensaje(i).cod_secc<>ls_codsecc_antg and ls_codsecc_antg<>' ' then
                  l_textoActual := l_textoActual || '</' || ls_vallite_antg || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- Abrimos la seccion
                if r_mensaje(i).cod_secc<>ls_codsecc_antg then
                  l_textoActual := l_textoActual || '<' || r_mensaje(i).VAL_LITE_IDEN || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                ls_mensaje:=r_mensaje(i).VAL_TEXT;
                select instr(ls_mensaje,'<fijo>') into l_indexinibloque from dual;
                select instr(ls_mensaje,'<fijo>',l_indexinibloque+1) into l_indexfinbloque from dual;

                if r_mensaje(i).tmen_oid_tipo_mens = 2 then
                  l_textoActual := l_textoActual || ls_mensaje;
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                else

                      for x in 0..l_indexfinbloque loop

                        if l_indexinibloque=0 then
                           ls_mensbloq:=ls_mensaje;
                           ls_mensfijo:='';
                           ls_mensvar:=ls_mensaje;
                        else
                           select substr(ls_mensaje,instr(ls_mensaje,'<fijo>'), instr(ls_mensaje,'<fijo>',2)-1)
                           into ls_mensbloq from dual;

                            select substr(ls_mensbloq,instr(ls_mensbloq,'<fijo>')+length('<fijo>'), instr(ls_mensbloq,'</fijo>')-length('<fijo>')-1)
                            into ls_mensfijo from dual;

                            select substr(ls_mensbloq,instr(ls_mensbloq,'</fijo>')+length('</fijo>'))
                            into ls_mensvar from dual;

                        end if;


                        if ls_mensvar is not null then

                        OPEN c_buzon(r_mensaje(i).mens_oid_mens,p_oidclie,p_oidsoli);
                        LOOP
                            FETCH c_buzon BULK COLLECT
                            INTO r_buzon LIMIT w_filas;

                            IF  r_buzon.COUNT > 0 THEN

                                -- Se inserta la parte fija
                                if ls_mensfijo is not null then
                                  l_textoActual := l_textoActual || ls_mensfijo;
                                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                end if;


                                FOR j IN r_buzon.FIRST..r_buzon.LAST
                                LOOP
                                    ls_menstemp:=ls_mensvar;

                                    if instr(ls_menstemp,'<DATO01>')>0 then
                                       select replace(ls_menstemp,'<DATO01>', r_buzon(j).dato_vari_01) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO02>')>0 then
                                       select replace(ls_menstemp,'<DATO02>', r_buzon(j).dato_vari_02) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO03>')>0 then
                                       select replace(ls_menstemp,'<DATO03>', r_buzon(j).dato_vari_03) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO04>')>0 then
                                       select replace(ls_menstemp,'<DATO04>', r_buzon(j).dato_vari_04) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO05>')>0 then
                                       select replace(ls_menstemp,'<DATO05>', r_buzon(j).dato_vari_05) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO06>')>0 then
                                       select replace(ls_menstemp,'<DATO06>', r_buzon(j).dato_vari_06) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO07>')>0 then
                                       select replace(ls_menstemp,'<DATO07>', r_buzon(j).dato_vari_07) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO08>')>0 then
                                       select replace(ls_menstemp,'<DATO08>', r_buzon(j).dato_vari_08) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO09>')>0 then
                                       select replace(ls_menstemp,'<DATO09>', r_buzon(j).dato_vari_09) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO10>')>0 then
                                       select replace(ls_menstemp,'<DATO10>', r_buzon(j).dato_vari_10) into ls_menstemp from dual;
                                    end if;

                                    if instr(ls_menstemp,'<DATO11>')>0 then
                                       select replace(ls_menstemp,'<DATO11>', r_buzon(j).dato_vari_11) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO12>')>0 then
                                       select replace(ls_menstemp,'<DATO12>', r_buzon(j).dato_vari_12) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO13>')>0 then
                                       select replace(ls_menstemp,'<DATO13>', r_buzon(j).dato_vari_13) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO14>')>0 then
                                       select replace(ls_menstemp,'<DATO14>', r_buzon(j).dato_vari_14) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO15>')>0 then
                                       select replace(ls_menstemp,'<DATO15>', r_buzon(j).dato_vari_15) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO16>')>0 then
                                       select replace(ls_menstemp,'<DATO16>', r_buzon(j).dato_vari_16) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO17>')>0 then
                                       select replace(ls_menstemp,'<DATO17>', r_buzon(j).dato_vari_17) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO18>')>0 then
                                       select replace(ls_menstemp,'<DATO18>', r_buzon(j).dato_vari_18) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO19>')>0 then
                                       select replace(ls_menstemp,'<DATO19>', r_buzon(j).dato_vari_19) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO20>')>0 then
                                       select replace(ls_menstemp,'<DATO20>', r_buzon(j).dato_vari_20) into ls_menstemp from dual;
                                    end if;

                                    -- Se inserta la parte variable
                                    l_textoActual := l_textoActual || ls_menstemp;
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    update msg_buzon_mensa set ind_acti=0, num_lote_impr=p_numlotefact, fec_impr=sysdate
                                    where oid_buzo_mens=r_buzon(j).oid_buzo_mens;

                                END LOOP;

                            END IF;

                            EXIT WHEN c_buzon%NOTFOUND;
                        END LOOP;
                        -- Cerramos el cursor
                        CLOSE c_buzon;

                        end if;


                          select substr(ls_mensaje,l_indexfinbloque)into ls_mensaje from dual;
                          select instr(ls_mensaje,'<fijo>') into l_indexinibloque from dual;
                          select instr(ls_mensaje,'<fijo>',l_indexinibloque+1) into l_indexfinbloque from dual;

                         --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                        --return;
                      end loop;
                end if;
                ls_codpatr_antg:=substr(r_mensaje(i).cod_patr,1,4);
                ls_codsecc_antg:=r_mensaje(i).cod_secc;
                ls_vallite_antg:=r_mensaje(i).VAL_LITE_IDEN;
                if l_textoActual is not null then
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;
            END LOOP;
        END IF;

        EXIT WHEN c_mensaje%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_mensaje;

    -- cerramos la seccion
      if ls_vallite_antg <> ' ' then
      l_textoActual := '</' || ls_vallite_antg || '>';
      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      end if;

    -- Cerramos el patron
      if ls_codpatr_antg <> ' ' then
      l_textoActual := l_textoActual || '</' || ls_codpatr_antg || '>';
      DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      end if;


      ls_codpatr_antg           :=' ';
      ls_codsecc_antg           :=' ';
      ls_vallite_antg           :=' ';

        END LOOP;
    END IF;


    EXIT WHEN c_patron%NOTFOUND;
END LOOP;
-- Cerramos el cursor
CLOSE c_patron;

begin
select xml_mens_punt into lc_xml_mens_punt from IMP_PAQUE_DOCUM_PUNTA_OBTEN
where cod_clie=(select cod_clie from mae_clien where oid_clie=p_oidclie);
exception when others then
  lc_xml_mens_punt:=null;
end;

IF l_tagPuntajeLideres IS NOT NULL AND
   INSTR(l_clob, l_tagPuntajeLideres) != 0 AND
   LENGTH(lc_xml_mens_punt) > 0 THEN

    -- Incluimos el mensaje del puntaje de concurso de lideres
    l_textoOriginal := l_tagPuntajeLideres;
    l_textoReemplazo := l_tagPuntajeLideres || lc_xml_mens_punt;
    IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo);

END IF;

--Se inserta el CLOB en memoria a BD
INSERT INTO IMP_PAQUE_DOCUM_UNOT (
    COR_UNOT,
    COD_CLIE,
    VAL_NUME_SOLI,
    XML_UNOT)
    VALUES(
    p_oidsoli,
    (select cod_clie from mae_clien where oid_clie=p_oidclie),
    (select val_nume_soli from ped_solic_cabec where oid_soli_cabe=p_oidsoli),
    l_clob);

--Se libera la variabla CLOB de Memoria
DBMS_LOB.FREETEMPORARY(l_clob);

    COMMIT;
END IMP_PR_PROCE_ULTIM_NOTIC;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_ua_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=1;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from mae_clien_unida_admin a, msg_mensa b, msg_mensa_unida_admin c,
 zon_terri_admin d, zon_secci e, zon_terri f, zon_zona g, zon_regio h
 where a.ztad_oid_terr_admi=d.oid_terr_admi and d.zscc_oid_secc=e.oid_secc
 and d.terr_oid_terr=f.oid_terr and e.zzon_oid_zona=g.oid_zona
 and g.zorg_oid_regi=h.oid_regi and a.ind_acti=1 and a.clie_oid_clie=p_oidclie
 and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and decode(c.zorg_oid_regi, null, h.oid_regi, c.zorg_oid_regi)=h.oid_regi
 and decode(c.zzon_oid_zona, null, g.oid_zona, c.zzon_oid_zona)=g.oid_zona
 and decode(c.zscc_oid_secc, null, e.oid_secc, c.zscc_oid_secc)=e.oid_secc
 and decode(c.terr_oid_terr, null, f.oid_terr, c.terr_oid_terr)=f.oid_terr ;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_ua_clie;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_marca_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=3;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from mae_clien_marca a, msg_mensa b, msg_mensa_marca c
 where a.clie_oid_clie=p_oidclie
 and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and c.marc_oid_marc=a.marc_oid_marc;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_marca_clie;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_lista_clie(p_oidclie NUMBER, p_oidmens NUMBER, p_oidsoli NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=6;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from msg_mensa b, msg_buzon_mensa c
 where c.clie_oid_clie=p_oidclie
 and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and (c.peri_oid_peri is null or c.peri_oid_peri=(select oid_peri from seg_perio_corpo x, bas_ctrl_fact z
 where x.cod_peri=z.cod_peri and z.sta_camp=0 and z.ind_camp_act=1
 )
 and (c.ind_acti=1 or c.num_lote_impr=(select num_lote_fact from ped_solic_cabec where oid_soli_cabe=p_oidsoli))
 )
 ;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_lista_clie;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_tipo_clie(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=2;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from mae_clien_tipo_subti a, msg_mensa b, msg_mensa_tipo_clien c,
 mae_clien_clasi d
 where a.clie_oid_clie=p_oidclie and a.oid_clie_tipo_subt=d.ctsu_oid_clie_tipo_subt
 and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and decode(c.ticl_oid_tipo_clie, null, a.ticl_oid_tipo_clie, c.ticl_oid_tipo_clie)=a.ticl_oid_tipo_clie
 and decode(c.sbti_oid_subt_clie, null, a.sbti_oid_subt_clie, c.sbti_oid_subt_clie)=a.sbti_oid_subt_clie
 and decode(c.tccl_oid_tipo_clas, null, d.tccl_oid_tipo_clasi, c.tccl_oid_tipo_clas)=d.tccl_oid_tipo_clasi
 and decode(c.clas_oid_clas, null, d.tccl_oid_tipo_clasi, c.clas_oid_clas)=d.clas_oid_clas ;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_tipo_clie;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_cuv_clie(p_oidsoli NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=4;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from ped_solic_cabec a, msg_mensa b, msg_mensa_codig_venta c,
 ped_solic_cabec d, ped_solic_posic e
 where a.oid_soli_cabe=p_oidsoli and a.oid_soli_cabe=d.soca_oid_soli_cabe
 and d.oid_soli_cabe=e.soca_oid_soli_cabe
 and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and e.val_codi_vent=c.val_codi_vent
 and d.ind_oc=1;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_cuv_clie;


/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_mens_pedid_clie(p_oidsoli NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=5;

 if lstipoasig=0 then
  RETURN 1;
 end if;

 select count(1) into lscontador
 from ped_solic_cabec a,-- msg_mensa b, msg_mensa_codig_venta c,
 ped_solic_cabec d
 where a.oid_soli_cabe=p_oidsoli and a.oid_soli_cabe=d.soca_oid_soli_cabe
-- and b.oid_mens=p_oidmens and b.oid_mens=c.mens_oid_mens
 and d.ind_oc=1
 ;

 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_pedid_clie;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_direc_clie(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER
  IS

 lndirevac     NUMBER(3);
 lndiredes     NUMBER(3);
 lnoiddire     NUMBER(12);

 lscoddirevac   VARCHAR(2):=sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'COD_TIPO_DIRE_VACA');
 lscoddiredes   VARCHAR(2):=sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'COD_TIPO_DIRE_ENTR');

 BEGIN

 select count(1) into lndirevac
 from mae_clien_direc a, mae_tipo_direc b
 where a.tidc_oid_tipo_dire=b.oid_tipo_dire
 and a.clie_oid_clie=p_oidclie
 and b.cod_tipo_dire=lscoddirevac
 and a.ind_elim=0
 ;

 select count(1) into lndiredes
 from mae_clien_direc a, mae_tipo_direc b
 where a.tidc_oid_tipo_dire=b.oid_tipo_dire
 and a.clie_oid_clie=p_oidclie
 and b.cod_tipo_dire=lscoddiredes
 and a.ind_elim=0
 ;


 if lscoddirevac is not null and lndirevac>0 and imp_fn_es_clie_vaca(p_codigoPais,p_oidclie)>0  then
   select max(oid_clie_dire) into lnoiddire
   from mae_clien_direc a, mae_tipo_direc b
   where a.tidc_oid_tipo_dire=b.oid_tipo_dire
   and a.clie_oid_clie=p_oidclie
   and b.cod_tipo_dire=lscoddirevac
   and a.ind_elim=0;
 else

     if lscoddiredes is not null and lndiredes>0  then
       select max(oid_clie_dire) into lnoiddire
       from mae_clien_direc a, mae_tipo_direc b
       where a.tidc_oid_tipo_dire=b.oid_tipo_dire
       and a.clie_oid_clie=p_oidclie
       and b.cod_tipo_dire=lscoddiredes
       and a.ind_elim=0;
     else
       select max(oid_clie_dire) into lnoiddire
       from mae_clien_direc a, mae_tipo_direc b
       where a.tidc_oid_tipo_dire=b.oid_tipo_dire
       and a.clie_oid_clie=p_oidclie
       --and b.cod_tipo_dire=lscoddiredes
       and a.ind_dire_ppal=1
       and a.ind_elim=0;
     end if;

 end if;



 RETURN lnoiddire;
 END imp_fn_obtiene_direc_clie;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_text_direc(p_oiddire NUMBER, p_xml VARCHAR2) RETURN VARCHAR2
  IS

 lsvaldire     VARCHAR2(300);

l_textoObs             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoObservaciones');

l_textoCP             VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','textoCP');

 BEGIN

select substr(
       case when (select x.des_abrv_tipo_via from seg_tipo_via x where x.oid_tipo_via=dir.tivi_oid_tipo_via and rownum=1) is not null then
         (select x.des_abrv_tipo_via from seg_tipo_via x where x.oid_tipo_via=dir.tivi_oid_tipo_via and rownum=1) || ' '
       else ''
       end ||
       dir.val_nomb_via || ' ' || dir.num_ppal || ' ' ||
       dir.val_inte || ' ' || dir.val_manz || ' ' ||
       dir.val_lote || ' ' || dir.val_km || ' ' ||
       l_textoObs || dir.val_obse || ' ' || dir.val_barr || ' ' || (select x.des_ciud from zon_ciuda x where x.cod_ciud=dir.ciud_cod_ciud and x.cod_ugeo_regi=dir.ciud_cod_ugeo_regi)
        || decode(dir.ciud_cod_ciud,null,'','/')
        || decode(dir.ciud_cod_ciud,null,'',
        (select des_geog from  zon_valor_estru_geopo where orde_1=substr(dir.cod_unid_geog,1,6) and orde_2 = substr(dir.cod_unid_geog,7,6) and orde_3 = substr(dir.cod_unid_geog,13,6) and orde_4 is null)
       )
       || decode(dir.ciud_cod_ciud,null,'','/')
       || dir.des_villa_pobl || ' ' || l_textoCP || dir.val_cod_post,1,299)
       into lsvaldire
       from mae_clien_direc dir
       where dir.oid_clie_dire=p_oiddire;

 RETURN lsvaldire;
 END imp_fn_obtiene_text_direc;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_obtiene_text2_direc(p_oiddire NUMBER, p_xml VARCHAR2) RETURN VARCHAR2
  IS

 lsvaldire     VARCHAR2(300);


 BEGIN

select '/' ||
       (select des_geog from zon_valor_estru_geopo where orde_1=substr(dir.cod_unid_geog,1,6) and orde_2 is null and orde_3 is null and orde_4 is null) || '/' ||
       (select des_geog from zon_valor_estru_geopo where orde_1=substr(dir.cod_unid_geog,1,6) and orde_2 = substr(dir.cod_unid_geog,7,6) and orde_3 is null and orde_4 is null) || '/' ||
       (select des_geog from zon_valor_estru_geopo where orde_1=substr(dir.cod_unid_geog,1,6) and orde_2 = substr(dir.cod_unid_geog,7,6) and orde_3 = substr(dir.cod_unid_geog,13,6) and orde_4 is null) || '/' ||
       (select des_geog from zon_valor_estru_geopo where orde_1=substr(dir.cod_unid_geog,1,6) and orde_2 = substr(dir.cod_unid_geog,7,6) and orde_3 = substr(dir.cod_unid_geog,13,6) and orde_4 = substr(dir.cod_unid_geog,19))
       into lsvaldire
       from mae_clien_direc dir
       where dir.oid_clie_dire=p_oiddire;

 RETURN lsvaldire;
 END imp_fn_obtiene_text2_direc;

/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_es_clie_vaca(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER
  IS

 lnflgvaca     NUMBER(12);

 lstipoclasi1   VARCHAR(10):=sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_CLASI_RECAR_FLET');
 lstipoclasi2   VARCHAR(10):=sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_CLASI_REC_FLE_OF');

 BEGIN

 select count(1) into lnflgvaca
 from mae_clien_tipo_subti a, mae_clien_clasi b, mae_tipo_clasi_clien c
 where a.oid_clie_tipo_subt=b.ctsu_oid_clie_tipo_subt
 and a.clie_oid_clie=p_oidclie
 and b.tccl_oid_tipo_clasi=c.oid_tipo_clas
 and c.oid_tipo_clas in (lstipoclasi1,lstipoclasi2)
 ;

 RETURN lnflgvaca;
 END imp_fn_es_clie_vaca;

/**************************************************************************
Descripcion : Devuelve el numero de OCS a enviar a las consultoras
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_devue_num_ocs(p_codigoPais VARCHAR,p_oidclie NUMBER) RETURN NUMBER
  IS

 ln_numocs     NUMBER(12):=1;
 ln_tmp     NUMBER(12):=0;


  lsnumpediweb VARCHAR2(15) := sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,
                                                                         'NUM_WEB_NO_OCS');


 BEGIN

 select count(1) into ln_tmp
 from mae_clien_datos_adici x
 where nvl(x.num_pedi_web,0)>=nvl(lsnumpediweb,'0')
 and x.clie_oid_clie=p_oidclie;

 if ln_tmp>0 and lsnumpediweb is not null then ln_numocs:=0;
 else

     begin
     select d.num_ocs into ln_numocs
     from mae_clien_tipo_subti a
     , mae_clien_clasi b
     , lar_tipo_clien_vip d
     where a.oid_clie_tipo_subt=b.ctsu_oid_clie_tipo_subt
     and a.clie_oid_clie=p_oidclie
     and b.clas_oid_clas=d.oid_clas
     and b.tccl_oid_tipo_clasi=d.oid_tipo_clas
     ;
     exception when no_data_found then
       ln_numocs:=1;
     end;

 end if;



 RETURN ln_numocs;
 END imp_fn_devue_num_ocs;
/**************************************************************************
Descripcion : Devuelve el oid de la direccion del cliente a mostrar en los
documentos de despacho
la Hora en formato dd/mm/yyyy
Fecha Creacion : 02/07/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_xml_opor_ahor(p_codigoPeriodo VARCHAR,p_oidperi NUMBER,p_oidclie NUMBER) RETURN VARCHAR2
  IS

 lnoidperi6     NUMBER(12);

 lscodperi6   VARCHAR(10):='';

 lsxml   VARCHAR(1000):='';

CURSOR c_ahorro IS
select b.cod_peri
, (select nvl(sum(nvl(val_gana_tota_loca,0)),0) from ped_solic_cabec x, ped_tipo_solic_pais y, ped_tipo_solic z where x.perd_oid_peri=a.oid_peri and x.clie_oid_clie=p_oidclie
and x.tspa_oid_tipo_soli_pais=y.oid_tipo_soli_pais and y.tsol_oid_tipo_soli=z.oid_tipo_soli and z.cod_tipo_soli='SOC') monto
from cra_perio a, seg_perio_corpo b
where a.peri_oid_peri=b.oid_peri and a.oid_peri>=lnoidperi6 and a.oid_peri<=p_oidperi;

r_ahorro c_ahorro%ROWTYPE;


 BEGIN

    lscodperi6 := GEN_FN_CALCU_PERIO(p_codigoPeriodo, -6);
    lnoidperi6 := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(lscodperi6, 2003, 2001);

    lsxml:='<graficobar><barra>';

    -- Iteramos sobre el cursor
    OPEN c_ahorro;
    LOOP
        FETCH c_ahorro INTO r_ahorro;
        EXIT WHEN c_ahorro%NOTFOUND;
             lsxml:=lsxml || '<cmp>' || r_ahorro.cod_peri || '</cmp>';
             lsxml:=lsxml || '<monto>' || r_ahorro.monto || '</monto>';

        -- Escribimos el salto de linea

    END LOOP;
        lsxml:=lsxml || '</barra></graficobar>';

    -- Cerramos el cursor
    CLOSE c_ahorro;


    RETURN lsxml;
 END imp_fn_xml_opor_ahor;
/**************************************************************************
Descripcion : Devuelve la descripcion del producto de planit
la Hora en formato dd/mm/yyyy
Fecha Creacion : 12/12/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_desc_produ(p_codigoPais VARCHAR,p_oidprod NUMBER) RETURN VARCHAR2
  IS

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');


 lstipoDescProd   VARCHAR(10):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tipoDescProd'),'0');

 lsDescProd   VARCHAR(1000):='';


 BEGIN

      if lstipoDescProd='0' then
        select val_i18n into lsDescProd from gen_i18n_sicc_pais x
        where x.attr_enti='MAE_PRODU'
        and x.val_oid=p_oidprod;

      else
        begin

        select x.des_com into lsDescProd from ped_descr_produ x, mae_produ y
        where x.cod_sap=y.cod_sap
        and y.oid_prod=p_oidprod;

        exception when no_data_found then

        select val_i18n into lsDescProd from gen_i18n_sicc_pais x
        where x.attr_enti='MAE_PRODU'
        and x.val_oid=p_oidprod;

        end;

      end if;


    RETURN lsDescProd;
 END imp_fn_desc_produ;

/**************************************************************************
Descripcion : Devuelve la descripcion del producto de planit usado en Boleta de Recojo
la Hora en formato dd/mm/yyyy
Fecha Creacion : 12/12/2012
Autor : Jorge Yepez
***************************************************************************/
FUNCTION imp_fn_desc_produ_br(p_codigoPais VARCHAR,p_oidprod NUMBER) RETURN VARCHAR2
  IS

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');


 lstipoDescProd   VARCHAR(10):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'tipoDescProdBr'),'0');

 lsDescProd   VARCHAR(1000):='';


 BEGIN

      if lstipoDescProd='0' then
        select val_i18n into lsDescProd from gen_i18n_sicc_pais x
        where x.attr_enti='MAE_PRODU'
        and x.val_oid=p_oidprod;

      else
        begin

        select x.des_com into lsDescProd from ped_descr_produ x, mae_produ y
        where x.cod_sap=y.cod_sap
        and y.oid_prod=p_oidprod;

        exception when no_data_found then

        select val_i18n into lsDescProd from gen_i18n_sicc_pais x
        where x.attr_enti='MAE_PRODU'
        and x.val_oid=p_oidprod;

        end;

      end if;


    RETURN lsDescProd;
 END imp_fn_desc_produ_br;

/**************************************************************************
Descripcion         : Obtiene los datos de la factura de referencia  en
                      base al OID documento contable (nota de credito).
Fecha Creacion      : 27/05/2009
Autor               : Carlos Hurtado Ramirez - cahurtado@belcorp.biz
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_OBTIE_INFOR_DOCLE_REFER(p_oidDocumento IN NUMBER,
                                         p_serieDocumentoReferencia OUT VARCHAR2,
                                         p_numeroDocumentoReferencia OUT NUMBER,
                                         p_codigoInternoReferencia OUT NUMBER,
                                         p_fechaReferencia OUT DATE,
                                         p_montoReferencia OUT NUMBER,
                                         p_oidTipoDocumentoReferencia OUT NUMBER,
                                         p_tipoDocumentoReferencia OUT VARCHAR2,
                                         p_valnumesolirefe OUT NUMBER,
                                         p_codperirefe OUT VARCHAR
                                         ) IS
CURSOR c_referencia IS
SELECT CAB.OID_CABE,
       CON.OID_SOLI_CABE,
       PED.VAL_NUME_SOLI,
       CON.FEC_FACT,
       FAC.NUM_DOCU_CONT_INTE,
       FAC.NUM_DOCU_LEGA,
       FAC.VAL_SERI_DOCU_LEGA,
       FAC.FEC_FACT FEC_FACT_REFE,
       FAC.VAL_TOTA_PAGA_LOCA,
       FTD.OID_TIPO_DOCU,
       FTD.COD_TIPO_DOCU,
       SPC.Cod_Peri
FROM FAC_DOCUM_CONTA_CABEC CAB,
     PED_SOLIC_CABEC CON,
     PED_SOLIC_CABEC PED,
     FAC_DOCUM_CONTA_CABEC FAC,
     FAC_TIPO_DOCUM FTD,
     CRA_PERIO CP,
     SEG_PERIO_CORPO SPC
WHERE CAB.SOCA_OID_SOLI_CABE = CON.OID_SOLI_CABE
and con.perd_oid_peri=cp.oid_peri
and cp.peri_oid_peri=spc.oid_peri
AND CON.SOCA_OID_DOCU_REFE = FAC.SOCA_OID_SOLI_CABE
AND PED.OID_SOLI_CABE = FAC.SOCA_OID_SOLI_CABE
AND FAC.TIDO_OID_TIPO_DOCU = FTD.OID_TIPO_DOCU
AND CAB.OID_CABE = p_oidDocumento
AND EXISTS (
    SELECT NULL
    FROM FAC_DOCUM_CONTA_LINEA DET,
         FAC_DOCUM_CONTA_LINEA DET_REFE,
         PED_SOLIC_POSIC POS,
         PED_SOLIC_POSIC POS_REFE
    WHERE CAB.OID_CABE = DET.DCCA_OID_CABE
      AND DET.SOPO_OID_SOLI_POSI = POS.OID_SOLI_POSI
      AND FAC.OID_CABE = DET_REFE.DCCA_OID_CABE
      AND DET_REFE.SOPO_OID_SOLI_POSI = POS_REFE.OID_SOLI_POSI
      AND POS.PROD_OID_PROD = POS_REFE.PROD_OID_PROD
      AND (  (POS.OFDE_OID_DETA_OFER IS NOT NULL AND POS.OFDE_OID_DETA_OFER = POS_REFE.OFDE_OID_DETA_OFER)
          OR POS.OFDE_OID_DETA_OFER IS NULL -- para los premios
          )
);

BEGIN

    -- Abrimos el cursor y obtenemos los datos
    FOR r_referencia IN c_referencia LOOP
        p_serieDocumentoReferencia := r_referencia.VAL_SERI_DOCU_LEGA;
        p_numeroDocumentoReferencia := r_referencia.NUM_DOCU_LEGA;
        p_codigoInternoReferencia := r_referencia.NUM_DOCU_CONT_INTE;
        p_fechaReferencia := r_referencia.FEC_FACT_REFE;
        p_montoReferencia := r_referencia.VAL_TOTA_PAGA_LOCA;
        p_oidTipoDocumentoReferencia := r_referencia.OID_TIPO_DOCU;
        p_tipoDocumentoReferencia := r_referencia.COD_TIPO_DOCU;
        p_valnumesolirefe := r_referencia.VAL_NUME_SOLI;
        p_codperirefe := r_referencia.COD_PERI;
    END LOOP;

END;


/**************************************************************************
Descripcion         : Proceso que prepara genera el XML de ultimas noticias. Coorperativo
Fecha Creacion      : 06/06/2013
Fecha Modificacion  : 06/06/2013
Autor               : Sergio Buchelli
Version             : Final (Alfa|Final)
***************************************************************************/
PROCEDURE IMP_PR_PROCE_ULTIM_NOTIC_CORPO(p_oidclie IN NUMBER, p_oidsoli IN NUMBER, p_numlotefact IN VARCHAR2
                                   )
IS

  W_FILAS             NUMBER := 1000 ;
  ls_patron           NUMBER(12);
  ls_codpatr_antg           VARCHAR(100):=' ';
  ls_codsecc_antg           VARCHAR(100):=' ';
  ls_vallite_antg           VARCHAR(100):=' ';
  ls_mensaje                VARCHAR(10000):=' ';
  ls_mensbloq               VARCHAR(10000):=' ';
  ls_mensfijo               VARCHAR(10000):=' ';
  ls_mensvar                VARCHAR(10000):=' ';
  ls_menstemp                VARCHAR(10000):=' ';

  l_clob                      CLOB;
  l_indexinibloque            NUMBER;
  l_indexfinbloque            NUMBER;
  l_textoActual               VARCHAR2(20000) := '';

l_tagPuntajeLideres         VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','tagPuntajeLideres');
l_textoOriginal VARCHAR2(200);
 l_textoReemplazo VARCHAR2(200);
 lc_xml_mens_punt CLOB;


CURSOR c_patron IS
         select a.patr_oid_patr
         --into ls_patron
         from msg_patro_perio a where a.peri_oid_peri=
         (select x.oid_peri from bas_ctrl_fact y, seg_perio_corpo x
         where y.cod_peri=x.cod_peri and y.sta_camp=0 and y.ind_camp_act=1
         );


TYPE patronrecord IS RECORD (
    patr_oid_patr                msg_patro.oid_patr%TYPE
);

TYPE patrontype IS TABLE OF patronrecord;
r_patron    patrontype;





CURSOR c_mensaje(oidPatron NUMBER) IS
          SELECT A.OID_PATR,
             substr(A.COD_PATR,1,4) COD_PATR,
             A.DES_PATR,
             A.FORS_OID_FORM,
             B.COD_FORM,
             A.MEEP_OID_MEDI_ENVI_PAIS,
             D.DES_MEDI_ENVI,
             A.IND_ACTI,
             A.IND_PATR_PERI,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.PATR_OID_PATR_ORIG
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) PATR_OID_PATR_ORIG,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.PERI_OID_PERI
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) PERI_OID_PERI,
             DECODE(A.IND_PATR_PERI,
                    1,
                    (SELECT E.OID_PATR_PERI
                       FROM MSG_PATRO_PERIO E
                      WHERE E.PATR_OID_PATR = A.OID_PATR),
                    NULL) OID_PATR_PERI,
             A.PAIS_OID_PAIS,
             F.PATR_OID_PATR,
             F.OID_PATR_SECC,
             F.COD_SECC,
             F.NUM_ORDE_SECC,
             F.METC_OID_META,
             G.VAL_LITE_IDEN,
             H.VAL_I18N,
             I.MENS_OID_MENS,
             I.NUM_ORDE_IMPR,
             J.VAL_TEXT,
             j.tmen_oid_tipo_mens,
                  (select IDE_SECC from MSG_SECCI_DOCUM x where  x.mdoc_cod_mens_docu = f.mdoc_cod_mens_docu and x.COD_SECC_DOCU  = F.MSEC_COD_SECC_DOCU AND X.IND_ACTI= 1 AND X.EST_REGI='1' ) IDE_SECC,
                (select NIV_SECC from MSG_SECCI_DOCUM x where x.mdoc_cod_mens_docu = f.mdoc_cod_mens_docu and x.COD_SECC_DOCU  = F.MSEC_COD_SECC_DOCU AND X.IND_ACTI= 1 AND X.EST_REGI='1' ) NIV_SECC,--SI ES PADRE
                   (select IND_GRUP_SECC from MSG_SECCI_DOCUM x where x.mdoc_cod_mens_docu = f.mdoc_cod_mens_docu and x.COD_SECC_DOCU  = F.MSEC_COD_SECC_DOCU AND X.IND_ACTI= 1 AND X.EST_REGI='1' ) IND_GRUP_SECC--MISMO GRUPO
        FROM MSG_PATRO            A,
             FAC_FORMU            B,
             MSG_MEDIO_ENVIO_PAIS C,
             MSG_MEDIO_ENVIO      D,
             MSG_PATRO_SECCI      F,
             MSG_METAC            G,
             V_GEN_I18N_SICC      H,
             MSG_PATRO_MENSA      I,
             MSG_MENSA            J
       WHERE A.OID_PATR = oidPatron
         AND A.IND_ACTI = 1
         AND B.OID_FORM = A.FORS_OID_FORM
         AND C.OID_MEDI_ENVI_PAIS = A.MEEP_OID_MEDI_ENVI_PAIS
         AND D.OID_MEDI_ENVI = C.MEEN_OID_MEDI_ENVI
         AND F.PATR_OID_PATR = A.OID_PATR
         AND F.METC_OID_META = G.OID_META(+)
         AND G.OID_META = H.VAL_OID(+)
         AND H.ATTR_ENTI(+) = 'MSG_METAC'
         AND H.IDIO_OID_IDIO(+) = 1
         AND I.PASE_OID_PATR_SECC = F.OID_PATR_SECC
         AND J.OID_MENS = I.MENS_OID_MENS
         and imp_fn_mens_ua_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_marca_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_lista_clie(p_oidclie, j.oid_mens,p_oidsoli)=1
         and imp_fn_mens_tipo_clie(p_oidclie, j.oid_mens)=1
         and imp_fn_mens_cuv_clie(p_oidsoli, j.oid_mens)=1
         and imp_fn_mens_pedid_clie(p_oidsoli, j.oid_mens)=1
       ORDER BY F.NUM_ORDE_SECC, I.NUM_ORDE_IMPR;


TYPE mensajerecord IS RECORD (
    oid_patr                msg_patro.oid_patr%TYPE,
    cod_patr                msg_patro.cod_patr%TYPE,
    des_patr                msg_patro.des_patr%TYPE,
    FORS_OID_FORM           msg_patro.FORS_OID_FORM%TYPE,
    cod_form                fac_formu.cod_form%TYPE,
    MEEP_OID_MEDI_ENVI_PAIS msg_patro.MEEP_OID_MEDI_ENVI_PAIS%TYPE,
    DES_MEDI_ENVI           MSG_MEDIO_ENVIO.DES_MEDI_ENVI%TYPE,
    IND_ACTI                msg_patro.IND_ACTI%TYPE,
    IND_PATR_PERI           msg_patro.IND_PATR_PERI%TYPE,
    PATR_OID_PATR_ORIG      MSG_PATRO_PERIO.PATR_OID_PATR_ORIG%TYPE,
    PERI_OID_PERI           MSG_PATRO_PERIO.PERI_OID_PERI%TYPE,
    OID_PATR_PERI           MSG_PATRO_PERIO.OID_PATR_PERI%TYPE,
    PAIS_OID_PAIS           msg_patro.PAIS_OID_PAIS%TYPE,
    PATR_OID_PATR           MSG_PATRO_SECCI.PATR_OID_PATR%TYPE,
    OID_PATR_SECC           MSG_PATRO_SECCI.OID_PATR_SECC%TYPE,
    COD_SECC                MSG_PATRO_SECCI.COD_SECC%TYPE,
    NUM_ORDE_SECC           MSG_PATRO_SECCI.NUM_ORDE_SECC%TYPE,
    METC_OID_META           MSG_PATRO_SECCI.METC_OID_META%TYPE,
    VAL_LITE_IDEN           MSG_METAC.VAL_LITE_IDEN%TYPE,
    VAL_I18N                GEN_I18N_SICC_PAIS.VAL_I18N%TYPE,
    MENS_OID_MENS           MSG_PATRO_MENSA.MENS_OID_MENS%TYPE,
    NUM_ORDE_IMPR           MSG_PATRO_MENSA.NUM_ORDE_IMPR%TYPE,
    VAL_TEXT                MSG_MENSA.VAL_TEXT%TYPE,
    tmen_oid_tipo_mens      MSG_MENSA.tmen_oid_tipo_mens%TYPE,
    IDE_SECC   MSG_SECCI_DOCUM.IDE_SECC%type,
    NIV_SECC   MSG_SECCI_DOCUM.NIV_SECC%type,
    IND_GRUP_SECC   MSG_SECCI_DOCUM.IND_GRUP_SECC%type
);

TYPE mensajetype IS TABLE OF mensajerecord;
r_mensaje    mensajetype;


CURSOR c_buzon(p_oidmens NUMBER,p_oidclie NUMBER,p_oidsoli NUMBER) IS
          SELECT A.Oid_Buzo_Mens,
          a.dato_vari_01,
          a.dato_vari_02,
          a.dato_vari_03,
          a.dato_vari_04,
          a.dato_vari_05,
          a.dato_vari_06,
          a.dato_vari_07,
          a.dato_vari_08,
          a.dato_vari_09,
          a.dato_vari_10,
          a.dato_vari_11,
          a.dato_vari_12,
          a.dato_vari_13,
          a.dato_vari_14,
          a.dato_vari_15,
          a.dato_vari_16,
          a.dato_vari_17,
          a.dato_vari_18,
          a.dato_vari_19,
          a.dato_vari_20
        FROM MSG_BUZON_MENSA A
       WHERE A.Mens_Oid_Mens=p_oidmens
       and (a.peri_oid_peri is null or a.peri_oid_peri=(select peri_oid_peri from cra_perio where oid_peri=(select perd_oid_peri from ped_solic_cabec where oid_soli_cabe=p_oidsoli)))
       AND a.clie_oid_clie=p_oidclie
       and (a.ind_acti=1 or a.num_lote_impr=p_numlotefact)
       ;


TYPE buzonrecord IS RECORD (
    oid_buzo_mens           msg_buzon_mensa.oid_buzo_mens%TYPE,
    dato_vari_01            msg_buzon_mensa.dato_vari_01%TYPE,
    dato_vari_02            msg_buzon_mensa.dato_vari_02%TYPE,
    dato_vari_03            msg_buzon_mensa.dato_vari_03%TYPE,
    dato_vari_04            msg_buzon_mensa.dato_vari_04%TYPE,
    dato_vari_05            msg_buzon_mensa.dato_vari_05%TYPE,
    dato_vari_06            msg_buzon_mensa.dato_vari_06%TYPE,
    dato_vari_07            msg_buzon_mensa.dato_vari_07%TYPE,
    dato_vari_08            msg_buzon_mensa.dato_vari_08%TYPE,
    dato_vari_09            msg_buzon_mensa.dato_vari_09%TYPE,
    dato_vari_10            msg_buzon_mensa.dato_vari_10%TYPE,
    dato_vari_11            msg_buzon_mensa.dato_vari_11%TYPE,
    dato_vari_12            msg_buzon_mensa.dato_vari_12%TYPE,
    dato_vari_13            msg_buzon_mensa.dato_vari_13%TYPE,
    dato_vari_14            msg_buzon_mensa.dato_vari_14%TYPE,
    dato_vari_15            msg_buzon_mensa.dato_vari_15%TYPE,
    dato_vari_16            msg_buzon_mensa.dato_vari_16%TYPE,
    dato_vari_17            msg_buzon_mensa.dato_vari_17%TYPE,
    dato_vari_18            msg_buzon_mensa.dato_vari_18%TYPE,
    dato_vari_19            msg_buzon_mensa.dato_vari_19%TYPE,
    dato_vari_20            msg_buzon_mensa.dato_vari_20%TYPE
);

TYPE buzontype IS TABLE OF buzonrecord;
r_buzon    buzontype;


  lsIdetificadorSeccion  MSG_SECCI_DOCUM.IDE_SECC%type;
  lsNivelSeccion           MSG_SECCI_DOCUM.NIV_SECC%type;
  lsGruposeccion          MSG_SECCI_DOCUM.IND_GRUP_SECC%type;

  lsIdetificadorSeccionAnt  MSG_SECCI_DOCUM.IDE_SECC%type;
  lsNivelSeccionAnt            MSG_SECCI_DOCUM.NIV_SECC%type;
  lsGruposeccionAnt          MSG_SECCI_DOCUM.IND_GRUP_SECC%type;
 hayCambioGrupo boolean:=false;
 cerrarTagMensaje boolean:= false;
BEGIN

    --Se inicializa la variabla CLOB en Memoria
    DBMS_LOB.CREATETEMPORARY(l_clob, TRUE);

    /*INSERT INTO IMP_PAQUE_DOCUM_UNOT (
    COR_UNOT,
    COD_CLIE,
    VAL_NUME_SOLI,
    XML_UNOT)
    VALUES(
    p_oidsoli,
    (select cod_clie from mae_clien where oid_clie=p_oidclie),
    (select val_nume_soli from ped_solic_cabec where oid_soli_cabe=p_oidsoli),
    EMPTY_CLOB())
    RETURNING XML_UNOT INTO l_clob;*/



-- Abrimos el cursor de patrones del periodo
OPEN c_patron;
LOOP
    FETCH c_patron BULK COLLECT
    INTO r_patron LIMIT w_filas;

    IF  r_patron.COUNT > 0 THEN

        FOR y IN r_patron.FIRST..r_patron.LAST
        LOOP



    -- Abrimos el cursor principal
    OPEN c_mensaje(r_patron(y).patr_oid_patr);
    LOOP
        FETCH c_mensaje BULK COLLECT
        INTO r_mensaje LIMIT w_filas;

        IF  r_mensaje.COUNT > 0 THEN

            FOR i IN r_mensaje.FIRST..r_mensaje.LAST
            LOOP

                l_textoActual:='';
                lsIdetificadorSeccion :=  r_mensaje(i).IDE_SECC;
                lsNivelSeccion:= r_mensaje(i).NIV_SECC;
                lsGruposeccion:= r_mensaje(i).IND_GRUP_SECC;

                if(  lsGruposeccion = lsGruposeccionAnt) then
                   hayCambioGrupo:=false;
                else
                    hayCambioGrupo:= true;
                end if;


                if (lsNivelSeccion is null or length(lsNivelSeccion) =0) then
                  cerrarTagMensaje:= true;
                 else
                  cerrarTagMensaje:= false;
                end if;

                 -- Cerramos el patron
                if r_mensaje(i).cod_patr<>ls_codpatr_antg and i<>1 then
                  l_textoActual := l_textoActual || '</' || ls_codpatr_antg || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- Abrimos el patron
                if r_mensaje(i).cod_patr<>ls_codpatr_antg then
                     l_textoActual := l_textoActual || '<' || substr(r_mensaje(i).cod_patr,1,4) || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- cerramos la seccion
                if r_mensaje(i).cod_secc<>ls_codsecc_antg and ls_codsecc_antg<>' ' then
                  l_textoActual := l_textoActual || '</' || ls_vallite_antg || '>';

                  --cerramos seccion cuando no es el primero y hay cambio de seccion O cunado el nivel esta vacio
                  if((i<>1 and hayCambioGrupo) ) then
                    l_textoActual := l_textoActual || '</' ||lsIdetificadorSeccionAnt || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                  end if;
                end if;



                if r_mensaje(i).cod_secc<>ls_codsecc_antg then

                 -- Abrimos la seccion
                  if(hayCambioGrupo and length(lsIdetificadorSeccion) > 0) then
                      l_textoActual := l_textoActual || '<' ||lsIdetificadorSeccion || '>';
                  end if;

                  l_textoActual := l_textoActual || '<' || r_mensaje(i).VAL_LITE_IDEN || '>';
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                ls_mensaje:=r_mensaje(i).VAL_TEXT;
                select instr(ls_mensaje,'<fijo>') into l_indexinibloque from dual;
                select instr(ls_mensaje,'<fijo>',l_indexinibloque+1) into l_indexfinbloque from dual;

                if r_mensaje(i).tmen_oid_tipo_mens = 2 then
                  l_textoActual := l_textoActual || ls_mensaje;
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                else

                      for x in 0..l_indexfinbloque loop

                        if l_indexinibloque=0 then
                           ls_mensbloq:=ls_mensaje;
                           ls_mensfijo:='';
                           ls_mensvar:=ls_mensaje;
                        else
                           select substr(ls_mensaje,instr(ls_mensaje,'<fijo>'), instr(ls_mensaje,'<fijo>',2)-1)
                           into ls_mensbloq from dual;

                            select substr(ls_mensbloq,instr(ls_mensbloq,'<fijo>')+length('<fijo>'), instr(ls_mensbloq,'</fijo>')-length('<fijo>')-1)
                            into ls_mensfijo from dual;

                            select substr(ls_mensbloq,instr(ls_mensbloq,'</fijo>')+length('</fijo>'))
                            into ls_mensvar from dual;

                        end if;


                        if ls_mensvar is not null then

                        OPEN c_buzon(r_mensaje(i).mens_oid_mens,p_oidclie,p_oidsoli);
                        LOOP
                            FETCH c_buzon BULK COLLECT
                            INTO r_buzon LIMIT w_filas;

                            IF  r_buzon.COUNT > 0 THEN

                                -- Se inserta la parte fija
                                if ls_mensfijo is not null then
                                  l_textoActual := l_textoActual || ls_mensfijo;
                                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                end if;


                                FOR j IN r_buzon.FIRST..r_buzon.LAST
                                LOOP
                                    ls_menstemp:=ls_mensvar;

                                    if instr(ls_menstemp,'<DATO01>')>0 then
                                       select replace(ls_menstemp,'<DATO01>', r_buzon(j).dato_vari_01) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO02>')>0 then
                                       select replace(ls_menstemp,'<DATO02>', r_buzon(j).dato_vari_02) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO03>')>0 then
                                       select replace(ls_menstemp,'<DATO03>', r_buzon(j).dato_vari_03) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO04>')>0 then
                                       select replace(ls_menstemp,'<DATO04>', r_buzon(j).dato_vari_04) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO05>')>0 then
                                       select replace(ls_menstemp,'<DATO05>', r_buzon(j).dato_vari_05) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO06>')>0 then
                                       select replace(ls_menstemp,'<DATO06>', r_buzon(j).dato_vari_06) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO07>')>0 then
                                       select replace(ls_menstemp,'<DATO07>', r_buzon(j).dato_vari_07) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO08>')>0 then
                                       select replace(ls_menstemp,'<DATO08>', r_buzon(j).dato_vari_08) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO09>')>0 then
                                       select replace(ls_menstemp,'<DATO09>', r_buzon(j).dato_vari_09) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO10>')>0 then
                                       select replace(ls_menstemp,'<DATO10>', r_buzon(j).dato_vari_10) into ls_menstemp from dual;
                                    end if;

                                    if instr(ls_menstemp,'<DATO11>')>0 then
                                       select replace(ls_menstemp,'<DATO11>', r_buzon(j).dato_vari_11) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO12>')>0 then
                                       select replace(ls_menstemp,'<DATO12>', r_buzon(j).dato_vari_12) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO13>')>0 then
                                       select replace(ls_menstemp,'<DATO13>', r_buzon(j).dato_vari_13) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO14>')>0 then
                                       select replace(ls_menstemp,'<DATO14>', r_buzon(j).dato_vari_14) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO15>')>0 then
                                       select replace(ls_menstemp,'<DATO15>', r_buzon(j).dato_vari_15) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO16>')>0 then
                                       select replace(ls_menstemp,'<DATO16>', r_buzon(j).dato_vari_16) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO17>')>0 then
                                       select replace(ls_menstemp,'<DATO17>', r_buzon(j).dato_vari_17) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO18>')>0 then
                                       select replace(ls_menstemp,'<DATO18>', r_buzon(j).dato_vari_18) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO19>')>0 then
                                       select replace(ls_menstemp,'<DATO19>', r_buzon(j).dato_vari_19) into ls_menstemp from dual;
                                    end if;
                                    if instr(ls_menstemp,'<DATO20>')>0 then
                                       select replace(ls_menstemp,'<DATO20>', r_buzon(j).dato_vari_20) into ls_menstemp from dual;
                                    end if;

                                    -- Se inserta la parte variable
                                    l_textoActual := l_textoActual || ls_menstemp;
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                    update msg_buzon_mensa set ind_acti=0, num_lote_impr=p_numlotefact, fec_impr=sysdate
                                    where oid_buzo_mens=r_buzon(j).oid_buzo_mens;

                                END LOOP;

                            END IF;

                            EXIT WHEN c_buzon%NOTFOUND;
                        END LOOP;
                        -- Cerramos el cursor
                        CLOSE c_buzon;

                        end if;


                          select substr(ls_mensaje,l_indexfinbloque)into ls_mensaje from dual;
                          select instr(ls_mensaje,'<fijo>') into l_indexinibloque from dual;
                          select instr(ls_mensaje,'<fijo>',l_indexinibloque+1) into l_indexfinbloque from dual;

                         --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                        --return;
                      end loop;
                end if;
                ls_codpatr_antg:=substr(r_mensaje(i).cod_patr,1,4);
                ls_codsecc_antg:=r_mensaje(i).cod_secc;
                ls_vallite_antg:=r_mensaje(i).VAL_LITE_IDEN;


                lsIdetificadorSeccionAnt :=  r_mensaje(i).IDE_SECC;
                lsNivelSeccionAnt:= r_mensaje(i).NIV_SECC;
                lsGruposeccionAnt:= r_mensaje(i).IND_GRUP_SECC;

                if l_textoActual is not null then
                    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;
            END LOOP;
        END IF;

        EXIT WHEN c_mensaje%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_mensaje;

    -- cerramos la seccion
      if ls_vallite_antg <> ' ' then
        l_textoActual := '</' || ls_vallite_antg || '>';

        IF(LENGTH(lsIdetificadorSeccionAnt) > 0) THEN
          l_textoActual := l_textoActual || '</' ||lsIdetificadorSeccionAnt || '>';
          --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
        END IF;
      --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      end if;

    -- Cerramos el patron
      if ls_codpatr_antg <> ' ' then
      l_textoActual := l_textoActual || '</' || ls_codpatr_antg || '>';
      DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
      end if;


      ls_codpatr_antg           :=' ';
      ls_codsecc_antg           :=' ';
      ls_vallite_antg           :=' ';

        END LOOP;
    END IF;

    EXIT WHEN c_patron%NOTFOUND;
END LOOP;
-- Cerramos el cursor
CLOSE c_patron;

begin
select xml_mens_punt into lc_xml_mens_punt from IMP_PAQUE_DOCUM_PUNTA_OBTEN
where cod_clie=(select cod_clie from mae_clien where oid_clie=p_oidclie);
exception when others then
  lc_xml_mens_punt:=null;
end;

IF l_tagPuntajeLideres IS NOT NULL AND
   INSTR(l_clob, l_tagPuntajeLideres) != 0 AND
   LENGTH(lc_xml_mens_punt) > 0 THEN

    -- Incluimos el mensaje del puntaje de concurso de lideres
    l_textoOriginal := l_tagPuntajeLideres;
    l_textoReemplazo := l_tagPuntajeLideres || lc_xml_mens_punt;
    IMP_PKG_PROCE_GENER.IMP_PR_LOB_REPLACE(l_clob, l_textoOriginal, l_textoReemplazo);

END IF;

--Se inserta el CLOB en memoria a BD
INSERT INTO IMP_PAQUE_DOCUM_UNOT (
    COR_UNOT,
    COD_CLIE,
    VAL_NUME_SOLI,
    XML_UNOT)
    VALUES(
    p_oidsoli,
    (select cod_clie from mae_clien where oid_clie=p_oidclie),
    (select val_nume_soli from ped_solic_cabec where oid_soli_cabe=p_oidsoli),
    l_clob);

--Se libera la variabla CLOB de Memoria
DBMS_LOB.FREETEMPORARY(l_clob);

COMMIT;
END IMP_PR_PROCE_ULTIM_NOTIC_CORPO;

/**************************************************************************
Descripcion : Proceso que ejecuta el Reporte de Desviaci?n de Pedidos.
Fecha Creacion : 23/10/2013
Fecha Modificacion  : 23/10/2013
Autor : Yahir Rivas Luna
***************************************************************************/

PROCEDURE IMP_PR_PROCE_DESVI_PEDID(p_codigoPais IN VARCHAR2
                                        ,p_promedio IN VARCHAR2
                                        ,p_desviacion IN VARCHAR2
                                        ,p_fechaFacturacion IN VARCHAR2)
IS

    lnOidTipoSoliPais number;
  lnoidpais number;

BEGIN

  EXECUTE IMMEDIATE 'TRUNCATE TABLE IMP_REPOR_DESVI_PEDID'; -- eliminamos la data de la tabla temporal

 lnOidTipoSoliPais:= FIN_PKG_GENER.FIN_FN_OBTIE_OID_SOLIC_PAIS ('C1');
  lnoidpais:= GEN_PKG_GENER.gen_fn_devuelve_id_pais(p_codigoPais);

    FOR Y IN (  SELECT
              m.cod_clie,
              gen_pkg_gener.GEN_FN_CLIEN_DATOS (m.COD_CLIE, 'COD_ZONA') AS ZONA,
              gen_pkg_gener.GEN_FN_CLIEN_DATOS (m.COD_CLIE, 'COD_SECC') AS SECCION,
              FIN_PKG_GENER.FIN_FN_OBTIE_NUMER_DOCUM_IDENT (m.OID_CLIE) AS DOCIDEN,
              HIP_PKG_CONSU.HIP_FN_OBTIE_PROME_VENTA_PEDID('','','','',m.COD_CLIE,p_promedio) PROMEDIO, -- cambiar por valor del parametro
              A.VAL_TOTA_PAGA_LOCA MONTO_PEDIDO,
              FIN_PKG_GENER.FIN_FN_OBTIE_DESCR_ESTAT_CLIEN (m.OID_CLIE) AS ESTATUS
            FROM ped_solic_cabec a, mae_clien m
           WHERE A.TSPA_OID_TIPO_SOLI_PAIS = lnOidTipoSoliPais
                 AND A.GRPR_OID_GRUP_PROC = 5
                 AND A.PAIS_OID_PAIS = lnoidpais --cambiar el valor por el OID del pais
                 AND A.FEC_FACT = TO_DATE(p_fechaFacturacion,'dd/mm/yyyy')   -- la fecha debe de ser la de facturacion y debe ser recibida por el store
                 AND A.VAL_TOTA_PAGA_LOCA > 0
                 --AND HIP_PKG_CONSU.HIP_FN_OBTIE_PROME_VENTA_PEDID('','','','',m.COD_CLIE,to_number(p_promedio)) > 0
                 AND A.CLIE_OID_CLIE = M.OID_CLIE ) LOOP

              if(y.PROMEDIO > 0
                   and ((( y.MONTO_PEDIDO / y.PROMEDIO ) - 1 ) * 100 > to_number(p_desviacion))) then

               INSERT INTO IMP_REPOR_DESVI_PEDID(cod_zona,cod_secc,doc_iden,pro_pedi,mon_pedi,des_esta)
                                      VALUES( y.zona,
                                              y.SECCION,
                                              y.DOCIDEN,
                                              y.PROMEDIO,
                                              y.MONTO_PEDIDO,
                                              y.ESTATUS);


          end if;




     END LOOP;

   EXCEPTION
    WHEN OTHERS THEN
       RAISE_APPLICATION_ERROR(-20123, 'ERROR IMP_PR_PROCE_DESVI_PEDID: '||substr(sqlerrm,1,250));

END IMP_PR_PROCE_DESVI_PEDID;



/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 13/05/2015
Autor : Juan Carlos Gutirrez
***************************************************************************/
FUNCTION imp_fn_mens_ua_clie_np(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);
 lnCodMens      VARCHAR2(12);
 lnCodCons      NUMBER(12);
 lsCodPeri      VARCHAR2(6);

 BEGIN

 select count(1) into lstipoasig
 from msg_mensa_tipo_asign a
 where a.mens_oid_mens=p_oidmens and tide_oid_tipo_dest=1;

 if lstipoasig=0 then
  RETURN 1;
 end if;
 
  SELECT COD_MENS INTO lnCodMens FROM MSG_MENSA WHERE OID_MENS = p_oidmens;
    
  SELECT COD_CONS_REST
    INTO lnCodCons
    FROM MSG_CONSI_RESTR
   WHERE IND_CONS_REST = 'C'
     AND ABR_CONS_REST = 'UAS';
  
  SELECT COD_PERI
    INTO lsCodPeri
    FROM BAS_CTRL_FACT
   WHERE STA_CAMP = 0
     AND IND_CAMP_ACT = 1;

 select count(1)
   into lscontador
   from mae_clien_unida_admin a,
        msg_mensa             b,
        Msg_Cores_Mensa_detal c,
        zon_terri_admin       d,
        zon_secci             e,
        zon_terri             f,
        zon_zona              g,
        zon_regio             h
  where a.ztad_oid_terr_admi = d.oid_terr_admi
    and d.zscc_oid_secc = e.oid_secc
    and d.terr_oid_terr = f.oid_terr
    and e.zzon_oid_zona = g.oid_zona
    and g.zorg_oid_regi = h.oid_regi
    and a.ind_acti = 1
    and a.clie_oid_clie = p_oidclie
    and b.oid_mens = p_oidmens
    and b.cod_mens = c.meca_cod_mens
    AND c.ind_acti = 1
    AND c.ind_cons_rest = 'C'
    AND c.meca_cam_proc = lsCodPeri
    AND c.core_cod_cons_rest = lnCodCons
    
    and decode(c.val_con1, null, h.cod_regi, c.val_con1) =
        h.cod_regi
    and decode(c.val_con2, null, g.cod_zona, c.val_con2) =
        g.cod_zona
    and decode(c.val_con3, null, e.cod_secc, c.val_con3) =
        e.cod_secc
    and decode(c.val_con4, null, f.cod_terr, c.val_con4) =
        f.cod_terr;

 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_ua_clie_np;

/**************************************************************************
Descripcion : Devuelve 1 si el mensaje aplica para el cliente o 0 si no
la Hora en formato dd/mm/yyyy
Fecha Creacion : 07/02/2012
Autor : Juan Carlos Gutirrez
***************************************************************************/
FUNCTION imp_fn_mens_tipo_clie_np(p_oidclie NUMBER, p_oidmens NUMBER) RETURN NUMBER
 IS

 lstipoasig     NUMBER(3);
 lscontador     NUMBER(10);
 lnCodMens      VARCHAR2(12);
 lnCodCons      NUMBER(12);
 lsCodPeri      VARCHAR2(6);
 BEGIN

 select count(1)
   into lstipoasig
   from msg_mensa_tipo_asign a
  where a.mens_oid_mens = p_oidmens
    and tide_oid_tipo_dest = 2;

 if lstipoasig=0 then
  RETURN 1;
 end if;
   SELECT COD_MENS INTO lnCodMens FROM MSG_MENSA WHERE OID_MENS = p_oidmens;
    
  SELECT COD_CONS_REST
    INTO lnCodCons
    FROM MSG_CONSI_RESTR
   WHERE IND_CONS_REST = 'C'
     AND ABR_CONS_REST = 'TCL';
  
  SELECT COD_PERI
    INTO lsCodPeri
    FROM BAS_CTRL_FACT
   WHERE STA_CAMP = 0
     AND IND_CAMP_ACT = 1;
 
 select count(1)
   into lscontador
   from mae_clien_tipo_subti a,
        msg_mensa            b,
        msg_mensa_tipo_clien c,
        mae_clien_clasi      d
  where a.clie_oid_clie = p_oidclie
    and a.oid_clie_tipo_subt = d.ctsu_oid_clie_tipo_subt
    and b.oid_mens = p_oidmens
    and b.oid_mens = c.mens_oid_mens
    and decode(c.ticl_oid_tipo_clie,
               null,
               a.ticl_oid_tipo_clie,
               c.ticl_oid_tipo_clie) = a.ticl_oid_tipo_clie
    and decode(c.sbti_oid_subt_clie,
               null,
               a.sbti_oid_subt_clie,
               c.sbti_oid_subt_clie) = a.sbti_oid_subt_clie
    and decode(c.tccl_oid_tipo_clas,
               null,
               d.tccl_oid_tipo_clasi,
               c.tccl_oid_tipo_clas) = d.tccl_oid_tipo_clasi
    and decode(c.clas_oid_clas,
               null,
               d.tccl_oid_tipo_clasi,
               c.clas_oid_clas) = d.clas_oid_clas;


 if lscontador>0 then
    return 1;
 else
    return 0;
 end if;

 RETURN 1;
 END imp_fn_mens_tipo_clie_np;


/***************************************************************************
Descripcion       : Procedimiemto que implementa la logica en IMP_PR_PROCE_DETAL_FACTU2_REGI
                    para su insercion en tablas cabecera y detalle: IMP_PRINT_PEDID_RESUM y 
                    IMP_PRINT_PEDID_DETAL - PAIS PERU CON Y SIN PERCEPCION
                    
Parametros        : Codigo de pais, codigo de periodo, codigo de marca, codigo de canal
Fecha Creacion    : 20/11/2015
Autor             : Gonzalo Javier Huertas Agurto
***************************************************************************/
/*PROCEDURE PEDIDOS(p_codigoPais IN VARCHAR2,
                                   p_codigoPeriodo IN VARCHAR2
                                   , p_oidZona NUMBER
                                   , p_fechaFacturacion IN VARCHAR2,
                                   psCodigoTransaccional varchar2, 
                                   psCodigoPaquete varchar2, 
                                   psCodigoUsuario varchar2) IS

CURSOR c_consolidados(oidPeriodo NUMBER,
                      indicadorEnvioLarissa VARCHAR2,
                      numeroLoteFacturacion NUMBER,
                      oidRegi NUMBER) IS
SELECT SP.OID_PAIS,
       SP.COD_PAIS,
       MC.OID_CLIE,
       MC.COD_CLIE,
       MC.COD_DIGI_CTRL,
       MC.VAL_NOM1,
       MC.VAL_NOM2,
       MC.VAL_APE1,
       MC.VAL_APE2,
       MCI.NUM_DOCU_IDEN,
       CON.OID_SOLI_CABE,
       CON.VAL_NUME_SOLI,
       CON.FEC_FACT,
       CON.VAL_IMPO_FLET_TOTA_LOCA,
       CON.Val_Reca_Flet_Loca,
       CON.VAL_IMPO_REDO_LOCA,
       substr(des_pais, 1,length(des_pais)-decode(instr(des_pais,'ESIKA'),0,0,5)-decode(instr(des_pais,'LBEL'),0,0,4)) DES_PAIS,
       ZON.COD_ZONA,
       SEC.COD_SECC,
       TER.COD_TERR,
       SEC.NUM_SECU_FACT_DIAR,
       mcda.ind_impr_docu imprimefactel,
       mcda.ind_impr_pdoc imprimepaqdoc,
       con.val_tota_gast_admi GASTOS,
       con.val_tota_gast_admi2 GASTOS2,
       (select val_nom1 || ' ' || val_nom2 from mae_clien where oid_clie=zon.clie_oid_clie)  nombreGZ,
       (select val_ape1 || ' ' || val_ape2 from mae_clien where oid_clie=zon.clie_oid_clie)  apellidosGZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=6 and rownum=1)  celular_GZ,
       (select x.val_text_comu from mae_clien_comun x where clie_oid_clie=zon.clie_oid_clie and x.ticm_oid_tipo_comu=3 and rownum=1)  correo_GZ,
       (select decode(y.val_sigl,'RUC',y.val_sigl,'DNI') from mae_tipo_docum y where y.oid_tipo_docu=mci.tdoc_oid_tipo_docu and rownum=1) tipo_docum,
       con.val_impo_impu_tota_loca,
       con.val_impo_desc_flet,
       con.val_impo_desc_3_tota_loca,
       con.val_impo_desc_4_tota_loca,
       (select x1.val_i18n from gen_i18n_sicc_comun x1 where x1.attr_enti='CAR_NIVEL_RIESG' and x1.val_oid=mcda.niri_oid_nive_ries) nr,
       nvl(mc.val_recl_pend,0) val_recl_pend
FROM MAE_CLIEN MC,
     MAE_CLIEN_IDENT MCI,
     MAE_CLIEN_DATOS_ADICI MCDA,
     PED_SOLIC_CABEC CON,
     ZON_ZONA ZON,
     ZON_TERRI TER,
     ZON_TERRI_ADMIN ZTA,
     ZON_SECCI SEC,
     PED_SOLIC_CABEC_SECUE SEC,
     SEG_PAIS SP,
     BAS_PAIS BP
WHERE MC.OID_CLIE = CON.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCI.CLIE_OID_CLIE
  AND MC.OID_CLIE = MCDA.CLIE_OID_CLIE
  AND MCI.VAL_IDEN_DOCU_PRIN = 1
  AND SP.OID_PAIS = CON.PAIS_OID_PAIS
  AND SP.COD_PAIS = BP.COD_PAIS
  AND CON.ZZON_OID_ZONA = ZON.OID_ZONA
  AND CON.TERR_OID_TERR = TER.OID_TERR
  AND CON.ZTAD_OID_TERR_ADMI = ZTA.OID_TERR_ADMI
  AND ZTA.ZSCC_OID_SECC = SEC.OID_SECC
  AND CON.OID_SOLI_CABE = SEC.SOCA_OID_SOLI_CABE
  AND CON.FEC_FACT = TO_DATE(p_fechaFacturacion, 'dd/mm/yyyy')
  AND CON.PERD_OID_PERI = oidPeriodo
  AND ZON.Oid_Zona = oidRegi
  and con.ind_inte_lari_gene = indicadorEnvioLarissa
  and (numeroLoteFacturacion is null or con.num_lote_fact = numeroLoteFacturacion)
  AND CON.NUM_UNID_ATEN_TOTA > 0
  AND EXISTS (
      SELECT NULL
      FROM INT_LAR_TIPO_SOLICI_PEDIDO_DIS L
      WHERE L.TSPA_OID_TIPO_SOLI_PAIS = CON.TSPA_OID_TIPO_SOLI_PAIS
  );
--ORDER BY MC.COD_CLIE,
--         CON.VAL_NUME_SOLI;

TYPE consolidadorecord IS RECORD (
    oid_pais                seg_pais.oid_pais%TYPE,
    cod_pais                seg_pais.cod_pais%TYPE,
    oid_clie                mae_clien.oid_clie%TYPE,
    cod_clie                mae_clien.cod_clie%TYPE,
    cod_digi_ctrl           mae_clien.cod_digi_ctrl%TYPE,
    val_nom1                mae_clien.val_nom1%TYPE,
    val_nom2                mae_clien.val_nom2%TYPE,
    val_ape1                mae_clien.val_ape1%TYPE,
    val_ape2                mae_clien.val_ape2%TYPE,
    num_docu_iden           mae_clien_ident.num_docu_iden%TYPE,
    oid_soli_cabe           ped_solic_cabec.oid_soli_cabe%TYPE,
    val_nume_soli           ped_solic_cabec.val_nume_soli%TYPE,
    fec_fact                ped_solic_cabec.fec_fact%TYPE,
    val_impo_flet_tota_loca ped_solic_cabec.val_impo_flet_tota_loca%TYPE,
    val_reca_flet_loca      ped_solic_cabec.val_reca_flet_loca%TYPE,
    val_impo_redo_loca      ped_solic_cabec.val_impo_redo_loca%TYPE,
    des_pais                bas_pais.des_pais%TYPE,
    cod_zona                zon_zona.cod_zona%TYPE,
    cod_secc                zon_secci.cod_secc%TYPE,
    cod_terr                zon_terri.cod_terr%TYPE,
    num_secu_fact_diar      ped_solic_cabec_secue.num_secu_fact_diar%TYPE,
    imprimefactel           mae_clien_datos_adici.ind_impr_docu%TYPE,
    imprimepaqdoc           mae_clien_datos_adici.ind_impr_pdoc%TYPE,
    gastos                  ped_solic_cabec.val_tota_gast_admi%TYPE,
    gastos2                  ped_solic_cabec.val_tota_gast_admi2%TYPE,
    nombresGZ               varchar2(100),
    apellidosGZ             varchar2(100),
    celularGZ               varchar2(100),
    correoGZ               varchar2(100),
    tipo_docum               varchar2(100),
    val_impo_impu_tota_loca  ped_solic_cabec.val_impo_impu_tota_loca%TYPE,
    val_impo_desc_flet       ped_solic_cabec.val_impo_desc_flet%TYPE,
    val_impo_desc_3_tota_loca ped_solic_cabec.val_impo_desc_3_tota_loca%TYPE,
    val_impo_desc_4_tota_loca ped_solic_cabec.val_impo_desc_4_tota_loca%TYPE,
    nr                        gen_i18n_sicc_comun.val_i18n%TYPE,
    val_recl_pend             mae_clien.val_recl_pend%TYPE
);

TYPE consolidadotype IS TABLE OF consolidadorecord;
r_consolidado    consolidadotype;

CURSOR c_detalle(oidConsolidado NUMBER
,v_desPremioAgotado VARCHAR2
,v_desAgotado VARCHAR2
,v_desFaltLiq VARCHAR2
,v_desFaltAnun VARCHAR2
,v_desAnulMotMax VARCHAR2
,v_desPremio VARCHAR2
,v_desAtRec VARCHAR2
,v_desRecup VARCHAR2
,v_desReemp VARCHAR2
,v_desGratis VARCHAR2
,v_desPremioLET VARCHAR2
,v_desRecupSemana VARCHAR2
,v_desOfertNavid VARCHAR2
, v_oidestra  NUMBER
,v_desRecuPROL VARCHAR2
,v_desRecuPROL2 VARCHAR2
) IS
SELECT PSC.OID_SOLI_CABE,
       PSC.COPA_OID_PARA_GENE,
       PSC.ICTP_OID_TIPO_PROG,
       PSP.OID_SOLI_POSI,
       nvl(NVL(PSP.VAL_CODI_VENT, LPAD('0', 4 - LENGTH(PSP.VAL_CODI_VENT_FICT), '0') || PSP.VAL_CODI_VENT_FICT),'00000') AS VAL_CODI_VENT,
       --(SELECT VAL_I18N FROM GEN_I18N_SICC_PAIS WHERE ATTR_ENTI = 'MAE_PRODU' AND IDIO_OID_IDIO = 1 AND VAL_OID = PSP.PROD_OID_PROD) DES_PROD,
       imp_fn_desc_produ(p_codigoPais,psp.prod_oid_prod) DES_PROD,
       PSP.NUM_UNID_DEMA_REAL,
       PSP.NUM_UNID_ATEN,
       PSP.VAL_PREC_CATA_UNIT_LOCA,
       PSP.VAL_PREC_CATA_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CATA_TOTA_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA,
       PSP.VAL_PREC_CONT_UNIT_LOCA * PSP.NUM_UNID_ATEN VAL_PREC_CONT_TOTA_LOCA,
       PSP.VAL_PREC_FACT_TOTA_LOCA,
       PSP.VAL_IMPO_DESC_TOTA_LOCA,
       NVL(PSP.VAL_PORC_DESC, 0) VAL_PORC_DESC,
       PSP.VAL_IMPO_IMPU_TOTA_LOCA,
       POD.IMP_PREC_PUBL,
       PSP.FOPA_OID_FORM_PAGO,
       decode(psc.modu_oid_modu,15,3,nvl(PTO.NUM_SECC_DETA_FACT,2)) IND_GRUP,
       psp.val_codi_orig,
       psp.num_unid_orig,
       psp.oid_nive_ofer,
       decode(mp.val_atri_3,'1','C',nvl(psp.ind_dent_fuer_caja_bols,'F')) ind_dent_fuer_caja_bols, 
       CASE
           WHEN exists (select 1 from pre_ofert x where x.oid_ofer=pod.ofer_oid_ofer and x.coes_oid_estr=v_oidestra)
               THEN v_desOfertNavid
           WHEN exists (select 1 from pre_recup_seman x where x.cod_peri=p_codigoPeriodo and x.cod_vent=psp.val_codi_vent) and (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0)
               THEN v_desRecupSemana
           WHEN (NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0) AND (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremioAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) - NVL(PSP.NUM_UNID_ATEN, 0) > 0
               THEN v_desAgotado
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1 AND (PTO.COD_TIPO_OFER = '21' OR PTO.COD_TIPO_OFER = '23')
               THEN v_desFaltLiq
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.IND_LIMI_VENT = 1
               THEN v_desFaltAnun
           WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2 AND PSP.STPO_OID_SUBT_POSI = 21
               THEN v_desAnulMotMax
           \*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
                AND PSP.ESPO_OID_ESTA_POSI = 2
               THEN 'Vta.Exc'*\
          WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RD'
               THEN v_desAgotado
           \*WHEN NVL(PSP.NUM_UNID_DEMA_REAL, 0) = 0 AND NVL(PSP.NUM_UNID_ATEN, 0) = 0
               THEN 'No.Aplica'*\
           WHEN (PSC.COPA_OID_PARA_GENE IS NOT NULL OR PSC.ICTP_OID_TIPO_PROG IS NOT NULL)
               THEN v_desPremio
           WHEN PSC.MODU_OID_MODU = '15'
               THEN v_desAtRec
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'RE'
               THEN v_desRecup
           WHEN PTP.COD_TIPO_POSI IS NOT NULL AND PTP.COD_TIPO_POSI = 'DA'
               THEN ''
           WHEN PST.COD_SUBT_POSI IS NOT NULL AND PST.COD_SUBT_POSI = 'RZ'
               THEN v_desReemp  || (
                 SELECT distinct POF.Val_Codi_Vent
                 FROM PRE_MATRI_FACTU PMF,
                      PRE_MATRI_REEMP PMR,
                      PRE_MATRI_FACTU PMF2,
                      PRE_OFERT_DETAL POF
                 WHERE PMF.OID_MATR_FACT = PMR.MAFA_OID_COD_REEM
                 AND PMF.OFDE_OID_DETA_OFER = PSP.OFDE_OID_DETA_OFER
                 AND PMR.MAFA_OID_COD_PPAL=PMF2.Oid_Matr_Fact
                 AND PMF2.Ofde_Oid_Deta_Ofer=POF.Oid_Deta_Ofer
                 AND exists (select 1 from ped_solic_posic where soca_oid_soli_cabe=PSC.OID_SOLI_CABE
                              and ofde_oid_deta_ofer=PSP.OFDE_Oid_Deta_Ofer)
                 and rownum=1
                 )
           WHEN PSP.VAL_PREC_CATA_UNIT_LOCA = 0
               THEN v_desGratis
           WHEN TS.Cod_Tipo_Soli = 'IPLC'
               THEN v_desPremioLET
           WHEN psp.ind_recu_prol = '1'
               THEN v_desRecuPROL
           WHEN psp.ind_recu_prol = '2'
               THEN v_desRecuPROL2
           ELSE ''
        END AS VAL_OBSE,
        MP.COD_SAP,
        psp.num_unid_por_aten
FROM PED_SOLIC_CABEC PSC,
     PED_SOLIC_POSIC PSP,
     PRE_OFERT_DETAL POD,
     PRE_TIPO_OFERT PTO,
     PED_TIPO_SOLIC_PAIS TSP,
     PED_TIPO_SOLIC TS,
     PED_TIPO_POSIC PTP,
     PED_SUBTI_POSIC PST,
     mae_produ mp
WHERE PSC.OID_SOLI_CABE = PSP.SOCA_OID_SOLI_CABE
  AND PSC.TSPA_OID_TIPO_SOLI_PAIS = TSP.OID_TIPO_SOLI_PAIS
  AND TSP.TSOL_OID_TIPO_SOLI = TS.OID_TIPO_SOLI
  and psp.prod_oid_prod=mp.oid_prod
  --AND TS.CLSO_OID_CLAS_SOLI = PCS.OID_CLAS_SOLI
  AND PSP.TPOS_OID_TIPO_POSI = PTP.OID_TIPO_POSI (+)
  AND PSP.Stpo_Oid_Subt_Posi = PST.Oid_Subt_Posi (+)
  AND PSP.OFDE_OID_DETA_OFER = POD.OID_DETA_OFER (+)
  AND POD.TOFE_OID_TIPO_OFER = PTO.OID_TIPO_OFER (+)
  AND PSP.ESPO_OID_ESTA_POSI != 2
  AND PSC.SOCA_OID_SOLI_CABE = oidConsolidado
--)
--WHERE IND_GRUP = indicadorGrupo
ORDER BY OID_NIVE_OFER, VAL_CODI_ORIG, VAL_CODI_VENT;

TYPE detallerecord IS RECORD (
    oid_soli_cabe               ped_solic_cabec.oid_soli_cabe%TYPE,
    copa_oid_para_gene          ped_solic_cabec.copa_oid_para_gene%TYPE,
    ictp_oid_tipo_prog          ped_solic_cabec.ictp_oid_tipo_prog%TYPE,
    oid_soli_posi               ped_solic_posic.oid_soli_posi%TYPE,
    val_codi_vent               varchar2(15),
    des_prod                    gen_i18n_sicc_pais.val_i18n%TYPE,
    num_unid_dema_real          ped_solic_posic.num_unid_dema_real%TYPE,
    num_unid_aten               ped_solic_posic.num_unid_aten%TYPE,
    val_prec_cata_unit_loca     ped_solic_posic.val_prec_cata_unit_loca%TYPE,
    val_prec_cata_tota_loca     ped_solic_posic.val_prec_cata_tota_loca%TYPE,
    val_prec_cont_unit_loca     ped_solic_posic.val_prec_cont_unit_loca%TYPE,
    val_prec_cont_tota_loca     ped_solic_posic.val_prec_cont_tota_loca%TYPE,
    val_prec_fact_tota_loca     ped_solic_posic.val_prec_fact_tota_loca%TYPE,
    val_impo_desc_tota_loca     ped_solic_posic.val_impo_desc_tota_loca%TYPE,
    val_porc_desc               ped_solic_posic.val_porc_desc%TYPE,
    val_impo_impu_tota_loca     ped_solic_posic.val_impo_impu_tota_loca%TYPE,
    imp_prec_publ               pre_ofert_detal.imp_prec_publ%TYPE,
    fopa_oid_form_pago          ped_solic_posic.fopa_oid_form_pago%TYPE,
    ind_grupo                   pre_tipo_ofert.num_secc_deta_fact%TYPE,
    val_codi_orig               ped_solic_posic.val_codi_orig%TYPE,
    num_unid_orig               ped_solic_posic.num_unid_orig%TYPE,
    oid_nive_ofer               ped_solic_posic.oid_nive_ofer%TYPE,
    ind_dent_fuer_caja_bols     ped_solic_posic.ind_dent_fuer_caja_bols%TYPE,
    val_obse                    VARCHAR2(1000),
    COD_SAP                     MAE_PRODU.COD_SAP%TYPE,
    Num_Unid_Por_Aten           PED_SOLIC_POSIC.Num_Unid_Por_Aten%TYPE
);

TYPE detalletype IS TABLE OF detallerecord;
r_detalle    detalletype;

-- Variables locales
l_oidPais                   NUMBER;
l_oidPeriodo                NUMBER;
l_oidCanal                  NUMBER;
l_oidMarca                  NUMBER;
--l_correlativo               NUMBER := 1;
l_contadorDetalles          NUMBER := 0;
l_porcDscto                 NUMBER;
l_precioUnitario            NUMBER(12, 2) := 0;
l_precioTotal               NUMBER(12, 2) := 0;
l_descuento                 NUMBER(12, 2) := 0;
l_descuento2                NUMBER(12, 2) := 0;
l_dif_desc                  NUMBER(12, 2) := 0;
l_precioFacturado           NUMBER(12, 2) := 0;
l_pagoPosterior             NUMBER(12, 2) := 0;
l_precioCatalogo            NUMBER(12, 2) := 0;
l_PrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_oportunidadAhorro         NUMBER(12, 2) := 0;

l_subtotalSolicitado        NUMBER := 0;
l_subtotalAtendido          NUMBER := 0;
l_subtotalCatalogo          NUMBER(12, 2) := 0;
l_subtotalDescuentos        NUMBER(12, 2) := 0;
l_subtotalFacturado         NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogo    NUMBER(12, 2) := 0;
l_subtotalPrecioCatalogoTotal       NUMBER(12, 2) := 0;
l_subtotaloportunidadAhorro NUMBER(12, 2) := 0;

l_totalSolicitado           NUMBER := 0;
l_totalAtendido             NUMBER := 0;
l_totalCatalogo             NUMBER(12, 2) := 0;
l_totalDescuentos           NUMBER(12, 2) := 0;
l_totalDescuentos2           NUMBER(12, 2) := 0;
l_totalFacturado            NUMBER(12, 2) := 0;
l_totalPrecioCatalogo       NUMBER(12, 2) := 0;
l_totalPrecioCatalogoTotal  NUMBER(12, 2) := 0;
l_totalOportunidadAhorro    NUMBER(12, 2) := 0;
l_totalImpuestosGratis      NUMBER(12, 2) := 0;
l_saldoFavor                NUMBER(12, 2) := 0;
l_saldoAnterior             NUMBER(12, 2) := 0;
l_saldoFlexAnterior         NUMBER(12, 2) := 0;
l_interesFlexipago          NUMBER(12, 2) := 0;
l_percepcion                NUMBER(12, 2) := 0;
l_totalFactura              NUMBER(12, 2) := 0;
l_cargoFamSegura            NUMBER(12, 2) := 0;
l_totalAPagar               NUMBER(12, 2) := 0;

l_oportunidadCatalogo       NUMBER(12, 2) := 0;
l_oportunidadRevista        NUMBER(12, 2) := 0;

l_indicadorEnvioLarissa     VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioLarissa');
l_indicadorEnvioUltimoLote  VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorEnvioUltimoLote');
l_indicadorCargoFamSegura   VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorCargoFamSegura'),'N');
l_indicadorImpuestosGratis  VARCHAR2(1) := 'N';
l_totalPagoPosterior        NUMBER(12, 2) := 0;
l_indicadorPercepcion       VARCHAR2(1) := 'N';
l_numeroLoteFacturacion     NUMBER;
--l_textoActual               VARCHAR2(20000) := '';
l_codigoPeriodoSiguiente    VARCHAR2(6);
l_cambioLineaRetornoCarro   VARCHAR2(2) := CHR(13) || CHR(10);
l_formatoNumerico           VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'formatoNumerico'),'9999999G990D00');
l_tasaImpuestoPercepcion    NUMBER(5, 3);
--nuevo parametro
l_indicadorGenerarDetalleFact2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'indicadorGenerarDetalleFactura2');

l_nombreSeccion1 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion1');
l_nombreSeccion2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion2');
l_nombreSeccion3 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion3');
l_nombreSeccion4 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'nombreSeccion4');

l_desRecupSemana VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecupSemana');
l_desPremioAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioAgotado');
l_desAgotado VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAgotado');
l_desFaltLiq VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltLiq');
l_desFaltAnun VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desFaltAnun');
l_desAnulMotMax VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAnulMotMax');
l_desPremio VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremio');
l_desAtRec VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desAtRec');
l_desRecup VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecup');
l_desReemp VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desReemp');
l_desGratis VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desGratis');
l_desPremioLET VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desPremioLET');
l_desOfertNavid VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desOfertNavid');
l_desRecuPROL VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecuPROL');
l_desRecuPROL2 VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'desRecuPROL2');



l_mensajeOportunidadAhorro VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_fechaVencimiento VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'mensajeOportunidadAhorro');

l_flagTitulo1     NUMBER:=0;
l_flagTitulo2     NUMBER:=0;
l_flagTitulo3     NUMBER:=0;
l_flagTitulo4     NUMBER:=0;

l_cantidadOC      NUMBER:=0;

lv_indiejec VARCHAR2(10):=nvl(sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_GASTO_ADMIN'),'N');

lv_indiejec2 VARCHAR2(10):=IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','impuestoEstatal');


lv_reemplazoOCS VARCHAR2(100) := IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indicadorReemplazoOCS');

lv_actividadConf VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadConf'),'CV');

lv_actividadDesp VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','actividadDesp'),'DP');

lv_imprimepaqdoc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimepaqdoc'),'N');

lv_imprimefactel VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimefactel'),'N');

lv_imprimenuevos VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','imprimenuevos'),'N');

lv_redondeoDesc VARCHAR2(100) := nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','redondeoDesc'),'S');


ln_oidestra NUMBER(10):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,'STO_ESTRA_NAVID');

ln_diasdesp NUMBER(10):= 0;
ln_diasdesp2 NUMBER(10):= 0;
ln_diasdesp3 NUMBER(10):= 0;


l_fechaCV VARCHAR2(100) := '';
l_fechaDespacho VARCHAR2(100) := '';
l_fechaDespacho_2 VARCHAR2(100) := '';
l_fechaDespacho_3 VARCHAR2(100) := '';
l_fechaDespacho2 VARCHAR2(100) :=  nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS','indFechaDesp2'),'N');
l_fechaSigFact VARCHAR2(100) := '';
l_fechaSigFact2 VARCHAR2(100) := '';
l_fechaSigFact3 VARCHAR2(100) := '';

lsactividadparametro VARCHAR2(100):= sto_pkg_gener.sto_fn_obten_param_ocr(p_codigoPais,
                                                                 'STO_ACTIV_RECAR_FLET');
lscodperigastos VARCHAR2(10);

ln_desc_flete VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'descFlete'),'N');

ln_desc_flete2 VARCHAR2(2):=nvl(IMP_PKG_PROCE_GENER.IMP_FN_OBTIE_PARAM_IMPRE('LAS', 'descFlete2'),'N');

orig_ante VARCHAR2(100):='';

lsCodigoVenta varchar2(15);
lsUnidadesDemandadas number(12);
lsUnidadesAtendidas number(6);
lsObservacion VARCHAR2(1000);
lsOidCabecera number(12);

lsTotalCatalogo             NUMBER(12, 2) := 0;
lsTotalDescuentos           NUMBER(12, 2) := 0;
lsTotalFacturado            NUMBER(12, 2) := 0;
lsTotalFlete                NUMBER(12, 2) := 0;
lsTotalPercepciones         NUMBER(12, 2) := 0;
lsTotalFactura              NUMBER(12, 2) := 0;
lsPagosPosteriores          NUMBER(12, 2) := 0;
lsAbonoAtencionServicios    NUMBER(12, 2) := 0;
lsSaldoAnterior             NUMBER(12, 2) := 0;
lsImporteActual             NUMBER(12, 2) := 0;
lsOportunidadCatalogo       NUMBER(12, 2) := 0;
lsOportunidadRevista        NUMBER(12, 2) := 0;
lsOportunidadTotal          NUMBER(12, 2) := 0;
lsMensaje                   VARCHAR2(60);
lsFechaVencimiento          VARCHAR2(60);
lsGastosAdministrativos     NUMBER(12, 2) := 0;      
lsSaldoFlexipago            NUMBER(12, 2) := 0;
lsCuotaFlexipago            NUMBER(12, 2) := 0;
lsRecargoFlete              NUMBER(12, 2) := 0;
lsDescuentoCabecera         NUMBER(12, 2) := 0;
lsCampanaGastosAdministrativos         VARCHAR2(10);                          
lsDescuentoCabecera2         NUMBER(12, 2) := 0;
lsReclamosPendientes         NUMBER(12, 2) := 0;

lsImpuesto                   NUMBER(12, 2) := 0;
lsSubTotalFlete              NUMBER(12, 2) := 0;
lsSubTotalFleteImpuesto      NUMBER(12, 2) := 0;
lsDescuentoFlete             NUMBER(12, 2) := 0;
lsTotalImpuestosGratis       NUMBER(12, 2) := 0;

BEGIN


    -- Obtenemos el OID del periodo
    l_oidPais    := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(p_codigoPais);
    l_oidCanal   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(CODIGO_CANAL);
    l_oidMarca   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(CODIGO_MARCA);
    l_oidPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO(p_codigoPeriodo, l_oidMarca, l_oidCanal);
    l_codigoPeriodoSiguiente := GEN_FN_CALCU_PERIO(p_codigoPeriodo, 1);

    --SOLO SE JECUTARA EL PROCESO SI PARAMETRO ES S, EN OTRO CASO NO SE EJECUTARA
    IF(l_indicadorEnvioUltimoLote = '1' OR l_indicadorEnvioUltimoLote = 'S') THEN

        BEGIN
            select max(cons.num_lote_fact)
            into l_numeroLoteFacturacion
            from ped_solic_cabec cons,
                 int_lar_tipo_solici_pedido_dis tspd
            where cons.perd_oid_peri = l_oidPeriodo
             and  cons.fec_fact = to_date(p_fechaFacturacion, 'dd/mm/yyyy')
             and  cons.ind_ts_no_conso = 0
             and  (cons.ind_pedi_prue = 0 or cons.ind_pedi_prue is null)
             and  cons.tspa_oid_tipo_soli_pais = tspd.tspa_oid_tipo_soli_pais
             and  cons.pais_oid_pais = l_oidPais;
        EXCEPTION
          WHEN OTHERS THEN
              l_numeroLoteFacturacion := null;
        END;

    END IF;

    -- Obtenemos el valor del indicador de impuestos a los productos gratis
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorImpuestosGratis
    from seg_pais p,
         seg_param_inter_pais i
    where p.oid_pais = i.pais_oid_pais
    and i.ind_impu_prod_grat = 1
    and p.cod_pais = p_codigoPais;

    -- Obtenemos el valor del indicador de percepciones
    select decode(count(*), 0, 'N', 'S')
    into l_indicadorPercepcion
    from fac_formu_perce ffp
    where ffp.pais_oid_pais = l_oidPais;

    -- Obtenemos el valor de la tasa de impuesto por percepciones
    IF l_indicadorPercepcion = 'S' THEN
        BEGIN
            select pti.val_tasa_impu
            into l_tasaImpuestoPercepcion
            from ped_tasa_impue pti
            where pti.pais_oid_pais = l_oidPais
            and pti.val_indi_impu = 'PER'; -- Codigo Percepciones

        EXCEPTION
        WHEN NO_DATA_FOUND THEN

            l_tasaImpuestoPercepcion := 0;

        END;
    END IF;

    -- Abrimos el cursor principal
    OPEN c_consolidados(l_oidPeriodo, l_indicadorEnvioLarissa, l_numeroLoteFacturacion, p_oidZona);
    LOOP
        FETCH c_consolidados BULK COLLECT
        INTO r_consolidado LIMIT w_filas;

        IF  r_consolidado.COUNT > 0 THEN
            FOR i IN r_consolidado.FIRST..r_consolidado.LAST
            LOOP

                l_flagTitulo1:=0;
                l_flagTitulo2:=0;
                l_flagTitulo3:=0;
                l_flagTitulo4:=0;
                
                lsOidCabecera:= IMP_PRPR_SEQ.Nextval;

                if lv_imprimefactel='S' then
                  if r_consolidado(i).tipo_docum<>'RUC' then
                     r_consolidado(i).imprimefactel:='1';
                  end if;
                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;

                -- Ind. Impresion FE
                --l_textoActual := l_textoActual || '<imprimefactel>' || r_consolidado(i).imprimefactel || '</imprimefactel>';

                \*if lv_imprimepaqdoc='S' then
                  -- Ind. Impresion
                  l_textoActual := l_textoActual || '<imprimepaqdoc>' || r_consolidado(i).imprimepaqdoc || '</imprimepaqdoc>';

                  --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                end if;*\

                if lv_imprimenuevos='S' then

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy'),to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaDespacho,l_fechaDespacho_2,l_fechaDespacho_3
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadDesp;
                  exception when others then
                    l_fechaDespacho:=trunc(sysdate);
                    l_fechaDespacho_2:=trunc(sysdate);
                    l_fechaDespacho_3:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaSigFact
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)

                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = 'FA';
                  exception when others then
                    l_fechaSigFact:=trunc(sysdate);
                  end;

                  begin
                  SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                  INTO l_fechaCV
                  FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                  WHERE cc.PERD_OID_PERI = cp.oid_peri
                    AND cp.peri_oid_peri = spc.oid_peri
                    AND spc.cod_peri = l_codigoPeriodoSiguiente
                    AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                    AND cc.CACT_OID_ACTI = act.OID_ACTI
                    AND act.COD_ACTI = lv_actividadConf;
                  exception when others then
                    l_fechaCV:=trunc(sysdate);
                  end;


                  l_fechaSigFact2:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,2),'dd/mm/yyyy');

                  l_fechaSigFact3:=to_char(fac_pkg_proc.ped_fn_dev_dia_fact(l_codigoPeriodoSiguiente,r_consolidado(i).cod_zona,3),'dd/mm/yyyy');

                  ln_diasdesp:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,1,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp2:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,2,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));
                  ln_diasdesp3:=fac_pkg_proc.ped_fn_obt_dias_fecha_ent(r_consolidado(i).oid_soli_cabe,3,l_codigoPeriodoSiguiente, to_date(l_fechaSigFact,'dd/mm/yyyy'));


                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho:=to_char(to_date(l_fechaSigFact,'dd/mm/yyyy')+ln_diasdesp,'dd/mm/yyyy');
                  end if;


                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_2:=to_char(to_date(l_fechaSigFact2,'dd/mm/yyyy')+ln_diasdesp2,'dd/mm/yyyy');
                  end if;

                  if l_fechaDespacho2='S' and ln_diasdesp>0 then
                    l_fechaDespacho_3:=to_char(to_date(l_fechaSigFact3,'dd/mm/yyyy')+ln_diasdesp3,'dd/mm/yyyy');
                  end if;



                  -- Nombre Consultora
                 \*l_textoActual := l_textoActual || '<nombres>' || r_consolidado(i).val_nom1 || ' ' || r_consolidado(i).val_nom2 || '</nombres>';
                  l_textoActual := l_textoActual || '<apellidos>' || r_consolidado(i).val_ape1 || ' ' || r_consolidado(i).val_ape2 || '</apellidos>';
                  l_textoActual := l_textoActual || '<nombresGZ>' || r_consolidado(i).nombresGZ || '</nombresGZ>';
                  l_textoActual := l_textoActual || '<apellidosGZ>' || r_consolidado(i).apellidosGZ || '</apellidosGZ>';
                  l_textoActual := l_textoActual || '<celularGZ>' || r_consolidado(i).celularGZ || '</celularGZ>';
                  l_textoActual := l_textoActual || '<correoGZ>' || r_consolidado(i).correoGZ || '</correoGZ>';
                  l_textoActual := l_textoActual || '<fechaCV>' || l_fechaCV || '</fechaCV>';
                  l_textoActual := l_textoActual || '<fechaReparto>' || l_fechaDespacho || '</fechaReparto>';
                  l_textoActual := l_textoActual || '<fechaReparto2>' || l_fechaDespacho_2 || '</fechaReparto2>';
                  l_textoActual := l_textoActual || '<fechaReparto3>' || l_fechaDespacho_3 || '</fechaReparto3>';
                  l_textoActual := l_textoActual || '<fechaSigFact>' || l_fechaSigFact || '</fechaSigFact>';
                  l_textoActual := l_textoActual || '<fechaSigFact2>' || l_fechaSigFact2 || '</fechaSigFact2>';
                  l_textoActual := l_textoActual || '<fechaSigFact3>' || l_fechaSigFact3 || '</fechaSigFact3>';
                  l_textoActual := l_textoActual || '<diasDesp>' || ln_diasdesp || '</diasDesp>';
                  l_textoActual := l_textoActual || '<tipo_docum>' || r_consolidado(i).tipo_docum || '</tipo_docum>';
                  l_textoActual := l_textoActual || imp_fn_xml_opor_ahor(p_codigoPeriodo,l_oidPeriodo,r_consolidado(i).oid_clie);
                  l_textoActual := l_textoActual || '<nriesgo>' || r_consolidado(i).nr || '</nriesgo>';*\
                end if;
                \*
                -- Numero Pedido
                l_textoActual := l_textoActual || '<numpedido>' || r_consolidado(i).val_nume_soli || '</numpedido>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Descripcion Pais
                l_textoActual := l_textoActual || '<lugar>' || r_consolidado(i).des_pais || '</lugar>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Dia
                l_textoActual := l_textoActual || '<dia>' || to_char(r_consolidado(i).fec_fact, 'dd') || '</dia>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Mes
                l_textoActual := l_textoActual || '<mes>' || to_char(r_consolidado(i).fec_fact, 'mm') || '</mes>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- A?o
                l_textoActual := l_textoActual || '<ano>' || to_char(r_consolidado(i).fec_fact, 'yyyy') || '</ano>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Codigo Cliente
                l_textoActual := l_textoActual || '<codconsultora>' || r_consolidado(i).cod_clie || '</codconsultora>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Territorio Cliente
                l_textoActual := l_textoActual || '<territorio>';
                l_textoActual := l_textoActual || r_consolidado(i).cod_zona || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_secc || '-';
                l_textoActual := l_textoActual || r_consolidado(i).cod_terr || '-';
                l_textoActual := l_textoActual || r_consolidado(i).num_secu_fact_diar;
                l_textoActual := l_textoActual || '</territorio>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Documento de Identidad
                l_textoActual := l_textoActual || '<rifci>' || r_consolidado(i).num_docu_iden || '</rifci>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Nombre Cliente
                l_textoActual := l_textoActual || '<nombre>';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_nom2 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape1 || ' ';
                l_textoActual := l_textoActual || r_consolidado(i).val_ape2;
                l_textoActual := l_textoActual || '</nombre>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Periodo
                l_textoActual := l_textoActual || '<campana>' || p_codigoPeriodo || '</campana>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);



                l_textoActual := l_textoActual || IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_CLASI_BOLET_DESPA( r_consolidado(i).cod_clie) ||
              IMP_PKG_PROCE_COMPA.IMP_FN_ETIQU_ESTAT_BOLET_DESPA( r_consolidado(i).cod_clie);


                -- Fin Cabecera
                l_textoActual := l_textoActual || '</blqcab>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);


                -- Inicio Detalle
                l_textoActual := '<detalle>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*\
                
                -- Iniciamos los totales
                l_totalSolicitado := 0;
                l_totalAtendido := 0;
                l_totalDescuentos := 0;
                l_totalCatalogo := 0;
                l_totalDescuentos := 0;
                l_totalImpuestosGratis := 0;
                l_totalFacturado := 0;
                l_totalPrecioCatalogo := 0;
                l_totalPrecioCatalogoTotal := 0;
                l_totalOportunidadAhorro := 0;
                l_oportunidadRevista:=0;
                l_oportunidadCatalogo:=0;
                
                
                \*INSERTAMOS LA CABECERA*\
                INSERT INTO IMP_PRINT_PEDID_RESUM
                    (
                      PRSP_COD_PROC,
                      PRSP_COD_CLIE,
                      PRSP_COD_PAQU,
                      OID_PEDI_RESU,
                      USU_CREA,
                      FEC_CREA,
                      IND_ACTI
                    )VALUES
                    (
                      psCodigoTransaccional,
                      r_consolidado(i).cod_clie,
                      psCodigoPaquete,
                      lsOidCabecera,
                      psCodigoUsuario,
                      SYSDATE,
                      1
                    );
                    \**\
                    \*INSERTAMOS LOS TITULOS*\
                    \**\
                            INSERT INTO IMP_PRINT_PEDID_DETAL
                            (
                              PRSP_COD_PROC,     
                              PRSP_COD_CLIE,     
                              PRSP_COD_PAQU,
                              OID_PEDI_RESU,     
                              OID_PEDI_DETAL,    
                              NUM_ORDE,          
                              TIP_FILA,          
                              DES_FILA,          
                              COD_CUV,          
                              COD_SAP,          
                              NOM_PROD,          
                              VAL_UNID_SOLI,     
                              VAL_UNID_ATEN,     
                              VAL_UNID_FALT,     
                              MON_PREC_UNIT,     
                              MON_PREC_UNIT_SIVA,
                              MON_TOTA_ATEN,     
                              MON_PORC_DCTO,     
                              MON_TOTA_DCTO,     
                              MON_PREC_CATA,     
                              MON_TOTA_CATA,     
                              MON_OPOR_AHOR,     
                              MON_TOTA_FACT,     
                              VAL_OBSE,          
                              VAL_PUNT,          
                              IND_FUER_CAJA,    
                              USU_CREA,          
                              FEC_CREA,                  
                              IND_ACTI          
                            ) VALUES 
                            (
                              psCodigoTransaccional,     
                              r_consolidado(i).cod_clie,     
                              psCodigoPaquete,
                              lsOidCabecera,     
                              IMP_PRPD_SEQ.NEXTVAL,    
                              NULL,          
                              'PH',          
                              NULL,          
                              null,          
                              'COD.',          
                              'PRODUCTO',          
                              'SOLIC',     
                              'ATND',     
                              null,     
                              'PRECIO UNIT',     
                              NULL,
                              'TOTAL ATENDIDO',     
                              '% DESC',     
                              'TOTAL DSCTO',     
                              'PRECIO CATALOGO',     
                              'TOTAL CATALOGO',     
                              'OPORT. AHORRO',     
                              'TOTAL FACTURADO',     
                              'OBSERVACIONES',          
                              NULL,          
                              NULL,    
                              psCodigoUsuario,          
                              sysdate,                  
                              1);
                            \**\
                \**\

                -- Iteramos por las secciones del detalle
                    OPEN c_detalle(r_consolidado(i).oid_soli_cabe
                      ,l_desPremioAgotado
                      ,l_desAgotado
                      ,l_desFaltLiq
                      ,l_desFaltAnun
                      ,l_desAnulMotMax
                      ,l_desPremio
                      ,l_desAtRec
                      ,l_desRecup
                      ,l_desReemp
                      ,l_desGratis
                      ,l_desPremioLET
                      ,l_desRecupSemana
                      ,l_desOfertNavid
                      ,ln_oidestra
                      ,l_desRecuPROL
                      ,l_desRecuPROL2
                    );
                    LOOP
                        FETCH c_detalle BULK COLLECT
                        INTO r_detalle LIMIT w_filas;
                FOR k IN 0..3
                LOOP

                    orig_ante:=null;

                    -- Iniciamos los subtotales

                    l_contadorDetalles := 0;
                    l_subtotalSolicitado := 0;
                    l_subtotalAtendido := 0;
                    l_subtotalCatalogo := 0;
                    l_subtotalDescuentos := 0;
                    l_subtotalFacturado := 0;
                    l_subtotalPrecioCatalogo := 0;
                    l_subtotalPrecioCatalogoTotal := 0;
                    l_subtotaloportunidadAhorro := 0;
                    l_oportunidadAhorro := 0;

                    -- Mostramos el titulo


                        IF  r_detalle.COUNT > 0 THEN
                            FOR j IN r_detalle.FIRST..r_detalle.LAST
                            LOOP
                            
                            
                            if r_detalle(j).ind_grupo=k then
           
                                IF k = 0 and l_flagTitulo1=0 THEN
                                  INSERT INTO IMP_PRINT_PEDID_DETAL
                                  (
                                    PRSP_COD_PROC,     
                                    PRSP_COD_CLIE,     
                                    PRSP_COD_PAQU,
                                    OID_PEDI_RESU,     
                                    OID_PEDI_DETAL,    
                                    NUM_ORDE,          
                                    TIP_FILA,          
                                    DES_FILA,          
                                    COD_CUV,           
                                    USU_CREA,          
                                    FEC_CREA,                  
                                    IND_ACTI          
                                  ) VALUES 
                                  (
                                    psCodigoTransaccional,     
                                    r_consolidado(i).cod_clie,     
                                    psCodigoPaquete,
                                    lsOidCabecera,     
                                    IMP_PRPD_SEQ.NEXTVAL,    
                                    NULL,          
                                    'PH',          
                                    NULL,          
                                    l_nombreSeccion1,          
                                    psCodigoUsuario,          
                                    sysdate,                  
                                    1);
                                    --l_textoActual := '<txt><u>' || l_nombreSeccion1 || '</u></txt><txt><t/></txt>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo1:=1;
                                ELSIF k = 1 and l_flagTitulo2=0 THEN
                                      INSERT INTO IMP_PRINT_PEDID_DETAL
                                      (
                                        PRSP_COD_PROC,     
                                        PRSP_COD_CLIE,     
                                        PRSP_COD_PAQU,
                                        OID_PEDI_RESU,     
                                        OID_PEDI_DETAL,    
                                        NUM_ORDE,          
                                        TIP_FILA,          
                                        DES_FILA,          
                                        COD_CUV,           
                                        USU_CREA,          
                                        FEC_CREA,                  
                                        IND_ACTI          
                                      ) VALUES 
                                      (
                                        psCodigoTransaccional,     
                                        r_consolidado(i).cod_clie,     
                                        psCodigoPaquete,
                                        lsOidCabecera,     
                                        IMP_PRPD_SEQ.NEXTVAL,    
                                        NULL,          
                                        'PH',          
                                        NULL,          
                                        l_nombreSeccion2,          
                                        psCodigoUsuario,          
                                        sysdate,                  
                                        1);
                                    --l_textoActual := '<txt/>';
                                    --l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion2 || '</u></txt><txt><t/></txt>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo2:=1;
                                ELSIF k = 2 and l_flagTitulo3=0 THEN
                                      INSERT INTO IMP_PRINT_PEDID_DETAL
                                      (
                                        PRSP_COD_PROC,     
                                        PRSP_COD_CLIE,     
                                        PRSP_COD_PAQU,
                                        OID_PEDI_RESU,     
                                        OID_PEDI_DETAL,    
                                        NUM_ORDE,          
                                        TIP_FILA,          
                                        DES_FILA,          
                                        COD_CUV,           
                                        USU_CREA,          
                                        FEC_CREA,                  
                                        IND_ACTI          
                                      ) VALUES 
                                      (
                                        psCodigoTransaccional,     
                                        r_consolidado(i).cod_clie,     
                                        psCodigoPaquete,
                                        lsOidCabecera,     
                                        IMP_PRPD_SEQ.NEXTVAL,    
                                        NULL,          
                                        'PH',          
                                        NULL,          
                                        l_nombreSeccion3,          
                                        psCodigoUsuario,          
                                        sysdate,                  
                                        1);
                                    --l_textoActual := '<txt/>';
                                    --l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion3 || '</u></txt><txt><t/></txt>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo3:=1;
                                ELSIF k = 3 and l_flagTitulo4=0 THEN
                                      INSERT INTO IMP_PRINT_PEDID_DETAL
                                      (
                                        PRSP_COD_PROC,     
                                        PRSP_COD_CLIE,     
                                        PRSP_COD_PAQU,
                                        OID_PEDI_RESU,     
                                        OID_PEDI_DETAL,    
                                        NUM_ORDE,          
                                        TIP_FILA,          
                                        DES_FILA,          
                                        COD_CUV,           
                                        USU_CREA,          
                                        FEC_CREA,                  
                                        IND_ACTI          
                                      ) VALUES 
                                      (
                                        psCodigoTransaccional,     
                                        r_consolidado(i).cod_clie,     
                                        psCodigoPaquete,
                                        lsOidCabecera,     
                                        IMP_PRPD_SEQ.NEXTVAL,    
                                        NULL,          
                                        'PH',          
                                        NULL,          
                                        l_nombreSeccion4,          
                                        psCodigoUsuario,          
                                        sysdate,                  
                                        1);
                                    --l_textoActual := '<txt/>';
                                    --l_textoActual := l_textoActual || '<txt><u>' || l_nombreSeccion4 || '</u></txt><txt><t/></txt>';
                                    --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                    l_flagTitulo4:=1;
                                END IF;
                                -- Calculo de valores
                                IF r_detalle(j).copa_oid_para_gene IS NOT NULL
                                OR r_detalle(j).ictp_oid_tipo_prog IS NOT NULL THEN
                                    -- Si se trata de un premio
                                    l_precioUnitario := 0;
                                    l_precioTotal := 0;
                                    l_porcDscto := 100;
                                    l_descuento := 0;
                                    l_precioFacturado := 0;
                                    l_pagoPosterior := 0;
                                    l_oportunidadAhorro := 0;
                                    l_precioCatalogo := 0;
                                    l_PrecioCatalogoTotal := 0;
                                ELSE
                                    IF r_detalle(j).val_prec_cata_unit_loca = 0 THEN
                                        -- Si es un gratis
                                        l_precioUnitario := r_detalle(j).val_prec_cont_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cont_tota_loca;
                                        l_porcDscto := 100;
                                        l_descuento := r_detalle(j).val_prec_cont_tota_loca;
                                        l_precioFacturado := 0;
                                        l_totalImpuestosGratis := l_totalImpuestosGratis + r_detalle(j).val_impo_impu_tota_loca;
                                        l_pagoPosterior := 0;
                                        l_oportunidadAhorro := 0;
                                        l_precioCatalogo := 0;
                                        l_PrecioCatalogoTotal := 0;
                                        if r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        end if;
                                    ELSE
                                        -- Producto con descuento
                                        l_precioUnitario := r_detalle(j).val_prec_cata_unit_loca;
                                        l_precioTotal := r_detalle(j).val_prec_cata_tota_loca;
                                        l_porcDscto := r_detalle(j).val_porc_desc;
                                        l_descuento := r_detalle(j).val_impo_desc_tota_loca;
                                        l_descuento2 := r_detalle(j).val_prec_cata_tota_loca*(r_detalle(j).val_porc_desc/100);
                                        l_precioFacturado := r_detalle(j).val_prec_fact_tota_loca;
                                        if ln_desc_flete2='S' then
                                           l_precioFacturado:=r_detalle(j).val_prec_cata_tota_loca-l_descuento2;
                                        end if;
                                        if r_detalle(j).ind_grupo=0 then
                                           l_precioCatalogo := l_precioUnitario;
                                           l_PrecioCatalogoTotal := l_precioTotal;
                                           l_oportunidadAhorro := l_descuento;
                                            if ln_desc_flete2='S' then
                                               l_oportunidadAhorro := l_descuento2;
                                            end if;
                                        elsif r_detalle(j).ind_grupo=1 then
                                           l_precioCatalogo := nvl(r_detalle(j).imp_prec_publ,0);
                                           l_PrecioCatalogoTotal := nvl(r_detalle(j).imp_prec_publ,0)*r_detalle(j).num_unid_aten;
                                           l_oportunidadAhorro := l_PrecioCatalogoTotal-l_precioTotal;
                                           if l_oportunidadAhorro<0 then
                                              l_oportunidadAhorro:=0;
                                           end if;
                                        else
                                           l_precioCatalogo := 0;
                                           l_PrecioCatalogoTotal := 0;
                                           l_oportunidadAhorro := 0;
                                        end if;

                                        -- Pago posterior (fraccionado)
                                        --l_pagoPosterior := IMP_PKG_PROCE_COMPA.IMP_FN_CALCU_PAGO_POSTE(r_detalle(j).oid_soli_posi, l_codigoPeriodoSiguiente);
                                    END IF;
                                END IF;

                                if (orig_ante is null and r_detalle(j).val_codi_orig is not null) or (orig_ante is not null and orig_ante<>r_detalle(j).val_codi_orig and r_detalle(j).val_codi_orig is not null) then
 
                                 --l_textoActual := '<txt>H' || '<t/>';

                                      -- Codigo de Venta
                                      lsCodigoVenta:= r_detalle(j).val_codi_orig;
      
                                      -- Unidades demandadas
                                      lsUnidadesDemandadas :=  r_detalle(j).num_unid_orig;
      
                                      -- Unidades atendidas
                                      lsUnidadesAtendidas := 0;
      
                                      -- Precio unitario
                                      l_precioUnitario:= 0;
      
                                      -- Precio total
                                      l_precioTotal:= 0;
      
                                      -- % Descuento
                                      l_porcDscto := 0;
      
                                      -- Importe Descuento
                                      l_descuento := 0;
      
                                      -- Precio Catalogo
                                      l_precioCatalogo := 0;
      
                                      -- Total Precio Catalogo
                                      l_precioCatalogoTotal := 0;
      
                                      -- Oportunidad de Ahorro
                                      l_oportunidadAhorro := 0;
      
                                      -- Total con Descuento
                                      l_precioFacturado := 0;
      
                                      -- Observaciones
                                      lsObservacion := '';

                                
                                end if;
                                
                                --l_textoActual := '<txt>';
                                
                               \* if r_detalle(j).val_codi_orig is not null then
                                   --l_textoActual := l_textoActual || 'D<t/>';
                                end if;*\

                                -- Codigo de Venta
                                lsCodigoVenta:= r_detalle(j).val_codi_vent;

                                -- Unidades demandadas
                                lsUnidadesDemandadas := r_detalle(j).num_unid_dema_real;

                                -- Unidades atendidas
                                lsUnidadesAtendidas :=  r_detalle(j).num_unid_aten;

                               \* -- Precio unitario
                                l_textoActual := l_textoActual || trim(to_char(l_precioUnitario, l_formatoNumerico));

                                -- Precio total
                                l_textoActual := l_textoActual || trim(to_char(l_precioTotal, l_formatoNumerico));

                                -- % Descuento
                                l_textoActual := l_textoActual || l_porcDscto;

                                -- Importe Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_descuento, l_formatoNumerico));

                                -- Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogo, l_formatoNumerico));

                                -- Total Precio Catalogo
                                l_textoActual := l_textoActual || trim(to_char(l_precioCatalogoTotal, l_formatoNumerico));

                                -- Oportunidad de Ahorro
                                l_textoActual := l_textoActual || trim(to_char(l_oportunidadAhorro, l_formatoNumerico));

                                -- Total con Descuento
                                l_textoActual := l_textoActual || trim(to_char(l_precioFacturado, l_formatoNumerico));
                                *\
                                -- Observaciones
                                lsObservacion := r_detalle(j).val_obse;
                                
                                \*if p_codigoPais='BOE' then
                                    -- Indicador Fuera de Caja
                                    l_textoActual := l_textoActual || r_detalle(j).ind_dent_fuer_caja_bols;
                                    l_textoActual := l_textoActual || '</txt>';
                                end if;*\
                                
                                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                                l_contadorDetalles := l_contadorDetalles + 1;
                                l_subtotalSolicitado := l_subtotalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_subtotalAtendido := l_subtotalAtendido + r_detalle(j).num_unid_aten;
                                l_subtotalCatalogo := l_subtotalCatalogo + l_precioTotal;
                                l_subtotalDescuentos := l_subtotalDescuentos + l_descuento;
                                l_subtotalFacturado := l_subtotalFacturado + l_precioFacturado;
                                l_subtotalPrecioCatalogo := l_subtotalPrecioCatalogo + l_precioCatalogo;
                                l_subtotalPrecioCatalogoTotal := l_subtotalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_subtotaloportunidadAhorro := l_subtotaloportunidadAhorro + l_oportunidadAhorro;

                                l_totalSolicitado := l_totalSolicitado + r_detalle(j).num_unid_dema_real;
                                l_totalAtendido := l_totalAtendido + r_detalle(j).num_unid_aten;
                                l_totalCatalogo := l_totalCatalogo + l_precioTotal;
                                l_totalDescuentos := l_totalDescuentos + l_descuento;
                                l_totalDescuentos2 := l_totalDescuentos2 + l_descuento2;
                                l_totalFacturado := l_totalFacturado + l_precioFacturado;
                                l_totalPrecioCatalogo := l_totalPrecioCatalogo + l_precioCatalogo;
                                l_totalPrecioCatalogoTotal := l_totalPrecioCatalogoTotal + l_PrecioCatalogoTotal;
                                l_totalOportunidadAhorro := l_totalOportunidadAhorro + l_oportunidadAhorro;
                                
                                orig_ante:=r_detalle(j).val_codi_orig;
                                
                                \*INSERTAMOS EL DETALLE*\
                            INSERT INTO IMP_PRINT_PEDID_DETAL
                            (
                              PRSP_COD_PROC,     
                              PRSP_COD_CLIE,     
                              PRSP_COD_PAQU,
                              OID_PEDI_RESU,     
                              OID_PEDI_DETAL,    
                              NUM_ORDE,          
                              TIP_FILA,          
                              DES_FILA,          
                              COD_CUV,          
                              COD_SAP,          
                              NOM_PROD,          
                              VAL_UNID_SOLI,     
                              VAL_UNID_ATEN,     
                              VAL_UNID_FALT,     
                              MON_PREC_UNIT,     
                              MON_PREC_UNIT_SIVA,
                              MON_TOTA_ATEN,     
                              MON_PORC_DCTO,     
                              MON_TOTA_DCTO,     
                              MON_PREC_CATA,     
                              MON_TOTA_CATA,     
                              MON_OPOR_AHOR,     
                              MON_TOTA_FACT,     
                              VAL_OBSE,          
                              VAL_PUNT,          
                              IND_FUER_CAJA,    
                              USU_CREA,          
                              FEC_CREA,                  
                              IND_ACTI          
                            ) VALUES 
                            (
                              psCodigoTransaccional,     
                              r_consolidado(i).cod_clie,     
                              psCodigoPaquete,
                              lsOidCabecera,     
                              IMP_PRPD_SEQ.NEXTVAL,    
                              NULL,          
                              'PD',          
                              NULL,          
                              lsCodigoVenta,          
                              r_detalle(j).cod_sap,          
                              r_detalle(j).des_prod,          
                              nvl(lsUnidadesDemandadas,0),     
                              nvl(lsUnidadesAtendidas,0),     
                              nvl((nvl(lsUnidadesDemandadas,0) - nvl(lsUnidadesAtendidas,0)),0),     
                              l_precioUnitario,     
                              NULL,
                              l_precioTotal,     
                              l_porcDscto,     
                              l_descuento,     
                              l_precioCatalogo,     
                              l_precioCatalogoTotal,     
                              l_oportunidadAhorro,     
                              l_precioFacturado,     
                              SUBSTR(lsObservacion, 0, 60),          
                              NULL,          
                              r_detalle(j).ind_dent_fuer_caja_bols,    
                              psCodigoUsuario,          
                              sysdate,                  
                              1);
                            \**\
                                
                            end if;
                            END LOOP;
                        END IF;

                    -- Cerramos el cursor de detalles

                    -- Subtotales
                    IF l_contadorDetalles > 0 THEN
                      \*
                        l_textoActual := '<txt><t/><u>Sub Total:</u><tr/>';
                        l_textoActual := l_textoActual || l_subtotalSolicitado;
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || l_subtotalAtendido;
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/><tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalDescuentos, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogo, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalPrecioCatalogoTotal, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotaloportunidadAhorro, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || trim(to_char(l_subtotalFacturado, l_formatoNumerico));
                        l_textoActual := l_textoActual || '<tr/>';
                        l_textoActual := l_textoActual || '</txt>';
                        --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);*\
                        \*INSERTAMOS LOS SUBTOTALES*\
                            INSERT INTO IMP_PRINT_PEDID_DETAL
                            (
                              PRSP_COD_PROC,     
                              PRSP_COD_CLIE,     
                              PRSP_COD_PAQU,
                              OID_PEDI_RESU,     
                              OID_PEDI_DETAL,    
                              NUM_ORDE,          
                              TIP_FILA,          
                              DES_FILA,          
                              COD_CUV,          
                              COD_SAP,          
                              NOM_PROD,          
                              VAL_UNID_SOLI,     
                              VAL_UNID_ATEN,     
                              VAL_UNID_FALT,     
                              MON_PREC_UNIT,     
                              MON_PREC_UNIT_SIVA,
                              MON_TOTA_ATEN,     
                              MON_PORC_DCTO,     
                              MON_TOTA_DCTO,     
                              MON_PREC_CATA,     
                              MON_TOTA_CATA,     
                              MON_OPOR_AHOR,     
                              MON_TOTA_FACT,     
                              VAL_OBSE,          
                              VAL_PUNT,          
                              IND_FUER_CAJA,    
                              USU_CREA,          
                              FEC_CREA,                  
                              IND_ACTI          
                            ) VALUES 
                            (
                              psCodigoTransaccional,     
                              r_consolidado(i).cod_clie,     
                              psCodigoPaquete,
                              lsOidCabecera,     
                              IMP_PRPD_SEQ.NEXTVAL,    
                              NULL,          
                              'S',          
                              NULL,          
                              NULL,          
                              NULL,          
                              'SUB TOTAL:',          
                              l_subtotalSolicitado,     
                              l_subtotalAtendido,     
                              NULL,     
                              NULL,     
                              NULL,
                              l_subtotalCatalogo,     
                              NULL,     
                              l_subtotalDescuentos,     
                              l_subtotalPrecioCatalogo,     
                              l_subtotalPrecioCatalogoTotal,     
                              l_oportunidadAhorro, 
                              l_subtotalFacturado,     
                              NULL,          
                              NULL,          
                              NULL,    
                              psCodigoUsuario,          
                              sysdate,                  
                              1);
                            \**\
                        
                        
                        if k=0 then
                           l_oportunidadCatalogo:=l_subtotaloportunidadAhorro;
                        elsif k=1 then
                           l_oportunidadRevista:=l_subtotaloportunidadAhorro;
                        end if;
                    END IF;
                    END LOOP;

                        EXIT WHEN c_detalle%NOTFOUND;
                END LOOP;
                    CLOSE c_detalle;

                
                
                -- Totales

                -- Al descuento le agregamos el redondeo
                if lv_redondeoDesc='S' then
                   l_totalDescuentos := l_totalDescuentos - r_consolidado(i).val_impo_redo_loca;
                end if;


                l_totalFacturado := l_totalCatalogo - l_totalDescuentos;
                \*
                l_textoActual := '<txt/><txt><t/><u>Total:</u><tr/>';
                l_textoActual := l_textoActual || l_totalSolicitado;
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || l_totalAtendido;
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/><tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalDescuentos, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogo, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalPrecioCatalogoTotal, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalOportunidadAhorro, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || trim(to_char(l_totalFacturado, l_formatoNumerico));
                l_textoActual := l_textoActual || '<tr/>';
                l_textoActual := l_textoActual || '</txt>';
                --DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

                -- Fin Detalle
                l_textoActual := '</detalle>';


                -- Inicio Pie
                l_textoActual := l_textoActual || '<pie>';*\
                
                \*INSERTAMOS LOS TOTALES*\
                INSERT INTO IMP_PRINT_PEDID_DETAL
                            (
                              PRSP_COD_PROC,     
                              PRSP_COD_CLIE,     
                              PRSP_COD_PAQU,
                              OID_PEDI_RESU,     
                              OID_PEDI_DETAL,    
                              NUM_ORDE,          
                              TIP_FILA,          
                              DES_FILA,          
                              COD_CUV,          
                              COD_SAP,          
                              NOM_PROD,          
                              VAL_UNID_SOLI,     
                              VAL_UNID_ATEN,     
                              VAL_UNID_FALT,     
                              MON_PREC_UNIT,     
                              MON_PREC_UNIT_SIVA,
                              MON_TOTA_ATEN,     
                              MON_PORC_DCTO,     
                              MON_TOTA_DCTO,     
                              MON_PREC_CATA,     
                              MON_TOTA_CATA,     
                              MON_OPOR_AHOR,     
                              MON_TOTA_FACT,     
                              VAL_OBSE,          
                              VAL_PUNT,          
                              IND_FUER_CAJA,    
                              USU_CREA,          
                              FEC_CREA,                  
                              IND_ACTI          
                            ) VALUES 
                            (
                              psCodigoTransaccional,     
                              r_consolidado(i).cod_clie,     
                              psCodigoPaquete,
                              lsOidCabecera,     
                              IMP_PRPD_SEQ.NEXTVAL,    
                              NULL,          
                              'S',          
                              NULL,          
                              NULL,          
                              NULL,          
                              'TOTAL:',          
                              l_totalSolicitado,     
                              l_totalAtendido,     
                              NULL,     
                              NULL,     
                              NULL,
                              l_totalCatalogo,     
                              NULL,     
                              l_totalDescuentos,     
                              l_totalPrecioCatalogo,     
                              l_totalPrecioCatalogoTotal,     
                              l_totalOportunidadAhorro, 
                              l_totalFacturado,     
                              NULL,          
                              NULL,          
                              NULL,    
                              psCodigoUsuario,          
                              sysdate,                  
                              1);
                \**\

               BEGIN

                SELECT to_char(cc.FEC_INIC,'dd/mm/yyyy')
                INTO l_fechaVencimiento
                FROM cra_crono cc, CRA_PERIO CP, seg_perio_corpo spc, CRA_ACTIV act
                WHERE cc.PERD_OID_PERI = cp.oid_peri
                  AND cp.peri_oid_peri = spc.oid_peri
                  AND spc.cod_peri = l_codigoPeriodoSiguiente
                  AND cc.ZZON_OID_ZONA = (select oid_zona from zon_zona where cod_zona=r_consolidado(i).cod_zona)
                  AND cc.CACT_OID_ACTI = act.OID_ACTI
                  AND act.COD_ACTI = 'CV';

               EXCEPTION
                WHEN OTHERS THEN
                 l_fechaVencimiento:=to_char(sysdate,'dd/mm/yyyy');
               END;

               -- Funcionalidad Flexipago
               IF lv_reemplazoOCS='S' THEN
                l_interesFlexipago := NVL(CCC_PKG_GENER.CCC_FN_OBTIE_INTER_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0);
                l_saldoFlexAnterior := ROUND(NVL(CCC_PKG_GENER.CCC_FN_OBTIE_MONTO_FLEXI_CAMPA(r_consolidado(i).oid_clie,p_codigoPeriodo),0),2);
               ELSE
                l_interesFlexipago :=0 ;
                l_saldoFlexAnterior := 0;
               END IF;

                -- Calculamos la percepcion
                l_percepcion := 0;
                IF l_indicadorPercepcion = 'S' THEN
                    -- No tomamos en cuenta el flete para el calculo de la percepcion
                    l_percepcion := round((l_totalCatalogo - l_totalDescuentos+nvl(r_consolidado(i).gastos,0)) * l_tasaImpuestoPercepcion / 100, 2);
                END IF;

                l_totalFactura := l_totalCatalogo - l_totalDescuentos + r_consolidado(i).val_impo_flet_tota_loca +  l_interesFlexipago + l_percepcion;

                -- Obtenemos los Pagos Posteriores
                SELECT NVL(SUM(imp_pend),0)
                INTO l_totalPagoPosterior
                FROM ccc_movim_cuent_corri mcc
                WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                  AND mcc.imp_pend > 0
                  AND mcc.perd_oid_peri > l_oidPeriodo
                  AND mcc.soca_oid_soli_cabe =r_consolidado(i).OID_SOLI_CABE ;


                select count(1) into l_cantidadOC from ped_solic_cabec
                where clie_oid_clie=r_consolidado(i).oid_clie
                and perd_oid_peri=l_oidPeriodo
                and ind_oc=1
                and ind_ts_no_conso=1
                and fec_fact is not null
                and tspa_oid_tipo_soli_pais in
                (
                select oid_tipo_soli_pais from ped_tipo_solic_pais x, ped_tipo_solic y
                where x.tsol_oid_tipo_soli=y.oid_tipo_soli
                and y.ind_soli_nega=0 and y.ind_cons=0
                )
                ;



                -- Obtenemos el Cargos por Familia Segura
                IF l_indicadorCargoFamSegura='S' and l_cantidadOC<2 THEN

                 SELECT NVL(SUM(mcc.imp_movi),0)
                 INTO l_cargoFamSegura
                 FROM
                  ccc_movim_cuent_corri mcc,
                  ccc_proce cp,
                  ccc_subpr su
                 WHERE mcc.clie_oid_clie = r_consolidado(i).oid_clie
                   AND mcc.perd_oid_peri = l_oidPeriodo
                   AND mcc.subp_oid_subp_crea = su.Oid_Subp
                   AND su.ccpr_Oid_Proc = cp.oid_proc
                   AND cp.cod_proc = 'CCC007'
                   AND su.cod_subp = 7;
                else
                    l_cargoFamSegura:=0;

                END IF;



                \********************************************************************
                Total Factura - Pagos Posteriores + Cargo Familia Segura
                + Saldo Anterior + Cuota Flexipago = Total Monto a Pagar
                **********************************************************************\
                l_totalAPagar := CCC_PKG_GENER.CCC_FN_OBTIE_SALDO_CAMPA_ANTER(r_consolidado(i).oid_clie,l_codigoPeriodoSiguiente);

                IF lv_indiejec='S' then
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura + nvl(r_consolidado(i).gastos,0) + + nvl(r_consolidado(i).gastos2,0);
                END IF;

                IF lv_indiejec2 is not null then
                 -- Gastos Administrativos
                 --l_saldoAnterior:=l_saldoAnterior-nvl(r_consolidado(i).gastos,0);
                 l_totalFactura:=l_totalFactura + nvl(r_consolidado(i).val_impo_impu_tota_loca,0);
                END IF;

                begin

                SELECT c.camp_ulti_pedi
                into lscodperigastos
                FROM ccc_detal_consu_gasto_admin c, ped_solic_cabec a
                WHERE c.soca_oid_soli_cabe_deud = a.oid_soli_cabe
                and a.soca_oid_soli_cabe=r_consolidado(i).oid_soli_cabe;

                exception when others then
                          NULL;
                end;


                \********************************************************************
                Saldo Anterior = Total Monto a Pagar - Total Factura + Pagos Posteriores - Cargo Familia Segura - Cuota Flexipago
                **********************************************************************\
                l_saldoAnterior := l_totalAPagar  + l_totalPagoPosterior - l_totalFactura  - l_cargoFamSegura - l_saldoFlexAnterior;

                
                if ln_desc_flete='S' then
                   
                   l_totalFactura:=l_totalFactura-nvl(r_consolidado(i).val_impo_desc_flet,0);
                   
                end if;
                
                -- En Peru el pie es diferente al resto de paises por las percepciones
                IF (l_indicadorPercepcion = 'S') THEN

                    -- Total Catalogo
                    --l_textoActual := l_textoActual || '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    lsTotalCatalogo:= l_totalCatalogo;
                    -- Total Descuentos (Incluimos el redondeo)
                    --l_textoActual := l_textoActual || '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    lsTotalDescuentos:= l_totalDescuentos;
                    -- Total Facturado
                    --l_textoActual := l_textoActual || '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    lsTotalFacturado:=l_totalCatalogo - l_totalDescuentos;
                    -- Flete
                    --l_textoActual := l_textoActual || '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca-r_consolidado(i).val_reca_flet_loca, l_formatoNumerico)) || '</linea4>';
                    lsTotalFlete :=r_consolidado(i).val_impo_flet_tota_loca-r_consolidado(i).val_reca_flet_loca;
                    -- Percepciones
                    --l_textoActual := l_textoActual || '<linea5>' || trim(to_char(l_percepcion, l_formatoNumerico)) || '</linea5>';
                    lsTotalPercepciones:= l_percepcion;
                    -- Total Factura
                    --l_textoActual := l_textoActual || '<linea6>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea6>';
                    lsTotalFactura:=l_totalFactura;
                    -- Pagos Posteriores
                    --l_textoActual := l_textoActual || '<linea7>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea7>';
                    lsPagosPosteriores:=l_totalPagoPosterior;
                    -- Abono Atencion de Servicios
                    --l_textoActual := l_textoActual || '<linea8>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea8>';
                    lsAbonoAtencionServicios:=l_cargoFamSegura;
                    -- Saldo anterior
                    --l_textoActual := l_textoActual || '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    lsSaldoAnterior:=l_saldoAnterior;
                    -- Importe Total
                    --l_textoActual := l_textoActual || '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    lsImporteActual:=l_totalAPagar;
                    -- Oportunidad Catalogo
                    --l_textoActual := l_textoActual || '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    lsOportunidadCatalogo:=l_oportunidadCatalogo;
                    -- Oportunidad Revista
                    --l_textoActual := l_textoActual || '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    lsOportunidadRevista:=l_oportunidadRevista;
                    -- Oportunidad Total
                    --l_textoActual := l_textoActual || '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    lsOportunidadTotal:=l_oportunidadCatalogo+l_oportunidadRevista;
                    -- Mensaje
                    --l_textoActual := l_textoActual || '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    lsMensaje:=l_mensajeOportunidadAhorro;
                    -- Fecha Vencimiento
                    --l_textoActual := l_textoActual || '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    lsFechaVencimiento:=l_fechaVencimiento;

                      -- Gastos Administrativos
                      --l_textoActual := l_textoActual || '<linea16>' || trim(to_char(nvl(r_consolidado(i).gastos,0), l_formatoNumerico)) || '</linea16>';
                      lsGastosAdministrativos:=nvl(r_consolidado(i).gastos,0);

                      -- Saldo Flexipago
                      --l_textoActual := l_textoActual || '<linea17>' || trim(to_char(l_interesFlexipago, l_formatoNumerico)) || '</linea17>';
                      lsSaldoFlexipago:=l_interesFlexipago;
                      -- Cuota Flexipago
                      --l_textoActual := l_textoActual || '<linea18>' || trim(to_char(l_saldoFlexAnterior, l_formatoNumerico)) || '</linea18>';
                      lsCuotaFlexipago:=l_saldoFlexAnterior;

                    IF lsactividadparametro is not null THEN
                        -- Recargo Flete
                        --l_textoActual := l_textoActual || '<linea19>' || trim(to_char(nvl(r_consolidado(i).val_reca_flet_loca,0), l_formatoNumerico)) || '</linea19>';
                        lsRecargoFlete:=nvl(r_consolidado(i).val_reca_flet_loca,0);
                    END IF;


                      -- Descuento Cabecera
                      --l_textoActual := l_textoActual || '<linea20>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0), l_formatoNumerico)) || '</linea20>';
                      lsDescuentoCabecera:=nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0);
                      
                      -- Campa?a de Gasto Administrativo
                      --l_textoActual := l_textoActual || '<linea21>' || lscodperigastos || '</linea21>';
                      lsCampanaGastosAdministrativos:= lscodperigastos;

                    -- Descuento Cabecera2
                    --l_textoActual := l_textoActual || '<linea22>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0), l_formatoNumerico)) || '</linea22>';
                    lsDescuentoCabecera2:=nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0);

                    -- Reclamos Pendientes
                    --l_textoActual := l_textoActual || '<linea23>' || trim(to_char(nvl(r_consolidado(i).val_recl_pend,0), l_formatoNumerico)) || '</linea23>';
                    lsReclamosPendientes :=nvl(r_consolidado(i).val_recl_pend,0);
                    
                    
                    \*ACTUALIZAMOS LA CABECERA*\
                    UPDATE IMP_PRINT_PEDID_RESUM
                    SET 
                      VAL_MONT_PAGO = lsTotalCatalogo,
                      VAL_TABU_01 = 0,
                      VAL_TABU_02 = 1,
                      VAL_TABU_03 = 0,
                      VAL_TABU_04 = 1,
                      VAL_TABU_05 = 1,
                      VAL_TABU_06 = 0,
                      VAL_TABU_07 = 1,
                      VAL_TABU_08 = 1,
                      VAL_TABU_09 = 1,
                      VAL_TABU_10 = 0,
                      VAL_DESC_01 = 'TOTAL CATALOGO',
                      VAL_DESC_02 ='(-) Mis Descuentos',
                      VAL_DESC_03 = 'TOTAL CON DESCUENTO',
                      VAL_DESC_04 = '(+) Gastos de Transporte',
                      VAL_DESC_05 = '(+) Percepcin',
                      VAL_DESC_06 = 'TOTAL FACTURA',
                      VAL_DESC_07 = '(-) Pagos Posteriores',
                      VAL_DESC_08 = '(+) Recaudo Seguro Familia Protegida',
                      VAL_DESC_09 = '(+) Saldo Campaa Anterior',
                      VAL_DESC_10 = 'TOTAL MONTO A PAGAR',
                      VAL_MONT_01 = lsTotalCatalogo,
                      VAL_MONT_02 = lsTotalDescuentos,
                      VAL_MONT_03 = lsTotalFacturado,
                      VAL_MONT_04 = lsTotalFlete,
                      VAL_MONT_05 = lsTotalPercepciones,
                      VAL_MONT_06 = lsTotalFactura,
                      VAL_MONT_07 = lsPagosPosteriores,
                      VAL_MONT_08 = lsAbonoAtencionServicios,
                      VAL_MONT_09 = lsSaldoAnterior,
                      VAL_MONT_10 = lsImporteActual,
                      VAL_DESC_01A = 'Por tus compras de productos de catlogo',
                      VAL_DESC_02A = 'Por tus compras de productos de revista',
                      VAL_DESC_03A = 'Total Oportunidad de Ahorro*',
                      VAL_DESC_04A = lsMensaje,
                      VAL_DESC_05A = lsFechaVencimiento,      
                      VAL_MONT_01A = lsOportunidadCatalogo,
                      VAL_MONT_02A = lsOportunidadRevista,
                      VAL_MONT_03A = lsOportunidadTotal
                  WHERE 
                      PRSP_COD_PROC = psCodigoTransaccional
                      AND PRSP_COD_CLIE = r_consolidado(i).cod_clie
                      AND PRSP_COD_PAQU = psCodigoPaquete
                      AND OID_PEDI_RESU = lsOidCabecera;

                ELSE

                    -- Total Catalogo
                    --l_textoActual := l_textoActual || '<linea1>' || trim(to_char(l_totalCatalogo, l_formatoNumerico)) || '</linea1>';
                    lsTotalCatalogo:= l_totalCatalogo;
                    -- Total Descuentos (Incluimos el redondeo)
                    --l_textoActual := l_textoActual || '<linea2>' || trim(to_char(l_totalDescuentos, l_formatoNumerico)) || '</linea2>';
                    lsTotalDescuentos:= l_totalDescuentos;
                    -- Total Facturado
                    --l_textoActual := l_textoActual || '<linea3>' || trim(to_char(l_totalCatalogo - l_totalDescuentos, l_formatoNumerico)) || '</linea3>';
                    lsTotalFacturado:= l_totalCatalogo - l_totalDescuentos;
                    -- Flete
                    --l_textoActual := l_textoActual || '<linea4>' || trim(to_char(r_consolidado(i).val_impo_flet_tota_loca, l_formatoNumerico)) || '</linea4>';
                    lsTotalFlete := r_consolidado(i).val_impo_flet_tota_loca;
                    -- Total Factura
                    --l_textoActual := l_textoActual || '<linea5>' || trim(to_char(l_totalFactura, l_formatoNumerico)) || '</linea5>';
                    lsTotalFactura:= l_totalFactura;
                    -- Pagos Posteriores
                    --l_textoActual := l_textoActual || '<linea6>' || trim(to_char(l_totalPagoPosterior, l_formatoNumerico)) || '</linea6>';
                    lsPagosPosteriores:= l_totalPagoPosterior;
                    -- Abono Atencion de Servicios (No se visualiza)
                    --l_textoActual := l_textoActual || '<linea7>' || trim(to_char(l_cargoFamSegura, l_formatoNumerico)) || '</linea7>';
                    lsAbonoAtencionServicios:=l_cargoFamSegura;
                    -- Impuesto de productos gratis (Solo se visualiza en algunos paises)
                    --l_textoActual := l_textoActual || '<linea8>' || trim(to_char(l_totalImpuestosGratis, l_formatoNumerico)) || '</linea8>';
                    lsTotalImpuestosGratis:=l_totalImpuestosGratis;
                    -- Saldo anterior
                    --l_textoActual := l_textoActual || '<linea9>' || trim(to_char(l_saldoAnterior, l_formatoNumerico)) || '</linea9>';
                    lsSaldoAnterior:=l_saldoAnterior;
                    -- Importe Total
                    --l_textoActual := l_textoActual || '<linea10>' || trim(to_char(l_totalAPagar, l_formatoNumerico)) || '</linea10>';
                    lsImporteActual:=l_totalAPagar;
                    -- Oportunidad Catalogo
                    --l_textoActual := l_textoActual || '<linea11>' || trim(to_char(l_oportunidadCatalogo, l_formatoNumerico)) || '</linea11>';
                    lsOportunidadCatalogo:=l_oportunidadCatalogo;
                    -- Oportunidad Revista
                    --l_textoActual := l_textoActual || '<linea12>' || trim(to_char(l_oportunidadRevista, l_formatoNumerico)) || '</linea12>';
                    lsOportunidadRevista:=l_oportunidadRevista;
                    -- Oportunidad Total
                    --l_textoActual := l_textoActual || '<linea13>' || trim(to_char(l_oportunidadCatalogo+l_oportunidadRevista, l_formatoNumerico)) || '</linea13>';
                    lsOportunidadTotal:=l_oportunidadCatalogo+l_oportunidadRevista;
                    -- Mensaje
                    --l_textoActual := l_textoActual || '<linea14>' || trim(l_mensajeOportunidadAhorro) || '</linea14>';
                    lsMensaje:=l_mensajeOportunidadAhorro;
                    -- Fecha Vencimiento
                    --l_textoActual := l_textoActual || '<linea15>' || trim(l_fechaVencimiento) || '</linea15>';
                    lsFechaVencimiento:=l_fechaVencimiento;
                    -- Impuesto
                    --l_textoActual := l_textoActual || '<linea16>' || trim(to_char(nvl(r_consolidado(i).val_impo_impu_tota_loca,0), l_formatoNumerico)) || '</linea16>';
                    lsImpuesto:= nvl(r_consolidado(i).val_impo_impu_tota_loca,0);
                    -- subtotal con flete
                    --l_textoActual := l_textoActual || '<linea17>' || trim(to_char(l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0), l_formatoNumerico)) || '</linea17>';
                    lsSubTotalFlete:=l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0);
                    -- subtotal con flete e impuesto
                    --l_textoActual := l_textoActual || '<linea18>' || trim(to_char(l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0)+nvl(r_consolidado(i).val_impo_impu_tota_loca,0), l_formatoNumerico)) || '</linea18>';
                    lsSubTotalFleteImpuesto:=l_totalCatalogo+nvl(r_consolidado(i).val_impo_flet_tota_loca,0)+nvl(r_consolidado(i).val_impo_impu_tota_loca,0);
                    -- descuento flete
                    --l_textoActual := l_textoActual || '<linea19>' || trim(to_char(r_consolidado(i).val_impo_desc_flet, l_formatoNumerico)) || '</linea19>';
                    lsDescuentoFlete:=r_consolidado(i).val_impo_desc_flet;

                    -- Descuento Cabecera
                    --l_textoActual := l_textoActual || '<linea20>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0), l_formatoNumerico)) || '</linea20>';
                    lsDescuentoCabecera:=nvl(r_consolidado(i).val_impo_desc_3_tota_loca,0);
                      -- Gastos Administrativos
                      --l_textoActual := l_textoActual || '<linea21>' || trim(to_char(nvl(r_consolidado(i).gastos,0)+nvl(r_consolidado(i).gastos2,0), l_formatoNumerico)) || '</linea21>';
                      lsGastosAdministrativos:=nvl(r_consolidado(i).gastos,0)+nvl(r_consolidado(i).gastos2,0);
                    -- Descuento Cabecera2
                    --l_textoActual := l_textoActual || '<linea22>' || trim(to_char(nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0), l_formatoNumerico)) || '</linea22>';
                    lsDescuentoCabecera2:=nvl(r_consolidado(i).val_impo_desc_4_tota_loca,0);
                    -- Reclamos Pendientes
                    --l_textoActual := l_textoActual || '<linea23>' || trim(to_char(nvl(r_consolidado(i).val_recl_pend,0), l_formatoNumerico)) || '</linea23>';
                    lsReclamosPendientes :=nvl(r_consolidado(i).val_recl_pend,0);

                    \*ACTUALIZAMOS LA CABECERA*\
                    UPDATE IMP_PRINT_PEDID_RESUM
                    SET 
                      VAL_MONT_PAGO = lsTotalCatalogo,
                      VAL_TABU_01 = 0,
                      VAL_TABU_02 = 1,
                      VAL_TABU_03 = 0,
                      VAL_TABU_04 = 1,
                      VAL_TABU_05 = 0,
                      VAL_TABU_06 = null,
                      VAL_TABU_07 = null,
                      VAL_TABU_08 = 1,
                      VAL_TABU_09 = null,
                      VAL_TABU_10 = 0,
                      VAL_DESC_01 = 'TOTAL CATALOGO',
                      VAL_DESC_02 ='(-) Mis Descuentos',
                      VAL_DESC_03 = 'TOTAL CON DESCUENTO',
                      VAL_DESC_04 = '(+) Gastos de Transporte',
                      VAL_DESC_05 = 'TOTAL FACTURA',
                      VAL_DESC_06 = null,
                      VAL_DESC_07 = null,
                      VAL_DESC_08 = '(+) Saldo Campaa Anterior',
                      VAL_DESC_09 = null,
                      VAL_DESC_10 = 'TOTAL MONTO A PAGAR',
                      VAL_MONT_01 = lsTotalCatalogo,
                      VAL_MONT_02 = lsTotalDescuentos,
                      VAL_MONT_03 = lsTotalFacturado,
                      VAL_MONT_04 = lsTotalFlete,
                      VAL_MONT_05 = lsTotalFactura,
                      VAL_MONT_06 = null,
                      VAL_MONT_07 = null,
                      VAL_MONT_08 = lsSaldoAnterior,
                      VAL_MONT_09 = null,
                      VAL_MONT_10 = lsImporteActual,
                      VAL_DESC_01A = 'Por tus compras de productos de catlogo',
                      VAL_DESC_02A = 'Por tus compras de productos de revista',
                      VAL_DESC_03A = 'Total Oportunidad de Ahorro*',
                      VAL_DESC_04A = lsMensaje,
                      VAL_DESC_05A = lsFechaVencimiento,      
                      VAL_MONT_01A = lsOportunidadCatalogo,
                      VAL_MONT_02A = lsOportunidadRevista,
                      VAL_MONT_03A = lsOportunidadTotal
                  WHERE 
                      PRSP_COD_PROC = psCodigoTransaccional
                      AND PRSP_COD_CLIE = r_consolidado(i).cod_clie
                      AND PRSP_COD_PAQU = psCodigoPaquete
                      AND OID_PEDI_RESU = lsOidCabecera;

                END IF;


                --l_correlativo := l_correlativo + 1;

                update ped_solic_cabec xx set xx.val_gana_tota_loca=l_oportunidadCatalogo+l_oportunidadRevista
                where oid_soli_cabe=r_consolidado(i).oid_soli_cabe;

            END LOOP;

        END IF;

        EXIT WHEN c_consolidados%NOTFOUND;
    END LOOP;
    -- Cerramos el cursor
    CLOSE c_consolidados;
END;
*/
/***************************************************************************
Descripcion       : Procedimiemto de Programa Punto
                    para su insercion en la tabla detalle: IMP_PAQUE_DOCUM_PROGR_PUNTO
                    
Parametros        : Codigo de pais, Codigo de periodo
Fecha Creacion    : 12/01/2016
Autor             : Segundo Leiva Carvallo
***************************************************************************/

PROCEDURE IMP_PR_PROCE_PROGR_PUNTO(psCodPais VARCHAR2,
  psCodigoPeriodo IN VARCHAR2) IS

ln_oidPeriodo seg_perio_corpo.cod_peri%TYPE;
l_campanaAnterior VARCHAR2(6);

CURSOR c_bloqueprincipal IS
SELECT DISTINCT clie_oid_clie
        FROM msg_tmp_pedid_clien
        WHERE cod_tipo_soli = 'SOC';

TYPE bloqueprincipalrecord IS RECORD (
    clieOidClie    msg_tmp_pedid_clien.clie_oid_clie%TYPE
);

TYPE bloqueprincipaltype IS TABLE OF bloqueprincipalrecord;
r_bloqueprincipal    bloqueprincipaltype;

CURSOR c_bloque1(oid_psCodigoPeriodo NUMBER, oidCliente NUMBER) IS
SELECT detalle.clie_oid_clie,  -- Oid de consultora
                    mc.cod_clie codigoCliente,  -- Cdigo de consultora
                    SUM(Ptos_acum_cante) ptosAcumCamAnte, --- Puntaje total acumulado a CX -1
                    SUM(Ptos_canjes_cmp) ptosCanjesCmp,  -- Puntos canjeados CX
                    SUM(Ptos_cdr_cmp) ptosCDRCmp,           -- Devoluciones CX-1
                    SUM(Ptos_vencidos) ptosVencidos,           -- Puntos Vencidos CX-1
                    SUM(Ptos_pedcon_cmp)  ptosPedCon,      -- Puntos de Constancia
                    SUM(Ptos_recom_cmp) ptosRecomCmp,   -- Puntos de Recomendacin
                    SUM(Ptos_promo_cmp) ptosPromoCmp,   -- Puntos de Apoyo a Productos
                    SUM(Ptos_nueva) ptosNuevas,                 -- Puntos de Constancia de Nuevas
                    SUM(Ptos_ventas_cmp) ptosVentasCmp,  -- Puntos por Ventas
                    SUM(Ptos_retail_cmp) ptosRetailCmp,      -- Puntos Belcenter      (Linea adicional)
                    SUM(Ptos_Cmp) ptosCmp,                       -- Puntaje total CX
                    SUM(Ptos_Total) ptosTotal                      -- Puntaje total acumulado a CX
               FROM (SELECT cc.clie_oid_clie,
                            cc.copa_oid_para_gral,
                            (CASE WHEN  (cc.perd_oid_peri < oid_psCodigoPeriodo AND upper(des_moti)  NOT LIKE '%VENCIMIENTO%')
                                                        THEN num_punt ELSE 0 END) Ptos_acum_cante,
                            (CASE WHEN (upper(des_moti)  LIKE 'PREMIA%' ) AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_canjes_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE '%ANUL%'  OR upper(des_moti)  LIKE '%DEVOL%'
                                                        OR upper(des_moti)  LIKE '%SIN PEDIDO%'   )
                                                        AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_cdr_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE '%VENCIMIENTO%' ) AND cc.perd_oid_peri < oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_vencidos,                                                       
                            (CASE WHEN (upper(des_moti)  LIKE '%PEDIDOS CONSECUTIVOS' ) AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_pedcon_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE 'RECOMENDACIONES%' ) AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_recom_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE 'LANZAMIENTO%' ) AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_promo_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE '%NUEVAS%' ) THEN num_punt ELSE 0 END)  Ptos_nueva,  -- Puntaje Constancia Nuevas
                            (CASE WHEN (upper(des_moti) = 'VENTA' or  des_moti IS NULL or upper(des_moti)  LIKE '%VENCIMIENTO%') AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_ventas_cmp,
                            (CASE WHEN (upper(des_moti)  LIKE '%RETAIL%' ) AND cc.perd_oid_peri >= oid_psCodigoPeriodo
                                                        THEN num_punt ELSE 0 END)  Ptos_retail_cmp,
                            (CASE WHEN  cc.perd_oid_peri >= oid_psCodigoPeriodo THEN num_punt ELSE 0 END) Ptos_cmp,
                            num_punt Ptos_Total
                            FROM inc_cuent_corri_punto cc, inc_concu_param_gener concu
                      WHERE cc.clie_oid_clie NOT IN (
                                             SELECT inc_desca.clie_oid_clie
                                                       FROM inc_desca
                                                     WHERE inc_desca.copa_oid_para_gral = cc.copa_oid_para_gral)
                        AND cc.clie_oid_clie IN (SELECT distinct clie_oid_clie
                                                  FROM msg_tmp_pedid_clien
                                                  WHERE cod_tipo_soli = 'SOC')
                            AND cc.copa_oid_para_gral = concu.oid_para_gral
                            AND concu.ind_acti=1
                            AND NVL(concu.ind_comu,1) = 1
                            AND concu.ind_prog_punt = 1) detalle,
                    inc_concu_param_gener cpg,
                    inc_param_gener_premi gen,
                    inc_concu_param_consu cons,
                    mae_clien mc
              WHERE cpg.oid_para_gral = detalle.copa_oid_para_gral
                AND cons.copa_oid_para_gral = cpg.oid_para_gral
                AND gen.copa_oid_para_gral = cpg.oid_para_gral
                AND detalle.clie_oid_clie = mc.oid_clie
                AND cpg.ind_acti = 1
                AND NVL(cpg.ind_comu,1) = 1
                AND cpg.ind_prog_punt = 1
                AND detalle.clie_oid_clie = oidCliente
              GROUP BY detalle.clie_oid_clie,
                    mc.cod_clie
             HAVING (SUM(Ptos_Total) > 0 or SUM(Ptos_canjes_cmp)>0);

TYPE bloque1record IS RECORD (
    clieOidClie   inc_cuent_corri_punto.clie_oid_clie%TYPE,
    codigoCliente mae_clien.cod_clie%TYPE,
    ptosAcumCamAnte inc_cuent_corri_punto.num_punt%TYPE,
    ptosCanjesCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosCDRCmp inc_cuent_corri_punto.num_punt%TYPE, 
    ptosVencidos inc_cuent_corri_punto.num_punt%TYPE,                           
    ptosPedCon inc_cuent_corri_punto.num_punt%TYPE,
    ptosRecomCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosPromoCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosNuevas inc_cuent_corri_punto.num_punt%TYPE,
    ptosVentasCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosRetailCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosCmp inc_cuent_corri_punto.num_punt%TYPE,
    ptosTotal inc_cuent_corri_punto.num_punt%TYPE
);

TYPE bloque1type IS TABLE OF bloque1record;
r_bloque1    bloque1type;

CURSOR c_bloque2(psCodigoPeriodo VARCHAR2, oidCliente NUMBER) IS
with base as
(select
sc.clie_oid_clie,
des.val_I18n descrip,  nvl(sp.num_unid_aten,0)+decode(bf.fec_solu, null,0,nvl(bf.num_unid_falt,0)) atendido
,case when bf.fec_solu is null then bf.num_unid_falt else 0 end faltante,
decode(a.num_cant_fija_punt, null, a.num_cant_inic_punt, a.num_cant_fija_punt) puntos
from ped_solic_cabec sc, ped_solic_posic sp, inc_bolsa_falta bf, gen_I18n_sicc_pais des,mae_produ, mae_clien,
    inc_concu_param_gener inc, ped_tipo_solic ts, v_gen_i18n_sicc i, ped_tipo_solic_pais tsp, cra_perio cra,
    seg_perio_corpo seg,
    inc_param_nivel_premi a,
    inc_lote_premi_artic b,
    inc_premi_artic c,
    inc_param_gener_premi d
where 1=1
and sc.oid_soli_cabe = sp.soca_oid_soli_cabe
and sp.oid_soli_posi = bf.sopo_oid_soli_posi(+)
and des.val_oid=sp.prod_oid_prod
and des.attr_enti = 'MAE_PRODU'
and sp.prod_oid_prod = mae_produ.oid_prod
and sc.clie_oid_clie = oid_clie
and sc.copa_oid_para_gene = inc.oid_para_gral
and espo_oid_esta_posi <>2
and cra.peri_oid_peri=seg.oid_peri
and sc.perd_oid_peri=cra.oid_peri
and seg.cod_peri= psCodigoPeriodo
and i.idio_oid_idio = 1
and i.attr_enti ='PED_TIPO_SOLIC'
and i.val_oid = ts.oid_tipo_soli
and sc.tspa_oid_tipo_soli_pais = tsp.oid_tipo_soli_pais
and tsp.tsol_oid_tipo_soli = ts.oid_tipo_soli
and cod_tipo_soli='SIN'
and sc.num_prem = b.num_prem(+)
and b.prar_oid_prem_arti = c.oid_prem_arti(+)
and c.panp_oid_para_nive_prem = a.oid_para_nive_prem(+)
and a.pagp_oid_para_gene_prem = d.oid_para_gene_prem
and d.copa_oid_para_gral=sc.copa_oid_para_gene
and inc.ind_acti = 1
and nvl(inc.ind_comu,1) = 1
and inc.ind_prog_punt = 1
and sc.clie_oid_clie in (select distinct clie_oid_clie
                                 from msg_tmp_pedid_clien
                                 where cod_tipo_soli = 'SOC')
)
select clie_oid_clie, descrip, status, sum(cantidad) cantidad, puntos puntos from
(
select clie_oid_clie, descrip, 'ATENDIDO' status, atendido cantidad, puntos puntos
from base where atendido>0
and clie_oid_clie = oidCliente
union all
select clie_oid_clie, descrip, 'FALTANTE' status, faltante cantidad, puntos puntos
from base where faltante>0
and clie_oid_clie = oidCliente
)
group by clie_oid_clie, descrip, status, puntos;


TYPE bloque2record IS RECORD (
    clieOidClie    inc_cuent_corri_punto.clie_oid_clie%TYPE,
    valI18n       gen_I18n_sicc_pais.Val_I18n%TYPE,
    status   VARCHAR2(10),
    cantidad    inc_bolsa_falta.num_unid_falt%TYPE,
    puntos inc_param_nivel_premi.num_cant_fija_punt%TYPE
);

TYPE bloque2type IS TABLE OF bloque2record;
r_bloque2    bloque2type;


CURSOR c_bloque3(psCodPais VARCHAR2, oidCliente NUMBER) IS
select CLIE_OID_CLIE, 
gen_pkg_gener.gen_fn_perio_nsigu(psCodPais, VEN.COD_PERI, gen_pkg_gener.gen_fn_param_pais(psCodPais,'GEN','000')) CampaaVen,
        nvl(ven.abn_ptos,0)-nvl(ven.car_ptos,0) Puntos
from inc_tempo_vcmto_pntos ven, inc_concu_param_gener inc
where nvl(ven.abn_ptos,0)>nvl(ven.car_ptos,0)
and ven.clie_oid_clie IN (SELECT DISTINCT clie_oid_clie
                                         FROM msg_tmp_pedid_clien
                                          WHERE cod_tipo_soli = 'SOC')
and ven.copa_oid_para_gral=inc.oid_para_gral
and inc.ind_acti=1
and nvl(inc.ind_comu,1) = 1
and inc.ind_prog_punt = 1
and clie_oid_clie = oidCliente
order by clie_oid_clie, cod_peri;

TYPE bloque3record IS RECORD (
    clieOidClie    inc_tempo_vcmto_pntos.clie_oid_clie%TYPE,
    campanaVen     VARCHAR2(6),
    puntos    inc_tempo_vcmto_pntos.abn_ptos%TYPE
);

TYPE bloque3type IS TABLE OF bloque3record;
r_bloque3    bloque3type;


--Variables locales
l_textoActual VARCHAR2(100);
l_clob CLOB;
l_saldoresta NUMBER(12);
l_canttotal NUMBER(12);

BEGIN

 l_textoActual := '';   
 ln_oidPeriodo :=gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);
 l_campanaAnterior := gen_pkg_gener.gen_fn_perio_nsigu(psCodPais,psCodigoPeriodo,-1);

                
-- Abrimos el cursor bloqueprincipal
 OPEN c_bloqueprincipal;
    LOOP
        
        FETCH c_bloqueprincipal BULK COLLECT
        INTO r_bloqueprincipal LIMIT w_filas;

        IF  r_bloqueprincipal.COUNT > 0 THEN
            FOR i IN r_bloqueprincipal.FIRST..r_bloqueprincipal.LAST
            LOOP   
                
-- ###################################################################


INSERT INTO IMP_PAQUE_DOCUM_PROGR_PUNTO (
                COR_PRPU,
                COD_CLIE,
                XML_PRPU,
                VAL_NUME_SOLI
                )
                VALUES(
                IMP_CORR_PRPU_SEQ.NEXTVAL,
                gen_pkg_gener.gen_fn_devuelve_cod_clie(r_bloqueprincipal(i).clieOidClie),            
                empty_clob,
                NULL)
                RETURNING XML_PRPU INTO l_clob;
                
                --Inicio
                l_textoActual := '<prgpuntos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);     
                
-- Abrimos el cursor bloque1
 OPEN c_bloque1(ln_oidPeriodo, r_bloqueprincipal(i).clieOidClie);
    LOOP
        
        FETCH c_bloque1 BULK COLLECT
        INTO r_bloque1 LIMIT w_filas;

        IF  r_bloque1.COUNT > 0 THEN
            FOR i IN r_bloque1.FIRST..r_bloque1.LAST
            LOOP
               -- Inicio writeappend
               
               --Campana Actual
                l_textoActual := '<cmpActual>' || psCodigoPeriodo || '</cmpActual>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);     
                
                --Campana Anterior
                l_textoActual := '<cmpAnterior>' || l_campanaAnterior || '</cmpAnterior>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);           
                
                --tag abrir bloque1
                l_textoActual := '<detpuntos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);           
                
                --Puntaje total acumulado a CX -1
                l_textoActual := '<puntajetotalacumdato>' || r_bloque1(i).ptosAcumCamAnte || '</puntajetotalacumdato>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos canjeados CX
                l_textoActual := '<ptoscanjeadosdato>' || r_bloque1(i).ptosCanjesCmp || '</ptoscanjeadosdato>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Devoluciones CX-1
                l_textoActual := '<devolucionesdatoanterior>' || r_bloque1(i).ptosCDRCmp || '</devolucionesdatoanterior>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos Vencidos CX-1
                IF(r_bloque1(i).ptosVencidos IS NOT NULL AND r_bloque1(i).ptosVencidos<>0)THEN
                      l_textoActual := '<ptosvencidos>' || r_bloque1(i).ptosVencidos || '</ptosvencidos>';
                      DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                END IF;
                
                l_saldoresta := r_bloque1(i).ptosAcumCamAnte +  r_bloque1(i).ptosCanjesCmp +  r_bloque1(i).ptosCDRCmp + r_bloque1(i).ptosVencidos;        
                --Saldo despues de resta
                l_textoActual := '<saldodespuesderestas>' || l_saldoresta || '</saldodespuesderestas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos de Constancia
                l_textoActual := '<ptosPedCon>' || r_bloque1(i).ptosPedCon || '</ptosPedCon>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos de Recomendacin
                l_textoActual := '<ptosRecomCmp>' || r_bloque1(i).ptosRecomCmp || '</ptosRecomCmp>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos de Apoyo a Productos
                l_textoActual := '<ptosapoyoproductos>' || r_bloque1(i).ptosPromoCmp || '</ptosapoyoproductos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
               
                --Puntos de Constancia de Nuevas
                l_textoActual := '<ptosconstancianueva>' || r_bloque1(i).ptosNuevas || '</ptosconstancianueva>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos por Ventas
                l_textoActual := '<ptosporventas>' || r_bloque1(i).ptosVentasCmp || '</ptosporventas>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos Belcenter
                l_textoActual := '<puntosbelcenter>' || r_bloque1(i).ptosRetailCmp || '</puntosbelcenter>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntaje total CX
                l_textoActual := '<puntajetotalcmpactual>' || r_bloque1(i).ptosCmp || '</puntajetotalcmpactual>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntaje total acumulado a CX
                l_textoActual := '<puntajetotalacumcmpactual>' || r_bloque1(i).ptosTotal || '</puntajetotalacumcmpactual>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --tag cerrar bloque1
                l_textoActual := '</detpuntos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                
            END LOOP;

        END IF;
        EXIT WHEN c_bloque1%NOTFOUND;
    END LOOP;    
 -- Cerramos el cursor bloque1
 CLOSE c_bloque1;
    
   -- Abrimos el cursor bloque3
 OPEN c_bloque3(psCodPais, r_bloqueprincipal(i).clieOidClie);
    LOOP
        
        FETCH c_bloque3 BULK COLLECT
        INTO r_bloque3 LIMIT w_filas;

        IF  r_bloque3.COUNT > 0 THEN
          --tag abrir bloque 3
                l_textoActual := '<proximospuntosvencer>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
            FOR i IN r_bloque3.FIRST..r_bloque3.LAST
            LOOP
               -- Inicio writeappend                                          
                --Abre tag Registro
                l_textoActual := '<proxptovencregistro'|| i ||'>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Campana
                l_textoActual := '<proxptovenccampana>' || r_bloque3(i).campanaVen || '</proxptovenccampana>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Puntos
                l_textoActual := '<proxptovencpuntos>' || r_bloque3(i).puntos || '</proxptovencpuntos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Cierre tag Registro
                l_textoActual := '</proxptovencregistro'|| i ||'>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                     
            END LOOP;
                --tag cerrar bloque 3
                l_textoActual := '</proximospuntosvencer>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
        END IF;
        EXIT WHEN c_bloque3%NOTFOUND;
    END LOOP;    
    -- Cerramos el cursor bloque3
    CLOSE c_bloque3;
    
 -- Abrimos el cursor bloque2
 OPEN c_bloque2(psCodigoPeriodo, r_bloqueprincipal(i).clieOidClie);
    LOOP
        
        FETCH c_bloque2 BULK COLLECT
        INTO r_bloque2 LIMIT w_filas;

        IF  r_bloque2.COUNT > 0 THEN
          
          --tag abrir bloque 2
                l_textoActual := '<premioscanjeados>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
            FOR i IN r_bloque2.FIRST..r_bloque2.LAST
            LOOP
               -- Inicio writeappend
                              
                --Abre tag Registro
                l_textoActual := '<prmcanjproxptovencregistro'|| i ||'>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Descripcioon
                l_textoActual := '<prmcanjdescripcion>' || r_bloque2(i).valI18n || '</prmcanjdescripcion>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Status ATENDIDO o FALTANTE
                l_textoActual := '<prmcanjstatus>' || r_bloque2(i).status || '</prmcanjstatus>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Cantidad
                l_textoActual := '<prmcanjcant>' || r_bloque2(i).cantidad || '</prmcanjcant>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                                
                --Puntos
                l_textoActual := '<prmcanjpuntos>' || r_bloque2(i).puntos || '</prmcanjpuntos>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                l_canttotal := r_bloque2(i).cantidad *  r_bloque2(i).puntos;        
                --Total
                l_textoActual := '<prmcanjtotal>' || l_canttotal || '</prmcanjtotal>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                --Cierra tag Registro
                l_textoActual := '</prmcanjproxptovencregistro'|| i ||'>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
                
                
            END LOOP;
                --tag cerrar bloque 2
                l_textoActual := '</premioscanjeados>';
                DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);
        END IF;
        
        EXIT WHEN c_bloque2%NOTFOUND;
    END LOOP;    
    -- Cerramos el cursor bloque2
  CLOSE c_bloque2;
  
    --Fin
    l_textoActual := '</prgpuntos>';
    DBMS_LOB.writeappend(l_clob, LENGTH(l_textoActual), l_textoActual);

-- ###################################################################
           commit;
            END LOOP;

        END IF;
        EXIT WHEN c_bloqueprincipal%NOTFOUND;
    END LOOP;    
     -- Cerramos el cursor bloqueprincipal
 CLOSE c_bloqueprincipal;

END;

                        
END;
/

CREATE OR REPLACE PACKAGE "INT_PKG_DATAM" IS
/* Declaracion de variables */
ln_sqlcode   NUMBER(10);
ls_sqlerrm   VARCHAR2(1500);
W_FILAS      NUMBER:=5000;

TYPE tRegDatEstimado IS RECORD
(
  COD_PAIS      VARCHAR2(3),
  COD_PERI      VARCHAR2(6),
  COD_MARC      VARCHAR2(3),
  COD_CANA      VARCHAR2(3),
  COD_REGI      VARCHAR2(2),
  COD_ZONA      VARCHAR2(4),
  COD_SECCI     VARCHAR2(1),
  VAL_ESTI_VEND NUMBER(9),
  VAL_ESTI_VENE NUMBER(13,2),
  VAL_ESTI_PEDI NUMBER(9),
  VAL_ESTI_CLIE NUMBER(9),
  VAL_ESTI_ACTI NUMBER(9),
  VAL_ESTI_INGR NUMBER(9),
  VAL_ESTI_EGRE NUMBER(9),
  VAL_ESTI_REIN NUMBER(9),
  NUM_PEDI_OBJE NUMBER(9),
  NUM_ACTI_OBJE NUMBER(9),
  VAL_REAL_TCPR NUMBER(13,2),
  VAL_ESTI_TCPR NUMBER(13,2),
  IND_MODI_PEOB VARCHAR2(1),
  USU_DIGI      VARCHAR2(20),
  FEC_DIGI      DATE,
  USU_MODI      VARCHAR2(20),
  FEC_MODI      DATE
);
TYPE tablaRegDatEstimado IS TABLE OF tRegDatEstimado;
/***************************************************************************
Descripcion       : Genera Interfase de Envio de Canales de Venta
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_CANAL_VENTA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoIso   VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Maestros de Zona
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_ZONA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Maestros de Marcas de Producto
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_MARCA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Impuestos por Producto
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_IMPUE_PRODU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psPeriodo VARCHAR2,
   psCodigoAcceso VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Maestro de Productos
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_PRODU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoIso   VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Maestro de Estados de Cobranza
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_ESTAD_COBRA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfase de Envio de Saldos Promedio por Canpa?a
                    y Producto
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_SALDOS_PROME_CAMPA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psFechaFacturacion VARCHAR2);

/***************************************************************************
Descripcion       : Devuelve el Codigo de Curso
Fecha Creacion    : 26/02/2007
Autor             : Jose Nunez M.
***************************************************************************/
FUNCTION INT_FN_DEVUE_CODIG_CURSO(
   pnOidCliente  mae_clien.oid_clie%TYPE,
   psFechaInicio cra_perio.fec_inic%TYPE,
   psFechaFinal  cra_perio.fec_fina%TYPE
) RETURN VARCHAR2;

/***************************************************************************
Descripcion       : Devuelve el Flag Estrella General de Cliente
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_ESTRE_GENER(
   pnOidCliente  NUMBER,
   pnOidTipoCliente NUMBER,
   pnOidTipoClasificacion NUMBER,
   pnOidClasificacion NUMBER
)
RETURN VARCHAR2;

/***************************************************************************
Descripcion       : Devuelve el Flag de Paso de Pedido
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_PASO_PEDID(
   pnOidCliente  NUMBER,
   pnOidPeriodo  NUMBER,
   psCodigoModulo VARCHAR2
)
RETURN VARCHAR2;

/***************************************************************************
Descripcion       : Devuelve el Flag de Dupla Cyzone
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_DUPLA_CYZON(
   pnOidCliente  NUMBER,
   psCodClasificacion  VARCHAR2,
   psCodTipoClasificacion VARCHAR2
)
RETURN VARCHAR2;

/***************************************************************************
Descripcion       : Genera Interface de Envio de Estatus por Colsultora al
                    cierre de Periodo
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_ESTAT_CONSU_CIERR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   pnOidTipoCliente NUMBER,
   pnOidTipoClasifCliente NUMBER,
   pnOidClasifCliente NUMBER,
   psCodigoClasifCyzone VARCHAR2,
   psCodigoTipoClasifCyzone VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interface de Envio de Estadistico de CDR's por
                    Colsultora
Fecha Creacion    : 06/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_ESTAD_CDRS_CONSU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psEstadoOperacion VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psFechaFacturacion VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Tipos de Documento para Pedidos
Fecha Creacion    : 10/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_TIPOS_DOCUM_PEDID
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2);

/***************************************************************************
Descripcion       : Devuelve el Tipo de Cobertura (1) Areas (0)NACIONAL
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_TIPO_COBER(
   pnOidParametro  NUMBER
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Devuelve el Tipo de Exigencia de Niveles
                   (M) Marca
                   (P) Producto
                   (N) No tiene
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_TIPO_EXIG_NIVEL(
   pnOidParametro  NUMBER
)


RETURN VARCHAR2;



/***************************************************************************
Descripcion       : Devuelve el Porcentaje Adicional de Cuota
Fecha Creacion    : 12/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PORCE_ADICI_CUOTA(
   pnOidParametro  NUMBER
)
RETURN NUMBER;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Concursos
Fecha Creacion    : 12/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_CONCU
  ( psCodigoPais        VARCHAR2,
    psCodigoSistema     VARCHAR2,
    psCodigoInterfaz    VARCHAR2,
    psNombreArchivo     VARCHAR2,
    psCodiIso           VARCHAR2,
    psCodigoMarca       VARCHAR2,
    psCodigoCanal       VARCHAR2,
    psCodigoPeriodo     VARCHAR2,
    psCodigoAcceso      VARCHAR2
   );

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Ventas por Seccion y Periodo
                    y Producto
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_VENTA_SECCI_PERIO
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2
   );

/***************************************************************************
Descripcion       : Devuelve Listado  de Estimados
Fecha Creacion    : 23/02/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
FUNCTION VEN_FN_OBTIE_ESTIM(
    psCodPeriodoMayor     VARCHAR2,
    psCodPeriodoMenor     VARCHAR2,
    psCodPais             VARCHAR2,
    psCodMarca            VARCHAR2,
    psCodCanal            VARCHAR2,
    psCodRegion           VARCHAR2,
    psCodZona             VARCHAR2,
    psCodSeccion          VARCHAR2)
RETURN  tablaRegDatEstimado PIPELINED;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Unidades Administrativas
                    por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_UNIDA_ADMIN_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Niveles por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_NIVEL_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Parametria de Opciones de premio
                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PARAM_OPCIO_PREMI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Participantes por Concurso
                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PARTI_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Productos relacionados al Concurso

                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PRODU_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoIso   VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio informacion de las Listas de
                    Recomendantes y Recomendadas por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_RECTE_RECDA_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Historico de Premios
                    despachados por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_HISTO_PREMI_DESPA
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Premios Seleccionados
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_SELEC
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2,
   psCodigoPeriodo  VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Premios Solicitados
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_SOLIC
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Puntaje de Ebelistas por
                    Periodo y concurso vigente
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PUNTA_PERIO_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2);

/***************************************************************************
Descripcion       : Devuelve los ingresos totales de la Periodo actual
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_PERIO_ACTUA(
   pnOidPeriodo  NUMBER,
   pnOidCliente NUMBER
)
RETURN NUMBER;


/***************************************************************************
Descripcion       : Devuelve los ingresos lideres que pasaron 2do pedido
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_LIDER_PEDI2(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Devuelve los ingresos lideres que pasaron 2do pedido
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_LIDER_PEDI3(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Recomendaciones efectivas a la
                    Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_RECOM_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Pedido Adicional a la
                    Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_PEDID_ADICI(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Pedido en la Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_PEDID_PERIO(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Impuestos por Producto
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_RESUL_CONCU_LIDER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Ebelistas Afiliadas
                    al programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_EBELI_SESSI_EXPER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Productos
                    del programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PRODU_SESSI_EXPER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de informacion de premios que
                    fueron asignados en total
                    del programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_ASIGN_TOTAL
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2);
/***************************************************************************
Descripcion       : Devuelve el Numero de Pedidos para la interfaz de estatus
                    Ebelistas al cierre de Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_PEDID(
   pnOidPeriodo  NUMBER,
   pnOidCliente NUMBER
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Genera Interfaz Datos Adicionales (DAT-86)
Fecha Creacion    : 08/09/2008
Autor             : RRG
***************************************************************************/
PROCEDURE INT_PR_DAT_ADICI_EBELI
  (
   psCodigoPais    VARCHAR2,
   psCodigoSistema    VARCHAR2,
   psCodigoInterfaz   VARCHAR2,
   psNombreArchivo    VARCHAR2);
/***************************************************************************
Descripcion       : Devuelve el tipo de cliente al que esta dirigido el concurso tomando los
                    valores de retorno de la nueva tabla INT_DAT_INC_DIRIG
Fecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION  INT_FN_DEVUE_CONCU_DIRIG(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Devuelve el tipo de agrupacion para el concurso tomando los valores
                    indicados de la nueva tabla INT_DAT_INC_AGRU1
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION  INT_FN_DEVUE_TIPO_CONCU_AGRUP1(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Devuelve el tipo de agrupacion para el concurso tomando como valores
                    de retorno los indicados en la tabla INT_DAT_INC_AGRU2
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_TIPO_CONCU_AGRUP2(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Devuelve el estado del concurso tomando los valores de retorno de
                    la tabla INT_DAT_INC_ESTAD
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_CONCU_ESTAD(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Devuelve el tipo de efectividad del concurso tomando los valores de
                    la tabla INT_DAT_INC_TIPO_EFECT
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_TIPO_EFECT(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Devuelve la unidad de medida del  concurso tomando los valores de
                    la tabla INT_DAT_INC_UNIDA_MEDID
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_CONCU_UNIDA_MEDID(
   pnOidConcurso  NUMBER

)
RETURN VARCHAR2;
/***************************************************************************
Descripcion       : Genera Interfaz de Envio de todos los registros que abarquen
                  los Periodos del concurso desde su inicio hasta su fin,
                  incluyendo los Periodos de calculo, efectividad y despachort
Fecha Creacion    : 10/10/2008
Autor             : Cristhian Roman
***************************************************************************/
PROCEDURE INT_PR_DAT_INCEN_TIEMP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2);
/**************************************************************************
  Descripcion       : Devuelve el valor del parametro de la tabla
               INT_DAT_PARAM_GENER
   Fecha Creacion    : 12/02/2009
  Parametros Entrada:
      psCodigoPais   : Codigo de pais
      psCodigoParametro   : Codigo de parametro
  Autor             : Cristhian Roman
  ***************************************************************************/
  FUNCTION INT_FN_DAT_DEVUE_PARAM_GENER
  (
    pscodigopais      VARCHAR2,
    pscodigoparametro VARCHAR2
  ) RETURN VARCHAR2;
 /***************************************************************************
Descripcion       : Carga la tabla INT_DAT_INC_CONCU_PROCE antes de la ejecucion
                     de las interfaces de datamart
Fecha Creacion    : 12/02/2009
Autor             : Cristhian Roman
***************************************************************************/
PROCEDURE INT_PR_DAT_CARGA_CONCU(pscodigopais VARCHAR2);
/**************************************************************************
  Descripcion       : Devuelve el valor VICO_OID_VIGE_CONC de la tabla
               INT_DAT_INC_CONCU_PROCE
   Fecha Creacion    : 12/02/2009
  Parametros Entrada:
      psCodigoPais   : Codigo de pais
      psCodigoParametro   : Codigo de parametro
  Autor             : Cristhian Roman
  ***************************************************************************/
  FUNCTION INT_FN_DAT_OID_VIGEN_CONCU(psoidparamgral NUMBER)
    RETURN NUMBER;



/***************************************************************************
Descripcion       : Funcion que devolvera el numero de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_INGRE_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje obtenido por cumplir la meta de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_INGRE_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de ingresos efectivos adicionales
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_EFECT_ADICI(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje obtenido por superar la meta de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_SUPER_INGRE(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de pedidos objetivos calculado
                    para la seccion en el programa de lideres
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PEDID_OBJET_PGLID(
   psCodigoPeriodo  VARCHAR2,
   psCodRegion           VARCHAR2,
   psCodZona             VARCHAR2,
   psCodSeccion          VARCHAR2
)
RETURN NUMBER;

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de activas finales utilizando
                    para el calculo del pedido objetivo
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_ACTIV_FINAL_PGLID(
   psCodigoPeriodo  VARCHAR2,
   psCodRegion           VARCHAR2,
   psCodZona             VARCHAR2,
   psCodSeccion          VARCHAR2
)
RETURN NUMBER;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Clasificacion Programa
Fecha Creacion    : 02/04/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_TIPO_CLASIF_PROGR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio Responsable Seccion
Fecha Creacion    : 02/04/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_RESPO_SECCI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/***************************************************************************
Descripcion       : Genera Interfaz de Envio Ranking Lideres
Fecha Creacion    : 02/04/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_RANKI_LIDER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion       : Interfaz que envia el maestro de tipos de clasificacion del Programa de Lideres
Fecha Creacion    : 07/04/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_TIPOS_CLASI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje bonificado en la Periodo
Fecha Creacion    : 30/07/2009
Autor             : Sergio Apaza
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_BONIF_PERIO(
   pnOidPeriodo     NUMBER,
   pnOidConcurso    NUMBER,
   pnOidLider       NUMBER
)
RETURN NUMBER;


/***************************************************************************
Descripcion       : Interfaz que envia el puntaje de concurso agrupado x cliente
Fecha Creacion    : 07/10/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVI_PUNTA_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/***************************************************************************
Descripcion       : Interfaz que envia los productos de apoyo
Fecha Creacion    : 16/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_APOYO
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/*******************************************************************************
Descripcion       : Interfaz que envia los productos reemplazados en una Periodo
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_REEMP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/**********************************************************************************************
Descripcion       : Interfaz que envia los Cronogramas planificados de facturacion de las zonas
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
***********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CRONO_PLANI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psfechaFacturacion VARCHAR2);


/*******************************************************************************
Descripcion       : Interfaz que envia los motivos de transacciones post venta
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MOTIV_CDR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);


/*******************************************************************************
Descripcion       : Interfaz que envia los motivos de rechazo de pedidos
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MOTIV_RECHA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/*******************************************************************************
Descripcion       : Interfaz que envia los motivos de rechazo de cdr
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RECHA_CDR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/*********************************************************************
Descripcion       : Interfaz que envia los productos de recuperacion
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
**********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_RECUP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/*********************************************************************
Descripcion       : Interfaz que envia las boletas de recojo
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psValIndiImpu    : Valor del Indicador de la Interface
**********************************************************************/

PROCEDURE INT_PR_DAT_ENVIO_BOLET_RECOJ
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psValIndiImpu   VARCHAR2);

/*********************************************************************
Descripcion       : Funcion para transformar a CDR
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psTipoRefe     : Tipo de Referencia

**********************************************************************/
FUNCTION INT_FN_DAT_TRANS_CDR(psTipoRefe  VARCHAR2)
RETURN VARCHAR2;

/*********************************************************************
Descripcion       : Funcion para obtener Motivo de CDR homologado
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psMotSPV     : Motivo SPV

**********************************************************************/
FUNCTION INT_FN_DAT_MOTIV_CDR(psMotSPV  VARCHAR2)
RETURN VARCHAR2;

/*********************************************************************
Descripcion       : Funcion para obtener motivo de rechazo de mayor prioridad
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psTipoDocuDeta     : Tipo de Documento Detalle
          psTipoDocuCabe     : Tipo de Documento Cabecera
          pnSecNumeDocu     : Numero de Documento

**********************************************************************/
FUNCTION INT_FN_DAT_MOTIV_RECHA_PRIOR(
   psTipoDocuDeta  VARCHAR2,
   psTipoDocuCabe  VARCHAR2,
   pnSecNumeDocu   NUMBER
)
RETURN VARCHAR2;

/***************************************************************************
Descripcion       : Interfaz que envia detalles de los documentos post venta
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoDetalle : Tipo de Documento Detalle
          psTipoDocumentoCabecera : Tipo de Documento Cabecera
**************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DETAL_POSTV(
   psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psTipoDocumentoDetalle VARCHAR2,
   psTipoDocumentoCabecera VARCHAR2,
   psfechaFacturacion VARCHAR2
);

/******************************************************************
Descripcion       : Interfaz que envia los documentos post venta
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoDetalle : Tipo de Documento Detalle
          psTipoDocumentoCabecera : Tipo de Documento Cabecera
******************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DOCUM_POSTV(
  psCodigoPais VARCHAR2,
  psCodigoSistema VARCHAR2,
  psCodigoInterfaz VARCHAR2,
  psNombreArchivo VARCHAR2,
  psCodigoMarca VARCHAR2,
  psCodigoCanal VARCHAR2,
  psCodigoPeriodo VARCHAR2,
  psTipoDocumentoCabecera VARCHAR2,
  psfechaFacturacion VARCHAR2
);

/*****************************************************************
Descripcion       : Interfaz que envia los pedidos rechazados
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoOCCabecera : Tipo de Documento OCC Cabecera
******************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PEDID_RECHA(
  psCodigoPais VARCHAR2,
  psCodigoSistema VARCHAR2,
  psCodigoInterfaz VARCHAR2,
  psNombreArchivo VARCHAR2,
  psCodigoMarca VARCHAR2,
  psCodigoCanal VARCHAR2,
  psCodigoPeriodo VARCHAR2,
  psTipoDocumentoOCCabecera VARCHAR2
);

/***************************************************************************
Descripcion       : Genera Interface de Envio de Fecha de Cierre de
                    Campanha
Fecha Creacion    : 11/02/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_CIERR(
   psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2
);

/***************************************************************************
Descripcion       : Genera Interface de Envio de Productos de Reemplazo
Fecha Creacion    : 11/02/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_REMPL(
   psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psNumeroLote     VARCHAR2
);

/**************************************************************************
  Descripcion       : Devuelve la ultima fecha que se ejecuto la interfaz
                      pasado como parametro
  Fecha Creacion    : 12/02/2010
  Parametros Entrada:
      psCodigoPais       : Codigo de pais
      psCodigoInterfaz   : Codigo de Interfaz
  Autor             : Jose Luis Rodriguez
***************************************************************************/
FUNCTION INT_FN_DEVUE_FECHA_ULTIM_EJECU
  (
    psOidpais      VARCHAR2,
    psCodigoInterfaz  VARCHAR2
  ) RETURN DATE;

/***************************************************************************
Descripcion       : Inserta un registro en la tabla int_histo_lotes
Fecha Creacion    : 03/03/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_INSER_HISTO_LOTES(
   psOidPais         NUMBER,
   psCodInterfaz    VARCHAR2,
   psNumeroLote     VARCHAR2,
   psContadorReg    NUMBER,
   pdFechaIinicio   DATE
);

/***************************************************************************
Descripcion : Interfaz que envia maestro segmento love
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SEGME_LOVE
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia maestro grupo segmento love
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GRUPO_LOVE
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia maestro tipo logro
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LOGRO
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia logro consultora
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LOGRO_CONSU
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2);

/**************************************************************************
 Descripcion : Devuelve la actividad del lider
 Fecha Creacion : 22/03/2010
 Parametros Entrada:
 psCodigoPeriodo : Codigo de Periodo
 psCodigoLider : Codigo Lider
 Autor : Sergio Buchelli
***************************************************************************/
FUNCTION INT_FN_DEVUE_ACTIV_LIDER
 (
 psCodigoPeriodo VARCHAR2,
 psCodigoLider VARCHAR2
 ) RETURN NUMBER ;


/***************************************************************************
Descripcion : Interfaz que envia las fechas de los documentos
Fecha Creacion : 25/03/2010
Autor : Jesse Rios
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca        : Codigo Marca
 psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_DOCUM
 (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2);

  /***************************************************************************
  Descripcion       : Genera Interfaz de Envio de clientes
  Fecha Creacion    : 30/11/2010
  Autor             :  S.b
  ***************************************************************************/
  PROCEDURE INT_PR_DAT_ENVIO_CLIEN
  (
    pscodigopais     VARCHAR2,
    pscodigosistema  VARCHAR2,
    pscodigointerfaz VARCHAR2,
    psnombrearchivo  VARCHAR2,
    pscodigomarca    VARCHAR2,
    pscodigocanal    VARCHAR2,
 psCodigoPeriodo VARCHAR2
  );

  /***************************************************************************
Descripcion : Interfaz que envia informacion Maestro Hijas Duplas (DAT-37)
Fecha Creacion : 11/01/2010
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_HIJAS_DUPLA
 (psCodigoPais      VARCHAR2,
  psCodigoSistema     VARCHAR2,
  psCodigoInterfaz     VARCHAR2,
  psNombreArchivo     VARCHAR2,
  psCodigoMarca         VARCHAR2,
  psCodigoCanal         VARCHAR2,
  psCodigoPeriodo     VARCHAR2);

/*************************************************************************************************
Descripcion       : Genera Interface de Envio de Fecha Cierre Campanha para Incentivos  (DAT-105)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoPeriodo : Codigo Periodo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
Autor: Sergio Buchelli
**************************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECCI_INCEN (
   psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoPeriodo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2
);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Regiones (DAT-13)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
 psCodigoIso  : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_REGIO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psCodigoMarca           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Empresas (DAT-3)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SOCIE
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Accesos (DAT-35)
Fecha Creacion    : 10/12/2010
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoCanal  : Codigo Canal
 psCodigoIso  : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ACCES
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo        VARCHAR2,
   psCodigoCanal          VARCHAR2,
   psCodigoIso             VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Logro (DAT-106)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Registro Logro (DAT-107)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_REGIS_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo    VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Ganancia Logro (DAT-108)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GANAN_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo    VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Asistencia Comparatamos(DAT-109)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ASIST_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz     VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo    VARCHAR2);

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Maestro Programa Lideres
                      ( DAT-110 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR_LIDER
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Nivel por Periodo ( DAT-111 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_CAMPA
  (psCodigoPais          VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal      VARCHAR2,
   psCodigoIso          VARCHAR2,
   psCodigoPeriodo    VARCHAR2);

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Nivel por Programa ( DAT-112 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PROGR
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Rango de Pedidos ( DAT-113 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RANGO_PEDID
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/***********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Resultado por Periodo ( DAT-114 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/***********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_CAMPA
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/***********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Resultado por Programa ( DAT-115 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/***********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_PROGR
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Maestro de Clasificaciones Let
                      ( DAT-132 )
  Fecha Creacion    : 24/07/2012
  Autor             : CSVD FFVV
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_LIDER
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2);
/***************************************************************************
Descripcion       : Genera Interfaz de Envio Unidades Geograficas (DAT-5)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNIDA_GEOGR
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/************************************************************************************
Descripcion       : Genera Interfaz de Envio Unidades Geograficas de Periodo (DAT-6)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNIGE_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/************************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion Gerentes Regionales (DAT-7)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GEREN_REGIO
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion de Lideres (DAT-10)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_INFOR_LIDER
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/*************************************************************************
Descripcion       : Genera Interfaz de Envio Matriz de Periodo (DAT-11)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoPeriodo  : Codigo Periodo
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MATRI_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/*********************************************************************
Descripcion       : Genera Interfaz de Envio de Secciones (DAT-14)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SECCI
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo VARCHAR2);

/***************************************************************************************
Descripcion       : Genera Interfaz de Envio Homologacion Status de Clientes (DAT-15)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
****************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_HOMES_CLIEN
  (psCodigoPais 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/********************************************************************
Descripcion       : Genera Interfaz de Envio de Periodos (DAT-16)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/**********************************************************************
Descripcion       : Genera Interfaz de Envio Tipos de Oferta (DAT-17)
Parametros:
 psCodigoPais     : Codigo de Pais
  psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPOS_OFERT
  (psCodigoPais 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/*******************************************************************
Descripcion       : Genera Interfaz de Envio de Zonas (DAT-18)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ZONAS
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Estatus Zonas (DAT-27)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAT_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/********************************************************************************
Descripcion       : Genera Interfaz de Envio Zonas Reales por Region (DAT-34)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ZONAS_REREG
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);


/*********************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion Gerentes Zona (DAT-8)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GEREN_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/******************************************************************************
Descripcion       : Genera Interfaz de Envio Numero Pedidos por Dia (DAT-22)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais       : Codigo Pais
 psCodigoMarca      : Codigo Marca
 psCodigoCanal      : Codigo Canal
 psCodigoAcceso V	: Codigo Acceso
 psCodigoPeriodo    : A?o Periodo
 psFechaFacturacion : Fecha Facturacion
 psCodigoSistema    : Codigo Empresa
 psCodigoInterfaz   : Codigo Interfaz
 psNombreArchivo    : Nombre Arcchivo
 psCodigoIso        : Codigo Iso
Autor:                  Sergio Buchelli
*******************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NUMER_PEDDI
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoAcceso 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psFechaFacturacion 	  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Transacciones por Zona(DAT-26)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRANS_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2);

/***********************************************************************************
Descripcion       : Genera Interfaz de Envio Numero Pedidos por Periodo (DAT-21)
Fecha Creacion    : 05/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NUMER_PEDID
  (psCodigoPais 		  VARCHAR2,
   psCodigoPeriodo 		VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		VARCHAR2,
   psCodigoInterfaz 	VARCHAR2,
   psNombreArchivo 		VARCHAR2,
   psFechaFact        VARCHAR2,
   psCodigoAcceso     VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Status Consultora (DAT-23)
Fecha Creacion    : 05/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo

Autor: Jose Luis Rodriguez
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_STATU_CONSU
  (psCodigoPais 		 VARCHAR2,
   psCodigoPeriodo 	 VARCHAR2,
   psCodigoCanal 		 VARCHAR2,
   psCodigoSistema 	 VARCHAR2,
   psCodigoInterfaz  VARCHAR2,
   psNombreArchivo 	 VARCHAR2,
   psFechaFact       VARCHAR2);
/****************************************************************************
Descripcion       : Genera Interfaz de Envio Status Consultora (DAT-23)
Fecha Creacion    : 05/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo

Autor: FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_STATU_CLIEN
  (psCodigoPais 		 VARCHAR2,
   psCodigoPeriodo 	 VARCHAR2,
   psCodigoCanal 		 VARCHAR2,
   psCodigoSistema 	 VARCHAR2,
   psCodigoInterfaz  VARCHAR2,
   psNombreArchivo 	 VARCHAR2,
   psFechaFact       VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Tiempos de Periodo (DAT-29)
Fecha Creacion    : 06/05/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo

Autor: Jose Luis Rodriguez
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIEMP_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoPeriodo 		VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		VARCHAR2,
   psCodigoInterfaz 	VARCHAR2,
   psNombreArchivo 		VARCHAR2,
   psFechaFacturacion  VARCHAR2);

/**************************************************************
Descripcion        : Verifica si en la Periodo y fecha de facturacion
                     vigente existen transacciones de CDR con la
                     Periodo siguiente.
Fecha Creacion     : 14/07/2011
Fecha Modificacion :
Parametros         : psCodigoPais: Codigo de Pais
                     psCodigoMarca: Codigo de Marca
                     psCodigoCanal: Codigo de Canal
                     psCodigoPeriodo: Codigo de Periodo
                     psFechaFacturacion: Fecha de Facturacion
Autor              : Sergio Apaza
***************************************************************/
FUNCTION INT_FN_DAT_VERIF_CDRS_PERIO
  (psCodigoPais       IN VARCHAR2,
   psCodigoMarca      IN VARCHAR2,
   psCodigoCanal      IN VARCHAR2,
   psCodigoPeriodo    IN VARCHAR2,
   psFechaFacturacion IN VARCHAR2)
RETURN NUMBER;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Fecha de Control (DAT-04, DAT-116)
Fecha Creacion    : 14/07/2011
Parametros:
  psCodigoPais        : codigo de pais
  psCodigoPeriodo     : Periodo de facturacion
  psCodigoMarca       : codigo de marca
  psCodigoCanal       : codigo de canal
  psCodigoSistema     : codigo de sistema para interfaz
  psCodigoInterfaz    : codigo de interfaz
  psNombreArchivo     : nombre que va a generar la interfaz
  psFechaFacturacion  : fecha de facturacion
  psIndModulo         : Indicador de modulo ( V=Ventas, I=Incentivos )

Autor: Sergio Apaza
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_CONTR
  (psCodigoPais 		   VARCHAR2,
   psCodigoPeriodo 		 VARCHAR2,
   psCodigoMarca 		   VARCHAR2,
   psCodigoCanal 		   VARCHAR2,
   psCodigoSistema 		 VARCHAR2,
   psCodigoInterfaz 	 VARCHAR2,
   psNombreArchivo 		 VARCHAR2,
   psFechaFacturacion  VARCHAR2,
   psIndModulo         VARCHAR2);

/*************************************************************************
Descripcion       : Genera Interfaz de Envio Control Cierres (DAT-36)
Fecha Creacion    : 25/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONTR_CIERR(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/****************************************************************************
Descripcion       : Genera interfaz de cabecera de pedidos para datamart (DAT-12)
Fecha Creacion    : 25/06/2012
Parametros: psCodigoPais       = Codigo de pais
            psCodigoPeriodo    = Periodo de facturacion
            psCodigoSistema    = Sistema de interfaz ( DAT )
            psCodigoInterfaz   = Codigo de interfaz ( DAT-12)
            psNombreArchivo    = Archivo de salida ( DAT-12-AAAAMMDDssss )
            psFechaFacturacion = Fecha de facturacion
            psCodigoAcceso     = Codigo de acceso
            psCodigoCanal      = Codigo de canal
Autor: CMori CSVD FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_BOLET_DESPA(
  psCodigoPais        VARCHAR2,
  psCodigoPeriodo     VARCHAR2,
  psCodigoSistema     VARCHAR2,
  psCodigoInterfaz    VARCHAR2,
  psNombreArchivo     VARCHAR2,
  psFechaFacturacion  VARCHAR2,
  psCodigoAcceso      VARCHAR2,
  psCodigoCanal       VARCHAR2);

/****************************************************************************
Descripcion       : Genera interfaz de cabecera de pedidos para datamart (DAT-24)
Fecha Creacion    : 25/06/2012
Parametros: psCodigoPais       = Codigo de pais
            psCodigoPeriodo    = Periodo de facturacion
            psCodigoSistema    = Sistema de interfaz ( DAT )
            psCodigoInterfaz   = Codigo de interfaz ( DAT-24)
            psNombreArchivo    = Archivo de salida ( DAT-24-AAAAMMDDssss )
            psFechaFacturacion = Fecha de facturacion
Autor: CMori CSVD FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRANS_CLIEN(
  psCodigoPais      VARCHAR2,
  psCodigoPeriodo   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFacturacion  VARCHAR2);

/*************************************************************************
Descripcion       : Genera Interfaz de Envio Control Cierres (DAT-117)
Fecha Creacion    : 25/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_LET_ENVIO_PROYE_PROGR(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);
/***************************************************************************
Descripcion       : Genera Interfaz de Envio Canal de Ingreso del Pedido (DAT-119)
Fecha Creacion    : 27/03/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAL_PEDID(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Impuestos ICE (DAT-118)
Fecha Creacion    : 02/04/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jesse James Rios Franco
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_IMPUE(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Maestro Programa Nuevas (DAT-120)
Fecha Creacion    : 22/05/2012
Fecha Modificacion: 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Codigo Acceso
   psCodigoCanal    : Codigp Canal

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 );


/*****************************************************************************************
Descripcion       : Genera Interfaz de Cupones, Premios y Kit - Programa Nuevas (DAT-121)
Fecha Creacion    : 22/05/2012
Fecha Modificacion: 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Archivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Codigo Acceso
   psCodigoCanal    : Codigo Canal

Autor: CSVD - FFVV
******************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUPON_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 );

/*********************************************************************************************
Descripcion       : Genera Interfaz de Cupones, Premios y Kit - CUV Programa Nuevas (DAT-122)
Fecha Creacion    : 22/05/2012
Fecha Modifcacion : 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Cod Acceso
   psCodigoCanal    : Cod Canal

Autor: Yury Romero
***********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUVPR_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 );

/*******************************************************************************************
Descripcion       : Genera Interfaz de Unidades Administrativas - Programa Nuevas (DAT-123)
Fecha Creacion    : 04/05/2012
Fecha Modificacion: 04/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Cod Acceso
   psCodigoCanal    : Cod Canal

Autor: CSVD - FFVV
********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNADM_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 );

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Cupones Usados (DAT-124)
Fecha Creacion    : 22/05/2012
Fecha Creacion    : 22/05/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUPON_USADO
 (
  psCodigoPais      VARCHAR2,
  psCodigoPeriodo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 );

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Canal de Ingreso del Pedido (DAT-125)
Fecha Creacion    : 27/03/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EJECU_NIVEL
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/***************************************************************************
Descripcion    : Enviar parametros del ciclo de ejecutivas ( DAT-126 )
Fecha Creacion : 04/07/2012
Parametros     :

Autor: CMori CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CICLO_EJECU
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/***************************************************************************
Descripcion    : Enviar resultado x Periodo de ejecutivas ( DAT-127 )
Fecha Creacion : 09/07/2012
Parametros     :

Autor: CMori CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_EJECU
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2);

/****************************************************************************
Descripcion       : Genera Interfaz de Maestro Programa de Reconocimiento Incentivos DAT-128)
Fecha Creacion    : 04/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRREC
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 );

/****************************************************************************
Descripcion       : Genera Interfaz de Nivel por Programa de Reconocimiento Activo DAT-129)
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRNIV
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 );

 /****************************************************************************
Descripcion       : Genera Interfaz con informacion sobre las consultoras que
                    lograron un nivel en el programa de reconocimiento(DAT-130)
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRREC_PNTJE
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 );

/****************************************************************************
Descripcion       : Genera Interfaz de con la informacion sobre el puntaje
                    alcanzado por la consultora en la Periodo(DAT-131).
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONSU_RECON
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Estados Lider  (DAT-133 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAT_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2
 );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Bajas Lider  (DAT-134 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TBAJA_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2
  );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Clasificaciones Lider  (DAT- 135 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2
  );


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Programas Lider  (DAT- 136 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
 );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider  (DAT- 137 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Reten  (DAT-138 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_SECCI
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Pedid  (DAT-139 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PEDID
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Reten  (DAT-140 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_RETEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider Result  (DAT-141 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_RESUL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );
/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider Retenciones  (DAT-142 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_RETEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2
  );
/***********************************************************************
Descripcion       : Genera Interfaz de Envio Fases Programa  (DAT-143 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FASE_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Programa  (DAT-144 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Parametros Programa  (DAT-145 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PARAM_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultados Programa  (DAT-146 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EJECU_RESUL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Metas Seccion  (DAT-147 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_META_SECCI
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Clientes (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLIEN_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Roles  (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ROL_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Perfiles  (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PERFI_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Cargo  (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_CARGO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Licencia  (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LICEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Operacion  (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_OPERA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Operaciones (DAT- )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_OPERA_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Programas LET (DAT-143 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Inicio Cursos y Ejecucion de Bonos LET (DAT-144)
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CURSO_BONO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Premio (DAT-145 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_PREMIO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Niveles LET (DAT-146 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lanzamiento Estrategico (DAT-147 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LANZA_ESTRA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Lanzamiento Estrategico (DAT-148 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DETAL_LANZA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Lanzamiento Estrategico (DAT-149 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LANZA_NIVEL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Lanzamiento LET (DAT-150 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_LANZA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Canastas (DAT-151 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_CANAS
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Canasta por Niveles LET (DAT-152 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAS_NIVEL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Canasta por Niveles LET (DAT-153 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAS_DETAL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Canasta por Niveles LET (DAT-154 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRAMO

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Cobranza por Tramo LET (DAT-155 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_COBRA_TRAMO

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Cobranza por Tramo LET (DAT-156 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_COBRA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCampanaProceso         VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Cobranza por Tramo LET (DAT-157 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CICLO_VIDA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Ciclo Vida por Nivel LET (DAT-158 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CVIDA_NIVEL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Pedido (DAT-159 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_PEDID

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lideres (DAT-160 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Clasificaciones LET (DAT-161 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_SUBCL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lideres (DAT-162 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SECCI_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro de Bajas(DAT-163 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_BAJA_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Calendario Cobranza (DAT-164 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CALEN_COBRA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio MAestro Exigencia Web por Geografia (DAT-165 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EXIGE_GEOGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***************************************************************************
Descripcion           : Genera Interfaz de Envio Tipo Reemplazo (DAT-129)
Fecha Creacion    : 05/05/2014
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
Autor : Sebastian Guerra
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_REEMP
 (psCodigoPais            VARCHAR2,
  psCodigoSistema       VARCHAR2,
  psCodigoInterfaz      VARCHAR2,
  psNombreArchivo      VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia interface de control que confirme la
              correcta ejecucion del paquete DATAMART - VENTAS
Fecha Creacion : 10/07/2014
Autor : Sergio Apaza
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LOTE_CONTR
 (psCodigoPais            VARCHAR2,
  psCodigoSistema         VARCHAR2,
  psCodigoInterfaz        VARCHAR2,
  psNombreArchivo         VARCHAR2,
  psFechaProceso          VARCHAR2,
  psCodigoPaquete         VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia parametros de Ranking de LET 2014
Fecha Creacion : 23/07/2013
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RANKI_NIVEL
 (psCodigoPais            VARCHAR2,
  psCodigoPeriodo         VARCHAR2,
  psCodigoSistema         VARCHAR2,
  psCodigoInterfaz        VARCHAR2,
  psNombreArchivo         VARCHAR2,
  psFechaProceso          VARCHAR2);

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Descuentos Nuevas (DAT-168 )
Fecha Creacion    : 22/08/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DESCU_NUEVA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2);

/***************************************************************************
Descripcion : Interfaz que envia consultoras excluidas LET 2014 (DAT-169)
Fecha Creacion : 29/08/2014
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONSU_EXCLU
 ( psCodigoPais            VARCHAR2,
   psCodigoPeriodo         VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 );

/***************************************************************************
Descripcion : Interfaz que envia Fechas de Entrega Exactas (DAT-170)
Fecha Creacion : 10/09/2014
Autor : Carlos Bazalar
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_ENTRE
 ( psCodigoPais            VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 );

/***************************************************************************
Descripcion : Interfaz que envia Estado de Programas (DAT-172)
Fecha Creacion : 13/07/2015
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAD_PROGR
 ( psCodigoPais            VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 );

/*************************************************************************
  Descripcion       : Genera Interfaz de Envio Recuperacion Cobranza (DAT-176)
Fecha Creacion    : 29/08/2015
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Anho Periodo
 psCodigoSistema  : Codigo Sistema
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Juan Carlos Gutirrez
***************************************************************************/
PROCEDURE INT_PR_LET_ENVIO_RECUP_COBRA(
  psCodigoPais 		  VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2);

/**************************************************************************
  Descripcion       : Ejecuta Validaciones Previas a la ejecucion de interfaces
  Fecha Creacion    : 13/01/2016
  Parametros Entrada:
  psCodigoPais   : Codigo de pais
  Autor             : Jose Cairampoma
  ***************************************************************************/
FUNCTION int_fn_dat_valid_previ(pscodigopais VARCHAR2) RETURN VARCHAR2;

END INT_PKG_DATAM;
/
CREATE OR REPLACE PACKAGE BODY "INT_PKG_DATAM" IS
/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Canales de Venta
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_CANAL_VENTA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoIso   VARCHAR2)
IS
   CURSOR c_interfaz IS

   SELECT SC.COD_CANA CODIGOCANAL,
          GEN_PKG_GENER.GEN_FN_DEVUELVE_DESCRIPCION(SC.OID_CANA,
                                                    'CANAL',
                                                    psCodigoIso) DESCRIPCIONCANAL
     FROM SEG_CANAL SC
    WHERE SC.COD_CANA = psCodigoCanal;
   TYPE interfazRec IS RECORD
   (
   codigoCanal         SEG_CANAL.COD_CANA%TYPE,
   descripcionCanal   GEN_I18N_SICC_COMUN.VAL_I18N%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */

        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoCanal            ||';'||
                              interfazRecord(x).descripcionCanal;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_CANAL_VENTA: '||ls_sqlerrm);
END INT_PR_DAT_CANAL_VENTA;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestros de Zona
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_ZONA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2)
IS
 CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS
   SELECT cod_zona CODIGOZONA
     FROM zon_zona zz
 WHERE zz.PAIS_OID_PAIS = vnIdPais
 AND zz.MARC_OID_MARC = vnIdMarca
 AND zz.CANA_OID_CANA = vnIdCanal
      AND zz.IND_ACTI = 1
      AND zz.IND_BORR = 0;
   TYPE interfazRec IS RECORD
   (
   codigoZona         zon_zona.cod_zona%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
 lnIdPais   NUMBER;
 lnIdCanal  NUMBER;
 lnIdMarca  NUMBER;
BEGIN
 lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
 lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
 lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);

     /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */
 OPEN c_interfaz(lnIdPais, lnIdMarca, lnIdCanal);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoZona;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_ZONA: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_ZONA;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestros de Marcas de Producto
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_MARCA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2)
IS
   CURSOR c_interfaz IS
   SELECT mp.COD_MARC_PROD,
         mp.DES_MARC_PROD
  FROM seg_marca_produ mp;

   TYPE interfazRec IS RECORD
   (
   codigoMarca               seg_marca_produ.cod_marc_prod%TYPE,
  descripcionMarca         seg_marca_produ.des_marc_prod%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */

        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoMarca ||';'||
                              interfazRecord(x).descripcionMarca;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_MARCA: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_MARCA;
/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Impuestos por Producto
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_IMPUE_PRODU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psPeriodo VARCHAR2,
   psCodigoAcceso VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER) IS
     SELECT DISTINCT psPeriodo,
            mp.cod_sap,
            to_char(ti.val_tasa_impu / 100, '990D99')
       FROM mae_produ       mp,
            ped_impue_gener ig,
            ped_tasa_impue  ti,
            seg_subac       sa,
            seg_acces       ac,
            PRE_OFERT_DETAL POD,
            PRE_OFERT PO,
            PRE_MATRI_FACTU_CABEC MFC,
            CRA_PERIO C ,
            SEG_PERIO_CORPO P
      WHERE ig.taim_oid_tasa_impu = ti.oid_tasa_impu
        AND ig.pais_oid_pais = vnidpais
        AND ig.sbac_oid_sbac = sa.oid_sbac
        AND sa.acce_oid_acce = ac.oid_acce
        AND ac.cod_acce =  decode(pscodigoacceso, '', 'GZ', NULL, 'GZ', pscodigoacceso)
        and POD.PROD_OID_PROD = MP.OID_PROD
        AND POD.OFER_OID_OFER = PO.OID_OFER
        AND PO.MFCA_OID_CABE = MFC.OID_CABE
        AND MFC.PERD_OID_PERI = C.OID_PERI
        AND C.PERI_OID_PERI=P.OID_PERI
        AND P.COD_PERI=psPeriodo;


   TYPE interfazRec IS RECORD
   (
   Periodo               VARCHAR2(6),
  codigoProducto       mae_produ.cod_sap%TYPE,
   impuestoVentas        VARCHAR2(10)

   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lbAbrirUtlFile      BOOLEAN;
BEGIN

   /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante

    /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).Periodo ||';'||
                              interfazRecord(x).codigoProducto ||';'||
                              interfazRecord(x).impuestoVentas;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_IMPUE_PRODU: '||ls_sqlerrm);
END INT_PR_DAT_IMPUE_PRODU;
/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Productos
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_PRODU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoIso   VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER) IS
     SELECT mp.cod_sap codigoProducto,
            substr(mp.des_cort, 1, 20) descripcionProducto,
            NULL descripcionProcedencia,
            substr(gen_pkg_gener.gen_fn_devuelve_descripcion(msp.Oid_Esta_Prod, 'MAE_ESTAT_PRODU', psCodigoIso), 1, 20) descripcionEstatus,
            mn.cod_nego codigoClase,
            smp.cod_marc_prod codigoMarca
       FROM mae_produ          mp,
            mae_estat_produ    msp,
            mae_negoc          mn,
            seg_marca_produ    smp
      WHERE mp.meud_oid_esta_prod = msp.oid_esta_prod
        AND mp.nego_oid_nego = mn.oid_nego
        AND mp.mapr_oid_marc_prod = smp.oid_marc_prod
        AND mp.pais_oid_pais = vnIdPais;

   TYPE interfazRec IS RECORD
   (
   codigoProducto        mae_produ.cod_sap%TYPE,
   descripcionProducto    mae_produ.des_cort%TYPE,
   descripcionProcedencia VARCHAR2(30),
   descripcionEstatus     gen_i18n_sicc_pais.val_i18n%TYPE,
   codigoClase            mae_negoc.cod_nego%TYPE,
   codigoMarca            seg_marca_produ.cod_marc_prod%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lbAbrirUtlFile      BOOLEAN;
BEGIN
   /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante

    /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoProducto ||';'||
                              interfazRecord(x).descripcionProducto ||';'||
                              interfazRecord(x).descripcionProcedencia ||';'||
                              interfazRecord(x).descripcionEstatus ||';'||
                              interfazRecord(x).codigoClase ||';'||
                              interfazRecord(x).codigoMarca;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_PRODU: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_PRODU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Estados de Cobranza
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_ESTAD_COBRA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2)
IS
   CURSOR c_interfaz IS
      SELECT ced.cod_etap_deud codigoEstatus,
             substr(ced.val_desc, 1, 20) descripcionEstatus,
             ced.val_edad_inic minimoDia,
             ced.val_edad_fina maximoDia,
             ' ' condicionCuenta
        FROM cob_etapa_deuda ced
       ORDER BY ced.val_edad_inic;

   TYPE interfazRec IS RECORD
   (
   codigoEstatus             cob_etapa_deuda.cod_etap_deud%TYPE,
   descripcionEstatus        cob_etapa_deuda.val_desc%TYPE,
   minimoDia                 cob_etapa_deuda.val_edad_inic%TYPE,
   maximoDia                 cob_etapa_deuda.val_edad_fina%TYPE,
   condicionCuenta           VARCHAR2(10)
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);

BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */

        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoEstatus ||';'||
                              interfazRecord(x).descripcionEstatus ||';'||
                              interfazRecord(x).minimoDia ||';'||
                              interfazRecord(x).maximoDia ||';'||
                              interfazRecord(x).condicionCuenta;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_PRODU: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_ESTAD_COBRA;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Saldos Promedio por Canpa?a
                    y Producto
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_SALDOS_PROME_CAMPA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psFechaFacturacion VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER) IS
     SELECT cnl.cod_cana codigoCanal,
            spc.cod_peri codigoPeriodo,
            mp.cod_sap codigoProducto,
            pto.cod_tipo_ofer codigoOferta,
            zz.cod_zona codigoZona,
            pod.val_codi_vent codigoVenta,
            SUM(sp.num_unid_aten) realUUAtendidas,
            SUM(sp.num_unid_dema_real - sp.num_unid_compr) realUUFaltantes
       FROM ped_solic_cabec sc,
            ped_solic_cabec scon,
            ped_solic_posic sp,
            mae_produ       mp,
            cra_perio       cp,
            seg_perio_corpo spc,
            pre_ofert_detal pod,
            pre_tipo_ofert  pto,
            zon_zona        zz,
            seg_canal       cnl,
            ped_estad_solic pes,
            ped_estad_posic pep
      WHERE sc.perd_oid_peri = cp.oid_peri
        AND cp.oid_peri = vnIdPeriodo
        AND cp.peri_oid_peri = spc.oid_peri
        AND cp.cana_oid_cana = cnl.oid_cana
        AND cnl.oid_cana = vnIdCanal
        AND cp.marc_oid_marc = vnIdMarca
        AND sc.fec_fact IS NOT NULL
        AND sc.fec_fact = DECODE(psFechaFacturacion,'',sc.fec_fact,NULL,sc.fec_fact,TO_DATE(psFechaFacturacion,'DD/MM/YYYY'))
        AND sc.soca_oid_soli_cabe = scon.oid_soli_cabe
        AND scon.esso_oid_esta_soli = pes.oid_esta_soli
        AND pes.cod_esta_soli <> 'AN'
        AND sc.pais_oid_pais = vnIdPais
        AND sc.oid_soli_cabe = sp.soca_oid_soli_cabe
        AND sp.prod_oid_prod = mp.oid_prod
        AND sp.ofde_oid_deta_ofer = pod.oid_deta_ofer(+)
        AND pod.tofe_oid_tipo_ofer = pto.oid_tipo_ofer
        AND sc.zzon_oid_zona = zz.oid_zona
        AND sc.ind_ts_no_conso = 1
        AND sc.ind_pedi_prue = 0
        AND sc.ind_oc = 1
        AND sp.espo_oid_esta_posi = pep.oid_esta_posi
        AND pep.cod_esta_posi <> 'AN'
        AND sc.modu_oid_modu <> psCodigoModulo
      GROUP BY cnl.cod_cana,
               spc.cod_peri,
               mp.cod_sap,
               pto.cod_tipo_ofer,
               zz.cod_zona,
               pod.val_codi_vent;

   TYPE interfazRec IS RECORD
   (
   codigoCanal                seg_canal.cod_cana%TYPE,
   codigoPeriodo              seg_perio_corpo.cod_peri%TYPE,
   codigoProducto             mae_produ.cod_sap%TYPE,
   codigoOferta               pre_tipo_ofert.cod_tipo_ofer%TYPE,
   codigoZona                 zon_zona.cod_zona%TYPE,
   codigoVenta                pre_ofert_detal.val_codi_vent%TYPE,
   realUUAtendidas            NUMBER,
   realUUFaltantes            NUMBER
   );



   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lnIdPeriodo         NUMBER;
  lbAbrirUtlFile      BOOLEAN;
BEGIN

   /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);-- id del Periodo consultante

   /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoCanal ||';'||
                              interfazRecord(x).codigoPeriodo ||';'||
                              interfazRecord(x).codigoProducto ||';'||
                              interfazRecord(x).codigoOferta ||';'||
                              interfazRecord(x).codigoZona ||';'||
                              interfazRecord(x).codigoVenta ||';'||
                              interfazRecord(x).realUUAtendidas ||';'||
                              interfazRecord(x).realUUFaltantes;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_SALDOS_PROME_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_SALDOS_PROME_CAMPA;

/***************************************************************************
Descripcion       : Devuelve el Codigo de Curso
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
FUNCTION INT_FN_DEVUE_CODIG_CURSO(
   pnOidCliente  mae_clien.oid_clie%TYPE,
   psFechaInicio cra_perio.fec_inic%TYPE,
   psFechaFinal  cra_perio.fec_fina%TYPE
)
RETURN VARCHAR2
IS
  lsCodigoCurso        edu_matri_curso.cod_curs%TYPE;
BEGIN
 lsCodigoCurso:='';
 SELECT mcur.cod_curs
   INTO lsCodigoCurso
   FROM edu_histo_curso hcur, edu_matri_curso mcur
  WHERE hcur.clie_oid_clie = pnOidCliente
    AND mcur.oid_curs = hcur.mcur_oid_curs
    AND psFechaInicio <= mcur.fec_fin_curs
    AND (mcur.fec_fin_curs IS NULL OR psFechaFinal >= mcur.fec_fin_curs);
RETURN lsCodigoCurso;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_CODIG_CURSO: '||ls_sqlerrm);
END INT_FN_DEVUE_CODIG_CURSO;
/***************************************************************************
Descripcion       : Devuelve el Flag Estrella General de Cliente
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_ESTRE_GENER(
   pnOidCliente  NUMBER,
   pnOidTipoCliente NUMBER,
   pnOidTipoClasificacion NUMBER,
   pnOidClasificacion NUMBER
)
RETURN VARCHAR2
IS
  lsFlagEstrGen        edu_matri_curso.cod_curs%TYPE;
BEGIN
 lsFlagEstrGen:='';
  SELECT COUNT(1)
    INTO lsFlagEstrGen
    FROM v_mae_tipif_clien vtc
   WHERE vtc.ticl_oid_tipo_clie = pnOidTipoCliente
     AND vtc.tccl_oid_tipo_clasi = pnOidTipoClasificacion
     AND vtc.clas_oid_clas = pnOidClasificacion
     AND clie_oid_clie = pnOidCliente;

RETURN lsFlagEstrGen;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_FLAG_ESTRE_GENER: '||ls_sqlerrm);
END INT_FN_DEVUE_FLAG_ESTRE_GENER;

/***************************************************************************
Descripcion       : Devuelve el Flag de Paso de Pedido
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_PASO_PEDID(
   pnOidCliente  NUMBER,
   pnOidPeriodo  NUMBER,
   psCodigoModulo VARCHAR2
)
RETURN VARCHAR2
IS
  lsFlagPasoPedido        edu_matri_curso.cod_curs%TYPE;
BEGIN
 lsFlagPasoPedido:='0';
  SELECT '1'
    INTO lsFlagPasoPedido
    FROM ped_solic_cabec psc,
         ped_solic_cabec psc1,
         ped_estad_solic pes,
         seg_modul       sm
   WHERE psc.soca_oid_soli_cabe = psc1.oid_soli_cabe
     AND psc1.esso_oid_esta_soli = pes.oid_esta_soli
     AND pes.cod_esta_soli <> 'AN'
     AND psc.ind_oc = 1
     AND psc.ind_ts_no_conso = 1
     AND psc.ind_pedi_prue = 0
     AND psc.modu_oid_modu = sm.oid_modu
     AND sm.cod_modu <> psCodigoModulo
     AND psc.perd_oid_peri = pnOidPeriodo
     AND psc.clie_oid_clie = pnOidCliente
     AND ROWNUM =1;

RETURN lsFlagPasoPedido;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '0';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_FLAG_PASO_PEDID: '||ls_sqlerrm);
END INT_FN_DEVUE_FLAG_PASO_PEDID;

/***************************************************************************
Descripcion       : Devuelve el Flag de Dupla Cyzone
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_FLAG_DUPLA_CYZON(
   pnOidCliente  NUMBER,
   psCodClasificacion  VARCHAR2,
   psCodTipoClasificacion VARCHAR2
)
RETURN VARCHAR2
IS
  lsFlagDuplaCyzone        VARCHAR2(1);
BEGIN
  lsFlagDuplaCyzone:='0';
  SELECT '1'
    INTO lsFlagDuplaCyzone
    FROM mae_clien_clasi      mcc,
         mae_clien_tipo_subti mcts,
         mae_clasi            mcl,
         mae_tipo_clasi_clien mtcc,
         mae_subti_clien      msc,
         mae_tipo_clien       mtc
   WHERE mcc.ctsu_oid_clie_tipo_subt = mcts.oid_clie_tipo_subt
     AND mcc.clas_oid_clas = mcl.oid_clas
     AND mcc.tccl_oid_tipo_clasi = mtcc.oid_tipo_clas
     AND mcts.ticl_oid_tipo_clie = mtc.oid_tipo_clie
     AND mcts.sbti_oid_subt_clie = msc.oid_subt_clie
     AND mcl.cod_clas = psCodClasificacion
     AND mtcc.cod_tipo_clas = psCodTipoClasificacion
     AND mcts.clie_oid_clie = pnOidCliente;


RETURN lsFlagDuplaCyzone;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '0';
WHEN OTHERS THEN
     RETURN '0';
--     ln_sqlcode := SQLCODE;
--     ls_sqlerrm := substr(sqlerrm,1,1000);
--     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_FLAG_DUPLA_CYZON: '||ls_sqlerrm);
END INT_FN_DEVUE_FLAG_DUPLA_CYZON;

/***************************************************************************
Descripcion       : Genera Interface de Envio de Estatus por Colsultora al
                    cierre de Periodo
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_ESTAT_CONSU_CIERR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   pnOidTipoCliente NUMBER,
   pnOidTipoClasifCliente NUMBER,
   pnOidClasifCliente NUMBER,
   psCodigoClasifCyzone VARCHAR2,
   psCodigoTipoClasifCyzone VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER) IS
      SELECT psCodigoCanal codigoCanal,
             spc.cod_peri codigoPeriodo,
             mc.cod_clie codigoEbelista,
             zt.cod_terr codigoTerritorio,
             SUBSTR(CASE WHEN mec.cod_esta_clie = '05' AND mcda.num_camp_sin_pedi > 2 THEN '07'
                      ELSE CASE WHEN mec.cod_esta_clie = '08' THEN '02'
                        ELSE mec.cod_esta_clie END END,2,1) codigoEstatus,
             int_pkg_datam.int_fn_devue_codig_curso(mc.oid_clie,cra.fec_inic,cra.fec_fina) codigoCapacitacion,
             int_pkg_datam.int_fn_devue_flag_estre_gener(mc.oid_clie, pnOidTipoCliente,pnOidTipoClasifCliente, pnOidClasifCliente) flagEstGeneral,
             '0' flagEstCosmeticos,
             '0' flagEstAccesorios,
             '0' flagEstrellaSM,
             '0' flagEstRegalables,
             '0' flagEstrellaHogar,
             '0' flagTerritorial,
             '0' flagSelect,
             ' ' promocionSelect,
             ' ' metaSelect,
             int_pkg_datam.int_fn_devue_flag_paso_pedid(mc.oid_clie, vnIdPeriodo, psCodigoModulo) flagPasoPedido,
             int_pkg_datam.int_fn_devue_numer_pedid(vnIdPeriodo,mc.oid_clie),
             int_pkg_datam.int_fn_devue_flag_dupla_cyzon(mc.oid_clie,psCodigoClasifCyzone,psCodigoTipoClasifCyzone) flagDuplaCyzone
        FROM mae_clien             mc,
             mae_clien_datos_adici mcda,
             mae_clien_unida_admin mcua,
             zon_terri_admin       zta,
             zon_terri             zt,
             seg_perio_corpo       spc,
             mae_estat_clien       mec,
             cra_perio             cra,
                   (SELECT MAX(fcc.perd_oid_peri) oidcmp_cierre
                          FROM fac_contr_cierr fcc,
                                     fac_tipos_cierr ftc
                         WHERE fcc.tcie_oid_tipo_cier = ftc.oid_tipo_cier
                           AND ftc.cod_tipo_cier ='P'
						     AND fcc.perd_oid_peri = vnIdPeriodo ) cierre
       WHERE cra.oid_peri = vnIdPeriodo
         AND cra.peri_oid_peri = spc.oid_peri
         AND cra.marc_oid_marc = vnIdMarca
         AND cra.cana_oid_cana = vnIdCanal
         AND cra.pais_oid_pais = vnIdPais
         AND mc.pais_oid_pais = cra.pais_oid_pais
         AND mc.oid_clie = mcua.clie_oid_clie
         AND mcua.ind_acti = 1
         AND mcua.ztad_oid_terr_admi = zta.oid_terr_admi
         AND zta.ind_borr = 0
         AND zta.terr_oid_terr = zt.oid_terr
         AND zt.ind_borr = 0
         AND mc.oid_clie = mcda.clie_oid_clie
         AND mcda.ind_acti = 1
         AND mcda.esta_oid_esta_clie = mec.oid_esta_clie
         AND cra.oid_peri = cierre.oidcmp_cierre;
         -- AND Trunc(cra.fec_fina)=Trunc(SYSDATE);

   TYPE interfazRec IS RECORD
   (
   codigoCanal                seg_canal.cod_cana%TYPE,
   codigoPeriodo              seg_perio_corpo.cod_peri%TYPE,
   codigoEbelista             mae_clien.cod_clie%TYPE,
   codigoTerritorio           zon_terri.cod_terr%TYPE,
   codigoEstatus              VARCHAR2(2),
   codigoCapacitacion         edu_matri_curso.cod_curs%TYPE,
   flagEstGeneral             VARCHAR2(1),
   flagEstCosmeticos          VARCHAR2(1),
   flagEstAccesorios          VARCHAR2(1),
   flagEstrellaSM             VARCHAR2(1),
   flagEstRegalables          VARCHAR2(1),
   flagEstrellaHogar          VARCHAR2(1),
   flagTerritorial            VARCHAR2(1),
   flagSelect                 VARCHAR2(1),
   promocionSelect            VARCHAR2(1),
   metaSelect                 VARCHAR2(1),
   flagPasoPedido             VARCHAR2(1),
   numeroOrdenes              NUMBER,
   flagDuplaCyzone            VARCHAR2(1)
   );



   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lnIdPeriodo         NUMBER;
  lbAbrirUtlFile      BOOLEAN;
BEGIN
   /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio(psCodigoPeriodo,lnIdMarca,lnIdCanal);-- id del Periodo consultante

   /* Generando Archivo de Texto (Detalle) */
       lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoCanal ||';'||
                              interfazRecord(x).codigoPeriodo ||';'||
                              interfazRecord(x).codigoEbelista ||';'||
                              interfazRecord(x).codigoTerritorio ||';'||
                              interfazRecord(x).codigoEstatus ||';'||
                              interfazRecord(x).codigoCapacitacion ||';'||
                              interfazRecord(x).flagEstGeneral ||';'||
                              interfazRecord(x).flagEstCosmeticos ||';'||
                              interfazRecord(x).flagEstAccesorios ||';'||
                              interfazRecord(x).flagEstrellaSM ||';'||
                              interfazRecord(x).flagEstRegalables ||';'||
                              interfazRecord(x).flagEstrellaHogar ||';'||
                              interfazRecord(x).flagTerritorial ||';'||
                              interfazRecord(x).flagSelect ||';'||
                              interfazRecord(x).promocionSelect ||';'||
                              interfazRecord(x).metaSelect ||';'||
                              interfazRecord(x).flagPasoPedido ||';'||
                              interfazRecord(x).numeroOrdenes ||';'||
                              interfazRecord(x).flagDuplaCyzone;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ESTAT_CONSU_CIERR: '||ls_sqlerrm);
END INT_PR_DAT_ESTAT_CONSU_CIERR;

/***************************************************************************
Descripcion       : Genera Interface de Envio de Estadistico de CDR's por
                    Colsultora
Fecha Creacion    : 06/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_ESTAD_CDRS_CONSU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoModulo VARCHAR2,
   psEstadoOperacion VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psFechaFacturacion VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER,vnIdPeriodo NUMBER) IS
     SELECT mc.cod_clie codigoEbelista,
            psCodigoPeriodo codigoPeriodo,
            DECODE(SIGN(SUM(DECODE(new_tabla.ind_true, 1, 1, 0))), 1, 1, 0) flagCambios,
            DECODE(SIGN(SUM(DECODE(new_tabla.ind_canj, 1, 1, 0))), 1, 1, 0) flagCanjes,
            DECODE(SIGN(SUM(DECODE(new_tabla.ind_devo, 1, 1, 0))), 1, 1, 0) flagDevoluciones,
            DECODE(SIGN(SUM(DECODE(new_tabla.ind_anul,
                                   1,
                                   1,
                                   DECODE(new_tabla.ind_falt,
                                          1,
                                          1,
                                          DECODE(new_tabla.ind_nmp,
                                                 1,
                                                 1,
                                                 DECODE(new_tabla.ind_pedi_serv,
                                                        1,
                                                        1,
                                                        0),
                                                 0))))),
                   1,
                   1,
                   0) flagReclamos,
            DECODE(SIGN(SUM(DECODE(new_tabla.ind_prem, 1, 1, 0))), 1, 1, 0) flagCDRPremios,
            DECODE(SIGN(SUM(DECODE(reo.cod_esta_oper, psEstadoOperacion, 1, 0))), 1, 1, 0) flagCDRRechazados
       FROM mae_clien         mc,
            rec_solic_opera   rso,
            ped_solic_cabec   psc,
            rec_opera_recla   ror,
            rec_estad_opera   reo,
            seg_modul         sm,
            int_dat_param_cdr new_tabla
      WHERE psc.modu_oid_modu = sm.oid_modu
        AND sm.cod_modu = psCodigoModulo
        AND psc.pais_oid_pais = vnIdPais
        AND psc.perd_oid_peri = vnIdPeriodo
        AND psc.fec_fact IS NOT NULL
        AND psc.fec_fact =DECODE(psFechaFacturacion,'',psc.fec_fact,NULL,psc.fec_fact,TO_DATE(psFechaFacturacion,'DD/MM/YYYY'))
        AND psc.clie_oid_clie = mc.oid_clie
        AND psc.oid_soli_cabe = rso.soca_oid_soli_cabe
        AND rso.opre_oid_oper_recl = ror.oid_oper_recl
        AND ror.esop_oid_esta_oper = reo.oid_esta_oper
        AND new_tabla.oid_tipo_soli_pais = rso.tspa_oid_tipo_soli_pais
      GROUP BY mc.cod_clie;

   TYPE interfazRec IS RECORD
   (
   codigoEbelista             mae_clien.cod_clie%TYPE,
   codigoPeriodo              seg_perio_corpo.cod_peri%TYPE,
   flagCambios            VARCHAR2(1),
   flagCanjes             VARCHAR2(1),
   flagDevoluciones          VARCHAR2(1),
   flagReclamos             VARCHAR2(1),
   flagCDRPremios          VARCHAR2(1),
   flagCDRRechazados          VARCHAR2(1)
   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lnIdPeriodo         NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN

   /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);-- id del Periodo consultante

   /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdPeriodo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoEbelista ||';'||
                              interfazRecord(x).codigoPeriodo ||';'||
                              interfazRecord(x).flagCambios ||';'||
                              interfazRecord(x).flagCanjes ||';'||
                              interfazRecord(x).flagDevoluciones ||';'||
                              interfazRecord(x).flagReclamos ||';'||
                              interfazRecord(x).flagCDRPremios ||';'||
                              interfazRecord(x).flagCDRRechazados;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ESTAD_CDRS_CONSU: '||ls_sqlerrm);
END INT_PR_DAT_ESTAD_CDRS_CONSU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Tipos de Documento para Pedidos
Fecha Creacion    : 10/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_TIPOS_DOCUM_PEDID
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2)
IS
   CURSOR c_interfaz IS
   SELECT td.cod_tipo_docum codigoDocumento,
          td.des_tipo_docum descripcionDocumento
     FROM int_dat_tipo_docum td;
   TYPE interfazRec IS RECORD
   (
   codigoDocumento         SEG_CANAL.COD_CANA%TYPE,
   descripcionDocumento   GEN_I18N_SICC_COMUN.VAL_I18N%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoDocumento            ||';'||
                              interfazRecord(x).descripcionDocumento;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_TIPOS_DOCUM_PEDID: '||ls_sqlerrm);
END INT_PR_DAT_TIPOS_DOCUM_PEDID;

/***************************************************************************
Descripcion       : Devuelve el Tipo de Cobertura (1) Areas (0)NACIONAL
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_TIPO_COBER(
   pnOidParametro  NUMBER
)
RETURN NUMBER
IS
  lnTipoCobertura NUMBER;
BEGIN

  lnTipoCobertura:=0;
  SELECT 1
    INTO lnTipoCobertura
    FROM inc_ambit_geogr
   WHERE copa_oid_para_gral = pnOidParametro;

  RETURN lnTipoCobertura;

EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN TOO_MANY_ROWS THEN
      RETURN 1;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_DESCR_TIPO_COBER: '||ls_sqlerrm);
END INT_FN_DEVUE_TIPO_COBER;

/***************************************************************************
Descripcion       : Devuelve el Tipo de Exigencia de Niveles
                   (M) Marca
                   (P) Producto
                   (N) No tiene
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_TIPO_EXIG_NIVEL(
   pnOidParametro  NUMBER
)
RETURN VARCHAR2
IS
  lnTipoExigencia NUMBER;

BEGIN

  lnTipoExigencia:=0;

  SELECT COUNT(DISTINCT mapr_oid_marc_prod)
    INTO lnTipoExigencia
    FROM inc_produ_exigi_premi
   WHERE repr_oid_requ_prem = pnOidParametro;

  IF  lnTipoExigencia>0 THEN RETURN 'M';
  ELSE
     SELECT COUNT(DISTINCT prod_oid_prod)
      INTO lnTipoExigencia
      FROM inc_produ_exigi_premi
     WHERE repr_oid_requ_prem = pnOidParametro;

     IF  lnTipoExigencia>0 THEN RETURN 'P';
         ELSE RETURN 'N';
     END IF;
  END IF;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_TIPO_EXIG_NIVEL: '||ls_sqlerrm);
END INT_FN_DEVUE_TIPO_EXIG_NIVEL;



/***************************************************************************
Descripcion       : Devuelve el Porcentaje Adicional de Cuota
Fecha Creacion    : 12/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PORCE_ADICI_CUOTA(
   pnOidParametro  NUMBER
)
RETURN NUMBER
IS
  lnPorcentajeAdicional inc_rango.val_incr%TYPE;
BEGIN

  lnPorcentajeAdicional:=0;
  SELECT val_incr
    INTO lnPorcentajeAdicional
    FROM inc_rango
   WHERE copa_oid_para_gral = pnOidParametro;

  RETURN lnPorcentajeAdicional;

EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PORCE_ADICI_CUOTA: '||ls_sqlerrm);
END INT_FN_DEVUE_PORCE_ADICI_CUOTA;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Concursos
Fecha Creacion    : 12/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_CONCU
  ( psCodigoPais        VARCHAR2,
    psCodigoSistema     VARCHAR2,
    psCodigoInterfaz    VARCHAR2,
    psNombreArchivo     VARCHAR2,
    psCodiIso           VARCHAR2,
    psCodigoMarca       VARCHAR2,
    psCodigoCanal       VARCHAR2,
    psCodigoPeriodo     VARCHAR2,
    psCodigoAcceso      VARCHAR2
   )
IS
    lsIndAcumInact      NUMBER:=1;
    lsIndVentCata       NUMBER:=3;
    lsIndVentFact       NUMBER:=2;
    lsIndVentNeta       NUMBER:=1;
    lsIndUnidVend       NUMBER:=2;
    lsIndAcumRecom      NUMBER:=4;
    lsIndFactRecom      NUMBER:=4;

    /* Constantes usadas para obtener la informacion */
   lnFlagActivo     NUMBER :=1;
   lnFlagInactivo   NUMBER :=0;

   CURSOR c_interfaz (vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER)IS
     SELECT cpg.num_conc codigoConcurso,
            SUBSTR(sp.cod_pais, 1, 2) codigoPais,
            SUBSTR(gen_pkg_gener.gen_fn_devuelve_descripcion(cpg.pais_oid_pais,
                                                             'PAIS',
                                                             psCodiIso),
                   1,
                   15) descripcionPais,

            int_pkg_datam.INT_FN_DEVUE_CONCU_DIRIG(cpg.oid_para_gral) flagDirigido,

            int_pkg_datam.INT_FN_DEVUE_TIPO_CONCU_AGRUP1(cpg.oid_para_gral) tipoObjetivo,

            int_pkg_datam.INT_FN_DEVUE_TIPO_CONCU_AGRUP2(cpg.oid_para_gral) flagTipoConcurso,


            SUBSTR(cpg.val_nomb, 1, 30) descripcionConcurso,
            int_pkg_datam.INT_FN_DEVUE_CONCU_ESTAD(cpg.oid_para_gral)  flagTipoEstadoConcurso,

            pgp.num_nive numeroNivelConcurso,
            ven_pkg_repor.ven_fn_devue_nume_campa(gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_desd),
                                                  gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_hast),
                                                  vnIdPais,
                                                  vnIdMarca,
                                                  vnIdCanal) numeroMaximoPeriodos,
            pgp.num_rota numeroRotacionPremiosNivel,
            DECODE(pgp.val_hast_nive,NULL,0,pgp.val_hast_nive) numeroNivelesAcumularanPremios,
            DECODE(int_pkg_datam.int_fn_devue_porce_adici_cuota(cpg.oid_para_gral),NULL,0,
                  int_pkg_datam.int_fn_devue_porce_adici_cuota(cpg.oid_para_gral)) porcentajeAdicionalCuota,
            irp.ind_pago_tiem flagControlMorosidad,
            pgp.ind_prem_elec flagConcursoEleccionPremios,
            pgp.ind_prem_acum_nive flagAcumulacionPremiosNiveles,
            DECODE(pgp.ind_prem_elec,
                   lsIndAcumInact,
                   lnFlagInactivo,
                   lnFlagActivo) flagAcumulacionPremiosNivel,
            pgp.ind_nive_rota flagRotacionPremiosNiveles,

            int_pkg_datam.INT_FN_DEVUE_TIPO_EFECT(cpg.oid_para_gral)  flagTipoEfectividad,
            '' flagCalculoVentaCatalogo,
            '' flagCalculoVentaFacturacion,
            '' flagCalculoVentaNeta,
            DECODE(cpg.bcal_oid_base_calc,
                   lsIndUnidVend,
                   lnFlagActivo,
                   lnFlagInactivo) flagCalculoUnidadesVendidas,
            cpg.ind_devo flagCalculoUnidadesDevueltas,
            cpg.ind_anul flagCalculoUnidadesAnuladas,
            cpg.val_falt_nanu flagCalculoUnidadesFaltantes,
            0 ventaPromedio,
            '' montoMinimoPedido,
            '' numeroMinimoPedidos,
            '' numeroMinimoPedidosRecomienda,
            '' numeroUnidadesMinimaPedido,
            gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_desd) PeriodoInicio,
            gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_hast) PeriodoFin,
            DECODE(pgp.ind_peri_desp_exig,
                   1,
                   gen_pkg_gener.gen_fn_devuelve_des_perio(pgp.perd_oid_peri),
                   ''
                   ) PeriodoEntregaPremios,
            '' PeriodoInicioCalculoPuntaje,
            '' PeriodoFinCalculoPuntaje,

            per_pkg_repor_perce.per_fn_obtie_perio(gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_desd),
                                                   vnIdPais,
                                                   vnIdMarca,
                                                   vnIdCanal,
                                                   -1) PeriodoGeneracionMaestroCuotas,
            DECODE(pgp.ind_peri_desp_exig,
                   1,
                   gen_pkg_gener.gen_fn_devuelve_des_perio(pgp.perd_oid_peri),
                   gen_pkg_gener.gen_fn_devuelve_perio_actu(vnIdPais,
                                                            psCodigoMarca,
                                                            vnIdCanal) -- < PARAMETRO_Periodo_ACTUAL >
                   ) PeriodoUltImoSolicitudPremios,
            '' PeriodoInicioEvaluacion,
            '' PeriodoFinEvaluacion,
            '' flagNumeroPedidosNivel,
            '' flagAcumulacionRecomendadas,
            '' factorRecomendadas,

            0 numeroPeriodosConfirma,
            DECODE(irp.val_cuot_ingr,null,0,irp.val_cuot_ingr) montoMinimoCuotaEbelistas,
            0 flagNivelEspecial,
            int_pkg_datam.INT_FN_DEVUE_CONCU_UNIDA_MEDID(cpg.oid_para_gral) unidadCalculoPuntaje,
            '' factorUnidadPuntaje,
            cpg.oid_para_gral oidParamGeneral,
            cpg.bcal_oid_base_calc oidBaseCalculo,
            DECODE(pgp.perd_oid_peri_inic,null,
              DECODE(pgp.perd_oid_peri,null,
                     '',gen_pkg_gener.gen_fn_devuelve_des_perio(pgp.perd_oid_peri)),
              gen_pkg_gener.gen_fn_devuelve_des_perio(pgp.perd_oid_peri_inic)) campEntPremIni

       FROM inc_concu_param_gener cpg,
            seg_pais              sp,
            seg_marca             sm,
            seg_canal             sc,
            inc_param_gener_premi pgp,
                  int_dat_inc_concu_proce icp,
            inc_requi_premi irp
      WHERE cpg.pais_oid_pais = vnIdPais --<parametro_pais>
        AND cpg.marc_oid_marc = vnIdMarca --<parametro_marca>
        AND cpg.cana_oid_cana = vnIdCanal --<parametro_canal>
        AND cpg.pais_oid_pais = sp.oid_pais
        AND cpg.marc_oid_marc = sm.oid_marc
        AND cpg.cana_oid_cana = sc.oid_cana
        AND pgp.copa_oid_para_gral = cpg.oid_para_gral
        AND cpg.oid_para_gral = icp.copa_oid_para_gral
        AND cpg.oid_para_gral = irp.copa_oid_para_gral(+);

   TYPE interfazRec IS RECORD
   (
   codigoConcurso                   INC_CONCU_PARAM_GENER.NUM_CONC%TYPE,
   codigoPais                       SEG_PAIS.COD_PAIS%TYPE,
   descripcionPais                  VARCHAR2(15),
   flagDirigido                     INT_DAT_INC_DIRIG.COD_DIRI%TYPE,
   tipoObjetivo                     INT_DAT_INC_AGRU1.COD_AGRU%TYPE,
   flagTipoConcurso                 inc_clasi_concu.cod_clas_conc%TYPE,


   descripcionConcurso              VARCHAR2(30),
   flagTipoEstadoConcurso           INT_DAT_INC_ESTAD.COD_ESTA%TYPE,

   numeroNivelConcurso              INC_PARAM_GENER_PREMI.NUM_NIVE%TYPE,
   numeroMaximoPeriodos             NUMBER(4),
   numeroRotacionPremiosNivel       INC_PARAM_GENER_PREMI.NUM_ROTA%TYPE,
   numeroNivelesAcumularanPremios   INC_PARAM_GENER_PREMI.VAL_HAST_NIVE%TYPE,
   porcentajeAdicionalCuota         INC_RANGO.VAL_INCR%TYPE,
   flagControlMorosidad             VARCHAR2(1),
   flagConcursoEleccionPremios      INC_PARAM_GENER_PREMI.IND_PREM_ELEC%TYPE,
   flagAcumulacionPremiosNiveles    INC_PARAM_GENER_PREMI.IND_PREM_ACUM_NIVE%TYPE,
   flagAcumulacionPremiosNivel      NUMBER,
   flagRotacionPremiosNiveles       INC_PARAM_GENER_PREMI.IND_NIVE_ROTA%TYPE,

   flagTipoEfectividad             INT_DAT_INC_TIPO_EFECT.COD_TIPO_EFEC%TYPE,
   flagCalculoVentaCatalogo         VARCHAR2(1),
   flagCalculoVentaFacturacion      VARCHAR2(1),
   flagCalculoVentaNeta             VARCHAR2(1),
   flagCalculoUnidadesVendidas      NUMBER,
   flagCalculoUnidadesDevueltas     INC_CONCU_PARAM_GENER.IND_DEVO%TYPE,
   flagCalculoUnidadesAnuladas      INC_CONCU_PARAM_GENER.IND_ANUL%TYPE,
   flagCalculoUnidadesFaltantes     INC_CONCU_PARAM_GENER.VAL_FALT_NANU%TYPE,
   ventaPromedio                    NUMBER,
   montoMinimoPedido                inc_concu_param_consu.imp_mont_mini_pedi%TYPE,
   numeroMinimoPedidos              inc_concu_param_consu.num_mini_pedi%TYPE,
   numeroMinimoPedidosRecomienda    inc_concu_param_consu.num_mini_pedi_reco%TYPE,
   numeroUnidadesMinimaPedido       inc_concu_param_consu.num_unid_mini_pedi%TYPE,
   PeriodoInicio                    SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoFin                       SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoEntregaPremios            SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoInicioCalculoPuntaje      SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoFinCalculoPuntaje         SEG_PERIO_CORPO.COD_PERI%TYPE,

   PeriodoGeneracionMaestroCuotas   SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoUltImoSolicitudPremios    SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoInicioEvaluacion          SEG_PERIO_CORPO.COD_PERI%TYPE,
   PeriodoFinEvaluacion             SEG_PERIO_CORPO.COD_PERI%TYPE,
   flagNumeroPedidosNivel           VARCHAR2(1),
   flagAcumulacionRecomendadas      VARCHAR2(1),
   factorRecomendadas               VARCHAR2(5),

   numeroPeriodosConfirma           NUMBER,
   montoMinimoCuotaEbelistas        inc_requi_premi.val_cuot_ingr%TYPE,
   flagNivelEspecial                NUMBER,
   unidadCalculoPuntaje             INT_DAT_INC_UNIDA_MEDID.COD_TIPO_UNID_MEDI%TYPE,
   factorUnidadPuntaje              VARCHAR2(5),
   oidParamGeneral                  INC_CONCU_PARAM_GENER.OID_PARA_GRAL%TYPE,
   oidBaseCalculo                   INC_CONCU_PARAM_GENER.BCAL_OID_BASE_CALC%TYPE,
   campEntPremIni                   SEG_PERIO_CORPO.COD_PERI%TYPE
   );



   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(3000);

  lsNombreArchivo     VARCHAR2(50);

  lnIdPais            NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lnIdPeriodo         NUMBER;

  lbAbrirUtlFile      BOOLEAN;

BEGIN
     /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio(psCodigoPeriodo,lnIdMarca,lnIdCanal);-- id del Periodo consultante

    /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                         --Recupera datos de conversion
                        BEGIN
                    SELECT
                           DECODE(interfazRecord(x) .oidBaseCalculo,
                                  lsIndAcumRecom,
                                  iop.val_punt_acum,
                                  0),
                           DECODE(interfazRecord(x) .oidBaseCalculo,
                                  lsIndFactRecom,
                                  iop.val_fact_conv,
                                  0),
                           iop.val_fact_conv
                      INTO
                           interfazRecord(x) .flagAcumulacionRecomendadas,
                           interfazRecord(x) .factorRecomendadas,
                           interfazRecord(x) .factorUnidadPuntaje
                      FROM inc_obten_punto iop
                     WHERE iop.copa_oid_para_gral = interfazRecord(x).oidParamGeneral;
                           EXCEPTION
                     WHEN no_data_found THEN
                         interfazRecord(x) .flagAcumulacionRecomendadas:=NULL;
                         interfazRecord(x) .factorRecomendadas:=NULL;
                         interfazRecord(x) .factorUnidadPuntaje:=NULL;

                          END;
                   /*Obteniendo valores de ipc: flagCalculoVentaCatalogo,
                                                flagCalculoVentaFacturacion,
                                                flagCalculoVentaCatalogo,
                                                flagCalculoVentaCatalogo,
                                                flagCalculoVentaNeta,
                                                PeriodoInicioCalculoPuntaje,
                                                PeriodoFinCalculoPuntaje
                   */
                  -- Recupera datos del concurso incremental
                  BEGIN
                  SELECT DECODE(ipc.tven_oid_tipo_vent,
                                lsIndVentCata,
                                lnFlagActivo,
                                lnFlagInactivo),
                         DECODE(ipc.tven_oid_tipo_vent,
                                lsIndVentFact,
                                lnFlagActivo,
                                lnFlagInactivo),
                         DECODE(ipc.tven_oid_tipo_vent,
                                lsIndVentNeta,
                                lnFlagActivo,
                                lnFlagInactivo),
                         DECODE(ipc.perd_oid_peri_desd,
                                NULL,
                                NULL,
                                gen_pkg_gener.gen_fn_devuelve_des_perio(ipc.perd_oid_peri_desd)),

                         DECODE(ipc.perd_oid_peri_hast,
                                NULL,
                                NULL,
                                gen_pkg_gener.gen_fn_devuelve_des_perio(ipc.perd_oid_peri_hast))
                    INTO interfazRecord(x) .flagCalculoVentaCatalogo,
                         interfazRecord(x) .flagCalculoVentaFacturacion,
                         interfazRecord(x) .flagCalculoVentaNeta,
                         interfazRecord(x) .PeriodoInicioCalculoPuntaje,
                         interfazRecord(x) .PeriodoFinCalculoPuntaje

                    FROM inc_param_calif ipc
                   WHERE ipc.copa_oid_para_gral = interfazRecord(x).oidParamGeneral;
                   EXCEPTION
                     WHEN no_data_found THEN
                         interfazRecord(x) .flagCalculoVentaCatalogo:=0;
                         interfazRecord(x) .flagCalculoVentaFacturacion:=0;
                         interfazRecord(x) .flagCalculoVentaNeta:=0;
                         interfazRecord(x) .PeriodoInicioCalculoPuntaje:=NULL;
                         interfazRecord(x) .PeriodoFinCalculoPuntaje:=NULL;
                   END;
                    /*Obteniendo valores de ipc: montoMinimoPedido,
                                                 numeroMinimoPedidos,
                                                 numeroMinimoPedidosRecomienda,
                                                 numeroUnidadesMinimaPedido,
                                                 PeriodoInicioEvaluacion,
                                                 PeriodoFinEvaluacion,
                                                 flagNumeroPedidosNivel
                    */
                    -- Recupera datos del concurso de recomendacion
                      BEGIN
                      SELECT cpc.imp_mont_mini_pedi,
                             cpc.num_mini_pedi,
                             cpc.num_mini_pedi_reco,
                             cpc.num_unid_mini_pedi,
                             DECODE(cpc.perd_oid_peri_inic_eval,
                                    NULL,
                                    NULL,
                                    gen_pkg_gener.gen_fn_devuelve_des_perio(cpc.perd_oid_peri_inic_eval)),
                             DECODE(cpc.perd_oid_peri_inic_eval,
                                    NULL,
                                    NULL,
                                              DECODE(ind_peri_desp_exig,1,
                                                     gen_pkg_gener.gen_fn_devuelve_des_perio(cpc.perd_oid_peri_inic_eval),
                                                     per_pkg_repor_perce.per_fn_obtie_perio(gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_hast),
                                                                                                                                     lnIdPais,
                                                                                                                                     lnIdMarca,
                                                                                                                                     lnIdCanal,
                                                                                                                                     1))),
                             DECODE(SIGN(cpc.num_mini_pedi),
                                    1,
                                    lnFlagActivo,
                                    lnFlagInactivo)
                        INTO interfazRecord(x) .montoMinimoPedido,
                             interfazRecord(x) .numeroMinimoPedidos,
                             interfazRecord(x) .numeroMinimoPedidosRecomienda,
                             interfazRecord(x) .numeroUnidadesMinimaPedido,
                             interfazRecord(x) .PeriodoInicioEvaluacion,
                             interfazRecord(x) .PeriodoFinEvaluacion,
                             interfazRecord(x) .flagNumeroPedidosNivel
                                  FROM inc_concu_param_consu cpc,
                                       inc_param_gener_premi pgp,
                                       inc_concu_param_gener cpg
                                 WHERE cpc.copa_oid_para_gral = interfazRecord(x).oidParamGeneral
                                 and cpc.copa_oid_para_gral = pgp.copa_oid_para_gral
                                 and cpc.copa_oid_para_gral = cpg.oid_para_gral;

                       EXCEPTION
                       WHEN no_data_found THEN
                         interfazRecord(x) .montoMinimoPedido := 0;
                         interfazRecord(x) .numeroMinimoPedidos := 0;
                            interfazRecord(x) .numeroMinimoPedidosRecomienda:=0;
                         interfazRecord(x) .numeroUnidadesMinimaPedido:=0;
                         interfazRecord(x) .PeriodoInicioEvaluacion:=NULL;
                             interfazRecord(x) .PeriodoFinEvaluacion:=NULL;
                             interfazRecord(x) .flagNumeroPedidosNivel:=NULL;
                       END;

                                     /*Escribiendo en archivo*/
                  lsLinea :=  interfazRecord(x).codigoConcurso                ||';'||
                              interfazRecord(x).codigoPais                    ||';'||
                              interfazRecord(x).descripcionPais               ||';'||

                              interfazRecord(x).flagDirigido                  ||';'||

                              interfazRecord(x).tipoObjetivo                  ||';'||

                              interfazRecord(x).flagTipoConcurso              ||';'||


                              interfazRecord(x).descripcionConcurso           ||';'||
                              interfazRecord(x).flagTipoEstadoConcurso        ||';'||

                              interfazRecord(x).numeroNivelConcurso           ||';'||
                              interfazRecord(x).numeroMaximoPeriodos          ||';'||
                              interfazRecord(x).numeroRotacionPremiosNivel    ||';'||
                              interfazRecord(x).numeroNivelesAcumularanPremios||';'||
                              interfazRecord(x).porcentajeAdicionalCuota      ||';'||
                              interfazRecord(x).flagControlMorosidad          ||';'||
                              interfazRecord(x).flagConcursoEleccionPremios   ||';'||
                              interfazRecord(x).flagAcumulacionPremiosNiveles ||';'||
                              interfazRecord(x).flagAcumulacionPremiosNivel   ||';'||
                              interfazRecord(x).flagRotacionPremiosNiveles    ||';'||

                              interfazRecord(x).flagTipoEfectividad           ||';'||
                              interfazRecord(x).flagCalculoVentaCatalogo      ||';'||
                              interfazRecord(x).flagCalculoVentaFacturacion   ||';'||
                              interfazRecord(x).flagCalculoVentaNeta          ||';'||
                              interfazRecord(x).flagCalculoUnidadesVendidas   ||';'||
                              interfazRecord(x).flagCalculoUnidadesDevueltas  ||';'||
                              interfazRecord(x).flagCalculoUnidadesAnuladas   ||';'||
                              interfazRecord(x).flagCalculoUnidadesFaltantes  ||';'||
                              interfazRecord(x).ventaPromedio                 ||';'||
                              interfazRecord(x).montoMinimoPedido             ||';'||
                              interfazRecord(x).numeroMinimoPedidos           ||';'||
                              interfazRecord(x).numeroMinimoPedidosRecomienda ||';'||
                              interfazRecord(x).numeroUnidadesMinimaPedido    ||';'||
                              interfazRecord(x).PeriodoInicio                 ||';'||
                              interfazRecord(x).PeriodoFin                    ||';'||
                              interfazRecord(x).PeriodoEntregaPremios         ||';'||
                              interfazRecord(x).PeriodoInicioCalculoPuntaje   ||';'||
                              interfazRecord(x).PeriodoFinCalculoPuntaje      ||';'||

                              interfazRecord(x).PeriodoGeneracionMaestroCuotas||';'||
                              interfazRecord(x).PeriodoUltImoSolicitudPremios ||';'||
                              interfazRecord(x).PeriodoInicioEvaluacion       ||';'||
                              interfazRecord(x).PeriodoFinEvaluacion          ||';'||
                              interfazRecord(x).flagNumeroPedidosNivel        ||';'||
                              interfazRecord(x).flagAcumulacionRecomendadas   ||';'||
                              interfazRecord(x).factorRecomendadas            ||';'||

                              interfazRecord(x).numeroPeriodosConfirma        ||';'||
                              interfazRecord(x).montoMinimoCuotaEbelistas     ||';'||

                              interfazRecord(x).flagNivelEspecial             ||';'||
                              interfazRecord(x).unidadCalculoPuntaje          ||';'||
                              interfazRecord(x).factorUnidadPuntaje           ||';'||
                              interfazRecord(x).campEntPremIni;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

      /* Procedimiento final para generar interfaz */
      GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_CONCU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Ventas por Seccion y Periodo
                    y Producto ( DAT-74 )
Fecha Creacion    : 05/12/2007
Autor             : Jose A. Cairampoma
Actualizado       : 12.09.11 Carlos Mori
                    06.08.15 Carlos Mori
***************************************************************************/
PROCEDURE INT_PR_DAT_VENTA_SECCI_PERIO (
                                         psCodigoPais     VARCHAR2,
                                         psCodigoSistema  VARCHAR2,
                                         psCodigoInterfaz VARCHAR2,
                                         psNombreArchivo  VARCHAR2,
                                         psCodigoMarca    VARCHAR2,
                                         psCodigoCanal    VARCHAR2,
                                         psCodigoPeriodo  VARCHAR2
                                       )
IS

CURSOR c_interfaz( vsIndTipoFVP NUMBER ) IS

SELECT ( SELECT cod_cana FROM SEG_CANAL WHERE oid_cana = base.cana_oid_cana ) codigoCanal,
       base.cod_peri codigoPeriodo,
       base.cod_zona codigoZona,
       base.cod_secc codigoSeccion,
       base.num_orde numOrdenes,
       base.num_clie numClientes,
       base.num_acti_fina numTotalActivasREAL,
       base.num_acti_inic numActivasInicialesREAL,
       base.num_ingr numIngresosREAL,
       base.num_egre numEgresosREAL,
       base.num_rein numReingresosREAL,
       base.num_rezo_reci numRecibidasREAL,
       base.num_rezo_entr numEntregadasREAL,
       base.num_pedi numTotalPedidosREAL,
       esec.num_unid numUnidVendidasESTI,
       esec.val_vene montoVentaNetaESTI,
       esec.num_pedi numPedidosESTI,
       esec.num_clie numClientesESTI,
       esec.num_acfi numActivasESTI,
       esec.num_ingr numIngresosESTI,
       esec.num_egpu numEgresosESTI,
       esec.num_rein numReingresosESTI,
       esec.val_posi_egre_cam_ant numPEGcmpAnteESTI,
       0 numObjetivoPedidosREAL, -- debe ir en cero segun especificacion de DAT
       0 numObjetivoActivasREAL, -- debe ir en cero segun especificacion de DAT
       obpe.num_pedi_obje_fina numObjetivoPediBaseREAL,
       NULL montoTCPromedioREAL,  -- debe ir sin valor segun especificacion de DAT
       NULL montoTCPromedioESTI,
       esec.Val_Rete_2ped numRet2doPediESTI,
       esec.Val_Rete_3ped numRet3erPediESTI,
       esec.Val_Rete_4ped numRet4toPediESTI,
       esec.Val_Rete_Acti numRetActC18ESTI,
       esec.Val_Porc_Rota valPorcRotaESTI,
       esec.Val_Posi_Egre numPosiEgreESTI,
       esec.Val_Porc_Rete_Posi_Egre numRetePosiEgreESTI,
       esec.Por_Egpu valPorcEgreESTI
  FROM (
        SELECT orig.cod_peri,
               zorg.cod_regi,
               zzon.cod_zona,
               zscc.cod_secc,
               SUM(NVL(fvrl.num_acti_inic,0)) num_acti_inic,
               SUM(NVL(fvrl.num_acti_fina,0)) num_acti_fina,
               SUM(NVL(fvrl.num_ingr,0)) num_ingr,
               SUM(NVL(fvrl.num_rein,0)) num_rein,
               SUM(NVL(fvrl.num_egre,0)) num_egre,
               SUM(NVL(fvrl.num_rezo_reci,0)) num_rezo_reci,
               SUM(NVL(fvrl.num_rezo_entr,0)) num_rezo_entr,
               SUM(NVL(fvra.num_orde,0)) num_orde,
               SUM(NVL(fvra.num_clie,0)) num_clie,
               SUM(NVL(fvra.num_pedi,0)) num_pedi,
               orig.oid_peri,
               zorg.oid_regi,
               zzon.oid_zona,
               zscc.oid_secc,
               orig.pais_oid_pais,
               orig.cana_oid_cana
          FROM (
                SELECT prds.cod_peri,
                       prds.oid_peri,
                       ztad.zscc_oid_secc,
                       ztad.terr_oid_terr,
                       ztad.pais_oid_pais,
                       ztad.cana_oid_cana
                  FROM zon_terri_admin ztad,
                       (
                        SELECT DISTINCT
                               peri.cod_peri,
                               perd.oid_peri
                          FROM INT_SAB_VENTA_PREVI_ZONA prev,
                               CRA_PERIO perd,
                               SEG_PERIO_CORPO peri
                         WHERE perd.peri_oid_peri = peri.oid_peri
                           AND peri.cod_peri = prev.cod_peri
                           AND prev.cod_peri >= psCodigoPeriodo
                       ) prds
                 WHERE 1=1
                   AND prds.oid_peri BETWEEN nvl(ztad.perd_oid_peri_inic,prds.oid_peri) AND
                                             NVL(ztad.perd_oid_peri_fina,prds.oid_peri)
               ) orig,
               zon_secci zscc,
               zon_zona  zzon,
               zon_regio zorg,
               int_fuent_ventas_real fvrl,
               int_fuent_venta_real_vacum fvra
         WHERE 1=1
           AND orig.zscc_oid_secc = zscc.oid_secc
           AND zscc.zzon_oid_zona = zzon.oid_zona
           AND zzon.zorg_oid_regi = zorg.oid_regi
           AND orig.oid_peri = fvrl.perd_oid_peri(+)
           AND orig.terr_oid_terr = fvrl.terr_oid_terr(+)
           AND orig.oid_peri = fvra.perd_oid_peri(+)
           AND orig.terr_oid_terr = fvra.terr_oid_terr(+)
         GROUP BY orig.cod_peri,
                  zorg.cod_regi,
                  zzon.cod_zona,
                  zscc.cod_secc,
                  orig.oid_peri,
                  zorg.oid_regi,
                  zzon.oid_zona,
                  zscc.oid_secc,
                  orig.pais_oid_pais,
                  orig.cana_oid_cana
       ) base, -- Base calculada
       (
        SELECT b.pais_cod_pais,
               b.cod_peri,
               b.cod_regi,
               b.Cod_Zona,
               b.Cod_Secc,
               b.num_ingr,
               b.num_egpu,
               b.num_rein,
               b.num_unid,
               b.val_vene,
               b.num_pedi,
               b.num_clie,
               b.num_acfi,
               b.val_posi_egre_cam_ant,
               b.Val_Rete_2ped,
               b.Val_Rete_3ped,
               b.Val_Rete_4ped,
               b.Val_Rete_Acti,
               b.Val_Porc_Rota,
               b.Val_Posi_Egre,
               b.Val_Porc_Rete_Posi_Egre,
               b.Por_Egpu
          FROM INT_SAB_VENTA_PREVI_SECCI b
         WHERE b.cod_peri >= psCodigoPeriodo
       ) esec,
       (
        SELECT a.lpro_cod_pais cod_pais,
               a.cam_obje cod_peri,
               a.cod_regi,
               a.cod_zona,
               a.cod_secc,
               a.num_pedi_obje_fina
          FROM LEC_LIDER_SECCI_OBJET_PEDID a
         WHERE a.Cam_Obje >= psCodigoPeriodo
       ) obpe
 WHERE base.cod_peri = esec.cod_peri(+)
   AND base.cod_regi = esec.cod_regi(+)
   AND base.cod_zona = esec.cod_zona(+)
   AND base.cod_secc = esec.cod_secc(+)
   --
   AND base.cod_peri = obpe.cod_peri(+)
   AND base.cod_regi = obpe.cod_regi(+)
   AND base.cod_zona = obpe.cod_zona(+)
   AND base.cod_secc = obpe.cod_secc(+)
 ORDER BY 2,3,4

     ;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables de Trabajo
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_handle        UTL_FILE.FILE_TYPE;
lsLinea         VARCHAR2(1000);
lsNombreArchivo VARCHAR2(50);
lnIdPais        SEG_PAIS.OID_PAIS%TYPE;
lnIdMarca       SEG_MARCA.OID_MARC%TYPE;
lnIdCanal       SEG_CANAL.OID_CANA%TYPE;
lnIdPeriodo     CRA_PERIO.OID_PERI%TYPE;
lbAbrirUtlFile  BOOLEAN;
lsIndTipoFVP    BAS_PARAM_PAIS.VAL_PARA%TYPE;

BEGIN
   -- Obtener OID de variables requeridas
   lnIdPais    := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca   := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal   := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);-- id del Periodo consultante

   BEGIN
       SELECT VAL_PARA
         INTO lsIndTipoFVP
         FROM BAS_PARAM_PAIS
        WHERE COD_PAIS = pscodigoPais
          AND COD_SIST = 'FVP'
          AND UPPER(NOM_PARA) = 'INDTIPOFVP'
          AND IND_ACTI = '1';
   EXCEPTION WHEN NO_DATA_FOUND THEN
       lsIndTipoFVP := '2';
   END;
   -- Generando Archivo de Texto (Detalle)
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz( lsIndTipoFVP );
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
               psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

                  lsLinea :=  interfazRecord(x).codigoCanal                 ||';'||
                              interfazRecord(x).codigoPeriodo               ||';'||
                              interfazRecord(x).codigoZona                  ||';'||
                              interfazRecord(x).codigoSeccion               ||';'||
                              interfazRecord(x).numOrdenes                  ||';'||
                              interfazRecord(x).numClientes                 ||';'||
                              interfazRecord(x).numTotalActivasREAL         ||';'||
                              interfazRecord(x).numActivasInicialesREAL     ||';'||
                              interfazRecord(x).numIngresosREAL             ||';'||
                              interfazRecord(x).numEgresosREAL              ||';'||
                              interfazRecord(x).numReingresosREAL           ||';'||
                              interfazRecord(x).numRecibidasREAL            ||';'||
                              interfazRecord(x).numEntregadasREAL           ||';'||
                              interfazRecord(x).numTotalPedidosREAL         ||';'||
                              interfazRecord(x).numUnidVendidasESTI         ||';'||
                              interfazRecord(x).montoVentaNetaESTI          ||';'||
                              interfazRecord(x).numPedidosESTI              ||';'||
                              interfazRecord(x).numClientesESTI             ||';'||
                              interfazRecord(x).numActivasESTI              ||';'||
                              interfazRecord(x).numIngresosESTI             ||';'||
                              interfazRecord(x).numEgresosESTI              ||';'||
                              interfazRecord(x).numReingresosESTI           ||';'||
                              interfazRecord(x).numPEGcmpAnteESTI           ||';'||
                              interfazRecord(x).numObjetivoPedidosREAL      ||';'||
                              interfazRecord(x).numObjetivoActivasREAL      ||';'||
                              interfazRecord(x).numObjetivoPediBaseREAL     ||';'||
                              interfazRecord(x).montoTCPromedioREAL         ||';'||
                              interfazRecord(x).montoTCPromedioESTI         ||';'||
                              interfazRecord(x).numRet2doPediESTI           ||';'||
                              interfazRecord(x).numRet3erPediESTI           ||';'||
                              interfazRecord(x).numRet4toPediESTI           ||';'||
                              TRIM( TO_CHAR( NVL( interfazRecord(x).numRetActC18ESTI,0 ),'999999990.99') )      ||';'||
                              interfazRecord(x).valPorcRotaESTI             ||';'||
                              interfazRecord(x).numPosiEgreESTI             ||';'||
                              TRIM( TO_CHAR( NVL( interfazrecord(x).numRetePosiEgreESTI,0 ),'999999990.99') )   ||';'||
                              TRIM( TO_CHAR( NVL( interfazrecord(x).valPorcEgreESTI,0 ),'999999990.99') )
                              ;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;
     CLOSE c_interfaz;

     IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
     END IF;
     RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_SALDOS_PROME_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_VENTA_SECCI_PERIO;

/***************************************************************************
Descripcion       : Devuelve Listado  de Estimados
Fecha Creacion    : 23/02/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
FUNCTION VEN_FN_OBTIE_ESTIM(
    psCodPeriodoMayor     VARCHAR2,
    psCodPeriodoMenor     VARCHAR2,
    psCodPais             VARCHAR2,
    psCodMarca            VARCHAR2,
    psCodCanal            VARCHAR2,
    psCodRegion           VARCHAR2,
    psCodZona             VARCHAR2,
    psCodSeccion          VARCHAR2)
RETURN  tablaRegDatEstimado PIPELINED
IS
  tablaRegistro   tablaRegDatEstimado;
  REG tRegDatEstimado;

  CURSOR cursorRegistro
IS
   SELECT psCodPais,
          seg_perio_corpo.cod_peri,
          psCodMarca,
          psCodCanal,
          psCodRegion,
          psCodZona,
          psCodSeccion,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL,
          NULL
     FROM seg_perio_corpo, cra_perio
    WHERE seg_perio_corpo.cod_peri <= psCodPeriodoMayor
    AND seg_perio_corpo.cod_peri >= psCodPeriodoMenor
    AND seg_perio_corpo.oid_peri = cra_perio.peri_oid_peri;

lnNumPediObjt NUMBER;

BEGIN

     OPEN cursorRegistro;
      LOOP
           FETCH cursorRegistro BULK COLLECT INTO tablaRegistro LIMIT W_FILAS;
           IF tablaRegistro.COUNT > 0 THEN
             FOR x IN tablaRegistro.FIRST .. tablaRegistro.LAST LOOP
                 REG :=tablaRegistro(x);
                 --OBTENGO EL VALOR DE PEDIDOS OBJETIVO
                  BEGIN
                    SELECT p.val_num_pedi_objt
                      INTO lnnumpediobjt
                      FROM lid_secci_numer_pedid p
                     WHERE p.cod_pais = pscodpais
                       AND p.cod_peri = reg.cod_peri
                       AND p.cod_marc = pscodmarca
                       AND p.cod_zona = pscodzona
                       AND p.cod_secc = pscodseccion;

                  EXCEPTION
                    WHEN too_many_rows THEN
                      lnnumpediobjt := NULL;
                    WHEN no_data_found THEN
                      lnnumpediobjt := NULL;

                  END;

                 dbms_output.put_line('numpedidos objetivo estimado ' ||  lnnumpediobjt);
                  BEGIN

                    SELECT int_dat_estim.val_esti_vend,
                           int_dat_estim.val_esti_vene,
                           int_dat_estim.val_esti_pedi,
                           int_dat_estim.val_esti_clie,
                           int_dat_estim.val_esti_acti,
                           int_dat_estim.val_esti_ingr,
                           int_dat_estim.val_esti_egre,
                           int_dat_estim.val_esti_rein,
                           int_dat_estim.num_pedi_obje,
                           int_dat_estim.num_acti_obje,
                           int_dat_estim.val_real_tcpr,
                           int_dat_estim.val_esti_tcpr,
                           'G' ind_modi_peob,
                           int_dat_estim.usu_digi,
                           int_dat_estim.fec_digi,
                           int_dat_estim.usu_modi,
                           int_dat_estim.fec_modi
                      INTO REG.val_esti_vend,
                           REG.val_esti_vene,
                           REG.val_esti_pedi,
                           REG.val_esti_clie,
                           REG.val_esti_acti,
                           REG.val_esti_ingr,
                           REG.val_esti_egre,
                           REG.val_esti_rein,
                           REG.num_pedi_obje,
                           REG.num_acti_obje,
                           REG.val_real_tcpr,
                           REG.val_esti_tcpr,
                           REG.ind_modi_peob,
                           REG.usu_digi,
                           REG.fec_digi,
                           REG.usu_modi,
                           REG.fec_modi
                      FROM int_dat_estim
                     WHERE int_dat_estim.pais_cod_pais = pscodpais
                       AND int_dat_estim.cod_marc = pscodmarca
                       AND int_dat_estim.cod_cana = pscodcanal
                       AND int_dat_estim.cod_regi = pscodregion
                       AND int_dat_estim.cod_zona = pscodzona
                       AND int_dat_estim.cod_secci = pscodseccion
                       AND int_dat_estim.cod_peri = tablaregistro(x).cod_peri;



                  IF lnnumpediobjt IS NULL THEN
                     REG.ind_modi_peob:='G'; --N
                  ELSE
                      dbms_output.put_line('EG.num_pedi_obje ' ||  REG.num_pedi_obje);

                      IF REG.num_pedi_obje<>lnnumpediobjt THEN
                      dbms_output.put_line('REG.ind_modi_peob ' ||  lnnumpediobjt);
                         REG.num_pedi_obje:=lnnumpediobjt;
                         REG.ind_modi_peob:='M';--M
                      END IF;

                  END IF;

                  EXCEPTION
                    WHEN no_data_found THEN
                      REG.val_esti_vend := NULL;
                      REG.val_esti_vene := NULL;
                      REG.val_esti_pedi := NULL;
                      REG.val_esti_clie := NULL;
                      REG.val_esti_acti := NULL;
                      REG.val_esti_ingr := NULL;
                      REG.val_esti_egre := NULL;
                      REG.val_esti_rein := NULL;
                      REG.num_pedi_obje := lnnumpediobjt;
                      REG.num_acti_obje := NULL;
                      REG.val_real_tcpr := NULL;
                      REG.val_esti_tcpr := NULL;
                      REG.ind_modi_peob:='G';
                      IF lnnumpediobjt IS NULL THEN
                         REG.ind_modi_peob := 'G';  --N
                         REG.num_pedi_obje:= 0; --NULL
                      END IF;

                      REG.usu_digi := NULL;
                      REG.fec_digi := NULL;
                      REG.usu_modi := NULL;
                      REG.fec_modi := NULL;

                  END;

                 PIPE ROW(REG);
             END LOOP;
           END IF;
           EXIT WHEN cursorRegistro%NOTFOUND ;
      END LOOP ;
      CLOSE cursorRegistro;
      RETURN;
END VEN_FN_OBTIE_ESTIM;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Unidades Administrativas
                    por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_UNIDA_ADMIN_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS
   SELECT
                num_conc  oidConcurso,
                cod_terr  codTerritorio
        FROM (
        -- Obtiene los territorios de los concursos que solo tienen regiones --
        SELECT cpg.num_conc
               , r.cod_regi
               , z.cod_zona
               , s.cod_secc
               , t.cod_terr
        FROM inc_concu_param_gener cpg,
            inc_ambit_geogr iag,
            zon_regio r,
            zon_zona z,
            zon_secci s,
            zon_terri_admin ta,
            zon_terri t,
            int_dat_inc_concu_proce icp
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        AND cpg.oid_para_gral = iag.copa_oid_para_gral
        AND iag.zorg_oid_regi = r.oid_regi
        AND iag.zzon_oid_zona is null
        AND iag.zscc_oid_secc is null
        AND iag.terr_oid_terr is null
        and r.ind_acti = 1
        and r.ind_borr = 0
        and iag.zorg_oid_regi = z.zorg_oid_regi
        and z.ind_acti = 1
        and z.ind_borr = 0
        and z.oid_zona = s.zzon_oid_zona
        and s.ind_acti = 1
        and s.ind_borr = 0
        and s.oid_secc = ta.zscc_oid_secc
        and ta.ind_borr = 0
        and ta.terr_oid_terr = t.oid_terr
        and t.ind_borr = 0
        UNION ALL
        -- Obtiene los territorios de los concursos que tienen zonas seleccionadas --
        SELECT cpg.num_conc
               , r.cod_regi
               , z.cod_zona
               , s.cod_secc
               , t.cod_terr
        FROM inc_concu_param_gener cpg,
             int_dat_inc_concu_proce icp,
            inc_ambit_geogr iag,
            zon_regio r,
            zon_zona z,
            zon_secci s,
            zon_terri_admin ta,
            zon_terri t
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        AND cpg.oid_para_gral = iag.copa_oid_para_gral
        AND iag.zorg_oid_regi = r.oid_regi
        AND iag.zscc_oid_secc is null
        AND iag.terr_oid_terr is null
        and r.ind_acti = 1
        and r.ind_borr = 0
        and iag.zorg_oid_regi = z.zorg_oid_regi
        and z.ind_acti = 1
        and z.ind_borr = 0
        and iag.zzon_oid_zona = z.oid_zona
        and iag.zzon_oid_zona = s.zzon_oid_zona
        and s.ind_acti = 1
        and s.ind_borr = 0
        and s.oid_secc = ta.zscc_oid_secc
        and ta.ind_borr = 0
        and ta.terr_oid_terr = t.oid_terr
        and t.ind_borr = 0
        UNION ALL
        -- Obtiene los territorios de los concursos que tienen secciones seleccionadas --
        SELECT cpg.num_conc
               , r.cod_regi
               , z.cod_zona
               , s.cod_secc
               , t.cod_terr
        FROM inc_concu_param_gener cpg,
            int_dat_inc_concu_proce icp,
            inc_ambit_geogr iag,
            zon_regio r,
            zon_zona z,
            zon_secci s,
            zon_terri_admin ta,
            zon_terri t
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        AND cpg.oid_para_gral = iag.copa_oid_para_gral
        AND iag.zorg_oid_regi = r.oid_regi
        AND iag.terr_oid_terr is null
        and r.ind_acti = 1
        and r.ind_borr = 0
        and iag.zorg_oid_regi = z.zorg_oid_regi
        and z.ind_acti = 1
        and z.ind_borr = 0
        and iag.zzon_oid_zona = z.oid_zona
        and iag.zzon_oid_zona = s.zzon_oid_zona
        and s.ind_acti = 1
        and s.ind_borr = 0
        AND iag.zscc_oid_secc = s.oid_secc
        and iag.zscc_oid_secc = ta.zscc_oid_secc
        and ta.ind_borr = 0
        and ta.terr_oid_terr = t.oid_terr
        and t.ind_borr = 0
        UNION ALL
        -- Obtiene los territorios de los concursos que llegan hasta territorios seleccionados --
        SELECT cpg.num_conc
               , r.cod_regi
               , z.cod_zona
               , s.cod_secc
               , t.cod_terr
        FROM inc_concu_param_gener cpg,
            int_dat_inc_concu_proce icp,
            inc_ambit_geogr iag,
            zon_regio r,
            zon_zona z,
            zon_secci s,
            zon_terri_admin ta,
            zon_terri t
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        AND cpg.oid_para_gral = iag.copa_oid_para_gral
        AND iag.zorg_oid_regi = r.oid_regi
        and r.ind_acti = 1
        and r.ind_borr = 0
        and iag.zorg_oid_regi = z.zorg_oid_regi
        and z.ind_acti = 1
        and z.ind_borr = 0
        and iag.zzon_oid_zona = z.oid_zona
        and iag.zzon_oid_zona = s.zzon_oid_zona
        and s.ind_acti = 1
        and s.ind_borr = 0
        AND iag.zscc_oid_secc = s.oid_secc
        and iag.zscc_oid_secc = ta.zscc_oid_secc
        and ta.ind_borr = 0
        AND iag.terr_oid_terr = t.oid_terr
        and ta.terr_oid_terr = t.oid_terr
        and t.ind_borr = 0
        UNION ALL
        -- Todos los territorios de los concurso que no han seleccionado Ambito Geografico --
        SELECT
             cpg.num_conc
             ,r.cod_regi
             ,z.cod_zona
             ,s.cod_secc
             ,t.cod_terr
        FROM
             inc_concu_param_gener cpg,
             int_dat_inc_concu_proce icp,
             zon_regio r,
             zon_zona z,
             zon_secci s,
             zon_terri_admin ta,
             zon_terri t
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        and cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        and cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        and cpg.oid_para_gral=icp.copa_oid_para_gral
        and cpg.oid_para_gral not in (select copa_oid_para_gral from inc_ambit_geogr)
        and cpg.pais_oid_pais = r.pais_oid_pais
        and cpg.marc_oid_marc = r.marc_oid_marc
        and cpg.cana_oid_cana = r.cana_oid_cana
        and r.ind_acti = 1
        and r.ind_borr = 0
        and r.oid_regi = z.zorg_oid_regi
        and z.ind_acti = 1
        and z.ind_borr = 0
        and z.oid_zona = s.zzon_oid_zona
        and s.ind_acti = 1
        and s.ind_borr = 0
        and s.oid_secc = ta.zscc_oid_secc
        and ta.ind_borr = 0
        and ta.terr_oid_terr = t.oid_terr
        and t.ind_borr = 0
        )
        ORDER BY num_conc;

   TYPE interfazRec IS RECORD
   (
      codigoConcurso   inc_concu_param_gener.num_conc%TYPE,
      codigoTerritorio zon_terri.cod_terr%TYPE
    );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);

  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN

    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoConcurso            ||';'||
                              interfazRecord(x).codigoTerritorio;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_UNIDA_ADMIN_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_UNIDA_ADMIN_CONCU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Niveles por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_NIVEL_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER,vnIdTipoArticulo NUMBER ) IS
     SELECT
        cpg.num_conc cconcurso,
          pnp.num_nive nnivel,
      DECODE(pgp.tprm_oid_tipo_pion, 1, pnp.num_cant_fija_punt, num_cant_inic_punt) valrefevalniv,
        pnp.num_cant_inic_punt puntajeMinimo,
        pnp.num_cant_fina_punt puntajeMaximo,
        int_pkg_datam.INT_FN_DEVUE_CONCU_UNIDA_MEDID(cpg.oid_para_gral) as unidadCalculoPuntaje
        FROM
            inc_concu_param_gener cpg,
            int_dat_inc_concu_proce icp,
            inc_param_gener_premi pgp,
            inc_param_nivel_premi pnp
        WHERE
            cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        AND cpg.oid_para_gral = pgp.copa_oid_para_gral
        AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
        AND pnp.tpre_oid_tipo_prem = vnIdTipoArticulo; --vnIdTipoArticulo --;

   TYPE interfazRec IS RECORD
   (  codigoConcurso        inc_concu_param_gener.num_conc%TYPE,
      nivel                 inc_param_gener_premi.num_nive%TYPE,
      valRefEvaluacion      inc_param_nivel_premi.num_cant_inic_punt%TYPE,
        puntajeMinimo                    inc_param_nivel_premi.num_cant_inic_punt%TYPE,
        puntajeMaximo                    inc_param_nivel_premi.num_cant_fina_punt%TYPE,
        flagTipoUnidad                INT_DAT_INC_UNIDA_MEDID.cod_tipo_unid_medi%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lnIdTipoArticulo  NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* Generando Archivo de Texto (Detalle) */
    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
    lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

    lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.
    lnIdTipoArticulo := 2; -- id del Premio tipo articulo corresponde a oid inc_tipo_premi.oid_tipo_prem dado que  no existe codigo.
    lbAbrirUtlFile := TRUE;

        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso,lnIdTipoArticulo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

                  lsLinea :=  interfazRecord(x).codigoConcurso                  ||';'||
                                        interfazRecord(x).nivel                           ||';'||
                              interfazRecord(x).valRefEvaluacion                ||';'||
                              interfazRecord(x).puntajeMinimo                    ||';'||
                                            interfazRecord(x).puntajeMaximo                    ||';'||
                              interfazRecord(x).flagTipoUnidad;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_NIVEL_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_NIVEL_CONCU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Parametria de Opciones de premio
                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PARAM_OPCIO_PREMI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2)
IS
  CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER,vnIdTipoArticulo NUMBER ) IS
          SELECT
                 1 AS tipoquery,
           alo.prod_oid_prod AS oidProducto,
           cpg.oid_para_gral oidParamGene,
           cpg.num_conc  codigoConcurso,
                   pnp.num_nive  nivel
                 ,lpa.num_prem  numeroOpcion
                 ,mp.cod_sap    codigoProducto
           ,DECODE(pgp.tprm_oid_tipo_pion, 1, pnp.num_cant_fija_punt, num_cant_inic_punt) puntaje
           ,0 as CantPremDesp
           ,0 AS CantPendDesp
                 , pnp.num_cant_inic_punt puntajeMinimo
                 , pnp.num_cant_fina_punt puntajeMaximo
                 , int_pkg_datam.INT_FN_DEVUE_CONCU_UNIDA_MEDID(cpg.oid_para_gral)  flagTipoUnidad
         ,'O' tipoProducto
            FROM inc_concu_param_gener cpg,
                 int_dat_inc_concu_proce icp,
                 inc_param_gener_premi pgp,
                 inc_param_nivel_premi pnp,
                 inc_premi_artic       par,
                 inc_lote_premi_artic  lpa,
                 inc_artic_lote        alo,
                 mae_produ             mp
            WHERE cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
             AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
             AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
             AND pgp.copa_oid_para_gral = cpg.oid_para_gral
             AND cpg.oid_para_gral=icp.copa_oid_para_gral
             AND pnp.pagp_oid_para_gene_prem = pgp.oid_para_gene_prem
             AND pnp.tpre_oid_tipo_prem = 2
             AND par.panp_oid_para_nive_prem = pnp.oid_para_nive_prem
             AND lpa.prar_oid_prem_arti = par.oid_prem_arti
             AND alo.lopa_oid_lote_prem_arti = lpa.oid_lote_prem_arti
             AND mp.oid_prod = alo.prod_oid_prod
    UNION
    SELECT
             2 AS tipoquery,
         alo.prod_oid_prod AS oidProducto,
         cpg.oid_para_gral oidParamGene,
         cpg.num_conc  codigoConcurso,
         pnp.num_nive  nivel
         ,lpa.num_prem  numeroOpcion
         ,mp.cod_sap    codigoProducto
         ,DECODE(pgp.tprm_oid_tipo_pion, 1, pnp.num_cant_fija_punt, num_cant_inic_punt) puntaje
         ,0 as CantPremDesp
         ,0 as CantPendDesp
         , pnp.num_cant_inic_punt puntajeMinimo
         , pnp.num_cant_fina_punt puntajeMaximo
         , int_pkg_datam.INT_FN_DEVUE_CONCU_UNIDA_MEDID(cpg.oid_para_gral)  flagTipoUnidad
         ,'R' tipoProducto
    FROM inc_concu_param_gener cpg,
         int_dat_inc_concu_proce icp,
         inc_param_gener_premi pgp,
         inc_param_nivel_premi pnp,
         inc_premi_artic       par,
         inc_lote_premi_artic  lpa,
         inc_artic_lote        alo,
         inc_reemp_artic_lote  ral,
         mae_produ             mp
    WHERE cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
     AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
     AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
     AND pgp.copa_oid_para_gral = cpg.oid_para_gral
     AND cpg.oid_para_gral      =icp.copa_oid_para_gral
     AND pnp.pagp_oid_para_gene_prem = pgp.oid_para_gene_prem
     AND pnp.tpre_oid_tipo_prem = 2
     AND par.panp_oid_para_nive_prem = pnp.oid_para_nive_prem
     AND lpa.prar_oid_prem_arti = par.oid_prem_arti
     AND alo.lopa_oid_lote_prem_arti = lpa.oid_lote_prem_arti
     AND alo.oid_arti_lote = ral.arlo_oid_arti_lote
     AND ral.prod_oid_prod = mp.oid_prod
            ORDER BY 4, 5, 6;

   TYPE interfazRec IS RECORD
   (
      tipoQuery             NUMBER(1),
      oidProducto           inc_reemp_artic_lote.prod_oid_prod%TYPE,
      oidParamGene          inc_concu_param_gener.oid_para_gral%TYPE,
      codigoConcurso        inc_concu_param_gener.num_conc%TYPE,
	    nivel                 inc_param_nivel_premi.num_nive%TYPE,
      numeroOpcion          inc_lote_premi_artic.num_prem%TYPE,
      codigoProducto        mae_produ.cod_sap%TYPE,
      puntosUnidPremDes     inc_param_nivel_premi.num_cant_inic_punt%TYPE,
      numPremiosDespachar   ped_solic_posic.NUM_UNID_ATEN%TYPE,
      numPremiosPendientes  inc_bolsa_falta.NUM_UNID_FALT%TYPE,
	    puntajeMinimo			inc_param_nivel_premi.NUM_CANT_INIC_PUNT%TYPE,
	    puntajeMaximo			inc_param_nivel_premi.NUM_CANT_FINA_PUNT%TYPE,
	    flagTipoUnidad		INT_DAT_INC_UNIDA_MEDID.COD_TIPO_UNID_MEDI%TYPE,
      tipoProducto          varchar2(1)
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnSecuencia  NUMBER;--se reinicia por cada consurso y nivel
  lsCodigoAnt  VARCHAR2(50);
  lsCodigoAct  VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lnIdTipoArticulo  NUMBER;
  lbAbrirUtlFile      BOOLEAN;
BEGIN

    /* Generando Archivo de Texto (Detalle) */
    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
    lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

    lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.
    lnIdTipoArticulo := 2; -- id del Premio tipo articulo corresponde a oid inc_tipo_premi.oid_tipo_prem dado que  no existe codigo.

   lnSecuencia  :=1;
   lsCodigoAnt  :=NULL;

        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso,lnIdTipoArticulo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  IF interfazRecord(x).tipoQuery = 1 THEN
                     --numPremiosDespachar
                     SELECT nvl(SUM(spx.num_unid_aten),0)
                     INTO interfazRecord(x).numPremiosDespachar
                     from
                            inc_concu_param_gener  cpgx
                           ,int_dat_inc_concu_proce icpx
                           ,inc_param_gener_premi pgpx
                           ,inc_param_nivel_premi pnpx
                           ,inc_premi_artic       parx
                           ,inc_lote_premi_artic  lpax
                           ,inc_artic_lote        alox
                           ,ped_solic_cabec       scx
                           ,ped_solic_posic       spx
                      WHERE cpgx.oid_para_gral = icpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = pgpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = scx.copa_oid_para_gene
                        and cpgx.pais_oid_pais = scx.pais_oid_pais
                        and scx.oid_soli_cabe = spx.soca_oid_soli_cabe
                        and scx.grpr_oid_grup_proc = 5
                        and scx.fec_fact is not null
                        and pnpx.pagp_oid_para_gene_prem = pgpx.oid_para_gene_prem
                        and pnpx.tpre_oid_tipo_prem = 2
                        and parx.panp_oid_para_nive_prem = pnpx.oid_para_nive_prem
                        and lpax.prar_oid_prem_arti = parx.oid_prem_arti
                        and alox.lopa_oid_lote_prem_arti = lpax.oid_lote_prem_arti
                        and lpax.num_prem = scx.num_prem
                        and spx.prod_oid_prod = alox.prod_oid_prod
                        and scx.tspa_oid_tipo_soli_pais in ( select oid_tipo_soli_pais
                                                from ped_tipo_solic_pais tsp
                                                ,ped_tipo_solic ts
                                                ,ped_clase_solic cs
                                                where cs.cod_clas_soli = 'I1'
                                                and cs.oid_clas_soli = ts.clso_oid_clas_soli
                                                and ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
                                                and ind_soli_nega = 0 )
                      and spx.num_unid_aten > 0
                      AND cpgx.oid_para_gral =  interfazRecord(x).oidParamGene
                      and pnpx.num_nive = interfazRecord(x).nivel
                      and lpax.num_prem = interfazRecord(x).numeroOpcion
                      and alox.prod_oid_prod = interfazRecord(x).oidProducto;

                      --numPremiosPendientes
                      SELECT
                      nvl(sum(spx.num_unid_dema_real - nvl(spx.num_unid_aten,0)),0)
                      INTO interfazRecord(x).numPremiosPendientes
                      from
                           inc_concu_param_gener  cpgx
                           ,int_dat_inc_concu_proce icpx
                           ,inc_param_gener_premi pgpx
                           ,inc_param_nivel_premi pnpx
                           ,inc_premi_artic       parx
                           ,inc_lote_premi_artic  lpax
                           ,inc_artic_lote        alox
                           ,inc_bolsa_falta       bfx
                           ,ped_solic_cabec       scx
                           ,ped_solic_posic       spx
                      where
                          cpgx.oid_para_gral = icpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = pgpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = scx.copa_oid_para_gene
                        and cpgx.pais_oid_pais = scx.pais_oid_pais
                        and scx.oid_soli_cabe = spx.soca_oid_soli_cabe
                        and scx.grpr_oid_grup_proc = 5
                        and scx.fec_fact is not null
                        and spx.oid_soli_posi = bfx.sopo_oid_soli_posi
                        and bfx.fec_solu is null
                        and pnpx.pagp_oid_para_gene_prem = pgpx.oid_para_gene_prem
                        and pnpx.tpre_oid_tipo_prem = 2
                        and parx.panp_oid_para_nive_prem = pnpx.oid_para_nive_prem
                        and lpax.prar_oid_prem_arti = parx.oid_prem_arti
                        and alox.lopa_oid_lote_prem_arti = lpax.oid_lote_prem_arti
                        and lpax.num_prem = scx.num_prem
                        and spx.prod_oid_prod = alox.prod_oid_prod
                        and scx.tspa_oid_tipo_soli_pais in ( select oid_tipo_soli_pais
                                                 from ped_tipo_solic_pais tsp
                                                 ,ped_tipo_solic ts
                                                 ,ped_clase_solic cs
                                                where cs.cod_clas_soli = 'I1'
                                                and cs.oid_clas_soli = ts.clso_oid_clas_soli
                                                and ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
                                                and ind_soli_nega = 0 )
                        and (spx.num_unid_aten = 0 or (spx.num_unid_aten < spx.num_unid_dema_real) or
                           (spx.num_unid_aten is null))
                        AND cpgx.oid_para_gral =  interfazRecord(x).oidParamGene
                        and pnpx.num_nive = interfazRecord(x).nivel
                        and lpax.num_prem = interfazRecord(x).numeroOpcion
                        and alox.prod_oid_prod = interfazRecord(x).oidProducto;
                  ELSE
                       --numPremiosDespachar
                       select
                       nvl(sum(spx.num_unid_aten),0)
                       INTO interfazRecord(x).numPremiosDespachar
                        from
                             inc_concu_param_gener  cpgx
                             ,int_dat_inc_concu_proce icpx
                             ,inc_param_gener_premi pgpx
                             ,inc_param_nivel_premi pnpx
                             ,inc_premi_artic       parx
                             ,inc_lote_premi_artic  lpax
                             ,inc_artic_lote        alox
                             ,inc_reemp_artic_lote  ralx
                             ,ped_solic_cabec       scx
                             ,ped_solic_posic       spx
                        where
                              cpgx.oid_para_gral = icpx.copa_oid_para_gral
                          and cpgx.oid_para_gral = pgpx.copa_oid_para_gral
                          and cpgx.oid_para_gral = scx.copa_oid_para_gene
                          and cpgx.pais_oid_pais = scx.pais_oid_pais
                          and scx.oid_soli_cabe = spx.soca_oid_soli_cabe
                          and scx.grpr_oid_grup_proc = 5
                          and scx.fec_fact is not null
                          and pnpx.pagp_oid_para_gene_prem = pgpx.oid_para_gene_prem
                          and pnpx.tpre_oid_tipo_prem = 2
                          and parx.panp_oid_para_nive_prem = pnpx.oid_para_nive_prem
                          and lpax.prar_oid_prem_arti = parx.oid_prem_arti
                          and alox.lopa_oid_lote_prem_arti = lpax.oid_lote_prem_arti
                          and lpax.num_prem = scx.num_prem
                          and alox.oid_arti_lote = ralx.arlo_oid_arti_lote
                          and spx.prod_oid_prod = ralx.prod_oid_prod
                          and scx.tspa_oid_tipo_soli_pais in ( select oid_tipo_soli_pais
                                                    from ped_tipo_solic_pais tsp
                                                    ,ped_tipo_solic ts
                                                    ,ped_clase_solic cs
                                                    where cs.cod_clas_soli = 'I1'
                                                    and cs.oid_clas_soli = ts.clso_oid_clas_soli
                                                    and ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
                                                    and ind_soli_nega = 0 )
                          and spx.num_unid_aten > 0
                          AND cpgx.oid_para_gral = interfazRecord(x).oidParamGene
                          and pnpx.num_nive = interfazRecord(x).nivel
                          and lpax.num_prem = interfazRecord(x).numeroOpcion
                          and ralx.prod_oid_prod = interfazRecord(x).oidProducto;

                       --numPremiosPendientes
                       select
                       nvl(sum(spx.num_unid_dema_real - nvl(spx.num_unid_aten,0)),0)
                       INTO interfazRecord(x).numPremiosPendientes
                      from
                           inc_concu_param_gener  cpgx
                           ,int_dat_inc_concu_proce icpx
                           ,inc_param_gener_premi pgpx
                           ,inc_param_nivel_premi pnpx
                           ,inc_premi_artic       parx
                           ,inc_lote_premi_artic  lpax
                           ,inc_artic_lote        alox
                           ,inc_reemp_artic_lote  ralx
                           ,inc_bolsa_falta       bfx
                           ,ped_solic_cabec       scx
                           ,ped_solic_posic       spx
                      where
                            cpgx.oid_para_gral = icpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = pgpx.copa_oid_para_gral
                        and cpgx.oid_para_gral = scx.copa_oid_para_gene
                        and cpgx.pais_oid_pais = scx.pais_oid_pais
                        and scx.oid_soli_cabe = spx.soca_oid_soli_cabe
                        and scx.grpr_oid_grup_proc = 5
                        and scx.fec_fact is not null
                        and spx.oid_soli_posi = bfx.sopo_oid_soli_posi
                        and bfx.fec_solu is null
                        and pnpx.pagp_oid_para_gene_prem = pgpx.oid_para_gene_prem
                        and pnpx.tpre_oid_tipo_prem = 2
                        and parx.panp_oid_para_nive_prem = pnpx.oid_para_nive_prem
                        and lpax.prar_oid_prem_arti = parx.oid_prem_arti
                        and alox.lopa_oid_lote_prem_arti = lpax.oid_lote_prem_arti
                        and lpax.num_prem = scx.num_prem
                        and alox.oid_arti_lote = ralx.arlo_oid_arti_lote
                        and spx.prod_oid_prod = ralx.prod_oid_prod
                        and scx.tspa_oid_tipo_soli_pais in ( select oid_tipo_soli_pais
                                                  from ped_tipo_solic_pais tsp
                                                  ,ped_tipo_solic ts
                                                  ,ped_clase_solic cs
                                                  where cs.cod_clas_soli = 'I1'
                                                  and cs.oid_clas_soli = ts.clso_oid_clas_soli
                                                  and ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
                                                  and ind_soli_nega = 0 )
                        and (spx.num_unid_aten = 0 or (spx.num_unid_aten < spx.num_unid_dema_real) or
                             (spx.num_unid_aten is null))
                        AND cpgx.oid_para_gral = interfazRecord(x).oidParamGene
                        and pnpx.num_nive = interfazRecord(x).nivel
                        and lpax.num_prem = interfazRecord(x).numeroOpcion
                        and ralx.prod_oid_prod = interfazRecord(x).oidProducto ;
                  END IF;

                  lsCodigoAct:=interfazRecord(x).codigoConcurso||interfazRecord(x).nivel;
                  --CADA VEZ QUE CAMBIE EL CONCURSO Y NIVEL REINICIO LA SECUENCIA
                  IF (lsCodigoAct<>lsCodigoAnt) THEN
                     lnSecuencia  :=1;
                  END IF;

                  lsLinea :=  interfazRecord(x).codigoConcurso             ||';'||
				  		  	            interfazRecord(x).nivel                      ||';'||
                              interfazRecord(x).numeroOpcion               ||';'||
                              interfazRecord(x).codigoProducto             ||';'||
                              interfazRecord(x).puntosUnidPremDes          ||';'||
                              interfazRecord(x).numPremiosDespachar        ||';'||
                              interfazRecord(x).numPremiosPendientes       ||';'||
                              interfazRecord(x).puntajeMinimo						   ||';'||
                              interfazRecord(x).puntajeMaximo						   ||';'||
                              interfazRecord(x).flagTipoUnidad             ||';'||
                              interfazRecord(x).tipoProducto;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

                  lnSecuencia  :=lnSecuencia + 1;
                  lsCodigoAnt:=lsCodigoAct;

              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PARAM_OPCIO_PREMI: '||ls_sqlerrm);
END INT_PR_DAT_PARAM_OPCIO_PREMI;



/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Participantes por Concurso
                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PARTI_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER) IS

  SELECT codigoconc,
         decode(clie_oid_clie, NULL, '', gen_pkg_gener.gen_fn_devuelve_cod_clie(clie_oid_clie)) consultora,
         decode(clie_oid_clie, NULL, '', gen_pkg_gener.gen_fn_clien_datos_oid(clie_oid_clie,'COD_TERR')) terr,
         'C'
  FROM (
        SELECT
              cpg.num_conc codigoconc,
              ccc.clie_oid_clie
         FROM inc_concu_param_gener cpg,
              int_dat_inc_concu_proce icp,
              inc_cuent_corri_punto ccc
        WHERE
              cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
          AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
          AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
          AND cpg.oid_para_gral=icp.copa_oid_para_gral
          AND cpg.oid_para_gral = ccc.copa_oid_para_gral
        GROUP BY cpg.num_conc,
                 ccc.copa_oid_para_gral,
                 ccc.clie_oid_clie
		UNION
        SELECT
              cpg.num_conc codigoconc,
              g.clie_oid_clie
         FROM inc_concu_param_gener cpg,
              int_dat_inc_concu_proce icp,
              inc_param_gener_premi pgp,
              inc_param_nivel_premi pnp,
              inc_ganad             g
        WHERE
              cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
          AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
          AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
          AND cpg.oid_para_gral=icp.copa_oid_para_gral
          AND cpg.oid_para_gral = pgp.copa_oid_para_gral
          AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
          AND pnp.oid_para_nive_prem = g.panp_oid_para_nive_prem
        GROUP BY cpg.num_conc,
                 cpg.oid_para_gral,
                 g.clie_oid_clie
		UNION
        SELECT
            cpg.num_conc codigoconc,
            crt.clie_oid_clie
        FROM
            inc_clien_recte       crt
            , inc_concu_param_gener cpg
            , int_dat_inc_concu_proce icp
        WHERE
            cpg.oid_para_gral = crt.copa_oid_para_gral
        AND cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND cpg.oid_para_gral=icp.copa_oid_para_gral
        GROUP BY
            crt.copa_oid_para_gral
            , cpg.num_conc
            , crt.clie_oid_clie
	  UNION
            SELECT
                cpg.num_conc codigoconc,
                crd.clie_oid_clie
            FROM
                inc_clien_recte       crt
                , inc_concu_param_gener cpg
                , int_dat_inc_concu_proce icp
                , inc_clien_recdo       crd
            WHERE
                cpg.oid_para_gral = crt.copa_oid_para_gral
            AND cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
            AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
            AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
            AND cpg.oid_para_gral=icp.copa_oid_para_gral
            AND crt.oid_clie_rete = crd.clr3_oid_clie_rete
            GROUP BY
                crt.copa_oid_para_gral
                , cpg.num_conc
                , crd.clie_oid_clie
      UNION
      SELECT
          cpg.num_conc codigoconc,
          pe.clie_oid_clie
      FROM
          inc_premi_elegi pe
          , inc_concu_param_gener cpg
          , int_dat_inc_concu_proce icp
      WHERE
          cpg.oid_para_gral = pe.copa_oid_para_gral
      AND cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
      AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
      AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
      AND cpg.oid_para_gral=icp.copa_oid_para_gral
      GROUP BY
          pe.copa_oid_para_gral
          , cpg.num_conc
          , pe.clie_oid_clie
          );


   TYPE interfazRec IS RECORD
   (
      codigoConcurso           inc_concu_param_gener.num_conc%TYPE,
      codigoConsultora           mae_clien.cod_clie%TYPE,
      codigoTerritorio         zon_terri.cod_terr%TYPE,
 	    flagDirigido			   INT_DAT_INC_DIRIG.COD_DIRI%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* Generando Archivo de Texto (Detalle) */
    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
    lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

    lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.

        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

                  lsLinea :=  interfazRecord(x).codigoConcurso            ||';'||
                              interfazRecord(x).codigoConsultora            ||';'||
                              interfazRecord(x).codigoTerritorio          ||';'||
                               interfazRecord(x).flagDirigido;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PARTI_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_PARTI_CONCU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Productos relacionados al Concurso
                    por Concurso
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PRODU_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoIso   VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER) IS
     SELECT
       cpmv.num_conc codigoconcurso,
       cpmv.cod_peri Periodo,
       cpmv.cod_sap codigoproducto,
       cpmv.cod_tipo_ofer codtipooferta,
       cpmv.val_codi_vent codventa,
       tpa.cod_tipo_prod_alca flagtipoproducto,
       cpmv.puntosbonificados
    FROM (SELECT con.oid_para_gral,
               con.pais_oid_pais,
               con.marc_oid_marc,
               con.cana_oid_cana,
               con.ind_acti,
               con.num_conc,
               con.cod_peri,
               mv.cod_sap,
               mv.cod_tipo_ofer,
               mv.val_codi_vent,
               tipo,
               decode(num_punt_unid, NULL, 0, num_punt_unid) AS puntosbonificados
          FROM (SELECT cpg.pais_oid_pais,
                       cpg.marc_oid_marc,
                       cpg.cana_oid_cana,
                       cpg.ind_acti,
                       cpg.oid_para_gral,
                       cpg.num_conc,
                       p.oid_peri,
                       pc.cod_peri
                  FROM inc_concu_param_gener cpg,
                       cra_perio             p,
                       seg_perio_corpo       pc
                 WHERE p.peri_oid_peri = pc.oid_peri
                   AND p.oid_peri >= cpg.perd_oid_peri_desd
                   AND p.oid_peri <= cpg.perd_oid_peri_hast
                 ORDER BY oid_para_gral,
                          oid_peri) con,
               (
                -- Productos Bonificados
                SELECT copa_oid_para_gral,
                        2 AS tipo,
                        mapr_oid_marc_prod,
                        uneg_oid_unid_nego,
                        nego_oid_nego,
                        sgen_oid_supe_gene,
                        gene_oid_gene,
                        tofe_oid_tipo_ofer,
                        civi_oid_cicl_vida,
                        prod_oid_prod,
                        num_punt_unid
                  FROM inc_produ_bonif pb,
                        inc_produ       pr
                 WHERE pb.prdu_oid_prod = pr.oid_prod
                UNION
                -- Productos Excluidos
                SELECT copa_oid_para_gral,
                       3 AS tipo,
                       mapr_oid_marc_prod,
                       uneg_oid_unid_nego,
                       nego_oid_nego,
                       sgen_oid_supe_gene,
                       gene_oid_gene,
                       tofe_oid_tipo_ofer,
                       civi_oid_cicl_vida,
                       prod_oid_prod,
                       NULL num_punt_unid
                  FROM inc_produ_exclu pb,
                       inc_produ       pr
                 WHERE pb.prdu_oid_prod = pr.oid_prod
                UNION
                -- Productos Exigidos
                SELECT copa_oid_para_gral,
                       4 AS tipo,
                       mapr_oid_marc_prod,
                       uneg_oid_unid_nego,
                       nego_oid_nego,
                       sgen_oid_supe_gene,
                       gene_oid_gene,
                       tofe_oid_tipo_ofer,
                       civi_oid_cicl_vida,
                       prod_oid_prod,
                       NULL num_punt_unid
                  FROM inc_produ_exigi pb,
                       inc_produ       pr
                 WHERE pb.prdu_oid_prod = pr.oid_prod
                UNION
                -- Productos Validos
                SELECT copa_oid_para_gral,
                       1 AS tipo,
                       mapr_oid_marc_prod,
                       uneg_oid_unid_nego,
                       nego_oid_nego,
                       sgen_oid_supe_gene,
                       gene_oid_gene,
                       tofe_oid_tipo_ofer,
                       civi_oid_cicl_vida,
                       prod_oid_prod,
                       NULL num_punt_unid
                  FROM inc_produ_valid pb,
                       inc_produ       pr
                 WHERE pb.prdu_oid_prod = pr.oid_prod) prodcon,
               (SELECT mf.perd_oid_peri,
                       od.prod_oid_prod,
                       mp.cod_sap,
                       od.val_codi_vent,
                       od.tofe_oid_tipo_ofer,
                       pto.cod_tipo_ofer,
                       od.civi_oid_ciclo_vida,
                       mp.mapr_oid_marc_prod,
                       mp.uneg_oid_unid_nego,
                       mp.nego_oid_nego,
                       mp.sgen_oid_supe_gene,
                       mp.gene_oid_gene
                  FROM pre_ofert_detal       od,
                       pre_ofert             po,
                       pre_tipo_ofert        pto,
                       pre_matri_factu_cabec mf,
                       mae_produ             mp
                 WHERE od.prod_oid_prod = mp.oid_prod
                   AND od.ofer_oid_ofer = po.oid_ofer
                   AND po.mfca_oid_cabe = mf.oid_cabe
                   AND pto.oid_tipo_ofer = od.tofe_oid_tipo_ofer
                 GROUP BY
                      mf.perd_oid_peri,
                      od.prod_oid_prod,
                      mp.cod_sap,
                      od.val_codi_vent,
                      od.tofe_oid_tipo_ofer,
                      pto.cod_tipo_ofer,
                      od.civi_oid_ciclo_vida,
                      mp.mapr_oid_marc_prod,
                      mp.uneg_oid_unid_nego,
                      mp.nego_oid_nego,
                      mp.sgen_oid_supe_gene,
                      mp.gene_oid_gene) mv
         WHERE con.oid_para_gral = prodcon.copa_oid_para_gral
           AND con.oid_peri = mv.perd_oid_peri
            AND
        (
            ( -- Bloque Producto, Ciclo de Vida, Tipo de Oferta
                (       prodCon.prod_oid_prod = mv.prod_oid_prod
                    AND prodCon.tofe_oid_tipo_ofer is null
                    AND prodCon.civi_oid_cicl_vida is null
                )
                OR
                (       prodCon.prod_oid_prod = mv.prod_oid_prod
                    AND prodCon.tofe_oid_tipo_ofer = mv.tofe_oid_tipo_ofer
                    AND prodCon.civi_oid_cicl_vida is null
                )
                OR
                (       prodCon.prod_oid_prod = mv.prod_oid_prod
                    AND prodCon.tofe_oid_tipo_ofer = mv.tofe_oid_tipo_ofer
                    AND prodCon.civi_oid_cicl_vida = mv.civi_oid_ciclo_vida
                )
                OR
                (       prodCon.prod_oid_prod = mv.prod_oid_prod
                    AND prodCon.tofe_oid_tipo_ofer is null
                    AND prodCon.civi_oid_cicl_vida = mv.civi_oid_ciclo_vida
                )
            )
            OR
            ( -- Bloque Tipo de Oferta, Ciclo de Vida
                prodCon.prod_oid_prod is null
                AND
                (
                    (       prodCon.tofe_oid_tipo_ofer = mv.tofe_oid_tipo_ofer
                        AND prodCon.civi_oid_cicl_vida is null
                    )
                    OR
                    (       prodCon.tofe_oid_tipo_ofer = mv.tofe_oid_tipo_ofer
                        AND prodCon.civi_oid_cicl_vida = mv.civi_oid_ciclo_vida
                    )
                )
            )
            OR
            ( -- Bloque Negocio: Marca Producto, Unidad Negocio, Negocio, Super Generico y Generico
                    prodCon.prod_oid_prod is null
                AND prodCon.tofe_oid_tipo_ofer is null
                AND prodCon.mapr_oid_marc_prod = mv.mapr_oid_marc_prod
                AND

                (
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene is null

                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene

                    )
                    OR
                    (      prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene is null

                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene is null

                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene is null
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego is null
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene is null
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene is null
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego is null
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene is null
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene is null
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene is null
                    )
                    OR
                    (       prodCon.uneg_oid_unid_nego = mv.uneg_oid_unid_nego
                        AND prodCon.nego_oid_nego = mv.nego_oid_nego
                        AND prodCon.sgen_oid_supe_gene = mv.sgen_oid_supe_gene
                        AND prodCon.gene_oid_gene = mv.gene_oid_gene
                    )

                )
            )
        )
        UNION
        -- Todos los concursos que no tienen productos especificados, entonces carga toda la matriz venta
        SELECT con.oid_para_gral,
               con.pais_oid_pais,
               con.marc_oid_marc,
               con.cana_oid_cana,
               con.ind_acti,
               con.num_conc,
               con.cod_peri,
               mv.cod_sap,
               mv.cod_tipo_ofer,
               mv.val_codi_vent,
               1 AS tipo -- todos son validos --
              ,
               0 AS puntosbonificados
          FROM (SELECT cpg.pais_oid_pais,
                       cpg.marc_oid_marc,
                       cpg.cana_oid_cana,
                       cpg.ind_acti,
                       cpg.oid_para_gral,
                       cpg.num_conc,
                       p.oid_peri,
                       pc.cod_peri
                  FROM inc_concu_param_gener cpg,
                       cra_perio             p,
                       seg_perio_corpo       pc
                 WHERE p.peri_oid_peri = pc.oid_peri
                   AND p.oid_peri >= cpg.perd_oid_peri_desd
                   AND p.oid_peri <= cpg.perd_oid_peri_hast
                 ORDER BY oid_para_gral,
                          oid_peri) con,
               (SELECT mf.perd_oid_peri,
                       od.prod_oid_prod,
                       mp.cod_sap,
                       od.val_codi_vent,
                       od.tofe_oid_tipo_ofer,
                       pto.cod_tipo_ofer,
                       od.civi_oid_ciclo_vida,
                       mp.mapr_oid_marc_prod,
                       mp.uneg_oid_unid_nego,
                       mp.nego_oid_nego,
                       mp.sgen_oid_supe_gene,
                       mp.gene_oid_gene
                  FROM pre_ofert_detal       od,
                       pre_ofert             po,
                       pre_tipo_ofert        pto,
                       pre_matri_factu_cabec mf,
                       mae_produ             mp
                 WHERE od.prod_oid_prod = mp.oid_prod
                   AND od.ofer_oid_ofer = po.oid_ofer
                   AND po.mfca_oid_cabe = mf.oid_cabe
                   AND pto.oid_tipo_ofer = od.tofe_oid_tipo_ofer
                 GROUP BY
                      mf.perd_oid_peri,
                      od.prod_oid_prod,
                      mp.cod_sap,
                      od.val_codi_vent,
                      od.tofe_oid_tipo_ofer,
                      pto.cod_tipo_ofer,
                      od.civi_oid_ciclo_vida,
                      mp.mapr_oid_marc_prod,
                      mp.uneg_oid_unid_nego,
                      mp.nego_oid_nego,
                      mp.sgen_oid_supe_gene,
                      mp.gene_oid_gene) mv
         WHERE con.oid_para_gral NOT IN
               (SELECT copa_oid_para_gral FROM inc_produ)
           AND con.oid_peri = mv.perd_oid_peri) cpmv,
       int_dat_inc_concu_proce icp,
       int_dat_inc_produ_alcan tpa
 WHERE cpmv.pais_oid_pais = vnIdPais --<Parametro_Pais>
   AND cpmv.marc_oid_marc = vnIdMarca  -- <Parametro_Marca>
   AND cpmv.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
   AND cpmv.oid_para_gral=icp.copa_oid_para_gral
   AND cpmv.tipo = tpa.oid_tipo_prod_alca
 ORDER BY cpmv.num_conc,
          cpmv.cod_peri,
          cpmv.cod_tipo_ofer,
          cpmv.cod_sap,
          cpmv.val_codi_vent;



   TYPE interfazRec IS RECORD
   (

      codigoconcurso         inc_concu_param_gener.num_conc%TYPE,
      Periodo                seg_perio_corpo.cod_peri%TYPE,
      codigoproducto         mae_produ.cod_sap%TYPE,
      codtipooferta          pre_tipo_ofert.cod_tipo_ofer%TYPE,
      codventa               pre_ofert_detal.val_codi_vent%TYPE,
      flagtipoproducto       int_dat_inc_produ_alcan.cod_tipo_prod_alca%TYPE,
      puntosbonificados      NUMBER
   );


   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* Generando Archivo de Texto (Detalle) */
    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
    lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

    lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.

        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=
                              interfazRecord(x).codigoconcurso      ||';'||
                              interfazRecord(x).Periodo             ||';'||
                              interfazRecord(x).codigoproducto      ||';'||
                              interfazRecord(x).codtipooferta       ||';'||
                              interfazRecord(x).codventa            ||';'||
                              interfazRecord(x).flagtipoproducto    ||';'||
                              interfazRecord(x).puntosbonificados;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PRODU_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_PRODU_CONCU;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio informacion de las Listas de
                    Recomendantes y Recomendadas por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_RECTE_RECDA_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2)
IS
CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER ) IS
SELECT cpg.num_conc  codigoConcurso,
      pnp.num_nive  numNivel,
      crd.num_prem  numOpcion,
      p.cod_sap  codigoProducto,
      decode(crt.clie_oid_clie,NULL,'',gen_pkg_gener.gen_fn_devuelve_cod_clie(crt.clie_oid_clie))  codigoEbelista,
      decode(crd.clie_oid_clie,NULL,'',gen_pkg_gener.gen_fn_devuelve_cod_clie(crd.clie_oid_clie))  ebelistaRecomendda,
      '' flagCtrlAfiRedExito,
      icpc.num_mini_pedi_reco  numPedConcRcdd,
      icpc.num_mini_pedi  numPedConcRcdt,
      per_pkg_repor_perce.per_fn_obtie_perio(gen_pkg_gener.gen_fn_devuelve_des_perio(crd.perd_oid_peri),
                                             vnIdPais,
                                             vnIdMarca,
                                             vnIdCanal,
                                             decode(icpc.num_mini_pedi_reco,NULL,0,icpc.num_mini_pedi_reco) - 1) PeriodoEvaRdaEfect
    , DECODE( crd.ind_efec, null, 0, crd.ind_efec) as flagRdaEfectiva
 FROM
    inc_clien_recte       crt
    , inc_concu_param_gener cpg
    , int_dat_inc_concu_proce icp
    , inc_concu_param_consu icpc
    , inc_param_nivel_premi pnp
    , inc_premi_artic       pa
    , inc_lote_premi_artic  lpa
    , inc_artic_lote        al
    , mae_produ             p
    , inc_clien_recdo       crd
WHERE
    cpg.oid_para_gral = icp.copa_oid_para_gral
AND cpg.oid_para_gral = icpc.copa_oid_para_gral(+)
and cpg.oid_para_gral = crt.copa_oid_para_gral
and crt.oid_clie_rete = crd.clr3_oid_clie_rete
and crd.panp_oid_para_nive_prem = pnp.oid_para_nive_prem(+)
and pnp.oid_para_nive_prem = pa.panp_oid_para_nive_prem(+)
and pa.oid_prem_arti = lpa.prar_oid_prem_arti(+)
and lpa.oid_lote_prem_arti = al.lopa_oid_lote_prem_arti(+)
and al.prod_oid_prod = p.oid_prod(+)
ORDER BY
      cpg.num_conc ,
      pnp.num_nive,
      crd.num_prem,
      p.cod_sap;

   TYPE interfazRec IS RECORD
   (
      codigoConcurso         inc_concu_param_gener.num_conc%TYPE,
      numNivel               inc_param_nivel_premi.num_nive%TYPE,
      numOpcion              inc_clien_recdo.num_prem%TYPE,
        codigoProducto             mae_produ.COD_SAP%TYPE,
        codigoEbelista         mae_clien.cod_clie%TYPE,
      ebelistaRecomendda     mae_clien.cod_clie%TYPE,
      flagCtrlAfiRedExito    VARCHAR2(1),
      numPedConcRcdd         inc_concu_param_consu.num_mini_pedi_reco%TYPE,
      numPedConcRcdt         inc_concu_param_consu.num_mini_pedi%TYPE,
      PeriodoEvaRdaEfect     seg_perio_corpo.cod_peri%TYPE,
      flagrdaefectiva        VARCHAR2(1)
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

   lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoConcurso            ||';'||
                              interfazRecord(x).numNivel                              ||';'||
                              interfazRecord(x).numOpcion                             ||';'||
                              interfazRecord(x).codigoProducto                          ||';'||
                              interfazRecord(x).codigoEbelista                        ||';'||
                              interfazRecord(x).ebelistaRecomendda                    ||';'||
                              interfazRecord(x).flagCtrlAfiRedExito                   ||';'||
                              interfazRecord(x).numPedConcRcdd                        ||';'||
                              interfazRecord(x).numPedConcRcdt                        ||';'||
                              interfazRecord(x).PeriodoEvaRdaEfect                    ||';'||
                              interfazRecord(x).flagrdaefectiva                       ;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_RECTE_RECDA_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_RECTE_RECDA_CONCU;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Historico de Premios
                    despachados por Concurso
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_HISTO_PREMI_DESPA
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER ,vnIdTipoOCConsultora NUMBER) IS
     SELECT cpg.num_conc codigoConcurso,
            decode(iga.clie_oid_clie,
                   NULL,
                   '',
                   gen_pkg_gener.gen_fn_devuelve_cod_clie(iga.clie_oid_clie)) codigoEbelista,
            pnp.num_nive numNivel,
            psc.num_prem numOpcion,
            mp.cod_sap codigoProducto,
            '' flagCtrlPremAlt,
            gen_pkg_gener.gen_fn_devuelve_des_perio(iga.perd_oid_peri) PeriodoEntPrem,
            (SELECT SUM(ccp.num_punt)
               FROM inc_cuent_corri_punto ccp
              WHERE ccp.copa_oid_para_gral = psc.copa_oid_para_gene
                AND ccp.val_desc <> 'Entrega de Premio'
                AND ccp.clie_oid_clie = iga.clie_oid_clie) puntAcumAlcanzado,
            pnp.num_cant_inic_punt puntExigAlcanzado,
            psp.num_unid_aten unidPremDesp,
            gen_pkg_gener.gen_fn_devuelve_des_perio(psc.perd_oid_peri) PeriodoAsigPremDesp,
            pscc.val_nume_soli nrodocumento,
            (SELECT cod_terr
               FROM zon_terri_admin za, zon_terri zt
              WHERE za.terr_oid_terr = zt.oid_terr
                AND zt.ind_borr = 0
                AND za.oid_terr_admi = psc.ztad_oid_terr_admi) codigoTerritorio,
            iga.ind_desp flagTipoAsigPrem
       FROM inc_ganad             iga,
            ped_solic_cabec       psc,
            ped_solic_cabec       pscc,
            ped_solic_posic       psp,
            inc_concu_param_gener cpg,
            inc_param_nivel_premi pnp,
            mae_produ             mp,
            inc_versi_concu       vco
      WHERE iga.ind_desp = 1
        AND cpg.pais_oid_pais = vnIdPais --<Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND psc.oid_soli_cabe = iga.soca_oid_soli_cabe
        AND pscc.tspa_oid_tipo_soli_pais = vnIdTipoOCConsultora
        AND pscc.oid_soli_cabe = psc.soca_oid_soli_cabe
        AND cpg.oid_para_gral = psc.copa_oid_para_gene
        AND vco.copa_oid_para_gral = cpg.oid_para_gral
        AND vco.vico_oid_vige_conc = vnIdVigenciaConcurso
        AND cpg.ind_acti = 1
        AND psp.soca_oid_soli_cabe = iga.soca_oid_soli_cabe
        AND pnp.oid_para_nive_prem = iga.panp_oid_para_nive_prem
        AND mp.oid_prod = psp.prod_oid_prod;

   TYPE interfazRec IS RECORD
   (
      codigoConcurso         inc_concu_param_gener.num_conc%TYPE,
      codigoEbelista         mae_clien.cod_clie%TYPE,
      numNivel               inc_param_nivel_premi.num_nive%TYPE,
      numOpcion              inc_clien_recdo.num_prem%TYPE,
      codigoProducto         mae_produ.cod_sap%TYPE,
      flagCtrlPremAlt        VARCHAR2(1),
      PeriodoEntPremio       seg_perio_corpo.cod_peri%TYPE,
      puntAcumAlcanzado      NUMBER(6),
      puntExigAlcanzado      inc_param_nivel_premi.num_cant_inic_punt%TYPE,
      unidPremDesp           ped_solic_posic.num_unid_aten%TYPE,
      PeriodoAsigPremDesp    seg_perio_corpo.cod_peri%TYPE,
      numDocumento           ped_solic_cabec.val_nume_soli%TYPE,
      codigoTerritorio       zon_terri.cod_terr%TYPE,
      flagTipoAsigPrem       inc_ganad.ind_desp%TYPE

   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lnIdTipoOCConsultora NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.

   SELECT a.oid_tipo_soli_pais
     INTO lnIdTipoOCConsultora
     FROM ped_tipo_solic_pais a, ped_tipo_solic b
    WHERE a.tsol_oid_tipo_soli = b.oid_tipo_soli
      AND b.cod_tipo_soli = 'C1';

        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso,lnIdTipoOCConsultora);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoConcurso                        ||';'||
                  interfazRecord(x).codigoEbelista                        ||';'||
                  interfazRecord(x).numNivel                              ||';'||
                  interfazRecord(x).numOpcion                             ||';'||
                  interfazRecord(x).codigoProducto                        ||';'||
                  interfazRecord(x).flagCtrlPremAlt                       ||';'||
                  interfazRecord(x).PeriodoEntPremio                      ||';'||
                  interfazRecord(x).puntAcumAlcanzado                     ||';'||
                  interfazRecord(x).puntExigAlcanzado                     ||';'||
                  interfazRecord(x).unidPremDesp                          ||';'||
                  interfazRecord(x).PeriodoAsigPremDesp                   ||';'||
                  interfazRecord(x).numDocumento                          ||';'||
                  interfazRecord(x).codigoTerritorio                      ||';'||
                  interfazRecord(x).flagTipoAsigPrem;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_HISTO_PREMI_DESPA: '||ls_sqlerrm);
END INT_PR_DAT_HISTO_PREMI_DESPA;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Premios Seleccionados
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_SELEC
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER ) IS
   SELECT codigoconcurso, numnivel, numopcion, codigoproducto,
          codigoebelista,max(codigoterritorio) codigoterritorio, flagctrlasig, periodoproceso
   FROM (
   SELECT
    cpg.num_conc codigoconcurso
    ,pnp.num_nive numnivel
    ,lpa.num_prem numopcion
    ,p.cod_sap codigoProducto
    ,decode(pe.clie_oid_clie, NULL,'',gen_pkg_gener.gen_fn_devuelve_cod_clie(pe.clie_oid_clie)) codigoEbelista
    ,(SELECT cod_terr
       FROM zon_terri_admin za, zon_terri zt, mae_clien_unida_admin mcua
      WHERE za.terr_oid_terr = zt.oid_terr
        AND zt.ind_borr = 0
        AND za.oid_terr_admi = mcua.ztad_oid_terr_admi
        AND mcua.ind_acti = 1
        AND mcua.clie_oid_clie = pe.clie_oid_clie) codigoterritorio
    ,DECODE(pe.ind_pend,0,1,0) as flagCtrlAsig
    ,pscodigoPeriodo Periodoproceso --<Parametro_Periodo>
FROM
    inc_concu_param_gener cpg
    ,int_dat_inc_concu_proce icp
    ,inc_param_gener_premi pgp
    ,inc_param_nivel_premi pnp
    ,inc_premi_artic       pa
    ,inc_lote_premi_artic  lpa
    ,inc_artic_lote        al
    ,mae_produ             p
    ,inc_premi_elegi pe
WHERE
   cpg.pais_oid_pais = vnIdPais -- <Parametro_Pais>
   and cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
   and cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
   and cpg.oid_para_gral = pe.copa_oid_para_gral
   and cpg.oid_para_gral=icp.copa_oid_para_gral
   and cpg.oid_para_gral = pgp.copa_oid_para_gral
   and pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
   and pnp.oid_para_nive_prem = pa.panp_oid_para_nive_prem
   and pnp.tpre_oid_tipo_prem = 2
   and pnp.val_nive_sele = 1 -- solo concursos de premios electivos --
   and pa.oid_prem_arti = lpa.prar_oid_prem_arti
   and lpa.oid_lote_prem_arti = al.lopa_oid_lote_prem_arti
   and al.prod_oid_prod = p.oid_prod
   and pa.panp_oid_para_nive_prem = pe.panp_oid_para_nive_prem
   and lpa.num_prem = pe.num_prem
   )
   GROUP BY codigoconcurso,
            numnivel,
            numopcion,
            codigoproducto,
            codigoebelista,
            flagctrlasig,
            periodoproceso
   ORDER BY codigoconcurso,
            numnivel,
            numopcion,
            codigoproducto,
            codigoebelista;


   TYPE interfazRec IS RECORD
   (
      codigoConcurso         inc_concu_param_gener.num_conc%TYPE,
      numNivel               inc_param_nivel_premi.num_nive%TYPE,
      numOpcion              inc_clien_recdo.num_prem%TYPE,
        codigoProducto             mae_produ.COD_SAP%TYPE,
      codigoEbelista         mae_clien.cod_clie%TYPE,
      codigoTerritorio       zon_terri.cod_terr%TYPE,
      flaglAsigPremio        VARCHAR2(1),
      PeriodoProceso         seg_perio_corpo.cod_peri%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.
   lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoConcurso                     ||';'||
                              interfazRecord(x).numNivel                           ||';'||
                              interfazRecord(x).numOpcion                          ||';'||
                              interfazRecord(x).codigoProducto                     ||';'||
                              interfazRecord(x).codigoEbelista                     ||';'||
                              interfazRecord(x).codigoTerritorio                   ||';'||
                              interfazRecord(x).flaglAsigPremio                    ||';'||
                              interfazRecord(x).PeriodoProceso ;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PREMI_SELEC: '||ls_sqlerrm);
END INT_PR_DAT_PREMI_SELEC;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Premios Solicitados
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_SOLIC
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS
   CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER,vnIdVigenciaConcurso NUMBER ) IS
     SELECT cpg.num_conc cconcurso,
            mc.cod_clie cebelista,
            pnp.num_nive nronivel,
            psc.num_prem nroopcion,
            mp.cod_sap cproducto,
            psp.num_unid_aten uupremdesp,
            psp.num_unid_por_aten uuproduuopcsol,
            psp.num_unid_por_aten uuopcpremsel,
            (SELECT SUM(ccp.num_punt)
               FROM inc_cuent_corri_punto ccp
              WHERE ccp.copa_oid_para_gral = psc.copa_oid_para_gene
                AND ccp.val_desc <> 'Entrega de Premio'
                AND ccp.clie_oid_clie = iga.clie_oid_clie) puntutixuuopcsol,
            (SELECT SUM(ccp.num_punt)
               FROM inc_cuent_corri_punto ccp
              WHERE ccp.copa_oid_para_gral = psc.copa_oid_para_gene
                AND ccp.val_desc <> 'Entrega de Premio'
                AND ccp.clie_oid_clie = iga.clie_oid_clie) puntutiopcpremsol,
            iga.ind_desp flagctrpremasig,
            psCodigoPeriodo Periodofac --<Parametro_Periodo>
       FROM inc_ganad             iga,
            ped_solic_cabec       psc,
            ped_solic_posic       psp,
            inc_concu_param_gener cpg,
            inc_param_nivel_premi pnp,
            mae_clien             mc,
            mae_produ             mp,
            inc_versi_concu       vco
      WHERE iga.ind_desp = 1
        AND cpg.pais_oid_pais = vnIdPais --<Parametro_Pais>
        AND cpg.marc_oid_marc = vnIdMarca -- <Parametro_Marca>
        AND cpg.cana_oid_cana = vnIdCanal -- <Parametro_Canal>
        AND psc.oid_soli_cabe = iga.soca_oid_soli_cabe
        AND cpg.oid_para_gral = psc.copa_oid_para_gene
        AND vco.copa_oid_para_gral = cpg.oid_para_gral
        AND vco.vico_oid_vige_conc = vnIdVigenciaConcurso
        AND cpg.ind_acti = 1
        AND psp.soca_oid_soli_cabe = iga.soca_oid_soli_cabe
        AND pnp.oid_para_nive_prem = iga.panp_oid_para_nive_prem
        AND mc.oid_clie = iga.clie_oid_clie
        AND mp.oid_prod = psp.prod_oid_prod;

   TYPE interfazRec IS RECORD
   (
      codigoConcurso         inc_concu_param_gener.num_conc%TYPE,
      codigoEbelista         mae_clien.cod_clie%TYPE,
      numNivel               inc_param_nivel_premi.num_nive%TYPE,
      numOpcion              inc_clien_recdo.num_prem%TYPE,
      codigoProducto         mae_produ.cod_sap%TYPE,
      unidPremioDesp         ped_solic_posic.num_unid_aten%TYPE,
      unidPremioSolic        ped_solic_posic.num_unid_por_aten%TYPE,
      unidPremioSelec        ped_solic_posic.num_unid_por_aten%TYPE,
      puntUtiOpcSel          NUMBER,
      puntUtiOpcSol          NUMBER,
      flagPremAsig           VARCHAR2(1),
      PeriodoFacturado       seg_perio_corpo.cod_peri%TYPE
   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;
  lnIdVigenciaConcurso NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdVigenciaConcurso := 1;-- id del vigencia de concurso corresponde a oid inc_vigen_concu.oid_vige_conc dado que  no existe codigo.

   lbAbrirUtlFile := TRUE;
        OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdVigenciaConcurso);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codigoConcurso                      ||';'||
                              interfazRecord(x).codigoEbelista                      ||';'||
                              interfazRecord(x).numNivel                            ||';'||
                              interfazRecord(x).numOpcion                           ||';'||
                              interfazRecord(x).codigoProducto                      ||';'||
                              interfazRecord(x).unidPremioDesp                      ||';'||
                              interfazRecord(x).unidPremioSolic                     ||';'||
                              interfazRecord(x).unidPremioSelec                     ||';'||
                              interfazRecord(x).puntUtiOpcSel                       ||';'||
                              interfazRecord(x).puntUtiOpcSol                       ||';'||
                              interfazRecord(x).flagPremAsig                        ||';'||
                              interfazRecord(x).PeriodoFacturado;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;


   IF NOT lbAbrirUtlFile THEN
      utl_file.fclose(V_HANDLE);

      /* Procedimiento final para generar interfaz */
      GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PREMI_SOLIC: '||ls_sqlerrm);
END INT_PR_DAT_PREMI_SOLIC;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Puntaje de Ebelistas por
                    Periodo y concurso vigente
Fecha Creacion    : 24/01/2008
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PUNTA_PERIO_CONCU
  (psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2)
IS

   CURSOR c_interfaz IS
   With  concursos as (
          SELECT cpg.oid_para_gral,
                   cpg.num_conc,
                   decode(pgp.tprm_oid_tipo_pion,
                          1,
                          pnp.num_cant_fija_punt,
                          pnp.num_cant_inic_punt) val_punt_exig,
                   bcal_oid_base_calc
              FROM inc_concu_param_gener   cpg,
                   int_dat_inc_concu_proce icp,
                   inc_param_gener_premi   pgp,
                   inc_param_nivel_premi   pnp
             WHERE cpg.oid_para_gral = icp.copa_oid_para_gral
               AND cpg.oid_para_gral = pgp.copa_oid_para_gral
               AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
               AND pnp.num_nive = 1)
    SELECT con.num_conc codigoConcurso,
           cli.cod_clie codigoEbelista,
           cor.cod_peri anocamp,
           sum(ccp.num_punt) Puntaje,
           nvl(ped.val_cant_pedi,0) nrototalped,
--           COUNT(DISTINCT clie_oid_reco_dado) nrorecom,
           NVL(SUM(ped.val_unid_tota), 0) uupedido,
           con.val_punt_exig puntajeExi,
		       mtv.imp_monto_venta  vtabase,
           ccp.clie_oid_clie    oidclie,
           ccp.perd_oid_peri    oidperi,
           con.oid_para_gral    oidparagral,
           con.bcal_oid_base_calc basecalculo
      FROM mae_clien             cli,
           inc_cuent_corri_punto ccp,
           cra_perio             cra,
           seg_perio_corpo       cor,
--           inc_solic_concu_punta scpg,
--           inc_solic_concu_recom scr,
           inc_metas_tipo_venta  mtv,
           concursos             con,
           ped_solic_cabec_acum2 ped
     WHERE con.oid_para_gral = ccp.copa_oid_para_gral
       AND ccp.clie_oid_clie = cli.oid_clie
       AND cra.oid_peri = ccp.perd_oid_peri
       AND cor.oid_peri = cra.peri_oid_peri
       and ccp.val_desc not like '%Entrega de Premio%'
--          AND ccp.clie_oid_clie = scpg.clie_oid_clie(+)
--          AND ccp.copa_oid_para_gral = scpg.copa_oid_para_gral(+)
          AND ccp.perd_oid_peri = ped.perd_oid_peri(+)
          AND ccp.clie_oid_clie = ped.clie_oid_clie(+)
--          AND ccp.copa_oid_para_gral = scr.copa_oid_para_gral(+)
--       AND ccp.perd_oid_peri = scr.perd_oid_peri(+)
       AND ccp.copa_oid_para_gral = mtv.copa_oid_para_gral(+)
       AND ccp.clie_oid_clie = mtv.clie_oid_clie(+)
     group by con.num_conc,
              ccp.clie_oid_clie,
              cli.cod_clie,
              con.oid_para_gral,
              ccp.perd_oid_peri,
              cor.cod_peri,
              con.val_punt_exig,
              mtv.imp_monto_venta,
              con.bcal_oid_base_calc,
              ped.val_cant_pedi;


   TYPE interfazRec IS RECORD
   (
      codigoConcurso         inc_concu_param_gener.num_conc%TYPE,
      codigoEbelista         mae_clien.cod_clie%TYPE,
      Periodo                seg_perio_corpo.cod_peri%TYPE,
      puntajeTotalVta        NUMBER,
      numTotalPedido         NUMBER,
--      numRecomend            NUMBER,
      totalUnidades          NUMBER,
      puntajeexi             NUMBER,
      vtabase                inc_metas_tipo_venta.imp_monto_venta%TYPE,
      oidclie                mae_clien.oid_clie%TYPE,
      oidperi                cra_perio.oid_peri%TYPE,
      oidparagral            inc_concu_param_gener.oid_para_gral%TYPE,
      oidbasecalc            inc_concu_param_gener.bcal_oid_base_calc%TYPE
   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
   numTotalPedido   number;
   totalUnidades    number;
   numRecomend      number;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnIdPais      NUMBER;
  lnIdMarca     NUMBER;
  lnIdCanal     NUMBER;

  lbAbrirUtlFile      BOOLEAN;

BEGIN
    /* obteniendo id's */
   lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante

  lbAbrirUtlFile := TRUE;
/*
  FOR y IN (SELECT cpg.oid_para_gral,
                   cpg.num_conc,
                   decode(pgp.tprm_oid_tipo_pion,
                          1,
                          pnp.num_cant_fija_punt,
                          pnp.num_cant_inic_punt) val_punt_exig
              FROM inc_concu_param_gener   cpg,
                   int_dat_inc_concu_proce icp,
                   inc_param_gener_premi   pgp,
                   inc_param_nivel_premi   pnp
             WHERE cpg.pais_oid_pais = lnidpais -- <Parametro_Pais>
               AND cpg.marc_oid_marc = lnidmarca -- <Parametro_Marca>
               AND cpg.cana_oid_cana = lnidcanal -- <Parametro_Canal>
               AND cpg.oid_para_gral = icp.copa_oid_para_gral
               AND cpg.oid_para_gral = pgp.copa_oid_para_gral
               AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
               AND pnp.num_nive = 1
               UNION
               SELECT NULL OID_PARA_GRAL, NULL NUM_CONC, NULL val_punt_exig FROM DUAL
               ) LOOP

*/
        OPEN c_interfaz();
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           /* Procedimiento inicial para generar interfaz */

           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

              /*
                  SELECT count(distinct perd_oid_peri), nvl(sum(num_unid),0)
                    into numTotalPedido, totalUnidades
                    from inc_solic_concu_punta
                    where copa_oid_para_gral = interfazRecord(x).oidparagral
                          and clie_oid_clie = interfazRecord(x).oidclie
                          and perd_oid_peri = interfazRecord(x).oidperi
                          and imp_mont>0;
                */
                  IF interfazRecord(x).oidbasecalc=4 THEN
                    SELECT count(0)
                    into numRecomend
                    from inc_solic_concu_recom
                    where copa_oid_para_gral = interfazRecord(x).oidparagral
                          and clie_oid_clie = interfazRecord(x).oidclie
                          and perd_oid_peri = interfazRecord(x).oidperi
                          and clie_oid_reco_dado is not null;
                  ELSE
                    numRecomend:=0;
                  END IF;

                  lsLinea :=  interfazRecord(x).codigoconcurso                          ||';'||
                              interfazRecord(x).codigoEbelista                    ||';'||
                              interfazRecord(x).Periodo                           ||';'||
                              interfazRecord(x).puntajeTotalVta                           ||';'||
                              interfazRecord(x).numTotalPedido                    ||';'||
                              numRecomend                       ||';'||
                              interfazRecord(x).totalUnidades                     ||';'||
                              interfazRecord(x).puntajeexi                     ||';'||
                              interfazRecord(x).vtabase;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
          END LOOP;
        CLOSE c_interfaz;

  --END LOOP;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_PUNTA_PERIO_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_PUNTA_PERIO_CONCU;

/***************************************************************************
Descripcion       : Devuelve los ingresos totales de la Periodo actual
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_PERIO_ACTUA(
   pnOidPeriodo  NUMBER,
   pnOidCliente NUMBER
)
RETURN NUMBER
IS
  ldFechaInicio DATE;
  ldFechaFin DATE;
  lnIngresos NUMBER;

BEGIN
  SELECT fec_inic, fec_fina
  into ldFechaInicio,ldFechaFin
          FROM cra_perio
         WHERE oid_peri = pnOidPeriodo;

  SELECT COUNT(1)
      INTO lningresos
      FROM mae_clien_vincu mcv, mae_tipo_vincu mtv, zon_secci zs, zon_zona zz
    WHERE mcv.tivc_oid_tipo_vinc = mtv.oid_tipo_vinc
      AND mtv.ind_reco = 1
      AND mcv.fec_desd >= ldFechaInicio
      AND mcv.fec_desd <= ldFechaFin
      AND zs.clie_oid_clie = mcv.clie_oid_clie_vnte
      AND zs.ind_acti = 1
      AND zs.ind_borr = 0
      AND zs.zzon_oid_zona = zz.oid_zona
      AND zz.ind_acti = 1
      AND zz.ind_borr = 0
      AND EXISTS (SELECT 1
              FROM fac_contr_cierr c, fac_tipos_cierr tc
             WHERE zorg_oid_regi IS NOT NULL
               AND c.tcie_oid_tipo_cier = tc.oid_tipo_cier
               AND tc.cod_tipo_cier = 'R'
               AND perd_oid_peri = pnOidPeriodo
               AND zorg_oid_regi = zz.zorg_oid_regi)
       AND mcv.clie_oid_clie_vnte = pnoidcliente;

  RETURN lnIngresos;

EXCEPTION

WHEN NO_DATA_FOUND  THEN
     RETURN 0;

WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_INGRE_PERIO_ACTUA: '||ls_sqlerrm);
END INT_FN_DEVUE_INGRE_PERIO_ACTUA;

/***************************************************************************
Descripcion       : Devuelve los ingresos lideres que pasaron 2do pedido
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_LIDER_PEDI2(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnIngresos NUMBER;
BEGIN
   SELECT count(1)
   INTO lningresos
     FROM lid_recom_lider reco
    WHERE reco.cod_conc = psCodigoConcurso--Codigo Concurso
      AND reco.cod_tipo = '01'
      AND reco.int_efec = 1
      AND reco.cod_peri_eval = psCodigoPeriodo  --- codigoPeriodo
      AND reco.cod_clie_lide = psCodigoLider; ---codigo Lider
  RETURN lnIngresos;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_INGRE_LIDER_PEDI2: '||ls_sqlerrm);
END INT_FN_DEVUE_INGRE_LIDER_PEDI2;

/***************************************************************************
Descripcion       : Devuelve los ingresos lideres que pasaron 2do pedido
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_INGRE_LIDER_PEDI3(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnIngresos NUMBER;
BEGIN
   SELECT count(1)
   INTO lningresos
    FROM lid_recom_lider reco
         WHERE reco.cod_conc = psCodigoConcurso--Codigo Concurso
               AND reco.cod_tipo = '02' --codigo de tipo
      AND reco.int_efec = 1 --Indicador
      AND reco.cod_peri_eval = psCodigoPeriodo  --- codigoPeriodo
      AND reco.cod_clie_lide = psCodigoLider; ---codigo Lider
  RETURN lnIngresos;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_INGRE_LIDER_PEDI3: '||ls_sqlerrm);
END INT_FN_DEVUE_INGRE_LIDER_PEDI3;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Recomendaciones efectivas a la
                    Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_RECOM_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnPuntaje NUMBER;
BEGIN
   SELECT SUM(reco.val_punt)
     INTO lnpuntaje
     FROM lid_recom_lider reco
    WHERE reco.cod_conc = pscodigoconcurso --Codigo Concurso
      AND reco.cod_tipo = '01' --codigo de tipo
      AND reco.int_efec = 1 --Indicador
      AND reco.cod_peri_eval = pscodigoPeriodo --- codigoPeriodo
      AND reco.cod_clie_lide = pscodigolider; ---codigo Lider
  RETURN lnPuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNT_RECOM_EFECT: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNT_RECOM_EFECT;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Pedido Adicional a la
                    Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_PEDID_ADICI(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnPuntaje NUMBER;
BEGIN
   SELECT SUM(reco.val_punt)
     INTO lnpuntaje
     FROM lid_recom_lider reco
         WHERE reco.cod_conc = psCodigoConcurso--Codigo Concurso
               AND reco.cod_tipo = '02' --codigo de tipo
      AND reco.int_efec = 1 --Indicador
      AND reco.cod_peri_eval = psCodigoPeriodo  --- codigoPeriodo
      AND reco.cod_clie_lide = psCodigoLider; ---codigo Lider
  RETURN lnPuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNT_PEDID_ADICI: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNT_PEDID_ADICI;

/***************************************************************************
Descripcion       : Devuelve los puntaje Por Pedido en la Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNT_PEDID_PERIO(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnPuntaje NUMBER;
BEGIN
  SELECT SUM(pedi.val_punt)
    INTO lnpuntaje
    FROM lid_secci_numer_pedid pedi
   WHERE pedi.ind_efec = 1 --Indicador
     AND pedi.cod_peri = pscodigoPeriodo --- codigoPeriodo
     AND pedi.cod_clie_lide = pscodigolider ---codigo Lider
     AND pedi.cod_conc = psCodigoConcurso;
  RETURN lnPuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNT_PEDID_PERIO: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNT_PEDID_PERIO;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Impuestos por Producto
Fecha Creacion    : 04/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_RESUL_CONCU_LIDER
(
  pscodigopais     VARCHAR2,
  pscodigosistema  VARCHAR2,
  pscodigointerfaz VARCHAR2,
  psnombrearchivo  VARCHAR2,
  pscodigomarca    VARCHAR2,
  pscodigocanal    VARCHAR2,
  pscodigoPeriodo  VARCHAR2
) IS
  CURSOR c_interfaz
  (
    vnidPeriodo  NUMBER,
    vnoidtipomov NUMBER
  ) IS

    SELECT pscodigoPeriodo,
           cod_clie,
           num_conc,
           ltrim(to_char(val_tota_acti_lide,'999999990.99')),
           val_tota_ingr,
           val_tota_ingr_ped2,
           val_tota_ingr_ped3,
           val_punt_acti_peri,
           val_punt_reco_efec,
           val_punt_pedi_adic,
           val_punt_tota_peri,
           val_punt_acum_conc,
           val_punt_tota_canj,
           val_ingr_otro_ped2,
           val_punt_reco_otro,
           val_punt_pedi_peri,
           num_ingr_efec_base,
           val_punt_ingr_efec_base,
           num_ingr_efec_adic,
           val_punt_ingr_efec_adic,
           val_punt_boni_peri,
           val_punt_obje,
           val_pup_obje_alca,
           val_unid_real_pup,
           num_pedi_real
      FROM int_dat_tmp_resul_concu_lider p,
           int_dat_tmp_conso_activ_lider e
     WHERE p.oid_clie = e.clie_oid_clie(+)
     ORDER BY num_conc,
              cod_clie;

  TYPE interfazrec IS RECORD(
    codigoPeriodo                 seg_perio_corpo.cod_peri%TYPE,
    codigoconsultora              mae_clien.cod_clie%TYPE,
    codigoconcurso                inc_concu_param_gener.num_conc%TYPE,
    puntactilider                 VARCHAR2(100),
    totalingresos                 NUMBER,
    ingresos2pedido               NUMBER,
    ingresos3pedido               NUMBER,
    puntactiPeriodo               NUMBER,
    puntrecoefec                  NUMBER,
    puntpediadic                  NUMBER,
    punttotalPeriodo              NUMBER,
    puntacumconcu                 NUMBER,
    punttotalcanje                NUMBER,
    ingresosotros2pedido          NUMBER,
    puntrecootros                 NUMBER,
    puntpediPeriodo               NUMBER,
    nroingresosefectivobase       NUMBER,
    ptjenroingresosefectivobase   NUMBER,
    nroingresosefectivosadicobjt  NUMBER,
    ptjeingresosefectivosadicobjt NUMBER,
    ptjebonificadosPeriodo        NUMBER,
    ptjepupobjetivo               NUMBER,
    pupobjetivoalcanzado          NUMBER,
    unidadesrealespup             NUMBER,
    pedidosreales                 NUMBER);
  TYPE interfazrectab IS TABLE OF interfazrec;
  interfazrecord interfazrectab;
  /* Variables usadas para la generacion del archivo de texto */
  lsdirtempo      bas_inter.dir_temp%TYPE;
  w_filas         NUMBER := 1000;
  v_handle        utl_file.file_type;
  lslinea         VARCHAR2(1000);
  lsnombrearchivo VARCHAR2(50);
  lnidmarca       NUMBER;
  lnidcanal       NUMBER;
  lnidPeriodo     NUMBER;
  lnidtipocargo   NUMBER;
  lbabrirutlfile  BOOLEAN;

BEGIN

 /* obteniendo id's */
  lnidmarca     := gen_pkg_gener.gen_fn_devuelve_id_marca(pscodigomarca); -- id del marca consultante
  lnidcanal     := gen_pkg_gener.gen_fn_devuelve_id_canal(pscodigocanal); -- id del canal consultante
  lnidPeriodo   := gen_pkg_gener.gen_fn_devuelve_id_cra_perio(pscodigoPeriodo,  lnidmarca,
                                                              lnidcanal);


  DELETE int_dat_tmp_resul_concu_lider;

  INSERT INTO int_dat_tmp_resul_concu_lider WITH concursos AS
    (SELECT cpg.num_conc,
            iccp.copa_oid_para_gral,
            mc.oid_clie,
            mc.cod_clie
       FROM inc_concu_param_gener cpg,
            inc_cuent_corri_punto iccp,
            mae_clien             mc
      WHERE cpg.val_obse LIKE '%PROGRAMA-LIDERES%'
        AND cpg.ind_acti = 1
        AND cpg.oid_para_gral = iccp.copa_oid_para_gral
        AND iccp.perd_oid_peri = lnidPeriodo
        AND iccp.num_punt <> 0
        AND iccp.clie_oid_clie = mc.oid_clie
      GROUP BY cpg.num_conc,
               iccp.copa_oid_para_gral,
               mc.oid_clie,
               mc.cod_clie)
    SELECT concursos.oid_clie,
           concursos.cod_clie cod_clie,
           concursos.num_conc num_conc,
           int_pkg_datam.int_fn_devue_ingre_perio_actua(lnidPeriodo,
                                                        concursos.oid_clie) val_tota_ingr,
           int_pkg_datam.int_fn_devue_ingre_lider_pedi2(pscodigoPeriodo,
                                                        concursos.num_conc,
                                                        concursos.cod_clie) val_tota_ingr_ped2,
           int_pkg_datam.int_fn_devue_ingre_lider_pedi3(pscodigoPeriodo,
                                                        concursos.num_conc,
                                                        concursos.cod_clie) val_tota_ingr_ped3,
           0 val_punt_acti_peri,
           nvl(int_pkg_datam.int_fn_devue_punt_recom_efect(pscodigoPeriodo,
                                                           concursos.num_conc,
                                                           concursos.cod_clie),
               0) val_punt_reco_efec,
           nvl(int_pkg_datam.int_fn_devue_punt_pedid_adici(pscodigoPeriodo,
                                                           concursos.num_conc,
                                                           concursos.cod_clie),
               0) val_punt_pedi_adic,
           0 val_punt_tota_peri,
           nvl((SELECT SUM(ccp.num_punt)
                 FROM inc_cuent_corri_punto ccp
                WHERE ccp.copa_oid_para_gral = concursos.copa_oid_para_gral
                  AND ccp.clie_oid_clie = concursos.oid_clie
                  AND ccp.perd_oid_peri <= lnidPeriodo),
               0) val_punt_acum_conc,
           nvl((SELECT SUM(ccp.num_punt)
                 FROM inc_cuent_corri_punto ccp
                WHERE copa_oid_para_gral = concursos.copa_oid_para_gral
                  AND clie_oid_clie = concursos.oid_clie
                  AND ccp.tmov_oid_tipo_movi = 2
                  AND ccp.val_desc LIKE 'Entrega de Premio%'),
               0) val_punt_tota_canj,
           0 val_ingr_otro_ped2,
           0 val_punt_reco_otro,
           nvl(int_pkg_datam.int_fn_devue_punt_pedid_perio(pscodigoPeriodo,
                                                           concursos.num_conc,
                                                           concursos.cod_clie),
               0) val_punt_pedi_peri,
           nvl(int_pkg_datam.int_fn_devue_numer_ingre_efect(pscodigoPeriodo,
                                                            concursos.num_conc,
                                                            concursos.cod_clie),
               0) num_ingr_efec_base,
           nvl(int_pkg_datam.int_fn_devue_punta_ingre_efect(pscodigoPeriodo,
                                                            concursos.num_conc,
                                                            concursos.cod_clie),
               0) val_punt_ingr_efec_base,
           nvl(int_pkg_datam.int_fn_devue_numer_efect_adici(pscodigoPeriodo,
                                                            concursos.num_conc,
                                                            concursos.cod_clie),
               0) num_ingr_efec_adic,
           nvl(int_pkg_datam.int_fn_devue_punta_super_ingre(pscodigoPeriodo,
                                                            concursos.num_conc,
                                                            concursos.cod_clie),
               0) val_punt_ingr_efec_adic,
           nvl(int_pkg_datam.int_fn_devue_punta_bonif_perio(lnidPeriodo,
                                                            concursos.copa_oid_para_gral,
                                                            concursos.oid_clie),
               0) val_punt_boni_peri,
           0 val_punt_obje,
           0 val_pup_obje_alca,
           0 val_unid_real_pup,
           (SELECT SUM(val_num_pedi_real)
              FROM lid_secci_numer_pedid
             WHERE cod_clie_lide = concursos.cod_clie
               AND cod_peri = pscodigoPeriodo) num_pedi_real
      FROM concursos;

  delete int_dat_tmp_conso_activ_lider;
  INSERT INTO int_dat_tmp_conso_activ_lider WITH zonasnocerradas AS
    (SELECT s.oid_secc
       FROM fac_contr_cierr f,
            fac_tipos_cierr y,
            zon_zona        z,
            zon_secci       s
      WHERE f.perd_oid_peri = lnidPeriodo
        AND f.tcie_oid_tipo_cier = y.oid_tipo_cier
        AND y.cod_tipo_cier = 'R'
        AND f.zorg_oid_regi = z.zorg_oid_regi
        AND s.zzon_oid_zona = z.oid_zona
        AND s.ind_acti = 1
        AND s.ind_borr = 0)
    SELECT a.clie_oid_clie,
           decode(SUM(numactifinales),
                  0,
                  0,
                  SUM(numeropedidoxseccion) * 100 / SUM(numactifinales)) val_tota_acti_lide
      FROM zon_secci a,
           (SELECT d.zscc_oid_secc,
                   COUNT(1) numeropedidoxseccion
              FROM ped_solic_cabec     a,
                   ped_tipo_solic_pais b,
                   ped_tipo_solic      c,
                   zon_terri_admin     d
             WHERE a.perd_oid_peri = lnidPeriodo
               AND c.cod_tipo_soli = 'SOC'
               AND a.grpr_oid_grup_proc = 5
               AND a.fec_fact IS NOT NULL
               AND a.tspa_oid_tipo_soli_pais = b.oid_tipo_soli_pais
               AND b.tsol_oid_tipo_soli = c.oid_tipo_soli
               AND a.ztad_oid_terr_admi = d.oid_terr_admi
               AND a.terr_oid_terr = d.terr_oid_terr
               AND EXISTS (SELECT 1 FROM zonasnocerradas s WHERE s.oid_secc = d.zscc_oid_secc)
             GROUP BY d.zscc_oid_secc) pedidoseccion,
           (SELECT c.zscc_oid_secc,
                   nvl(SUM(a.num_acti_fina),
                       0) numactifinales
              FROM int_fuent_ventas_real a,
                   zon_terri             b,
                   zon_terri_admin       c
             WHERE a.perd_oid_peri = lnidPeriodo
               AND a.terr_oid_terr = b.oid_terr
               AND b.oid_terr = c.terr_oid_terr
               AND c.perd_oid_peri_inic <= lnidPeriodo
               AND (c.perd_oid_peri_fina IS NULL OR c.perd_oid_peri_fina >= lnidPeriodo)
               AND EXISTS (SELECT 1 FROM zonasnocerradas s WHERE s.oid_secc = c.zscc_oid_secc)
             GROUP BY c.zscc_oid_secc) activasfinales
     WHERE a.ind_acti = 1
       AND a.ind_borr = 0
       AND a.oid_secc = activasfinales.zscc_oid_secc
       AND a.oid_secc = pedidoseccion.zscc_oid_secc
       AND exists(
  select 1 from int_dat_tmp_resul_concu_lider l
  where a.clie_oid_clie=l.oid_clie

       )
     GROUP BY a.clie_oid_clie;

  lnidtipocargo := 2; --Tipo de Movimiento Cargo, no dispone de codigo por lo que el oid es el identificador '2'

  /* Generando Archivo de Texto (Detalle) */
  lbabrirutlfile := TRUE;
  OPEN c_interfaz(lnidPeriodo,
                  lnidtipocargo);
  LOOP
    FETCH c_interfaz BULK COLLECT
      INTO interfazrecord LIMIT w_filas;
    /* Procedimiento inicial para generar interfaz */
    IF lbabrirutlfile THEN
      gen_pkg_inter_archi.gen_pr_inici_inter(pscodigopais,
                                             pscodigosistema,
                                             pscodigointerfaz,
                                             psnombrearchivo,
                                             lsdirtempo,
                                             lsnombrearchivo,
                                             v_handle);
      lbabrirutlfile := FALSE;
    END IF;

    IF interfazrecord.count > 0 THEN
      FOR x IN interfazrecord.first .. interfazrecord.last
      LOOP

                interfazRecord(x).punttotalPeriodo:= interfazRecord(x).puntrecoefec +
                                                   interfazRecord(x).puntpediadic +
                                                   interfazRecord(x).puntpediadic +
                                                   interfazRecord(x).ptjenroingresosefectivobase +
                                                   interfazRecord(x).ptjeingresosefectivosadicobjt +
                                                   interfazRecord(x).puntpediPeriodo +
                                                   interfazRecord(x).ptjebonificadosPeriodo;

                lsLinea :=  interfazRecord(x).codigoPeriodo         ||';'||
                interfazRecord(x).codigoConsultora      ||';'||
                interfazRecord(x).codigoConcurso        ||';'||
                interfazRecord(x).puntActiLider         ||';'||
                interfazRecord(x).totalIngresos         ||';'||
                interfazRecord(x).ingresos2pedido       ||';'||
                interfazRecord(x).ingresos3pedido       ||';'||
                interfazRecord(x).puntActiPeriodo       ||';'||
                interfazRecord(x).puntRecoEfec          ||';'||
                interfazRecord(x).puntPediAdic          ||';'||
                interfazRecord(x).puntTotalPeriodo      ||';'||
                interfazRecord(x).puntAcumConcu         ||';'||
                interfazRecord(x).puntTotalCanje        ||';'||
                interfazRecord(x).ingresosOtros2pedido  ||';'||
                interfazRecord(x).puntRecoOtros         ||';'||
                interfazRecord(x).puntPediPeriodo       ||';'||
                interfazRecord(x).nroIngresosEfectivoBase        ||';'||
                interfazRecord(x).ptjeNroIngresosEfectivoBase    ||';'||
                interfazRecord(x).nroIngresosEfectivosAdicObjt   ||';'||
                interfazRecord(x).ptjeIngresosEfectivosAdicObjt   ||';'||
                interfazRecord(x).ptjeBonificadosPeriodo  ||';'||
                interfazRecord(x).ptjePUPObjetivo    ||';'||
                interfazRecord(x).PUPObjetivoAlcanzado   ||';'||
                interfazRecord(x).unidadesRealesPUP   ||';'||
                interfazRecord(x).pedidosReales;

        utl_file.put_line(v_handle,
                          lslinea);
      END LOOP;
    END IF;
    EXIT WHEN c_interfaz%NOTFOUND;
  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbabrirutlfile THEN
    utl_file.fclose(v_handle);

    /* Procedimiento final para generar interfaz */
    gen_pkg_inter_archi.gen_pr_final_inter('SICC_DIR',
                                           lsdirtempo,
                                           psnombrearchivo,
                                           lsnombrearchivo);
  END IF;
  RETURN;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(SQLERRM,
                         1,
                         1000);
    raise_application_error(-20123,
                            'ERROR INT_PR_DAT_RESUL_CONCU_LIDER: ' || ls_sqlerrm);
END INT_PR_DAT_RESUL_CONCU_LIDER;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Ebelistas Afiliadas
                    al programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_EBELI_SESSI_EXPER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz IS
   SELECT a.cod_consu, pa.cam_inic, a.cam_afili
     FROM sse_consu_sesio_exper a, sse_progr_param_sesio b, sse_progr_anho pa
    WHERE a.cod_pais = b.cod_pais
      AND a.cod_prog = b.cod_prog
      AND a.cod_pais = psCodigoPais
      AND b.cod_marca = psCodigoMarca
      AND b.cod_canal = psCodigoCanal
      AND pa.cod_pais = b.cod_pais
      AND pa.cod_prog = b.cod_prog
      AND pa.cod_anho = substr(psCodigoPeriodo,1,4)
      AND (psCodigoPeriodo BETWEEN pa.cam_inic AND pa.cam_fin);

   TYPE interfazRec IS RECORD
   (
     codigoEbelista     mae_clien.cod_clie%TYPE,
     PeriodoInicio      seg_perio_corpo.cod_peri%TYPE,
     PeriodoAfiliacion  seg_perio_corpo.cod_peri%TYPE

   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */

        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

                  lsLinea :=  interfazRecord(x).codigoEbelista            ||';'||
                              interfazRecord(x).PeriodoInicio            ||';'||
                              interfazRecord(x).PeriodoAfiliacion;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_EBELI_SESSI_EXPER: '||ls_sqlerrm);
END INT_PR_DAT_EBELI_SESSI_EXPER;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Maestro de Productos
                    del programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PRODU_SESSI_EXPER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   --Cursos de Periodos
   CURSOR c_Periodo IS

   SELECT pa.cam_inic, pa.cam_fin
     FROM sse_progr_param_sesio a, sse_progr_produ b, sse_progr_anho pa
    WHERE a.cod_pais = pscodigopais
      AND a.cod_marca = pscodigomarca
      AND a.cod_canal = pscodigocanal
      AND b.cod_pais = a.cod_pais
      AND a.cod_prog = b.cod_prog
      AND pa.cod_pais=a.cod_pais
      AND pa.cod_prog = a.cod_prog
      AND pa.cod_anho = substr(psCodigoPeriodo,1,4)
      AND (pscodigoPeriodo BETWEEN pa.cam_inic AND pa.cam_fin)
    GROUP BY pa.cam_inic, pa.cam_fin;


   TYPE PeriodoRec IS RECORD
   (
     codigoPeriodoInicio     seg_perio_corpo.cod_peri%TYPE,
     codigoPeriodoFin        seg_perio_corpo.cod_peri%TYPE
   );

   TYPE PeriodoRecTab  IS TABLE OF PeriodoRec ;

   PeriodoRecord PeriodoRecTab;

   --Cursor de Productos
   CURSOR c_producto(lsCodigoPeriodoInicio VARCHAR2, lsCodigoPeriodoFin VARCHAR2, lnNumProductos NUMBER) IS

   SELECT b.cod_prod
     FROM sse_progr_param_sesio a, sse_progr_produ b, sse_progr_anho pa
    WHERE a.cod_pais = psCodigoPais
      AND a.cod_marca = psCodigoMarca
      AND a.cod_canal = psCodigoCanal
      AND pa.cod_pais = a.cod_pais
      AND pa.cod_prog = a.cod_prog
      AND pa.cod_pais = b.cod_pais
      AND pa.cod_prog = b.cod_prog
      AND pa.cod_anho = b.cod_anho
      AND pa.cod_anho = substr(psCodigoPeriodo,1,4)
      AND rownum <= lnNumProductos
      AND pa.cam_inic = lscodigoPeriodoinicio
      AND pa.cam_fin = lscodigoPeriodofin
      AND b.est_regi = '1';


   TYPE productoRec IS RECORD
   (
     codigoProducto     mae_produ.cod_sap%TYPE
   );
   productoRecord productoRec;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lnNumProductos      NUMBER:=5;--Numero de productos mostrados en archivo
  lnContProductos     NUMBER;
BEGIN
    /* Procedimiento inicial para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
        psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_Periodo;
      LOOP
        FETCH c_Periodo BULK COLLECT INTO PeriodoRecord LIMIT W_FILAS;
          IF PeriodoRecord.COUNT > 0 THEN
            FOR x IN PeriodoRecord.FIRST .. PeriodoRecord.LAST LOOP

              lsLinea :=  PeriodoRecord(x).codigoPeriodoInicio            ||';'||
                          PeriodoRecord(x).codigoPeriodoFin;
              lnContProductos:=0;

              OPEN c_producto(PeriodoRecord(x).codigoPeriodoInicio,PeriodoRecord(x).codigoPeriodoFin,lnNumProductos);
                LOOP
                  FETCH c_producto INTO productoRecord.codigoProducto;

                  EXIT WHEN c_producto%NOTFOUND;
                     lsLinea := lsLinea ||';'||
                                productoRecord.codigoProducto;
                     lnContProductos := lnContProductos+1;

                END LOOP;
              CLOSE c_producto;

              FOR y IN 0 .. lnNumProductos-lnContProductos-1 LOOP
                  lsLinea := lsLinea ||';'|| NULL;
              END LOOP;
              DBMS_OUTPUT.PUT_LINE(lslinea);
              UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

            END LOOP;
          END IF;
        EXIT WHEN c_Periodo%NOTFOUND;
      END LOOP;
    CLOSE c_Periodo;

    utl_file.fclose(V_HANDLE);

    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_EBELI_SESSI_EXPER: '||ls_sqlerrm);
END INT_PR_DAT_PRODU_SESSI_EXPER;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de informacion de premios que
                    fueron asignados en total
                    del programa Session Expert
Fecha Creacion    : 03/12/2007
Autor             : Jose A. Cairampoma
***************************************************************************/
PROCEDURE INT_PR_DAT_PREMI_ASIGN_TOTAL
(
  pscodigopais     VARCHAR2,
  pscodigosistema  VARCHAR2,
  pscodigointerfaz VARCHAR2,
  psnombrearchivo  VARCHAR2,
  pscodigomarca    VARCHAR2,
  pscodigocanal    VARCHAR2
) IS
  CURSOR c_interfaz IS
    SELECT prem_asig.num_conc,
           prem_asig.num_nive,
           prem_asig.num_prem,
           (SELECT p.cod_sap
              FROM inc_concu_param_gener cpg,
                   inc_param_gener_premi pgp,
                   inc_param_nivel_premi pnp,
                   inc_premi_artic       pa,
                   inc_lote_premi_artic  lpa,
                   inc_artic_lote        al,
                   mae_produ             p
             WHERE cpg.oid_para_gral = pgp.copa_oid_para_gral
               AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
               AND pnp.tpre_oid_tipo_prem = 2
               AND pnp.oid_para_nive_prem = pa.panp_oid_para_nive_prem
               AND pa.oid_prem_arti = lpa.prar_oid_prem_arti
               AND lpa.oid_lote_prem_arti = al.lopa_oid_lote_prem_arti
               AND al.prod_oid_prod = p.oid_prod
               AND cpg.oid_para_gral = prem_asig.oid_para_gral
               AND pnp.num_nive = prem_asig.num_nive
               AND lpa.num_prem = prem_asig.num_prem
               AND p.oid_prod = prem_asig.prod_oid_prod
            UNION -- se agregan los reemplazos --
            SELECT p.cod_sap
              FROM int_dat_tmp_preas_premi prx,
                   mae_produ               p
             WHERE prx.prod_oid_prod = p.oid_prod
               AND prx.oid_para_gral = prem_asig.oid_para_gral
               AND prx.num_nive = prem_asig.num_nive
               AND prx.num_prem = prem_asig.num_prem
               AND p.oid_prod = prem_asig.prod_oid_prod) AS codproducto,
           decode(prem_asig.clie_oid_clie,
                  NULL,
                  '',
                  gen_pkg_gener.gen_fn_devuelve_cod_clie(prem_asig.clie_oid_clie)) codigoebelista,
           prem_asig.val_punt_acum_alca,
           prem_asig.val_punt_exig_alca,
           (SELECT cod_sap FROM mae_produ mp WHERE mp.oid_prod = prem_desp.prod_oid_prod) codproddespachado,
           prem_asig.val_cant_prem_asig AS unidpremasig,
           gen_pkg_gener.gen_fn_devuelve_des_perio(prem_asig.oid_peri_prem_asig) Periodopremasig,
           prem_desp.val_cant_prem_desp unidpremdesp,
           gen_pkg_gener.gen_fn_devuelve_des_perio(prem_desp.oid_peri_prem_desp) Periodopremdesp
      FROM int_dat_tmp_preas_asign prem_asig,
           int_dat_tmp_preas_despa prem_desp
     WHERE prem_asig.oid_para_gral = prem_desp.oid_para_gral(+)
       AND prem_asig.num_prem = prem_desp.num_prem(+)
       AND prem_asig.prod_oid_prod = prem_desp.prod_oid_prod(+)
       AND prem_asig.clie_oid_clie = prem_desp.clie_oid_clie(+)
    UNION ALL
    SELECT -- Seccion de solicitudes que han sido reemplazadas --
     pex.num_conc codigoconcurso,
     pnp.num_nive numnivel,
     lpa.num_prem numopcion,
     po.cod_sap codproducto,
     c.cod_clie codigoebelista,
     (SELECT SUM(ccp.num_punt)
        FROM inc_cuent_corri_punto ccp
       WHERE ccp.copa_oid_para_gral = pex.oid_para_gral
         AND ccp.val_desc NOT LIKE '%Entrega de Premio%'
         AND ccp.clie_oid_clie = pex.clie_oid_clie) puntacumalcanzado,
     decode(pgp.tprm_oid_tipo_pion,
            1,
            pnp.num_cant_fija_punt,
            pnp.num_cant_inic_punt) puntexigalcanzado,
     pr.cod_sap codproddespachado,
     SUM(spor.num_unid_dema_real) unidpremasig,
     gen_pkg_gener.gen_fn_devuelve_des_perio(MIN(scor.perd_oid_peri)) Periodopremasig,
     SUM(nvl(pex.num_unid_aten,
             0)) unidpremdesp,
     gen_pkg_gener.gen_fn_devuelve_des_perio(MAX(pex.perd_oid_peri)) Periodopremdesp
      FROM int_dat_tmp_preas_solic pex,
           mae_clien               c,
           inc_param_gener_premi   pgp,
           inc_param_nivel_premi   pnp,
           inc_premi_artic         pa,
           inc_lote_premi_artic    lpa,
           inc_artic_lote          al,
           inc_reemp_artic_lote    ral,
           mae_produ               pr,
           inc_bolsa_falta         bf,
           ped_solic_cabec         scor,
           ped_solic_posic         spor,
           mae_produ               po
     WHERE pex.oid_para_gral = pgp.copa_oid_para_gral
       AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
       AND pnp.tpre_oid_tipo_prem = 2
       AND pnp.oid_para_nive_prem = pa.panp_oid_para_nive_prem
       AND pa.oid_prem_arti = lpa.prar_oid_prem_arti
       AND lpa.oid_lote_prem_arti = al.lopa_oid_lote_prem_arti
       AND al.oid_arti_lote = ral.arlo_oid_arti_lote
       AND ral.prod_oid_prod = pr.oid_prod
       AND ral.prod_oid_prod = pex.prod_oid_prod
       AND pex.clie_oid_clie = c.oid_clie
       AND pex.num_prem = lpa.num_prem
       AND bf.fec_solu IS NOT NULL
       AND bf.sopo_oid_soli_posi = spor.oid_soli_posi
       AND spor.soca_oid_soli_cabe = scor.oid_soli_cabe
       AND scor.fec_fact IS NOT NULL
       AND scor.grpr_oid_grup_proc = 5
       AND scor.copa_oid_para_gene = oid_para_gral
       AND scor.num_prem = pex.num_prem
       AND scor.clie_oid_clie = pex.clie_oid_clie
       AND spor.prod_oid_prod = po.oid_prod
       AND spor.prod_oid_prod <> pex.prod_oid_prod
     GROUP BY pex.oid_para_gral,
              pex.num_conc,
              pnp.num_nive,
              lpa.num_prem,
              po.cod_sap,
              c.cod_clie,
              pex.clie_oid_clie,
              pgp.tprm_oid_tipo_pion,
              pnp.num_cant_fija_punt,
              pnp.num_cant_inic_punt,
              pr.cod_sap;

  TYPE interfazrec IS RECORD(
    codigoconcurso      inc_concu_param_gener.num_conc%TYPE,
    numnivel            inc_param_nivel_premi.num_nive%TYPE,
    numopcion           ped_solic_cabec.num_prem%TYPE,
    codigoproducto      mae_produ.cod_sap%TYPE,
    codigoebelista      mae_clien.cod_clie%TYPE,
    puntacumalcanzado   NUMBER,
    puntexigalcanzado   NUMBER,
    codproddespachado   mae_produ.oid_prod%TYPE,
    unidpremasig        NUMBER,
    Periodoasigpremdesp seg_perio_corpo.cod_peri%TYPE,
    unidpremdesp        NUMBER,
    Periodopremdesp     seg_perio_corpo.cod_peri%TYPE);
  TYPE interfazrectab IS TABLE OF interfazrec;
  interfazrecord interfazrectab;
  /* Variables usadas para la generacion del archivo de texto */
  lsdirtempo           bas_inter.dir_temp%TYPE;
  w_filas              NUMBER := 1000;
  v_handle             utl_file.file_type;
  lslinea              VARCHAR2(1000);
  lsnombrearchivo      VARCHAR2(50);
  lnidpais             NUMBER;
  lnidmarca            NUMBER;
  lnidcanal            NUMBER;

  lbabrirutlfile       BOOLEAN;

BEGIN
  /* Generando Archivo de Texto (Detalle) */
  lnidpais  := gen_pkg_gener.gen_fn_devuelve_id_pais(pscodigopais); -- id del pais consultante
  lnidmarca := gen_pkg_gener.gen_fn_devuelve_id_marca(pscodigomarca); -- id del marca consultante
  lnidcanal := gen_pkg_gener.gen_fn_devuelve_id_canal(pscodigocanal); -- id del canal consultante

  EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_TMP_PREAS_PREMI';
  INSERT INTO int_dat_tmp_preas_premi
    (prod_oid_prod,
     num_prem,
     oid_para_gral,
     num_nive)
    SELECT ral.prod_oid_prod,
           lpa.num_prem,
           cpg.oid_para_gral,
           pnp.num_nive
      FROM inc_concu_param_gener cpg,
           inc_param_gener_premi pgp,
           inc_param_nivel_premi pnp,
           inc_premi_artic       pa,
           inc_lote_premi_artic  lpa,
           inc_artic_lote        al,
           inc_reemp_artic_lote  ral
     WHERE cpg.oid_para_gral = pgp.copa_oid_para_gral
       AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
       AND pnp.tpre_oid_tipo_prem = 2
       AND pnp.oid_para_nive_prem = pa.panp_oid_para_nive_prem
       AND pa.oid_prem_arti = lpa.prar_oid_prem_arti
       AND lpa.oid_lote_prem_arti = al.lopa_oid_lote_prem_arti
       AND al.oid_arti_lote = ral.arlo_oid_arti_lote;

  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_TMP_PREAS_PREMI',
                                cascade => TRUE);

  EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_TMP_PREAS_TIPO_SOLIC';
  INSERT INTO int_dat_tmp_preas_tipo_solic
    SELECT oid_tipo_soli_pais
      FROM ped_tipo_solic_pais tsp,
           ped_tipo_solic      ts,
           ped_clase_solic     cs
     WHERE cs.cod_clas_soli = 'I1'
       AND cs.oid_clas_soli = ts.clso_oid_clas_soli
       AND ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
       AND ind_soli_nega = 0;
  --BORRAMOS LAS TABLA TEMPORAL
  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_TMP_PREAS_TIPO_SOLIC',
                                cascade => TRUE);
  EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_INC_SOLIC_REEMP';

  --Insertamos a la tabla temporal los Oids de las solicitudes origen que han sido reemplazadas por otras
  INSERT INTO int_dat_inc_solic_reemp
    (soca_oid_soli_cabe)
    SELECT scf.oid_soli_cabe
     --, scf.perd_oid_peri, scf.tspa_oid_tipo_soli_pais,
      --  sc.oid_soli_cabe, sc.perd_oid_peri, sc.tspa_oid_tipo_soli_pais
      FROM ped_solic_cabec              scf,
           ped_solic_posic              spf,
           inc_bolsa_falta              bf,
           ped_solic_cabec              sc,
           ped_solic_posic              sp
     WHERE bf.fec_solu IS NOT NULL
       AND bf.sopo_oid_soli_posi = spf.oid_soli_posi
       AND spf.soca_oid_soli_cabe = scf.oid_soli_cabe
       AND scf.fec_fact IS NOT NULL
       AND scf.grpr_oid_grup_proc = 5
       AND sp.soca_oid_soli_cabe = sc.oid_soli_cabe
       AND sc.grpr_oid_grup_proc = 5
       AND sc.fec_fact IS NOT NULL
       AND scf.copa_oid_para_gene = sc.copa_oid_para_gene
       AND scf.num_prem = sc.num_prem
       AND scf.clie_oid_clie = sc.clie_oid_clie
       AND sp.oid_soli_posi = sopo_oid_soli_posi_reem
       AND spf.prod_oid_prod <> sp.prod_oid_prod;



  /*  SELECT scf.oid_soli_cabe
      FROM ped_solic_cabec              scf,
           ped_solic_posic              spf,
           inc_bolsa_falta              bf,
           ped_solic_cabec              sc,
           ped_solic_posic              sp,
           int_dat_tmp_preas_premi      prx,
           int_dat_tmp_preas_tipo_solic pts
     WHERE bf.fec_solu IS NOT NULL
       AND bf.sopo_oid_soli_posi = spf.oid_soli_posi
       AND scf.copa_oid_para_gene = prx.oid_para_gral
       AND spf.soca_oid_soli_cabe = scf.oid_soli_cabe
       AND scf.fec_fact IS NOT NULL
       AND scf.grpr_oid_grup_proc = 5
       AND prx.prod_oid_prod = sp.prod_oid_prod
       AND sp.soca_oid_soli_cabe = sc.oid_soli_cabe
       AND sc.copa_oid_para_gene = prx.oid_para_gral
       AND pts.oid_tipo_soli_pais = sc.tspa_oid_tipo_soli_pais
       AND sc.copa_oid_para_gene = prx.oid_para_gral
       AND sc.num_prem = prx.num_prem
       AND sc.grpr_oid_grup_proc = 5
       AND sc.fec_fact IS NOT NULL
       AND scf.copa_oid_para_gene = sc.copa_oid_para_gene
       AND scf.num_prem = sc.num_prem
       AND scf.clie_oid_clie = sc.clie_oid_clie
       AND spf.prod_oid_prod <> sp.prod_oid_prod;*/

  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_INC_SOLIC_REEMP',
                                cascade => TRUE);
  --BORRAMOS LAS TABLA TEMPORAL DE SOLICITUDES
  EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_TMP_PREAS_SOLIC';

  INSERT INTO int_dat_tmp_preas_solic
    (clie_oid_clie,
     num_prem,
     oid_soli_cabe,
     pais_oid_pais,
     perd_oid_peri,
     num_unid_dema_real,
     prod_oid_prod,
     num_unid_aten,
     oid_para_gral,
     num_conc,
     marc_oid_marc,
     cana_oid_cana)
    SELECT scx.clie_oid_clie,
           scx.num_prem,
           scx.oid_soli_cabe,
           scx.pais_oid_pais,
           scx.perd_oid_peri,
           spx.num_unid_dema_real,
           spx.prod_oid_prod,
           spx.num_unid_aten,
           cpgx.oid_para_gral,
           cpgx.num_conc,
           cpgx.marc_oid_marc,
           cpgx.cana_oid_cana
      FROM ped_solic_cabec              scx,
           ped_solic_posic              spx,
           inc_concu_param_gener        cpgx,
           int_dat_inc_concu_proce      icpx,
           int_dat_tmp_preas_tipo_solic pts
     WHERE cpgx.oid_para_gral = icpx.copa_oid_para_gral
       AND icpx.copa_oid_para_gral = scx.copa_oid_para_gene
       AND cpgx.oid_para_gral = scx.copa_oid_para_gene
       AND cpgx.pais_oid_pais = scx.pais_oid_pais
       AND scx.oid_soli_cabe = spx.soca_oid_soli_cabe
       AND scx.grpr_oid_grup_proc = 5
       AND scx.fec_fact IS NOT NULL
       AND scx.tspa_oid_tipo_soli_pais = pts.oid_tipo_soli_pais;

  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_TMP_PREAS_SOLIC',
                                cascade => TRUE);

  EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_TMP_PREAS_DESPA';
  INSERT INTO int_dat_tmp_preas_despa
    (oid_para_gral,
     num_prem,
     prod_oid_prod,
     clie_oid_clie,
     oid_peri_prem_desp,
     val_cant_prem_desp)
    SELECT pex.oid_para_gral,
           pex.num_prem,
           pex.prod_oid_prod,
           pex.clie_oid_clie,
           MAX(pex.perd_oid_peri) Periodopremdesp,
           nvl(SUM(pex.num_unid_aten),
               0) cantpredesp
      FROM int_dat_tmp_preas_solic pex
     GROUP BY pex.oid_para_gral,
              pex.num_prem,
              pex.prod_oid_prod,
              pex.clie_oid_clie;

  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_TMP_PREAS_DESPA',
                                cascade => TRUE);

 EXECUTE IMMEDIATE 'TRUNCATE TABLE INT_DAT_TMP_PREAS_ASIGN';
  INSERT INTO int_dat_tmp_preas_asign
    (oid_para_gral,
     num_conc,
     clie_oid_clie,
     num_nive,
     num_prem,
     val_punt_acum_alca,
     val_punt_exig_alca,
     prod_oid_prod,
     val_cant_prem_asig,
     oid_peri_prem_asig)
    SELECT pex.oid_para_gral oid_para_gral,
           pex.num_conc codigoconcurso,
           iga.clie_oid_clie,
           pnp.num_nive numnivel,
           pex.num_prem numopcion,
           (SELECT SUM(ccp.num_punt)
              FROM inc_cuent_corri_punto ccp
             WHERE ccp.copa_oid_para_gral = pex.oid_para_gral
               AND ccp.val_desc NOT LIKE '%Entrega de Premio%'
               AND ccp.clie_oid_clie = iga.clie_oid_clie) puntacumalcanzado,
           decode(pgp.tprm_oid_tipo_pion,
                  1,
                  pnp.num_cant_fija_punt,
                  pnp.num_cant_inic_punt) puntexigalcanzado,
           pex.prod_oid_prod,
           SUM(pex.num_unid_dema_real) cantpreasig,
           MAX(pex.perd_oid_peri) Periodopremasig
      FROM inc_ganad               iga,
           int_dat_tmp_preas_solic pex,
           inc_param_gener_premi   pgp,
           inc_param_nivel_premi   pnp
     WHERE iga.ind_desp = 1
       AND pex.pais_oid_pais = lnidpais -- <Parametro_Pais>
       AND pex.marc_oid_marc = lnidmarca -- <Parametro_Marca>
       AND pex.cana_oid_cana = lnidcanal -- <Parametro_Canal>
       AND iga.soca_oid_soli_cabe = pex.oid_soli_cabe
       AND iga.clie_oid_clie = pex.clie_oid_clie
       AND pex.oid_para_gral = pgp.copa_oid_para_gral(+)
       AND iga.soca_oid_soli_cabe = pex.oid_soli_cabe
       AND pgp.oid_para_gene_prem = pnp.pagp_oid_para_gene_prem
       AND pnp.oid_para_nive_prem = iga.panp_oid_para_nive_prem
       AND NOT EXISTS
     (SELECT 1 FROM int_dat_inc_solic_reemp WHERE pex.oid_soli_cabe = soca_oid_soli_cabe)
     GROUP BY pex.oid_para_gral,
              pex.num_conc,
              pnp.num_nive,
              pex.num_prem,
              pex.prod_oid_prod,
              pgp.tprm_oid_tipo_pion,
              pnp.num_cant_fija_punt,
              pnp.num_cant_inic_punt,
              iga.clie_oid_clie;

  dbms_stats.gather_table_stats(USER,
                                tabname => 'INT_DAT_TMP_PREAS_ASIGN',
                                cascade => TRUE);

  lbabrirutlfile := TRUE;
  OPEN c_interfaz;
  LOOP
    FETCH c_interfaz BULK COLLECT
      INTO interfazrecord LIMIT w_filas;
    /* Procedimiento inicial para generar interfaz */
    IF lbabrirutlfile THEN
      gen_pkg_inter_archi.gen_pr_inici_inter(pscodigopais,
                                             pscodigosistema,
                                             pscodigointerfaz,
                                             psnombrearchivo,
                                             lsdirtempo,
                                             lsnombrearchivo,
                                             v_handle);
      lbabrirutlfile := FALSE;
    END IF;

    IF interfazrecord.count > 0 THEN
      FOR x IN interfazrecord.first .. interfazrecord.last
      LOOP
        lslinea := interfazrecord(x).codigoconcurso || ';' || interfazrecord(x).numnivel || ';' || interfazrecord(x)
                   .numopcion || ';' || interfazrecord(x).codigoproducto || ';' || interfazrecord(x)
                   .codigoebelista || ';' || interfazrecord(x).puntacumalcanzado || ';' || interfazrecord(x)
                   .puntexigalcanzado || ';' || interfazrecord(x).codproddespachado || ';' || interfazrecord(x)
                   .unidpremasig || ';' || interfazrecord(x).Periodoasigpremdesp || ';' || interfazrecord(x)
                   .unidpremdesp || ';' || interfazrecord(x).Periodopremdesp;

        utl_file.put_line(v_handle,
                          lslinea);
      END LOOP;
    END IF;
    EXIT WHEN c_interfaz%NOTFOUND;
  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbabrirutlfile THEN
    utl_file.fclose(v_handle);

    /* Procedimiento final para generar interfaz */
    gen_pkg_inter_archi.gen_pr_final_inter('SICC_DIR',
                                           lsdirtempo,
                                           psnombrearchivo,
                                           lsnombrearchivo);
  END IF;
  RETURN;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(SQLERRM,
                         1,
                         1000);
    raise_application_error(-20123,
                            'ERROR INT_PR_DAT_PREMI_ASIGN_TOTAL: ' || ls_sqlerrm);
END INT_PR_DAT_PREMI_ASIGN_TOTAL;
/***************************************************************************
Descripcion       : Devuelve el Numero de Pedidos para la interfaz de estatus
                    Ebelistas al cierre de Periodo
Fecha Creacion    : 11/12/2007
Autor             : Jose A. Cairampoma.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_PEDID(
   pnOidPeriodo  NUMBER,
   pnOidCliente NUMBER
)
RETURN NUMBER
IS
  lnNumeropedidos NUMBER;
BEGIN
  SELECT COUNT(1)
    INTO LNNUMEROPEDIDOS
    FROM PED_SOLIC_CABEC PSC,
         PED_SOLIC_CABEC PSC1,
         PED_ESTAD_SOLIC PES,
         SEG_MODUL       SM
   WHERE PSC.SOCA_OID_SOLI_CABE = PSC1.OID_SOLI_CABE
     AND PSC1.ESSO_OID_ESTA_SOLI = PES.OID_ESTA_SOLI
     AND PES.COD_ESTA_SOLI <> 'AN'
     AND PSC.IND_OC = 1
     AND PSC.IND_TS_NO_CONSO = 1
     AND PSC.IND_PEDI_PRUE = 0
     AND PSC.MODU_OID_MODU = SM.OID_MODU
     AND SM.COD_MODU <> '15'
     AND PSC.PERD_OID_PERI = pnOidPeriodo
     AND PSC.CLIE_OID_CLIE = pnOidCliente;

  RETURN lnNumeropedidos;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_NUMER_PEDID: '||ls_sqlerrm);
END INT_FN_DEVUE_NUMER_PEDID;

/***************************************************************************
Descripcion       : Genera Interfaz Datos Adicionales Consultora (DAT-86)
Fecha Creacion    : 08/09/2008
Fecha Modidicacion: 13/07/2011
Autor             :
***************************************************************************/
PROCEDURE INT_PR_DAT_ADICI_EBELI(
   psCodigoPais    VARCHAR2,
   psCodigoSistema    VARCHAR2,
   psCodigoInterfaz   VARCHAR2,
   psNombreArchivo    VARCHAR2)
IS
  lsfechUltmProceso   DATE;
  lnOidPais           NUMBER(12);

  -- Definimos los caracteres a filtrar y reemplazar por blancos
  searchStr  VARCHAR2(100) := 'a"'',;|' || CHR(10) || CHR(13) || CHR(20);
  replaceStr VARCHAR2(100) := 'a        ';

    CURSOR c_interfaz(vsfechUltmProceso DATE) IS
        SELECT DISTINCT
               TRIM(TRANSLATE(cli.cod_clie, searchStr, replaceStr))    AS  codigoconsultora,
                   TRIM(TRANSLATE(SUBSTR(DMail.val_text_comu,1,50), searchStr, replaceStr))  AS  email,
               SUBSTR(Dfijo.val_text_comu,1,50)  AS telefonofijo,
                     SUBSTR(DCelu.val_text_comu,1,50)  AS telefonomovil,
                     SUBSTR(DTraba.val_text_comu,1,50) AS telefonotrabajo,
                     SUBSTR(DBepp.val_text_comu,1,50)  AS beeper,
                     SUBSTR(DFax.val_text_comu,1,50)   AS fax
         FROM (SELECT cli.oid_clie,
                            cli.cod_clie AS cod_clie,
                      cli.pais_oid_pais
                 FROM mae_clien cli
                WHERE NOT TRUNC (cli.fec_ulti_actu) > TRUNC (cli.fec_crea)
                   AND (vsfechUltmProceso IS NULL OR cli.fec_ulti_actu > vsfechUltmProceso)
                UNION
                   SELECT cli.oid_clie,
                                     cli.cod_clie,
                      cli.pais_oid_pais
                 FROM mae_clien cli,
                      mae_clien_vincu vin,
             mae_clien_datos_adici adi,
             mae_clien_unida_admin adm,
                      mae_estat_clien est,
                      mae_clien_direc dir,
                                  (SELECT xcom.clie_oid_clie,
                                          MAX(xcom.fec_ulti_actu) Fec_actu
                                     FROM mae_clien_comun xcom
                         GROUP BY xcom.clie_oid_clie) com
        WHERE cli.oid_clie = adi.clie_oid_clie
         AND cli.oid_clie = adm.clie_oid_clie
                 AND adi.esta_oid_esta_clie = est.oid_esta_clie(+)
                 AND cli.oid_clie = vin.clie_oid_clie_vndo(+)
         AND cli.oid_clie = dir.clie_oid_clie
                           AND cli.oid_clie =  com.clie_oid_clie
                 AND TRUNC (cli.fec_ulti_actu) > TRUNC (cli.fec_crea)
                    AND ((vsfechUltmProceso IS null) OR
                  (   cli.fec_ulti_actu > vsfechUltmProceso
                      OR adi.fec_ulti_actu > vsfechUltmProceso
                      OR adm.fec_ulti_actu > vsfechUltmProceso
                      OR vin.fec_ulti_actu > vsfechUltmProceso
                      OR est.fec_ulti_actu > vsfechUltmProceso
                      OR dir.fec_ulti_actu > vsfechUltmProceso
                      OR com.fec_actu > vsfechUltmProceso ))) cli,
                    (SELECT tcom.clie_oid_clie,
                                   tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                              mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'TF'
                        AND tcom.val_text_comu IS NOT NULL ) DFijo,
                    (SELECT tcom.clie_oid_clie,
                                     tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                              mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'ML'
                        AND tcom.val_text_comu IS NOT NULL) DMail,
                    (SELECT tcom.clie_oid_clie,
                                     tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                                  mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'TM'
                        AND tcom.val_text_comu IS NOT NULL) DCelu,
                    (SELECT tcom.clie_oid_clie,
                            tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                              mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'TT'
                        AND tcom.val_text_comu IS NOT NULL) DTraba,
                  (SELECT tcom.clie_oid_clie,
                                   tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                            mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'FX'
                   AND tcom.val_text_comu IS NOT NULL) DFax,
                  (SELECT tcom.clie_oid_clie,
                                   tcom.val_text_comu
                       FROM mae_clien_comun tcom,
                              mae_tipo_comun tc
                      WHERE tcom.ticm_oid_tipo_comu = tc.oid_tipo_comu
                        AND tc.cod_tipo_comu = 'BP'
                        AND tcom.val_text_comu IS NOT NULL) DBepp
        WHERE cli.oid_clie = DFijo.Clie_oid_clie(+)
          AND cli.oid_clie = DMail.Clie_oid_clie(+)
          AND cli.oid_clie = DCelu.clie_oid_clie(+)
          AND cli.oid_clie = DTraba.clie_oid_clie(+)
          AND cli.oid_clie = DFax.clie_oid_clie(+)
          AND cli.oid_clie = DBepp.clie_oid_clie(+)
           AND cli.pais_oid_pais = lnOidPais
        ORDER BY 1;

  TYPE interfazRec IS RECORD(
       codigoconsultora        INT_PR_REU_CONS_PROCE.COD_CLIE%TYPE,
       email                   mae_clien_comun.val_text_comu%TYPE,
       telefonofijo            mae_clien_comun.val_text_comu%TYPE,
       telefonomovil           mae_clien_comun.val_text_comu%TYPE,
             telefonotrabajo         mae_clien_comun.val_text_comu%TYPE,
             beeper                  mae_clien_comun.val_text_comu%TYPE,
             fax                     mae_clien_comun.val_text_comu%TYPE
  );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
    /* Variables usadas para la generacion del archivo de texto */
      lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
      W_FILAS             NUMBER := 1000 ;
      v_handle            UTL_FILE.FILE_TYPE;
      lsLinea             VARCHAR2(1000);
      lsNombreArchivo     VARCHAR2(50);
    lbAbrirUtlFile      BOOLEAN;

    BEGIN
      SELECT MAX(hl.fec_fpro)
        INTO lsfechUltmProceso
        FROM bas_histo_lotes hl
       WHERE hl.pais_cod_pais = pscodigopais
         AND hl.sist_cod_sist = pscodigosistema
         AND hl.inte_cod_inte = pscodigointerfaz
         AND hl.ind_loer ='N'
         AND hl.fec_fpro IS NOT NULL;

      lnOidPais:= GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(psCodigoPais);

      OPEN c_interfaz(lsfechUltmProceso);
          lbAbrirUtlFile := TRUE;
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
                 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                 lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  substr(interfazRecord(x).codigoconsultora,1,10)             ||';'||
                            substr(interfazRecord(x).email,1,50)                        ||';'||
                            substr(interfazRecord(x).telefonofijo,1,50)                 ||';'||
                            substr(interfazRecord(x).telefonomovil,1,50)                ||';'||
                            substr(interfazRecord(x).telefonotrabajo,1,50)              ||';'||
                            substr(interfazRecord(x).beeper,1,50)                       ||';'||
                            substr(interfazRecord(x).fax,1,50);
                    UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
            CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
      utl_file.fclose(V_HANDLE);

      /* Procedimiento final para generar interfaz */
      GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;

    EXCEPTION
    WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ADICI_EBELI: '||ls_sqlerrm);
END INT_PR_DAT_ADICI_EBELI;
/***************************************************************************
Descripcion       : Devuelve el tipo de cliente al que esta dirigido el concurso tomando los
                    valores de retorno de la nueva tabla INT_DAT_INC_DIRIG
Fecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION  INT_FN_DEVUE_CONCU_DIRIG(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2
IS
  lsTipoCliente VARCHAR2(1);
BEGIN
SELECT
      c.cod_diri as dirigidoA
 INTO lsTipoCliente
 FROM (SELECT cpg.oid_para_gral,
              cpg.diri_oid_diri AS dirigidoa1
         FROM inc_concu_param_gener cpg) a, -- Consultoras o Gerentes de Zona --
      (select cpg.oid_para_gral, 3 AS dirigidoa2
       from inc_clasi_concu cc, inc_concu_param_gener cpg
       where cc.cod_clas_conc = 'L'
       and cc.oid_clas_conc = cpg.ccon_oid_clas_conc -- Lideres --
       UNION ALL
       SELECT cpg.oid_para_gral, 4 AS dirigidoa2
         FROM inc_concu_param_gener cpg,
              inc_clasi_parti_concu cpc,
              inc_parti_concu_cabec pcc,
              inc_parti_concu_detal pcd,
              mae_tipo_clasi_clien tcc
        WHERE cpg.oid_para_gral = cpc.copa_oid_para_gral
          AND cpc.paci_oid_part_conc_cabe = pcc.oid_part_conc_cabe
          AND pcc.oid_part_conc_cabe = pcd.paci_oid_part_conc_cabe
          AND pcd.tccl_oid_tipo_clas = tcc.oid_tipo_clas
          AND tcc.cod_tipo_clas = '01' -- Gerentes de Region --
          AND tcc.sbti_oid_subt_clie =
         (SELECT oid_subt_clie
            FROM mae_subti_clien
           WHERE cod_subt_clie = '01'
             AND ticl_oid_tipo_clie = (SELECT oid_tipo_clie
                                         FROM mae_tipo_clien
                                        WHERE cod_tipo_clie = '04'))
                ) b,
     INT_DAT_INC_DIRIG c
WHERE a.oid_para_gral = pnOidConcurso and
a.oid_para_gral = b.oid_para_gral(+)
AND DECODE (dirigidoa2, NULL, dirigidoa1, dirigidoa2) = c.oid_diri;

  RETURN lsTipoCliente;

EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_CONCU_DIRIG: '||ls_sqlerrm);
END INT_FN_DEVUE_CONCU_DIRIG;

/***************************************************************************
Descripcion       : Devuelve el tipo de agrupacion para el concurso tomando los valores
                    indicados de la nueva tabla INT_DAT_INC_AGRU1
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION  INT_FN_DEVUE_TIPO_CONCU_AGRUP1(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2

IS
  lsTipoAgrupacion VARCHAR2(1);
BEGIN
SELECT
    c.cod_agru as agrupacion
INTO  lsTipoAgrupacion
FROM (SELECT oid_para_gral,
             DECODE (bcal_oid_base_calc, 4, 2, 1) AS agrupacion1
        FROM inc_concu_param_gener) a, -- recomendacion o ventas --
     (SELECT oid_para_gral, 3 AS agrupacion2
        FROM inc_concu_param_gener
       WHERE val_obse LIKE 'PROGRAMA%') b -- programas --
    , INT_DAT_INC_AGRU1 c
WHERE a.oid_para_gral = pnOidConcurso AND
a.oid_para_gral = b.oid_para_gral(+)
AND DECODE (agrupacion2, NULL, agrupacion1, agrupacion2) = c.oid_agru;

  RETURN lsTipoAgrupacion;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_TIPO_CONCU_AGRUP1: '||ls_sqlerrm);
END INT_FN_DEVUE_TIPO_CONCU_AGRUP1;

/***************************************************************************
Descripcion       : Devuelve el tipo de agrupacion para el concurso tomando como valores
                    de retorno los indicados en la tabla INT_DAT_INC_AGRU2
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_TIPO_CONCU_AGRUP2(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2
IS
  lsTipoAgrupacion VARCHAR2(1);
BEGIN
  select cc.cod_clas_conc
  into lsTipoAgrupacion
  from inc_clasi_concu cc, inc_concu_param_gener cpg
  where cpg.oid_para_gral = pnOidConcurso
  and cc.oid_clas_conc = cpg.ccon_oid_clas_conc;

  RETURN lsTipoAgrupacion;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_TIPO_CONCU_AGRUP2: '||ls_sqlerrm);
END INT_FN_DEVUE_TIPO_CONCU_AGRUP2;

/***************************************************************************
Descripcion       : Devuelve el estado del concurso tomando los valores de retorno de
                    la tabla INT_DAT_INC_ESTAD
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_CONCU_ESTAD(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2
IS
  lsEstado VARCHAR2(1);
BEGIN
  SELECT
        d.cod_esta as estado
  INTO lsEstado
FROM
     (-- EN PROCESO:todos los concursos por defecto --
      SELECT oid_para_gral, 1 AS proceso
        FROM inc_concu_param_gener cpg) a,
     (-- NUEVO: concursos con Periodo inicio mayor al Periodo actual --
      SELECT oid_para_gral, 1 AS nuevo
        FROM inc_concu_param_gener cpgx, cra_perio px,
             seg_perio_corpo pcx
       WHERE cpgx.perd_oid_peri_desd = px.oid_peri
         AND px.peri_oid_peri = pcx.oid_peri
         AND pcx.cod_peri >
                gen_pkg_gener.gen_fn_devuelve_perio_actu
                   (cpgx.pais_oid_pais, 'T', cpgx.cana_oid_cana)
     ) b,
     (-- CONCLUIDO: concursos cerrados --
    SELECT oid_para_gral, 1 AS concluido
        FROM inc_concu_param_gener cpgx, inc_versi_concu vc
       WHERE cpgx.oid_para_gral = vc.copa_oid_para_gral
         AND vc.vico_oid_vige_conc = 6
      ) c
    , INT_DAT_INC_ESTAD d
WHERE a.oid_para_gral =  pnOidConcurso AND
    a.oid_para_gral = b.oid_para_gral(+)
AND a.oid_para_gral = c.oid_para_gral(+)
AND DECODE (nuevo, 1, 1, DECODE (concluido, 1, 2, 3)) = d.oid_esta;

  RETURN lsEstado;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_CONCU_ESTAD: '||ls_sqlerrm);
END INT_FN_DEVUE_CONCU_ESTAD;

/***************************************************************************
Descripcion       : Devuelve el tipo de efectividad del concurso tomando los valores de
                    la tabla INT_DAT_INC_TIPO_EFECT
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_TIPO_EFECT(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2
IS
  lsTipoEfectividad VARCHAR2(1);
BEGIN
SELECT
    te.cod_tipo_efec
INTO lsTipoEfectividad
FROM
   inc_concu_param_gener cpg,
   inc_obten_punto iop,
   INT_DAT_INC_TIPO_EFECT te
WHERE cpg.oid_para_gral = pnOidConcurso and
    cpg.oid_para_gral = iop.copa_oid_para_gral
AND DECODE(iop.ind_cons, 0, 1, 2) = te.oid_tipo_efec;

  RETURN lsTipoEfectividad;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_TIPO_EFECT: '||ls_sqlerrm);
END INT_FN_DEVUE_TIPO_EFECT;

/***************************************************************************
Descripcion       : Devuelve la unidad de medida del  concurso tomando los valores de
                    la tabla INT_DAT_INC_UNIDA_MEDID
FFecha Creacion    : 30/09/2008
Autor             : Cristhian Roman
***************************************************************************/
FUNCTION   INT_FN_DEVUE_CONCU_UNIDA_MEDID(
   pnOidConcurso  NUMBER
)
RETURN VARCHAR2
IS
  lsUnidadMedida VARCHAR2(1);
BEGIN
SELECT
   max(tum.cod_tipo_unid_medi)
INTO lsUnidadMedida
FROM inc_concu_param_gener cpg,
     inc_plant_concu pc,
     INT_DAT_INC_UNIDA_MEDID tum
WHERE cpg.oid_para_gral= pnOidConcurso and
      cpg.plc2_oid_plan_conc = pc.oid_plan_conc(+)
AND DECODE (cpg.bcal_oid_base_calc,NULL, pc.bcal_oid_base_calc,cpg.bcal_oid_base_calc) =
    tum.oid_tipo_unid_medi;

RETURN lsUnidadMedida;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN NULL;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'INT_FN_DEVUE_CONCU_UNIDA_MEDID: '||ls_sqlerrm);
END INT_FN_DEVUE_CONCU_UNIDA_MEDID;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de todos los registros que abarquen
                  los Periodos del concurso desde su inicio hasta su fin,
                  incluyendo los Periodos de calculo, efectividad y despachort
Fecha Creacion    : 10/10/2008
Autor             : Cristhian Roman
***************************************************************************/
PROCEDURE INT_PR_DAT_INCEN_TIEMP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca  VARCHAR2,
   psCodigoCanal VARCHAR2)
IS
  CURSOR c_interfaz IS
    SELECT
    ct.num_conc codConcurso,
    ct.cod_peri anioCampana,
    tt.cod_tipo_tiem codTipoTiempo
FROM (
    -- Duracion de concursos --
    select cpg.oid_para_gral, cpg.num_conc, cpg.ind_acti, pc.cod_peri, 1 as tipo
    from
        inc_concu_param_gener cpg,cra_perio p, seg_perio_corpo pc
    where
        p.peri_oid_peri = pc.oid_peri
    and pc.cod_peri >= gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_desd)
    and pc.cod_peri <= gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_hast)
    union all
    -- Periodo de despacho --
    select cpg.oid_para_gral, cpg.num_conc, cpg.ind_acti,
    pc.cod_peri
       , 2 as tipo
    from
        inc_concu_param_gener cpg, inc_param_gener_premi pgp
        ,cra_perio p, seg_perio_corpo pc
    where
        cpg.oid_para_gral = pgp.copa_oid_para_gral
    and pgp.ind_peri_desp_exig = 1
    and p.peri_oid_peri = pc.oid_peri
    and (pgp.perd_oid_peri is not null and pc.cod_peri >= gen_pkg_gener.gen_fn_devuelve_des_perio(NVL(pgp.perd_oid_peri_inic,pgp.perd_oid_peri)))
    and (pgp.perd_oid_peri is not null and pc.cod_peri <= gen_pkg_gener.gen_fn_devuelve_des_perio(pgp.perd_oid_peri))
    union all
    -- Periodo de calculo --
    select cpg.oid_para_gral, cpg.num_conc, cpg.ind_acti, pc.cod_peri, 3 as tipo
    from
        inc_concu_param_gener cpg, inc_param_calif ipc, cra_perio p, seg_perio_corpo pc
    where cpg.oid_para_gral = ipc.copa_oid_para_gral
    and cpg.ind_dupl_cyzo = 1
    and p.peri_oid_peri = pc.oid_peri
    and pc.cod_peri >= gen_pkg_gener.gen_fn_devuelve_des_perio(ipc.perd_oid_peri_desd)
    and pc.cod_peri <= gen_pkg_gener.gen_fn_devuelve_des_perio(ipc.perd_oid_peri_hast)
    union all
    -- Periodo de efectividad --
    select cpg.oid_para_gral, cpg.num_conc, cpg.ind_acti, pc.cod_peri, 4 as tipo
      from inc_concu_param_gener cpg, inc_concu_param_consu cpc, cra_perio p, seg_perio_corpo pc
     where cpg.oid_para_gral = cpc.copa_oid_para_gral
    and cpg.bcal_oid_base_calc = 4
    and p.peri_oid_peri = pc.oid_peri
    and (cpc.perd_oid_peri_inic_eval is not null and pc.cod_peri >= gen_pkg_gener.gen_fn_devuelve_des_perio(cpc.perd_oid_peri_inic_eval))
    and pc.cod_peri <= per_pkg_repor_perce.per_fn_obtie_perio(gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_hast),
                                           cpg.pais_oid_pais,
                                           cpg.marc_oid_marc,
                                           cpg.cana_oid_cana,1)
    union all
    -- Periodo de Genera Cuotas --
    select cpg.oid_para_gral, cpg.num_conc, cpg.ind_acti,
    per_pkg_repor_perce.per_fn_obtie_perio(gen_pkg_gener.gen_fn_devuelve_des_perio(cpg.perd_oid_peri_desd),
                                           cpg.pais_oid_pais,
                                           cpg.marc_oid_marc,
                                           cpg.cana_oid_cana,
                                           -1) as cod_peri, 5 as tipo
    from inc_concu_param_gener cpg
            where cpg.ind_dupl_cyzo = 1
    order by oid_para_gral, cod_peri
    ) ct,
    INT_DAT_INC_TIPO_TIEMP tt
    , int_dat_inc_concu_proce icp
WHERE
    ct.tipo = tt.oid_tipo_tiem
and ct.oid_para_gral=icp.copa_oid_para_gral
ORDER BY ct.num_conc,
         tt.cod_tipo_tiem,
         ct.cod_peri;

   TYPE interfazRec IS RECORD
   (
      codConcurso              inc_concu_param_gener.num_conc%TYPE,
      anioCampana              seg_perio_corpo.cod_peri%TYPE,
      codTipoTiempo            varchar2(1)

   );
   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;
  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
BEGIN

    /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codConcurso                  ||';'||
                              interfazRecord(x).codTipoTiempo                  ||';'||
                              interfazRecord(x).anioCampana;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_INCEN_TIEMP: '||ls_sqlerrm);
END INT_PR_DAT_INCEN_TIEMP;
/**************************************************************************
  Descripcion       : Devuelve el valor del parametro de la tabla
               INT_DAT_PARAM_GENER
   Fecha Creacion    : 12/02/2009
  Parametros Entrada:
      psCodigoPais   : Codigo de pais
      psCodigoParametro   : Codigo de parametro
  Autor             : Cristhian Roman
  ***************************************************************************/
  FUNCTION INT_FN_DAT_DEVUE_PARAM_GENER
  (
    pscodigopais      VARCHAR2,
    pscodigoparametro VARCHAR2
  ) RETURN VARCHAR2 IS

    lsvalor VARCHAR2(15);

  BEGIN

    SELECT a.val_para
      INTO lsvalor
      FROM int_dat_param_gener a
     WHERE a.cod_pais = pscodigopais
       AND a.cod_para = pscodigoparametro;

    RETURN lsvalor;

  EXCEPTION
    WHEN no_data_found THEN
      RETURN '';
    WHEN OTHERS THEN
      RETURN '';

  END INT_FN_DAT_DEVUE_PARAM_GENER;
 /**************************************************************************
  Descripcion       : Devuelve el valor COPA_OID_PARA_GRAL de la tabla
               INT_DAT_INC_CONCU_PROCE
   Fecha Creacion    : 12/02/2009
  Parametros Entrada:
      psCodigoPais   : Codigo de pais
      psCodigoParametro   : Codigo de parametro
  Autor             : Cristhian Roman
  ***************************************************************************/
  FUNCTION INT_FN_DAT_OID_VIGEN_CONCU
  (
    psoidparamgral NUMBER
  ) RETURN NUMBER IS

  lsvalor NUMBER;

  BEGIN

    SELECT A.VICO_OID_VIGE_CONC
      INTO lsvalor
      FROM INT_DAT_INC_CONCU_PROCE a
     WHERE A.COPA_OID_PARA_GRAL= psoidparamgral;

    RETURN lsvalor;

  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
    WHEN OTHERS THEN
      RETURN NULL;

  END INT_FN_DAT_OID_VIGEN_CONCU;
 /***************************************************************************
Descripcion       : Carga la tabla INT_DAT_INC_CONCU_PROCE antes de la ejecucion
                     de las interfaces de datamart
Fecha Creacion    : 12/02/2009
Autor             : Cristhian Roman
***************************************************************************/
PROCEDURE INT_PR_DAT_CARGA_CONCU(pscodigopais VARCHAR2)

 IS
  CURSOR c_cargatabla IS
        SELECT cpg.oid_para_gral,
           cpg.num_conc,
           cpg.val_nomb,
           cpg.ind_acti,
           vc.vico_oid_vige_conc
      FROM inc_concu_param_gener cpg,
           inc_versi_concu       vc
     WHERE cpg.oid_para_gral = vc.copa_oid_para_gral
       AND ((ind_acti = 1 AND vc.vico_oid_vige_conc IN (1, 2)) OR
           (ind_acti = 0 AND vc.vico_oid_vige_conc = 6))
       AND cpg.oid_para_gral NOT IN
           (SELECT copa_oid_para_gral
              FROM int_dat_inc_concu_elimi);

  TYPE t_oid_para_gral IS TABLE OF inc_concu_param_gener.oid_para_gral%TYPE;
  TYPE t_num_conc IS TABLE OF inc_concu_param_gener.num_conc%TYPE;
  TYPE t_val_nomb IS TABLE OF inc_concu_param_gener.val_nomb%TYPE;
  TYPE t_ind_acti IS TABLE OF inc_concu_param_gener.ind_acti%TYPE;

  TYPE t_vico_oid_vige_conc IS TABLE OF inc_versi_concu.vico_oid_vige_conc%TYPE;

  v_oid_para_gral      t_oid_para_gral;
  v_num_conc           t_num_conc;
  v_val_nomb           t_val_nomb;
  v_ind_acti           t_ind_acti;
  v_vico_oid_vige_conc t_vico_oid_vige_conc;

  rows       NATURAL := 1000; -- Numero de filas a procesar cada vez
  j          BINARY_INTEGER := 0;
  numero     NUMBER := 0;
  diferencia NUMBER := 0;

  lsparametrodias    int_dat_param_gener.val_para%TYPE;
  lsvigenciaconcurso int_dat_inc_concu_proce.vico_oid_vige_conc%TYPE;
BEGIN

  lsparametrodias := int_pkg_datam.INT_FN_DAT_DEVUE_PARAM_GENER(pscodigopais,
                                                            'VAL_DIAS_CONC_CERR');

  DELETE FROM int_dat_inc_concu_proce a
   WHERE a.vico_oid_vige_conc <> 6;

  OPEN c_cargatabla;
  LOOP
    FETCH c_cargatabla BULK COLLECT
      INTO v_oid_para_gral, v_num_conc, v_val_nomb, v_ind_acti, v_vico_oid_vige_conc

    LIMIT rows;

    IF v_oid_para_gral.COUNT > 0 THEN
      -- Actualizamos Documentos Validados OK
      FOR j IN v_oid_para_gral.FIRST .. v_oid_para_gral.LAST
      LOOP

        BEGIN
          numero := 0;

          SELECT COUNT(1)
            INTO numero
            FROM int_dat_inc_concu_proce a
           WHERE a.copa_oid_para_gral = v_oid_para_gral(j);

          IF (numero > 0) THEN
            lsvigenciaconcurso := int_pkg_datam.INT_FN_DAT_OID_VIGEN_CONCU(v_oid_para_gral(j));

            IF (lsvigenciaconcurso = 6) THEN
              diferencia := 0;
              SELECT trunc(SYSDATE - a.fec_proc)
                INTO diferencia
                FROM int_dat_inc_concu_proce a
               WHERE a.copa_oid_para_gral = v_oid_para_gral(j);

              IF (diferencia > to_number(lsparametrodias)) THEN

                BEGIN

                  DELETE FROM int_dat_inc_concu_proce a
                   WHERE a.copa_oid_para_gral =
                         v_oid_para_gral(j);

                  INSERT INTO int_dat_inc_concu_elimi
                    (copa_oid_para_gral,
                     fec_ulti_actu)
                  VALUES
                    (v_oid_para_gral(j),
                     SYSDATE);

                END;

              END IF;

            ELSE

              DELETE FROM int_dat_inc_concu_proce a
               WHERE a.copa_oid_para_gral = v_oid_para_gral(j);

              INSERT INTO int_dat_inc_concu_proce
                (copa_oid_para_gral,
                 vico_oid_vige_conc,
                 fec_proc)
              VALUES
                (v_oid_para_gral(j),
                 v_vico_oid_vige_conc(j),
                 SYSDATE);

            END IF;

          ELSE
            INSERT INTO int_dat_inc_concu_proce
              (copa_oid_para_gral,
               vico_oid_vige_conc,
               fec_proc)
            VALUES
              (v_oid_para_gral(j),
               v_vico_oid_vige_conc(j),
               SYSDATE);

          END IF;
        END;

      END LOOP;

    END IF;
    EXIT WHEN c_cargatabla%NOTFOUND;
  END LOOP;
  CLOSE c_cargatabla;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(SQLERRM, 1, 250);
    raise_application_error(-20123,
                            'INT_PR_DAT_CARGA_CONCU: ' ||
                             ls_sqlerrm);
END INT_PR_DAT_CARGA_CONCU;

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_INGRE_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  nroIngrEfecBase NUMBER;
BEGIN

SELECT VAL_INGR_EFEC_OBJT
    INTO nroIngrEfecBase
    FROM lid_secci_ingre_efect pedi
   WHERE pedi.cod_peri = pscodigoPeriodo --- codigoPeriodo
     AND pedi.cod_clie_lide = pscodigolider ---codigo Lider
        AND IND_EFEC_CUMP=1
     AND pedi.cod_conc = psCodigoConcurso;

  RETURN nroIngrEfecBase;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_NUMER_INGRE_EFECT: '||ls_sqlerrm);
END INT_FN_DEVUE_NUMER_INGRE_EFECT;


/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje obtenido por cumplir la meta de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_INGRE_EFECT(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnpuntaje NUMBER;
BEGIN

SELECT SUM(pedi.val_punt_cump)
    INTO lnpuntaje
    FROM lid_secci_ingre_efect pedi
   WHERE pedi.ind_efec_cump = 1 --Indicador
     AND pedi.cod_peri = pscodigoPeriodo --- codigoPeriodo
     AND pedi.cod_clie_lide = pscodigolider ---codigo Lider
     AND pedi.Cod_Conc = psCodigoConcurso;
  RETURN lnpuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNTA_INGRE_EFECT: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNTA_INGRE_EFECT;

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de ingresos efectivos adicionales
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_NUMER_EFECT_ADICI(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  nroIngrEfecAdicObje NUMBER;
BEGIN

SELECT (VAL_INGR_EFEC_REAL-VAL_INGR_EFEC_OBJT)
    INTO nroIngrEfecAdicObje
    FROM lid_secci_ingre_efect pedi
   WHERE pedi.cod_peri = pscodigoPeriodo --- codigoPeriodo
     AND pedi.cod_clie_lide = pscodigolider ---codigo Lider
     and VAL_INGR_EFEC_REAL >= VAL_INGR_EFEC_OBJT
     and pedi.cod_conc = psCodigoConcurso;
  RETURN nroIngrEfecAdicObje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_NUMER_EFECT_ADICI: '||ls_sqlerrm);
END INT_FN_DEVUE_NUMER_EFECT_ADICI;

/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje obtenido por superar la meta de ingresos efectivos
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_SUPER_INGRE(
   psCodigoPeriodo  VARCHAR2,
   psCodigoConcurso VARCHAR2,
   psCodigoLider    VARCHAR2
)
RETURN NUMBER
IS
  lnpuntaje NUMBER;
BEGIN

  SELECT SUM(pedi.val_punt_supe)
    INTO lnpuntaje
    FROM lid_secci_ingre_efect pedi
   WHERE pedi.ind_efec_supe = 1 --Indicador
     AND pedi.cod_peri = pscodigoPeriodo --- codigoPeriodo
     AND pedi.cod_clie_lide = pscodigolider ---codigo Lider
     AND pedi.cod_conc = psCodigoConcurso;
  RETURN lnpuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNTA_SUPER_INGRE: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNTA_SUPER_INGRE;

----------------------------------------

/***************************************************************************
Descripcion       : Funcion que devolvera el numero de pedidos objetivos calculado
                    para la seccion en el programa de lideres
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_PEDID_OBJET_PGLID(
   psCodigoPeriodo  VARCHAR2,
   psCodRegion           VARCHAR2,
   psCodZona             VARCHAR2,
   psCodSeccion          VARCHAR2
)
RETURN NUMBER
IS
  lnNumPedObjt NUMBER;
BEGIN

select val_num_pedi_objt
  INTO lnNumPedObjt
  from lid_secci_numer_pedid lsnp
 where lsnp.cod_peri = pscodigoPeriodo -- Periodo proceso
   and lsnp.cod_regi = psCodRegion -- codigo region
   and lsnp.cod_zona = psCodZona -- codigo zona
   and lsnp.cod_secc = psCodSeccion; -- codigo seccion
  RETURN lnNumPedObjt;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PEDID_OBJET_PGLID: '||ls_sqlerrm);
END INT_FN_DEVUE_PEDID_OBJET_PGLID;


/***************************************************************************
Descripcion       : Funcion que devolvera el numero de activas finales utilizando
                    para el calculo del pedido objetivo
Fecha Creacion    : 13/03/2009
Autor             : Efrain F. Osorio.
***************************************************************************/
FUNCTION INT_FN_DEVUE_ACTIV_FINAL_PGLID(
   psCodigoPeriodo  VARCHAR2,
   psCodRegion           VARCHAR2,
   psCodZona             VARCHAR2,
   psCodSeccion          VARCHAR2
)
RETURN NUMBER
IS
  lnNumActiFinalPglid NUMBER;
BEGIN
select val_num_acti_fina
  INTO lnNumActiFinalPglid
  from lid_secci_numer_pedid lsnp
 where lsnp.cod_peri = pscodigoPeriodo -- Periodo proceso
   and lsnp.cod_regi = psCodRegion -- codigo region
   and lsnp.cod_zona = psCodZona -- codigo zona
   and lsnp.cod_secc = psCodSeccion; -- codigo seccion
  RETURN lnNumActiFinalPglid;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_ACTIV_FINAL_PGLID: '||ls_sqlerrm);
END INT_FN_DEVUE_ACTIV_FINAL_PGLID;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Clasificacion Programa
Fecha Creacion    : 02/04/2009
Autor             : Sergio Buchelli
Parametros:
          psCodigoPais  : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz  : Codigo de Interfaz
          psNombreArchivo   : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
          psCodigoPeriodo   : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_TIPO_CLASIF_PROGR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz IS
      SELECT psCodigoPeriodo aniocampana,
             lc.COD_LIDE_CLAS codclasificacion,
             lc.DES_LIDE_CLAS desclasificacion,
             lp.MIN_ACTI_FINA_SECC nroactivasexigidassecci,
     lp.MIN_ACTI_FINA_ZONA nroactivasexigidaszona,
     lp.VAL_PUNT_MINI_PROD puntMiniProd,
     ltrim(to_char(lp.VAL_RATI_CRIT,'99999990.99')) ratioCrit
     FROM LID_CLASI lc,
            LID_PARAM lp
      WHERE lc.COD_LIDE_CLAS = 'L'
        AND lp.COD_PAIS = psCodigoPais
      ORDER BY LC.COD_LIDE_CLAS;


   TYPE interfazTipo IS RECORD
   (
 aniocampana          SEG_PERIO_CORPO.COD_PERI%TYPE,
 codclasificacion         LID_CLASI.COD_LIDE_CLAS%TYPE,
 desclasificacion         LID_CLASI.DES_LIDE_CLAS%TYPE,
 nroactivasexigidassecci LID_CLASI.NUM_ACFI_EXIG_SECC%TYPE,
 nroactivasexigidaszona LID_CLASI.NUM_ACFI_EXIG_ZONA%TYPE,
 puntMiniProd LID_PARAM.VAL_PUNT_MINI_PROD%TYPE,
 ratioCrit VARCHAR2(8)
   );

 TYPE interfazTab IS TABLE OF interfazTipo ;

   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
BEGIN

      /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea := interfazRecord(x).aniocampana     ||';'||
             interfazRecord(x).codclasificacion     ||';'||
             interfazRecord(x).desclasificacion ||';'||
                              interfazRecord(x).nroactivasexigidassecci ||';'||
             interfazRecord(x).nroactivasexigidaszona ||';'||
             interfazRecord(x).puntMiniProd ||';'||
             interfazRecord(x).ratioCrit ;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_TIPO_CLASIF_PROGR: '||ls_sqlerrm);
END INT_PR_DAT_TIPO_CLASIF_PROGR;


/***************************************************************************
Descripcion : Genera Interfaz de Envio Responsable Seccion ( DAT-97 )
Fecha Creacion : 02/04/2009
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_RESPO_SECCI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz IS
   SELECT     pscodigoPeriodo aniocampana,
             zz.cod_zona codZona,
             zs.cod_secc codseccion,
          nvl( (   select  zh.gere
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null) ),'XXXXXXXXX')
         codlider,
        CASE WHEN
           (  select count(1) from let_histo_clasi_lider hc
           where hc.cam_clas =  pscodigoPeriodo ) > 0 then
          (  select  decode(hc.cod_clas_lide,'03','02',hc.cod_clas_lide)
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc, let_histo_clasi_lider hc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
            and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =   pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           and zh.gere = hc.cod_lide and pc.cod_peri = hc.cam_clas)
        ELSE
           nvl( ( select 'L' from mae_clien mc
             where mc.oid_clie = zs.clie_oid_clie ), 0)
        END codclasificacion,
        CASE WHEN
         ( select  gere
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =   pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null) ) is not null then '1'
        ELSE
          '0'
        END flagactiva,
          nvl( (   select  nvl(zh.acfi_exig_secc_nomb,0)
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
        and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =   pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null) ),0)
        nroactexigsecnombramiento,
          nvl( (   select  nvl(zh.acfi_exig_zona_nomb,0)
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
            and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           and   pr.oid_peri >= zh.perd_oid_peri_desd
           and (  pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null) ),0)
        nroactexigzonnombramiento,
            CASE WHEN (   select  nvl(zh.ind_desv_auto,0)
                from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc
                where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
				and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
                and   pr.oid_peri >= zh.perd_oid_peri_desd
                and (  pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)) > 0
            THEN 1
		   ELSE 0
        END  flagDesvAutomatica,
          CASE WHEN
           (  select count(1) from let_histo_clasi_lider hc
           where hc.cam_clas =  pscodigoPeriodo ) > 0 then
          (  select case
               when hc.cod_clas_lide  = '01'   then hc.cod_clas
               when hc.cod_clas_lide = '02'   then '02'
               when hc.cod_clas_lide = '03'   then '01'
             end  as  Subclas
           from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc, let_histo_clasi_lider hc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
            and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =   pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           and zh.gere = hc.cod_lide and pc.cod_peri = hc.cam_clas)
        ELSE
           null
        END Subclasifi,
        (  select
        pcm.cod_peri
        from zon_histo_geren zh, cra_perio pr, seg_perio_corpo pc,
        ( select gm.gere, min(gm.perd_oid_peri_desd) perdesd from zon_histo_geren gm where length(gm.ua) = 9
          group by gm.gere) minc, cra_perio prm, seg_perio_corpo pcm
        where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
				and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
        and   pr.oid_peri >= zh.perd_oid_peri_desd
        and (  pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
        and zh.gere = minc.gere
        and minc.perdesd = prm.oid_peri
        and prm.peri_oid_peri = pcm.oid_peri ) CampIni
          FROM zon_regio zr,
          zon_sub_geren_venta sgv,
          	   zon_zona zz,
          	   zon_secci zs,
               cra_perio pr, seg_perio_corpo pc
           WHERE zs.zzon_oid_zona = zz.oid_zona
           AND zz.zorg_oid_regi = zr.oid_regi
           AND zr.zsgv_oid_subg_vent = sgv.oid_subg_vent
           AND  pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =   pscodigoPeriodo
           AND ( pr.oid_peri >= zs.perd_oid_peri_inic or zs.perd_oid_peri_inic is null )
           AND ( pr.oid_peri <= zs.perd_oid_peri_fina or zs.perd_oid_peri_fina is null )
           AND zz.pais_oid_pais = zr.pais_oid_pais
           AND zz.marc_oid_marc = zr.marc_oid_marc
           AND zz.cana_oid_cana = zr.cana_oid_cana
           AND zr.pais_oid_pais = sgv.pais_oid_pais
           AND zr.marc_oid_marc = sgv.marc_oid_marc
           AND zr.cana_oid_cana = sgv.cana_oid_cana;

   TYPE interfazRespo IS RECORD
   (
         aniocampana                         SEG_PERIO_CORPO.COD_PERI%TYPE,
         codzona                                  ZON_ZONA.COD_ZONA%TYPE,
         codseccion                             ZON_SECCI .COD_SECC%TYPE,
         codlider                                  ZON_HISTO_GEREN.GERE%TYPE,
         codclasificacion                 VARCHAR2(2),
         indicadorActividad        VARCHAR2(1),
     nroactivasexigidassecci        LID_RESPO_SECCI.NUM_ACFI_EXIG_SECC_NOMB%TYPE,
     nroactivasexigidaszona         LID_RESPO_SECCI.NUM_ACFI_EXIG_ZONA_NOMB%TYPE,
     flagDesvAutomatica        ZON_HISTO_GEREN.IND_DESV_AUTO%TYPE,
     Subclasifi                VARCHAR2(2),
     CampIni                   VARCHAR2(6)
   );

         TYPE interfazTab IS TABLE OF interfazRespo;

   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
         lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
         W_FILAS NUMBER := 1000 ;
         v_handle UTL_FILE.FILE_TYPE;
         lsLinea VARCHAR2(1000);
         lbAbrirUtlFile BOOLEAN;
         lsNombreArchivo VARCHAR2(50);
BEGIN

      /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                             lsLinea := interfazRecord(x).aniocampana         ||';'||
                             interfazRecord(x).codzona                                       ||';'||
                             interfazRecord(x).codseccion                                 ||';'||
                             interfazRecord(x).codlider                                     ||';'||
                             interfazRecord(x).codclasificacion                     ||';'||
                             interfazRecord(x).indicadorActividad                 ||';'||
                             interfazRecord(x).nroactivasexigidassecci         ||';'||
                             interfazRecord(x).nroactivasexigidaszona         ||';'||
                             interfazRecord(x).flagDesvAutomatica        ||';'||
                             interfazRecord(x).Subclasifi       ||';'||
                             interfazRecord(x).Campini ;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_RESPO_SECCI: '||ls_sqlerrm);
END INT_PR_DAT_RESPO_SECCI;


/***************************************************************************
Descripcion : Genera Interfaz de Envio Ranking Lideres
Fecha Creacion : 02/04/2009
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_RANKI_LIDER
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz IS
         -- Nuevo query: --
        SELECT
         cc.COD_PERI anioCamp
         ,cc.COD_CLIE_LIDE codLider
         ,cc.IND_PROD rankCamp
         ,cp.IND_PROD rankPeri
         ,r1.DES_LIDE_RANK desRankCamp
         ,r2.DES_LIDE_RANK desRankPeri
         ,cc.NUM_PUNT_MINI puntMiniProd
         ,ltrim(to_char(cp.VAL_RATIO ,'99999990.99')) ratioCriti
         ,cc.NUM_PUNT_CAMP punRankCamp
         FROM
         LID_CRITI_CAMPA cc
         ,LID_RANKI r1
         ,LID_PERIO_CORPO pc
         ,LID_CRITI_PERIO cp
         ,LID_RANKI r2
         WHERE
         cc.COD_PERI = psCodigoPeriodo
         AND TO_NUMBER(SUBSTR(cc.COD_PERI,5,2)) >= pc.ini_peri -- 2 ultimos digitos en numero --
         AND TO_NUMBER(SUBSTR(cc.COD_PERI,5,2)) <= pc.fin_peri -- 2 ultimos digitos en numero --
         AND pc.NUM_PERI = cp.NUM_PERI
         AND SUBSTR(cc.COD_PERI,1,4) = cp.VAL_ANIO(+) -- 4 primeros digitos del Periodo --
         AND cc.COD_CLIE_LIDE = cp.COD_CLIE_LIDE(+)
         AND cc.IND_PROD = r1.COD_LIDE_RANK(+)
         AND cp.IND_PROD = r2.COD_LIDE_RANK(+);



   TYPE interfazRank IS RECORD
   (
         anioCamp                  SEG_PERIO_CORPO.COD_PERI%TYPE,
         codLider                      MAE_CLIEN.COD_CLIE%TYPE,
         rankCamp                 LID_CRITI_CAMPA.IND_PROD%TYPE,
         rankPeri                         LID_CRITI_PERIO.IND_PROD%TYPE,
         desRankCamp LID_RANKI.DES_LIDE_RANK%TYPE,
         desRankPeri LID_RANKI.DES_LIDE_RANK%TYPE,
         puntMiniProd LID_RANKI.DES_LIDE_RANK%TYPE,
         ratioCriti VARCHAR2(8),
         punRankCamp LID_CRITI_CAMPA.NUM_PUNT_CAMP%TYPE
   );

         TYPE interfazTab IS TABLE OF interfazRank;

   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
         lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
         W_FILAS NUMBER := 1000 ;
         v_handle UTL_FILE.FILE_TYPE;
         lsLinea VARCHAR2(1000);
         lbAbrirUtlFile BOOLEAN;
             lsNombreArchivo VARCHAR2(50);
BEGIN

      /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                     lsLinea := interfazRecord(x).anioCamp         ||';'||
                     interfazRecord(x).codLider                             ||';'||
                     interfazRecord(x).rankCamp                             ||';'||
                     interfazRecord(x).rankPeri                             ||';'||
                     interfazRecord(x).desRankCamp                         ||';'||
                     interfazRecord(x).desRankPeri                         ||';'||
                     interfazRecord(x).puntMiniProd                     ||';'||
                     interfazRecord(x).ratioCriti                          ||';'||
                     interfazRecord(x).punRankCamp;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
         utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_RANKI_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_RANKI_LIDER;


/***************************************************************************
Descripcion : Interfaz que envia el maestro de tipos de clasificacion del Programa de Lideres
Fecha Creacion : 07/04/2009
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
                psCodigoMarca        : Codigo Marca
                  psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_MAEST_TIPOS_CLASI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz IS
            SELECT
          LC.COD_LIDE_CLAS codclasificacion,
            LC.DES_LIDE_CLAS desclasificacion
            FROM LID_CLASI LC
            ORDER BY LC.COD_LIDE_CLAS;



   TYPE interfazTipo IS RECORD
   (  codclasificacion             LID_CLASI.COD_LIDE_CLAS%TYPE,
      desclasificacion             LID_CLASI.DES_LIDE_CLAS%TYPE
   );

   TYPE interfazTab  IS TABLE OF interfazTipo ;

   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lbAbrirUtlFile      BOOLEAN;
  lsNombreArchivo     VARCHAR2(50);
BEGIN

      /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;
        OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                  lsLinea :=  interfazRecord(x).codclasificacion          ||';'||
                              interfazRecord(x).desclasificacion ;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;
           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_MAEST_TIPOS_CLASI: '||ls_sqlerrm);
END INT_PR_DAT_MAEST_TIPOS_CLASI;

/***************************************************************************
Descripcion       : Funcion que devolvera el puntaje bonificado en la Periodo
Fecha Creacion    : 30/07/2009
Autor             : Sergio Apaza
***************************************************************************/
FUNCTION INT_FN_DEVUE_PUNTA_BONIF_PERIO(
   pnOidPeriodo     NUMBER,
   pnOidConcurso    NUMBER,
   pnOidLider       NUMBER
)
RETURN NUMBER
IS
  lnpuntaje NUMBER;
BEGIN

  SELECT SUM(inc.num_punt)
    INTO lnpuntaje
    FROM inc_cuent_corri_punto inc
   WHERE inc.perd_oid_peri = pnOidPeriodo
     AND inc.clie_oid_clie = pnOidLider
     AND inc.copa_oid_para_gral = pnOidConcurso
     AND inc.val_desc in (select des_moti_carg_punt from inc_motiv_carga_punta);

  RETURN lnpuntaje;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN 0;
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_PUNTA_BONIF_PERIO: '||ls_sqlerrm);
END INT_FN_DEVUE_PUNTA_BONIF_PERIO;

/***************************************************************************
Descripcion : Interfaz que envia el puntaje de concurso agrupado x cliente
Fecha Creacion : 07/10/2009
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
          psCodigoMarca        : Codigo Marca
          psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVI_PUNTA_CONCU
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS
   CURSOR c_interfaz(psOidConcurso NUMBER,psOidPeriodo NUMBER) IS
     SELECT A.CLIE_OID_CLIE,
            GEN_PKG_GENER.GEN_FN_DEVUELVE_COD_CLIE(a.CLIE_OID_CLIE) COD_CLIE
     FROM INC_CUENT_CORRI_PUNTO A
        WHERE A.COPA_OID_PARA_GRAL = psOidConcurso
         --AND A.PERD_OID_PERI = psOidPeriodo
        GROUP BY A.CLIE_OID_CLIE;

   TYPE interfazTipo IS RECORD
 ( oidConsultora         MAE_CLIEN.OID_CLIE%TYPE,
 codConsultora         MAE_CLIEN.COD_CLIE%TYPE
   );

 TYPE interfazTab IS TABLE OF interfazTipo ;

   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
 lnOidConcurso INC_CONCU_PARAM_GENER.OID_PARA_GRAL%TYPE;
 lsCodConcurso INC_CONCU_PARAM_GENER.NUM_CONC%TYPE;
 lnOidPeriodo INC_CONCU_PARAM_GENER.OID_PARA_GRAL%TYPE;

 lnIdPais seg_pais.oid_pais%TYPE;
 lnIdCanal seg_canal.oid_cana%TYPE;
 lnIdMarca seg_marca.oid_marc%TYPE;
 lnIdPeriodo seg_perio_corpo.oid_peri%TYPE;

 lnPuntajeVenta INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeVentaDevolucion INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeConstancia INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeConstanciaAnulacion INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeRecomendacion INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeCanje INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeBonificado INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnPuntajeAcumulado INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
  lnPuntajeOtrosCanales INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
  lnPuntajePorIncumplimiento INC_CUENT_CORRI_PUNTO.NUM_PUNT%TYPE;
 lnOidCliente         MAE_CLIEN.OID_CLIE%TYPE ;

  lnPeriodoInicio       seg_perio_corpo.oid_peri%TYPE;
  lnIdPeriodoProceso    seg_perio_corpo.oid_peri%TYPE;
  lsPeriodoDesde        seg_perio_corpo.cod_peri%TYPE;
  lsPeriodoFin          seg_perio_corpo.cod_peri%TYPE;

BEGIN

       /* obteniendos ids */
 lnIdPais := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
 lnIdCanal := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
 lnIdMarca := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);

       /* obteniendo el oid del Periodo actual con la funcion */
        --lnIdPeriodoProceso := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO( psCodigoPeriodo,lnIdMarca,lnIdCanal);

        --lnOidConcurso:=LOV_PKG_PROCE.LOV_FN_DEVUE_CONCU_VIGEN(psCodigoPais,psCodigoPeriodo);
        --SB OBTENIENDO CONCURSO VIGENTE QUE AUN NO TERMINA DESPACHAR
      BEGIN
        SELECT gen.OID_PARA_GRAL
        INTO  lnOidConcurso
        FROM INC_CONCU_PARAM_GENER gen, INC_CLASI_CONCU cla,
             INC_PARAM_GENER_PREMI pre,
             CRA_PERIO crad, SEG_PERIO_CORPO cord,
             CRA_PERIO crah, SEG_PERIO_CORPO corh
       WHERE gen.CCON_OID_CLAS_CONC = cla.Oid_Clas_Conc
         AND gen.pais_oid_pais = lnIdPais
         AND cla.cod_clas_conc = 'A'
         AND gen.ind_acti = 1
         AND pre.copa_oid_para_gral = gen.oid_para_gral
         AND gen.perd_oid_peri_desd = crad.oid_peri
         AND crad.peri_oid_peri = cord.oid_peri
         AND cord.cod_peri <= psCodigoPeriodo
         AND pre.perd_oid_peri = crah.oid_peri
         AND crah.peri_oid_peri = corh.oid_peri
         AND corh.cod_peri >= psCodigoPeriodo;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
            lnOidConcurso:=NULL;
      END;


      /* Generando Archivo de Texto (Detalle) */
        lbAbrirUtlFile := TRUE;

        IF(lnOidConcurso IS NULL) THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
               psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
        ELSE
            --Obteniendo el numero concurso, Periodo inico y fin para la interface
            SELECT NUM_CONC, PERD_OID_PERI_DESD
            INTO lsCodConcurso , lnPeriodoInicio
 FROM INC_CONCU_PARAM_GENER
 WHERE OID_PARA_GRAL=lnOidConcurso;


            /*Perido Inicio Concurso*/
             SELECT A.COD_PERI INTO lsPeriodoDesde
             FROM SEG_PERIO_CORPO A,
                  CRA_PERIO B,
                  SEG_CANAL C,
                  SEG_MARCA D
             WHERE A.OID_PERI = B.PERI_OID_PERI
             AND B.OID_PERI=lnPeriodoInicio
             AND B.CANA_OID_CANA = C.OID_CANA
             AND B.MARC_OID_MARC = D.OID_MARC
             AND C.COD_CANA = 'VD'
             AND D.COD_MARC = 'T';

             /*Periodo Fin*/
             lsPeriodoFin:=psCodigoPeriodo;


         LOOP
            EXIT WHEN lsPeriodoDesde > lsPeriodoFin;

            /* obteniendo el oid del Periodo desde con la funcion */
            lnIdPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO( lsPeriodoDesde,lnIdMarca,lnIdCanal);


            OPEN c_interfaz(lnOidConcurso,lnIdPeriodo);
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
               /* Procedimiento inicial para generar interfaz */
               IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                   psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
               END IF;


               IF interfazRecord.COUNT > 0 THEN


                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                    --oidConsultora
                    lnOidCliente:=interfazRecord(x).oidConsultora;
                    --obtenemos todos los puntajes relacionados

                    --PUNTAJE VENTA
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeVenta
                            FROM INC_CUENT_CORRI_PUNTO Z
                            WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                            AND Z.PERD_OID_PERI = lnIdPeriodo
                            AND Z.CLIE_OID_CLIE =lnOidCliente
                            AND UPPER(Z.VAL_DESC) LIKE UPPER('%Puntaje por Compras C%');

                     --PUNTAJE VENTA DEVO/ANUL
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeVentaDevolucion
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                            AND Z.PERD_OID_PERI = lnIdPeriodo
                            AND Z.CLIE_OID_CLIE =lnOidCliente
 AND (UPPER(Z.VAL_DESC) LIKE UPPER('%Puntaje por Devolucion%') OR
 UPPER(Z.VAL_DESC) LIKE UPPER('%Puntaje por Anulacion%'));

                    --PUNTAJE CONSTANCIA
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeConstancia
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) LIKE UPPER('%Puntaje por Constancia%')
                        AND Z.TMOV_OID_TIPO_MOVI = 1;

                    --PUNTAJE CONSTANCIA ANULACION
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeConstanciaAnulacion
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
 AND UPPER(Z.VAL_DESC) LIKE UPPER('%Anulacion de Puntaje por Constancia%');

                    --PUNTAJE Recomendacion
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeRecomendacion
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) LIKE UPPER('%AbonoPuntaje del PeriodoGrupo%');

                   --PUNTAJE CANJE
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeCanje
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) LIKE UPPER('%Entrega de Premio%');

                   --PUNTAJE BONIFICADO
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeBonificado
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Puntaje por Compras C%')
 AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Puntaje por Devolucion%')
 AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Puntaje por Anulacion%')
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Puntaje por Constancia%')
 AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Anulacion de Puntaje por Constancia%')
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%AbonoPuntaje del PeriodoGrupo%')
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Entrega de Premio%')
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Otros Canales%')
                        AND UPPER(Z.VAL_DESC) not LIKE UPPER('%Por incumplimiento de las Bases del Programa%');

                --PUNTAJE ACUMULADO
 SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeAcumulado
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI <= lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente;


                  ---Puntaje Otros Canales
                       SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajeOtrosCanales
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) LIKE UPPER('%Otros Canales%');

                  ---Puntaje Por Incumplimeunto
                       SELECT NVL(SUM(Z.NUM_PUNT),0) INTO lnPuntajePorIncumplimiento
                        FROM INC_CUENT_CORRI_PUNTO Z
                        WHERE Z.COPA_OID_PARA_GRAL = lnOidConcurso
                        AND Z.PERD_OID_PERI = lnIdPeriodo
                        AND Z.CLIE_OID_CLIE =lnOidCliente
                        AND UPPER(Z.VAL_DESC) LIKE UPPER('%Por incumplimiento de las Bases del Programa%');

 lsLinea := lsCodConcurso     ||';'||
                                  interfazRecord(x).codConsultora ||';'||
 lsPeriodoDesde ||';'||
 lnPuntajeVenta ||';'||
 lnPuntajeVentaDevolucion ||';'||
 lnPuntajeConstancia ||';'||
 lnPuntajeConstanciaAnulacion ||';'||
 lnPuntajeRecomendacion ||';'||
 lnPuntajeCanje ||';'||
 lnPuntajeBonificado ||';'||
                                  lnPuntajeAcumulado              ||';'||
                                  lnPuntajeOtrosCanales           ||';'||
                                  lnPuntajePorIncumplimiento;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;


               END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
            CLOSE c_interfaz;
            --obtenemos el siguiente Periodo
            lsPeriodoDesde:=PER_PKG_REPOR_PERCE.PER_FN_OBTIE_PERIO(lsPeriodoDesde,
                                                             lnIdPais,
                                                             lnIdMarca,
                                                             lnIdCanal,
                                                             1);

         END LOOP;

        END IF;
    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
    RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVI_PUNTA_CONCU: '||ls_sqlerrm);
END INT_PR_DAT_ENVI_PUNTA_CONCU;


/***************************************************************************
Descripcion : Interfaz que envia los productos de apoyo en una camapa?a
Fecha Creacion : 16/11/2009
Autor : Jesse Rios
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
         psCodigoMarca     : Codigo Marca
 psCodigoCanal     : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_APOYO
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
is

  CURSOR c_interfaz IS
Select distinct Periodo, cuv_promocion,codsap_promocion,cod_canal_venta_promocion,tipo_oferta_promocion,cuv_apoyado,codsap_apoyado,cod_canal_venta_apoyado,tipo_oferta_apoyado
from
(
 SELECT gen_pkg_gener.gen_fn_devuelve_des_perio
                                            (c.PERD_OID_PERI) Periodo,
         a.val_codi_vent cuv_promocion,
         prod.cod_sap codsap_promocion,
         '01' cod_canal_venta_promocion,
         tof.cod_tipo_ofer tipo_oferta_promocion,
         proxrango.val_codi_vent cuv_apoyado,
         proxrango.cod_sap codsap_apoyado,
         '01' cod_canal_venta_apoyado,
         proxrango.tipo_oferta tipo_oferta_apoyado
    FROM pre_ofert_detal a,
         pre_ofert b,
         pre_matri_factu_cabec c,
         cra_perio d,
         seg_perio_corpo e,
         pre_promo g,
         gen_i18n_sicc_pais gprod,
         mae_produ prod,
         pre_tipo_ofert tof,
 (SELECT h.oid_ofer, j.oid_rang_prom, l.val_codi_vent, k.cod_sap,
                   gprod.val_i18n descripcion, cat.des_cata, l.num_pagi_cata,
                   v.cod_tipo_ofer tipo_oferta
              FROM pre_ofert h,
                   pre_promo i,
                   pre_rango_promo j,
                   mae_produ k,
                   pre_ofert_detal l,
                   pre_ofert ll,
                   gen_i18n_sicc_pais gprod,
                   pre_catal cat,
                   pre_matri_factu_cabec pmfc,
                   cra_perio crap,
                   seg_perio_corpo spcorp,
                   pre_tipo_ofert v
             WHERE h.oid_ofer = i.ofer_oid_ofer
               AND i.oid_prom = j.pomo_oid_prom
               AND j.ocat_oid_cata = ll.ocat_oid_cata
               AND ll.ocat_oid_cata = cat.oid_cata
               AND l.num_pagi_cata >= j.val_desd
               AND l.num_pagi_cata <= j.val_hast
               AND j.cod_tipo_rang = 'R'
               AND ll.mfca_oid_cabe = pmfc.oid_cabe
               AND pmfc.perd_oid_peri = crap.oid_peri
               AND crap.peri_oid_peri = spcorp.oid_peri
               AND spcorp.cod_peri = psCodigoPeriodo
               AND l.prod_oid_prod = k.oid_prod
               AND j.ind_excl = 0
               AND h.mfca_oid_cabe = ll.mfca_oid_cabe
               AND ll.oid_ofer = l.ofer_oid_ofer
               AND gprod.attr_enti = 'MAE_PRODU'
               AND gprod.val_oid = k.oid_prod
               AND l.tofe_oid_tipo_ofer = v.oid_tipo_ofer
               AND k.cod_sap NOT IN (
                      SELECT p.cod_sap
                        FROM pre_ofert m,
                             pre_promo n,
                             pre_rango_promo o,
                             mae_produ p,
                             pre_ofert_detal q
                       WHERE m.oid_ofer = n.ofer_oid_ofer
                         AND n.oid_prom = o.pomo_oid_prom
                         AND o.ocat_oid_cata = q.ocat_oid_catal
                         AND q.num_pagi_cata >= o.val_desd
                         AND q.num_pagi_cata <= o.val_hast
                         AND o.cod_tipo_rang = 'R'
                         AND q.prod_oid_prod = p.oid_prod
                         AND o.ind_excl = 1
                         AND o.pomo_oid_prom = j.pomo_oid_prom)
               AND k.oid_prod NOT IN (
                      SELECT x.val_desd
                        FROM pre_rango_promo x
                       WHERE x.cod_tipo_rang = 'P'
                         AND x.ind_excl = 1
                         AND x.pomo_oid_prom = i.oid_prom)
          ORDER BY 1, 2, 3, 4) proxrango
   WHERE a.ofer_oid_ofer = b.oid_ofer
     AND b.mfca_oid_cabe = c.oid_cabe
     AND c.perd_oid_peri = d.oid_peri
     AND d.peri_oid_peri = e.oid_peri
     AND b.coes_oid_estr IN (select to_number(VAL_VALO) from DAT_PARAM_INTER where COD_INTE = 'DAT-101' and NOM_COLU = 'COES_OID_ESTR' and IND_COLU = 0)
     AND b.oid_ofer = g.ofer_oid_ofer
     AND e.cod_peri = psCodigoPeriodo
     AND proxrango.oid_ofer = b.oid_ofer
     AND a.prod_oid_prod = prod.oid_prod
     AND gprod.attr_enti = 'MAE_PRODU'
     AND gprod.val_oid = prod.oid_prod
     AND a.tofe_oid_tipo_ofer = tof.oid_tipo_ofer
     AND tof.cod_tipo_ofer IN (select VAL_VALO from DAT_PARAM_INTER where COD_INTE = 'DAT-101' and NOM_COLU = 'COD_TIPO_OFER' and IND_COLU = 0)
UNION ALL
SELECT gen_pkg_gener.gen_fn_devuelve_des_perio(c.PERD_OID_PERI) Periodo,
         a.val_codi_vent cuv_promocion,
         prod.cod_sap codsap_promocion,
         '01' cod_canal_venta_promocion,
         tof.cod_tipo_ofer tipo_oferta_promocion,
         proxrango.val_codi_vent cuv_apoyado,
         proxrango.cod_sap codsap_apoyado,
         '01' cod_canal_venta_apoyado,
         proxrango.tipo_oferta tipo_oferta_apoyado
    FROM pre_ofert_detal a,
         pre_ofert b,
         pre_matri_factu_cabec c,
         cra_perio d,
         seg_perio_corpo e,
         gen_i18n_sicc_pais gprod,
         mae_produ prod,
         pre_tipo_ofert tof,
         pre_grupo_ofert pgof,
         (SELECT h.oid_ofer, l.val_codi_vent, k.cod_sap,
                 gprod.val_i18n descripcion, l.num_pagi_cata,
                 v.cod_tipo_ofer tipo_oferta
            FROM pre_ofert h,
                 mae_produ k,
                 pre_ofert_detal l,
                 gen_i18n_sicc_pais gprod,
                 pre_matri_factu_cabec pmfc,
                 cra_perio crap,
                 seg_perio_corpo spcorp,
                 pre_tipo_ofert v,
                 pre_grupo_ofert pgof
           WHERE h.mfca_oid_cabe = pmfc.oid_cabe
             AND pgof.ofer_oid_ofer = h.oid_ofer
             AND pgof.oid_grup_ofer = l.gofe_oid_grup_ofer
             AND pgof.ind_cndo = 1
             AND pmfc.perd_oid_peri = crap.oid_peri
             AND crap.peri_oid_peri = spcorp.oid_peri
             AND spcorp.cod_peri = psCodigoPeriodo
             AND l.prod_oid_prod = k.oid_prod
             AND gprod.attr_enti = 'MAE_PRODU'
             AND gprod.val_oid = k.oid_prod
             AND l.tofe_oid_tipo_ofer = v.oid_tipo_ofer) proxrango
     WHERE a.ofer_oid_ofer = b.oid_ofer
     AND b.mfca_oid_cabe = c.oid_cabe
     AND c.perd_oid_peri = d.oid_peri
     AND d.peri_oid_peri = e.oid_peri
     AND b.coes_oid_estr IN (select to_number(VAL_VALO) from DAT_PARAM_INTER where COD_INTE = 'DAT-101' and NOM_COLU = 'COES_OID_ESTR' and IND_COLU = 1)
     AND e.cod_peri = psCodigoPeriodo
     AND pgof.ofer_oid_ofer = b.oid_ofer
     AND pgof.oid_grup_ofer = a.gofe_oid_grup_ofer
     AND pgof.ind_cndt = 1
     AND a.prod_oid_prod = prod.oid_prod
     AND gprod.attr_enti = 'MAE_PRODU'
     AND gprod.val_oid = prod.oid_prod
     AND a.tofe_oid_tipo_ofer = tof.oid_tipo_ofer
     AND tof.cod_tipo_ofer IN (select VAL_VALO from DAT_PARAM_INTER where COD_INTE = 'DAT-101' and NOM_COLU = 'COD_TIPO_OFER' and IND_COLU = 0)
     AND proxrango.oid_ofer = b.oid_ofer
     ORDER BY 1, 2, 3, 4, 5, 6, 7, 8, 9
);

     TYPE interfazTipo IS RECORD(
     anioCampana seg_perio_corpo.Cod_Peri%TYPE,
     cuv_promocion          PRE_OFERT_DETAL.val_codi_vent%TYPE,
 codsap_promocion MAE_PRODU.COD_SAP%TYPE,
     cod_canal_venta_apoyador VARCHAR2(2),
     tipo_oferta_promocion pre_tipo_ofert.COD_TIPO_OFER%TYPE,
     cuv_apoyado pre_ofert_detal.val_codi_vent%TYPE,
     codsap_apoyado mae_produ.cod_sap%TYPE,
     cod_canal_venta_apoyado VARCHAR2(2),
     tipo_oferta_apoyado pre_tipo_ofert.cod_tipo_ofer%TYPE
     );

     TYPE interfazTab IS TABLE OF interfazTipo;
     interfazRecord interfazTab;

     /* Variables usadas para la generacion del archivo de texto */
     lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
     W_FILAS NUMBER := 1000 ;
     v_handle UTL_FILE.FILE_TYPE;
     lsLinea VARCHAR2(1000);
     lbAbrirUtlFile BOOLEAN:=TRUE;
     lsNombreArchivo VARCHAR2(50);
     lnIdPais      NUMBER;
      lnIdMarca      NUMBER;
      lnIdCanal      NUMBER;
BEGIN

      lbAbrirUtlFile := TRUE;

      OPEN c_interfaz;

      LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                   psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN

              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                   lsLinea := interfazRecord(x).anioCampana ||';'||
      interfazRecord(x).cuv_promocion ||';'||
                         interfazRecord(x).tipo_oferta_promocion ||';'||
                             interfazRecord(x).codsap_promocion ||';'||
                             interfazRecord(x).cod_canal_venta_apoyador ||';'||
                              interfazRecord(x).cuv_apoyado ||';'||
                              interfazRecord(x).tipo_oferta_apoyado ||';'||
                              interfazRecord(x).codsap_apoyado ||';'||
                             interfazRecord(x).cod_canal_venta_apoyado;
                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                END LOOP;
              END IF;
              EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;

      CLOSE c_interfaz;
      IF NOT lbAbrirUtlFile THEN
      UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;
      RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PRODU_APOYO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PRODU_APOYO;

/*******************************************************************************
Descripcion : Interfaz que envia los productos reemplazados en una Periodo
Fecha Creacion : 17/11/2009
Autor : Jesse Rios
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
         psCodigoMarca     : Codigo Marca
 psCodigoCanal     : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_REEMP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS

  CURSOR c_interfaz IS
select distinct cod_peri,cuv_reemplazo,tipo_ofert_reemplazo,producto,descripcion,cuv_reemplazado,tipo_ofert_reemplazado,producto2,descripcion2
from
(
  SELECT f.cod_peri cod_peri,
       g.val_codi_vent cuv_reemplazo,
       t.cod_tipo_ofer tipo_ofert_reemplazo,
       k.cod_sap producto,
       m.val_i18n descripcion,
       c.val_codi_vent cuv_reemplazado,
       u.cod_tipo_ofer tipo_ofert_reemplazado,
       j.cod_sap producto2,
       l.val_i18n descripcion2
  FROM pre_matri_factu_cabec a,
       pre_ofert b,
       pre_ofert_detal c,
       pre_matri_factu d,
       cra_perio e,
       seg_perio_corpo f,
       pre_ofert_detal g,
       pre_matri_factu h,
       pre_matri_reemp i,
       mae_produ j,
       mae_produ k,
       gen_i18n_sicc_pais l,
       gen_i18n_sicc_pais m,
       pre_tipo_ofert t,
       pre_tipo_ofert u
 WHERE a.oid_cabe = b.mfca_oid_cabe
   AND b.oid_ofer = c.ofer_oid_ofer
   AND c.oid_deta_ofer = d.ofde_oid_deta_ofer
   AND a.perd_oid_peri = e.oid_peri
   AND i.mafa_oid_cod_ppal = d.oid_matr_fact
   AND i.mafa_oid_cod_reem = h.oid_matr_fact
   AND h.ofde_oid_deta_ofer = g.oid_deta_ofer
   AND f.oid_peri = e.peri_oid_peri
   AND f.cod_peri = psCodigoPeriodo
   AND c.prod_oid_prod = j.oid_prod
   AND j.oid_prod = l.val_oid
   AND l.attr_enti = 'MAE_PRODU'
   AND g.prod_oid_prod = k.oid_prod
   AND k.oid_prod = m.val_oid
   AND m.attr_enti = 'MAE_PRODU'
   AND g.tofe_oid_tipo_ofer = t.oid_tipo_ofer
   AND c.tofe_oid_tipo_ofer = u.oid_tipo_ofer
);

   TYPE interfazTipo IS RECORD(
     codigoPeriodo               seg_perio_corpo.COD_PERI%TYPE,
     codigoVentaReemplazo        pre_ofert_detal.val_codi_vent%TYPE,
     codigoTipoOfertaReemplazo   pre_tipo_ofert.cod_tipo_ofer%TYPE,
     codigoProductoReemplazo     mae_produ.cod_sap%TYPE,
        codigoCanalVentaReemplazo   gen_i18n_sicc_pais.val_i18n%TYPE,
     codigoVentaReemplazado      pre_ofert_detal.val_codi_vent%TYPE,
     codigoTipoOfertaReemplazado pre_tipo_ofert.cod_tipo_ofer%TYPE,
     codigoProductoReemplazado   mae_produ.cod_sap%TYPE,
        codigoCanalVentaReemplazado gen_i18n_sicc_pais.val_i18n%TYPE
   );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);
BEGIN

     lbAbrirUtlFile := TRUE;

     OPEN c_interfaz;

     LOOP
          FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                   psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN

              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                    lsLinea := interfazRecord(x).codigoPeriodo               ||';'||
                                   interfazRecord(x).codigoVentaReemplazo        ||';'||
                             interfazRecord(x).codigoTipoOfertaReemplazo   ||';'||
                             interfazRecord(x).codigoProductoReemplazo     ||';'||
                             interfazRecord(x).codigoCanalVentaReemplazo   ||';'||
                             interfazRecord(x).codigoVentaReemplazado      ||';'||
                             interfazRecord(x).codigoTipoOfertaReemplazado ||';'||
                             interfazRecord(x).codigoProductoReemplazado   ||';'||
                             interfazRecord(x).codigoCanalVentaReemplazado;
                 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
              END LOOP;

           END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;

     CLOSE c_interfaz;

     IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
     END IF;
     RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PRODU_REEMP: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PRODU_REEMP;

/*******************************************************************************
Descripcion       : Interfaz que envia los Cronogramas planificados de facturacion de las zonas
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CRONO_PLANI
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psfechaFacturacion VARCHAR2)
IS

  CURSOR c_interfaz IS
  SELECT  distinct d.cod_peri, b.cod_zona, a.fec_inic, e.cod_regi
  FROM cra_crono a, zon_zona b, cra_perio c, seg_perio_corpo d, zon_regio e
  WHERE a.zzon_oid_zona = b.oid_zona
       AND a.perd_oid_peri = c.oid_peri
     AND b.clie_oid_clie is not null
     AND c.peri_oid_peri = d.oid_peri
     AND a.cact_oid_acti =
                  (SELECT oid_acti
                     FROM cra_activ
                    WHERE pais_oid_pais = b.pais_oid_pais AND cod_acti = 'FA')
     AND ((a.fec_inic >=  TO_DATE(psfechaFacturacion,'DD/MM/YYYY')) or (d.cod_peri = psCodigoPeriodo))/*(
                     SELECT fec_proc
                     FROM bas_ctrl_fact
                     WHERE sta_camp = 0
                     AND ind_camp_act = 1
     )*/
     AND b.zorg_oid_regi = e.oid_regi
  ORDER BY 1, 2, 3;

  TYPE interfazTipo IS RECORD(
   codigoPeriodo     seg_perio_corpo.cod_peri%TYPE,
   codigoZona        zon_zona.cod_zona%TYPE,
   fechaFacturacion  cra_crono.fec_inic%TYPE,
   codigoRegion      zon_regio.cod_regi%TYPE
  );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

BEGIN

 lbAbrirUtlFile := TRUE;

 OPEN c_interfaz;

 LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

       IF lbAbrirUtlFile THEN
                  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                  lbAbrirUtlFile := FALSE;
          END IF;

       IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).codigoPeriodo    ||';'||
                               interfazRecord(x).codigoZona       ||';'||
                         to_char(interfazRecord(x).fechaFacturacion,'YYYYMMDD') ||';'||
                         interfazRecord(x).codigoRegion;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

       END IF;
       EXIT WHEN c_interfaz%NOTFOUND;
  END LOOP;

   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;
   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CRONO_PLANI: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CRONO_PLANI;


/**********************************************************************************************
Descripcion       : Interfaz que envia los motivos de transacciones post venta
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
              psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
***********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MOTIV_CDR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)

IS
  CURSOR c_interfaz IS
  SELECT d.cod_moti_devo,
  g.val_i18n,
  nvl(mm.cod_moti_homl,'00') cod_moti_homl,
  nvl(mm.des_moti_homl,'SIN HOMOLOGAR') des_moti_homl
  FROM gen_i18n_sicc_pais g,
       rec_motiv_devol d,
       int_rec_motiv_cdr_dm rm,
       int_mae_motiv_cdr_dm mm
  WHERE attr_enti = 'REC_MOTIV_DEVOL'
  AND d.oid_moti_devo = g.val_oid
  AND d.cod_moti_devo = rm.cod_moti_devo(+)
  AND rm.cod_moti_homl = mm.cod_moti_homl(+);

  TYPE interfazTipo IS RECORD(
   codigoMotivoCDR           rec_motiv_devol.cod_moti_devo%TYPE,
   descripcionMotivoCDR      gen_i18n_sicc_pais.val_i18n%TYPE,
   codigoCorporativoCDR      int_mae_motiv_cdr_dm.cod_moti_homl%TYPE,
   descripcionCorpoMotivoCDR int_mae_motiv_cdr_dm.des_moti_homl%TYPE
  );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

BEGIN
 lbAbrirUtlFile := TRUE;

 OPEN c_interfaz;

 LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

       IF lbAbrirUtlFile THEN
                  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                  lbAbrirUtlFile := FALSE;
          END IF;

       IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).codigoMotivoCDR      ||';'||
                                 interfazRecord(x).descripcionMotivoCDR ||';'||
                                 interfazRecord(x).codigoCorporativoCDR ||';'||
                                 interfazRecord(x).descripcionCorpoMotivoCDR;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

       END IF;
       EXIT WHEN c_interfaz%NOTFOUND;
   END LOOP;

   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;
   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MOTIV_CDR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MOTIV_CDR;


/*******************************************************************************
Descripcion       : Interfaz que envia los motivos de rechazo de pedidos
Fecha Creacion    : 17/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MOTIV_RECHA
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)

IS

  CURSOR c_interfaz IS
  SELECT pv.cod_vali AS codigo,
  NVL(mv.des_larg_mens, pv.des_vali) descripcion,
  nvl(mm.cod_moti_homl,'00') cod_moti_homl,
  nvl(mm.des_moti_homl,'SIN HOMOLOGAR') des_moti_homl
  FROM sto_param_valid pv,
       sto_mensa_valid mv,
       int_rec_motiv_recha_dm rm,
       int_mae_motiv_recha_dm mm
  WHERE pv.cod_tipo_docu IN ('OCC')
   AND mv.cod_vali(+) = pv.cod_vali
  AND pv.cod_vali = rm.cod_moti_rech(+)
  AND rm.cod_moti_homl = mm.cod_moti_homl(+)
 UNION ALL
 SELECT '00' AS codigo, 'SIN RECHAZO', '00','SIN RECHAZO' FROM DUAL;

  TYPE interfazTipo IS RECORD(
   codMotivoRechazoPedido     sto_param_valid.cod_vali%TYPE,
   desMotivoRechazoPedido     sto_mensa_valid.des_larg_mens%TYPE,
   codMotivoRechazoPedidoCorp int_mae_motiv_recha_dm.cod_moti_homl%TYPE,
   desMotivoRechazoPedidoCorp int_mae_motiv_recha_dm.des_moti_homl%TYPE
  );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(4000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

BEGIN

     lbAbrirUtlFile := TRUE;

     OPEN c_interfaz;

     LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

       IF lbAbrirUtlFile THEN
                  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                  lbAbrirUtlFile := FALSE;
       END IF;

       IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
               lsLinea :=  interfazRecord(x).codMotivoRechazoPedido     ||';'||
                               interfazRecord(x).desMotivoRechazoPedido     ||';'||
                         interfazRecord(x).codMotivoRechazoPedidoCorp ||';'||
                         interfazRecord(x).desMotivoRechazoPedidoCorp;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

       END IF;
       EXIT WHEN c_interfaz%NOTFOUND;
   END LOOP;

   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;
   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MOTIV_RECHA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MOTIV_RECHA;


/*******************************************************************************
Descripcion       : Interfaz que envia los motivos de rechazo de cdr
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RECHA_CDR
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)

IS

   CURSOR c_interfaz IS
   SELECT pv.cod_vali AS codigo,
   NVL (mv.des_larg_mens, pv.des_vali) descripcion,
   nvl(mm.cod_moti_homl,'00') cod_moti_homl,
   nvl(mm.des_moti_homl,'SIN HOMOLOGAR') des_moti_homl
   FROM sto_param_valid pv,
       sto_mensa_valid mv,
       int_rec_motiv_recha_dm rm,
       int_mae_motiv_recha_dm mm
   WHERE pv.cod_tipo_docu IN ('SPVC', 'SPVD')
   AND mv.cod_vali(+) = pv.cod_vali
   AND pv.cod_vali = rm.cod_moti_rech(+)
   AND rm.cod_moti_homl = mm.cod_moti_homl(+)
 UNION ALL
 SELECT '00' AS codigo, 'SIN RECHAZO', '00','SIN RECHAZO' FROM DUAL;

   TYPE interfazTipo IS RECORD(
       codMotivoRechazoPedido     sto_param_valid.cod_vali%TYPE,
       desMotivoRechazoPedido     sto_mensa_valid.des_larg_mens%TYPE,
       codMotivoRechazoPedidoCorp int_mae_motiv_recha_dm.cod_moti_homl%TYPE,
       desMotivoRechazoPedidoCorp int_mae_motiv_recha_dm.des_moti_homl%TYPE
   );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

BEGIN

     lbAbrirUtlFile := TRUE;

     OPEN c_interfaz;

     LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

       IF lbAbrirUtlFile THEN
                  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                  lbAbrirUtlFile := FALSE;
       END IF;

       IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).codMotivoRechazoPedido     ||';'||
                               interfazRecord(x).desMotivoRechazoPedido     ||';'||
                         interfazRecord(x).codMotivoRechazoPedidoCorp ||';'||
                         interfazRecord(x).desMotivoRechazoPedidoCorp;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

       END IF;
       EXIT WHEN c_interfaz%NOTFOUND;
   END LOOP;

   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;
   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RECHA_CDR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_RECHA_CDR;


/*********************************************************************
Descripcion       : Interfaz que envia los productos de recuperacion
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
**********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_RECUP
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)

IS

  CURSOR c_interfaz IS
  select distinct cod_peri, Periodo_original, cuv_que_recupera,producto, tipo_oferta_que_recupera,cod_canal_venta_recupera,cuv_a_recuperar,producto2,tipo_oferta_a_recuperar,cod_canal_venta_recuperar
from
(
  SELECT f.cod_peri cod_peri,
       (SELECT cod_peri
          FROM cra_perio cp,
               seg_perio_corpo spc,
               pre_matri_factu_cabec pmfc
          WHERE pmfc.perd_oid_peri = cp.oid_peri
           AND cp.peri_oid_peri = spc.oid_peri
           AND pmfc.oid_cabe = h.mfca_oid_cabe) Periodo_original,
       c.val_codi_vent cuv_que_recupera, j.cod_sap producto,
       u.cod_tipo_ofer tipo_oferta_que_recupera,'01' as cod_canal_venta_recupera,
       g.val_codi_vent cuv_a_recuperar, k.cod_sap producto2,
       t.cod_tipo_ofer tipo_oferta_a_recuperar,'01' as cod_canal_venta_recuperar
  FROM pre_matri_factu_cabec a,
       pre_ofert b,
       pre_ofert_detal c,
       pre_matri_factu d,
       cra_perio e,
       seg_perio_corpo f,
       pre_ofert_detal g,
       pre_matri_factu h,
       pre_matri_recup i,
       mae_produ j,
       mae_produ k,
       gen_i18n_sicc_pais l,
       gen_i18n_sicc_pais m,
       pre_tipo_ofert t,
       pre_tipo_ofert u
  WHERE a.oid_cabe = b.mfca_oid_cabe
   AND b.oid_ofer = c.ofer_oid_ofer
   AND c.oid_deta_ofer = d.ofde_oid_deta_ofer
   AND a.perd_oid_peri = e.oid_peri
   AND i.mafa_oid_cod_ppal = d.oid_matr_fact
   AND i.mafa_oid_cod_recu = h.oid_matr_fact
   AND h.ofde_oid_deta_ofer = g.oid_deta_ofer
   AND f.oid_peri = e.peri_oid_peri
   AND f.cod_peri = psCodigoPeriodo
   AND c.prod_oid_prod = j.oid_prod
   AND j.oid_prod = l.val_oid
   AND l.attr_enti = 'MAE_PRODU'
   AND g.prod_oid_prod = k.oid_prod
   AND k.oid_prod = m.val_oid
   AND m.attr_enti = 'MAE_PRODU'
   AND g.tofe_oid_tipo_ofer = t.oid_tipo_ofer
   AND c.tofe_oid_tipo_ofer = u.oid_tipo_ofer
);

   TYPE interfazTipo IS RECORD(
       anioCampana                  seg_perio_corpo.COD_PERI%TYPE,
       anioCampanaRef                seg_perio_corpo.COD_PERI%TYPE,
       codVentaRecuperacion         pre_ofert_detal.VAL_CODI_VENT%TYPE,
       codProductoRecuperacion      mae_produ.COD_SAP%TYPE,
       codTipoOfertaRecuperacion    pre_tipo_ofert.COD_TIPO_OFER%TYPE,
       codCanalVentaRecuperacion    VARCHAR2(2),
       codVentaRecuperado           pre_ofert_detal.VAL_CODI_VENT%TYPE,
       codProductoRecuperado        mae_produ.COD_SAP%TYPE,
       codTipoOfertaRecuperado      pre_tipo_ofert.COD_TIPO_OFER%TYPE,
       codCanalVentaRecuperado      VARCHAR2(2)
   );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

  /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

BEGIN

     lbAbrirUtlFile := TRUE;

     OPEN c_interfaz;

     LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

       IF lbAbrirUtlFile THEN
                  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                  lbAbrirUtlFile := FALSE;
       END IF;

       IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).anioCampana               ||';'||
                               interfazRecord(x).anioCampanaRef            ||';'||
                         interfazRecord(x).codVentaRecuperacion      ||';'||
                         interfazRecord(x).codTipoOfertaRecuperacion ||';'||
                         interfazRecord(x).codProductoRecuperacion   ||';'||
                         interfazRecord(x).codCanalVentaRecuperacion ||';'||
                         interfazRecord(x).codVentaRecuperado        ||';'||
                         interfazRecord(x).codTipoOfertaRecuperado   ||';'||
                         interfazRecord(x).codProductoRecuperado     ||';'||
                         interfazRecord(x).codCanalVentaRecuperado;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

       END IF;
       EXIT WHEN c_interfaz%NOTFOUND;
   END LOOP;

   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;
   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PRODU_RECUP: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_PRODU_RECUP;

/*********************************************************************
Descripcion       : Interfaz que envia las boletas de recojo
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psValIndiImpu    : Valor del Indicador de la Interface
**********************************************************************/

PROCEDURE INT_PR_DAT_ENVIO_BOLET_RECOJ
  (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2,
   psValIndiImpu   VARCHAR2)

IS

  CURSOR c_interfaz(vdFechaIni DATE,vdFechaFin DATE,vsValIndiImpu NUMBER) IS
  select (tt.zona||''||tt.secc) as CodSeccion,
    tt.terr as CodTerritorio,
    tt.Periodo_impresion as AnioCampanaImpresion,
    tt.Periodo_generacion as AnioCampanaGeneracion,
    count(tt.cod_cabe_bore) as NroBRImpresas,
    sum(unid_recl_br) as RealUUBRImpresas,
    sum(monto_neto) as RealVtaMNNetoBRImpresas,
    sum(ind_exitosa_1) as NroBRExito1,
    sum(unid_recl_ex_1) as RealUUBRExito1,
    sum(monto_neto_ex_1) as RealVtaMNNetoBRExito1,
    sum(ind_exitosa_2) as NroBRExito2,
    sum(unid_recl_ex_2) as RealUUBRExito2,
    sum(monto_neto_ex_2) as RealVtaMNNetoBRExito2,
    sum(ind_discrepancia_1) as NroBRExito1Discrepancia,
    sum(unid_recl_dis_1) as RealUUBRExito1Discrepancia,
    sum(monto_neto_discr_1) as RealVtaMNNetoBREx1Disc,
    sum(ind_discrepancia_2) as NroBRExito2Discrepancia,
    sum(unid_recl_dis_2) as RealUUBRExito2Discrepancia,
    sum(monto_neto_discr_2) as RealVtaMNNetoBREx2Disc,
    sum(ind_exitosa) as NroBRExito,
    sum(unid_recl_ex) as RealUUBRExito,
    sum(monto_neto_ex) as RealVtaMNNetoBRoExito,
    sum(ind_no_exitosa) as NroBRError,
    sum(unid_recl_no_exitosa) as RealUUBRError,
    sum(monto_neto_no_exitosa) as RealVtaMNNetoBRError,
    sum(ind_en_proceso) as NroBRProceso,
    sum(unid_recl_en_proceso) as RealUUBRProceso,
    sum(monto_neto_en_proceso) as RealVtaMNNetoBRProceso,
    sum(ind_no_entregada) as NroBRNoEntregadasProveedor--,
    --sum(unid_recl_no_entregada)as RealUUBRNoEntregadas,
    --sum(monto_neto_no_entregado)as RealVtaMNNetoBRNoEntregadas
    from (
    select
    GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_ZONA') ZONA,
    GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_SECC') SECC,
    GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_TERR') TERR,
    psCodigoPeriodo AS Periodo_IMPRESION,
    c.cod_peri_proc AS Periodo_GENERACION,
    c.cod_cabe_bore,
    (
        SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM INT_REC_LINEA_BOREC L,
            INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and l.REFE_COD_LINE_BORE is null
    ) unid_recl_br,
    DECODE(C.ESBO_OID_ESTA_BOR2,7,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                              val_prec_disc*(100  + vsValIndiImpu)/100
                              , 0) abono
                 FROM int_rec_linea_borec l,
                      int_rec_cabec_borec b,
                      rec_linea_opera_recla o,
                      ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) ,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0)
    ) monto_neto,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
    ) as ind_exitosa_1,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
    ),0) as unid_recl_ex_1,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex_1,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
    ) as ind_exitosa_2,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
    ),0) as unid_recl_ex_2,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex_2,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 1
    ) as ind_discrepancia_1,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 1
    ),0) as unid_recl_dis_1,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                              val_prec_disc*(100  + vsValIndiImpu)/100
                              , 0) abono
                 FROM  int_rec_linea_borec l,
                       int_rec_cabec_borec b,
                       rec_linea_opera_recla o,
                       ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 1
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 1
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) as monto_neto_discr_1,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 2
    ) as ind_discrepancia_2,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 2
    ),0) as unid_recl_dis_2,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                             val_prec_disc*(100  + vsValIndiImpu)/100
                              , 0) abono
                 FROM  int_rec_linea_borec l,
                       int_rec_cabec_borec b,
                       rec_linea_opera_recla o,
                       ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 2
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 2
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) as monto_neto_discr_2,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
    ) as ind_exitosa,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
    ),0) as unid_recl_ex,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 6
    ) as ind_no_exitosa,
    nvl((
     SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 6
        AND l.REFE_COD_LINE_BORE is null
    ),0) as unid_recl_no_exitosa,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 6
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_no_exitosa,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and ((b.ESBO_OID_ESTA_BOR1 = 3
              and b.NUM_RECO = 2)
              or
              (b.ESBO_OID_ESTA_BOR1 = 1
              and b.NUM_RECO = 1))
    ) as ind_en_proceso,
    nvl((
        SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND ((b.ESBO_OID_ESTA_BOR1 = 3
          AND b.NUM_RECO = 2)
          OR
          (b.ESBO_OID_ESTA_BOR1 = 1
          AND b.NUM_RECO = 1))
    ),0) unid_recl_en_proceso,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
        AND ((b.ESBO_OID_ESTA_BOR1 = 3
          AND b.NUM_RECO = 2)
          OR
          (b.ESBO_OID_ESTA_BOR1 = 1
          AND b.NUM_RECO = 1))
    ),0) as monto_neto_en_proceso,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 8
    ) as ind_no_entregada,
    nvl((
     SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 8
        AND l.REFE_COD_LINE_BORE is null
    ),0) as unid_recl_no_entregada,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 8
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_no_entregado
    from int_rec_cabec_borec c
    where trunc(c.FEC_INGR) <= vdFechaFin
    and trunc(c.FEC_INGR)   >= vdFechaIni
    and c.IND_ENVI_XERO = 1
    union all
    select
     GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_ZONA') ZONA,
     GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_SECC') SECC,
     GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(c.clie_oid_clie,'COD_TERR') TERR,
    psCodigoPeriodo AS Periodo_IMPRESION,
    c.cod_peri_proc AS Periodo_GENERACION,
    c.cod_cabe_bore,
    (
        SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and l.REFE_COD_LINE_BORE is null
    ) unid_recl_br,
    DECODE(C.ESBO_OID_ESTA_BOR2,7,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                              val_prec_disc*(100  + vsValIndiImpu)/100
                              , 0) abono
                 FROM  int_rec_linea_borec l,
                       int_rec_cabec_borec b,
                       rec_linea_opera_recla o,
                       ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) ,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0)
    ) monto_neto,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
    ) as ind_exitosa_1,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
    ),0) as unid_recl_ex_1,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 1
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex_1,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
    ) as ind_exitosa_2,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
    ),0) as unid_recl_ex_2,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        and b.NUM_RECO = 2
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex_2,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 1
    ) as ind_discrepancia_1,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 1
    ),0) as unid_recl_dis_1,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                              val_prec_disc*(100  + vsValIndiImpu)/100
                              , 0) abono
                 FROM  int_rec_linea_borec l,
                       int_rec_cabec_borec b,
                       rec_linea_opera_recla o,
                       ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 1
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 1
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) as monto_neto_discr_1,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 2
    ) as ind_discrepancia_2,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 7
        and b.NUM_RECO = 2
    ),0) as unid_recl_dis_2,
    nvl((
    SELECT ( SUM(cargo) - SUM(abono) )
         FROM (
         SELECT L.COD_CABE_BORE,decode(L.num_unid_recl, 0, 0,
                             (L.num_unid_recl -
                              decode(l.ind_disc, 1, 0, l.num_unid_reco)) *
                              (decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA))) cargo,
                      decode(L.num_unid_recl, 0,
                             decode(l.ind_disc, 1, 0, l.num_unid_reco) *
                             val_prec_disc*(100  + vsValIndiImpu)/100, 0) abono
                 FROM  int_rec_linea_borec l,
                       int_rec_cabec_borec b,
                       rec_linea_opera_recla o,
                       ped_solic_posic p
                WHERE l.cod_cabe_bore = B.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.refe_cod_line_bore IS NULL
                  AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
                  AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 2
               UNION ALL
               SELECT L.COD_CABE_BORE,0 cargo,
                      decode(L.num_unid_recl, 0, 0,
                             L.num_unid_reco * val_prec_disc*(100  + vsValIndiImpu)/100
                             ) abono
                 FROM  int_rec_cabec_borec b,
                       int_rec_linea_borec l
                WHERE b.cod_cabe_bore = l.cod_cabe_bore
                  AND l.prod_oid_prod IS NOT NULL
                  AND l.prod_oid_prod_disc IS NOT NULL
                  and b.ESBO_OID_ESTA_BOR1 = 4
                  and b.ESBO_OID_ESTA_BOR2 = 7
                  and b.NUM_RECO = 2
                  ) a
    WHERE A.COD_CABE_BORE = C.COD_CABE_BORE
    ),0) as monto_neto_discr_2,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
    ) as ind_exitosa,
    nvl((
        SELECT SUM(L.NUM_UNID_RECO)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
    ),0) as unid_recl_ex,
    nvl((
    SELECT SUM(L.NUM_UNID_RECO*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 5
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_ex,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 6
    ) as ind_no_exitosa,
    nvl((
     SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 6
        AND l.REFE_COD_LINE_BORE is null
    ),0) as unid_recl_no_exitosa,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 6
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_no_exitosa,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and ((b.ESBO_OID_ESTA_BOR1 = 3
              and b.NUM_RECO = 2)
              or
              (b.ESBO_OID_ESTA_BOR1 = 1
              and b.NUM_RECO = 1))
    ) as ind_en_proceso,
    nvl((
        SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND ((b.ESBO_OID_ESTA_BOR1 = 3
          AND b.NUM_RECO = 2)
          OR
          (b.ESBO_OID_ESTA_BOR1 = 1
          AND b.NUM_RECO = 1))
    ),0) unid_recl_en_proceso,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
        AND ((b.ESBO_OID_ESTA_BOR1 = 3
          AND b.NUM_RECO = 2)
          OR
          (b.ESBO_OID_ESTA_BOR1 = 1
          AND b.NUM_RECO = 1))
    ),0) as monto_neto_en_proceso,
    (
        select count(*)
        from  int_rec_cabec_borec b
        where b.COD_CABE_BORE = c.cod_cabe_bore
        and b.ESBO_OID_ESTA_BOR1 = 4
        and b.ESBO_OID_ESTA_BOR2 = 8
    ) as ind_no_entregada,
    nvl((
     SELECT SUM(L.NUM_UNID_RECL-L.NUM_UNID_elim)
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 8
        AND l.REFE_COD_LINE_BORE is null
    ),0) as unid_recl_no_entregada,
    nvl((
    SELECT SUM((L.NUM_UNID_RECL-L.NUM_UNID_elim)*(decode(p.val_prec_cata_unit_loca,0,0,p.VAL_PREC_NETO_UNIT_LOCA)))
        FROM  INT_REC_LINEA_BOREC L,
             INT_REC_CABEC_BOREC B,
             rec_linea_opera_recla o,
             ped_solic_posic p
        WHERE L.COD_CABE_BORE = c.cod_cabe_bore
        AND B.COD_CABE_BORE = L.COD_CABE_BORE
        AND b.ESBO_OID_ESTA_BOR1 = 4
        AND b.ESBO_OID_ESTA_BOR2 = 8
        AND l.REFE_COD_LINE_BORE is null
        AND l.LOR_OID_LINE_OPER_RECL = o.OID_LINE_OPER_RECL
        AND o.SOPO_OID_SOLI_POSI = p.OID_SOLI_POSI
    ),0) as monto_neto_no_entregado
    from  int_rec_cabec_borec c
    where trunc(c.FEC_ING2) <= vdFechaFin
    and trunc(c.FEC_ING2) >= vdFechaIni
    and c.FEC_ING2 IS NOT NULL
    and c.IND_ENVI_XER2 = 1
    ) tt
    group by tt.zona,tt.secc,
        tt.terr,
        tt.Periodo_impresion,
        tt.Periodo_generacion
    order by 1,3,4,2;

    TYPE interfazTipo IS RECORD(
       codSeccion                                    VARCHAR2(7),

       CodTerritorio                                 VARCHAR2(10),

       anioCampanaImpresion                          VARCHAR(6),

       anioCampanaGeneracion                         VARCHAR(6),

       nroBoletasRecojoImpresas                      int_rec_cabec_borec.cod_cabe_bore%TYPE,

       realUUBoletaRecojoImpresas                    INT_REC_LINEA_BOREC.NUM_UNID_RECL%TYPE,

       realVtaMNNetoBoletaRecojoImpr                 ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecojoExito1                         NUMBER,

       realUUBoletaRecojoExito1                      INT_REC_LINEA_BOREC.NUM_UNID_RECO%TYPE,

       realVtaMNNetoBoletaRecoExit1                  ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecojoExito2                         NUMBER,

       realUUBoletaRecojoExito2                      INT_REC_LINEA_BOREC.NUM_UNID_RECO%TYPE,

       realVtaMNNetoBoletaRecoExit2                  ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletasRecoExit1Discrepa                   NUMBER,

       realUUBoletaRecoExit1Discrepa                 INT_REC_LINEA_BOREC.NUM_UNID_RECO%TYPE,

       realVtaMNNetBoleRecoExit1Discr                ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecoExit2Discrepa                    NUMBER,

       realUUBoletaRecoExit2Discrepa                 INT_REC_LINEA_BOREC.NUM_UNID_RECO%TYPE,

       realVtaMNNetBoleRecoExit2Discr                ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecojoExito                          NUMBER,

       realUUBoletaRecojoExito                       INT_REC_LINEA_BOREC.NUM_UNID_RECO%TYPE,

       realVtaMNNetoBoletaRecojoExito                ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecojoError                          NUMBER,

       realUUBoletaRecojoError                       INT_REC_LINEA_BOREC.NUM_UNID_RECL%TYPE,

       realVtaMNNetoBoletaRecojoError                ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecojoProceso                        NUMBER,

       realUUBoletaRecojoProceso                     INT_REC_LINEA_BOREC.NUM_UNID_RECL%TYPE,

       realVtaMNNetoBoletaRecoProc                   ped_solic_posic.val_prec_cata_unit_loca%TYPE,

       nroBoletaRecoEntregProve                      NUMBER
   );

   TYPE interfazTab  IS TABLE OF interfazTipo;
   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000;
   V_HANDLE            UTL_FILE.FILE_TYPE;
   lsLinea             VARCHAR2(1000);
   lbAbrirUtlFile      BOOLEAN:=TRUE;
   lsNombreArchivo     VARCHAR2(50);

   ldFechaIni          DATE;
   ldFechaFin          DATE;
   lnValTasaImpu       PED_TASA_IMPUE.val_tasa_impu%TYPE;

BEGIN

     select c.FEC_INIC,c.FEC_FINA into ldFechaIni,ldFechaFin
     from cra_perio c,
          seg_perio_corpo s
     where s.OID_PERI = c.PERI_OID_PERI
     and s.COD_PERI = psCodigoPeriodo;

     begin
           select val_tasa_impu into lnValTasaImpu
           from  PED_TASA_IMPUE
           where val_indi_impu = psValIndiImpu;
     EXCEPTION
     WHEN NO_DATA_FOUND THEN
           lnValTasaImpu := 0;
     end;

     OPEN c_interfaz(ldFechaIni,ldFechaFin,lnValTasaImpu);

     LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

            IF lbAbrirUtlFile THEN
            GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
            psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
            lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).codSeccion                      ||';'||
                               interfazRecord(x).CodTerritorio                   ||';'||
                         interfazRecord(x).anioCampanaImpresion            ||';'||
                         interfazRecord(x).anioCampanaGeneracion           ||';'||
                         interfazRecord(x).nroBoletasRecojoImpresas        ||';'||
                         interfazRecord(x).realUUBoletaRecojoImpresas      ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecojoImpr   ||';'||
                         interfazRecord(x).nroBoletaRecojoExito1           ||';'||
                         interfazRecord(x).realUUBoletaRecojoExito1        ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecoExit1    ||';'||
                         interfazRecord(x).nroBoletaRecojoExito2           ||';'||
                         interfazRecord(x).realUUBoletaRecojoExito2        ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecoExit2    ||';'||
                         interfazRecord(x).nroBoletasRecoExit1Discrepa     ||';'||
                         interfazRecord(x).realUUBoletaRecoExit1Discrepa   ||';'||
                         interfazRecord(x).realVtaMNNetBoleRecoExit1Discr  ||';'||
                         interfazRecord(x).nroBoletaRecoExit2Discrepa      ||';'||
                         interfazRecord(x).realUUBoletaRecoExit2Discrepa   ||';'||
                         interfazRecord(x).realVtaMNNetBoleRecoExit2Discr  ||';'||
                         interfazRecord(x).nroBoletaRecojoExito            ||';'||
                         interfazRecord(x).realUUBoletaRecojoExito         ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecojoExito  ||';'||
                         interfazRecord(x).nroBoletaRecojoError            ||';'||
                         interfazRecord(x).realUUBoletaRecojoError         ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecojoError  ||';'||
                         interfazRecord(x).nroBoletaRecojoProceso          ||';'||
                         interfazRecord(x).realUUBoletaRecojoProceso       ||';'||
                         interfazRecord(x).realVtaMNNetoBoletaRecoProc     ||';'||
                         interfazRecord(x).nroBoletaRecoEntregProve;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

         END IF;

       EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;

     CLOSE c_interfaz;

     IF NOT lbAbrirUtlFile THEN
         UTL_FILE.FCLOSE(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
        END IF;

     RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_BOLET_RECOJ: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_BOLET_RECOJ;

/*********************************************************************
Descripcion       : Funcion para transformar a CDR
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psTipoRefe     : Tipo de Referencia

**********************************************************************/
FUNCTION INT_FN_DAT_TRANS_CDR(psTipoRefe  VARCHAR2)
RETURN VARCHAR2

IS
  lsCodOperHomol INT_REC_OPERA_HOMOL_DM.COD_OPER_HOML%TYPE;

BEGIN
	 --select distinct r.COD_OPER_HOML
   select distinct decode(r.COD_OPER_HOML,'F','R',r.COD_OPER_HOML)
     into lsCodOperHomol
     from INT_MAE_OPERA_HOMOL_DM m,
           INT_REC_OPERA_HOMOL_DM r
     where r.COD_OPER_HOML = m.COD_OPER_HOML
     and r.cod_oper = psTipoRefe
     and r.cod_tipo_oper = '01';

     RETURN lsCodOperHomol;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DAT_TRANS_CDR: '||ls_sqlerrm);
END INT_FN_DAT_TRANS_CDR;

/*********************************************************************
Descripcion       : Funcion para obtener Motivo de CDR homologado
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psMotSPV     : Motivo SPV

**********************************************************************/
FUNCTION INT_FN_DAT_MOTIV_CDR(psMotSPV  VARCHAR2)
RETURN VARCHAR2
IS

  lsCodMotiHomol INT_REC_MOTIV_CDR_DM.COD_MOTI_HOML%TYPE;
BEGIN

  select distinct r.COD_MOTI_HOML
  into lsCodMotiHomol
  from INT_MAE_MOTIV_CDR_DM m,
       INT_REC_MOTIV_CDR_DM r
  where m.COD_MOTI_HOML = r.COD_MOTI_HOML
  and r.COD_MOTI_DEVO = psMotSPV;

  RETURN lsCodMotiHomol;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '08';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DAT_MOTIV_CDR: '||ls_sqlerrm);
END INT_FN_DAT_MOTIV_CDR;


/*********************************************************************
Descripcion       : Funcion para obtener motivo de rechazo de mayor prioridad
Fecha Creacion    : 19/11/2009
Autor             : Jesse Rios
Parametros:
          psTipoDocuDeta     : Tipo de Documento Detalle
          psTipoDocuCabe     : Tipo de Documento Cabecera
          pnSecNumeDocu     : Numero de Documento

**********************************************************************/
FUNCTION INT_FN_DAT_MOTIV_RECHA_PRIOR(
   psTipoDocuDeta  VARCHAR2,
   psTipoDocuCabe  VARCHAR2,
   pnSecNumeDocu   NUMBER
)
RETURN VARCHAR2
IS

  lsCodVali STO_DETAL_DOCUM_EXCEP.COD_VALI%TYPE;

BEGIN

        SELECT tt.cod_vali
        INTO lscodvali
        FROM
        (
        SELECT PSV.COD_VALI,psv.num_secu
        FROM
        (
        SELECT cod_vali
        FROM STO_DETAL_DOCUM_EXCEP
        WHERE sec_nume_docu = pnsecnumedocu
        and COD_TIPO_DOCU =  pstipodocudeta
        UNION ALL
        SELECT cod_vali
        FROM STO_HISTO_DETAL_DOCUM_EXCEP
        WHERE sec_nume_docu = pnsecnumedocu
        and COD_TIPO_DOCU =  pstipodocudeta
        UNION ALL
        SELECT cod_vali
        FROM STO_DETAL_DOCUM_EXCEP
        WHERE sec_nume_docu = (SELECT sec_nume_docu_cabe
                               FROM sto_docum_digit
                               WHERE sec_nume_docu = pnsecnumedocu)
        and COD_TIPO_DOCU =  pstipodocucabe
        UNION ALL
        SELECT cod_vali
        FROM STO_HISTO_DETAL_DOCUM_EXCEP
        WHERE sec_nume_docu = (SELECT sec_nume_docu_cabe
                               FROM sto_histo_docum_digit
                               WHERE sec_nume_docu = pnsecnumedocu)
        and COD_TIPO_DOCU =  pstipodocucabe
        ) T_AUX_VALI,
        sto_param_secue_valid       psv
        WHERE PSV.COD_VALI = T_AUX_VALI.COD_VALI
        ORDER BY PSV.num_secu ASC) tt
        WHERE rownum = 1;

  RETURN lsCodVali;
EXCEPTION
WHEN NO_DATA_FOUND  THEN
     RETURN '00';
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DAT_TRANS_CDR: '||ls_sqlerrm);
END INT_FN_DAT_MOTIV_RECHA_PRIOR;

/***************************************************************************
Descripcion       : Interfaz que envia detalles de los documentos post venta
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoDetalle : Tipo de Documento Detalle
          psTipoDocumentoCabecera : Tipo de Documento Cabecera
**************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DETAL_POSTV
(
  pscodigopais            VARCHAR2,
  pscodigosistema         VARCHAR2,
  pscodigointerfaz        VARCHAR2,
  psnombrearchivo         VARCHAR2,
  pscodigomarca           VARCHAR2,
  pscodigocanal           VARCHAR2,
  pscodigoPeriodo         VARCHAR2,
  pstipodocumentodetalle  VARCHAR2,
  pstipodocumentocabecera VARCHAR2,
  psfechafacturacion      VARCHAR2
)

 IS

  CURSOR c_interfaz
  (
    vscodigopais            VARCHAR2,
    vstipodocumentodetalle  VARCHAR2,
    vstipodocumentocabecera VARCHAR2,
    v_factorimpuesto        NUMBER,
    ldFechaIni DATE,
    ldFechaFin DATE,
    lsOidPeriodo NUMBER,
    vnIdTipoPedido NUMBER,
    lsFechaBasCtrlFact varchar2,
    lsvalpain varchar2
  ) IS

    SELECT *
      FROM (SELECT ---c.cod_peri aniocampana,
         DECODE
            (c.oid_peri_recl,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_recl)
            ) aniocampana,
       decode(c.oid_peri_refe,
              NULL,
              c.cod_peri,
              gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_refe)) aniocampanaref,
       c.sec_nume_docu AS nrodocpostventa,
       m.cod_clie AS codebelista,
       int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) AS tipopostventa,
       d.num_line AS nrolineatipopostventa,
       int_pkg_datam.int_fn_dat_motiv_recha_prior(vstipodocumentodetalle,
                                                  vstipodocumentocabecera,
                                                  d.sec_nume_docu) AS codmotivorechazopostventa, -- invocar funcion para obtener rechazo de mayor prioridad arriba especificada
       case when dg.ind_envi ='1' then
         'A'
         else
           'R'
         END estadodocpostventa,
       lpad(TRIM(to_char(to_number(cod_vent_devu))),
            5,
            '0') AS codventacdr,
       (SELECT cod_tipo_ofer FROM pre_tipo_ofert WHERE oid_tipo_ofer = d.tofe_oid_devu) AS codtipoofertacdr,
       (SELECT cod_sap FROM mae_produ WHERE oid_prod = d.prod_oid_prod_devu) AS codproductocdr,
       '01' AS codcanalventacdr,
       int_pkg_datam.int_fn_dat_motiv_cdr(d.mot_spv) AS codmotivocdr,
       lpad(TRIM(to_char(to_number(cod_vent_dese))),
            5,
            '0') AS codventasolicitado,
       (SELECT cod_tipo_ofer FROM pre_tipo_ofert WHERE oid_tipo_ofer = d.tofe_oid_envi) AS codtipoofertasolicitado,
       (SELECT cod_sap FROM mae_produ WHERE oid_prod = d.prod_oid_prod_envi) AS codproductosolicitado,
       '01' AS codcanalventasolicitado,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'C',
              nvl(d.can_vent_devu,
                  0),
              0) AS realuuacambiar,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'C',
              round(nvl((d.val_prec_cata_devu / v_factorimpuesto) * d.can_vent_devu,
                        0),
                    2),
              0) AS realvtamnnetoacambiar,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'C',
              nvl(d.can_prod_dese,
                  0),
              0) AS realuusolicitado,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'C',
              round(nvl((d.val_prec_cata_envi / v_factorimpuesto) * d.can_prod_dese,
                        0),
                    2),
              0) AS realvtamnnetosolicitado,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'D',
              nvl(d.can_vent_devu,
                  0),
              0) AS realuudevolucion,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'D',
              round(nvl((d.val_prec_cata_devu / v_factorimpuesto) * d.can_vent_devu,
                        0),
                    2),
              0) AS realvtamnnetodevolucion,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'R',
              nvl(d.can_vent_devu,
                  0),
              0) AS realuureclamo,
       decode(int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper),
              'R',
              round(nvl((d.val_prec_cata_devu / v_factorimpuesto) * d.can_vent_devu,
                        0),
                    2),
              0) AS realvtamnnetoreclamo,
       (SELECT DISTINCT r.ind_fne_envi
          FROM int_mae_opera_homol_dm m,
               int_rec_opera_homol_dm r
         WHERE r.cod_oper_homl = m.cod_oper_homl
           AND r.cod_oper = d.cod_oper
           AND r.cod_tipo_oper = '01') AS tiporeclamo,
       '0' flagcambiodevolucion,
         lsFechaBasCtrlFact fechageneracion,
         DECODE
            (a.perd_oid_peri_regi ,
             NULL, gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_regi),
             gen_pkg_gener.gen_fn_devuelve_des_perio(a.perd_oid_peri_regi)
            ) AnioCampanaReg
         /*(DECODE
            (c.oid_peri_regi ,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_regi)
            ) AnioCampanaReg                 */
  FROM int_solic_conso_poven_cabec c,
       rec_cabec_recla             a,
       int_solic_conso_poven_detal d,
       sto_docum_digit             dg,
       mae_clien                   m
 WHERE c.cod_pais = d.cod_pais
   AND c.cod_peri = d.cod_peri
   AND c.cod_clie = d.cod_clie
   AND c.num_docu = d.num_docu
   AND c.num_lote = d.num_lote
   AND c.oid_clie = m.oid_clie
   AND d.sec_nume_docu = dg.sec_nume_docu
   and c.oid_cabe_recl_refe = a.oid_cabe_recl (+)
   AND (dg.ind_rech = '1' OR dg.ind_envi = '1')
   AND dg.cod_tipo_docu = vstipodocumentodetalle
   AND c.oid_cabe IS NOT NULL
   AND d.oid_soli_posi_devu IS NOT NULL
   AND d.tofe_oid_devu IS NOT NULL
   AND (d.cod_oper IN (SELECT r.cod_oper
                                 FROM int_mae_opera_homol_dm m,
                                      int_rec_opera_homol_dm r
                                WHERE r.cod_oper_homl = m.cod_oper_homl
                                  AND r.cod_oper_homl IN ('D',
                                                          'R',
                                                          'F')
                                  AND  r.cod_oper_homl is not null
                                  AND r.cod_tipo_oper = '01') OR
               (d.cod_oper IN (SELECT r.cod_oper
                                  FROM int_mae_opera_homol_dm m,
                                       int_rec_opera_homol_dm r
                                 WHERE r.cod_oper_homl = m.cod_oper_homl
                                   AND r.cod_oper_homl = 'C'
                                   AND  r.cod_oper_homl is not null
                                   AND r.cod_tipo_oper = '01') AND d.tofe_oid_envi IS NOT NULL AND
               d.cod_vent_devu IS NOT NULL))
   /*AND NOT EXISTS (SELECT 1
          FROM ped_solic_cabec ccc,
               ped_solic_posic ppp
         WHERE ppp.soca_oid_soli_cabe = ccc.oid_soli_cabe
           AND ppp.oid_soli_posi = d.oid_soli_posi_devu
           AND ccc.modu_oid_modu = 15)
   AND EXISTS (SELECT 1
          FROM ped_solic_cabec ped
         WHERE ped.soca_oid_soli_cabe = c.oid_cabe
           AND ped.tspa_oid_tipo_soli_pais = vnidtipopedido)*/
   AND decode(lsvalpain,'REGI', nvl( a.perd_oid_peri_regi ,c.oid_peri_regi), c.oid_peri_recl ) = lsOidPeriodo
   ---- AND decode(lsvalpain,'REGI', c.oid_peri_regi, c.oid_peri_recl ) = lsOidPeriodo
   -----AND c.oid_peri_recl = lsOidPeriodo  --- Se cambia busqueda por Periodo
   )
     ORDER BY nrodocpostventa,
              codebelista,
              aniocampana,
              nrolineatipopostventa;

  TYPE interfaztipo IS RECORD(
    aniocampana               int_solic_conso_poven_cabec.cod_peri%TYPE,
    aniocampanaref            int_solic_conso_poven_cabec.cod_peri%TYPE,
    nrodocpostventa           int_solic_conso_poven_cabec.sec_nume_docu%TYPE,
    codebelista               mae_clien.cod_clie%TYPE,
    tipopostventa             int_rec_opera_homol_dm.cod_oper_homl%TYPE,
    nrolineatipopostventa     int_solic_conso_poven_detal.num_line%TYPE,
    codmotivorechazopostventa sto_detal_docum_excep.cod_vali%TYPE,
    estadodocpostventa        VARCHAR2(1),
    codventacdr               int_solic_conso_poven_detal.cod_vent_devu%TYPE,
    codtipoofertacdr          pre_tipo_ofert.cod_tipo_ofer%TYPE,
    codproductocdr            mae_produ.cod_sap%TYPE,
    codcanalventacdr          VARCHAR2(2),
    codmotivocdr              int_rec_motiv_cdr_dm.cod_moti_homl%TYPE,
    codventasolicitado        int_solic_conso_poven_detal.cod_vent_dese%TYPE,
    codtipoofertasolicitado   pre_tipo_ofert.cod_tipo_ofer%TYPE,
    codproductosolicitado     mae_produ.cod_sap%TYPE,
    codcanalventasolicitado   VARCHAR2(2),
    realuuacambiar            int_solic_conso_poven_detal.can_vent_devu%TYPE,
    realvtamnnetoacambiar     int_solic_conso_poven_detal.val_prec_cata_devu%TYPE,
    realuusolicitado          int_solic_conso_poven_detal.can_prod_dese%TYPE,
    realvtamnnetosolicitado   int_solic_conso_poven_detal.val_prec_cata_devu%TYPE,
    realuudevolucion          int_solic_conso_poven_detal.can_vent_devu%TYPE,
    realvtamnnetodevolucion   int_solic_conso_poven_detal.val_prec_cata_devu%TYPE,
    realuureclamo             int_solic_conso_poven_detal.can_vent_devu%TYPE,
    realvtamnnetoreclamo      int_solic_conso_poven_detal.val_prec_cata_devu%TYPE,
    tiporeclamo               int_rec_opera_homol_dm.cod_oper_homl%TYPE,
    flagcambiodevolucion      VARCHAR2(1),
    lsfechageneracion         VARCHAR2(10),
    aniocampanareg            int_solic_conso_poven_cabec.cod_peri%TYPE
    );

  TYPE interfaztab IS TABLE OF interfaztipo;
  interfazrecord interfaztab;

  /* Variables usadas para la generacion del archivo de texto */
  lsdirtempo      bas_inter.dir_temp%TYPE;
  w_filas         NUMBER := 1000;
  v_handle        utl_file.file_type;
  lslinea         VARCHAR2(1000);
  lbabrirutlfile  BOOLEAN := TRUE;
  lsnombrearchivo VARCHAR2(50);
  ldFechaIni          DATE;
  ldFechaFin          DATE;
  lsOidPeriodo      NUMBER;
  v_factorimpuesto NUMBER;
  ldFechaNovedad DATE;
  lnIdTipoPedido ped_tipo_solic_pais.oid_tipo_soli_pais%TYPE;
  lsFechaBasCtrlFact  VARCHAR2(8);
    ls_valpain          bas_param_inter.val_pain%TYPE;


BEGIN

     select c.FEC_INIC,c.FEC_FINA, c.oid_peri into ldFechaIni,ldFechaFin,lsOidPeriodo
     from cra_perio c,
          seg_perio_corpo s
     where s.OID_PERI = c.PERI_OID_PERI
     and s.COD_PERI = psCodigoPeriodo;

     select TO_CHAR (bb.fec_proc, 'yyyyMMdd') into lsFechaBasCtrlFact
     from bas_ctrl_fact bb
     where bb.sta_camp = 0
     and bb.ind_camp_act = 1;

     select nvl(min(b.val_pain),'RECL') into ls_valpain
      from bas_param_inter b
     where b.inte_cod_inte =  psCodigoInterfaz
       and b.nom_pain = 'PeriodoEnviaData';

  SELECT (val_tasa_impu / 100) + 1
    INTO v_factorimpuesto
    FROM ped_tasa_impue a
   WHERE a.oid_tasa_impu = 2001;


   lnIdTipoPedido:=  int_pkg_recla.gen_fn_devue_oid_tipo_solpa('SOC');

  OPEN c_interfaz(pscodigopais,
                  pstipodocumentodetalle,
                  pstipodocumentocabecera,
                  v_factorimpuesto,
                  ldFechaIni,
                  ldFechaFin,
                  lsOidPeriodo,
                  lnIdTipoPedido,
                  lsFechaBasCtrlFact,
                  ls_valpain);

  LOOP
    FETCH c_interfaz BULK COLLECT
      INTO interfazrecord LIMIT w_filas;

    IF lbabrirutlfile THEN
      gen_pkg_inter_archi.gen_pr_inici_inter(pscodigopais,
                                             pscodigosistema,
                                             pscodigointerfaz,
                                             psnombrearchivo,
                                             lsdirtempo,
                                             lsnombrearchivo,
                                             v_handle);
      lbabrirutlfile := FALSE;
    END IF;

    IF interfazrecord.count > 0 THEN

      FOR x IN interfazrecord.first .. interfazrecord.last
      LOOP
         lsLinea := interfazRecord(x).anioCampana               ||';'||
              interfazRecord(x).anioCampanaRef            ||';'||
        interfazRecord(x).nroDocPostVenta           ||';'||
        interfazRecord(x).codEbelista               ||';'||
        interfazRecord(x).tipoPostVenta             ||';'||
        interfazRecord(x).nroLineaTipoPostVenta     ||';'||
        interfazRecord(x).codMotivoRechazoPostVenta ||';'||
        interfazRecord(x).estadoDocPostVenta        ||';'||
        interfazRecord(x).codVentaCDR               ||';'||
        interfazRecord(x).codTipoOfertaCDR          ||';'||
        interfazRecord(x).codProductoCDR            ||';'||
        interfazRecord(x).codCanalVentaCDR          ||';'||
        interfazRecord(x).codMotivoCDR              ||';'||
        interfazRecord(x).codVentaSolicitado        ||';'||
        interfazRecord(x).codTipoOfertaSolicitado   ||';'||
        interfazRecord(x).codProductoSolicitado     ||';'||
        interfazRecord(x).codCanalVentaSolicitado   ||';'||
        interfazRecord(x).realUUACambiar            ||';'||
        interfazRecord(x).realVtaMNNetoACambiar     ||';'||
        interfazRecord(x).realUUSolicitado          ||';'||
        interfazRecord(x).realVtaMNNetoSolicitado   ||';'||
        interfazRecord(x).realUUDevolucion          ||';'||
        interfazRecord(x).realVtaMNNetoDevolucion   ||';'||
        interfazRecord(x).realUUReclamo             ||';'||
        interfazRecord(x).realVtaMNNetoReclamo      ||';'||
        interfazRecord(x).tipoReclamo               ||';'||
        interfazRecord(x).flagCambioDevolucion;

         if ls_valpain = 'REGI' then
            lsLinea := lsLinea || ';'||
                       interfazRecord(x).anioCampanaReg;
         end if;

        utl_file.put_line(v_handle,
                          lslinea);
      END LOOP;

    END IF;

    EXIT WHEN c_interfaz%NOTFOUND;
  END LOOP;

  CLOSE c_interfaz;

  IF NOT lbabrirutlfile THEN
    utl_file.fclose(v_handle);
    --Procedimiento final para generar interfaz
    gen_pkg_inter_archi.gen_pr_final_inter('SICC_DIR',
                                           lsdirtempo,
                                           psnombrearchivo,
                                           lsnombrearchivo);
  END IF;

  RETURN;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(SQLERRM,
                         1,
                         1000);
    raise_application_error(-20123,
                            'ERROR INT_PR_DAT_ENVIO_DETAL_POSTV: ' || ls_sqlerrm);
END INT_PR_DAT_ENVIO_DETAL_POSTV;

/******************************************************************
Descripcion       : Interfaz que envia los documentos post venta
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoDetalle : Tipo de Documento Detalle
          psTipoDocumentoCabecera : Tipo de Documento Cabecera
******************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DOCUM_POSTV(
  psCodigoPais VARCHAR2,
  psCodigoSistema VARCHAR2,
  psCodigoInterfaz VARCHAR2,
  psNombreArchivo VARCHAR2,
  psCodigoMarca VARCHAR2,
  psCodigoCanal VARCHAR2,
  psCodigoPeriodo VARCHAR2,
  psTipoDocumentoCabecera VARCHAR2,
  psfechaFacturacion VARCHAR2
)

IS

  CURSOR c_interfaz
  (
  vsCodigoPais VARCHAR2,
  vsTipoDocumentoCabecera VARCHAR2 ,
  ldFechaIni DATE,
  ldFechaFin DATE,
  lsOidPeriodo number,
  lsFechaBasCtrlFact varchar2,
  lsvalpain varchar2
  ) IS

SELECT *
FROM (
  SELECT ---c.cod_peri AnioCampana,
         DECODE
            (c.oid_peri_recl,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_recl)
            ) AnioCampana,
         DECODE
            (c.oid_peri_refe,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_refe)
            ) AnioCampanaRef,         m.cod_clie as CodEbelista,
         C.SEC_NUME_DOCU as NroDocPostVenta,
         LTRIM(c.num_docu_cruc,'0') as NroDocumento,
         lsFechaBasCtrlFact FechaGeneracion,
         TO_CHAR ( c.fec_digi , 'yyyyMMdd') FechaRegistro,
         DECODE
            (c.oid_peri_regi ,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_regi)
            ) AnioCampanaReg,
         c.num_docu as NroDocPostVentaFisico
    FROM int_solic_conso_poven_cabec c,
         sto_docum_digit dg,
         mae_clien m
   WHERE 1=1
     AND c.sec_nume_docu = dg.sec_nume_docu
     AND c.oid_clie = m.oid_clie
     AND c.oid_cabe is not null
     AND dg.ind_rech = 1
     AND dg.cod_tipo_docu IN (vsTipoDocumentoCabecera)
     /*AND EXISTS(
         SELECT 1
         FROM ped_solic_cabec ped
         WHERE ped.soca_oid_soli_cabe = c.oid_cabe
         AND  ped.ind_oc = 1
         --ped.tspa_oid_tipo_soli_pais = int_pkg_recla.GEN_FN_DEVUE_OID_TIPO_SOLPA('SOC')
     )*/
    and exists(
         select 1
         from ped_solic_cabec ccc,
              ped_solic_posic ppp,
              int_solic_conso_poven_detal d,
              sto_docum_digit dgd
         where 1=1
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
           AND d.sec_nume_docu = dgd.sec_nume_docu
           AND ppp.soca_oid_soli_cabe = ccc.oid_soli_cabe
           AND ppp.oid_soli_posi = d.OID_SOLI_POSI_DEVU
           -----AND ccc.modu_oid_modu <> 15
           AND dgd.ind_envi = '0'
           AND dgd.ind_rech = '1'
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
           d.oid_soli_posi_devu is not null
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
    )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
          d.tofe_oid_devu is not null
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
          int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IS NOT NULL
          AND d.cod_pais = c.cod_pais
          AND d.num_lote = c.num_lote
          AND d.cod_clie = c.cod_clie
          AND d.cod_peri = c.cod_peri
          AND d.num_docu = c.num_docu
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
          d.num_lote = c.num_lote
          AND d.cod_pais = c.cod_pais
          AND d.cod_clie = c.cod_clie
          AND d.cod_peri = c.cod_peri
          AND d.num_docu = c.num_docu
          AND (
            int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IN ('D','R')
                                                      OR
              (
            int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IN ('C') AND TOFE_OID_ENVI IS NOT NULL AND d.COD_VENT_DEVU IS NOT NULL
              )
            )
          )
      AND decode(lsvalpain,'REGI', c.oid_peri_regi, c.oid_peri_recl ) = lsOidPeriodo
      -----AND c.oid_peri_recl = lsOidPeriodo  ---- Se cambia la busqueda de fecha por perido
--
UNION ALL
--
SELECT   ----c.cod_peri AnioCampana,
         DECODE
            (c.oid_peri_recl,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_recl)
            ) AnioCampana,
         DECODE
            (c.oid_peri_refe,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_refe)
            ) AnioCampanaRef,
         m.cod_clie as CodEbelista,
         C.SEC_NUME_DOCU as NroDocPostVenta,
         LTRIM(c.num_docu_cruc,'0') as NroDocumento,
         lsFechaBasCtrlFact FechaGeneracion,
         TO_CHAR ( c.fec_digi , 'yyyyMMdd') FechaRegistro,
         DECODE
            (a.perd_oid_peri_regi ,
             NULL, gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_regi),
             gen_pkg_gener.gen_fn_devuelve_des_perio(a.perd_oid_peri_regi)
            ) AnioCampanaReg,
         c.num_docu as NroDocPostVentaFisico
         /*DECODE
            (c.oid_peri_regi ,
             NULL, c.cod_peri,
             gen_pkg_gener.gen_fn_devuelve_des_perio(c.oid_peri_regi)
            ) AnioCampanaReg,
         c.num_docu as NroDocPostVentaFisico */
    FROM int_solic_conso_poven_cabec c,
         rec_cabec_recla a,
         sto_docum_digit dg,
         mae_clien m
   WHERE c.sec_nume_docu = dg.sec_nume_docu
     AND c.oid_clie = m.oid_clie
     AND c.oid_cabe is not null
     and c.oid_cabe_recl_refe = a.oid_cabe_recl
     AND dg.cod_tipo_docu IN (vsTipoDocumentoCabecera)--'SPVC'
     AND dg.ind_envi = 1
     AND dg.ind_rech = 0
     /*AND EXISTS(
         SELECT 1
         FROM ped_solic_cabec ped
         WHERE ped.soca_oid_soli_cabe = c.oid_cabe
         AND  ped.ind_oc = 1 --ped.tspa_oid_tipo_soli_pais = int_pkg_recla.GEN_FN_DEVUE_OID_TIPO_SOLPA('SOC')
     )*/
    and exists(
         select 1
         from ped_solic_cabec ccc,
              ped_solic_posic ppp,
              int_solic_conso_poven_detal d,
              sto_docum_digit dgd
         where 1=1
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
           AND d.sec_nume_docu = dgd.sec_nume_docu
           AND ppp.soca_oid_soli_cabe = ccc.oid_soli_cabe
           AND ppp.oid_soli_posi = d.OID_SOLI_POSI_DEVU
           ----AND ccc.modu_oid_modu <> 15
           AND dgd.ind_envi = '1'
           AND dgd.ind_rech = '0'
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
           d.oid_soli_posi_devu is not null
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
           d.tofe_oid_devu is not null
           AND d.cod_pais = c.cod_pais
           AND d.num_lote = c.num_lote
           AND d.cod_clie = c.cod_clie
           AND d.cod_peri = c.cod_peri
           AND d.num_docu = c.num_docu
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d
         WHERE
          int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IS NOT NULL
          AND d.cod_pais = c.cod_pais
          AND d.num_lote = c.num_lote
          AND d.cod_clie = c.cod_clie
          AND d.cod_peri = c.cod_peri
          AND d.num_docu = c.num_docu
     )
     and exists (
         SELECT 1
         FROM int_solic_conso_poven_detal d--,
         WHERE
          d.num_lote = c.num_lote
          AND d.cod_pais = c.cod_pais
          AND d.cod_clie = c.cod_clie
          AND d.cod_peri = c.cod_peri
          AND d.num_docu = c.num_docu
          AND
          (
          int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IN ('D','R')
                                                      OR
          (
          int_pkg_datam.int_fn_dat_trans_cdr(d.cod_oper) IN ('C') AND TOFE_OID_ENVI IS NOT NULL AND d.COD_VENT_DEVU IS NOT NULL
          )
          )
         )
      AND decode(lsvalpain,'REGI', a.perd_oid_peri_regi, c.oid_peri_recl ) = lsOidPeriodo
      ----AND c.oid_peri_recl = lsOidPeriodo   ---- Se cambia la busqueda de fecha por perido
   );


   TYPE interfazTipo IS RECORD(

      anioCampana              int_solic_conso_poven_cabec.COD_PERI%TYPE,

      anioCampanaRef           int_solic_conso_poven_cabec.COD_PERI%TYPE,

      codEbelista              mae_clien.COD_CLIE%TYPE,

      nroDocPostVenta          int_solic_conso_poven_cabec.SEC_NUME_DOCU%TYPE,

      nroDocumento             int_solic_conso_poven_cabec.num_docu_cruc%TYPE,

      lsFechaGeneracion        VARCHAR2(10),

      lsFechaRegistro          VARCHAR2(10),

      anioCampanaReg           int_solic_conso_poven_cabec.COD_PERI%TYPE,

      nroDocPostVentaFisico    int_solic_conso_poven_cabec.num_docu%TYPE

   );

   TYPE interfazTab IS TABLE OF interfazTipo;

   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
    lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
    W_FILAS             NUMBER := 1000;
    V_HANDLE            UTL_FILE.FILE_TYPE;
    lsLinea             VARCHAR2(1000);
    lbAbrirUtlFile      BOOLEAN:=TRUE;
    lsNombreArchivo     VARCHAR2(50);
    lsOidPeriodo        Number;
    ldFechaIni          DATE;
    ldFechaFin          DATE;
    lsFechaBasCtrlFact  VARCHAR2(8);
    ls_valpain          bas_param_inter.val_pain%TYPE;

BEGIN
     --- 27/08/2012 se obtiene tambien el oid del Periodo
     select c.FEC_INIC,c.FEC_FINA,c.oid_peri into ldFechaIni,ldFechaFin,lsOidPeriodo
     from cra_perio c,
          seg_perio_corpo s
     where s.OID_PERI = c.PERI_OID_PERI
     and s.COD_PERI = psCodigoPeriodo;

     select TO_CHAR (bb.fec_proc, 'yyyyMMdd') into lsFechaBasCtrlFact
     from bas_ctrl_fact bb
     where bb.sta_camp = 0
     and bb.ind_camp_act = 1;

     select nvl(min(b.val_pain),'RECL') into ls_valpain
      from bas_param_inter b
     where b.inte_cod_inte =  psCodigoInterfaz
       and b.nom_pain = 'PeriodoEnviaData';

     OPEN c_interfaz(psCodigoPais,psTipoDocumentoCabecera,ldFechaIni,ldFechaFin,lsOidPeriodo,lsFechaBasCtrlFact,ls_valpain);

     LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

            IF lbAbrirUtlFile THEN
            GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
            psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
            lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).anioCampana            ||';'||
                               interfazRecord(x).anioCampanaRef         ||';'||
                         interfazRecord(x).codEbelista            ||';'||
                         interfazRecord(x).nroDocPostVenta        ||';'||
                         interfazRecord(x).nroDocumento           ||';'||
                         interfazRecord(x).lsFechaGeneracion      ||';'||
                         interfazRecord(x).nroDocPostVentaFisico;

               if ls_valpain = 'REGI' then
                  lsLinea := lsLinea || ';'||
                             interfazRecord(x).anioCampanaReg      ||';'||
                             interfazRecord(x).lsFechaRegistro;
               end if;
            UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

         END IF;

       EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;

     CLOSE c_interfaz;

     IF NOT lbAbrirUtlFile THEN
         UTL_FILE.FCLOSE(V_HANDLE);
        --Procedimiento final para generar interfaz
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
        END IF;

     RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_DOCUM_POSTV: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_DOCUM_POSTV;

/*****************************************************************
Descripcion       : Interfaz que envia los pedidos rechazados
Fecha Creacion    : 18/11/2009
Autor             : Jesse Rios
Parametros:
          psCodigoPais     : Codigo de Pais
          psCodigoSistema  : Codigo de Empresa
          psCodigoInterfaz : Codigo de Interfaz
          psNombreArchivo  : Nombre Archivo
          psCodigoMarca       : Codigo Marca
          psCodigoCanal       : Codigo Canal
          psCodigoPeriodo  : Codigo Periodo
          psTipoDocumentoOCCabecera : Tipo de Documento OCC Cabecera
******************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PEDID_RECHA(
  psCodigoPais VARCHAR2,
  psCodigoSistema VARCHAR2,
  psCodigoInterfaz VARCHAR2,
  psNombreArchivo VARCHAR2,
  psCodigoMarca VARCHAR2,
  psCodigoCanal VARCHAR2,
  psCodigoPeriodo VARCHAR2,
  psTipoDocumentoOCCabecera VARCHAR2
)
IS

  CURSOR c_interfaz(vsCodigoPais VARCHAR2,vsTipoDocumentoOCCabecera VARCHAR2,vnOidTipoSolicitud NUMBER, vnOidPeriodo NUMBER)IS
SELECT det.Periodo as AnioCampana,
       det.zona as CodSeccion,
       det.valerro as CodMotivoRechazoPedido,
       COUNT(det.nropedido) as RealNroPedidosRechazados
FROM
   (
   SELECT c.cod_peri as Periodo,
          c.cod_clie as cliente,
          c.sec_nume_docu as nropedido,
          (GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_ZONA') ||''|| GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_SECC')) as zona,
          CASE
             WHEN dg.cod_ulti_vali_erro is not null THEN dg.cod_ulti_vali_erro
             WHEN dg.cod_ulti_vali_erro is null THEN dg.cod_ulti_vali_exit
             ELSE dg.cod_ulti_vali_ejec
          END as valerro
   FROM int_solic_conso_cabec c,
        sto_docum_digit dg
   WHERE c.cod_peri = psCodigoPeriodo
     AND c.cod_pais = dg.cod_pais
     AND c.num_lote = dg.num_lote
     AND c.sec_nume_docu = dg.sec_nume_docu
     AND dg.cod_tipo_docu = vsTipoDocumentoOCCabecera  -- OCC
     AND dg.ind_envi = '0'
     AND GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_ZONA') IS NOT NULL
     AND GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_SECC') IS NOT NULL
     AND NOT EXISTS                 -- valida que no haya pasado pedido en la Periodo
      (
        SELECT oid_soli_cabe
          FROM ped_solic_cabec ped
         WHERE ped.clie_oid_clie = c.clie_oid_clie
           AND ped.perd_oid_peri = c.perd_oid_peri
            AND ped.perd_oid_peri = vnOidPeriodo
           AND ped.tspa_oid_tipo_soli_pais = vnOidTipoSolicitud
           AND ped.fec_fact is not null
           AND ped.esso_oid_esta_soli <> 4
      )
   --
   UNION ALL
   --
   SELECT c.cod_peri as Periodo,
          c.cod_clie as cliente,
          c.sec_nume_docu as nropedido,
          (GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_ZONA') ||''|| GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_SECC')) as zona,
          CASE
             WHEN dg.cod_ulti_vali_erro is not null THEN dg.cod_ulti_vali_erro
             WHEN dg.cod_ulti_vali_erro is null THEN dg.cod_ulti_vali_exit
             ELSE dg.cod_ulti_vali_ejec
          END as valerro
   FROM ped_histo_solic_conso_cabec c,
        sto_histo_docum_digit dg
   WHERE c.cod_peri = psCodigoPeriodo
     AND c.cod_pais = dg.cod_pais
     AND c.num_lote = dg.num_lote
     AND c.sec_nume_docu = dg.sec_nume_docu
     AND dg.cod_tipo_docu = vsTipoDocumentoOCCabecera  -- OCC
     AND dg.ind_envi = '0'
     AND GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_ZONA') IS NOT NULL
     AND GEN_PKG_GENER.GEN_FN_CLIEN_DATOS_OID(fin_pkg_gener.FIN_FN_OBTIE_OID_CLIEN(c.cod_clie),'COD_SECC') IS NOT NULL
     AND NOT EXISTS                 -- valida que no haya pasado pedido en la Periodo
      (
        SELECT oid_soli_cabe FROM ped_solic_cabec ped
        WHERE ped.clie_oid_clie = c.clie_oid_clie
        AND ped.perd_oid_peri = c.perd_oid_peri
        AND ped.perd_oid_peri = vnOidPeriodo
        AND ped.tspa_oid_tipo_soli_pais = vnOidTipoSolicitud
        AND ped.fec_fact is not null
        AND ped.esso_oid_esta_soli <> 4
      )
     --
   ) det
WHERE det.zona is not null
GROUP BY det.Periodo,det.zona,det.valerro
ORDER BY det.Periodo,det.zona,det.valerro;

     TYPE interfazTipo IS RECORD(

        anioCampana               int_solic_conso_cabec.COD_PERI%TYPE,

        codSeccion                zon_zona.DES_ZONA%TYPE,

        codMotivoRechazoPedido    sto_detal_docum_excep.COD_VALI%TYPE,

        realNroPedidosRechazados  NUMBER

     );

     TYPE interfazTab IS TABLE OF interfazTipo;

     interfazRecord interfazTab;

     /* Variables usadas para la generacion del archivo de texto */
     lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
     W_FILAS             NUMBER := 1000;
     V_HANDLE            UTL_FILE.FILE_TYPE;
     lsLinea             VARCHAR2(1000);
     lbAbrirUtlFile      BOOLEAN:=TRUE;
     lsNombreArchivo     VARCHAR2(50);
     lnOidTipoSolicitud  PED_TIPO_SOLIC_PAIS.Oid_Tipo_Soli_Pais%TYPE;
     lnOidPeriodo        cra_perio.oid_peri%TYPE;

BEGIN

   lnOidTipoSolicitud := fin_pkg_gener.FIN_FN_OBTIE_OID_SOLIC_PAIS('SOC');

   lnOidPeriodo:= gen_pkg_gener.GEN_FN_DEVUELVE_ID_CRA_PERIO2(psCodigoPeriodo);

     OPEN c_interfaz(psCodigoPais,psTipoDocumentoOCCabecera,lnOidTipoSolicitud,lnOidPeriodo);

     LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

            IF lbAbrirUtlFile THEN
            GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
            psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
            lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN

          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                lsLinea := interfazRecord(x).anioCampana              ||';'||
                               interfazRecord(x).codSeccion               ||';'||
                         interfazRecord(x).codMotivoRechazoPedido   ||';'||
                         interfazRecord(x).realNroPedidosRechazados;


            UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;

         END IF;

       EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;

     CLOSE c_interfaz;

     IF NOT lbAbrirUtlFile THEN
         UTL_FILE.FCLOSE(V_HANDLE);
        --Procedimiento final para generar interfaz
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
        END IF;

     RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PEDID_RECHA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PEDID_RECHA;

/***************************************************************************
Descripcion       : Genera Interface de Envio de Fecha de Cierre de
                    Campanha
Fecha Creacion    : 11/02/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_CIERR(
   psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoModulo   VARCHAR2,
   psCodigoPeriodo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2
)
IS
  CURSOR c_interfaz(vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER, vnIdTipoCierre NUMBER) IS
    SELECT spc.cod_peri codigoPeriodo,
                 MAX(TO_CHAR(fec_cier,'yyyymmdd')) fechaCierre
        FROM fac_contr_cierr fcc,
                 fac_tipos_cierr ftc,
                 cra_perio cp,
                 seg_perio_corpo spc,
                 seg_pais sgp,
                 seg_canal scl,
                 seg_marca sma
     WHERE sgp.oid_pais = vnIdPais
       AND spc.oid_peri = vnIdPeriodo
         AND sma.oid_marc = vnIdMarca
         AND scl.oid_cana = vnIdCanal
         AND ftc.oid_tipo_cier = vnIdTipoCierre
       AND fcc.tcie_oid_tipo_cier = ftc.oid_tipo_cier
         AND fcc.perd_oid_peri = cp.oid_peri
         AND cp.peri_oid_peri = spc.oid_peri
         AND cp.pais_oid_pais = sgp.oid_pais
         AND cp.marc_oid_marc = sma.oid_marc
         AND cp.cana_oid_cana = scl.oid_cana
  GROUP BY spc.cod_peri ;

   TYPE interfazRec IS RECORD (
     codigoPeriodo      seg_perio_corpo.cod_peri%TYPE,
     fechaCierre        VARCHAR2(8)
   );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lnIdPeriodo         NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lnIdTipoCierre      NUMBER;
  lbAbrirUtlFile      BOOLEAN;

BEGIN
   /* obteniendo id's */
   lnIdPais    := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca   := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal   := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo := gen_pkg_gener.gen_fn_devuelve_id_perio(psCodigoPeriodo);-- id del Periodo consultante
    -- Id del Tipo de Cierre P
   SELECT f.oid_tipo_cier
     INTO lnIdTipoCierre
     FROM fac_tipos_cierr f
    WHERE f.cod_tipo_cier = 'P';

   /* Generando Archivo de Texto */
   lbAbrirUtlFile := TRUE;
   OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo,lnIdTipoCierre);
     LOOP
       FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
         /* Procedimiento inicial para generar interfaz */
         IF lbAbrirUtlFile THEN
           GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
           lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN
           FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea :=  interfazRecord(x).codigoPeriodo ||';'||
                         interfazRecord(x).fechaCierre;
             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
           END LOOP;
         END IF;
         EXIT WHEN c_interfaz%NOTFOUND;

     END LOOP;
   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);

     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;

   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_FECHA_CIERR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_FECHA_CIERR;

/***************************************************************************
Descripcion       : Genera Interface de Productos de Reemplazo
Fecha Creacion    : 11/02/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRODU_REMPL(
   psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoModulo   VARCHAR2,
   psCodigoPeriodo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2,
   psNumeroLote     VARCHAR2
)
IS
  CURSOR c_interfaz(vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER,
                    /*vdFecUltAct DATE, */ vsFlagTipoAccion VARCHAR2) IS
    SELECT
                 cana.cod_cana      codigoCanalVenta,
                 pcor.cod_peri      codigoPeriodo,
           pro1.cod_sap       codigoProductoReemplazado,
           tof1.cod_tipo_ofer codigoTipoOfertaReemplazado,
           ofd1.val_codi_vent codigoVentaReemplazado,
           pro2.cod_sap       codigoProductoReemplazo,
           tof2.cod_tipo_ofer codigoTipoOfertaReemplazo,
           ofd2.val_codi_vent codigoVentaReemplazo,
           pro1.des_cort           descripcionProductoReemplazado,
           pro2.des_cort             descripcionProductoReemplazo,
           0                  flagTipoAccion,
           max(ptr.cod_tipo_reem) cod_tipo_reem
      FROM pre_matri_reemp mre,
           pre_matri_factu mfac,
           pre_matri_factu mfacr,
           pre_matri_factu_cabec mfacab,
           pre_matri_factu_cabec mfacabr,
           cra_perio per,
           seg_perio_corpo pcor,
           seg_canal cana,
           mae_produ pro1,
           mae_produ pro2,
           pre_ofert_detal ofd1,
           pre_ofert_detal ofd2,
           pre_tipo_ofert tof1,
           pre_tipo_ofert tof2,
           pre_tipo_reemp ptr
     WHERE per.pais_oid_pais = vnIdPais
       AND per.oid_peri = vnIdPeriodo
       AND per.marc_oid_marc = vnIdMarca
       AND per.cana_oid_cana = vnIdCanal
       --AND TRUNC(mre.fec_ulti_actu) > TRUNC(vdFecUltAct)
       AND pcor.cod_peri >= psCodigoPeriodo
       AND mre.mafa_oid_cod_ppal = mfac.oid_matr_fact
       AND mre.mafa_oid_cod_reem = mfacr.oid_matr_fact
       AND mfac.mfca_oid_cabe = mfacab.oid_cabe
       AND mfacr.mfca_oid_cabe = mfacabr.oid_cabe
       AND mfacab.perd_oid_peri = per.oid_peri
       AND mfacabr.perd_oid_peri = per.oid_peri
       AND per.cana_oid_cana = cana.oid_cana
       AND mfac.ofde_oid_deta_ofer = ofd1.oid_deta_ofer
       AND mfacr.ofde_oid_deta_ofer = ofd2.oid_deta_ofer
       AND ofd1.prod_oid_prod = pro1.oid_prod
       AND ofd2.prod_oid_prod = pro2.oid_prod
       AND per.peri_oid_peri = pcor.oid_peri
       AND ofd1.tofe_oid_tipo_ofer = tof1.oid_tipo_ofer
       AND ofd2.tofe_oid_tipo_ofer = tof2.oid_tipo_ofer
       AND mre.OID_TIPO_REEM=ptr.oid_tipo_reem(+)
     GROUP BY cana.cod_cana, pcor.cod_peri,
           pro1.cod_sap,     tof1.cod_tipo_ofer,
           ofd1.val_codi_vent ,
           pro2.cod_sap       ,
           tof2.cod_tipo_ofer ,
           ofd2.val_codi_vent ,
           pro1.des_cort      ,
           pro2.des_cort;

   TYPE interfazRec IS RECORD (
     codigoCanalVenta                seg_canal.cod_cana%TYPE,
       codigoPeriodo                   seg_perio_corpo.cod_peri%TYPE,
     codigoProductoReemplazado       mae_produ.cod_sap%TYPE,
     codigoTipoOfertaReemplazado     pre_tipo_ofert.cod_tipo_ofer%TYPE,
     codigoVentaReemplazado          pre_ofert_detal.val_codi_vent%TYPE,
     codigoProductoReemplazo         mae_produ.cod_sap%TYPE,
     codigoTipoOfertaReemplazo       pre_tipo_ofert.cod_tipo_ofer%TYPE,
     codigoVentaReemplazo            pre_ofert_detal.val_codi_vent%TYPE,
     descripcionProductoReemplazado  mae_produ.des_cort%TYPE,
     descripcionProductoReemplazo    mae_produ.des_cort%TYPE,
     flagTipoAccion                  VARCHAR2(1),
     codigotiporeemplazo             pre_tipo_reemp.cod_tipo_reem%TYPE
   );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  W_FILAS             NUMBER := 1000 ;
  v_handle            UTL_FILE.FILE_TYPE;

  lsLinea             VARCHAR2(1000);

  lsNombreArchivo     VARCHAR2(50);
  lnIdPais            NUMBER;
  lnIdPeriodo         NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lnIdTipoCierre      NUMBER;
  lbAbrirUtlFile      BOOLEAN;
  ldFecUltAct         DATE;
  lsFlagTipoAccion    VARCHAR2(1);
  ldFecInicioEjec     DATE;
  lsCodInterfaz       VARCHAR2(10);
  lnContadorReg       NUMBER;

BEGIN

   /* obteniendo id's */
   lnIdPais    := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca   := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal   := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);-- id del Periodo consultante

   lsCodInterfaz := 'DAT-28';
   lnContadorReg := 0;
   -- Se obtiene la ultima fecha de ejecucion de la interfaz DAT-28
   --ldFecUltAct := INT_FN_DEVUE_FECHA_ULTIM_EJECU(lnIdPais,lsCodInterfaz);
   lsFlagTipoAccion := '0';

   /*IF ldFecUltAct = '' THEN
     lsFlagTipoAccion := '0';
   ELSE
     lsFlagTipoAccion := '1';
   END IF;*/

   /* Generando Archivo de Texto */
   lbAbrirUtlFile := TRUE;
   ldFecInicioEjec := SYSDATE;

  -- Si existe el registro para ese lote, se elimina
  delete from int_histo_lotes
   where COD_INTE      = lsCodInterfaz
     and PAIS_OID_PAIS = lnIdPais
     and NUM_LOTE      = psNumeroLote;

   OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo, /*ldFecUltAct,*/ lsFlagTipoAccion);
     LOOP
       FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
         IF lbAbrirUtlFile THEN
           GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
           lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN
           FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea :=  interfazRecord(x).codigoCanalVenta               ||';'||
                         interfazRecord(x).codigoPeriodo                   ||';'||
                         interfazRecord(x).codigoProductoReemplazado      ||';'||
                         interfazRecord(x).codigoTipoOfertaReemplazado    ||';'||
                         interfazRecord(x).codigoVentaReemplazado         ||';'||
                         interfazRecord(x).codigoProductoReemplazo        ||';'||
                         interfazRecord(x).codigoTipoOfertaReemplazo      ||';'||
                         interfazRecord(x).codigoVentaReemplazo           ||';'||
                         interfazRecord(x).descripcionProductoReemplazado ||';'||
                         interfazRecord(x).descripcionProductoReemplazo   ||';'||
                         interfazRecord(x).flagTipoAccion                 ||';'||
                         interfazRecord(x).codigotiporeemplazo ;
             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             lnContadorReg := lnContadorReg + 1;
           END LOOP;
         END IF;

         EXIT WHEN c_interfaz%NOTFOUND;

     END LOOP;
   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);

     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
     INT_PR_INSER_HISTO_LOTES(lnIdPais, lsCodInterfaz, psNumeroLote, lnContadorReg, ldFecInicioEjec);

   END IF;

   RETURN;
EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PRODU_REMPL: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PRODU_REMPL;

/**************************************************************************
  Descripcion       : Devuelve la ultima fecha que se ejecuto la interfaz
                      pasado como parametro
  Fecha Creacion    : 12/02/2010
  Parametros Entrada:
      psOidPais          : Oid de pais
      psCodigoInterfaz   : Codigo de Interfaz
  Autor             : Jose Luis Rodriguez
***************************************************************************/
  FUNCTION INT_FN_DEVUE_FECHA_ULTIM_EJECU
  (
    psOidpais      VARCHAR2,
    psCodigoInterfaz  VARCHAR2
  ) RETURN DATE IS

    ldFecha DATE;

  BEGIN
    ldFecha := '';
    SELECT MAX (fec_fin_proc)
      INTO ldFecha
      FROM int_histo_lotes
     WHERE pais_oid_pais = psOidpais
       AND cod_inte LIKE psCodigoInterfaz;

    RETURN ldFecha;

  EXCEPTION
    WHEN no_data_found THEN
      RETURN '';
    WHEN OTHERS THEN
      RETURN '';

  END INT_FN_DEVUE_FECHA_ULTIM_EJECU;

/***************************************************************************
Descripcion       : Inserta un registro en la tabla int_histo_lotes
Fecha Creacion    : 03/03/2010
Autor             : Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_INSER_HISTO_LOTES(
   psOidPais         NUMBER,
                                   psCodInterfaz    VARCHAR2,
                                   psNumeroLote     VARCHAR2,
                                   psContadorReg    NUMBER,
   pdFechaIinicio   DATE
)
IS
BEGIN

  INSERT INTO int_histo_lotes
  ( cod_inte, num_lote, val_desc_lote, fec_inic_proc, fec_fin_proc, ind_log_erro,
    num_regi_proc, num_regi_erro, pais_oid_pais  )
  VALUES
  ( psCodInterfaz, psNumeroLote, 'Datamart', pdFechaIinicio, SYSDATE, 0,
    psContadorReg, 0, psOidPais);

END INT_PR_INSER_HISTO_LOTES;

/***************************************************************************
Descripcion : Interfaz que envia maestro segmento love
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SEGME_LOVE
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2)
IS
 CURSOR c_interfaz IS
            SELECT
      A.COD_SEGM codigoSegmento,
          A.DES_SEGM descripcionSegmento,
 A.COD_GRUP_SEGM codigoGrupo
            FROM MAE_LOVE_SEGME A
 ORDER BY A.COD_SEGM;


 TYPE interfazTipo IS RECORD
 ( codigoSegmento         MAE_LOVE_SEGME.COD_SEGM%TYPE,
 descripcionSegmento     MAE_LOVE_SEGME.DES_SEGM%TYPE,
 codigoGrupo MAE_LOVE_SEGME.COD_GRUP_SEGM%TYPE
 );

 TYPE interfazTab IS TABLE OF interfazTipo ;

 interfazRecord interfazTab;

 /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
BEGIN

 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz;
 LOOP
 FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
 /* Procedimiento inicial para generar interfaz */
 IF lbAbrirUtlFile THEN
 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
 lbAbrirUtlFile := FALSE;
 END IF;

 IF interfazRecord.COUNT > 0 THEN
 FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
 lsLinea := interfazRecord(x).codigoSegmento     ||';'||
 interfazRecord(x).descripcionSegmento ||';'||
 interfazRecord(x).codigoGrupo ;

 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
 END LOOP;
 END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
 utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;
 RETURN;
 EXCEPTION
 WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_SEGME_LOVE: '||ls_sqlerrm);
 END INT_PR_DAT_ENVIO_SEGME_LOVE;

/***************************************************************************
Descripcion : Interfaz que envia maestro grupo segmento love
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GRUPO_LOVE
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2)
 IS
 CURSOR c_interfaz IS
            SELECT
      LC.COD_GRUP_SEGM codigoGrupo,
         LC.DES_GRUP_SEGM descripcionGrupoSegmento
            FROM MAE_LOVE_GRUPO_SEGME LC
            ORDER BY LC.COD_GRUP_SEGM;



 TYPE interfazTipo IS RECORD
 ( codigoGrupo          MAE_LOVE_GRUPO_SEGME.COD_GRUP_SEGM%TYPE,
 descripcionGrupoSegmento MAE_LOVE_GRUPO_SEGME.DES_GRUP_SEGM%TYPE
 );

 TYPE interfazTab IS TABLE OF interfazTipo ;

 interfazRecord interfazTab;

 /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
BEGIN

 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz;
 LOOP
 FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
 /* Procedimiento inicial para generar interfaz */
 IF lbAbrirUtlFile THEN
 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
 lbAbrirUtlFile := FALSE;
 END IF;

 IF interfazRecord.COUNT > 0 THEN
 FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
 lsLinea := interfazRecord(x).codigoGrupo     ||';'||
 interfazRecord(x).descripcionGrupoSegmento ;

 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
 END LOOP;
 END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
 utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;
 RETURN;
 EXCEPTION
 WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_GRUPO_LOVE: '||ls_sqlerrm);
 END INT_PR_DAT_ENVIO_GRUPO_LOVE;

/***************************************************************************
Descripcion : Interfaz que envia maestro tipo logro
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LOGRO
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2)
IS
 CURSOR c_interfaz IS
            SELECT
      LC.COD_TIPO_LOGR codigoTipoLogro,
          LC.DES_TIPO_LOG1 descripcionTipologro
            FROM MAE_LOVE_TIPO_LOGRO LC
            ORDER BY LC.COD_TIPO_LOGR;



 TYPE interfazTipo IS RECORD
 ( codigoTipoLogro MAE_LOVE_TIPO_LOGRO.COD_TIPO_LOGR%TYPE,
 descripcionTipologro MAE_LOVE_TIPO_LOGRO.DES_TIPO_LOG1%TYPE
 );

 TYPE interfazTab IS TABLE OF interfazTipo ;

 interfazRecord interfazTab;

 /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
BEGIN

 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz;
 LOOP
 FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
 /* Procedimiento inicial para generar interfaz */
 IF lbAbrirUtlFile THEN
 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
 lbAbrirUtlFile := FALSE;
 END IF;

 IF interfazRecord.COUNT > 0 THEN
 FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
 lsLinea := interfazRecord(x).codigoTipoLogro     ||';'||
 interfazRecord(x).descripcionTipologro ;

 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
 END LOOP;
 END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
 utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;
 RETURN;
 EXCEPTION
 WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_LOGRO: '||ls_sqlerrm);
 END INT_PR_DAT_ENVIO_TIPO_LOGRO;

/***************************************************************************
Descripcion : Interfaz que envia logro consultora
Fecha Creacion : 16/02/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
         psCodigoMarca        : Codigo Marca
         psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LOGRO_CONSU
 (psCodigoPais VARCHAR2,
 psCodigoSistema VARCHAR2,
 psCodigoInterfaz VARCHAR2,
 psNombreArchivo VARCHAR2,
 psCodigoMarca VARCHAR2,
 psCodigoCanal VARCHAR2,
 psCodigoPeriodo VARCHAR2)
 IS
 CURSOR c_interfaz IS
     SELECT
 LC.COD_CLIE codigoCliente,
 (SELECT X.COD_GRUP_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VIS3) codigoGrupoSegmentoVisit3,
 (SELECT X.COD_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VIS3) codigoSegmentoVisit3,
 (SELECT X.COD_GRUP_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VIS6) codigoGrupoSegmentoVisit6,
 (SELECT X.COD_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VIS6) codigoSegmentoVisit6,
 (SELECT X.COD_GRUP_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VISI_ESTA) codigoGrupoSegmentoVisitEstab,
 (SELECT X.COD_SEGM FROM MAE_LOVE_SEGME X WHERE X.SEC_SEGM=LC.SEC_SEGM_VISI_ESTA) codigoSegmentoVisitEstab,
 LC.COD_TIPO_LOGR codigoTipoLogro,
 LC.DET_LOGR detalleLogro,
 LC.VAL_LOGR valorLogro,
 TO_CHAR(LC.FEC_ACTU_SEGM_VIS3,'ddMMyyyy') fechaVisit3,
 TO_CHAR(LC.FEC_ACTU_SEGM_VIS6,'ddMMyyyy') fechaVisit6,
 TO_CHAR(LC.FEC_ACTU_SEGM_VISI_ESTA,'ddMMyyyy') fechaVisitEstab,
 (SELECT X.ORD_TIPO_PREF
 FROM MAE_LOVE_PREFE_COMUN X
 WHERE X.COD_CLIE = LC.COD_CLIE
 AND X.COD_TIPO_PREF='DM') ordenVisitaDomicilio,
 (SELECT X.ORD_TIPO_PREF
 FROM MAE_LOVE_PREFE_COMUN X
 WHERE X.COD_CLIE = LC.COD_CLIE
 AND X.COD_TIPO_PREF='TF') ordenLlamadaTelefonica,
 (SELECT X.ORD_TIPO_PREF
 FROM MAE_LOVE_PREFE_COMUN X
 WHERE X.COD_CLIE = LC.COD_CLIE
 AND X.COD_TIPO_PREF='ML') ordenCorreoElectronico,
 (SELECT X.ORD_TIPO_PREF
 FROM MAE_LOVE_PREFE_COMUN X
 WHERE X.COD_CLIE = LC.COD_CLIE
 AND X.COD_TIPO_PREF='MT') ordenMensajeTexto,
     LC.CAM_INIC_LOGR campanaInicioLogro,
 LC.CAM_FINA_LOGR campanaFinLogro,
 LC.POR_ASIG_LOGR porcAsignacionLogro,
 LC.NEC_LOGR nesecidadLogro
     FROM MAE_LOVE_DATOS_ADICI LC
     ORDER BY LC.COD_CLIE;

 TYPE interfazTipo IS RECORD
 ( codigoCliente          MAE_LOVE_DATOS_ADICI.COD_CLIE%TYPE,
 codigoGrupoSegmentoVisit3     MAE_LOVE_SEGME.COD_GRUP_SEGM%TYPE,
 codigoSegmentoVisit3          MAE_LOVE_SEGME.COD_SEGM%TYPE,
 codigoGrupoSegmentoVisit6     MAE_LOVE_SEGME.COD_GRUP_SEGM%TYPE,
 codigoSegmentoVisit6          MAE_LOVE_SEGME.COD_SEGM%TYPE,
 codigoGrupoSegmentoVisitEstab MAE_LOVE_SEGME.COD_GRUP_SEGM%TYPE,
 codigoSegmentoVisitEstab         MAE_LOVE_SEGME.COD_SEGM%TYPE,
 codigoTipoLogro          MAE_LOVE_DATOS_ADICI.COD_TIPO_LOGR%TYPE,
 detalleLogro          MAE_LOVE_DATOS_ADICI.DET_LOGR%TYPE,
 valorLogro          MAE_LOVE_DATOS_ADICI.VAL_LOGR%TYPE,
 fechaVisit3          VARCHAR2(8),
 fechaVisit6          VARCHAR2(8),
 fechaVisitEstab          VARCHAR2(8),
 ordenVisitaDomicilio          MAE_LOVE_PREFE_COMUN.ORD_TIPO_PREF%TYPE,
 ordenLlamadaTelefonica         MAE_LOVE_PREFE_COMUN.ORD_TIPO_PREF%TYPE,
 ordenCorreoElectronico         MAE_LOVE_PREFE_COMUN.ORD_TIPO_PREF%TYPE,
 ordenMensajeTexto          MAE_LOVE_PREFE_COMUN.ORD_TIPO_PREF%TYPE,
 campanaInicioLogro          MAE_LOVE_DATOS_ADICI.CAM_INIC_LOGR%TYPE,
 campanaFinLogro          MAE_LOVE_DATOS_ADICI.CAM_FINA_LOGR%TYPE,
 porcAsignacionLogro          MAE_LOVE_DATOS_ADICI.POR_ASIG_LOGR%TYPE,
 nesecidadLogro          MAE_LOVE_DATOS_ADICI.NEC_LOGR%TYPE
 );

 TYPE interfazTab IS TABLE OF interfazTipo ;

 interfazRecord interfazTab;

 /* Variables usadas para la generacion del archivo de texto */
 lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
 W_FILAS NUMBER := 1000 ;
 v_handle UTL_FILE.FILE_TYPE;
 lsLinea VARCHAR2(1000);
 lbAbrirUtlFile BOOLEAN;
 lsNombreArchivo VARCHAR2(50);
BEGIN

 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz;
 LOOP
 FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
 /* Procedimiento inicial para generar interfaz */
 IF lbAbrirUtlFile THEN
 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
 lbAbrirUtlFile := FALSE;
 END IF;

 IF interfazRecord.COUNT > 0 THEN
 FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
 lsLinea := interfazRecord(x).codigoCliente      ||';'||
 interfazRecord(x).codigoGrupoSegmentoVisit3     ||';'||
 interfazRecord(x).codigoSegmentoVisit3      ||';'||
 interfazRecord(x).codigoGrupoSegmentoVisit6     ||';'||
 interfazRecord(x).codigoSegmentoVisit6      ||';'||
 interfazRecord(x).codigoGrupoSegmentoVisitEstab ||';'||
 interfazRecord(x).codigoSegmentoVisitEstab     ||';'||
 interfazRecord(x).codigoTipoLogro      ||';'||
 interfazRecord(x).detalleLogro      ||';'||
 interfazRecord(x).valorLogro      ||';'||
 interfazRecord(x).fechaVisit3      ||';'||
 interfazRecord(x).fechaVisit6      ||';'||
 interfazRecord(x).fechaVisitEstab      ||';'||
 interfazRecord(x).ordenVisitaDomicilio      ||';'||
 interfazRecord(x).ordenLlamadaTelefonica     ||';'||
 interfazRecord(x).ordenCorreoElectronico     ||';'||
 interfazRecord(x).ordenMensajeTexto      ||';'||
 interfazRecord(x).campanaInicioLogro      ||';'||
 interfazRecord(x).campanaFinLogro      ||';'||
 interfazRecord(x).porcAsignacionLogro      ||';'||
 interfazRecord(x).nesecidadLogro ;

 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
 END LOOP;
 END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
 utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;
 RETURN;

 EXCEPTION
 WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LOGRO_CONSU: '||ls_sqlerrm);
 END INT_PR_DAT_ENVIO_LOGRO_CONSU;

/**************************************************************************
 Descripcion : Devuelve la actividad del lider
 Fecha Creacion : 22/03/2010
 Parametros Entrada:
 psCodigoPeriodo : Codigo de Periodo
 psCodigoLider : Codigo Lider
 Autor : Sergio Buchelli
***************************************************************************/
FUNCTION INT_FN_DEVUE_ACTIV_LIDER
 (
 psCodigoPeriodo VARCHAR2,
 psCodigoLider VARCHAR2
 ) RETURN NUMBER
IS
 oidCliente MAE_CLIEN.OID_CLIE%TYPE;
 lnIdPeriodo seg_perio_corpo.oid_peri%TYPE;
 lnActividadLider NUMBER:=0;
 lnResultadoCierre NUMBER:=0;

 --    Recupera las secciones que la lider es responsable
 CURSOR cursorSeccionResponsableLider(oidCliente NUMBER) IS
 SELECT A.OID_SECC,
 A.ZZON_OID_ZONA
 FROM ZON_SECCI A
 WHERE A.IND_ACTI = 1
 AND A.IND_BORR = 0
 AND A.CLIE_OID_CLIE = oidCliente;

 lnNumeroPedidoTotal NUMBER:=0 ;
 lnNumeroPedidoXSeccion NUMBER:=0;
 lnNumActiFinalesTotales NUMBER:=0;
 lnNumActiFinales NUMBER:=0;
BEGIN


 oidCliente:=Gen_Pkg_Gener.GEN_FN_DEVUELVE_ID_CLIENTE(psCodigoLider);
 lnIdPeriodo := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2( psCodigoPeriodo);

 --    Cursor que Recupera las secciones que la lider es responsable
 FOR cSeccion IN cursorSeccionResponsableLider(oidCliente) LOOP
 /*
 Si existe Oids de secciones a las cuales la lider es responsable,
 entonces se verifica que por lo menos para algunas de las secciones
 ya se haya realizado el cierre de region
 */
 SELECT COUNT(1) INTO lnResultadoCierre
 FROM FAC_CONTR_CIERR F , FAC_TIPOS_CIERR Y
 WHERE F.PERD_OID_PERI=lnIdPeriodo
 AND F.TCIE_OID_TIPO_CIER = Y.OID_TIPO_CIER
 AND Y.COD_TIPO_CIER ='R'
 AND F.ZORG_OID_REGI IN (
 SELECT Z.ZORG_OID_REGI
 FROM ZON_ZONA Z
 WHERE F.ZORG_OID_REGI=Z.ZORG_OID_REGI
 AND Z.OID_ZONA = cSeccion.ZZON_OID_ZONA);

 IF(lnResultadoCierre > 0 ) THEN--si hay cierre

 /*
 si ya hay algun cierre de region, entonces se recupera el numero de pedidos que han pasado en esas secciones.
 */
 SELECT COUNT(1) INTO lnNumeroPedidoXSeccion
 FROM PED_SOLIC_CABEC A,
 PED_TIPO_SOLIC_PAIS B,
 PED_TIPO_SOLIC C,
 ZON_TERRI_ADMIN D
 WHERE A.PERD_OID_PERI = lnIdPeriodo
 AND C.COD_TIPO_SOLI = 'SOC'
 AND A.GRPR_OID_GRUP_PROC = 5
 AND A.FEC_FACT IS NOT NULL
 AND A.TSPA_OID_TIPO_SOLI_PAIS = B.OID_TIPO_SOLI_PAIS
 AND B.TSOL_OID_TIPO_SOLI = C.OID_TIPO_SOLI
 AND A.ZTAD_OID_TERR_ADMI = D.OID_TERR_ADMI
 AND A.TERR_OID_TERR = D.TERR_OID_TERR
 AND D.ZSCC_OID_SECC = cSeccion.OID_SECC;

 lnNumeroPedidoTotal:=lnNumeroPedidoTotal+lnNumeroPedidoXSeccion;

 /*
 Seguidamente se obtiene el numero de activas finales de esas secciones
 */

 SELECT NVL(SUM(A.NUM_ACTI_FINA),0)
 INTO lnNumActiFinales
 FROM INT_FUENT_VENTAS_REAL A,
 ZON_TERRI B,
 ZON_TERRI_ADMIN C
 WHERE A.PERD_OID_PERI = lnIdPeriodo
 AND A.TERR_OID_TERR = B.OID_TERR
 AND B.OID_TERR = C.TERR_OID_TERR
 AND C.ZSCC_OID_SECC = cSeccion.OID_SECC
 AND C.PERD_OID_PERI_INIC <= lnIdPeriodo
 AND (C.PERD_OID_PERI_FINA IS NULL OR C.PERD_OID_PERI_FINA >= lnIdPeriodo);

 lnNumActiFinalesTotales := lnNumActiFinalesTotales + lnNumActiFinales;


 END IF;


 END LOOP;

 IF(lnNumActiFinalesTotales > 0 ) THEN
 lnActividadLider:=(lnNumeroPedidoTotal*100)/lnNumActiFinalesTotales;
 END IF;

RETURN lnActividadLider;
EXCEPTION
WHEN NO_DATA_FOUND THEN
 RETURN 0;
WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_FN_DEVUE_ACTIV_LIDER: '||ls_sqlerrm);
END INT_FN_DEVUE_ACTIV_LIDER;


/***************************************************************************
Descripcion : Interfaz que envia las fechas de los documentos
Fecha Creacion : 25/03/2010
Autor : Jesse Rios
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca        : Codigo Marca
 psCodigoCanal        : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_DOCUM
 (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS

  CURSOR c_interfaz
  (
  ldFechaIni DATE,
  ldFechaFin DATE,
  lsOid_Peri seg_perio_corpo.oid_peri%TYPE
  ) IS

  SELECT pc.cod_peri aniocampania,
       sc.tspa_oid_tipo_soli_pais,
       conso.val_nume_soli numdocumentofacturacion,
       TO_CHAR((SELECT fec_soli FROM INT_SOLIC_CONSO_CABEC a WHERE a.soca_oid_soli_cabe_refe=sc.oid_soli_cabe and cod_clie=mc.cod_clie AND ind_ocs_proc=1 and cod_peri = pc.cod_peri ),'YYYYMMDD') fec_soli
  FROM ped_solic_cabec sc,
       cra_perio pe,
       seg_perio_corpo pc,
       mae_clien mc,
       (SELECT s.oid_soli_cabe, s.val_nume_soli, s.fec_fact
          FROM ped_solic_cabec s, cra_perio p1
         WHERE s.perd_oid_peri = p1.oid_peri
           --AND p1.oid_peri = (select c.oid_peri from cra_perio c, seg_perio_corpo d where c.PERI_OID_PERI=d.OID_PERI  and d.cod_peri=(select cod_peri from bas_ctrl_fact b where b.STA_CAMP=0 and b.IND_CAMP_ACT=1))
           AND p1.oid_peri = lsOid_peri
           --AND s.fec_fact = (select fec_proc from bas_ctrl_fact b where b.STA_CAMP=0 and b.IND_CAMP_ACT=1)
           AND s.ind_ts_no_conso = 0
           AND (s.ind_pedi_prue = 0 OR s.ind_pedi_prue IS NULL)
           ) conso,
       ped_tipo_solic ts,
       ped_tipo_solic_pais sp
 WHERE sc.soca_oid_soli_cabe = conso.oid_soli_cabe
   AND sc.ind_oc = 1
   AND sc.tspa_oid_tipo_soli_pais = sp.oid_tipo_soli_pais
   AND sp.tsol_oid_tipo_soli = ts.oid_tipo_soli
   AND sc.clie_oid_clie = mc.oid_clie
   AND sc.perd_oid_peri = pe.oid_peri
   AND pe.peri_oid_peri = pc.oid_peri
   AND ts.ind_devo = 0 AND ts.ind_anul = 0
   and sc.perd_oid_peri= lsOid_peri
   /*and sc.perd_oid_peri=(select c.oid_peri from cra_perio c, seg_perio_corpo d where c.PERI_OID_PERI=d.OID_PERI
   and d.cod_peri=(select cod_peri from bas_ctrl_fact b where b.STA_CAMP=0 and b.IND_CAMP_ACT=1))
   AND sc.fec_fact = (select fec_proc from bas_ctrl_fact b where b.STA_CAMP=0 and b.IND_CAMP_ACT=1);
   */
   AND sc.fec_fact >= ldFechaIni
   AND sc.fec_fact <= ldFechaFin;

   TYPE interfazTipo IS RECORD
   (
        aniocampania            seg_perio_corpo.cod_peri%TYPE,
        tipoSoliPais            ped_solic_cabec.tspa_oid_tipo_soli_pais%TYPE,
        numDocumentoFacturacion ped_solic_cabec.val_nume_soli%TYPE,
        fechaSolicitud          VARCHAR2(8)
   );

   TYPE interfazTab IS TABLE OF interfazTipo;

   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS NUMBER := 1000 ;
   v_handle UTL_FILE.FILE_TYPE;
   lsLinea VARCHAR2(1000);
   lbAbrirUtlFile BOOLEAN;
   lsNombreArchivo VARCHAR2(50);
   ldFechaIni          DATE;
   ldFechaFin          DATE;
   lsOid_peri          seg_perio_corpo.oid_peri%TYPE;
BEGIN

     select c.FEC_INIC,c.FEC_FINA, c.OID_PERI
     into ldFechaIni,ldFechaFin, lsOid_Peri
     from cra_perio c,
          seg_perio_corpo s
     where s.OID_PERI = c.PERI_OID_PERI
     and s.COD_PERI = psCodigoPeriodo;

  /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz ( ldFechaIni,ldFechaFin, lsOid_Peri );

 LOOP
 FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
 /* Procedimiento inicial para generar interfaz */
 IF lbAbrirUtlFile THEN
 GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
 lbAbrirUtlFile := FALSE;
 END IF;

 IF interfazRecord.COUNT > 0 THEN
 FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
 lsLinea := interfazRecord(x).aniocampania      ||';'||
 interfazRecord(x).tipoSoliPais     ||';'||
 interfazRecord(x).numDocumentoFacturacion      ||';'||
 interfazRecord(x).fechaSolicitud;

 UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
 END LOOP;
 END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
 utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;

RETURN;
EXCEPTION
 WHEN OTHERS THEN
 ln_sqlcode := SQLCODE;
 ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_FECHA_DOCUM: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_FECHA_DOCUM;

/***************************************************************************
Descripcion : Interfaz que envia informacion clientes (DAT-2)
Fecha Creacion : 30/11/2010
Autor : Sergio Buchelli
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLIEN
 (psCodigoPais VARCHAR2,
   psCodigoSistema VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo VARCHAR2,
   psCodigoMarca VARCHAR2,
   psCodigoCanal VARCHAR2,
   psCodigoPeriodo VARCHAR2)
IS

  CURSOR c_interfaz (vnidpais NUMBER, fechaActualizacionInterfaz DATE)IS
   SELECT
       clie.cod_clie AS codigoConsultora,
       uadm.cod_terr AS codigoterritorio,
       clie.val_nom1 AS nombre1,
       clie.val_nom2 AS nombre2,
       clie.val_ape1 AS apellidoPaterno,
       clie.val_ape2 AS apellidoMaterno,
       nsep.cod_nsep NSE,
       cprc.cod_peri AS anioCampaniaIngreso,
       to_char(clda.fec_naci,'yyyymmdd') AS fechaNacimiento,
       pq_apl_aux.valor_gen_i18n_sicc(1, clda.escv_oid_esta_civi, 'MAE_ESTAD_CIVIL') AS estadocivil,
       nvl(clie.SAL_DEUD_ANTE,0) - nvl(clie.val_recl_pend,0) AS saldo,
       (
        SELECT MAX(cor.cod_peri)
          FROM ped_solic_cabec_acum2 acu,
               cra_perio cra,
               seg_perio_corpo cor
         WHERE acu.perd_oid_peri= cra.oid_peri
           AND cra.peri_oid_peri = cor.oid_peri
           AND acu.clie_oid_clie = clie.oid_clie
       ) AS anioCampanaUltimoPedido,
       obtener_indicadores (clie.oid_clie, 1) AS indicadorEstrella,
       NVL(pq_apl_int.func_obten_tipo_curso_clien(clie.oid_clie),'') AS codigoUltimoCursoRecibido,
       NVL(docu.cod_tipo_docu,'') AS tipoDocumentoIdentidad,
       NVL(docu.num_docu_iden,'') AS numeroDocumentoIdentidad,
       NVL ( decl.ind_activ, '0') AS indicadorActiva,
       CASE
          WHEN ( clda.esta_oid_esta_clie = 5 AND clda.num_camp_sin_pedi > 2 ) THEN pq_apl_aux.valor_gen_i18n_sicc(1,7,'MAE_ESTAT_CLIEN')
          ELSE
             CASE
                WHEN clda.esta_oid_esta_clie = 8 THEN
                     pq_apl_aux.valor_gen_i18n_sicc (1,2,'MAE_ESTAT_CLIEN')
                ELSE pq_apl_aux.valor_gen_i18n_sicc (1,clda.esta_oid_esta_clie,'MAE_ESTAT_CLIEN')
             END
       END AS estatusVentaVigente,
       SUBSTR(cltf.val_text_comu,0,15) AS telefono,
       SUBSTR(cltt.val_text_comu,0,15) AS telefonoTrabajo,
       dire.nivel_1 AS departamento,
       dire.nivel_2 AS provincia,
       dire.nivel_3 AS distrito,
       SUBSTR( dire.des_abrv_tipo_via || ' '|| dire.val_nomb_via || ' ' || TRIM (num_ppal) || ' ' || TRIM (val_inte) || ' ' || TRIM (val_obse),0,80) AS direccion,
       dire.descripcionTipoCentroPoblado,
       dire.descripcionCentroPoblado,
       uadm.val_nom1 AS nombre1Lider,
       uadm.val_nom2 AS nombre2Lider,
       uadm.val_ape1 AS apellido1Lider,
       uadm.val_ape2 AS apellido2Lider,
       dire.codigoTipoCentroPoblado,
       dire.codigoCentroPoblado,
       NVL(dire.Orde_1,'') AS orden1,
       NVL(dire.Orde_2,'') AS orden2,
       NVL(dire.Orde_3,'') AS orden3,
       NVL(dire.Orde_4,'') AS orden4,
       NVL(dire.Orde_5,'') AS orden5,
       NVL(dire.Orde_6,'') AS orden6,
       NVL(dire.Orde_7,'') AS orden7,
       NVL(dire.Orde_8,'') AS orden8,
       NVL(dire.Orde_9,'') AS orden9,
       obtener_indicadores (clie.oid_clie, 2) AS indicadorLider,
       obtener_indicadores (clie.oid_clie, 3) AS indicadorGerenteZona,
       obtener_indicadores (clie.oid_clie, 4) AS indicadorGerenteRegion,
       reco.cod_clie AS codigoconsultorarecomendante,
       cprc.cod_tipo_cont AS codigoFuenteIngresos,
       ccla.cod_clie_anti AS codigoAnterior,
       NVL (dupl.flag, '0') AS flagDuplaCyzone,
       CASE WHEN acci.oid_clie IS NOT NULL THEN '0' ELSE '1' END AS flagTipoAccion,
       (
        SELECT SUBSTR( MIN( LPAD(tibq.num_nive_grav_bloq,3,'0')
                            || tibq.cod_tipo_bloq
                            || TO_CHAR(TRUNC(clbl.fec_bloq),'YYYYMMDD')
                            || x.val_i18n),4,2)
          FROM mae_clien_bloqu clbl,
               mae_tipo_bloqu tibq,
               mae_accio_proce_bloqu mpbl,
               mae_accio_bloqu mabl,
               mae_proce_bloqu mapb,
               gen_i18n_sicc_comun x
         WHERE clbl.tibq_oid_tipo_bloq = tibq.oid_tipo_bloq
           AND tibq.oid_tipo_bloq = mpbl.tibq_oid_tipo_bloq
           AND mpbl.mabl_oid_acci_bloq = mabl.oid_acci_bloq
           AND mpbl.mapb_oid_proc_bloq = mapb.oid_proc_bloq
           AND tibq.oid_tipo_bloq = x.val_oid
           --
           AND mapb.cod_proc_bloq = 'FA'
           AND mabl.cod_acci_bloq = 'FN'
           AND x.attr_enti = 'MAE_TIPO_BLOQU'
           AND clbl.fec_desb IS NULL
           AND clbl.clie_oid_clie = clie.oid_clie
       ) FlagBloqueo,
       (
        SELECT SUBSTR( MIN( LPAD(tibq.num_nive_grav_bloq,3,'0')
                            || tibq.cod_tipo_bloq
                            || TO_CHAR(TRUNC(clbl.fec_bloq),'YYYYMMDD')
                            || x.val_i18n),14)
          FROM mae_clien_bloqu clbl,
               mae_tipo_bloqu tibq,
               mae_accio_proce_bloqu mpbl,
               mae_accio_bloqu mabl,
               mae_proce_bloqu mapb,
               gen_i18n_sicc_comun x
         WHERE clbl.tibq_oid_tipo_bloq = tibq.oid_tipo_bloq
           AND tibq.oid_tipo_bloq = mpbl.tibq_oid_tipo_bloq
           AND mpbl.mabl_oid_acci_bloq = mabl.oid_acci_bloq
           AND mpbl.mapb_oid_proc_bloq = mapb.oid_proc_bloq
           AND tibq.oid_tipo_bloq = x.val_oid
           --
           AND mapb.cod_proc_bloq = 'FA'
           AND mabl.cod_acci_bloq = 'FN'
           AND x.attr_enti = 'MAE_TIPO_BLOQU'
           AND clbl.fec_desb IS NULL
           AND clbl.clie_oid_clie = clie.oid_clie
       ) DesBloqueo,
       clie.cod_digi_ctrl as digit_ctrl,
       dire.val_cod_post
  FROM (
         SELECT oid_clie AS clie_oid_clie FROM mae_clien clie WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie FROM mae_clien_datos_adici WHERE fec_ulti_actu > ( fechaActualizacionInterfaz  )
         UNION
         SELECT clie_oid_clie FROM mae_clien_unida_admin WHERE ind_acti = 1 AND fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie_vndo AS clie_oid_clie FROM mae_clien_vincu WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie FROM mae_clien_prime_conta WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie FROM mae_clien_direc WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie FROM mae_clien_comun WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
         UNION
         SELECT clie_oid_clie_vndo FROM mae_clien_vincu WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
        UNION
        SELECT clie_oid_clie_vnte FROM mae_clien_vincu WHERE fec_ulti_actu > ( fechaActualizacionInterfaz )
        UNION
         SELECT clbl.clie_oid_clie
           FROM mae_clien_bloqu clbl
          WHERE clbl.fec_desb IS NULL
        UNION
        SELECT clie.oid_clie clie_oid_clie
          FROM int_tmp_gener_solic_cabec temp,
               mae_clien clie
         WHERE temp.cod_clie = clie.cod_clie
         GROUP BY clie.oid_clie
       ) data,
       mae_clien clie,
       mae_clien_datos_adici clda,
       mae_tipo_nivel_socec_perso nsep,
       (
         SELECT cprc.*, peri.cod_peri
           FROM (
                  SELECT clie.oid_clie, cod_tipo_cont,
                         CASE
                            WHEN cprc.perd_oid_peri IS NOT NULL THEN
                                 cprc.perd_oid_peri
                            ELSE CASE
                                    WHEN clhe.perd_oid_peri IS NOT NULL THEN
                                         clhe.perd_oid_peri
                                    ELSE NULL
                                 END
                         END AS perd_oid_peri
                     FROM mae_clien clie,
                         mae_clien_prime_conta cprc,
                         ( SELECT clie_oid_clie, MIN(perd_oid_peri) perd_oid_peri FROM mae_clien_histo_estat GROUP BY clie_oid_clie ) clhe
                   WHERE clie.oid_clie = cprc.clie_oid_clie(+)
                     AND clie.oid_clie = clhe.clie_oid_clie(+)
                ) cprc,
                cra_perio perd,
                seg_perio_corpo peri
          WHERE cprc.perd_oid_peri = perd.oid_peri
            AND perd.peri_oid_peri = peri.oid_peri
       ) cprc,
       int_dat_estat_clien decl,
       mae_codig_clien_anter ccla,
       (
        SELECT clie_oid_clie_vndo, clie_oid_clie_vnte, tivc_oid_tipo_vinc, clie.cod_clie
          FROM mae_clien_vincu cvin,
               mae_clien clie,
               mae_tipo_vincu tivc
         WHERE cvin.clie_oid_clie_vnte = clie.oid_clie
           AND cvin.tivc_oid_tipo_vinc = tivc.oid_tipo_vinc
           AND tivc.ind_reco = 1
       ) reco,
       (
         SELECT a.clie_oid_clie, a.oid_clie_dire OID, c.cod_tipo_via, c.des_abrv_tipo_via, a.val_nomb_via, a.num_ppal, a.val_inte,
                a.val_obse, a.val_barr, t.cod_terr, a.val_cod_post,
                (
                 SELECT des_geog
                   FROM ZON_VALOR_ESTRU_GEOPO
                  WHERE pais_oid_pais = d.pais_oid_pais
                    AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                    AND orde_2 IS NULL
                ) AS nivel_1,
                (
                 SELECT des_geog
                   FROM ZON_VALOR_ESTRU_GEOPO
                  WHERE pais_oid_pais = d.pais_oid_pais
                    AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                    AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                    AND orde_3 IS NULL
                ) AS nivel_2,
                (
                 SELECT des_geog
                   FROM ZON_VALOR_ESTRU_GEOPO
                  WHERE pais_oid_pais = d.pais_oid_pais
                    AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                    AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                    AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                    AND orde_4 IS NULL
                ) AS nivel_3,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 18
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 IS NULL)
                   ELSE NULL
                END AS nivel_4,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 24
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 = SUBSTR (a.cod_unid_geog, 25, 6)
                               AND orde_6 IS NULL)
                  ELSE NULL
                END AS nivel_5,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 30
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 = SUBSTR (a.cod_unid_geog, 25, 6)
                               AND orde_6 = SUBSTR (a.cod_unid_geog, 31, 6)
                               AND orde_7 IS NULL)
                   ELSE NULL
                END AS nivel_6,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 36
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 = SUBSTR (a.cod_unid_geog, 25, 6)
                               AND orde_6 = SUBSTR (a.cod_unid_geog, 31, 6)
                               AND orde_7 = SUBSTR (a.cod_unid_geog, 37, 6)
                               AND orde_8 IS NULL)
                   ELSE NULL
                END AS nivel_7,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 42
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 = SUBSTR (a.cod_unid_geog, 25, 6)
                               AND orde_6 = SUBSTR (a.cod_unid_geog, 31, 6)
                               AND orde_7 = SUBSTR (a.cod_unid_geog, 37, 6)
                               AND orde_8 = SUBSTR (a.cod_unid_geog, 43, 6)
                               AND orde_9 IS NULL)
                   ELSE NULL
                END AS nivel_8,
                CASE
                   WHEN LENGTH (a.cod_unid_geog) > 48
                      THEN (SELECT des_geog
                              FROM ZON_VALOR_ESTRU_GEOPO
                             WHERE pais_oid_pais = d.pais_oid_pais
                               AND orde_1 = SUBSTR (a.cod_unid_geog, 1, 6)
                               AND orde_2 = SUBSTR (a.cod_unid_geog, 7, 6)
                               AND orde_3 = SUBSTR (a.cod_unid_geog, 13, 6)
                               AND orde_4 = SUBSTR (a.cod_unid_geog, 19, 6)
                               AND orde_5 = SUBSTR (a.cod_unid_geog, 25, 6)
                               AND orde_6 = SUBSTR (a.cod_unid_geog, 31, 6)
                               AND orde_7 = SUBSTR (a.cod_unid_geog, 37, 6)
                               AND orde_8 = SUBSTR (a.cod_unid_geog, 43, 6)
                               AND orde_9 = SUBSTR (a.cod_unid_geog, 49, 6))
                   ELSE NULL
                END AS nivel_9,
                CASE
                   WHEN (vepo.orde_4 IS NULL)
                      THEN NULL
                   ELSE (
                         SELECT pq_apl_aux.valor_gen_i18n_sicc
                                   (1,
                                    (
                                     SELECT nivel.sgeo_oid_sube_geop
                                       FROM zon_valor_estru_geopo nivel
                                      WHERE nivel.orde_1 = vepo.orde_1
                                        AND nivel.orde_2 = vepo.orde_2
                                        AND nivel.orde_3 = vepo.orde_3
                                        AND nivel.orde_4 = vepo.orde_4
                                        AND nivel.orde_5 IS NULL
                                        AND nivel.pais_oid_pais = d.pais_oid_pais
                                        AND ROWNUM = 1),
                                    'ZON_SUBES_GEOPO'
                                   )
                           FROM DUAL
                        )
                END AS descripciontipocentropoblado,
                CASE
                   WHEN (vepo.orde_4 IS NULL)
                      THEN NULL
                   ELSE (
                         SELECT nivel.des_geog
                           FROM zon_valor_estru_geopo nivel
                          WHERE nivel.orde_1 = vepo.orde_1
                            AND nivel.orde_2 = vepo.orde_2
                            AND nivel.orde_3 = vepo.orde_3
                            AND nivel.orde_4 = vepo.orde_4
                            AND nivel.orde_5 IS NULL
                            AND nivel.pais_oid_pais = d.pais_oid_pais
                            AND ROWNUM = 1
                        )
                END AS descripcioncentropoblado,
                (
                 SELECT zsg.cod_sube
                   FROM zon_subes_geopo zsg
                  WHERE zsg.oid_sube_geop =
                           (
                            SELECT nivel.sgeo_oid_sube_geop
                              FROM zon_valor_estru_geopo nivel
                             WHERE nivel.orde_1 = vepo.orde_1
                               AND nivel.orde_2 = vepo.orde_2
                               AND nivel.orde_3 = vepo.orde_3
                               AND nivel.orde_4 = vepo.orde_4
                               AND nivel.orde_5 IS NULL
                               AND nivel.pais_oid_pais = d.pais_oid_pais
                               AND ROWNUM = 1
                            )
                ) AS codigotipocentropoblado,
                (
                 SELECT nivel.orde_4
                   FROM zon_valor_estru_geopo nivel
                  WHERE nivel.orde_1 = vepo.orde_1
                    AND nivel.orde_2 = vepo.orde_2
                    AND nivel.orde_3 = vepo.orde_3
                    AND nivel.orde_4 = vepo.orde_4
                    AND nivel.orde_5 IS NULL
                    AND nivel.pais_oid_pais = d.pais_oid_pais
                    AND ROWNUM = 1
                ) AS codigocentropoblado,
                vepo.Orde_1, vepo.Orde_2, vepo.Orde_3, vepo.Orde_4, vepo.Orde_5, vepo.Orde_6, vepo.Orde_7, vepo.Orde_8, vepo.Orde_9
           FROM mae_clien_direc a,
                mae_tipo_direc b,
                seg_tipo_via c,
                mae_clien d,
                zon_terri t,
                zon_valor_estru_geopo vepo
          WHERE d.OID_CLIE = a.CLIE_OID_CLIE
            AND b.OID_TIPO_DIRE = a.TIDC_OID_TIPO_DIRE
            AND c.OID_TIPO_VIA = a.TIVI_OID_TIPO_VIA
            AND a.TERR_OID_TERR = t.OID_TERR (+)
            AND t.vepo_oid_valo_estr_geop = vepo.oid_valo_estr_geop(+)
            AND a.IND_ELIM = 0
            AND a.IND_DIRE_PPAL  = 1
       ) dire,
       (
         SELECT cuad.clie_oid_clie, zorg.oid_regi, zzon.oid_zona, zscc.oid_secc , terr.oid_terr,
                cuad.ind_acti, zorg.cod_regi, zzon.cod_zona, zscc.cod_secc, terr.cod_terr,
                lide.val_ape1, lide.val_ape2, lide.val_nom1, lide.val_nom2
           FROM mae_clien_unida_admin cuad,
                zon_terri_admin ztad,
                zon_secci zscc,
                zon_terri terr,
                zon_zona zzon,
                zon_regio zorg,
                mae_clien clie,
                mae_clien lide
          WHERE cuad.ztad_oid_terr_admi = ztad.oid_terr_admi
            AND cuad.clie_oid_clie = clie.oid_clie
            AND ztad.zscc_oid_secc = zscc.oid_secc
            AND ztad.terr_oid_terr = terr.oid_terr
            AND zscc.zzon_oid_zona = zzon.oid_zona
            AND zscc.clie_oid_clie = lide.oid_clie(+)
            AND zzon.zorg_oid_regi = zorg.oid_regi
            -- Condicion adicional --
            AND cuad.ind_acti = 1
       ) uadm,
       (
         SELECT clid.clie_oid_clie, tdoc.oid_tipo_docu, tdoc.cod_tipo_docu, clid.num_docu_iden
           FROM mae_clien_ident clid,
                mae_tipo_docum tdoc
          WHERE clid.tdoc_oid_tipo_docu = tdoc.oid_tipo_docu
            AND clid.val_iden_docu_prin = 1
       ) docu,
       (
         SELECT clco.clie_oid_clie, ticm.oid_tipo_comu, ticm.cod_tipo_comu, clco.val_text_comu
           FROM mae_clien_comun clco,
                mae_tipo_comun ticm
          WHERE clco.ticm_oid_tipo_comu = ticm.oid_tipo_comu
            AND cod_tipo_comu = 'TF'
       ) cltf,
       (
         SELECT clco.clie_oid_clie, ticm.oid_tipo_comu, ticm.cod_tipo_comu, clco.val_text_comu
           FROM mae_clien_comun clco,
                mae_tipo_comun ticm
          WHERE clco.ticm_oid_tipo_comu = ticm.oid_tipo_comu
            AND cod_tipo_comu = 'TT'
       ) cltt,
       (
         SELECT mcts.clie_oid_clie, '1' AS flag
           FROM mae_clien_clasi mcc,
                mae_clien_tipo_subti mcts,
                mae_clasi mc,
                mae_tipo_clasi_clien mtcc,
                mae_subti_clien msc,
                mae_tipo_clien mtc
          WHERE mcc.ctsu_oid_clie_tipo_subt = mcts.oid_clie_tipo_subt
            AND mcc.clas_oid_clas = mc.oid_clas
            AND mcc.tccl_oid_tipo_clasi = mtcc.oid_tipo_clas
            AND mcts.ticl_oid_tipo_clie = mtc.oid_tipo_clie
            AND mcts.sbti_oid_subt_clie = msc.oid_subt_clie
            AND mc.oid_clas = (select oid_clas from mae_clasi where cod_clas='01' and TCCL_OID_TIPO_CLAS = mtcc.OID_TIPO_CLAS)
            AND mtcc.oid_tipo_clas = (select OID_TIPO_CLAS from mae_tipo_clasi_clien where cod_tipo_clas='23' and SBTI_OID_SUBT_CLIE = mcts.sbti_oid_subt_clie)
       ) dupl,
       (
             SELECT clie.oid_clie
               FROM mae_clien clie
              WHERE NOT TRUNC (clie.fec_ulti_actu) > TRUNC (clie.fec_crea)
                AND clie.fec_ulti_actu > fechaActualizacionInterfaz
           ) acci
 WHERE data.clie_oid_clie = clie.oid_clie
   AND data.clie_oid_clie = clda.clie_oid_clie
   AND data.clie_oid_clie = dire.clie_oid_clie(+)
   AND data.clie_oid_clie = uadm.clie_oid_clie(+)
   AND data.clie_oid_clie = cprc.oid_clie(+)
   AND data.clie_oid_clie = docu.clie_oid_clie(+)
   AND data.clie_oid_clie = cltf.clie_oid_clie(+)
   AND data.clie_oid_clie = cltt.clie_oid_clie(+)
   AND data.clie_oid_clie = ccla.clie_oid_clie_nuev(+)
   AND data.clie_oid_clie = reco.clie_oid_clie_vndo(+)
   AND data.clie_oid_clie = dupl.clie_oid_clie(+)
   AND data.clie_oid_clie = acci.oid_clie(+)
   AND clda.nsep_oid_nsep = nsep.oid_nsep(+)
   AND clda.esta_oid_esta_clie = decl.esta_oid_esta_clie(+);



   TYPE interfazTipo IS RECORD
   (
        codigoconsultora                    mae_clien.cod_clie%TYPE,
        codigoterritorio                    zon_terri.cod_terr%TYPE,
        nombre1                             mae_clien.val_nom1%TYPE,
        nombre2                             mae_clien.val_nom2%TYPE,
        apellidoPaterno                     mae_clien.val_ape1%TYPE,
        apellidoMaterno                     mae_clien.val_ape2%TYPE,
        cod_nsep                            VARCHAR2(15),
        anioCampaniaIngreso                 VARCHAR2(6),
        fechaNacimiento                     VARCHAR2(8),
        estadocivil                         VARCHAR2(40),
        saldo                               NUMBER(12),
        anioCampanaUltimoPedido             VARCHAR2(6),
        indicadorEstrella                   VARCHAR2(1),
        codigoUltimoCursoRecibido           VARCHAR2(5),
        tipoDocumentoIdentidad              mae_tipo_docum.cod_tipo_docu%TYPE,
        numeroDocumentoIdentidad            mae_clien_ident.num_docu_iden%TYPE,
        indicadorActiva                     VARCHAR2(1),
        estatusVentaVigente                 VARCHAR2(40),
        telefono                            mae_clien_comun.val_text_comu%TYPE,
        telefonoTrabajo                     mae_clien_comun.val_text_comu%TYPE,
        departamento                        zon_valor_estru_geopo.des_geog%TYPE,
        provincia                           zon_valor_estru_geopo.des_geog%TYPE,
        distrito                            zon_valor_estru_geopo.des_geog%TYPE,
        direccion                           VARCHAR2(80), -- esta truncado a 80 en el select
        descripcionTipoCentroPoblado        VARCHAR2(50),
        descripcionCentroPoblado        	  zon_valor_estru_geopo.des_geog%TYPE,
        nombre1Lider                        mae_clien.val_nom1%TYPE,
        nombre2Lider                        mae_clien.val_nom2%TYPE,
        apellido1Lider                      mae_clien.val_ape1%TYPE,
        apellido2Lider                      mae_clien.val_ape2%TYPE,
        codigoTipoCentroPoblado             VARCHAR2(2),
        codigoCentroPoblado                 VARCHAR2(6),
        orden1                              zon_valor_estru_geopo.orde_1%TYPE,
        orden2                              zon_valor_estru_geopo.orde_2%TYPE,
        orden3                              zon_valor_estru_geopo.orde_3%TYPE,
        orden4                              zon_valor_estru_geopo.orde_4%TYPE,
        orden5                              zon_valor_estru_geopo.orde_5%TYPE,
        orden6                              zon_valor_estru_geopo.orde_6%TYPE,
        orden7                              zon_valor_estru_geopo.orde_7%TYPE,
        orden8                              zon_valor_estru_geopo.orde_8%TYPE,
        orden9                              zon_valor_estru_geopo.orde_9%TYPE,
        indicadorLider                      VARCHAR2(1),
        indicadorGerenteZona                VARCHAR2(1),
        indicadorGerenteRegion              VARCHAR2(1),
        codigoconsultorarecomendante        mae_clien.cod_clie%TYPE,
        codigoFuenteIngresos                VARCHAR2(3),
        codigoAnterior                      mae_codig_clien_anter.cod_clie_anti%TYPE,
        flagDuplaCyzone                     VARCHAR2(1),
        flagTipoAccion                      VARCHAR2(1),
        FlagBloqueo                         VARCHAR2(2),
        DesBloqueo                          VARCHAR2(50),
        digitCtrl                           mae_clien.cod_digi_ctrl%type,
        codPost                             mae_clien_direc.val_cod_post%type
   );

   TYPE interfazTab IS TABLE OF interfazTipo;

   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
   v_handle UTL_FILE.FILE_TYPE;
   lsLinea VARCHAR2(1000);
   lbAbrirUtlFile BOOLEAN;
   lsNombreArchivo VARCHAR2(50);
   pdFechaUltimaActualizacion DATE;
   lnidpais NUMBER;

BEGIN
  lnidpais := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);

  SELECT MAX(FEC_IPRO) INTO pdFechaUltimaActualizacion
  FROM BAS_HISTO_LOTES
  WHERE PAIS_COD_PAIS = psCodigoPais
     AND SIST_COD_SIST= psCodigosistema
     AND INTE_COD_INTE = psCodigoInterfaz
     AND IND_LOER ='N'
     AND FEC_FPRO IS NOT NULL;

 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz(lnidpais, pdFechaUltimaActualizacion);
  LOOP
   FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
    /* Procedimiento inicial para generar interfaz */
    IF lbAbrirUtlFile THEN
       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
       lbAbrirUtlFile := FALSE;
    END IF;

    IF interfazRecord.COUNT > 0 THEN
     FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
     lsLinea := interfazRecord(x).codigoconsultora             ||';'||
                          interfazRecord(x).codigoterritorio             ||';'||
                          interfazRecord(x).nombre1 ||' '||interfazRecord(x).nombre2 ||' '|| interfazRecord(x).apellidoPaterno ||' '||   interfazRecord(x).apellidoMaterno  ||';'||
                          interfazRecord(x).Nombre1 ||' '||interfazRecord(x).Nombre2 ||';'||
                          interfazRecord(x).apellidoPaterno              ||';'||
                          interfazRecord(x).apellidoMaterno              ||';'||
                          interfazRecord(x).cod_nsep                     ||';'||
                          interfazRecord(x).anioCampaniaIngreso          ||';'||
                          interfazRecord(x).fechaNacimiento              ||';'||
                          interfazRecord(x).estadocivil                  ||';'||
                          ltrim(nvl(to_char(interfazRecord(x).saldo,'999999999990.99'),0))||';'||
                         interfazRecord(x).anioCampanaUltimoPedido    ||';'||
                          '' ||';'||
                          '' ||';'||
                          '' ||';'||
                          '' ||';'||
                          '' ||';'||
                          interfazRecord(x).indicadorEstrella            ||';'||
                          '' ||';'||
                          interfazRecord(x).codigoUltimoCursoRecibido    ||';'||
                          interfazRecord(x).tipoDocumentoIdentidad       ||';'||
                          interfazRecord(x).numeroDocumentoIdentidad     ||';'||
                          interfazRecord(x).indicadorActiva              ||';'||
                          interfazRecord(x).estatusVentaVigente          ||';'||
                          '' ||';'||
                          interfazRecord(x).telefono                     ||';'||
                          interfazRecord(x).telefonoTrabajo              ||';'||
                          interfazRecord(x).departamento                 ||';'||
                          interfazRecord(x).provincia                    ||';'||
                          interfazRecord(x).distrito                     ||';'||
                          interfazRecord(x).direccion                    ||';'||
                          '' ||';'||
                          '' ||';'||
                          '' ||';'||
                          interfazRecord(x).descripcionTipoCentroPoblado ||';'||
                          interfazRecord(x).descripcionCentroPoblado     ||';'||
                          interfazRecord(x).nombre1Lider||' '||  interfazRecord(x).nombre2Lider ||' '|| interfazRecord(x).apellido1Lider  ||' '|| interfazRecord(x).apellido2Lider  ||';'||
                          interfazRecord(x).codigoTipoCentroPoblado      ||';'||
                          interfazRecord(x).codigoCentroPoblado          ||';'||
                          NVL(interfazRecord(x).orden1,'')||
                          NVL(interfazRecord(x).orden2,'')||
                          NVL(interfazRecord(x).orden3,'')||
                          NVL(interfazRecord(x).orden4,'')||
                          NVL(interfazRecord(x).orden5,'')||
                          NVL(interfazRecord(x).orden6,'')||
                          NVL(interfazRecord(x).orden7,'')||
                          NVL(interfazRecord(x).orden8,'')||
                          NVL(interfazRecord(x).orden9,'')							 ||';'||
                          interfazRecord(x).indicadorLider               ||';'||
                          interfazRecord(x).indicadorGerenteZona         ||';'||
                          interfazRecord(x).indicadorGerenteRegion       ||';'||
                          interfazRecord(x).codigoconsultorarecomendante ||';'||
                          NVL(interfazRecord(x).codigoFuenteIngresos,'')         ||';'||
                          NVL(interfazRecord(x).codigoAnterior,'')               ||';'||
                          '' ||';'||
                          interfazRecord(x).flagDuplaCyzone                      ||';'||
                          interfazRecord(x).flagTipoAccion               ||';'||
                          interfazRecord(x).FlagBloqueo                  ||';'||
                          interfazRecord(x).DesBloqueo                   ||';'||
                          interfazRecord(x).digitCtrl                    ||';'||
                          interfazRecord(x).codPost;

     UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
     END LOOP;
    END IF;
   EXIT WHEN c_interfaz%NOTFOUND;
  END LOOP;
 CLOSE c_interfaz;

 IF NOT lbAbrirUtlFile THEN
    utl_file.fclose(V_HANDLE);

 /* Procedimiento final para generar interfaz */
 GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;

RETURN;
EXCEPTION
 WHEN OTHERS THEN
  ln_sqlcode := SQLCODE;
  ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CLIEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CLIEN;


/***************************************************************************
Descripcion : Interfaz que envia informacion Maestro Hijas Duplas (DAT-37)
Fecha Creacion : 11/01/2010
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
 psCodigoPeriodo : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_HIJAS_DUPLA
 (psCodigoPais          VARCHAR2,
  psCodigoSistema         VARCHAR2,
  psCodigoInterfaz         VARCHAR2,
  psNombreArchivo         VARCHAR2,
  psCodigoMarca         VARCHAR2,
  psCodigoCanal         VARCHAR2,
  psCodigoPeriodo         VARCHAR2)
IS
  CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, fechaActualizacionInterfaz DATE, vnDuplaEdadMin NUMBER, vnDuplaEdadMax NUMBER)IS
          SELECT MC.COD_CLIE codigoCliente,
               MAD_DUP.COD_CLIE codigoMadreDupla,
               MC.VAL_APE1 apellidoPaterno,
               MC.VAL_APE2 apellidoMaterno,
               MC.VAL_NOM1 nombre1,
               MC.VAL_NOM2 nombre2,
               TO_CHAR(CA.FEC_NACI,'YYYYMMDD') fechaNacimiento,
               (SELECT C.VAL_TEXT_COMU
                 FROM MAE_CLIEN_COMUN C, MAE_TIPO_COMUN TC
                 WHERE C.CLIE_OID_CLIE = MC.OID_CLIE
                   AND C.TICM_OID_TIPO_COMU = TC.OID_TIPO_COMU
                   AND TC.COD_TIPO_COMU = 'ML'                                   -- Email
                   AND ROWNUM = 1) email,
               (SELECT C.VAL_TEXT_COMU
                 FROM MAE_CLIEN_COMUN C, MAE_TIPO_COMUN TC
                 WHERE C.CLIE_OID_CLIE = MC.OID_CLIE
                   AND C.TICM_OID_TIPO_COMU = TC.OID_TIPO_COMU
                   AND TC.COD_TIPO_COMU = 'TF'                                -- Telefono Fijo
                   AND ROWNUM = 1) telefonoFijo,
               (SELECT C.VAL_TEXT_COMU
                 FROM MAE_CLIEN_COMUN C, MAE_TIPO_COMUN TC
                 WHERE C.CLIE_OID_CLIE = MC.OID_CLIE
                   AND C.TICM_OID_TIPO_COMU = TC.OID_TIPO_COMU
                   AND TC.COD_TIPO_COMU = 'TM'                                   -- Telefono Movil
                   AND ROWNUM = 1) telefonoMovil,
               DECODE(NVL(CO.VAL_DIA_COMU,''),'L','1','M','1','I','1','J','1','V','1','S','1','D','1','0') indicadorContactada,
               --DECODE(NVL(EC.COD_ESTA_CLIE,''),'01','1','0') estatus,      -- Estatus Registrada
               (
                  SELECT COUNT(1)
                    FROM mae_clien_datos_adici mcda,
                         mae_clien_vincu mcv
                   WHERE 1=1
                     AND mcda.clie_oid_clie     = mcv.clie_oid_clie_vnte
                     AND mc.oid_clie            = mcv.clie_oid_clie_vndo
                     AND mcda.ind_acti          = 1
                     AND ((mcda.esta_oid_esta_clie IN (2,3,4,6,8)) OR (mcda.esta_oid_esta_clie = 5 AND mcda.NUM_CAMP_SIN_PEDI <= 2))
                     AND mcv.tivc_oid_tipo_vinc = 1
                     AND mcv.fec_hast IS NULL
                     AND ca.fec_naci IS NOT NULL
                     AND FLOOR(months_between(sysdate,to_date(ca.fec_naci,'dd/mm/rrrr'))/12)
                         BETWEEN vnDuplaEdadMin AND vnDuplaEdadMax
                ) estatus,
               SUBSTR((SELECT MIN(TO_CHAR(P.FEC_INIC,'YYYYMMDD') || PC.COD_PERI)
                          FROM CRA_PERIO P, SEG_PERIO_CORPO PC
                          WHERE P.PAIS_OID_PAIS = vnIdPais
                            AND P.MARC_OID_MARC = vnIdMarca
                            AND P.CANA_OID_CANA = vnIdCanal
                            AND P.PERI_OID_PERI = PC.OID_PERI
                            AND P.FEC_INIC <= MC.FEC_INGR
                            AND P.FEC_FINA >= MC.FEC_INGR),9) campaniaIngreso,
               TO_CHAR(MC.FEC_INGR,'YYYYMMDD') fechaIngreso,
               TO_CHAR(SYSDATE,'YYYYMMDD') fechaUltimaActualizacion,
               DECODE(NVL(PC.COD_TIPO_CONT,''),'W','W','C') codigoCanalIngreso,
               NVL((SELECT DECODE(C.IND_CONF_COMU,'1','1','0')
                     FROM MAE_CLIEN_COMUN C, MAE_TIPO_COMUN TC
                     WHERE C.CLIE_OID_CLIE = MC.OID_CLIE
                       AND C.TICM_OID_TIPO_COMU = TC.OID_TIPO_COMU
                       AND TC.COD_TIPO_COMU = 'ML' -- Email
                       AND ROWNUM = 1),'0') indicadorConfirmacion
         FROM  MAE_CLIEN MC,
               MAE_CLIEN_TIPO_SUBTI CT,
               MAE_TIPO_CLIEN TC,
               MAE_SUBTI_CLIEN SC,
               MAE_CLIEN_COMUN CO,
               MAE_CLIEN_DATOS_ADICI CA,
               MAE_CLIEN_VINCU CV,
               MAE_TIPO_VINCU TV,
               MAE_ESTAT_CLIEN EC,
               MAE_CLIEN_PRIME_CONTA PC,
               (SELECT OID_CLIE, COD_CLIE FROM MAE_CLIEN) MAD_DUP
         WHERE MC.PAIS_OID_PAIS = vnIdPais
           AND MC.OID_CLIE = CT.CLIE_OID_CLIE
           AND CT.TICL_OID_TIPO_CLIE = TC.OID_TIPO_CLIE
           AND TC.COD_TIPO_CLIE = '10'                                   -- Hija Dupla
           AND CT.SBTI_OID_SUBT_CLIE = SC.OID_SUBT_CLIE
           AND SC.COD_SUBT_CLIE = '01'                                 -- Subtipo Hija Dupla
           AND MC.OID_CLIE = CA.CLIE_OID_CLIE(+)
           AND MC.OID_CLIE = CO.CLIE_OID_CLIE(+)
           AND CO.IND_COMU_PPAL(+) = 1
           AND MC.OID_CLIE = CV.CLIE_OID_CLIE_VNDO
           AND CA.ESTA_OID_ESTA_CLIE = EC.OID_ESTA_CLIE(+)
           AND MAD_DUP.OID_CLIE = CV.CLIE_OID_CLIE_VNTE
           AND CV.TIVC_OID_TIPO_VINC = TV.OID_TIPO_VINC
           AND TV.COD_TIPO_VINC = '01'                                    -- DuplaCyzone
           AND MC.OID_CLIE = PC.CLIE_OID_CLIE(+)
           --AND CV.FEC_HAST IS NULL
           AND (MC.FEC_ULTI_ACTU  > fechaActualizacionInterfaz OR
                CO.FEC_ULTI_ACTU  > fechaActualizacionInterfaz OR
                CA.FEC_ULTI_ACTU  > fechaActualizacionInterfaz OR
                PC.FEC_ULTI_ACTU  > fechaActualizacionInterfaz OR
                CT.FEC_ULTI_ACTU  > fechaActualizacionInterfaz OR
                CV.FEC_ULTI_ACTU  > fechaActualizacionInterfaz
               );


   TYPE interfazTipo IS RECORD
   (
        codigoCliente                       MAE_CLIEN.COD_CLIE%TYPE,
        codigoMadreDupla                    MAE_CLIEN.COD_CLIE%TYPE,
        apellidoPaterno                     MAE_CLIEN.VAL_APE1%TYPE,
        apellidoMaterno                     MAE_CLIEN.VAL_APE2%TYPE,
        nombre1                             MAE_CLIEN.VAL_NOM1%TYPE,
        nombre2                             MAE_CLIEN.VAL_NOM2%TYPE,
        fechaNacimiento                     VARCHAR2(8),
        email                                MAE_CLIEN_COMUN.VAL_TEXT_COMU%TYPE,
        telefonoFijo                        MAE_CLIEN_COMUN.VAL_TEXT_COMU%TYPE,
        telefonoMovil                        MAE_CLIEN_COMUN.VAL_TEXT_COMU%TYPE,
        indicadorContactada                 VARCHAR2(1),
        status                                 VARCHAR2(1),
        campaniaIngreso                        VARCHAR2(6),
        fechaIngreso                        VARCHAR2(8),
        fechaUltimaActualizacion            VARCHAR2(8),
        codigoCanalIngreso                    VARCHAR2(1),
        indicadorConfirmacion                VARCHAR2(1)
   );

   TYPE interfazTab IS TABLE OF interfazTipo;

   interfazRecord interfazTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo                                 BAS_INTER.DIR_TEMP%TYPE;
   v_handle                             UTL_FILE.FILE_TYPE;
   lsLinea                               VARCHAR2(1000);

   lbAbrirUtlFile                       BOOLEAN;
   lsNombreArchivo                       VARCHAR2(50);

   lnIdPais                              NUMBER;
   lnIdMarca                          NUMBER;
   lnIdCanal                           NUMBER;
   pdFechaUltimaActualizacion           DATE;

   lnDuplaEdadMin     NUMBER;
   lnDuplaEdadMax     NUMBER;


BEGIN

     lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
   lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
   lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);

   SELECT MAX(FEC_IPRO) INTO pdFechaUltimaActualizacion
    FROM BAS_HISTO_LOTES
    WHERE PAIS_COD_PAIS = psCodigoPais
      AND SIST_COD_SIST = psCodigosistema
      AND INTE_COD_INTE = psCodigoInterfaz
      AND IND_LOER = 'N'
      AND FEC_FPRO IS NOT NULL;

 --obtener edad minima para dupla cyzone
    BEGIN
      SELECT nvl(mce.val_edad_mini,0)
        INTO lnDuplaEdadMin
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMin := 0;
    END;
 --obtener edad maxima para dupla cyzone
     BEGIN
      SELECT nvl(mce.val_edad_maxi,200)
        INTO lnDuplaEdadMax
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMax := 200;
    END;


    /* Generando Archivo de Texto (Detalle) */
    lbAbrirUtlFile := TRUE;
    OPEN c_interfaz(lnIdPais, lnIdMarca, lnIdCanal, pdFechaUltimaActualizacion,lnDuplaEdadMin,lnDuplaEdadMax);
     LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
       /* Procedimiento inicial para generar interfaz */
       IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
             psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
       END IF;

       IF interfazRecord.COUNT > 0 THEN
        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea := interfazRecord(x).codigoCliente                ||';'||
                             interfazRecord(x).codigoMadreDupla              ||';'||
                             interfazRecord(x).apellidoPaterno ||' '||interfazRecord(x).apellidoMaterno ||' '|| interfazRecord(x).nombre1 ||' '||   interfazRecord(x).nombre2  ||';'||
                             interfazRecord(x).apellidoPaterno               ||';'||
                             interfazRecord(x).apellidoMaterno               ||';'||
                             interfazRecord(x).nombre1 ||' '||interfazRecord(x).nombre2 ||';'||
                                  interfazRecord(x).fechaNacimiento               ||';'||
                             interfazRecord(x).email                          ||';'||
                             interfazRecord(x).telefonoFijo                   ||';'||
                             interfazRecord(x).telefonoMovil                 ||';'||
                             interfazRecord(x).indicadorContactada           ||';'||
                             interfazRecord(x).status                         ||';'||
                             interfazRecord(x).campaniaIngreso                 ||';'||
                             interfazRecord(x).fechaIngreso                     ||';'||
                             interfazRecord(x).fechaUltimaActualizacion      ||';'||
                             interfazRecord(x).codigoCanalIngreso            ||';'||
                             interfazRecord(x).indicadorConfirmacion          ;


                    UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
       END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
     END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
 WHEN OTHERS THEN
  ln_sqlcode := SQLCODE;
  ls_sqlerrm := substr(sqlerrm,1,1000);
 RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_HIJAS_DUPLA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_HIJAS_DUPLA;


/*************************************************************************************************
Descripcion       : Genera Interface de Envio de Fecha Cierre Campanha para Incentivos  (DAT-105)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoPeriodo : Codigo Periodo
 psCodigoMarca  : Codigo Marca
 psCodigoCanal  : Codigo Canal
Autor: Sergio Buchelli
**************************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECCI_INCEN (
   psCodigoPais     VARCHAR2,
   psCodigoSistema  VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo  VARCHAR2,
   psCodigoPeriodo  VARCHAR2,
   psCodigoMarca    VARCHAR2,
   psCodigoCanal    VARCHAR2
)
IS
  CURSOR c_interfaz(vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, vnIdPeriodo NUMBER, vnIdTipoCierre NUMBER) IS

    SELECT spc.cod_peri codigoPeriodo,
               MAX(TO_CHAR(fec_cier,'yyyymmdd')) fechaCierre
        FROM fac_contr_cierr fcc,
             fac_tipos_cierr ftc,
              cra_perio cp,
              seg_perio_corpo spc,
              seg_pais sgp,
              seg_canal scl,
              seg_marca sma
      WHERE sgp.oid_pais = vnIdPais
        AND    spc.oid_peri = vnIdPeriodo
          AND    sma.oid_marc = vnIdMarca
          AND    scl.oid_cana = vnIdCanal
          AND    ftc.oid_tipo_cier = vnIdTipoCierre
        AND    fcc.tcie_oid_tipo_cier = ftc.oid_tipo_cier
          AND    fcc.perd_oid_peri = cp.oid_peri
          AND    cp.peri_oid_peri = spc.oid_peri
          AND    cp.pais_oid_pais = sgp.oid_pais
          AND    cp.marc_oid_marc = sma.oid_marc
          AND    cp.cana_oid_cana = scl.oid_cana
        GROUP BY spc.cod_peri ;

   TYPE interfazRec IS RECORD (
     codigoPeriodo      SEG_PERIO_CORPO.COD_PERI%TYPE,
     fechaCierre        VARCHAR2(8)
   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais            NUMBER;
   lnIdPeriodo         NUMBER;
   lnIdMarca           NUMBER;
   lnIdCanal           NUMBER;
   lnIdTipoCierre      NUMBER;


BEGIN
   /* obteniendo id's */
   lnIdPais    := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
   lnIdMarca   := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
   lnIdCanal   := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
   lnIdPeriodo := gen_pkg_gener.gen_fn_devuelve_id_perio(psCodigoPeriodo);-- id del Periodo consultante

   -- Id del Tipo de Cierre Periodo
   SELECT f.oid_tipo_cier
     INTO lnIdTipoCierre
     FROM fac_tipos_cierr f
    WHERE f.cod_tipo_cier = 'P';

   /* Generando Archivo de Texto */
   lbAbrirUtlFile := TRUE;
   OPEN c_interfaz(lnIdPais, lnIdMarca, lnIdCanal, lnIdPeriodo, lnIdTipoCierre);
     LOOP
       FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
         /* Procedimiento inicial para generar interfaz */
         IF lbAbrirUtlFile THEN
           GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                  psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
           lbAbrirUtlFile := FALSE;
         END IF;

         IF interfazRecord.COUNT > 0 THEN
           FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea :=  interfazRecord(x).codigoPeriodo ||';'||
                         interfazRecord(x).fechaCierre;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
           END LOOP;
         END IF;
         EXIT WHEN c_interfaz%NOTFOUND;

     END LOOP;
   CLOSE c_interfaz;

   IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);

     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
   END IF;

   RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_FECCI_INCEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_FECCI_INCEN;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Regiones (DAT-13)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoMarca  : Codigo Marca
 psCodigoIso  : Codigo Canal
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_REGIO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2,
   psCodigoMarca           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

       SELECT sgv.COD_SUBG_VENT codigoSubgerencia,
              sgv.DES_SUBG_VENT nombreSubgerencia,
              reg.COD_REGI codigoRegion,
              reg.DES_REGI nombreRegion,
              pais.COD_PAIS codigoPais,
              substr(GEN_PKG_GENER.GEN_FN_DEVUELVE_DESCRIPCION(sgv.PAIS_OID_PAIS, 'SEG_PAIS', psCodigoIso), 1, 20) nombrePais,
              clie.COD_CLIE codigoGerenteRegional,
              clie.VAL_NOM1 nombre1,
              clie.VAL_NOM2 nombre2,
              clie.VAL_APE1 apellido1,
              clie.VAL_APE2 apellido2,
              '' campanaCreacionRegion
       FROM ZON_REGIO reg, ZON_SUB_GEREN_VENTA sgv, MAE_CLIEN clie, SEG_PAIS pais
       WHERE sgv.PAIS_OID_PAIS = pais.OID_PAIS
       AND      reg.CLIE_OID_CLIE = clie.OID_CLIE(+)
       AND      reg.Zsgv_OID_SUBG_VENT = sgv.OID_SUBG_VENT
       AND      reg.IND_ACTI = 1
       AND      sgv.IND_ACTI = 1
       AND      reg.IND_BORR = 0
       AND      sgv.IND_BORR =0
       AND      sgv.PAIS_OID_PAIS = vnIdPais
       AND      sgv.MARC_OID_MARC = vnIdMarca
       AND      sgv.CANA_OID_CANA = vnIdCanal;

   TYPE interfazRec IS RECORD
       (
       codigoSubgerencia        ZON_SUB_GEREN_VENTA.COD_SUBG_VENT%TYPE,
       nombreSubgerencia           ZON_SUB_GEREN_VENTA.DES_SUBG_VENT%TYPE,
       codigoRegion                ZON_REGIO.COD_REGI%TYPE,
       nombreRegion                ZON_REGIO.DES_REGI%TYPE,
       codigoPais                SEG_PAIS.COD_PAIS%TYPE,
       nombrePais                VARCHAR2(20),
       codigoGerenteRegional    MAE_CLIEN.COD_CLIE%TYPE,
       nombre1                    MAE_CLIEN.VAL_NOM1%TYPE,
       nombre2                    MAE_CLIEN.VAL_NOM2%TYPE,
       apellido1                MAE_CLIEN.VAL_APE1%TYPE,
       apellido2                MAE_CLIEN.VAL_APE2%TYPE,
       campanaCreacionRegion    VARCHAR2(6)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais              NUMBER;
   lnIdCanal             NUMBER;
   lnIdMarca             NUMBER;

BEGIN

    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
    lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).codigoSubgerencia            ||';'||
                                          interfazRecord(x).nombreSubgerencia            ||';'||
                                      interfazRecord(x).codigoRegion                 ||';'||
                                      interfazRecord(x).nombreRegion                 ||';'||
                                      interfazRecord(x).codigoPais                    ||';'||
                                      interfazRecord(x).nombrePais                   ||';'||
                                      interfazRecord(x).codigoGerenteRegional         ||';'||
                                      interfazRecord(x).nombre1 ||' '||interfazRecord(x).nombre2 ||' '|| interfazRecord(x).apellido1 ||' '||   interfazRecord(x).apellido2  ||';'||
                                      interfazRecord(x).campanaCreacionRegion;

                          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_REGIO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_REGIO;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Empresas (DAT-3)
Fecha Creacion    : 11/01/2011
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SOCIE
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER) IS

       SELECT soci.COD_SOCI codigoSociedad,
                 soci.VAL_DENO descripcionSociedad
         FROM SEG_SOCIE soci
         WHERE soci.PAIS_OID_PAIS = vnIdPais;

   TYPE interfazRec IS RECORD
       (
       codigoSociedad        SEG_SOCIE.COD_SOCI%TYPE,
       descripcionSociedad   SEG_SOCIE.VAL_DENO%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;

   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais            NUMBER;

BEGIN

    lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais);
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
               /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).codigoSociedad            ||';'||
                                      interfazRecord(x).descripcionSociedad;

                          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_EMPRE: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_SOCIE;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio de Accesos (DAT-35)
Fecha Creacion    : 10/12/2010
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
 psCodigoCanal  : Codigo Canal
 psCodigoIso  : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ACCES
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2)
IS
   CURSOR c_interfaz (vnIdCanal NUMBER) IS

       SELECT acc.COD_ACCE codigoAcceso,
              substr(GEN_PKG_GENER.GEN_FN_DEVUELVE_DESCRIPCION(acc.OID_ACCE, 'ACCESO', psCodigoIso), 1, 20) descripcionAcceso
           FROM SEG_CANAL ca, SEG_ACCES acc
           WHERE acc.CANA_OID_CANA = ca.OID_CANA
           AND   acc.CANA_OID_CANA = vnIdCanal;

   TYPE interfazRec IS RECORD
       (
       codigoAcceso                  SEG_ACCES.COD_ACCE%TYPE,
       descripcionAcceso       VARCHAR2(20)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdCanal             NUMBER;
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdCanal);
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                                   /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).codigoAcceso            ||';'||
                                      interfazRecord(x).descripcionAcceso;

                          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ACCES: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ACCES;


/***************************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Logro (DAT-106)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2)
IS
   CURSOR c_interfaz IS

    SELECT LPAD(nvtl.cod_tipo_logr,2,'0') AS codTipoLogro,
           nvtl.des_tipo_logr AS desTipoLogro,
         NVL(nvtl.imp_maxi_logr,0) AS montoMaxLogroMN
      FROM nvs_tipo_logro nvtl;

   TYPE interfazRec IS RECORD
     (
       codTipoLogro                NVS_TIPO_LOGRO.cod_tipo_logr%TYPE,
       desTipoLogro                NVS_TIPO_LOGRO.des_tipo_logr%TYPE,
       montoMaxLogroMN        NVS_TIPO_LOGRO.imp_maxi_logr%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lbAbrirUtlFile      BOOLEAN;

BEGIN
    lbAbrirUtlFile:=TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz ();
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                       /* Procedimiento inicial para generar interfaz */
                    IF lbAbrirUtlFile THEN
                       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                              psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                       lbAbrirUtlFile := FALSE;
                     END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).codTipoLogro        ||';'||
                                                    interfazRecord(x).desTipoLogro        ||';'||
                                  TO_CHAR(interfazRecord(x).montoMaxLogroMN,'999999999990.99');

                                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);

       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_LOGRO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TIPO_LOGRO;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Registro Logro (DAT-107)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/

PROCEDURE INT_PR_DAT_ENVIO_REGIS_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo        VARCHAR2)
IS
   CURSOR c_interfaz  IS

    SELECT nvcg.cmp_inic AS anioCampanaIniLogro,
           nvcg.cod_clie AS codEbelista,
           LPAD(nvcg.cod_tipo_logr,2,'0') AS codTipoLogro,
           NVCG.CMP_FINA AS ANIOCAMPANAFINLOGRO,
           NVL(NVCG.IMP_LOGR,0) AS MONTOLOGROMN,
           REPLACE(nvcg.des_larg,';',' ') AS descripcion,
           nvcg.ori_regi AS codCanalOrigen
      FROM nvs_consu_logro nvcg
     WHERE nvcg.est_regi != '9'
       AND nvcg.est_logr = '1' -- Nuevo
       AND nvcg.cmp_inic <= psCodigoPeriodo
       AND nvcg.cmp_fina >= psCodigoPeriodo
         ;

   TYPE interfazRec IS RECORD
       (
        anioCampanaIniLogro    NVS_CONSU_LOGRO.cmp_inic%TYPE,
        codEbelista            NVS_CONSU_LOGRO.cod_clie%TYPE,
        codTipoLogro        NVS_CONSU_LOGRO.cod_tipo_logr%TYPE,
        anioCampanaFinLogro    NVS_CONSU_LOGRO.cmp_fina%TYPE,
        montoLogroMN        NVS_CONSU_LOGRO.imp_logr%TYPE,
        descripcion            NVS_CONSU_LOGRO.des_larg%TYPE,
        codCanalOrigen        NVS_CONSU_LOGRO.ori_regi%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lbAbrirUtlFile BOOLEAN;

BEGIN


    lbAbrirUtlFile:=TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz ();
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

                       /* Procedimiento inicial para generar interfaz */
                    IF lbAbrirUtlFile THEN
                       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                              psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                       lbAbrirUtlFile := FALSE;
                     END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).anioCampanaIniLogro    ||';'||
                                  interfazRecord(x).codEbelista            ||';'||
                                  interfazRecord(x).codTipoLogro        ||';'||
                                  interfazRecord(x).anioCampanaFinLogro    ||';'||
                                  TO_CHAR(interfazRecord(x).montoLogroMN,'999999999990.99') ||';'||
                                  interfazRecord(x).descripcion            ||';'||
                                      interfazRecord(x).codCanalOrigen;

                                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;


    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_REGIS_LOGRO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_REGIS_LOGRO;



/***************************************************************************
Descripcion       : Genera Interfaz de Envio Ganancia Logro (DAT-108)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/

PROCEDURE INT_PR_DAT_ENVIO_GANAN_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema           VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo           VARCHAR2,
   psCodigoCanal           VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo        VARCHAR2)
IS
   CURSOR c_interfaz (lnOidPeriodo NUMBER) IS

    SELECT psCodigoPeriodo AS anioCampana,
           nvcg.cod_clie AS codEbelista,
           nvcg.cmp_inic AS anioCampanaIniLogro,
           NVL(camp.Ganancia,0) AS montoLogroCampanaMN,
           NVL(acum.Ganancia,0) AS montoLogroAcumuladoMN
      FROM nvs_consu_logro nvcg,
           (
            SELECT clie.cod_clie, SUM( NVL(soca.Val_Gana_Tota_Loca,0) ) AS ganancia
              FROM nvs_consu_logro nvcg,
                   mae_clien clie,
                   ped_solic_cabec soca,
                   ped_solic_cabec soca2
             WHERE nvcg.cod_clie = clie.cod_clie
               AND clie.oid_clie = soca.clie_oid_clie
               AND soca.soca_oid_soli_cabe = soca2.oid_soli_cabe
               --
               AND nvcg.cmp_inic <= psCodigoPeriodo
               AND nvcg.cmp_fina >= psCodigoPeriodo
               --
               AND soca.ind_oc = 1
               AND soca.esso_oid_esta_soli <> 4
               AND soca.modu_oid_modu NOT IN (13,15)
               AND soca.perd_oid_peri = lnOidPeriodo
               AND nvcg.est_regi != '9'
               AND nvcg.est_logr = '1' -- Nuevo
             GROUP BY clie.cod_clie
           ) camp,
           (
            SELECT clie.cod_clie, SUM( NVL(soca.Val_Gana_Tota_Loca,0) ) AS Ganancia
              FROM nvs_consu_logro nvcg,
                   mae_clien clie,
                   ped_solic_cabec soca,
                   ped_solic_cabec soca2
             WHERE nvcg.cod_clie = clie.cod_clie
               AND clie.oid_clie = soca.clie_oid_clie
               AND soca.soca_oid_soli_cabe = soca2.oid_soli_cabe
               --
               AND nvcg.cmp_inic <= psCodigoPeriodo
               AND nvcg.cmp_fina >= psCodigoPeriodo
               --
               AND soca.ind_oc = 1
               AND soca.esso_oid_esta_soli <> 4
               AND soca.modu_oid_modu NOT IN (13,15)
               AND soca.perd_oid_peri >= FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO(nvcg.cmp_inic)
               AND soca.perd_oid_peri <= lnOidPeriodo
               AND nvcg.est_regi != '9'
               AND nvcg.est_logr = '1' -- Nuevo
             GROUP BY clie.cod_clie
            ) acum
     WHERE nvcg.cod_clie = camp.cod_clie(+)
       AND nvcg.cod_clie = acum.cod_clie(+)
       AND nvcg.cmp_inic <= psCodigoPeriodo
       AND nvcg.cmp_fina >= psCodigoPeriodo
       AND nvcg.est_regi <> '9'
       AND nvcg.est_logr = '1' -- Nuevo
       ;

   TYPE interfazRec IS RECORD
       (
           anioCampana                NVS_CONSU_LOGRO.CMP_INIC%TYPE,
           codEbelista                NVS_CONSU_LOGRO.COD_CLIE%TYPE,
           anioCampanaIniLogro        NVS_CONSU_LOGRO.CMP_INIC%TYPE,
           montoLogroCampanaMN        NVS_CONSU_LOGRO.IMP_LOGR%TYPE,
           montoLogroAcumuladoMN    NVS_CONSU_LOGRO.IMP_LOGR%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnOidPeriodo        NUMBER;
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lnOidPeriodo:= GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2(psCodigoPeriodo);

    lbAbrirUtlFile:=TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz(lnOidPeriodo) ;
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

                       /* Procedimiento inicial para generar interfaz */
                    IF lbAbrirUtlFile THEN
                       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                              psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                       lbAbrirUtlFile := FALSE;
                     END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).anioCampana                ||';'||
                                  interfazRecord(x).codEbelista                ||';'||
                                  interfazRecord(x).anioCampanaIniLogro        ||';'||
                                  TO_CHAR(interfazRecord(x).montoLogroCampanaMN,'999999999990.99') ||';'||
                                  --interfazRecord(x).montoLogroCampanaMN        ||';'||
                                  TO_CHAR(interfazRecord(x).montoLogroAcumuladoMN,'999999999990.99');
                                      --interfazRecord(x).montoLogroAcumuladoMN;

                                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;


    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_GANAN_LOGRO: '||LS_SQLERRM);
END INT_PR_DAT_ENVIO_GANAN_LOGRO;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Asistencia Comparatamos(DAT-109)
Fecha Creacion    : 22/02/2010
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoCanal    : Codigo Canal
 psCodigoIso      : Codigo Iso
 psCodigoPeriodo  : Codigo Periodo
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ASIST_LOGRO
  (psCodigoPais           VARCHAR2,
   psCodigoSistema        VARCHAR2,
   psCodigoInterfaz       VARCHAR2,
   psNombreArchivo        VARCHAR2,
   psCodigoCanal          VARCHAR2,
   psCodigoIso            VARCHAR2,
   psCodigoPeriodo        VARCHAR2)
IS
   CURSOR c_interfaz (lnOidPeriodo NUMBER) IS

      SELECT BAS.COD_CANA AS CODCANALVENTA,
             BAS.COD_PERI AS ANIOCAMPANA,
             UADM.COD_TERR AS CODTERRITORIO,
             CLIE.COD_CLIE AS CODEBELISTA,
             GEN_FN_CALCU_PERIO( psCodigoPeriodo,1 ) AS ANIOCAMPANAASISTE,
             NVL(ASIS.FLAGASISTE,0) AS FLAGASISTEREUNION,
             NVCG1.ORI_REGI AS CODCANALORIGEN,
             CASE
              -- si la Periodo de 1er ped de la consultora es igual a la Periodo de proceso y tiene pedido en esta Periodo.
              WHEN CPRC.PERD_OID_PERI = CIER.PERD_OID_PERI OR
                   (CLDA.ESTA_OID_ESTA_CLIE IN (1,2,7,8) AND CAMP.CLIE_OID_CLIE IS NOT NULL )THEN
                         '01' -- visita de meta
              WHEN CPRC.PERD_OID_PERI = FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO( GEN_FN_CALCU_PERIO( CIER.COD_PERI, -1 ) ) THEN
                     '02'  -- contacto 2
              WHEN CPRC.PERD_OID_PERI = FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO( GEN_FN_CALCU_PERIO( CIER.COD_PERI, -2 ) ) AND
                   CLDA.NUM_CAMP_SIN_PEDI = 0 THEN
                     '03'  -- contacto 3
              WHEN CPRC.PERD_OID_PERI = FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO( GEN_FN_CALCU_PERIO( CIER.COD_PERI, -3 ) ) AND
                   CLDA.NUM_CAMP_SIN_PEDI = 0 THEN
                         '04'  -- visita felicitaciones
              WHEN (CPRC.PERD_OID_PERI = FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO( GEN_FN_CALCU_PERIO( CIER.COD_PERI, -3 ) ) AND
                    CLDA.NUM_CAMP_SIN_PEDI >= 2 OR CIER.COD_PERI < NVCG1.CMP_INIC ) THEN
                         NULL -- no le corresponde visita
                    ELSE '05'   -- visita establecida
                 END AS CODTIPOVISITA,
                 NULL AS FLAGTIPOVISITA,
                 CASE
               WHEN PR.EST_POLI IS NULL OR PR.EST_POLI ='4' THEN '0'
                   ELSE '1'
             END AS FLAGINSCRIPCIONSEGURO,
             CASE
               WHEN PR.EST_POLI IS NULL THEN NULL
               WHEN PR.EST_POLI = '3' THEN '1'
               WHEN PR.EST_POLI = '1' THEN '2'
               WHEN PR.EST_POLI = '4' THEN '3'
             END AS ESTADOPOLIZA
        FROM (
              SELECT clie.oid_clie
                FROM mae_clien clie,
                     mae_clien_datos_adici clda
               WHERE clie.oid_clie = clda.clie_oid_clie
                 AND clda.ind_acti = 1
                 AND clda.esta_oid_esta_clie <> 1
              UNION
              SELECT P.CLIE_OID_CLIE
                FROM SGR_FAMSE_POLIZ_REGIS P
               WHERE P.EST_REGI <> '9'
                 AND P.CAM_REGI <= psCodigoPeriodo
               GROUP BY P.CLIE_OID_CLIE
             ) DATO,
             MAE_CLIEN CLIE,
             (
              SELECT FIN_PKG_GENER.FIN_FN_OBTIE_OID_PERIO( CMP_INIC_PROG ) AS PERD_OID_PERI
                 FROM NVS_PARAM_LOGRO
             ) NVPA,
             (
              SELECT NVCG.COD_CLIE,
                     NVCG.CMP_INIC,
                     NVCG.ORI_REGI
                FROM NVS_CONSU_LOGRO NVCG,
                     NVS_PARAM_LOGRO NPAR
               WHERE NVCG.EST_REGI != '9'
                 AND NVCG.EST_LOGR = '1' -- Nuevo
                 AND NVCG.COD_PAIS = NPAR.COD_PAIS
                 AND NVCG.CMP_INIC >= NPAR.CMP_INIC_PROG
                 AND NVCG.CMP_INIC = (
                                       SELECT MAX(NVCG2.CMP_INIC) AS CMP_INIC
                                         FROM NVS_CONSU_LOGRO NVCG2
                                        WHERE NVCG2.Est_Regi != '9'
                                          AND NVCG2.EST_LOGR = '1' -- Nuevo
                                          AND NVCG2.COD_CLIE = NVCG.COD_CLIE
                                      )
             ) NVCG1,
             MAE_CLIEN_DATOS_ADICI CLDA,
             MAE_CLIEN_PRIME_CONTA CPRC,
             (
              SELECT COD_CLIE, MAX( CASE WHEN UPPER( COD_ACCE ) IN ( 'S','A' ) THEN 1 ELSE 0 END ) AS FLAGASISTE
                FROM INT_SOLIC_PEDID_DETAL
               WHERE COD_PERI = psCodigoPeriodo
               GROUP BY COD_CLIE
             ) ASIS,
             (
              SELECT SOCA.CLIE_OID_CLIE, SOCA.PERD_OID_PERI,
                     SUM(NVL(SOCA.VAL_TOTA_PAGA_LOCA,0)) AS VAL_TOTA_PAGA_LOCA,
                     SUM(NVL(SOCA.VAL_GANA_TOTA_LOCA,0)) AS VAL_GANA_TOTA_LOCA
                FROM PED_SOLIC_CABEC SOCA,
                     PED_SOLIC_CABEC SOCA2,
                     (
                      SELECT clie_oid_clie, MAX( perd_oid_peri ) AS perd_oid_peri_max
                        FROM ped_solic_cabec_acum2 sca2
                       GROUP BY clie_oid_clie
                     ) sca2
               WHERE SOCA.SOCA_OID_SOLI_CABE = SOCA2.OID_SOLI_CABE
                 AND SOCA.Perd_Oid_Peri = SOCA2.Perd_Oid_Peri -- Nuevo
                 AND SOCA.CLIE_OID_CLIE = sca2.clie_oid_clie
                 AND SOCA.Perd_Oid_Peri = sca2.perd_oid_peri_max
                 AND SOCA.IND_OC = 1
                 AND SOCA.ESSO_OID_ESTA_SOLI <> 4
                 AND SOCA.MODU_OID_MODU NOT IN (13,15)
               GROUP BY SOCA.CLIE_OID_CLIE, SOCA.PERD_OID_PERI
             ) CAMP,
             (
              SELECT CUAD.CLIE_OID_CLIE, ZORG.OID_REGI, ZZON.OID_ZONA,
                     CLIE.COD_CLIE, ZORG.COD_REGI, ZZON.COD_ZONA, CUAD.IND_ACTI,
                     TERR.COD_TERR
                FROM MAE_CLIEN_UNIDA_ADMIN CUAD,
                     ZON_TERRI_ADMIN ZTAD,
                     ZON_SECCI ZSCC,
                     ZON_TERRI TERR,
                     ZON_ZONA ZZON,
                     ZON_REGIO ZORG,
                     MAE_CLIEN CLIE
               WHERE CUAD.ZTAD_OID_TERR_ADMI = ZTAD.OID_TERR_ADMI
                 AND CUAD.CLIE_OID_CLIE = CLIE.OID_CLIE
                 AND ZTAD.ZSCC_OID_SECC = ZSCC.OID_SECC
                 AND ZTAD.TERR_OID_TERR = TERR.OID_TERR
                 AND ZSCC.ZZON_OID_ZONA = ZZON.OID_ZONA
                 AND ZZON.ZORG_OID_REGI = ZORG.OID_REGI
                 AND CUAD.IND_ACTI = 1
             ) UADM,
             (
              SELECT COD_PAIS, COD_PERI, COD_CANA
                FROM BAS_CTRL_FACT WHERE COD_PERI = psCodigoPeriodo
             ) BAS,
             (
              SELECT ZORG_OID_REGI,
                     MAX( PERD_OID_PERI ) PERD_OID_PERI,
                     FIN_PKG_GENER.FIN_FN_OBTIE_CODIG_PERIO( MAX( PERD_OID_PERI ) ) AS COD_PERI
                FROM FAC_CONTR_CIERR
               WHERE TCIE_OID_TIPO_CIER = 1
                 AND PERD_OID_PERI <= lnOidPeriodo
               GROUP BY ZORG_OID_REGI
             ) CIER,
             (
              SELECT P.CLIE_OID_CLIE, min(P.EST_POLI) EST_POLI
                FROM SGR_FAMSE_POLIZ_REGIS P
               WHERE P.FEC_SOLI = (
                                   SELECT MAX(P1.FEC_SOLI)
                                     FROM SGR_FAMSE_POLIZ_REGIS P1
                                    WHERE P1.CLIE_OID_CLIE = P.CLIE_OID_CLIE
                                      AND P1.EST_REGI <> '9'
                                      AND P1.CAM_REGI <= psCodigoPeriodo
                                  )
                 AND P.EST_REGI <> '9'
            GROUP BY  P.CLIE_OID_CLIE
               --  AND P.EST_POLI <> '4'
             ) PR
       WHERE DATO.OID_CLIE = CLIE.OID_CLIE
         AND CLIE.COD_CLIE = NVCG1.COD_CLIE(+)
         AND CLIE.OID_CLIE = CLDA.CLIE_OID_CLIE
         AND CLIE.OID_CLIE = CPRC.CLIE_OID_CLIE(+)
         AND CLIE.COD_CLIE = ASIS.COD_CLIE(+)
         AND CLIE.OID_CLIE = UADM.CLIE_OID_CLIE(+)
         AND UADM.OID_REGI = CIER.ZORG_OID_REGI(+)
         AND CLIE.OID_CLIE = CAMP.CLIE_OID_CLIE(+)
         AND CLIE.OID_CLIE = PR.CLIE_OID_CLIE(+)
         --AND CLDA.IND_ACTI = 1
         --AND CLDA.ESTA_OID_ESTA_CLIE <> 1
         /*AND (
              NVL(CPRC.PERD_OID_PERI,0) >= NVPA.PERD_OID_PERI AND
              (
                CLDA.ESTA_OID_ESTA_CLIE NOT IN (1,2,7,8) OR
                ( CLDA.ESTA_OID_ESTA_CLIE IN (1,2,7,8) AND NVL(CAMP.PERD_OID_PERI,0) <> 0 )
              )
             )*/
           ;

   TYPE interfazRec IS RECORD
       (
       codCanalVenta        VARCHAR2(2),
       anioCampana            NVS_CONSU_LOGRO.CMP_INIC%TYPE,
       codTerritorio        VARCHAR2(10),
       codEbelista            NVS_CONSU_LOGRO.COD_CLIE%TYPE,
       anioCampanaAsiste    NVS_CONSU_LOGRO.CMP_INIC%TYPE,
       flagAsisteReunion    VARCHAR2(1),
       codCanalOrigen        VARCHAR2(1),
       codTipoVisita        VARCHAR2(2),
       flagTipoVisita        VARCHAR2(1),
       flagInscripcionSeguro VARCHAR2(1),
       estadoPoliza          VARCHAR2(1)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnOidPeriodo        NUMBER;
   lbAbrirUtlFile BOOLEAN;

BEGIN

     lnOidPeriodo:= GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2(psCodigoPeriodo);
     lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnOidPeriodo);
            LOOP
               FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                       /* Procedimiento inicial para generar interfaz */
                   IF lbAbrirUtlFile THEN
                       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                              psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                       lbAbrirUtlFile := FALSE;
                   END IF;

                   IF interfazRecord.COUNT > 0 THEN
                      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                          lsLinea :=  interfazRecord(x).CodCanalVenta        ||';'||
                                  interfazRecord(x).AnioCampana            ||';'||
                                  interfazRecord(x).CodTerritorio        ||';'||
                                  interfazRecord(x).CodEbelista            ||';'||
                                  interfazRecord(x).AnioCampanaAsiste    ||';'||
                                  interfazRecord(x).FlagAsisteReunion    ||';'||
                                  interfazRecord(x).CodCanalOrigen        ||';'||
                                  interfazRecord(x).CodTipoVisita        ||';'||
				                          interfazRecord(x).FlagTipoVisita        ||';'||
	                                interfazRecord(x).flagInscripcionSeguro ||';'||
                                  interfazRecord(x).estadoPoliza;

                          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      END LOOP;
                   END IF;
               EXIT WHEN c_interfaz%NOTFOUND;
            END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ASIST_LOGRO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ASIST_LOGRO;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Maestro Programa Lideres
                      ( DAT-110 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
  Actualizado por   : Carlos Mori ( 12/09/11 )
                      - Se modifica filtro para considerar Periodos n+1 y n+2
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR_LIDER
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS

  CURSOR c_interfaz ( vsCampaniaMasUno VARCHAR2, vsCampaniaMasDos VARCHAR2) IS
    SELECT lpcl.cod_conc AS codprograma,
           substr( lpcl.des_conc,1,30 ) AS desprograma,
           lpcl.cam_inic AS aniocampanainicio,
           lpcl.cam_fina AS aniocampanafin,
           lpcl.nica_nive_camp AS numnivelescampana,
           lpcl.nico_nive_conc AS numnivelesprograma,
           floor(lprp.can_pedi / (lpcl.por_acti_meta / 100))  AS nroactivasexigidasseccion,
           lpcl.min_acti_fina_zona AS nroactivasexigidaszona,
           lpcl.rat_crit AS ratiocriticidad,
           lpcl.num_ingr_nuev AS numingrnueva
     FROM let_param_concu_lider lpcl,
          let_param_rango_premi lprp
     WHERE lpcl.pais_cod_pais = pscodigopais
       AND ( psCodigoPeriodo BETWEEN lpcl.cam_inic AND lpcl.cam_fina OR
             lpcl.cam_inic BETWEEN vsCampaniaMasUno AND vsCampaniaMasDos)
       AND  lpcl.cod_conc = lprp.conc_cod_conc
       AND  lprp.rang_num_rang = 1      ;

  TYPE interfazRec IS RECORD(
      codprograma                  LET_PARAM_CONCU_LIDER.COD_CONC%TYPE,
      desprograma                  LET_PARAM_CONCU_LIDER.DES_CONC%TYPE,
      aniocampanainicio            LET_PARAM_CONCU_LIDER.CAM_INIC%TYPE,
      aniocampanafin              LET_PARAM_CONCU_LIDER.CAM_FINA%TYPE,
      numnivelescampana            LET_PARAM_CONCU_LIDER.NICA_NIVE_CAMP%TYPE,
      numnivelesprograma          LET_PARAM_CONCU_LIDER.NICO_NIVE_CONC%TYPE,
      nroactivasexigidasseccion    LET_PARAM_CONCU_LIDER.MIN_ACTI_FINA_SECC%TYPE,
      nroactivasexigidaszona      LET_PARAM_CONCU_LIDER.MIN_ACTI_FINA_ZONA%TYPE,
      ratiocriticidad              LET_PARAM_CONCU_LIDER.RAT_CRIT%TYPE,
      numingrnueva                 LET_PARAM_CONCU_LIDER.NUM_INGR_NUEV%TYPE
    );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
  lsCampaniaMasUno    VARCHAR2(6);
  lsCampaniaMasDos    VARCHAR2(6);

BEGIN

    lbAbrirUtlFile := TRUE;
    lsCampaniaMasUno := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 1 );
    lsCampaniaMasDos := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 2 );

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ( lsCampaniaMasUno, lsCampaniaMasDos );
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).codprograma                  ||';'||
                                             interfazrecord(x).desprograma                ||';'||
                                             interfazrecord(x).aniocampanainicio          ||';'||
                                             interfazrecord(x).aniocampanafin                ||';'||
                                             interfazrecord(x).numnivelescampana            ||';'||
                                             interfazrecord(x).numnivelesprograma         ||';'||
                                             interfazrecord(x).nroactivasexigidasseccion    ||';'||
                                             interfazrecord(x).nroactivasexigidaszona        ||';'||
                                             interfazrecord(x).ratiocriticidad   ||';'||
                                             interfazrecord(x).numingrnueva ;
               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

    RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PROGR_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PROGR_LIDER;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Maestro de Clasificaciones Let
                      ( DAT-132 )
  Fecha Creacion    : 23/07/2012
  Autor             : CSVD FFVV

/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_LIDER
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS

  CURSOR c_interfaz  IS
    SELECT decode(tclas.cod_tipo_clas,'08','01','02') CodClas,
    substr(GTCLAS.VAL_I18N,5,15) DesClasi,
   case
     when clas.cod_clas < '07'  and tclas.cod_tipo_clas = '08'  then clas.cod_clas
     when clas.cod_clas = '01'  and tclas.cod_tipo_clas in ('08', '09') then '02'
     when clas.cod_clas = '02'  and tclas.cod_tipo_clas in ('08', '09') then '01'
   end  as  Subclas,
   substr(GCLAS.VAL_I18N,1,15)  DesSubcl
    FROM   MAE_TIPO_CLIEN TIPO, MAE_SUBTI_CLIEN SUBT, MAE_TIPO_CLASI_CLIEN TCLAS,
           MAE_CLASI CLAS, GEN_I18N_SICC_COMUN GTIPO,
	         GEN_I18N_SICC_COMUN GSUBT, GEN_I18N_SICC_COMUN GTCLAS,
           GEN_I18N_SICC_COMUN GCLAS
    WHERE  SUBT.TICL_OID_TIPO_CLIE = TIPO.OID_TIPO_CLIE AND TCLAS.SBTI_OID_SUBT_CLIE = SUBT.OID_SUBT_CLIE
    AND    CLAS.TCCL_OID_TIPO_CLAS = TCLAS.OID_TIPO_CLAS
    AND    GTIPO.ATTR_ENTI = 'MAE_TIPO_CLIEN' AND GTIPO.VAL_OID = TIPO.OID_TIPO_CLIE
    AND    GSUBT.ATTR_ENTI = 'MAE_SUBTI_CLIEN' AND GSUBT.VAL_OID = SUBT.OID_SUBT_CLIE
    AND    GTCLAS.ATTR_ENTI = 'MAE_TIPO_CLASI_CLIEN' AND GTCLAS.VAL_OID = TCLAS.OID_TIPO_CLAS
    AND    GCLAS.ATTR_ENTI = 'MAE_CLASI' AND GCLAS.VAL_OID = CLAS.OID_CLAS
    AND   tipo.cod_tipo_clie = '02' and subt.ticl_oid_tipo_clie = tipo.oid_tipo_clie and subt.cod_subt_clie = '04'
    and   subt.oid_subt_clie = tclas.sbti_oid_subt_clie and tclas.cod_tipo_clas in ( '08', '09')
    ORDER BY TIPO.COD_TIPO_CLIE, SUBT.COD_SUBT_CLIE, TCLAS.COD_TIPO_CLAS, CLAS.COD_CLAS;


  TYPE interfazRec IS RECORD(
      codClas                      MAE_TIPO_CLASI_CLIEN.COD_TIPO_CLAS%TYPE,
      DesClasi                     VARCHAR2(15),
      SubClas                      MAE_CLASI.COD_CLAS%TYPE,
      DesSubcl                     VARCHAR2(15)
          );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile := TRUE;


    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ;
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).codClas                  ||';'||
                           interfazrecord(x).DesClasi          ||';'||
                                             interfazrecord(x).SubClas                ||';'||
                                             interfazrecord(x).DesSubcl    ;
               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

    RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CLASI_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CLASI_LIDER;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Nivel por Periodo ( DAT-111 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_CAMPA
  (psCodigoPais          VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal      VARCHAR2,
   psCodigoIso          VARCHAR2,
   psCodigoPeriodo    VARCHAR2)
IS

  CURSOR c_interfaz ( vsCampaniaMasUno VARCHAR2, vsCampaniaMasDos VARCHAR2 ) IS
    SELECT pnca.Conc_Cod_Conc AS CodPrograma,
           CASE
              WHEN NVL(pnca.Nica_Nive_Camp,0) = 0 THEN
                 NULL
              ELSE
                 LPAD( pnca.Nica_Nive_Camp,2,'0')
           END AS CodNivelCam, -- New CMM
           pnca.Inc_Pedi AS IncrementoPedido,
           pnca.Met_Segu_Pedi AS MetaIngEfectivos,
           pnca.Pun_Rank AS PuntajeRankingCampana,
           substr(lnc.des_nive_camp,1,10) AS DesNiveCam,
           case when pnca.tiva_cod_tipo in ('P','A') and pnca.nica_nive_camp > 0 and  pnca.nica_nive_camp < 99
           then 'S'
           else 'N'
           END  FlagPed,
           case when pnca.tiva_cod_tipo in ('I','A') and pnca.nica_nive_camp > 0 and  pnca.nica_nive_camp < 99
           then 'S'
           else 'N'
           END  FlagIng
      FROM let_param_nivel_campa pnca,
           let_param_concu_lider lpcl,
           let_nivel_campa lnc
     WHERE pnca.Pais_Cod_Pais = lpcl.Pais_Cod_Pais
       AND pnca.Conc_Cod_Conc = lpcl.Cod_Conc
       AND pnca.nica_nive_camp = lnc.nive_camp
       AND ( psCodigoPeriodo BETWEEN lpcl.cam_inic AND lpcl.cam_fina OR
             lpcl.cam_inic BETWEEN vsCampaniaMasUno AND vsCampaniaMasDos
           );

  TYPE interfazRec IS RECORD(
      codprograma             LET_PARAM_NIVEL_CAMPA.CONC_COD_CONC%TYPE,
      codnivelcam                VARCHAR2(2),
      incrementopedido        LET_PARAM_NIVEL_CAMPA.INC_PEDI%TYPE,
      metaIngEfectivos        LET_PARAM_NIVEL_CAMPA.MET_SEGU_PEDI%TYPE,
      puntajeRankingCampana   LET_PARAM_NIVEL_CAMPA.PUN_RANK%TYPE,
      DesNiveCam                VARCHAR2(10),
      FlagPed                   VARCHAR2(1),
      FlagIng                   VARCHAR2(1)
  );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
  lsCampaniaMasUno    VARCHAR2(6);
  lsCampaniaMasDos    VARCHAR2(6);

BEGIN

    lbAbrirUtlFile := TRUE;
    lsCampaniaMasUno := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 1 );
    lsCampaniaMasDos := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 2 );

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ( lsCampaniaMasUno, lsCampaniaMasDos );
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).codprograma                 ||';'||
                           interfazrecord(x).codNivelCam                 ||';'||
                           interfazrecord(x).incrementoPedido            ||';'||
                           interfazrecord(x).metaIngEfectivos            ||';'||
                           interfazrecord(x).puntajeRankingCampana        ||';'||
                           interfazrecord(x).DesNiveCam        ||';'||
                           interfazrecord(x).FlagPed        ||';'||
                           interfazrecord(x).FlagIng  ;

               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_NIVEL_CAMPA;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Nivel por Programa ( DAT-112 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PROGR
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS

  CURSOR c_interfaz ( vsCampaniaMasUno VARCHAR2, vsCampaniaMasDos VARCHAR2 )IS
    SELECT pnco.Conc_Cod_Conc AS CodPrograma,
           CASE
              WHEN NVL(pnco.Nico_Nive_Conc,0) = 0 THEN
                 NULL
              ELSE
                 LPAD( pnco.Nico_Nive_Conc,2,'0' )
           END AS CodNivelProg, -- New CMM
           pnco.Por_Incr/100 AS PorIncPedidos
      FROM let_param_nivel_concu pnco,
           let_param_concu_lider lpcl
     WHERE pnco.Pais_Cod_Pais = lpcl.Pais_Cod_Pais
       AND pnco.Conc_Cod_Conc = lpcl.Cod_Conc
       AND ( psCodigoPeriodo BETWEEN lpcl.cam_inic AND lpcl.cam_fina OR
             lpcl.cam_inic BETWEEN vsCampaniaMasUno AND vsCampaniaMasDos
           );

  TYPE interfazRec IS RECORD(
      codprograma      LET_PARAM_NIVEL_CONCU.CONC_COD_CONC%TYPE,
      codnivelprog    VARCHAR2(2),
      porincpedidos  NUMBER(12,3)
    );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
  lsCampaniaMasUno    VARCHAR2(6);
  lsCampaniaMasDos    VARCHAR2(6);

BEGIN

    lbAbrirUtlFile := TRUE;
    lsCampaniaMasUno := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 1 );
    lsCampaniaMasDos := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 2 );

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ( lsCampaniaMasUno, lsCampaniaMasDos );
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).codprograma           ||';'||
                                             interfazrecord(x).codnivelprog        ||';'||
                           TO_CHAR(interfazrecord(x).porincpedidos,'90.000');
               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

  RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL_PROGR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_NIVEL_PROGR;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Rango de Pedidos ( DAT-113 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RANGO_PEDID
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS
  CURSOR c_interfaz ( vsCampaniaMasUno VARCHAR2, vsCampaniaMasDos VARCHAR2 )IS
    SELECT prap.conc_cod_conc AS codprograma,
           lpad( prap.rang_num_rang,2,'0') AS codrangopedido,
         can_pedi AS NumPedidos,
         can_pedi AS MinNroPedidos, -- new
         (
          SELECT can_pedi - 1
            FROM let_param_rango_premi
           WHERE conc_cod_conc = prap.conc_cod_conc
             AND rang_num_rang > prap.rang_num_rang
             AND ROWNUM = 1
         ) AS MaxNroPedidos --new
   FROM let_param_rango_premi prap,
        let_param_concu_lider lpcl
     WHERE prap.Pais_Cod_Pais = lpcl.Pais_Cod_Pais
       AND prap.Conc_Cod_Conc = lpcl.Cod_Conc
       AND ( psCodigoPeriodo BETWEEN lpcl.cam_inic AND lpcl.cam_fina OR
             lpcl.cam_inic BETWEEN vsCampaniaMasUno AND vsCampaniaMasDos
           );

  TYPE interfazRec IS RECORD(
    codprograma        LET_PARAM_RANGO_PREMI.CONC_COD_CONC%TYPE,
      codrangopedido    VARCHAR2(2),
      numpedidos      LET_PARAM_RANGO_PREMI.CAN_PEDI%TYPE,
      minnropedidos   LET_PARAM_RANGO_PREMI.CAN_PEDI%TYPE,
      maxnropedidos   LET_PARAM_RANGO_PREMI.CAN_PEDI%TYPE
    );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;
  lsCampaniaMasUno    VARCHAR2(6);
  lsCampaniaMasDos    VARCHAR2(6);

BEGIN

    lbAbrirUtlFile := TRUE;
    lsCampaniaMasUno := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 1 );
    lsCampaniaMasDos := GEN_FN_CALCU_PERIO( psCodigoPeriodo, + 2 );

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ( lsCampaniaMasUno, lsCampaniaMasDos );
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).codprograma            ||';'||
                                             interfazrecord(x).codrangopedido       ||';'||
                           interfazrecord(x).numpedidos     ||';'||
                           interfazrecord(x).minnropedidos  ||';'||
                           interfazrecord(x).maxnropedidos;

               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RANGO_PEDID: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_RANGO_PEDID;

/*********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Resultado por Periodo ( DAT-114 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_CAMPA
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS

  CURSOR c_interfaz IS
	SELECT resc.lide_cam_lide AS aniocampana,
	           resc.conc_cod_conc AS codprograma,
	           resc.lide_cod_lide AS codlider,
	           resc.cod_regi || resc.cod_zona || resc.cod_secc AS codseccion,
	           resc.ran_prem AS codrangopedido,
             CASE
                WHEN NVL(resc.niv_camp,0) = 0 THEN
                   NULL
                ELSE
                   LPAD(resc.niv_camp,2,'0')
             END AS codnivelcam, -- New CMM
	           nvl(prap.can_pedi,0) AS numpedidos,
	           nvl(obj.obj_pedi,0) AS metapedidos,
	           CASE
	               WHEN nvl(resc.niv_camp,0) = 0 THEN
	                    (
                       SELECT met_segu_pedi
	                        FROM let_param_nivel_campa
	                       WHERE pais_cod_pais = resc.pais_cod_pais
	                         AND conc_cod_conc = resc.conc_cod_conc
	                        AND nica_nive_camp = 1 )
                   WHEN nvl(resc.niv_camp,0) = 99 THEN
                    ( select  ld.num_ingr_nuev from let_param_concu_lider ld
                     WHERE ld.cod_conc = resc.conc_cod_conc )
	               ELSE  pnca.met_segu_pedi
			   END AS metaingefectivos,
	           resc.num_pedi AS realnropedidos,
	           resc.rec_efec AS ingefectivos,
	           resc.act_fina AS realnroactivas,
	           CASE
	               WHEN resc.ind_efec = 1 THEN '1'
	               WHEN resc.ind_efec = 2 THEN '0'
	               ELSE NULL
	           END AS flagganadora,
             CASE
                 WHEN resc.val_esta ='X' THEN 'P'
                 WHEN resc.val_esta ='S' THEN 'E'
             ELSE
                 'C'
             END codrankingcampana,
             CASE
               WHEN nvl(prol.val_esta,0) = 'X' THEN 'P'
               WHEN nvl(prol.val_esta,0) = 'S' THEN 'E'
             ELSE nvl(prol.val_esta,0)
             END codrankingproye,
	           resc.pun_rank AS puntajecampana,
             CASE
              WHEN resc.ind_efec = 1 THEN nvl(lbc.val_mont_bono,0)
              ELSE  0
              END  Bono,
              0 PorComis
	      FROM let_resul_secci_campa resc,
	           let_param_rango_premi prap,
	           let_metas_lider_campa mlca,
			   let_param_nivel_campa pnca,
	           let_produ_lider prol,
             let_objet_pedid_secci obj,
             let_bonos_campa lbc
	     WHERE resc.pais_cod_pais = prap.pais_cod_pais(+)
	       AND resc.conc_cod_conc = prap.conc_cod_conc(+)
	       AND resc.ran_prem = prap.rang_num_rang(+)
	       AND resc.pais_cod_pais = mlca.pais_cod_pais(+)
	       AND resc.conc_cod_conc = mlca.conc_cod_conc(+)
	       AND resc.lide_cam_lide = mlca.cam_eval(+)
	       AND resc.cod_regi = mlca.cod_regi(+)
	       AND resc.cod_zona = mlca.cod_zona(+)
	       AND resc.cod_secc = mlca.cod_secc(+)
	       AND resc.niv_camp = mlca.nica_nive_camp(+)
		   AND resc.pais_cod_pais = pnca.pais_cod_pais(+)
	       AND resc.conc_cod_conc = pnca.conc_cod_conc(+)
	       AND resc.niv_camp = pnca.nica_nive_camp(+)
	       AND resc.pais_cod_pais = prol.pais_cod_pais(+)
	       AND resc.conc_cod_conc = prol.conc_cod_conc(+)
	       AND resc.lide_cod_lide = prol.cod_lid(+)
	       AND resc.lide_cam_lide =   pscodigoPeriodo
         AND resc.cod_regi = obj.cod_regi(+)
         AND resc.cod_zona = obj.cod_zona(+)
         AND resc.cod_secc = obj.cod_secc (+)
         AND resc.lide_cam_lide = obj.cam_proc(+)
         AND resc.niv_camp = lbc.nica_num_nive (+)
         AND resc.ran_prem = lbc.rang_num_rang (+)
         and resc.conc_cod_conc = lbc.cod_conc (+)
         and resc.lide_cam_lide = lbc.cam_desp (+)
         ;

  TYPE interfazRec IS RECORD(
    anioCampana         LET_RESUL_SECCI_CAMPA.LIDE_CAM_LIDE%TYPE,
    codPrograma         LET_RESUL_SECCI_CAMPA.CONC_COD_CONC%TYPE,
    codLider            LET_RESUL_SECCI_CAMPA.LIDE_COD_LIDE%TYPE,
    codSeccion          VARCHAR2(7),
    codRangoPedido      LET_RESUL_SECCI_CAMPA.RAN_PREM%TYPE,
    codNivelCam         LET_RESUL_SECCI_CAMPA.NIV_CAMP%TYPE,
    numPedidos          LET_PARAM_RANGO_PREMI.CAN_PEDI%TYPE,
    metaPedidos         LET_METAS_LIDER_CAMPA.MET_PEDI%TYPE,
    metaIngEfectivos    LET_PARAM_NIVEL_CAMPA.MET_SEGU_PEDI%TYPE,
    realNroPedidos      LET_RESUL_SECCI_CAMPA.NUM_PEDI%TYPE,
    ingEfectivos        LET_RESUL_SECCI_CAMPA.REC_EFEC%TYPE,
    realNroActivas      LET_RESUL_SECCI_CAMPA.ACT_FINA%TYPE,
    flagGanadora        VARCHAR2(1),
    codRankingCampana   LET_RESUL_SECCI_CAMPA.VAL_ESTA%TYPE,
    codRankingProye     LET_PRODU_LIDER.VAL_ESTA%TYPE,
    puntajeCampana      LET_RESUL_SECCI_CAMPA.PUN_RANK%TYPE,
    Bono                LET_BONOS_CAMPA.VAL_MONT_BONO%TYPE,
    PorComis            VARCHAR2(1)
  );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ();
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).anioCampana       ||';'||
                           interfazrecord(x).codPrograma       ||';'||
                           interfazrecord(x).codLider          ||';'||
                           interfazrecord(x).codSeccion        ||';'||
                           interfazrecord(x).codRangoPedido    ||';'||
                           interfazrecord(x).codNivelCam       ||';'||
                           interfazrecord(x).numPedidos        ||';'||
                           interfazrecord(x).metaPedidos       ||';'||
                           interfazrecord(x).metaIngEfectivos  ||';'||
                           interfazrecord(x).realNroPedidos    ||';'||
                           interfazrecord(x).ingEfectivos      ||';'||
                           interfazrecord(x).realNroActivas    ||';'||
                           interfazrecord(x).flagGanadora      ||';'||
                           interfazrecord(x).codRankingCampana ||';'||
                           interfazrecord(x).codRankingProye   ||';'||
                           interfazrecord(x).puntajeCampana    ||';'||
                           interfazrecord(x).Bono              ||';'||
                           interfazrecord(x).PorComis;

               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RESUL_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_RESUL_CAMPA;

/***********************************************************************************
  Descripcion       : Genera Interfaz de Envio de Resultado por Programa ( DAT-115 )
  Fecha Creacion    : 01/03/2011
  Autor             : Jose Luis Rodriguez
/***********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_PROGR
  (psCodigoPais     VARCHAR2,
   psCodigoSistema     VARCHAR2,
   psCodigoInterfaz VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psCodigoCanal         VARCHAR2,
   psCodigoIso           VARCHAR2,
   psCodigoPeriodo  VARCHAR2)
IS

  CURSOR c_interfaz IS
    SELECT psCodigoPeriodo AS AnioCampana,
           rlco.Conc_Cod_Conc AS CodPrograma,
           rlco.Cod_Lide AS CodLider,
           rlco.Ran_Prem AS CodRanPedido,
           CASE
              WHEN NVL(rlco.Niv_Conc,0) = 0 THEN
                 NULL
              ELSE
                 LPAD( rlco.Niv_Conc,2,'0')
           END AS CodNivelProg, -- New CMM
           prap.can_pedi AS NumPedidos,
           CASE
               WHEN nvl(rlco.niv_conc,0) = 0 THEN
                    ( SELECT met_pedi
                        FROM let_metas_lider_concu
                       WHERE pais_cod_pais = rlco.pais_cod_pais
                         AND conc_cod_conc = rlco.conc_cod_conc
                         AND nico_nive_conc = 1
                         AND cod_lide = rlco.cod_lide )
               ELSE lmlc.met_pedi
           END AS MetaPedido,
           NVL(prol.num_camp_eval,0) AS NumCampanas,
           CASE
               WHEN rlco.Ind_Efec = 1 THEN '1'
               WHEN rlco.Ind_Efec = 2 THEN '0'
               ELSE NULL
           END AS FlagGanadora
      FROM let_resul_lider_concu rlco,
           let_param_concu_lider lpcl,
           let_param_rango_premi prap,
           let_metas_lider_concu lmlc,
           let_produ_lider prol
     WHERE rlco.pais_cod_pais = lpcl.pais_cod_pais
       AND rlco.conc_cod_conc = lpcl.cod_conc
       AND rlco.pais_cod_pais = prap.pais_cod_pais
       AND rlco.conc_cod_conc = prap.conc_cod_conc
       AND rlco.ran_prem = prap.rang_num_rang
       AND rlco.pais_cod_pais = lmlc.pais_cod_pais(+)
       AND rlco.conc_cod_conc = lmlc.conc_cod_conc(+)
       AND rlco.niv_conc = lmlc.nico_nive_conc(+)
       AND rlco.cod_lide = lmlc.cod_lide(+)
       AND rlco.pais_cod_pais = prol.pais_cod_pais(+)
       AND rlco.conc_cod_conc = prol.conc_cod_conc(+)
       AND rlco.cod_lide = prol.cod_lid(+)
       AND lpcl.Cam_Inic <= psCodigoPeriodo
       AND lpcl.Cam_Fina >= psCodigoPeriodo;

  TYPE interfazRec IS RECORD(
    anioCampana    LET_RESUL_SECCI_CAMPA.LIDE_CAM_LIDE%TYPE,
    codPrograma    LET_RESUL_LIDER_CONCU.CONC_COD_CONC%TYPE,
    codLider       LET_RESUL_LIDER_CONCU.COD_LIDE%TYPE,
    codRanPedido   LET_RESUL_LIDER_CONCU.RAN_PREM%TYPE,
    codNivelProg   LET_RESUL_LIDER_CONCU.NIV_CONC%TYPE,
    numPedidos     LET_PARAM_RANGO_PREMI.CAN_PEDI%TYPE,
    metaPedido     LET_METAS_LIDER_CONCU.MET_PEDI%TYPE,
    numCampanas    LET_PRODU_LIDER.NUM_CAMP_EVAL%TYPE,
    flagGanadora   VARCHAR2(1)
  );

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_handle            UTL_FILE.FILE_TYPE;
  lsLinea             VARCHAR2(1000);
  lsNombreArchivo     VARCHAR2(50);
  lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz ();
      LOOP
        FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
           /* Procedimiento inicial para generar interfaz */
           IF lbAbrirUtlFile THEN
             GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                    psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
             lbAbrirUtlFile := FALSE;
           END IF;

           IF interfazRecord.COUNT > 0 THEN
             FOR x IN interfazrecord.first .. interfazrecord.last LOOP
               lslinea :=  interfazrecord(x).anioCampana  ||';'||
                           interfazrecord(x).codPrograma  ||';'||
                           interfazrecord(x).codLider     ||';'||
                           interfazrecord(x).codRanPedido ||';'||
                           interfazrecord(x).codNivelProg ||';'||
                           interfazrecord(x).numPedidos   ||';'||
                           interfazrecord(x).metaPedido   ||';'||
                           interfazrecord(x).numCampanas  ||';'||
                           interfazrecord(x).flagGanadora;

               UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END LOOP;
           END IF;

        EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
        utl_file.fclose(V_HANDLE);

        /* Procedimiento final para generar interfaz */
        GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
      END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RESUL_PROGR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_RESUL_PROGR;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Unidades Geograficas (DAT-5)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNIDA_GEOGR
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

   		SELECT ter.cod_terr codigoTerritorio,
           	   sec.cod_secc codigoSeccion,
               nvl(clisec.cod_clie,' ') liderSeccion,
           	   zon.cod_zona codigoZona,
           	   reg.cod_regi codigoRegion,
           	   nvl(clizon.cod_clie,' ') gerenteZona,
           	   nvl(clireg.cod_clie,' ') gerenteRegion,
           	   CASE WHEN trim(ter.cod_nse2) IS NULL THEN trim(ter.cod_nse1) ELSE trim(ter.cod_nse2) END nivel,
           	   nivel1.orde_1 codigoDepartamento,
           	   nivel2.orde_2 codigoProvincia,
           	   nivel3.orde_3 codigoDistrito,
           	   nivel1.des_geog nombreDepartamento,
           	   nivel2.des_geog nombreProvincia,
           	   nivel3.des_geog nombreDistrito,
           	   geo.orde_1 || geo.orde_2 || geo.orde_3 ||
           	   geo.orde_4 || geo.orde_5 || geo.orde_6 ||
           	   geo.orde_7 || geo.orde_8 || geo.orde_9 codigoUbigeo,
			         reg.des_regi nombreRegion,
           	   zon.des_zona nombreZona,
           	   pais.cod_pais codigoPais,
           	   substr(GEN_PKG_GENER.GEN_FN_DEVUELVE_DESCRIPCION(pais.OID_PAIS, 'SEG_PAIS', psCodigoIso), 1, 15) nombrePais,
			         clisec.val_nom1 || ' ' || clisec.val_nom2 ||' ' || clisec.val_ape1 ||' ' || clisec.val_ape2 nombreLiderSeccion,
           	   clireg.val_nom1 || ' ' || clireg.val_nom2 ||' ' || clireg.val_ape1 ||' ' || clireg.val_ape2 nombreGerenteRegion,
           	   clizon.val_nom1 || ' ' || clizon.val_nom2 ||' ' || clizon.val_ape1 ||' ' || clizon.val_ape2 nombreGerenteZona,
			         NULL campanaCreacionTerritorio,
           	   sgv.cod_subg_vent codigoSubgerenciaVentas,
           	   sgv.des_subg_vent nombreSubgerenciaVentas


          FROM zon_terri_admin tad,
       		   zon_terri ter,
       		   zon_zona zon,
       		   zon_secci sec,
       		   zon_regio reg,
       		   zon_sub_geren_venta sgv,
       		   mae_clien clizon,
       		   mae_clien clireg,
       		   mae_clien clisec,
       		   zon_valor_estru_geopo geo,
       		   zon_valor_estru_geopo nivel1,
       		   zon_valor_estru_geopo nivel2,
       		   zon_valor_estru_geopo nivel3,
       		   seg_pais pais
          WHERE tad.pais_oid_pais = vnIdPais
          AND 	tad.marc_oid_marc = vnIdMarca
          AND 	tad.cana_oid_cana = vnIdCanal
          AND 	tad.ind_borr = 0
          AND 	tad.terr_oid_terr = ter.oid_terr
          AND 	tad.zscc_oid_secc = sec.oid_secc
          AND   sec.zzon_oid_zona = zon.oid_zona
          AND 	zon.zorg_oid_regi = reg.oid_regi
          AND 	reg.zsgv_oid_subg_vent = sgv.oid_subg_vent
		  AND	sgv.pais_oid_pais = pais.oid_pais
          AND 	zon.clie_oid_clie = clizon.oid_clie  (+)
          AND 	reg.clie_oid_clie = clireg.oid_clie (+)
          AND 	sec.clie_oid_clie = clisec.oid_clie (+)
          AND 	ter.vepo_oid_valo_estr_geop = geo.oid_valo_estr_geop
          --
          AND 	nivel1.orde_1 = geo.orde_1
          AND 	nivel1.orde_2 IS NULL
          AND 	nivel1.pais_oid_pais =geo.pais_oid_pais
          --
          AND 	nivel2.orde_1 = geo.orde_1
          AND 	nivel2.orde_2 = geo.orde_2
          AND 	nivel2.orde_3 IS NULL
          AND 	nivel2.pais_oid_pais = geo.pais_oid_pais
          --
          AND 	nivel3.orde_1 = geo.orde_1
          AND 	nivel3.orde_2 = geo.orde_2
          AND 	nivel3.orde_3 = geo.orde_3
          AND 	nivel3.orde_4 IS NULL
          AND 	nivel3.pais_oid_pais = geo.pais_oid_pais
          --
          AND 	nivel1.ind_acti= 1
          AND 	nivel1.ind_borr=0
          --
          AND 	nivel2.ind_acti= 1
          AND 	nivel2.ind_borr=0
          --
          AND 	nivel3.ind_acti= 1
          AND 	nivel3.ind_borr=0
          --
          AND 	sec.ind_acti = 1
          AND 	zon.ind_acti = 1
          AND 	zon.ind_borr = 0
          AND 	reg.ind_acti = 1
          AND 	reg.ind_borr = 0 ;


   TYPE interfazRec IS RECORD
	   (
    	   codigoTerritorio         zon_terri.cod_terr%TYPE,
    	   codigoSeccion   			zon_secci.cod_secc%TYPE,
    	   liderSeccion				mae_clien.cod_clie%TYPE,
    	   codigoZona				zon_zona.cod_zona%TYPE,
           codigoRegion						zon_regio.cod_regi%TYPE,
    	   gerenteZona				mae_clien.cod_clie%TYPE,
    	   gerenteRegion			mae_clien.cod_clie%TYPE,
    	   nivel					zon_terri.cod_nse2%TYPE,
    	   codigoDepartamento		zon_valor_estru_geopo.orde_1%TYPE,
           codigoProvincia					zon_valor_estru_geopo.orde_2%TYPE,
           codigoDistrito					zon_valor_estru_geopo.orde_3%TYPE,
           nombreDepartamento		zon_valor_estru_geopo.des_geog%TYPE,
           nombreProvincia			zon_valor_estru_geopo.des_geog%TYPE,
           nombreDistrito			zon_valor_estru_geopo.des_geog%TYPE,
           codigoUbigeo				VARCHAR2(54),
           nombreRegion						zon_regio.des_regi%TYPE,
           nombreZona						zon_zona.des_zona%TYPE,
           codigoPais						seg_pais.cod_pais%TYPE,
           nombrePais						VARCHAR2(15),
           nombreLiderSeccion				VARCHAR2(100),
           nombreGerenteRegion				VARCHAR2(100),
           nombreGerenteZona				VARCHAR2(100),
           campanaCreacionTerritorio		VARCHAR2(8),
           codigoSubgerenciaVentas  zon_sub_geren_venta.cod_subg_vent%TYPE,
           nombreSubgerenciaVentas	zon_sub_geren_venta.des_subg_vent%TYPE
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoTerritorio            ||';'||
						  		  	  interfazRecord(x).codigoSeccion            	||';'||
									  interfazRecord(x).liderSeccion				||';'||
									  interfazRecord(x).codigoZona  				||';'||
                                      interfazRecord(x).codigoRegion					||';'||
									  interfazRecord(x).gerenteZona		 			||';'||
									  interfazRecord(x).gerenteRegion		 		||';'||
									  interfazRecord(x).nivel		 				||';'||
									  interfazRecord(x).codigoDepartamento		 	||';'||
                                      interfazRecord(x).codigoProvincia					||';'||
                                      interfazRecord(x).codigoDistrito					||';'||
									  interfazRecord(x).nombreDepartamento		 	||';'||
									  interfazRecord(x).nombreProvincia		 		||';'||
									  interfazRecord(x).nombreDistrito		 		||';'||
									  interfazRecord(x).codigoUbigeo		 		||';'||
                                      interfazRecord(x).nombreRegion					||';'||
                                      interfazRecord(x).nombreZona						||';'||
                                      interfazRecord(x).codigoPais						||';'||
                                      interfazRecord(x).nombrePais						||';'||
                                      interfazRecord(x).nombreLiderSeccion				||';'||
                                      interfazRecord(x).nombreGerenteRegion				||';'||
                                      interfazRecord(x).nombreGerenteZona				||';'||
                                      interfazRecord(x).campanaCreacionTerritorio		||';'||
									  interfazRecord(x).codigoSubgerenciaVentas		||';'||
									  interfazRecord(x).nombreSubgerenciaVentas;


						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_UNIDA_GEOGR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_UNIDA_GEOGR;

/************************************************************************************
Descripcion       : Genera Interfaz de Envio Unidades Geograficas de Periodo (DAT-6)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNIGE_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

		SELECT DISTINCT
			   psCodigoPeriodo codigoCampana,
			   psCodigoCanal codigoCanal,
               terr.cod_terr codigoTerritorio,
               secc.cod_secc codigoSeccion,
               nvl(clisec.cod_clie,' ') liderSeccion,
               zon.cod_zona codigoZona	  ,
               reg.cod_regi codigoRegion,
               nvl(clizon.cod_clie,' ') gerenteZona,
               nvl(clireg.cod_clie,' ') gerenteRegion,
               geo.orde_1 || geo.orde_2 || geo.orde_3 ||
           	   geo.orde_4 || geo.orde_5 || geo.orde_6 ||
           	   geo.orde_7 || geo.orde_8 || geo.orde_9 codigoUbigeo,
               reg.des_regi nombreRegion,
               zon.des_zona nombreZona,
               clisec.val_nom1 || ' ' || clisec.val_nom2 ||' ' || clisec.val_ape1 ||' ' || clisec.val_ape2 nombreLiderSeccion,
               clireg.val_nom1 || ' ' || clireg.val_nom2 ||' ' || clireg.val_ape1 ||' ' || clireg.val_ape2 nombreGerenteRegion,
               clizon.val_nom1 || ' ' || clizon.val_nom2 ||' ' || clizon.val_ape1 ||' ' || clizon.val_ape2 nombreGerenteZona,
               est.cod_esta_zona codigoEstatus,
               subg.cod_subg_vent codigoSubgerenciaVentas,
               subg.des_subg_vent nombreSubgerenciaVentas
          FROM zon_zona zon,
               zon_regio reg,
               zon_sub_geren_venta subg,
               zon_terri_admin tad,
               zon_terri terr,
               zon_secci secc,
               zon_valor_estru_geopo geo,
               zon_estad_zona est,
               mae_clien clisec,
               mae_clien clizon,
               mae_clien clireg
         WHERE secc.zzon_oid_zona = zon.oid_zona
           AND zon.zorg_oid_regi = reg.oid_regi
           AND zon.eszo_oid_esta_zona = est.oid_esta_zona(+)
           AND reg.zsgv_oid_subg_vent = subg.oid_subg_vent
           AND tad.terr_oid_terr = terr.oid_terr
           AND terr.vepo_oid_valo_estr_geop = geo.oid_valo_estr_geop
           AND tad.zscc_oid_secc = secc.oid_secc
           AND secc.clie_oid_clie = clisec.oid_clie(+)
           AND zon.clie_oid_clie = clizon.oid_clie (+)
           AND reg.clie_oid_clie = clireg.oid_clie (+)
           AND tad.pais_oid_pais = vnIdPais
           AND tad.marc_oid_marc = vnIdMarca
           AND tad.cana_oid_cana = vnIdCanal
           AND tad.ind_borr = 0
           AND secc.ind_acti = 1
           AND zon.ind_acti = 1 AND zon.ind_borr = 0
           AND reg.ind_acti = 1 AND reg.ind_borr = 0
           AND subg.ind_acti = 1 AND subg.ind_borr = 0 ;


   TYPE interfazRec IS RECORD
	   (
    	   codigoCampana	   	 	VARCHAR2(6),
		   codigoCanal				VARCHAR2(2),
		   codigoTerritorio         zon_terri.cod_terr%TYPE,
    	   codigoSeccion   			zon_secci.cod_secc%TYPE,
    	   liderSeccion				mae_clien.cod_clie%TYPE,
    	   codigoZona				zon_zona.cod_zona%TYPE,
    	   codigoRegion				zon_regio.cod_regi%TYPE,
    	   gerenteZona				mae_clien.cod_clie%TYPE,
    	   gerenteRegion			mae_clien.cod_clie%TYPE,
		   codigoUbigeo				VARCHAR2(54),
		   nombreRegion				zon_regio.des_regi%TYPE,
    	   nombreZona				zon_zona.des_zona%TYPE,
    	   nombreLiderSeccion		VARCHAR2(100),
		   nombreGerenteZona		VARCHAR2(100),
    	   nombreGerenteRegion		VARCHAR2(100),
    	   codigoEstatus			zon_estad_zona.cod_esta_zona%TYPE,
           codigoSubgerenciaVentas  zon_sub_geren_venta.cod_subg_vent%TYPE,
           nombreSubgerenciaVentas	zon_sub_geren_venta.des_subg_vent%TYPE
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCampana            	||';'||
						  		  	  interfazRecord(x).codigoCanal                 ||';'||
						  		  	  interfazRecord(x).codigoTerritorio            ||';'||
						  		  	  interfazRecord(x).codigoSeccion            	||';'||
									  interfazRecord(x).liderSeccion				||';'||
									  interfazRecord(x).codigoZona  				||';'||
									  interfazRecord(x).codigoRegion		 		||';'||
									  interfazRecord(x).gerenteZona		 			||';'||
									  interfazRecord(x).gerenteRegion		 		||';'||
									  interfazRecord(x).codigoUbigeo		 		||';'||
									  interfazRecord(x).nombreRegion		 		||';'||
									  interfazRecord(x).nombreZona		 			||';'||
									  interfazRecord(x).nombreLiderSeccion   		||';'||
									  interfazRecord(x).nombreGerenteZona		 	||';'||
									  interfazRecord(x).nombreGerenteRegion		 	||';'||
									  interfazRecord(x).codigoEstatus		 	||';'||
									  interfazRecord(x).codigoSubgerenciaVentas		||';'||
									  interfazRecord(x).nombreSubgerenciaVentas;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_UNIGE_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_UNIGE_CAMPA;

/************************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion Gerentes Regionales (DAT-7)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GEREN_REGIO
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

         SELECT DISTINCT
                cli.cod_clie codigoGerenteRegional,
                cli.val_nom1 || ' ' || cli.val_nom2 || ' ' || cli.val_ape1 || ' ' || cli.val_ape2 nombreGerenteRegional,
                cli2.cod_clie codigoGerenteComoConsultora,
                ' ' AS codigoRegionGerente,
                orden1.des_geog departamento,
                orden2.des_geog provincia,
                orden3.des_geog distrito,
                tvia.des_abrv_tipo_via || ' ' || dir.val_nomb_via || ' ' || dir.num_ppal direccionGerente,
                (
           	   	 SELECT gen.val_i18n
                   FROM gen_i18n_sicc_comun gen, seg_idiom idio
                  WHERE gen.attr_enti = 'ZON_NIVEL_GEOGR'
                    AND gen.idio_oid_idio = idio.oid_idio
                    AND gen.val_oid = tipo_poblado.oid_divi_poli
  					        AND idio.cod_iso_idio = psCodigoIso
           	    ) descripcionTipoCentroPoblado,
                orden4.des_geog descripcionCentroPoblado,
                cod_tipo_poblado.cod_sube codigoTipoCentroPoblado,
                orden4.orde_4 codigoCentroPoblado,
                geo.orde_1 || geo.orde_2 || geo.orde_3 ||
         	      geo.orde_4 || geo.orde_5 || geo.orde_6 ||
         	      geo.orde_7 || geo.orde_8 || geo.orde_9 codigoUbigeo,
        		    (
         	       SELECT c.val_text_comu
                   FROM mae_clien_comun c, mae_tipo_comun tc
                  WHERE c.clie_oid_clie = cli.oid_clie
              		  AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                 	  AND cod_tipo_comu = 'TF'
         	      ) telefonoDomicilio,
                (
         	       SELECT c.val_text_comu
                   FROM mae_clien_comun c, mae_tipo_comun tc
                  WHERE c.clie_oid_clie = cli.oid_clie
              	    AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                    AND cod_tipo_comu = 'FX'
         	      ) faxDomicilio,
                (
         	       SELECT c.val_text_comu
                   FROM mae_clien_comun c, mae_tipo_comun tc
                  WHERE c.clie_oid_clie = cli.oid_clie
              	    AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                    AND cod_tipo_comu = 'TM'
         	      ) telefonoCelular,
                (
         	       SELECT gen.val_i18n
                   FROM gen_i18n_sicc_comun gen, seg_idiom idio
                  WHERE gen.attr_enti = 'MAE_ESTAD_CIVIL'
                    AND gen.idio_oid_idio = idio.oid_idio
                    AND gen.val_oid = civ.oid_esta_civi
					          AND idio.cod_iso_idio = psCodigoIso
         	      ) estadoCivil,
                tdoc.cod_tipo_docu tipoDocumentoIdentidad,
                ide.num_docu_iden numeroDocumentoIdentidad,
                to_char(adi.fec_naci,'yyyyMMdd') fechaNacimiento,
                (
         	       SELECT c.val_text_comu
                   FROM mae_clien_comun c, mae_tipo_comun tc
                  WHERE c.clie_oid_clie = cli.oid_clie
              	    AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                    AND cod_tipo_comu = 'ML'
         	      ) email,
                CASE WHEN (tdoc1.cod_tipo_docu <> '05' OR tdoc1.cod_tipo_docu IS NULL ) THEN NULL
                 ELSE cliden.num_docu_iden
                 END numeroPasaporte,
        		    '' fechaInicioContrato,
        		    '' fechaFinContrato,
        		    0 flagTipoAccion,
                adi.cod_cub -- Nuevo
           FROM zon_regio reg,
                mae_clien cli,
                mae_clien cli2,
                mae_clien_unida_admin adm,
                mae_clien_datos_adici adi,
                mae_estad_civil civ,
                mae_clien_ident ide,
                mae_tipo_docum tdoc,
                mae_clien_direc dir,
                zon_valor_estru_geopo geo,
                zon_terri_admin tad,
                zon_terri terr,
                zon_secci secc,
                zon_zona zon,
                seg_tipo_via tvia,
                mae_clien_ident cliden,
                mae_tipo_docum tdoc1,
                zon_valor_estru_geopo orden1,
                zon_valor_estru_geopo orden2,
                zon_valor_estru_geopo orden3,
                zon_valor_estru_geopo orden4,
                zon_estru_geopo estru,
                zon_nivel_geogr tipo_poblado,
                zon_subes_geopo cod_tipo_poblado,
           	    mae_clien_comun com
          WHERE reg.clie_oid_clie = cli.oid_clie
            AND cli.oid_clie = cli2.oid_clie
            AND adm.clie_oid_clie = cli2.oid_clie
            AND adm.ztad_oid_terr_admi = tad.oid_terr_admi
            AND tad.terr_oid_terr = terr.oid_terr
            AND tad.zscc_oid_secc = secc.oid_secc
            AND secc.zzon_oid_zona = zon.oid_zona
            AND terr.vepo_oid_valo_estr_geop = geo.oid_valo_estr_geop
            AND adi.clie_oid_clie = cli.oid_clie
            AND adi.escv_oid_esta_civi = civ.oid_esta_civi(+)
            AND ide.clie_oid_clie = cli.oid_clie
            AND ide.tdoc_oid_tipo_docu = tdoc.oid_tipo_docu
            AND ide.val_iden_docu_prin = 1
            AND dir.clie_oid_clie(+) = cli.oid_clie
            AND dir.ind_dire_ppal = 1
            AND dir.tivi_oid_tipo_via = tvia.oid_tipo_via
            AND dir.ind_elim = 0
            AND reg.ind_acti = 1
            AND reg.ind_borr = 0
            AND adm.ind_acti = 1
            AND zon.ind_borr = 0
            AND zon.ind_acti = 1
            AND terr.ind_borr = 0
            AND secc.ind_borr = 0
            AND secc.ind_acti = 1
            AND cli.oid_clie = com.clie_oid_clie(+)
            AND reg.pais_oid_pais = vnIdPais
            AND reg.marc_oid_marc = vnIdMarca
            AND reg.cana_oid_cana = vnIdCanal
            AND cliden.clie_oid_clie(+) = cli.oid_clie
            AND cliden.tdoc_oid_tipo_docu = tdoc1.oid_tipo_docu
            AND orden1.orde_1(+) = geo.orde_1
            AND orden1.orde_2 IS NULL
            AND orden1.pais_oid_pais = geo.pais_oid_pais
            AND orden2.orde_1(+) = geo.orde_1
            AND orden2.orde_2(+) = geo.orde_2
            AND orden2.orde_3 IS NULL
            AND orden2.pais_oid_pais = geo.pais_oid_pais
            AND orden3.orde_1(+) = geo.orde_1
            AND orden3.orde_2(+) = geo.orde_2
            AND orden3.orde_3(+) = geo.orde_3
            AND orden3.orde_4 IS NULL
            AND orden3.pais_oid_pais = geo.pais_oid_pais
            AND orden4.orde_1(+) = geo.orde_1
            AND orden4.orde_2(+) = geo.orde_2
            AND orden4.orde_3(+) = geo.orde_3
            AND orden4.orde_4(+) = geo.orde_4
            AND orden4.orde_5 IS NULL
            AND orden4.pais_oid_pais(+) = geo.pais_oid_pais
            AND estru.oid_estr_geop(+) = orden4.egeo_oid_estr_geop
            AND cod_tipo_poblado.oid_sube_geop(+) = orden4.sgeo_oid_sube_geop
            AND tipo_poblado.oid_divi_poli(+) = estru.dipo_oid_divi_poli ;


   TYPE interfazRec IS RECORD
	   (
    	 codigoGerenteRegional	   	 	  	mae_clien.cod_clie%TYPE,
		   nombreGerenteRegional				    VARCHAR2(100),
		   codigoGerenteComoConsultora			mae_clien.cod_clie%TYPE,
		   codigoRegionGerente         			VARCHAR2(3),
    	 departamento   						      VARCHAR2(25),
    	 provincia							          VARCHAR2(25),
    	 distrito								          VARCHAR2(25),
    	 direccionGerente						      VARCHAR2(80),
    	 descripcionTipoCentroPoblado			VARCHAR2(25),
    	 descripcionCentroPoblado				  VARCHAR2(25),
		   codigoTipoCentroPoblado				  VARCHAR2(2),
		   codigoCentroPoblado					    VARCHAR2(6),
    	 codigoUbigeo							        VARCHAR2(48),
    	 telefonoDomicilio					      VARCHAR2(15),
		   faxDomicilio							        VARCHAR2(15),
    	 telefonoCelular						      VARCHAR2(15),
    	 estadoCivil							        VARCHAR2(15),
       tipoDocumentoIdentidad  				  VARCHAR2(3),
       numeroDocumentoIdentidad				  VARCHAR2(18),
		   fechaNacimiento						      VARCHAR2(8),
		   email								            VARCHAR2(50),
		   numeroPasaporte						      VARCHAR2(15),
		   fechaInicioContrato					    VARCHAR2(8),
		   fechaFinContrato						      VARCHAR2(8),
		   flagTipoAccion						        NUMBER(1),
       codigoCUB                        VARCHAR2(20) -- Nuevo
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoGerenteRegional         ||';'||
						  		  	            interfazRecord(x).nombreGerenteRegional         ||';'||
									                interfazRecord(x).codigoGerenteComoConsultora   ||';'||
						  		  	            interfazRecord(x).codigoRegionGerente           ||';'||
						  		  	            interfazRecord(x).departamento            			||';'||
              									  interfazRecord(x).provincia							        ||';'||
              									  interfazRecord(x).distrito  							      ||';'||
              									  interfazRecord(x).direccionGerente		 			    ||';'||
              									  interfazRecord(x).descripcionTipoCentroPoblado	||';'||
              									  interfazRecord(x).descripcionCentroPoblado			||';'||
              									  interfazRecord(x).codigoTipoCentroPoblado				||';'||
              									  interfazRecord(x).codigoCentroPoblado					  ||';'||
              									  interfazRecord(x).codigoUbigeo						      ||';'||
              									  interfazRecord(x).telefonoDomicilio		 			    ||';'||
              									  interfazRecord(x).faxDomicilio						      ||';'||
              									  interfazRecord(x).telefonoCelular						    ||';'||
              									  interfazRecord(x).estadoCivil							      ||';'||
              									  interfazRecord(x).tipoDocumentoIdentidad				||';'||
              									  interfazRecord(x).numeroDocumentoIdentidad			||';'||
              									  interfazRecord(x).fechaNacimiento						    ||';'||
              									  interfazRecord(x).email								          ||';'||
              									  interfazRecord(x).numeroPasaporte						    ||';'||
              									  interfazRecord(x).fechaInicioContrato					  ||';'||
              									  interfazRecord(x).fechaFinContrato					    ||';'||
              									  interfazRecord(x).flagTipoAccion                ||';'||
                                  interfazRecord(x).codigoCUB; -- Nuevo

						            UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_GEREN_REGIO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_GEREN_REGIO;


/****************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion de Lideres (DAT-10)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_INFOR_LIDER
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso             VARCHAR2,
   psCodigoPeriodo         VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

              select datat.*
from (
  SELECT
     CASE WHEN
            ( select nvl(ind_prog_lide,0)
                from bas_pais
               where cod_pais = psCodigoPais )  >= 1 THEN
           (   select  zh.gere
                from zon_histo_geren zh,
                     cra_perio pr,
                     seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
                 and pr.peri_oid_peri = pc.oid_peri
                 and pc.cod_peri =  pscodigoPeriodo
           and  pr.oid_peri >= zh.perd_oid_peri_desd
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null) )
        ELSE
               ( select mc.cod_clie
                   from mae_clien mc
             where mc.oid_clie = zs.clie_oid_clie )
        END codigoConsultoraLider,
       CASE WHEN
        ( select  nvl(ind_prog_lide,0)  from bas_pais where cod_pais = psCodigoPais)  >= 1    THEN
          (   select  SUBSTR(mc.val_nom1,1,15) || ' ' ||  SUBSTR(mc.val_nom2,1,10) || ' ' ||  SUBSTR(mc.val_ape1,1,15) || ' ' ||  SUBSTR(mc.val_ape2,1,10)
           from zon_histo_geren zh, mae_clien mc, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri = pscodigoPeriodo
           and ( pr.oid_peri >= zh.perd_oid_peri_desd or  zh.perd_oid_peri_desd is null )
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           and mc.cod_clie = gere )
        ELSE
           (  select  SUBSTR(mc.val_nom1,1,15) || ' ' ||  SUBSTR(mc.val_nom2,1,10) || ' ' ||  SUBSTR(mc.val_ape1,1,15) || ' ' ||  SUBSTR(mc.val_ape2,1,10)
           from   mae_clien mc
           where zs.clie_oid_clie = mc.oid_clie   )
        END nombreLider,
        CASE WHEN
        ( select  nvl(ind_prog_lide,0)  from bas_pais where cod_pais = psCodigoPais  )  >= 1    THEN
          (   select  SUBSTR(trim(tvia.des_abrv_tipo_via) || ' '  || trim(dir.val_nomb_via) || ' ' || trim(dir.num_ppal),1,80)
           from zon_histo_geren zh, mae_clien cli, mae_clien_direc dir, seg_tipo_via tvia, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           and ( pr.oid_peri >= zh.perd_oid_peri_desd or  zh.perd_oid_peri_desd is null )
           and ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           and cli.cod_clie = gere
           AND dir.clie_oid_clie(+) = cli.oid_clie
           AND dir.tivi_oid_tipo_via = tvia.oid_tipo_via(+)
           AND dir.ind_dire_ppal(+) = 1
           AND dir.ind_elim (+) =0 )
        ELSE
           (  select  SUBSTR(trim(tvia.des_abrv_tipo_via) || ' '  || trim(dir.val_nomb_via) || ' ' || trim(dir.num_ppal),1,80)
           from   mae_clien cli, mae_clien_direc dir, seg_tipo_via tvia
           where zs.clie_oid_clie = cli.oid_clie
           AND dir.clie_oid_clie(+) = cli.oid_clie
           AND dir.tivi_oid_tipo_via = tvia.oid_tipo_via(+)
           AND dir.ind_dire_ppal(+) = 1
           AND dir.ind_elim (+) =0 )
        END direccionLider,
        CASE WHEN
        ( select  nvl(ind_prog_lide,0)  from bas_pais where cod_pais = psCodigoPais)  >= 1    THEN
          (   select SUBSTR(com1.val_text_comu,1,15)
           from zon_histo_geren zh, mae_clien cli, mae_clien_comun com1,mae_tipo_comun tcom1, cra_perio pr, seg_perio_corpo pc
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           AND ( pr.oid_peri >= zh.perd_oid_peri_desd or  zh.perd_oid_peri_desd is null )
           AND ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           AND cli.cod_clie = gere
           AND cli.oid_clie = com1.clie_oid_clie
           AND com1.ticm_oid_tipo_comu = tcom1.oid_tipo_comu
           AND tcom1.cod_tipo_comu = 'TF' )
         ELSE
           (  select SUBSTR(com1.val_text_comu,1,15)
           from   mae_clien cli, mae_clien_comun com1, mae_tipo_comun tcom1
           where zs.clie_oid_clie = cli.oid_clie
            AND cli.oid_clie = com1.clie_oid_clie
           AND com1.ticm_oid_tipo_comu = tcom1.oid_tipo_comu
           AND tcom1.cod_tipo_comu = 'TF' )
        END telefono,
            CASE
               WHEN ( SELECT nvl( ind_prog_lide,0 )
                        FROM bas_pais
                       WHERE cod_pais = psCodigoPais )  >= 1 THEN
                    FIN_PKG_GENER.FIN_FN_OBTIE_CODIG_PERIO
                    (
                      (
                        SELECT MAX( hger.perd_oid_peri_desd ) AS perd_oid_peri_desd
                          FROM zon_histo_geren hger
                         WHERE hger.gere = (
                                             SELECT cod_clie
                                               FROM mae_clien
                                              WHERE oid_clie = zs.clie_oid_clie
                                           )
                         GROUP BY hger.gere
                      )
                    )
                    /*
          (   select MAX(pc.cod_peri)
           from zon_histo_geren zh, cra_perio p, seg_perio_corpo pc, zon_histo_geren zhg, cra_perio pr, seg_perio_corpo pc2
           where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
           and pr.peri_oid_peri = pc2.oid_peri and pc2.cod_peri = pscodigoPeriodo
           AND ( pr.oid_peri >= zh.perd_oid_peri_desd or  zh.perd_oid_peri_desd is null )
           AND ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
           AND zh.gere = zhg.gere
           		      AND p.peri_oid_peri = pc.oid_peri
           		      AND p.fec_inic <= zhg.fec_desd
           AND p.fec_fina >= zhg.fec_desd )
                    */
         ELSE
                ( SELECT MAX(pc.cod_peri)
                    FROM mae_clien cli,
                         cra_perio p,
                         seg_perio_corpo pc,
                         zon_histo_geren zhg
                   WHERE cli.oid_clie = zs.clie_oid_clie
              AND cli.cod_clie = zhg.gere
           AND p.peri_oid_peri = pc.oid_peri
           AND p.fec_inic <= zhg.fec_desd
           AND p.fec_fina >= zhg.fec_desd  )
        END campa
        FROM zon_regio zr,
          	   zon_sub_geren_venta sgv,
          	   zon_zona zz,
          	   zon_secci zs,
                 cra_perio pr,
                 seg_perio_corpo pc
           WHERE zs.zzon_oid_zona = zz.oid_zona
           AND zz.zorg_oid_regi = zr.oid_regi
           AND zr.zsgv_oid_subg_vent = sgv.oid_subg_vent
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           AND  ( pr.oid_peri >= zs.perd_oid_peri_inic or zs.perd_oid_peri_inic is null )
           AND ( pr.oid_peri <= zs.perd_oid_peri_fina or zs.perd_oid_peri_fina is null )
           AND zz.pais_oid_pais = zr.pais_oid_pais
           AND zz.marc_oid_marc = zr.marc_oid_marc
           AND zz.cana_oid_cana = zr.cana_oid_cana
           AND zr.pais_oid_pais = sgv.pais_oid_pais
           AND zr.marc_oid_marc = sgv.marc_oid_marc
           AND zr.cana_oid_cana = sgv.cana_oid_cana) datat
where codigoConsultoraLider is not null;


   TYPE interfazRec IS RECORD
	   (
        codigoConsultoraLider   mae_clien.cod_clie%TYPE,
        nombreLider                VARCHAR2(55),
        direccionLider            VARCHAR2(80),
        telefono                VARCHAR2(15),
        campanaEsLider   		VARCHAR2(6)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);

    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoConsultoraLider    ||';'||
						  		  	  interfazRecord(x).nombreLider            	 ||';'||
									  interfazRecord(x).direccionLider           ||';'||
									  interfazRecord(x).telefono            	 ||';'||
									  interfazRecord(x).campanaEsLider ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_INFOR_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_INFOR_LIDER;

/*************************************************************************
Descripcion       : Genera Interfaz de Envio Matriz de Periodo (DAT-11)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoPeriodo  : Codigo Periodo
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MATRI_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdPeriodo NUMBER) IS

   		    SELECT sc.cod_cana codigoCanal,
            	   spc.cod_peri codigoCampana,
            	   mp.cod_sap codigoProducto,
            	   pto.cod_tipo_ofer codigoTipoOferta,
            	   pod.val_codi_vent codigoVenta,
           (SELECT gen.val_i18n
                      FROM gen_i18n_sicc_comun gen, seg_idiom idio
                     WHERE gen.attr_enti = 'PRE_TIPO_OFERT'
                       AND gen.idio_oid_idio = idio.oid_idio
                       AND gen.val_oid = pto.oid_tipo_ofer
               AND idio.cod_iso_idio = psCodigoIso) descripcionTipoOferta,
            	   pod.precio_unitario precioOferta,
            	   pto.ind_esta flagEstadisticable,
            	   DECODE(ventaex.aux, NULL, '0', '1') flagPerteneceSessionExpert,
				   1 flagTipoAccion,
				   pod.imp_prec_publ precioVenta,
           pod.imp_prec_posi precioVentaNormal,
           pod.val_fact_repe FactorRepeticion,
           ocat.cod_cata CodCatalogo,
           ocat.des_cata DesCatalogo,
           pod.num_pagi_cata NroPagina,
            nvl(gofe.cod_fact_cuad,
           (SELECT MIN(w.val_fact_cuad) FROM pre_promo w WHERE w.ofer_oid_ofer = ofer.oid_ofer))  FactorCuadre,
           coes.cod_estr CodEstrategia,
           ofer.num_ofer NumOferta,
           nvl((SELECT z.val_i18n
               FROM gen_i18n_sicc_comun z
            WHERE z.attr_enti = 'PRE_INDIC_CUADR'
              AND z.val_oid = cues.indc_oid_indi_cuad),
           (SELECT MIN(z.val_i18n)
              FROM gen_i18n_sicc_comun   z,
                   pre_promo             w,
                   pre_indic_cuadr_promo v
             WHERE z.attr_enti = 'PRE_INDIC_CUADR_PROMO'
               AND w.ofer_oid_ofer = ofer.oid_ofer
               AND w.icpr_oid_indi_cuad_prom = v.oid_indi_cuad_prom
               AND z.val_oid = v.oid_indi_cuad_prom))  IndCuadre
              FROM cra_perio cp,
              	   seg_perio_corpo spc,
              	   seg_canal sc,
              	   pre_matri_factu_cabec pmc,
            	   pre_matri_factu pmf,
            	   pre_ofert_detal pod,
           pre_ofert ofer,
           pre_estra coes,
           pre_catal ocat,
            	   mae_produ mp,
            	   pre_tipo_ofert pto,
           pre_grupo_ofert gofe,
           pre_indic_cuadr_tipo_estra cues,
           pre_indic_cuadr indc,
           (SELECT vex.ofer_oid_ofer, COUNT(*) aux
              FROM pre_venta_exclu vex, pre_venta_exclu_tipo_clasi vextc
                     WHERE vextc.pais_oid_pais = vnIdPais
                       AND vex.ticl_oid_tipo_clie = vextc.ticl_oid_tipo_clie
                       AND vex.sbti_oid_subt_clie = vextc.sbti_oid_subt_clie
                       AND vex.tccl_oid_tipo_clas = vextc.tccl_oid_tipo_clas
                       AND vex.clas_oid_clas = vextc.clas_oid_clas
             GROUP BY ofer_oid_ofer) ventaex
             WHERE cp.oid_peri = vnIdPeriodo
               AND cp.peri_oid_peri = spc.oid_peri
               AND cp.cana_oid_cana = sc.oid_cana
               AND pmc.perd_oid_peri = cp.oid_peri
               AND pmf.mfca_oid_cabe = pmc.oid_cabe
               AND pmf.ofde_oid_deta_ofer = pod.oid_deta_ofer
               AND pod.prod_oid_prod = mp.oid_prod
               AND pod.tofe_oid_tipo_ofer = pto.oid_tipo_ofer
       AND pod.ofer_oid_ofer = ventaex.ofer_oid_ofer(+)
       AND pod.ofer_oid_ofer = ofer.oid_ofer
       AND ofer.ocat_oid_cata = ocat.oid_cata(+)
       AND ofer.coes_oid_estr = coes.oid_estr(+)
       AND pod.gofe_oid_grup_ofer = gofe.oid_grup_ofer(+)
       AND gofe.cues_oid_ind_cuad_tipo_estr = cues.oid_ind_cuad_tipo_estr(+)
       AND cues.indc_oid_indi_cuad = indc.oid_ind_cuad(+)
         ;

   TYPE interfazRec IS RECORD
	   (
    	   codigoCanal	   	 	  	   seg_canal.cod_cana%TYPE,
 	   	   codigoCampana			   VARCHAR2(6),
 	   	   codigoProducto         	   mae_produ.cod_sap%TYPE,
    	   codigoTipoOferta			   pre_tipo_ofert.cod_tipo_ofer%TYPE,
    	   codigoVenta				   pre_ofert_detal.val_codi_vent%TYPE,
           descripcionTipoOferta       VARCHAR2(100),
    	   precioOferta				   pre_ofert_detal.precio_unitario%TYPE,
    	   flagEstadisticable		   VARCHAR2(1),
    	   flagPerteneceSessionExpert  VARCHAR2(1),
 	   	   flagTipoAccion			   NUMBER(1),
		   precioVenta				   pre_ofert_detal.imp_prec_publ%TYPE,
          precioVentaNormal	pre_ofert_detal.imp_prec_posi%TYPE,
          FactorRepeticion pre_ofert_detal.val_fact_repe%TYPE,
          CodCatalogo pre_catal.cod_cata%TYPE,
          DesCatalogo pre_catal.des_cata%TYPE,
          NroPagina pre_ofert_detal.num_pagi_cata%TYPE,
          FactorCuadre NUMBER(7),
          CodEstrategia pre_estra.cod_estr%TYPE,
          NumOferta pre_ofert.num_ofer%TYPE,
          IndCuadre VARCHAR2(40)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdPeriodo 		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdPeriodo);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCanal
                                  ||';'|| interfazRecord(x).codigoCampana
                                  ||';'|| interfazRecord(x).codigoProducto
                                  ||';'|| interfazRecord(x).codigoTipoOferta
                                  ||';'|| interfazRecord(x).codigoVenta
                                  ||';'|| interfazRecord(x).descripcionTipoOferta
                                  ||';'|| interfazRecord(x).precioOferta
                                  ||';'|| interfazRecord(x).flagEstadisticable
                                  ||';'|| interfazRecord(x).flagPerteneceSessionExpert
                                  ||';'|| interfazRecord(x).flagTipoAccion
                                  ||';'|| interfazRecord(x).precioVenta
                                  ||';'|| interfazRecord(x).precioVentaNormal
                                  ||';'|| interfazRecord(x).FactorRepeticion
                                  ||';'|| LPAD(interfazRecord(x).CodCatalogo,2,'0')
                                  ||';'|| interfazRecord(x).DesCatalogo
                                  ||';'|| interfazRecord(x).NroPagina
                                  ||';'|| interfazRecord(x).FactorCuadre
                                  ||';'|| interfazRecord(x).CodEstrategia
                                  ||';'|| interfazRecord(x).NumOferta
                                  ||';'|| interfazRecord(x).IndCuadre
                                  ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MATRI_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MATRI_CAMPA;

/*********************************************************************
Descripcion       : Genera Interfaz de Envio de Secciones (DAT-14)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SECCI
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2,
   psCodigoPeriodo    VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, vnOidPeriodo NUMBER) IS

	    SELECT sgv.cod_subg_vent codigoSubgerencia,
        	   zr.cod_regi codigoRegion,
        	   zs.cod_secc codigoSeccion,
               zz.cod_zona codigoZona,
            SUBSTR(sgv.des_subg_vent,1,15) nombreSubgerencia,
            SUBSTR(zr.des_regi,1,15) nombreRegion,
            SUBSTR(zz.des_zona,1,15) nombreZona,
            CASE WHEN
             (
              SELECT  nvl(ind_prog_lide,0) FROM bas_pais WHERE cod_pais = psCodigoPais  ) >= 1 THEN
                 (
                  SELECT zh.gere
                    FROM (select * from zon_histo_geren order by perd_oid_peri_hast desc) zh,
                         cra_perio pr, seg_perio_corpo pc
                   WHERE sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
                     AND pr.peri_oid_peri = pc.oid_peri
                     AND pc.cod_peri =  pscodigoPeriodo
                     AND pr.oid_peri >= zh.perd_oid_peri_desd
                     AND ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
                     AND rownum<=1
                 )
            ELSE
                (
                 SELECT mc.cod_clie
                   FROM mae_clien mc
                  WHERE mc.oid_clie = zs.clie_oid_clie
                )
            END codigoLider,
            CASE WHEN
              ( SELECT nvl(ind_prog_lide,0) FROM bas_pais WHERE cod_pais = psCodigoPais  ) >= 1 THEN
                (
                 SELECT SUBSTR(mc.val_nom1,1,15) || ' ' ||  SUBSTR(mc.val_nom2,1,10) || ' ' ||  SUBSTR(mc.val_ape1,1,15) || ' ' ||  SUBSTR(mc.val_ape2,1,10)
                   FROM (select * from zon_histo_geren order by perd_oid_peri_hast desc) zh, mae_clien mc,  cra_perio pr, seg_perio_corpo pc
                  WHERE sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
                    AND pr.peri_oid_peri = pc.oid_peri
                    AND pc.cod_peri =  pscodigoPeriodo
                    AND ( pr.oid_peri >= zh.perd_oid_peri_desd or  zh.perd_oid_peri_desd is null )
                    AND ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
                    AND mc.cod_clie = gere
                    AND rownum<=1)
            ELSE
                (
                 SELECT SUBSTR(mc.val_nom1,1,15) || ' ' ||  SUBSTR(mc.val_nom2,1,10) || ' ' ||  SUBSTR(mc.val_ape1,1,15) || ' ' ||  SUBSTR(mc.val_ape2,1,10)
                   FROM mae_clien mc
                  WHERE zs.clie_oid_clie = mc.oid_clie
                )
            END NombLid,
               GEN_FN_DEVUE_FLAG_LIDER(zz.pais_oid_pais, zz.marc_oid_marc, zr.cana_oid_cana, zz.oid_zona, zs.oid_secc, vnOidPeriodo) flagLider
          FROM zon_regio zr,
          	   zon_sub_geren_venta sgv,
          	   zon_zona zz,
               zon_secci zs,
               cra_perio pr,
               seg_perio_corpo pc
         WHERE zs.zzon_oid_zona = zz.oid_zona
           AND zz.zorg_oid_regi = zr.oid_regi
           AND zr.zsgv_oid_subg_vent = sgv.oid_subg_vent
           and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  pscodigoPeriodo
           AND  ( pr.oid_peri >= zs.perd_oid_peri_inic or zs.perd_oid_peri_inic is null )
           AND ( pr.oid_peri <= zs.perd_oid_peri_fina or zs.perd_oid_peri_fina is null )
           AND  ( pr.oid_peri >= zz.perd_oid_peri_inic or zz.perd_oid_peri_inic is null )
           AND ( pr.oid_peri <= zz.perd_oid_peri_fina or zz.perd_oid_peri_fina is null )
           AND zz.pais_oid_pais = zr.pais_oid_pais
           AND zz.marc_oid_marc = zr.marc_oid_marc
           AND zz.cana_oid_cana = zr.cana_oid_cana
           AND zr.pais_oid_pais = sgv.pais_oid_pais
           AND zr.marc_oid_marc = sgv.marc_oid_marc
           AND zr.cana_oid_cana = sgv.cana_oid_cana
           AND sgv.pais_oid_pais = vnIdPais
           AND sgv.marc_oid_marc = vnIdMarca
           AND sgv.cana_oid_cana = vnIdCanal
           AND zr.ind_acti = 1 ;   -- Ajuste

   TYPE interfazRec IS RECORD
	   (
        codigoSubgerencia       zon_sub_geren_venta.cod_subg_vent%TYPE,
        codigoRegion			zon_regio.cod_regi%TYPE,
        codigoSeccion			zon_secci.cod_secc%TYPE,
        codigoZona				zon_zona.cod_zona%TYPE,
        nombreSubgerencia   	zon_sub_geren_venta.des_subg_vent%TYPE,
        nombreRegion			zon_regio.des_regi%TYPE,
        nombreZona				zon_zona.des_zona%TYPE,
        codigoLider				mae_clien.cod_clie%TYPE,
        NombLid           VARCHAR2(55),
        flagLider    			VARCHAR2(1)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;
   lnOidPeriodo      NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
    lnOidPeriodo   := gen_pkg_gener.GEN_FN_DEVUELVE_ID_CRA_PERIO2(psCodigoPeriodo);


    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal,lnOidPeriodo);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoSubgerencia            ||';'||
						  		  	  interfazRecord(x).codigoRegion            	 ||';'||
									  interfazRecord(x).codigoSeccion            	 ||';'||
									  interfazRecord(x).codigoZona            	 	 ||';'||
									  interfazRecord(x).nombreSubgerencia            ||';'||
									  interfazRecord(x).nombreRegion				 ||';'||
									  interfazRecord(x).nombreZona   				 ||';'||
									  interfazRecord(x).codigoLider					 ||';'||
									  interfazRecord(x).NombLid  ||';'||
		                              interfazRecord(x).flagLider;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_SECCI: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_SECCI;


/***************************************************************************************
Descripcion       : Genera Interfaz de Envio Homologacion Status de Clientes (DAT-15)
Fecha Creacion    : 16/03/2011
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
****************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_HOMES_CLIEN
  (psCodigoPais 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER) IS

   		 SELECT TO_NUMBER(mec.cod_esta_clie) codigoEstatus,
                (
        		 SELECT gen.val_i18n
                   FROM gen_i18n_sicc_comun gen, seg_idiom idio
                  WHERE gen.attr_enti = 'MAE_ESTAT_CLIEN'
                    AND gen.idio_oid_idio = idio.oid_idio
                    AND gen.val_oid = mec.oid_esta_clie
         		    AND idio.cod_iso_idio = psCodigoIso
        		) descripcionEstatus,
        		'' codigoCorporativo,
        		'' nombreStatusCorporativo
           FROM mae_estat_clien mec
          ORDER BY cod_esta_clie ;


   TYPE interfazRec IS RECORD
	   (
    	   codigoEstatus	   	 	  	   NUMBER(1),
 	   	   descripcionEstatus			   VARCHAR2(30),
 	   	   codigoCorporativo         	   VARCHAR2(1),
    	   nombreStatusCorporativo		   VARCHAR2(15)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);

    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoEstatus	   	   		   ||';'||
						  		  	  interfazRecord(x).descripcionEstatus			   ||';'||
						  		  	  interfazRecord(x).codigoCorporativo			   ||';'||
									  interfazRecord(x).nombreStatusCorporativo;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_HOMES_CLIEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_HOMES_CLIEN;

/********************************************************************
Descripcion       : Genera Interfaz de Envio de Periodos (DAT-16)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psNombreArchivo  : Nombre Arcchivo
 psCodigoInterfaz : Codigo de Interfaz
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

		SELECT pc.cod_peri codigoCampana,
        	   psCodigoCanal as codigoCanal,
        	   CASE
        	      WHEN rng.cod_rape = '01' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'I'
        		  WHEN rng.cod_rape = '02' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'II'
        		  WHEN rng.cod_rape = '03' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'III'
        	   END rangoPeriodo,
			   '' descripcionEstacion,
			   psCodigoPeriodo codigoCampanaActual
          FROM cra_perio p,
          	   seg_perio_corpo pc,
        	   cra_rango_perio rng
         WHERE pc.oid_peri = p.peri_oid_peri
           AND p.pais_oid_pais = vnIdPais
           AND p.marc_oid_marc = vnIdMarca
           AND p.cana_oid_cana = vnIdCanal
           AND pc.val_anio = SUBSTR(psCodigoPeriodo,1,4)
           AND ( SUBSTR(pc.cod_peri,5,2) >= rng.per_inic AND SUBSTR(pc.cod_peri,5,2) <= rng.per_fina )
         ORDER BY pc.cod_peri ASC ;

   TYPE interfazRec IS RECORD
	   (
    	   codigoCampana	   	 	VARCHAR2(6),
		   codigoCanal				VARCHAR2(2),
		   rangoPeriodo         	VARCHAR2(8),
		   descripcionEstacion		VARCHAR2(10),
    	   codigoCampanaActual   	VARCHAR2(6)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCampana            	||';'||
						  		  	  interfazRecord(x).codigoCanal                 ||';'||
						  		  	  interfazRecord(x).rangoPeriodo            	||';'||
						  		  	  interfazRecord(x).descripcionEstacion         ||';'||
									  interfazRecord(x).codigoCampanaActual ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CAMPA;

/**********************************************************************
Descripcion       : Genera Interfaz de Envio Tipos de Oferta (DAT-17)
Parametros:
 psCodigoPais     : Codigo de Pais
  psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
***********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPOS_OFERT
  (psCodigoPais 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdCanal NUMBER) IS

		SELECT sc.cod_cana codigoCanal,
        	   pto.cod_tipo_ofer codigoTipoOferta,
        	   (
        	    SELECT gen.val_i18n
                  FROM gen_i18n_sicc_comun gen, seg_idiom idio
                 WHERE gen.attr_enti = 'PRE_TIPO_OFERT'
                   AND gen.idio_oid_idio = idio.oid_idio
                   AND gen.val_oid = pto.oid_tipo_ofer
         	       AND idio.cod_iso_idio = psCodigoIso
        	   ) descripcionTipoOferta,
        	   pto.val_form_vent codigoTipoProfit,
        	   '' descripcionTipoProfit
          FROM pre_tipo_ofert pto,
          	   seg_canal sc
         WHERE pto.cana_oid_cana = sc.oid_cana
           AND pto.cana_oid_cana= vnIdCanal ;

   TYPE interfazRec IS RECORD
	   (
    	   codigoCanal	   	 	  		seg_canal.cod_cana%TYPE,
		   codigoTipoOferta				pre_tipo_ofert.cod_tipo_ofer%TYPE,
		   descripcionTipoOferta        VARCHAR2(100),
		   codigoTipoProfit				pre_tipo_ofert.val_form_vent%TYPE,
    	   descripcionTipoProfit   		VARCHAR2(20)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);

    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCanal            		   ||';'||
						  		  	  interfazRecord(x).codigoTipoOferta               ||';'||
						  		  	  interfazRecord(x).descripcionTipoOferta          ||';'||
						  		  	  interfazRecord(x).codigoTipoProfit         	   ||';'||
									  interfazRecord(x).descripcionTipoProfit ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPOS_OFERT: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TIPOS_OFERT;

/*******************************************************************
Descripcion       : Genera Interfaz de Envio de Zonas (DAT-18)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
********************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ZONAS
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

        SELECT zon.cod_zona codigoZona,
        	   cli.cod_clie codigoGerenteZona,
        	   cli.val_nom1 nombre1GerenteZona,
        	   cli.val_nom2 nombre2GerenteZona,
        	   cli.val_ape1 apellido1GerenteZona,
        	   cli.val_ape2 apellido2GerenteZona,
        	   reg.cod_regi codigoRegion,
        	   '' capitalRestoPaises,
        	   '' nombreEmpresa,
        	   '' campanaCreacionZona,
        	   DECODE( zon.ind_acti, 1, '1', '0' ) indicadorActiva,
        	   cli2.cod_clie codigoGerenteRegional,
        	   cli2.val_nom1 nombre1GerenteRegional,
        	   cli2.val_nom2 nombre2GerenteRegional,
        	   cli2.val_ape1 apellido1GerenteRegional,
        	   cli2.val_ape2 apellido2GerenteRegional,
        	   reg.des_regi nombreRegion,
        	   pai.cod_pais codigoPais,
        	   (
           	    SELECT gen.val_i18n
                  FROM gen_i18n_sicc_comun gen, seg_idiom idio
                 WHERE gen.attr_enti = 'SEG_PAIS'
                   AND gen.idio_oid_idio = idio.oid_idio
                   AND gen.val_oid = pai.oid_pais
         	       AND idio.cod_iso_idio = psCodigoIso
           	   ) nombrePais,
        	   estz.cod_esta_zona estatusZona,
        	   0 flagTipoAccion,
        	   subg.cod_subg_vent codigoSubgerencia,
        	   subg.des_subg_vent nombreSubgerencia,
        	   zon.des_zona nombreZona
          FROM zon_zona zon,
          	   zon_regio reg,
        	   zon_estad_zona estz,
        	   mae_clien cli,
        	   mae_clien cli2,
        	   seg_pais pai,
        	   zon_sub_geren_venta subg
         WHERE zon.clie_oid_clie = cli.oid_clie(+)
           AND zon.zorg_oid_regi = reg.oid_regi
           AND reg.clie_oid_clie = cli2.oid_clie(+)
           AND zon.pais_oid_pais = pai.oid_pais
           AND zon.eszo_oid_esta_zona = estz.oid_esta_zona (+)
           AND reg.zsgv_oid_subg_vent = subg.oid_subg_vent
           AND zon.pais_oid_pais = vnIdPais
           AND zon.marc_oid_marc = vnIdMarca
           AND zon.cana_oid_cana = vnIdCanal
           AND reg.ind_acti = 1
           AND reg.ind_borr = 0 ;


   TYPE interfazRec IS RECORD
	   (
    	   codigoZona	   	 	   	   	zon_zona.cod_zona%TYPE,
		   codigoGerenteZona			mae_clien.cod_clie%TYPE,
		   nombre1GerenteZona			mae_clien.val_nom1%TYPE,
    	   nombre2GerenteZona   		mae_clien.val_nom2%TYPE,
    	   apellido1GerenteZona			mae_clien.val_ape1%TYPE,
    	   apellido2GerenteZona			mae_clien.val_ape2%TYPE,
    	   codigoRegion					zon_regio.cod_regi%TYPE,
    	   capitalRestoPaises			VARCHAR2(17),
    	   nombreEmpresa				VARCHAR2(17),
		   campanaCreacionZona			VARCHAR2(10),
		   indicadorActiva				VARCHAR2(1),
    	   codigoGerenteRegional		mae_clien.cod_clie%TYPE,
    	   nombre1GerenteRegional		mae_clien.val_nom1%TYPE,
		   nombre2GerenteRegional		mae_clien.val_nom2%TYPE,
    	   apellido1GerenteRegional		mae_clien.val_ape1%TYPE,
    	   apellido2GerenteRegional		mae_clien.val_ape2%TYPE,
		   nombreRegion			   		zon_regio.des_regi%TYPE,
		   codigoPais					seg_pais.cod_pais%TYPE,
		   nombrePais					VARCHAR2(50),
		   estatusZona					zon_estad_zona.cod_esta_zona%TYPE,
		   flagTipoAccion				NUMBER(1),
           codigoSubgerenciaVentas  	zon_sub_geren_venta.cod_subg_vent%TYPE,
           nombreSubgerenciaVentas		zon_sub_geren_venta.des_subg_vent%TYPE,
		   nombreZona					zon_zona.des_zona%TYPE
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoZona            		   ||';'||
						  		  	  interfazRecord(x).codigoGerenteZona       	   ||';'||
						  		  	  interfazRecord(x).nombre1GerenteZona ||' '|| interfazRecord(x).nombre2GerenteZona ||' '|| interfazRecord(x).apellido1GerenteZona ||' '|| interfazRecord(x).apellido2GerenteZona ||';'||
						  		  	  interfazRecord(x).codigoRegion            	   ||';'||
									  interfazRecord(x).capitalRestoPaises			   ||';'||
									  interfazRecord(x).nombreEmpresa  				   ||';'||
									  interfazRecord(x).campanaCreacionZona		 	   ||';'||
									  interfazRecord(x).indicadorActiva		 		   ||';'||
									  interfazRecord(x).codigoGerenteRegional		   ||';'||
									  interfazRecord(x).nombre1GerenteRegional ||' '|| interfazRecord(x).nombre2GerenteRegional ||' '|| interfazRecord(x).apellido1GerenteRegional ||' '|| interfazRecord(x).apellido2GerenteRegional ||';'||
									  interfazRecord(x).nombreRegion		 		   ||';'||
									  interfazRecord(x).codigoPais		 			   ||';'||
									  SUBSTR(interfazRecord(x).nombrePais,1,15) ||';'||
									  interfazRecord(x).estatusZona		 			   ||';'||
									  interfazRecord(x).flagTipoAccion		 		   ||';'||
									  interfazRecord(x).codigoSubgerenciaVentas		   ||';'||
									  interfazRecord(x).nombreSubgerenciaVentas		   ||';'||
									  interfazRecord(x).nombreZona ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ZONAS: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ZONAS;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Estatus Zonas (DAT-27)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAT_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER) IS

   	    SELECT est.cod_esta_zona codigoEstatusZona,
        	   (
        	    SELECT gen.val_i18n
                  FROM gen_i18n_sicc_pais gen, seg_idiom idio
                 WHERE gen.attr_enti = 'ZON_ESTAD_ZONA'
                   AND gen.idio_oid_idio = idio.oid_idio
                   AND gen.val_oid = est.oid_esta_zona
        		   AND idio.cod_iso_idio = psCodigoIso
        	   ) descripcionEstatusZona
          FROM zon_estad_zona est
         WHERE pais_oid_pais = vnIdPais;

   TYPE interfazRec IS RECORD
	   (
    	   codigoEstatusZona   				zon_estad_zona.cod_esta_zona%TYPE,
 	   	   descripcionEstatusZona			VARCHAR2(20)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);

    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoEstatusZona  		   ||';'||
									  interfazRecord(x).descripcionEstatusZona;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ESTAT_ZONA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ESTAT_ZONA;


/********************************************************************************
Descripcion       : Genera Interfaz de Envio Zonas Reales por Region (DAT-34)
Parametros:
 psCodigoPais     : Codigo de Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ZONAS_REREG
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

        SELECT psCodigoCanal codigoCanal,
        	   psCodigoPeriodo codigoCampania,
        	   zr.cod_regi codigoRegion,
        	   0 numeroEstimadoZonas,
        	   COUNT(*) numeroRealZonas
          FROM zon_regio zr,
          	   zon_zona zz
         WHERE zr.oid_regi = zz.zorg_oid_regi
           AND zr.ind_borr = 0
           AND zz.ind_borr = 0
           AND zz.ind_acti = 1
           AND zr.pais_oid_pais = vnIdPais
           AND zr.marc_oid_marc = vnIdMarca
           AND zr.cana_oid_cana = vnIdCanal
         GROUP BY zr.cod_regi ;


   TYPE interfazRec IS RECORD
	   (
        codigoCanal       	  VARCHAR2(3),
        codigoCampania		  VARCHAR2(6),
        codigoRegion		  zon_regio.cod_regi%TYPE,
        numeroEstimadoZonas	  NUMBER(3),
        numeroRealZonas		  NUMBER(3)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   W_FILAS             NUMBER := 1000 ;
   v_handle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdMarca  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);


    lbAbrirUtlFile := TRUE;

    /* Generando Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCanal            ||';'||
						  		  	  interfazRecord(x).codigoCampania         ||';'||
									  interfazRecord(x).codigoRegion           ||';'||
									  interfazRecord(x).numeroEstimadoZonas    ||';'||
		                              interfazRecord(x).numeroRealZonas;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    --utl_file.fclose(V_HANDLE);

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ZONAS_REREG: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ZONAS_REREG;

/*********************************************************************************
Descripcion       : Genera Interfaz de Envio Informacion Gerentes Zona (DAT-8)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
**********************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_GEREN_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER) IS

            SELECT DISTINCT
              	   cli.cod_clie codigoGerenteZona,
              	   cli.val_nom1 || ' ' || cli.val_nom2 || ' ' || cli.val_ape1 || ' ' || cli.val_ape2 nombreGerenteZona,
            	   cli.cod_clie codigoConsultoraGerenteZona,
            	   ' ' codigoZonaGerente,
            	   (
            	    SELECT nivel.des_geog
                      FROM zon_valor_estru_geopo nivel
                     WHERE nivel.orde_1 = geo.orde_1
                       AND nivel.orde_2 IS NULL
                       AND nivel.pais_oid_pais = geo.pais_oid_pais
                       AND ROWNUM = 1
            	   ) nombreDepartamento,
                   CASE WHEN (geo.orde_2 IS NULL) THEN NULL
                     ELSE (
            		       SELECT nivel.des_geog
                             FROM zon_valor_estru_geopo nivel
                            WHERE nivel.orde_1 = geo.orde_1
                              AND nivel.orde_2 = geo.orde_2
                              AND nivel.orde_3 IS NULL
                              AND nivel.pais_oid_pais = geo.pais_oid_pais
                              AND ROWNUM = 1
            			  )
                   END nombreProvincia,
                   CASE WHEN (geo.orde_3 IS NULL) THEN NULL
                     ELSE (
              	           SELECT nivel.des_geog
                             FROM zon_valor_estru_geopo nivel
                            WHERE nivel.orde_1 = geo.orde_1
                              AND nivel.orde_2 = geo.orde_2
                              AND nivel.orde_3 = geo.orde_3
                              AND nivel.orde_4 IS NULL
                              AND nivel.pais_oid_pais = geo.pais_oid_pais
                              AND ROWNUM = 1
              			  )
                   END nombreDistrito,
            	   tvia.des_abrv_tipo_via || ' ' || dir.val_nomb_via || ' ' || dir.num_ppal direccionGerente,
                   CASE WHEN (geo.orde_4 IS NULL) THEN NULL
                     ELSE (
              	           SELECT gen.val_i18n
                             FROM gen_i18n_sicc_comun gen,
							 	  seg_idiom idio
                            WHERE gen.attr_enti = 'ZON_SUBES_GEOPO'
                              AND gen.idio_oid_idio = idio.oid_idio
                              AND idio.cod_iso_idio = psCodigoIso
              				  AND gen.val_oid = (
              				                     SELECT nivel.sgeo_oid_sube_geop
                                                   FROM zon_valor_estru_geopo nivel
                                                  WHERE nivel.orde_1 = geo.orde_1
                                                    AND nivel.orde_2 = geo.orde_2
                                                    AND nivel.orde_3 = geo.orde_3
                                                    AND nivel.orde_4 = geo.orde_4
                                                    AND nivel.orde_5 IS NULL
                                                    AND nivel.pais_oid_pais = geo.pais_oid_pais
                                                    AND ROWNUM = 1
              								    )
              			  )
                   END descripcionTipoCentroPoblado,
                   CASE WHEN (geo.orde_4 IS NULL) THEN NULL
                     ELSE (
            	           SELECT nivel.des_geog
                             FROM zon_valor_estru_geopo nivel
                             WHERE nivel.orde_1 = geo.orde_1
                             AND nivel.orde_2 = geo.orde_2
                             AND nivel.orde_3 = geo.orde_3
                             AND nivel.orde_4 = geo.orde_4
                             AND nivel.orde_5 IS NULL
                             AND nivel.pais_oid_pais = geo.pais_oid_pais
                             AND ROWNUM = 1
            		      )
                   END descripcionCentroPoblado,
                   (
            	    SELECT zsg.cod_sube
                      FROM zon_subes_geopo zsg
                     WHERE zsg.oid_sube_geop = (
            	                                SELECT nivel.sgeo_oid_sube_geop
                                                  FROM zon_valor_estru_geopo nivel
                                                 WHERE nivel.orde_1 = geo.orde_1
                                                   AND nivel.orde_2 = geo.orde_2
                                                   AND nivel.orde_3 = geo.orde_3
                                                   AND nivel.orde_4 = geo.orde_4
                                                   AND nivel.orde_5 IS NULL
                                                   AND nivel.pais_oid_pais = geo.pais_oid_pais
                                                   AND ROWNUM = 1
            								)
            	   ) codigoTipoCentroPoblado,
                   (
            	    SELECT nivel.orde_4
                      FROM zon_valor_estru_geopo nivel
                     WHERE nivel.orde_1 = geo.orde_1
                       AND nivel.orde_2 = geo.orde_2
                       AND nivel.orde_3 = geo.orde_3
                       AND nivel.orde_4 = geo.orde_4
                       AND nivel.orde_5 IS NULL
                       AND nivel.pais_oid_pais = geo.pais_oid_pais
                       AND ROWNUM = 1
            	   ) codigoCentroPoblado,
                   geo.orde_1 || geo.orde_2 || geo.orde_3 || geo.orde_4 ||
            	   geo.orde_5 || geo.orde_6 || geo.orde_7 || geo.orde_8 ||
            	   geo.orde_9 codigoUbigeo,
                   (
                    SELECT c.val_text_comu
                      FROM mae_clien_comun c, mae_tipo_comun tc
                     WHERE c.clie_oid_clie = cli.oid_clie
                       AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                    	AND cod_tipo_comu = 'TF'
            			AND ROWNUM = 1
                   ) telefonoDomicilio,
                   (
                    SELECT c.val_text_comu
                      FROM mae_clien_comun c,
            		  	   mae_tipo_comun tc
                     WHERE c.clie_oid_clie = cli.oid_clie
                       AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                       AND cod_tipo_comu = 'FX'
            		   AND ROWNUM = 1
                   ) faxDomicilio,
                   (
                    SELECT c.val_text_comu
                      FROM mae_clien_comun c,
            		  	   mae_tipo_comun tc
                     WHERE c.clie_oid_clie = cli.oid_clie
                       AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                       AND cod_tipo_comu = 'TM'
            		   AND ROWNUM = 1
                   ) telefonoCelular,
                   (
                    SELECT gen.val_i18n
                      FROM gen_i18n_sicc_comun gen,
            		  	   seg_idiom idio
                     WHERE gen.attr_enti = 'MAE_ESTAD_CIVIL'
                       AND gen.idio_oid_idio = idio.oid_idio
                       AND gen.val_oid = adi.escv_oid_esta_civi
                       AND idio.cod_iso_idio = psCodigoIso
            		   AND ROWNUM = 1
                   ) estadoCivil,
                   (
            	    SELECT tdo.cod_tipo_docu
                      FROM mae_clien_ident iden,
                           mae_tipo_docum tdo
                     WHERE iden.clie_oid_clie = cli.oid_clie
                       AND iden.val_iden_docu_prin = 1
                       AND tdo.oid_tipo_docu = iden.tdoc_oid_tipo_docu
                       AND ROWNUM = 1
            	   ) codigoTipoDocumentoIdentidad,
                   (
            	    SELECT iden.num_docu_iden
                      FROM mae_clien_ident iden
                     WHERE iden.clie_oid_clie = cli.oid_clie
                       AND iden.val_iden_docu_prin = 1
                       AND ROWNUM = 1
            	   ) numeroDocumentoIdentidad,
                   to_char(adi.fec_naci,'yyyyMMdd') fechaNacimiento,
                   (
                    SELECT c.val_text_comu
                      FROM mae_clien_comun c, mae_tipo_comun tc
                     WHERE c.clie_oid_clie = cli.oid_clie
                	   AND c.ticm_oid_tipo_comu = tc.oid_tipo_comu
                       AND cod_tipo_comu = 'ML'
                   ) email,
            	   (
            	    SELECT iden.num_docu_iden
               		  FROM mae_clien_ident iden, mae_tipo_docum tdo
               		 WHERE iden.clie_oid_clie = cli.oid_clie
               		   AND iden.tdoc_oid_tipo_docu = tdo.oid_tipo_docu
               		   AND tdo.cod_tipo_docu = '05'
                   ) numeroPasaporte,
                   '' fechaInicioContrato,
            	   '' fechaFinContrato,
            	   0 flagTipoAccion,
                 adi.cod_cub CUB
              FROM mae_clien cli,
                   mae_clien_unida_admin adm,
                   mae_clien_ident ide,
                   mae_clien_datos_adici adi,
                   mae_clien_direc dir,
                   zon_zona zon,
                   zon_terri_admin tad,
                   zon_valor_estru_geopo geo,
                   zon_terri ter,
                   seg_tipo_via tvia,
                   mae_clien_comun com
             WHERE zon.pais_oid_pais = vnIdPais
               AND zon.marc_oid_marc = vnIdMarca
               AND zon.cana_oid_cana = vnIdCanal
               AND zon.ind_borr = 0
               AND zon.ind_acti = 1
               AND adm.ind_acti = 1
               AND ter.ind_borr = 0
               AND zon.clie_oid_clie = cli.oid_clie
               AND cli.oid_clie = ide.clie_oid_clie
               AND adi.clie_oid_clie(+) = cli.oid_clie
               AND adm.clie_oid_clie(+) = cli.oid_clie
               AND adm.ztad_oid_terr_admi = tad.oid_terr_admi(+)
               AND tad.terr_oid_terr = ter.oid_terr(+)
               AND ter.vepo_oid_valo_estr_geop = geo.oid_valo_estr_geop
               AND tad.ind_borr = 0
               AND cli.oid_clie = com.clie_oid_clie(+)
               AND dir.clie_oid_clie = cli.oid_clie
               AND dir.ind_dire_ppal = 1
               AND dir.ind_elim = 0
               AND dir.tivi_oid_tipo_via = tvia.oid_tipo_via ;


   TYPE interfazRec IS RECORD
	   (
    	    codigoGerenteZona				mae_clien.cod_clie%TYPE,
			nombreGerenteZona				VARCHAR2(100),
			codigoConsultoraGerenteZona		mae_clien.cod_clie%TYPE,
			codigoZonaGerente				VARCHAR2(4),
			nombreDepartamento				zon_valor_estru_geopo.des_geog%TYPE,
			nombreProvincia					zon_valor_estru_geopo.des_geog%TYPE,
			nombreDistrito					zon_valor_estru_geopo.des_geog%TYPE,
			direccionGerente				VARCHAR2(80),
			descripcionTipoCentroPoblado	VARCHAR2(25),
			descripcionCentroPoblado		VARCHAR2(25),
			codigoTipoCentroPoblado			zon_subes_geopo.cod_sube%TYPE,
			codigoCentroPoblado				zon_valor_estru_geopo.orde_4%TYPE,
			codigoUbigeo					VARCHAR2(54),
			telefonoDomicilio				mae_clien_comun.val_text_comu%TYPE,
			faxDomicilio					mae_clien_comun.val_text_comu%TYPE,
			telefonoCelular					mae_clien_comun.val_text_comu%TYPE,
			estadoCivil						VARCHAR2(15),
			codigoTipoDocumentoIdentidad	mae_tipo_docum.cod_tipo_docu%TYPE,
			numeroDocumentoIdentidad		mae_clien_ident.num_docu_iden%TYPE,
			fechaNacimiento					VARCHAR2(8),
			email							mae_clien_comun.val_text_comu%TYPE,
			numeroPasaporte					mae_clien_ident.num_docu_iden%TYPE,
			fechaInicioContrato				VARCHAR2(8),
			fechaFinContrato				VARCHAR2(8),
			flagTipoAccion					NUMBER(1),
      codigoCUB               VARCHAR2(20)
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdMarca  		   NUMBER;
   lnIdCanal  		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais,lnIdMarca,lnIdCanal);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoGerenteZona					         ||';'||
                                      interfazRecord(x).nombreGerenteZona					     ||';'||
                                      interfazRecord(x).codigoConsultoraGerenteZona		 ||';'||
                                      interfazRecord(x).codigoZonaGerente					     ||';'||
                                      interfazRecord(x).nombreDepartamento					   ||';'||
                                      interfazRecord(x).nombreProvincia						     ||';'||
                                      interfazRecord(x).nombreDistrito						     ||';'||
                                      interfazRecord(x).direccionGerente					     ||';'||
                                      interfazRecord(x).descripcionTipoCentroPoblado	 ||';'||
                                      interfazRecord(x).descripcionCentroPoblado			 ||';'||
                                      interfazRecord(x).codigoTipoCentroPoblado				 ||';'||
                                      interfazRecord(x).codigoCentroPoblado					   ||';'||
                                      interfazRecord(x).codigoUbigeo						       ||';'||
                                      interfazRecord(x).telefonoDomicilio					     ||';'||
                                      interfazRecord(x).faxDomicilio						       ||';'||
                                      interfazRecord(x).telefonoCelular						     ||';'||
                                      interfazRecord(x).estadoCivil							       ||';'||
                                      interfazRecord(x).codigoTipoDocumentoIdentidad	 ||';'||
                                      interfazRecord(x).numeroDocumentoIdentidad			 ||';'||
                                      interfazRecord(x).fechaNacimiento						     ||';'||
                                      interfazRecord(x).email								           ||';'||
                                      interfazRecord(x).numeroPasaporte						     ||';'||
                                      interfazRecord(x).fechaInicioContrato					   ||';'||
                                      interfazRecord(x).fechaFinContrato					     ||';'||
                                      interfazRecord(x).flagTipoAccion                 ||';'||
                                      interfazRecord(x).codigoCUB;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_GEREN_ZONA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_GEREN_ZONA;


/******************************************************************************
Descripcion       : Genera Interfaz de Envio Numero Pedidos por Dia (DAT-22)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais       : Codigo Pais
 psCodigoMarca      : Codigo Marca
 psCodigoCanal      : Codigo Canal
 psCodigoAcceso V	: Codigo Acceso
 psCodigoPeriodo    : A?o Periodo
 psFechaFacturacion : Fecha Facturacion
 psCodigoSistema    : Codigo Empresa
 psCodigoInterfaz   : Codigo Interfaz
 psNombreArchivo    : Nombre Arcchivo
 psCodigoIso        : Codigo Iso
Autor:                  Sergio Buchelli
*******************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NUMER_PEDDI
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoAcceso 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psFechaFacturacion 	  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, vnIdAcceso NUMBER, vnIdPeriodo NUMBER) IS

   		 SELECT cana.cod_cana codigoCanal,
         		soci.cod_soci codigoEmpresa,
        		to_char(soc.fec_fact,'yyyyMMdd') fechaFacturacion,
                pericorp.cod_peri anioCampana,
                COUNT(soc.oid_soli_cabe) numeroOrdenesCompra,
                COUNT(DISTINCT(cli.oid_clie)) numeroPedidos
           FROM ped_solic_cabec soc,
                cra_perio peri,
                seg_socie soci,
                mae_clien cli,
                mae_clien_tipo_subti cts,
                seg_subac subac,
                ped_tipo_solic_pais tsp,
                ped_tipo_solic ts,
        		seg_canal cana,
        		seg_perio_corpo pericorp
          WHERE soc.pais_oid_pais = vnIdPais
            AND peri.marc_oid_marc = vnIdMarca
            AND peri.cana_oid_cana = vnIdCanal
            AND subac.acce_oid_acce = vnIdAcceso
            AND peri.oid_peri = vnIdPeriodo
            AND trunc(soc.fec_fact) = TO_DATE(psFechaFacturacion,'dd/MM/yyyy')
            AND soc.ind_ts_no_conso = 1
            AND soc.ind_oc = 1
            AND soc.ind_pedi_prue = 0
            AND ts.ind_devo = 0
            AND ts.ind_anul = 0
            AND cts.ticl_oid_tipo_clie = 2
        	AND soc.soci_oid_soci = soci.oid_soci
            AND soc.perd_oid_peri = peri.oid_peri
            AND soc.clie_oid_clie = cli.oid_clie
            AND cts.clie_oid_clie = cli.oid_clie
            AND soc.sbac_oid_sbac = subac.oid_sbac
            AND soc.tspa_oid_tipo_soli_pais = tsp.oid_tipo_soli_pais
            AND ts.oid_tipo_soli = tsp.tsol_oid_tipo_soli
        	AND peri.cana_oid_cana = cana.oid_cana
        	AND peri.peri_oid_peri = pericorp.oid_peri
          GROUP BY cana.cod_cana,
                soci.cod_soci,
        		soc.fec_fact,
                pericorp.cod_peri;


   TYPE interfazRec IS RECORD
	   (
    	 codigoCanal	 		  			  seg_canal.cod_cana%TYPE,
         codigoEmpresa						  seg_socie.cod_soci%TYPE,
         fechaFacturacion					  VARCHAR(8)			  ,
		 anioCampanaFacturacion				  VARCHAR2(6),
         numeroOrdenesCompra				  NUMBER(12),
         numeroPedidos						  NUMBER(12)
		-- tipoCambio							  seg_tipo_cambi.val_tipo_camb%TYPE
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  -- W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdMarca  		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdAcceso  		   NUMBER;
   lnIdPeriodo 		   NUMBER;
   lnExisteTC		   NUMBER;
   lnTipoCambio		   NUMBER(12,4);

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);

    SELECT oid_acce INTO lnIdAcceso
      FROM seg_acces
     WHERE cod_acce = psCodigoAcceso
       AND cana_oid_cana =lnIdCanal;

	SELECT COUNT(1) INTO lnExisteTC
	  FROM (
	        SELECT tipocambio
	          FROM (
	                 SELECT tipocambio.val_tipo_camb tipocambio
	                   FROM seg_pais pais,
	                        seg_tipo_cambi tipocambio
	                  WHERE tipocambio.mone_oid_mon1 = pais.mone_oid_mone_alt
	                    AND tipocambio.mone_oid_mon2 = pais.mone_oid_mone
	                    AND TRUNC(tipocambio.fec_desd) <= TO_DATE (psFechaFacturacion, 'dd/MM/yyyy')
	                    AND pais.oid_pais = lnIdPais
	                  ORDER BY fec_desd DESC
	               )
	         WHERE ROWNUM = 1
	       );

    IF lnExisteTC = 1 THEN
	        SELECT tipocambio INTO lnTipoCambio
	          FROM (
                    SELECT tipocambio.val_tipo_camb tipocambio
                      FROM seg_pais pais,
                           seg_tipo_cambi tipocambio
                     WHERE tipocambio.mone_oid_mon1 = pais.mone_oid_mone_alt
                       AND tipocambio.mone_oid_mon2 = pais.mone_oid_mone
                       AND TRUNC(tipocambio.fec_desd) <= TO_DATE (psFechaFacturacion, 'dd/MM/yyyy')
                       AND pais.oid_pais = lnIdPais
                     ORDER BY fec_desd DESC
	               )
	         WHERE ROWNUM = 1;
    ELSE
       lnTipoCambio := 0;
    END IF;

    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais, lnIdMarca, lnIdCanal, lnIdAcceso, lnIdPeriodo);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  --interfazRecord(x).tipoCambio := lnTipoCambio;
		                  lsLinea :=  interfazRecord(x).codigoCanal                  ||';'||
                                      interfazRecord(x).codigoEmpresa                ||';'||
                                      interfazRecord(x).fechaFacturacion             ||';'||
                                      interfazRecord(x).anioCampanaFacturacion       ||';'||
                                      interfazRecord(x).numeroOrdenesCompra          ||';'||
                                      interfazRecord(x).numeroPedidos                ||';'||
                                      lnTipoCambio ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NUMER_PEDDI: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_NUMER_PEDDI;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Transacciones por Zona(DAT-26)
Fecha Creacion    : 13/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoMarca    : Codigo Marca
 psCodigoCanal    : Codigo Canal
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo
 psCodigoIso      : Codigo Iso
Autor: Sergio Buchelli
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRANS_ZONA
  (psCodigoPais 		  VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoPeriodo 		  VARCHAR2,
   psCodigoSistema 		  VARCHAR2,
   psCodigoInterfaz 	  VARCHAR2,
   psNombreArchivo 		  VARCHAR2,
   psCodigoIso   		  VARCHAR2)
IS
   CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, vnIdPeriodo NUMBER) IS

      SELECT cana.cod_cana codigoCanalVenta,
       		 percop.cod_peri anioCampanaFacturacion,
     		 zon.cod_zona codigoZona,
     		 (
     		  SELECT NVL (SUM (acum.num_orde), 0)
                 FROM int_fuent_venta_real_vacum acum
                WHERE acum.zzon_oid_zona = zon.oid_zona
                  AND acum.perd_oid_peri = peri.oid_peri
     		 ) numeroTotalOrdenes,
             (
     		  SELECT NVL (SUM (acum.num_clie), 0)
                 FROM int_fuent_venta_real_vacum acum
                WHERE acum.zzon_oid_zona = zon.oid_zona
                  AND acum.perd_oid_peri = peri.oid_peri
     		 ) numeroTotalClientes,
             NVL (SUM (fvr.num_acti_fina), 0) numeroConsultorasActivas,
             NVL (SUM (fvr.num_acti_inic), 0) numeroActivasInicioCampana,
             NVL (SUM (fvr.num_ingr), 0) numeroIngresos,
             NVL (SUM (fvr.num_egre), 0) numeroEgresos,
             NVL (SUM (fvr.num_rein), 0) numeroConsultorasReingreso,
             NVL (pre.num_unid_vend, 0) estimadoUnidadesVendidas,
             NVL (pre.val_vent_neta_esta, 0) estimadoVentasNetas,
             NVL (pre.num_pedi, 0) estimadoNumeroPedidos,
             NVL (pre.num_clie, 0) estimadoNumeroClientes,
             NVL (pre.num_acti_fina, 0) estimadoNumeroActivas,
             NVL (pre.num_ingr, 0) estimadoNumeroIngresos,
             NVL (pre.num_egre, 0) estimadoNumeroEgresos,
             NVL (pre.num_rein, 0) estimadoNumeroReingresos,
             NVL (SUM (fvr.num_rezo_reci), 0) numeroConsultorasRecibidas,
             NVL (SUM (fvr.num_rezo_entr), 0) numeroConsultorasEntregadas,
             (
     		  SELECT NVL (SUM (acum.num_pedi), 0)
                 FROM int_fuent_venta_real_vacum acum
                WHERE acum.zzon_oid_zona = zon.oid_zona
                  AND acum.perd_oid_peri = peri.oid_peri
     		 ) numeroRealPedidos,
             NVL ((
     		       SELECT val_porc_acti_fina
                     FROM lid_activ_final_zona z,
     				      seg_pais x ,
     					  seg_marca y
                    WHERE x.cod_pais= z.cod_pais
                      AND y.cod_marc= z.cod_marc
                      AND z.cod_peri = percop.cod_peri
                      AND z.cod_zona = zon.cod_zona
					  AND x.oid_pais= vnIdPais
                      AND y.oid_marc= vnIdMarca
				  ), 0
     			 ) actividadInfladaZona,
             NVL (pre.num_cons_clie_priv, 0) consultorasClientesPrivilege,
             NVL (pre.num_clie_insc_priv, 0) clientesInscritosPrivilege,
             NVL (pre.num_clie_tran_priv, 0) clientesTransaccionesPrivilege,
             NVL (pre.val_rete_2do_pedi, 0) retencion2doPedido,
             NVL (pre.val_rete_3er_pedi, 0) retencion3erPedido,
             NVL (pre.val_rete_4to_pedi, 0) retencion4toPedido,
             NVL (pre.val_rete_acti, 0) retencionActivas,
             NVL (pre.val_porc_rota, 0) porcentajeRotacion,
             NVL (pre.num_posi_egre, 0) posiblesEgresos,
             NVL (pre.val_rete_posi_egre, 0) retencionPosiblesEgresos,
             NVL (pre.val_porc_egre, 0) porcentajeEgresos,
             NVL (pre.val_pup, 0) pup,
             NVL (pre.val_ppu, 0) ppu
        FROM int_fuent_venta_previ_sap pre,
          	 cra_perio peri,
          	 seg_perio_corpo percop,
          	 seg_canal cana,
          	 zon_zona zon,
          	 int_fuent_ventas_real fvr
       WHERE pre.perd_oid_peri = peri.oid_peri
         AND pre.zzon_oid_zona = zon.oid_zona
         AND peri.cana_oid_cana = cana.oid_cana
         AND pre.perd_oid_peri = fvr.perd_oid_peri(+)
         AND pre.zzon_oid_zona = fvr.zzon_oid_zona(+)
         AND peri.peri_oid_peri = percop.oid_peri
         AND peri.pais_oid_pais = vnIdPais
         AND peri.cana_oid_cana = vnIdCanal
         AND peri.oid_peri >=  vnIdPeriodo
       GROUP BY
             cana.oid_cana,
             cana.cod_cana,
             peri.oid_peri,
             percop.cod_peri,
             zon.oid_zona,
             zon.cod_zona,
             pre.num_unid_vend,
             pre.num_pedi,
             pre.val_vent_neta_esta,
             pre.num_clie,
             pre.num_acti_fina,
             pre.num_ingr,
             pre.num_egre,
             pre.num_rein,
             pre.val_acti_infl_zona,
             pre.num_cons_clie_priv,
             pre.num_clie_insc_priv,
             pre.num_clie_tran_priv,
             pre.val_rete_2do_pedi,
             pre.val_rete_3er_pedi,
             pre.val_rete_4to_pedi,
             pre.val_rete_acti,
             pre.val_porc_rota,
             pre.num_posi_egre,
             pre.val_rete_posi_egre,
             pre.val_porc_egre,
             pre.val_pup,
             pre.val_ppu ;


   TYPE interfazRec IS RECORD
	   (
    	 codigoCanalVenta	 		  			  seg_canal.cod_cana%TYPE,
         anioCampanaFacturacion					  VARCHAR2(6),
         codigoZona								  zon_zona.cod_zona%TYPE,
         numeroTotalOrdenes						  NUMBER(9),
         numeroTotalClientes					  NUMBER(9),
         numeroConsultorasActivas 				  NUMBER(9),
         numeroActivasInicioCampana				  NUMBER(9),
         numeroIngresos							  NUMBER(9),
         numeroEgresos							  NUMBER(9),
         numeroConsultorasReingreso				  NUMBER(9),
         estimadoUnidadesVendidas				  int_fuent_venta_previ_sap.num_unid_vend%TYPE,
         estimadoVentasNetas					  int_fuent_venta_previ_sap.val_vent_neta_esta%TYPE,
         estimadoNumeroPedidos					  int_fuent_venta_previ_sap.num_pedi%TYPE,
         estimadoNumeroClientes					  int_fuent_venta_previ_sap.num_clie%TYPE,
         estimadoNumeroActivas					  int_fuent_venta_previ_sap.num_acti_fina%TYPE,
         estimadoNumeroIngresos					  int_fuent_venta_previ_sap.num_ingr%TYPE,
         estimadoNumeroEgresos					  int_fuent_venta_previ_sap.num_egre%TYPE,
         estimadoNumeroReingresos				  int_fuent_venta_previ_sap.num_rein%TYPE,
         numeroConsultorasRecibidas				  NUMBER(9),
         numeroConsultorasEntregadas			  NUMBER(9),
         numeroRealPedidos						  NUMBER(9),
         actividadInfladaZona					  lid_activ_final_zona.val_porc_acti_fina%TYPE,
         consultorasClientesPrivilege			  int_fuent_venta_previ_sap.num_cons_clie_priv%TYPE,
         clientesInscritosPrivilege				  int_fuent_venta_previ_sap.num_clie_insc_priv%TYPE,
         clientesTransaccionesPrivilege			  int_fuent_venta_previ_sap.num_clie_tran_priv%TYPE,
         retencion2doPedido						  int_fuent_venta_previ_sap.val_rete_2do_pedi%TYPE,
         retencion3erPedido						  int_fuent_venta_previ_sap.val_rete_3er_pedi%TYPE,
         retencion4toPedido						  int_fuent_venta_previ_sap.val_rete_4to_pedi%TYPE,
         retencionActivas						  int_fuent_venta_previ_sap.val_rete_acti%TYPE,
         porcentajeRotacion						  int_fuent_venta_previ_sap.val_porc_rota%TYPE,
         posiblesEgresos						  int_fuent_venta_previ_sap.num_posi_egre%TYPE,
         retencionPosiblesEgresos				  int_fuent_venta_previ_sap.val_rete_posi_egre%TYPE,
         porcentajeEgresos						  int_fuent_venta_previ_sap.val_porc_egre%TYPE,
         pup									  int_fuent_venta_previ_sap.val_pup%TYPE,
         ppu									  int_fuent_venta_previ_sap.val_ppu%TYPE
	   );

   TYPE interfazRecTab  IS TABLE OF interfazRec ;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   --W_FILAS             NUMBER := 1000 ;
   v_hANDle            UTL_FILE.FILE_TYPE;
   lbAbrirUtlFile      BOOLEAN;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);

   lnIdPais   		   NUMBER;
   lnIdMarca  		   NUMBER;
   lnIdCanal  		   NUMBER;
   lnIdPeriodo 		   NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
	lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);


    lbAbrirUtlFile := TRUE;

    /* GenerANDo Archivo de Texto (Detalle) */
        OPEN c_interfaz (lnIdPais, lnIdMarca, lnIdCanal, lnIdPeriodo);
	        LOOP
	           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                        /* Procedimiento inicial para generar interfaz */
                 IF lbAbrirUtlFile THEN
                   GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                          psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
                   lbAbrirUtlFile := FALSE;
                 END IF;

		           IF interfazRecord.COUNT > 0 THEN
		              FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		                  lsLinea :=  interfazRecord(x).codigoCanalVenta                     ||';'||
                                      interfazRecord(x).anioCampanaFacturacion               ||';'||
                                      interfazRecord(x).codigoZona                           ||';'||
                                      interfazRecord(x).numeroTotalOrdenes                   ||';'||
                                      interfazRecord(x).numeroTotalClientes                  ||';'||
                                      interfazRecord(x).numeroConsultorasActivas             ||';'||
                                      interfazRecord(x).numeroActivasInicioCampana           ||';'||
                                      interfazRecord(x).numeroIngresos                       ||';'||
                                      interfazRecord(x).numeroEgresos                        ||';'||
                                      interfazRecord(x).numeroConsultorasReingreso           ||';'||
                                      interfazRecord(x).estimadoUnidadesVendidas             ||';'||
                                      TO_CHAR(interfazRecord(x).estimadoVentasNetas,'999999999999.99') ||';'||
                                      interfazRecord(x).estimadoNumeroPedidos                ||';'||
                                      interfazRecord(x).estimadoNumeroClientes               ||';'||
                                      interfazRecord(x).estimadoNumeroActivas                ||';'||
                                      interfazRecord(x).estimadoNumeroIngresos               ||';'||
                                      interfazRecord(x).estimadoNumeroEgresos                ||';'||
                                      interfazRecord(x).estimadoNumeroReingresos             ||';'||
                                      interfazRecord(x).numeroConsultorasRecibidas           ||';'||
                                      interfazRecord(x).numeroConsultorasEntregadas          ||';'||
                                      interfazRecord(x).numeroRealPedidos                    ||';'||
                                      TO_CHAR(interfazRecord(x).actividadInfladaZona,'99999.99') ||';'||
                                      interfazRecord(x).consultorasClientesPrivilege         ||';'||
                                      interfazRecord(x).clientesInscritosPrivilege           ||';'||
                                      interfazRecord(x).clientesTransaccionesPrivilege       ||';'||
                                      interfazRecord(x).retencion2doPedido                   ||';'||
                                      interfazRecord(x).retencion3erPedido                   ||';'||
                                      interfazRecord(x).retencion4toPedido                   ||';'||
                                      TO_CHAR(interfazRecord(x).retencionActivas,'999999999999.99')        ||';'||
                                      TO_CHAR(interfazRecord(x).porcentajeRotacion,'999999999999.99')      ||';'||
                                      interfazRecord(x).posiblesEgresos                      						   ||';'||
                                      TO_CHAR(interfazRecord(x).retencionPosiblesEgresos,'999999999999.99') ||';'||
                                      TO_CHAR(interfazRecord(x).porcentajeEgresos,'999999999999.99')       ||';'||
                                      TO_CHAR(interfazRecord(x).pup,'999999999999.99')       							 ||';'||
                                      TO_CHAR(interfazRecord(x).ppu,'999999999999.99') ;

						  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		              END LOOP;
		           END IF;
	           EXIT WHEN c_interfaz%NOTFOUND;
	        END LOOP;
        CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
	   utl_file.fclose(V_HANDLE);
	   /* Procedimiento final para generar interfaz */
	   GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

    RETURN;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TRANS_ZONA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TRANS_ZONA;

/***********************************************************************************
Descripcion       : Genera Interfaz de Envio Numero Pedidos por Periodo (DAT-21)
Fecha Creacion    : 25/04/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NUMER_PEDID(
  psCodigoPais 		  VARCHAR2,
  psCodigoPeriodo 	VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2)
IS
  CURSOR c_interfaz (vnIdPais NUMBER, vnIdAcceso NUMBER, vnIdPeriodo NUMBER) IS
    SELECT mfca.val_tipo_camb AS tipoCambio,
           MAX(momi.MontoMinimo) AS MontoMinimo,
           SUM ( soca.num_clien ) AS numeroClientes,
           COUNT ( DISTINCT ( soca.clie_oid_clie ) ) AS numeroPedidos,
           COUNT ( soca.oid_soli_cabe ) AS numeroOrdenesCompra
      FROM ped_solic_cabec soca,
           pre_matri_factu_cabec mfca,
           (
            SELECT MIN(momi.VAL_NIV1) AS MontoMinimo
              FROM ped_monto_minim momi
             WHERE momi.sbti_oid_subt_clie = 1
               AND momi.ticl_oid_tipo_clie = 2
               AND momi.tccl_oid_tipo_clas IS NULL
               AND momi.clas_oid_clas IS NULL
           )momi,
           ped_tipo_solic_pais tsp,
           mae_clien_tipo_subti cts,
			     seg_subac subac
     WHERE soca.tspa_oid_tipo_soli_pais = tsp.oid_tipo_soli_pais
       AND cts.clie_oid_clie = soca.clie_oid_clie
       --
       AND soca.perd_oid_peri = vnIdPeriodo
       AND mfca.perd_oid_peri = vnIdPeriodo
       AND ( vnIdPais IS NULL OR soca.pais_oid_pais = vnIdPais )
       AND (vnIdAcceso IS NULL OR subac.acce_oid_acce = vnIdAcceso )
       AND ( psFechaFact IS NULL OR soca.fec_fact =  TO_DATE( psFechaFact, 'dd/MM/yyyy' ) )
       AND soca.ind_oc = 1
       AND soca.ind_ts_no_conso = 1
       AND soca.ind_pedi_prue = 0
       AND cts.ticl_oid_tipo_clie = 2
  GROUP BY soca.pais_oid_pais,
           mfca.val_tipo_camb;

  TYPE interfazRec IS RECORD(
    tipoCambio	 		  	 PRE_MATRI_FACTU_CABEC.VAL_TIPO_CAMB%TYPE,
    montoMinimo	 		     NUMBER,
    numeroClientes	 		 NUMBER,
    numeroPedidos	 		   NUMBER,
		numeroOrdenesCompra	 NUMBER
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdAcceso 	 	   NUMBER;
  lnIdCanal        NUMBER;
  lnIdPais   		   NUMBER;
  lnIdPeriodo 		 NUMBER;

BEGIN

  lnIdPais     := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdPeriodo  := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);
  lnIdCanal    := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);

  SELECT oid_acce
    INTO lnIdAcceso
    FROM seg_acces
   WHERE cod_acce = psCodigoAcceso
     AND cana_oid_cana = lnIdCanal;

  lbAbrirUtlFile := TRUE;

  /* Generando Archivo de Texto (Detalle) */
  OPEN c_interfaz (lnIdPais, lnIdAcceso, lnIdPeriodo);
    LOOP

      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

			  /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

		    IF interfazRecord.COUNT > 0 THEN
		      FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		        lsLinea :=  psCodigoCanal                                                  ||';'||
                        psCodigoPeriodo                                                ||';'||
                        TRIM(TO_CHAR(interfazRecord(x).tipoCambio,'999999999990.99'))  ||';'||
                        TRIM(TO_CHAR(interfazRecord(x).montoMinimo,'999999999990.99')) ||';'||
                        interfazRecord(x).numeroClientes                               ||';'||
                        interfazRecord(x).numeroPedidos                				         ||';'||
                        interfazRecord(x).numeroOrdenesCompra;

						UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		      END LOOP;
		    END IF;

	    EXIT WHEN c_interfaz%NOTFOUND;

	  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NUMER_PEDID: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_NUMER_PEDID;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Status Consultora (DAT-23)
Fecha Creacion    : 05/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo

Autor: Jose Luis Rodriguez
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_STATU_CONSU(
  psCodigoPais 		  VARCHAR2,
  psCodigoPeriodo 	VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psFechaFact       VARCHAR2)
IS

  CURSOR c_interfaz (vnIdPeriodo NUMBER, vnFechaUltimoProc DATE, vnDuplaEdadMin NUMBER, vnDuplaEdadMax NUMBER) IS
    SELECT oidcliente,
           codigoestatus,
           indicadoresestrella,
           codigocurso,
           codigocliente,
           codigoterritorio,
           numerototalordenes,
           flagduplacyzone
      FROM (
            (SELECT cli.oid_clie                                                                            oidcliente,
                    SUBSTR(CASE WHEN EST.COD_ESTA_CLIE = '05' AND ADI.NUM_CAMP_SIN_PEDI > 2 THEN '07' ELSE
                           CASE WHEN EST.COD_ESTA_CLIE = '08' THEN '02' ELSE EST.COD_ESTA_CLIE END END,2,1) codigoEstatus,
                    (SELECT COUNT (1)
                       FROM v_mae_tipif_clien vtc
                      WHERE vtc.ticl_oid_tipo_clie = 2
                        AND vtc.tccl_oid_tipo_clasi = 3
                        AND vtc.clas_oid_clas = 14
                        AND clie_oid_clie = cli.oid_clie )                                                  indicadorEsEstrella,
					          NULL                                                                                    codigoCurso,
                    0                                                                                       numeroTotalOrdenes,
        			      cli.cod_clie                                                                            codigoCliente,
                    terr.cod_terr                                                                           codigoterritorio,
                    (
                     SELECT count(1)
                       FROM mae_clien_vincu mcv,
                            mae_clien d,
                            mae_clien_datos_adici dmcda
                      WHERE 1 = 1
                        AND cli.oid_clie           = mcv.clie_oid_clie_vnte
                        AND mcv.clie_oid_clie_vndo = d.oid_clie
                        AND dmcda.ind_acti         = 1
                         AND ((EST.COD_ESTA_CLIE IN ('01','02','03','04','06','08')) OR (EST.COD_ESTA_CLIE = '05' AND adi.NUM_CAMP_SIN_PEDI <=2))
                        AND d.oid_clie             = dmcda.clie_oid_clie
                        AND mcv.tivc_oid_tipo_vinc = 1
                        AND mcv.fec_hast           IS NULL
                        AND dmcda.fec_naci         IS NOT NULL
                        AND FLOOR(months_between(SYSDATE,to_date(dmcda.fec_naci,'dd/mm/rrrr'))/12)
                            BETWEEN vnDuplaEdadMin AND vnDuplaEdadMax
                     )                                                                                     flagDuplaCyzone
               FROM mae_clien_unida_admin adm,
                    mae_clien cli,
                    zon_terri_admin tadm,
                    zon_terri terr,
                    zon_secci secc,
                    mae_clien_datos_adici adi,
                    mae_estat_clien est,
                    cra_perio per_ini,
                    (SELECT DISTINCT zorg_oid_regi
                       FROM fac_contr_cierr c,
                            fac_tipos_cierr tc
                         WHERE zorg_oid_regi IS NOT NULL
                           AND c.tcie_oid_tipo_cier = tc.oid_tipo_cier
                           AND tc.cod_tipo_cier = 'R'
                           AND perd_oid_peri = vnIdPeriodo
                           AND (vnFechaUltimoProc IS NULL OR
                               (c.fec_ulti_actu >= vnFechaUltimoProc AND c.fec_ulti_actu <= SYSDATE))) controlcierre,
                    zon_zona zon_zon,
                    (SELECT fec_inic,
                            fec_fina,
                            oid_peri
                       FROM cra_perio
                      WHERE oid_peri = vnIdPeriodo) per_ref
              WHERE adm.clie_oid_clie = cli.oid_clie
                AND adm.ztad_oid_terr_admi = tadm.oid_terr_admi
                AND tadm.zscc_oid_secc = secc.oid_secc
                AND secc.ind_acti = 1
                AND secc.ind_borr = 0
                AND adi.clie_oid_clie = cli.oid_clie
                AND adi.esta_oid_esta_clie = est.oid_esta_clie
                AND adi.ind_acti = 1
                AND tadm.terr_oid_terr = terr.oid_terr
                AND terr.ind_borr = 0
                AND secc.zzon_oid_zona = zon_zon.oid_zona
                AND zon_zon.ind_acti = 1
                AND zon_zon.ind_borr = 0
                AND adm.ind_acti = 1
                AND adm.perd_oid_peri_ini = per_ini.oid_peri
                AND per_ref.fec_inic >= per_ini.fec_inic
                AND controlcierre.zorg_oid_regi = zon_zon.zorg_oid_regi
                AND (adm.perd_oid_peri_fin IS NULL OR (SELECT fec_fina
				                                                 FROM cra_perio
                                                        WHERE oid_peri = adm.perd_oid_peri_fin) <= per_ref.fec_fina)
           GROUP BY cli.oid_clie,
				            est.cod_esta_clie,
					          adi.num_camp_sin_pedi,
                    'indicadoresestrella',
                    'codigocurso',
                    cli.cod_clie,
                    terr.cod_terr,
                    'flagduplacyzone')
            UNION
               /* Clientes que pasaron pedido el dia de hoy pero no corrieron el cierre de su region*/
            (SELECT cli.oid_clie                                                                             oidCliente,
                    SUBSTR(CASE WHEN EST.COD_ESTA_CLIE = '05' AND ADI.NUM_CAMP_SIN_PEDI > 2 THEN '07' ELSE
                           CASE WHEN EST.COD_ESTA_CLIE = '08' THEN '02' ELSE EST.COD_ESTA_CLIE END END,2,1)  codigoEstatus,
                    (SELECT COUNT (1)
                       FROM v_mae_tipif_clien vtc
                      WHERE vtc.ticl_oid_tipo_clie = 2
                        AND vtc.tccl_oid_tipo_clasi = 3
                        AND vtc.clas_oid_clas = 14
                        AND clie_oid_clie = cli.oid_clie )                                                   indicadoresestrella,
                    NULL                                                                                     codigoCurso,
                    COUNT (soc.oid_soli_cabe)                                                                numeroTotalOrdenes,
                    cli.cod_clie                                                                             codigoCliente,
                    terr.cod_terr                                                                            codigoTerritorio,
                    (
                     SELECT count(1)
                       FROM mae_clien_vincu mcv,
                            mae_clien d,
                            mae_clien_datos_adici dmcda
                      WHERE 1 = 1
                        AND cli.oid_clie           = mcv.clie_oid_clie_vnte
                        AND mcv.clie_oid_clie_vndo = d.oid_clie
                        AND dmcda.ind_acti         = 1
                        AND ((EST.COD_ESTA_CLIE IN ('01','02','03','04','06','08')) OR (EST.COD_ESTA_CLIE = '05' AND adi.NUM_CAMP_SIN_PEDI <=2))
                        AND d.oid_clie             = dmcda.clie_oid_clie
                        AND mcv.tivc_oid_tipo_vinc = 1
                        AND mcv.fec_hast           IS NULL
                        AND dmcda.fec_naci         IS NOT NULL
                        AND FLOOR(months_between(SYSDATE,to_date(dmcda.fec_naci,'dd/mm/rrrr'))/12)
                            BETWEEN vnDuplaEdadMin AND vnDuplaEdadMax
                     )                                                                                     flagDuplaCyzone

               FROM mae_clien_unida_admin adm,
                    mae_clien cli,
                    zon_terri_admin tadm,
                    zon_terri terr,
                    zon_secci secc,
                    cra_perio per_ini,
                    ped_solic_cabec soc,
                    mae_clien_datos_adici adi,
                    mae_estat_clien est,
                    zon_zona zon_zon,
                    (SELECT fec_inic,
                            fec_fina,
                            oid_peri
                       FROM cra_perio
                      WHERE oid_peri = vnIdPeriodo) per_ref
              WHERE adm.clie_oid_clie = cli.oid_clie
                AND adm.ztad_oid_terr_admi = tadm.oid_terr_admi
                AND tadm.zscc_oid_secc = secc.oid_secc
                AND secc.ind_acti = 1
                AND secc.ind_borr = 0
                AND tadm.terr_oid_terr = terr.oid_terr
                AND terr.ind_borr = 0
                AND secc.zzon_oid_zona = zon_zon.oid_zona
                AND zon_zon.ind_acti = 1
                AND zon_zon.ind_borr = 0
                AND adm.ind_acti = 1
                AND adm.perd_oid_peri_ini = per_ini.oid_peri
                AND per_ref.fec_inic >= per_ini.fec_inic
                AND zon_zon.zorg_oid_regi NOT IN (SELECT DISTINCT zorg_oid_regi
                                                    FROM fac_contr_cierr c,
													                               fac_tipos_cierr tc
                                                   WHERE zorg_oid_regi IS NOT NULL
                                                     AND c.tcie_oid_tipo_cier = tc.oid_tipo_cier
                                                     AND tc.cod_tipo_cier = 'R'
                                                     AND perd_oid_peri = vnIdPeriodo
                                                     AND (vnFechaUltimoProc IS NULL OR ( c.fec_ulti_actu >= vnFechaUltimoProc AND c.fec_ulti_actu <= SYSDATE )))
                AND (adm.perd_oid_peri_fin IS NULL OR (SELECT fec_fina
                                                         FROM cra_perio
                                                        WHERE oid_peri = adm.perd_oid_peri_fin) <= per_ref.fec_fina )
                AND soc.clie_oid_clie = cli.oid_clie
                AND soc.ind_ts_no_conso = 1
                AND soc.ind_oc = 1
                AND soc.ind_pedi_prue <> 1
                AND soc.modu_oid_modu <> 15
                AND soc.perd_oid_peri = vnIdPeriodo
                AND soc.fec_fact = to_date(psFechaFact, 'dd/MM/yyyy')
                AND adi.clie_oid_clie = cli.oid_clie
                AND adi.esta_oid_esta_clie = est.oid_esta_clie
                AND adi.ind_acti = 1
           GROUP BY cli.oid_clie,
                    est.cod_esta_clie,
                    adi.num_camp_sin_pedi,
                    'indicadoresestrella',
                    'codigocurso',
                    cli.cod_clie,
                    terr.cod_terr,
                    'flagduplacyzone')
           ) a
            UNION
            /*    Consultoras de territorios que han sido rezonificados  */
         (
        SELECT oidcliente,
                          codigoestatus,
                          indicadoresestrella,
                          codigocurso,
                          codigocliente,
                          codigoterritorio,
                          numerototalordenes,
                          flagduplacyzone
                     FROM ( (  SELECT cli.oid_clie oidcliente,
                                      SUBSTR (
                                         CASE
                                            WHEN EST.COD_ESTA_CLIE = '05'
                                                 AND ADI.NUM_CAMP_SIN_PEDI > 2
                                            THEN
                                               '07'
                                            ELSE
                                               CASE
                                                  WHEN EST.COD_ESTA_CLIE = '08' THEN '02'
                                                  ELSE EST.COD_ESTA_CLIE
                                               END
                                         END,
                                         2,
                                         1)
                                         codigoEstatus,
                                      (SELECT COUNT (1)
                                         FROM v_mae_tipif_clien vtc
                                        WHERE     vtc.ticl_oid_tipo_clie = 2
                                              AND vtc.tccl_oid_tipo_clasi = 3
                                              AND vtc.clas_oid_clas = 14
                                              AND clie_oid_clie = cli.oid_clie)
                                         indicadorEsEstrella,
                                      NULL codigoCurso,
                                      0 numeroTotalOrdenes,
                                      cli.cod_clie codigoCliente,
                                      terr.cod_terr codigoterritorio,
                                      (SELECT COUNT (1)
                                         FROM mae_clien_vincu mcv,
                                              mae_clien d,
                                              mae_clien_datos_adici dmcda
                                        WHERE     1 = 1
                                              AND cli.oid_clie = mcv.clie_oid_clie_vnte
                                              AND mcv.clie_oid_clie_vndo = d.oid_clie
                                              AND dmcda.ind_acti = 1
                                              AND ( (EST.COD_ESTA_CLIE IN
                                                        ('01','02', '03', '04', '06', '08'))
                                                   OR (EST.COD_ESTA_CLIE = '05'
                                                       AND adi.NUM_CAMP_SIN_PEDI <= 2))
                                              AND d.oid_clie = dmcda.clie_oid_clie
                                              AND mcv.tivc_oid_tipo_vinc = 1
                                              AND mcv.fec_hast IS NULL
                                              AND dmcda.fec_naci IS NOT NULL
                                              AND FLOOR (
                                                     MONTHS_BETWEEN (
                                                        SYSDATE,
                                                        TO_DATE (dmcda.fec_naci,
                                                                 'dd/mm/rrrr'))
                                                     / 12) BETWEEN vnDuplaEdadMin
                                                               AND   vnDuplaEdadMax  ) flagDuplaCyzone
                                 FROM mae_clien_unida_admin adm,
                                      mae_clien cli,
                                      zon_terri_admin tadm,
                                      zon_terri terr,
                                      zon_secci secc,
                                      mae_clien_datos_adici adi,
                                      mae_estat_clien est,
                                      cra_perio per_ini,
                                      (select cod_terr
                                      from ZON_HISTO_VALID_UNADM
                                      where cod_peri= psCodigoPeriodo ) hcua,
                                      zon_zona zon_zon
                                WHERE     adm.clie_oid_clie = cli.oid_clie
                                      AND adm.ztad_oid_terr_admi = tadm.oid_terr_admi
                                      AND tadm.zscc_oid_secc = secc.oid_secc
                                      AND secc.ind_acti = 1
                                      AND secc.ind_borr = 0
                                      AND adi.clie_oid_clie = cli.oid_clie
                                      AND adi.esta_oid_esta_clie = est.oid_esta_clie
                                      AND adi.ind_acti = 1
                                      AND tadm.terr_oid_terr = terr.oid_terr
                                      AND terr.ind_borr = 0
                                      AND secc.zzon_oid_zona = zon_zon.oid_zona
                                      AND zon_zon.ind_acti = 1
                                      AND zon_zon.ind_borr = 0
                                      AND adm.ind_acti = 1
                                      AND terr.cod_terr = hcua.cod_terr
                                      AND cli.oid_clie not in
                                       (     SELECT soc.clie_oid_clie
                                             FROM  PED_SOLIC_CABEC   soc
                                             WHERE  soc.clie_oid_clie = cli.oid_clie
                                             AND soc.ind_ts_no_conso = 1
                                             AND soc.ind_oc = 1
                                             AND soc.ind_pedi_prue <> 1
                                             AND soc.modu_oid_modu <> 15
                                             AND soc.perd_oid_peri = vnIdPeriodo
                                             AND soc.fec_fact =
                                                     to_date(psFechaFact, 'dd/MM/yyyy') -----
                                       )
                             GROUP BY cli.oid_clie,
                                      est.cod_esta_clie,
                                      adi.num_camp_sin_pedi,
                                      'indicadoresestrella',
                                      'codigocurso',
                                      cli.cod_clie,
                                      terr.cod_terr,
                                      'flagduplacyzone') )
               UNION
               /*  Consultoras que han sido cambiaas de territorio de forma masiva  */
         (
        SELECT oidcliente,
                          codigoestatus,
                          indicadoresestrella,
                          codigocurso,
                          codigocliente,
                          codigoterritorio,
                          numerototalordenes,
                          flagduplacyzone
                     FROM ( (  SELECT cli.oid_clie oidcliente,
                                      SUBSTR (
                                         CASE
                                            WHEN EST.COD_ESTA_CLIE = '05'
                                                 AND ADI.NUM_CAMP_SIN_PEDI > 2
                                            THEN
                                               '07'
                                            ELSE
                                               CASE
                                                  WHEN EST.COD_ESTA_CLIE = '08' THEN '02'
                                                  ELSE EST.COD_ESTA_CLIE
                                               END
                                         END,
                                         2,
                                         1)
                                         codigoEstatus,
                                      (SELECT COUNT (1)
                                         FROM v_mae_tipif_clien vtc
                                        WHERE     vtc.ticl_oid_tipo_clie = 2
                                              AND vtc.tccl_oid_tipo_clasi = 3
                                              AND vtc.clas_oid_clas = 14
                                              AND clie_oid_clie = cli.oid_clie)
                                         indicadorEsEstrella,
                                      NULL codigoCurso,
                                      0 numeroTotalOrdenes,
                                      cli.cod_clie codigoCliente,
                                      terr.cod_terr codigoterritorio,
                                      (SELECT COUNT (1)
                                         FROM mae_clien_vincu mcv,
                                              mae_clien d,
                                              mae_clien_datos_adici dmcda
                                        WHERE     1 = 1
                                              AND cli.oid_clie = mcv.clie_oid_clie_vnte
                                              AND mcv.clie_oid_clie_vndo = d.oid_clie
                                              AND dmcda.ind_acti = 1
                                              AND ( (EST.COD_ESTA_CLIE IN
                                                        ('01','02', '03', '04', '06', '08'))
                                                   OR (EST.COD_ESTA_CLIE = '05'
                                                       AND adi.NUM_CAMP_SIN_PEDI <= 2))
                                              AND d.oid_clie = dmcda.clie_oid_clie
                                              AND mcv.tivc_oid_tipo_vinc = 1
                                              AND mcv.fec_hast IS NULL
                                              AND dmcda.fec_naci IS NOT NULL
                                              AND FLOOR (
                                                     MONTHS_BETWEEN (
                                                        SYSDATE,
                                                        TO_DATE (dmcda.fec_naci,
                                                                 'dd/mm/rrrr'))
                                                     / 12) BETWEEN vnDuplaEdadMin
                                                               AND   vnDuplaEdadMax  )  flagDuplaCyzone
                                 FROM mae_clien_unida_admin adm,
                                      mae_clien cli,
                                      zon_terri_admin tadm,
                                      zon_terri terr,
                                      zon_secci secc,
                                      mae_clien_datos_adici adi,
                                      mae_estat_clien est,
                                      cra_perio per_ini,
                                      (select cod_clie
                                      from ZON_HISTO_TERRI_CONSU
                                      where cod_peri= psCodigoPeriodo ) hcon,
                                      zon_zona zon_zon
                                WHERE     adm.clie_oid_clie = cli.oid_clie
                                      AND adm.ztad_oid_terr_admi = tadm.oid_terr_admi
                                      AND tadm.zscc_oid_secc = secc.oid_secc
                                      AND secc.ind_acti = 1
                                      AND secc.ind_borr = 0
                                      AND adi.clie_oid_clie = cli.oid_clie
                                      AND adi.esta_oid_esta_clie = est.oid_esta_clie
                                      AND adi.ind_acti = 1
                                      AND tadm.terr_oid_terr = terr.oid_terr
                                      AND terr.ind_borr = 0
                                      AND secc.zzon_oid_zona = zon_zon.oid_zona
                                      AND zon_zon.ind_acti = 1
                                      AND zon_zon.ind_borr = 0
                                      AND adm.ind_acti = 1
                                      AND cli.cod_clie = hcon.cod_clie
                                     AND cli.oid_clie not in
                                       (     SELECT soc.clie_oid_clie
                                             FROM  PED_SOLIC_CABEC   soc
                                             WHERE  soc.clie_oid_clie = cli.oid_clie
                                             AND soc.ind_ts_no_conso = 1
                                             AND soc.ind_oc = 1
                                             AND soc.ind_pedi_prue <> 1
                                             AND soc.modu_oid_modu <> 15
                                             AND soc.perd_oid_peri = vnIdPeriodo
                                             AND soc.fec_fact =
                                                     to_date(psFechaFact, 'dd/MM/yyyy')  -----
                                       )
                             GROUP BY cli.oid_clie,
                                      est.cod_esta_clie,
                                      adi.num_camp_sin_pedi,
                                      'indicadoresestrella',
                                      'codigocurso',
                                      cli.cod_clie,
                                      terr.cod_terr,
                                      'flagduplacyzone') ) )      )
    ORDER BY oidcliente;

  TYPE interfazRec IS RECORD(
    oidCliente	 		  	 mae_clien.oid_clie%TYPE,
    codigoEstatus	 		   VARCHAR2(2),
    indicadorEsEstrella  NUMBER,
    codigoCurso	 		     edu_matri_curso.cod_curs%TYPE,
    codigoCliente	 		   mae_clien.cod_clie%TYPE,
    codigoTerritorio	 	 zon_terri.cod_terr%TYPE,
    numeroTotalOrdenes	 NUMBER,
    flagDuplaCyzone	 		 NUMBER
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo         BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle           UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile     BOOLEAN;
  lsLinea            VARCHAR2(1000);
  lsNombreArchivo    VARCHAR2(50);
  lnIdPais   		     NUMBER;
  lnIdPeriodo 		   NUMBER;
  ldfechaUltimoProc  DATE := null;

  lnDuplaEdadMin     NUMBER;
  lnDuplaEdadMax     NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);

  SELECT MAX(fec_fin_proc)
    INTO ldFechaUltimoProc
    FROM int_histo_lotes
   WHERE cod_inte = psCodigoInterfaz
     AND pais_oid_pais = lnIdPais;
 --obtener edad minima para dupla cyzone
    BEGIN
      SELECT nvl(mce.val_edad_mini,0)
        INTO lnDuplaEdadMin
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMin := 0;
    END;
 --obtener edad maxima para dupla cyzone
     BEGIN
      SELECT nvl(mce.val_edad_maxi,200)
        INTO lnDuplaEdadMax
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMax := 200;
    END;

  lbAbrirUtlFile := TRUE;

  /* GenerANDo Archivo de Texto (Detalle) */
  OPEN c_interfaz (lnIdPeriodo, ldFechaUltimoProc,lnDuplaEdadMin,lnDuplaEdadMax);
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

		    /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazRecord.COUNT > 0 THEN
          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
            lsLinea :=  psCodigoCanal                                 ||';'||
                        psCodigoPeriodo                               ||';'||
                        interfazRecord(x).codigocliente               ||';'||
                        interfazRecord(x).codigoterritorio            ||';'||
                        interfazRecord(x).codigoestatus               ||';'||
                        interfazRecord(x).codigocurso                 ||';'||
                        interfazRecord(x).indicadoresestrella         ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        '0.00'                                        ||';';

                        IF interfazRecord(x).numerototalordenes > 0 THEN
                          lsLinea :=  lsLinea || '1' ||';';
                        ELSE
                          lsLinea :=  lsLinea || '0' ||';';
                        END IF;

                        lsLinea :=  lsLinea || interfazRecord(x).numerototalordenes 	  ||';'||
                                    interfazRecord(x).flagduplacyzone;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_STATU_CONSU: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_STATU_CONSU;


/****************************************************************************
Descripcion       : Genera Interfaz de Envio Status Consultora (Reemplazaria al DAT-23)
Fecha Creacion    : 29/10/2015
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo

Autor: FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_STATU_CLIEN(
  psCodigoPais 		  VARCHAR2,
  psCodigoPeriodo 	VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psFechaFact       VARCHAR2)
IS

  CURSOR c_interfaz (vnIdPeriodo NUMBER, vnFechaUltimoProc DATE, vnDuplaEdadMin NUMBER, vnDuplaEdadMax NUMBER) IS
    SELECT oidcliente,
           codigoestatus,
           indicadoresestrella,
           codigocurso,
           codigocliente,
           codigoterritorio,
           numerototalordenes,
           flagduplacyzone
      FROM (
            (SELECT act.clie_oid_clie                                                                            oidcliente,
                    SUBSTR(CASE WHEN act.cod_esta_actu = '05' AND adi.num_camp_sin_pedi > 2 THEN '07' ELSE
                           CASE WHEN act.cod_esta_actu = '08' THEN '02' ELSE act.cod_esta_actu END END,2,1) codigoEstatus,
                    (SELECT COUNT (1)
                       FROM v_mae_tipif_clien vtc
                      WHERE vtc.ticl_oid_tipo_clie = 2
                        AND vtc.tccl_oid_tipo_clasi = 3
                        AND vtc.clas_oid_clas = 14
                        AND clie_oid_clie = act.clie_oid_clie )                                                  indicadorEsEstrella,
					          NULL                                                                                    codigoCurso,
                    0                                                                                       numeroTotalOrdenes,
        			      act.cod_clie                                                                            codigoCliente,
                    terr.cod_terr                                                                           codigoterritorio,
                    (
                     SELECT count(1)
                       FROM mae_clien_vincu mcv,
                            mae_clien d,
                            mae_clien_datos_adici dmcda
                      WHERE 1 = 1
                        AND act.clie_oid_clie      = mcv.clie_oid_clie_vnte
                        AND mcv.clie_oid_clie_vndo = d.oid_clie
                        AND dmcda.ind_acti         = 1
                         AND ((act.cod_esta_actu IN ('01','02','03','04','06','08')) OR (act.cod_esta_actu = '05' AND adi.NUM_CAMP_SIN_PEDI <=2))
                        AND d.oid_clie             = dmcda.clie_oid_clie
                        AND mcv.tivc_oid_tipo_vinc = 1
                        AND mcv.fec_hast           IS NULL
                        AND dmcda.fec_naci         IS NOT NULL
                        AND FLOOR(months_between(SYSDATE,to_date(dmcda.fec_naci,'dd/mm/rrrr'))/12)
                            BETWEEN vnDuplaEdadMin AND vnDuplaEdadMax
                     )                                                                                     flagDuplaCyzone
               FROM mae_clien_unida_admin adm,
                    mae_clien_estat_actua act,
                    zon_terri_admin tadm,
                    zon_terri terr,
                    zon_secci secc,
                    mae_clien_datos_adici adi,
                    cra_perio per_ini,
                    zon_zona zon_zon,
                    (SELECT fec_inic,
                            fec_fina,
                            oid_peri
                       FROM cra_perio
                      WHERE oid_peri = vnIdPeriodo) per_ref
              WHERE adm.clie_oid_clie = act.clie_oid_clie
                AND adm.ztad_oid_terr_admi = tadm.oid_terr_admi
                AND tadm.zscc_oid_secc = secc.oid_secc
                AND secc.ind_acti = 1
                AND secc.ind_borr = 0
                AND adi.clie_oid_clie = act.clie_oid_clie
                AND adi.ind_acti = 1
                AND tadm.terr_oid_terr = terr.oid_terr
                AND terr.ind_borr = 0
                AND secc.zzon_oid_zona = zon_zon.oid_zona
                AND zon_zon.ind_acti = 1
                AND zon_zon.ind_borr = 0
                AND adm.ind_acti = 1
                AND adm.perd_oid_peri_ini = per_ini.oid_peri
                AND per_ref.fec_inic >= per_ini.fec_inic
                AND act.cam_eval_actu=psCodigoPeriodo
                AND (adm.perd_oid_peri_fin IS NULL OR (SELECT fec_fina
				                                                 FROM cra_perio
                                                        WHERE oid_peri = adm.perd_oid_peri_fin) <= per_ref.fec_fina)
           GROUP BY act.clie_oid_clie,
				            act.cod_esta_actu,
					          adi.num_camp_sin_pedi,
                    'indicadoresestrella',
                    'codigocurso',
                    act.cod_clie,
                    terr.cod_terr,
                    'flagduplacyzone')
           ) a
    ORDER BY oidcliente;

  TYPE interfazRec IS RECORD(
    oidCliente	 		  	 mae_clien.oid_clie%TYPE,
    codigoEstatus	 		   VARCHAR2(2),
    indicadorEsEstrella  NUMBER,
    codigoCurso	 		     edu_matri_curso.cod_curs%TYPE,
    codigoCliente	 		   mae_clien.cod_clie%TYPE,
    codigoTerritorio	 	 zon_terri.cod_terr%TYPE,
    numeroTotalOrdenes	 NUMBER,
    flagDuplaCyzone	 		 NUMBER
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo         BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle           UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile     BOOLEAN;
  lsLinea            VARCHAR2(1000);
  lsNombreArchivo    VARCHAR2(50);
  lnIdPais   		     NUMBER;
  lnIdPeriodo 		   NUMBER;
  ldfechaUltimoProc  DATE := null;

  lnDuplaEdadMin     NUMBER;
  lnDuplaEdadMax     NUMBER;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);

  SELECT MAX(fec_fin_proc)
    INTO ldFechaUltimoProc
    FROM int_histo_lotes
   WHERE cod_inte = psCodigoInterfaz
     AND pais_oid_pais = lnIdPais;
 --obtener edad minima para dupla cyzone
    BEGIN
      SELECT nvl(mce.val_edad_mini,0)
        INTO lnDuplaEdadMin
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMin := 0;
    END;
 --obtener edad maxima para dupla cyzone
     BEGIN
      SELECT nvl(mce.val_edad_maxi,200)
        INTO lnDuplaEdadMax
        FROM mae_clien_edad mce
       WHERE mce.sbti_oid_subt_clie = 6;
    EXCEPTION
      WHEN no_data_found THEN
        lnDuplaEdadMax := 200;
    END;

  lbAbrirUtlFile := TRUE;

  /* GenerANDo Archivo de Texto (Detalle) */
  OPEN c_interfaz (lnIdPeriodo, ldFechaUltimoProc,lnDuplaEdadMin,lnDuplaEdadMax);
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

		    /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazRecord.COUNT > 0 THEN
          FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
            lsLinea :=  psCodigoCanal                                 ||';'||
                        psCodigoPeriodo                               ||';'||
                        interfazRecord(x).codigocliente               ||';'||
                        interfazRecord(x).codigoterritorio            ||';'||
                        interfazRecord(x).codigoestatus               ||';'||
                        interfazRecord(x).codigocurso                 ||';'||
                        interfazRecord(x).indicadoresestrella         ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        ''                                            ||';'||
                        '0.00'                                        ||';';

                        IF interfazRecord(x).numerototalordenes > 0 THEN
                          lsLinea :=  lsLinea || '1' ||';';
                        ELSE
                          lsLinea :=  lsLinea || '0' ||';';
                        END IF;

                        lsLinea :=  lsLinea || interfazRecord(x).numerototalordenes 	  ||';'||
                                    interfazRecord(x).flagduplacyzone;

                  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_STATU_CLIEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_STATU_CLIEN;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Tiempos de Periodo (DAT-29)
Fecha Creacion    : 06/05/2011
Fecha Edicion     : 14/07/2011 - CMori
                    - Configuracion de Periodo N+1
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Arcchivo
Autor: Dany Romero
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIEMP_CAMPA
  (psCodigoPais 		  VARCHAR2,
   psCodigoPeriodo 		VARCHAR2,
   psCodigoMarca 		  VARCHAR2,
   psCodigoCanal 		  VARCHAR2,
   psCodigoSistema 		VARCHAR2,
   psCodigoInterfaz 	VARCHAR2,
   psNombreArchivo     VARCHAR2,
   psFechaFacturacion  VARCHAR2)
IS
  CURSOR c_campanias (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, vnAnio NUMBER) IS
    SELECT p.fec_inic  fechaInicio,
	  		   p.fec_fina  fechaFin,
			     pc.cod_peri codigoPeriodo,
           CASE
             WHEN rng.cod_rape = '01' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'I'
             WHEN rng.cod_rape = '02' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'II'
             WHEN rng.cod_rape = '03' THEN SUBSTR(pc.cod_peri,1,4) || ' ' || 'III'
           END rangoPeriodo
      FROM cra_perio p,
			     seg_perio_corpo pc,
           cra_rango_perio rng
     WHERE pc.oid_peri = p.peri_oid_peri
       AND (vnIdCanal IS NULL OR p.cana_oid_cana = vnIdCanal)
       AND (vnIdPais IS NULL OR p.pais_oid_pais = vnIdPais)
       AND (vnIdMarca IS NULL OR p.marc_oid_marc = vnIdMarca)
       AND (vnAnio IS NULL OR pc.val_anio = vnAnio)
       AND ( SUBSTR(pc.cod_peri,5,2) >= rng.per_inic AND SUBSTR(pc.cod_peri,5,2) <= rng.per_fina )
  ORDER BY p.fec_inic ASC;

  TYPE tRecCampania IS RECORD
  (
    fechaInicio	 	 cra_perio.fec_inic%TYPE,
    fechaFin	 		 cra_perio.fec_fina%TYPE,
    codigoPeriodo	 seg_perio_corpo.cod_peri%TYPE,
    rangoperiodo   varchar2(8)
  );

  TYPE tTabRecCampania  IS TABLE OF tRecCampania;
  tabCampanias tTabRecCampania;
  tabCampAux   tTabRecCampania;
  recCampAux   tRecCampania;
  recCampNull  tRecCampania;

  TYPE interfazRec IS RECORD
  (
    anioCampanaActual	 	    VARCHAR2(6),
    codigoCanalVenta		    VARCHAR2(2),
    fechaDiaAnio			      DATE,
    anioContableDia		      VARCHAR2(4),
    numTrimestreAnio		    VARCHAR2(1),
    PeriodoBelcorp			    VARCHAR2(8),
    descripcionEstacion	    VARCHAR2(9),
    numeroSemestre			    VARCHAR2(1),
    nombreMes				        VARCHAR2(10),
    nombreDiaSemana		      VARCHAR2(9),
    numeroSemana			      VARCHAR2(2),
    indicadorFeriado		    VARCHAR2(1),
    indicadorLaborable		  VARCHAR2(1),
    indicadorInicioPeriodo  VARCHAR2(1),
    indicadorFinPeriodo	    VARCHAR2(1)
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;

  interfazRecord interfazRecTab := interfazRecTab();
  interfazRecNew interfazRec;
  interfazRecNull interfazRec;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle            UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile      BOOLEAN;
  --
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdMarca        NUMBER;
  lnIdCanal        NUMBER;
  lnIdPais   		   NUMBER;
  lnIdPeriodo 		 NUMBER;
  lnAnio     		   NUMBER;
  ctdReg     		   NUMBER;
  fecFacturacion   DATE;
  fecMayor   		   DATE;
  --
  lsCodigoPeriodoSig  VARCHAR2(6) := NULL;
  lnIndCdrNmasUno     NUMBER(1)   := 0;
  lnIndCruceCamp      NUMBER(1)   := 0;


BEGIN
  lnIdPais     := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lnIdPeriodo  := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);
  lnIdMarca    := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
  lnIdCanal    := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
  --
  lnIndCdrNmasUno    := INT_PKG_DATAM.INT_FN_DAT_VERIF_CDRS_PERIO(psCodigoPais,psCodigoMarca,psCodigoCanal,psCodigoPeriodo,psFechaFacturacion);
  --INT_FN_CDRS_CAMPA_SIGUI(psCodigoPeriodo,psFechaFacturacion);

  SELECT perd.ind_peri_cruc
    INTO lnIndCruceCamp
    FROM cra_perio perd
   WHERE perd.oid_peri = lnIdPeriodo;

  SELECT pc.val_anio
    INTO lnAnio
    FROM cra_perio p,
	  	   seg_perio_corpo pc
   WHERE pc.oid_peri = p.peri_oid_peri
	   AND p.oid_peri = lnIdPeriodo;

  SELECT COUNT(1)
    INTO ctdReg
    FROM cra_perio p,
         seg_perio_corpo pc
   WHERE pc.oid_peri = p.peri_oid_peri
     AND (lnIdCanal IS NULL OR p.cana_oid_cana = lnIdCanal)
     AND (lnIdPais IS NULL OR p.pais_oid_pais = lnIdPais)
     AND (lnIdMarca IS NULL OR p.marc_oid_marc = lnIdMarca)
     AND (lnAnio IS NULL OR pc.val_anio = lnAnio);

  IF ctdReg IS NULL OR ctdReg = 0 THEN
    OPEN c_campanias (lnIdPais, lnIdMarca, lnIdCanal, lnAnio + 1);
  ELSE
    OPEN c_campanias (lnIdPais, lnIdMarca, lnIdCanal, lnAnio);
  END IF;

  LOOP
    FETCH c_campanias BULK COLLECT INTO tabCampanias LIMIT W_FILAS;
    EXIT WHEN c_campanias%NOTFOUND;
  END LOOP;

  CLOSE c_campanias;

  fecFacturacion := tabCampanias(1).fechaInicio;

	FOR x IN tabCampanias.FIRST .. tabCampanias.LAST LOOP
    IF fecFacturacion > tabCampanias(x).fechaInicio THEN
      fecFacturacion := tabCampanias(x).fechaInicio;
    END IF;
  END LOOP;

  fecMayor := tabCampanias(1).fechaFin;

  FOR x IN tabCampanias.FIRST .. tabCampanias.LAST LOOP
    IF fecMayor < tabCampanias(x).fechaFin THEN
      fecMayor := tabCampanias(x).fechaFin;
    END IF;
  END LOOP;

  FOR y IN 0 .. 366 LOOP
    tabCampAux := tTabRecCampania();
    FOR x IN tabCampanias.FIRST .. tabCampanias.LAST LOOP
      IF fecFacturacion + y >= tabCampanias(x).fechaInicio AND fecFacturacion + y <= tabCampanias(x).fechaFin  THEN
        recCampAux := recCampNull;
        recCampAux.codigoPeriodo := tabCampanias(x).codigoPeriodo;
        recCampAux.rangoPeriodo := tabCampanias(x).rangoPeriodo;
        IF fecFacturacion + y = tabCampanias(x).fechaInicio THEN
          recCampAux.fechaInicio := TO_DATE('01/01/01', 'DD/MM/YYYY');
        ELSE
          recCampAux.fechaInicio := TO_DATE('02/01/01', 'DD/MM/YYYY');
        END IF;
        IF fecFacturacion + y = tabCampanias(x).fechaFin THEN
          recCampAux.fechaFin := TO_DATE('01/01/01', 'DD/MM/YYYY');
        ELSE
          recCampAux.fechaFin := TO_DATE('02/01/01', 'DD/MM/YYYY');
        END IF;
        tabCampAux.Extend;
        tabCampAux(tabCampAux.count) := recCampAux;
      END IF;
    END LOOP;

    IF tabCampAux.count>0 THEN

      interfazRecNew                   := interfazRecNull;
      interfazRecNew.anioCampanaActual := tabCampAux(1).codigoPeriodo;
      interfazRecNew.fechaDiaAnio      := fecFacturacion + y;
      interfazRecNew.codigoCanalVenta  := psCodigoCanal;
      interfazRecNew.anioContableDia   := lnAnio;

/*
      IF substr(tabCampAux(1).codigoPeriodo,5,2) >= '01' AND substr(tabCampAux(1).codigoPeriodo,5,2) <= '06' THEN
        interfazRecNew.PeriodoBelcorp := substr(tabCampAux(1).codigoPeriodo,1,4) || ' I';
      ELSIF substr(tabCampAux(1).codigoPeriodo,5,2) >= '07' AND substr(tabCampAux(1).codigoPeriodo,5,2) <= '12' THEN
        interfazRecNew.PeriodoBelcorp := substr(tabCampAux(1).codigoPeriodo,1,4) || ' II';
      ELSIF substr(tabCampAux(1).codigoPeriodo,5,2) >= '13' AND substr(tabCampAux(1).codigoPeriodo,5,2) <= '18' THEN
        interfazRecNew.PeriodoBelcorp := substr(tabCampAux(1).codigoPeriodo,1,4) || ' III';
      END IF;
*/
      interfazRecNew.PeriodoBelcorp := tabCampAux(1).rangoperiodo;

      interfazRecNew.indicadorFeriado       := '0';
      interfazRecNew.indicadorLaborable     := '1';
      interfazRecNew.indicadorInicioPeriodo := CASE WHEN tabCampAux(1).fechaInicio = TO_DATE('01/01/01', 'DD/MM/YYYY') THEN '1' ELSE '0' END;
      interfazRecNew.indicadorFinPeriodo    := CASE WHEN tabCampAux(1).fechaFin = TO_DATE('01/01/01', 'DD/MM/YYYY') THEN '1' ELSE '0' END;
      interfazRecNew.numTrimestreAnio       := CEIL(TO_NUMBER(TO_CHAR(fecFacturacion + y,'MM'))/3);
      interfazRecNew.numeroSemestre         := CEIL(TO_NUMBER(TO_CHAR(fecFacturacion + y,'MM'))/6);
      interfazRecNew.nombreDiaSemana        := TO_CHAR(fecFacturacion + y,'Day');
      interfazRecNew.nombreMes              := TO_CHAR(fecFacturacion + y,'Month');

      IF interfazRecNew.nombreDiaSemana LIKE 'Domingo%' THEN
        ctdReg := to_number(TO_CHAR(fecFacturacion + y,'IW')) + 2;
      ELSE
        ctdReg := to_number(TO_CHAR(fecFacturacion + y,'IW')) + 1;
      END IF;

      IF ctdReg >= 53 THEN
        ctdReg := ctdReg - 52;
      END IF;

      interfazRecNew.numeroSemana := ctdReg;

      IF (TO_CHAR(fecFacturacion + y,'MMDD')>='0101' AND TO_CHAR(fecFacturacion + y,'MMDD')<='0320') OR
         (TO_CHAR(fecFacturacion + y,'MMDD')>='1222' AND TO_CHAR(fecFacturacion + y,'MMDD')<='1231') THEN
        interfazRecNew.descripcionEstacion := 'Verano';
      ELSIF (TO_CHAR(fecFacturacion + y,'MMDD')>='0321' AND TO_CHAR(fecFacturacion + y,'MMDD')<='0621') THEN
        interfazRecNew.descripcionEstacion := 'Otoo';
      ELSIF (TO_CHAR(fecFacturacion + y,'MMDD')>='0622' AND TO_CHAR(fecFacturacion + y,'MMDD')<='0922') THEN
        interfazRecNew.descripcionEstacion := 'Invierno';
      ELSIF (TO_CHAR(fecFacturacion + y,'MMDD')>='0923' AND TO_CHAR(fecFacturacion + y,'MMDD')<='1221') THEN
        interfazRecNew.descripcionEstacion := 'Primavera';
      END IF;

      interfazRecord.extend;
      interfazRecord(interfazRecord.count) := interfazRecNew;

    END IF;
  END LOOP;

  /* Generando Archivo de Texto (Detalle) */
  lbAbrirUtlFile := TRUE;

  IF lbAbrirUtlFile THEN
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
    lbAbrirUtlFile := FALSE;
  END IF;

  IF interfazRecord.COUNT > 0 THEN
    FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
      lsLinea := interfazRecord(x).anioCampanaActual                 ||';'||
          		   interfazRecord(x).codigoCanalVenta                  ||';'||
          			 to_char(interfazRecord(x).fechaDiaAnio,'YYYYMMDD')  ||';'||
          			 interfazRecord(x).anioContableDia                   ||';'||
			           interfazRecord(x).numTrimestreAnio                  ||';'||
			           interfazRecord(x).PeriodoBelcorp                    ||';'||
			           interfazRecord(x).descripcionEstacion               ||';'||
			           interfazRecord(x).numeroSemestre                  	 ||';'||
			           trim(interfazRecord(x).nombreDiaSemana)       	     ||';'||
			           trim(interfazRecord(x).nombreMes)              	   ||';'||
			           interfazRecord(x).numeroSemana                  	   ||';'||
			           interfazRecord(x).indicadorFeriado                  ||';'||
			           interfazRecord(x).indicadorLaborable                ||';'||
			           interfazRecord(x).indicadorInicioPeriodo            ||';'||
			           interfazRecord(x).indicadorFinPeriodo;
        UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

        IF to_char(interfazRecord(x).fechaDiaAnio,'dd/MM/yyyy') = psFechaFacturacion AND
           lnIndCdrNmasUno = 1 AND
           lnIndCruceCamp = 0 THEN
           lsCodigoPeriodoSig := GEN_FN_CALCU_PERIO(interfazRecord(x).anioCampanaActual,1);
           lsLinea := lsCodigoPeriodoSig                                  ||';'||
                      interfazRecord(x).codigoCanalVenta                  ||';'||
                      to_char(interfazRecord(x).fechaDiaAnio,'YYYYMMDD')  ||';'||
                      interfazRecord(x).anioContableDia                   ||';'||
                      interfazRecord(x).numTrimestreAnio                  ||';'||
                      interfazRecord(x).PeriodoBelcorp                    ||';'||
                      interfazRecord(x).descripcionEstacion               ||';'||
                      interfazRecord(x).numeroSemestre                    ||';'||
                      trim(interfazRecord(x).nombreDiaSemana)             ||';'||
                      trim(interfazRecord(x).nombreMes)                   ||';'||
                      interfazRecord(x).numeroSemana                      ||';'||
                      interfazRecord(x).indicadorFeriado                  ||';'||
                      interfazRecord(x).indicadorLaborable                ||';'||
                      interfazRecord(x).indicadorInicioPeriodo            ||';'||
                      interfazRecord(x).indicadorFinPeriodo;
      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END IF;
    END LOOP;
  END IF;

  IF NOT lbAbrirUtlFile THEN
    utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIEMP_CAMPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TIEMP_CAMPA;

/**************************************************************
Descripcion        : Verifica si en la Periodo y fecha de facturacion
                     vigente existen transacciones de CDR con la
                     Periodo siguiente.
Fecha Creacion     : 14/07/2011
Fecha Modificacion :
Parametros         : psCodigoPais: Codigo de Pais
                     psCodigoMarca: Codigo de Marca
                     psCodigoCanal: Codigo de Canal
                     psCodigoPeriodo: Codigo de Periodo
                     psFechaFacturacion: Fecha de Facturacion
Autor              : Sergio Apaza
***************************************************************/
FUNCTION INT_FN_DAT_VERIF_CDRS_PERIO
  (psCodigoPais       IN VARCHAR2,
   psCodigoMarca      IN VARCHAR2,
   psCodigoCanal      IN VARCHAR2,
   psCodigoPeriodo    IN VARCHAR2,
   psFechaFacturacion IN VARCHAR2)
RETURN NUMBER
IS
	lnOidPeriodoSig NUMBER(12);
	lnIndExisteMov  NUMBER(1);
	lnNumCDRs       NUMBER(12);

  lnIdPais           SEG_PAIS.OID_PAIS%TYPE;
  lnIdCanal          SEG_CANAL.OID_CANA%TYPE;
  lnIdMarca          SEG_MARCA.OID_MARC%TYPE;
  lsCodigoPeriodo    SEG_PERIO_CORPO.COD_PERI%TYPE;

BEGIN
  lnIdPais  := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_PAIS(psCodigoPais);
  lnIdMarca := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_MARCA(psCodigoMarca);
  lnIdCanal := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CANAL(psCodigoCanal);

  lsCodigoPeriodo := PER_PKG_REPOR_PERCE.PER_FN_OBTIE_PERIO(psCodigoPeriodo,
                                                            lnIdPais,
                                                            lnIdMarca,
                                                            lnIdCanal,
                                                            1);


  lnOidPeriodoSig := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2(lsCodigoPeriodo);

	SELECT COUNT(1)
	  INTO lnNumCDRs
	  FROM ped_solic_cabec soca,
         ped_solic_posic sopo,
	       ped_tipo_solic_pais tspa,
	       ped_tipo_solic tsol,
	       int_param_tipo_solic ipts,
	       cra_perio perd,
	       seg_perio_corpo peri
	 WHERE soca.oid_soli_cabe = sopo.soca_oid_soli_cabe
     AND soca.tspa_oid_tipo_soli_pais = tspa.oid_tipo_soli_pais
	   AND soca.perd_oid_peri = perd.oid_peri
	   AND perd.peri_oid_peri = peri.oid_peri
	   AND tspa.tsol_oid_tipo_soli = tsol.oid_tipo_soli
	   AND tspa.oid_tipo_soli_pais = ipts.tspa_oid_tipo_soli_pais
     AND ( FN_DAT_VALIDAR_PROD_SOLI_DEVO(soca.OID_SOLI_CABE, sopo.OID_SOLI_POSI) > 0 AND
           ( ipts.num_unid_devu = 1 OR
             ipts.num_unid_anul = 1 OR
             ipts.num_unid_canj = 1 OR
             ipts.num_unid_true = 1
          )
         )
     AND sopo.espo_oid_esta_posi <> 2
	   AND soca.perd_oid_peri = lnOidPeriodoSig
     AND trunc(soca.fec_fact) = TO_DATE(psFechaFacturacion,'dd/MM/yyyy');

  IF lnNumCDRs = 0 THEN
     lnIndExisteMov := 0; -- Indica que NO existen CDRs con Periodo siguiente
  ELSE
     lnIndExisteMov := 1; -- Indica que SI existen CDRs con Periodo siguiente
  END IF;

  RETURN lnIndExisteMov;

END INT_FN_DAT_VERIF_CDRS_PERIO;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Fecha de Control (DAT-04, DAT-116)
Fecha Creacion    : 14/07/2011
Parametros:
  psCodigoPais        : codigo de pais
  psCodigoPeriodo     : Periodo de facturacion
  psCodigoMarca       : codigo de marca
  psCodigoCanal       : codigo de canal
  psCodigoSistema     : codigo de sistema para interfaz
  psCodigoInterfaz    : codigo de interfaz
  psNombreArchivo     : nombre que va a generar la interfaz
  psFechaFacturacion  : fecha de facturacion
  psIndModulo         : Indicador de modulo ( V=Ventas, I=Incentivos )

Autor: Sergio Apaza
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_CONTR
  (psCodigoPais 		   VARCHAR2,
   psCodigoPeriodo 		 VARCHAR2,
   psCodigoMarca 		   VARCHAR2,
   psCodigoCanal 		   VARCHAR2,
   psCodigoSistema 		 VARCHAR2,
   psCodigoInterfaz 	 VARCHAR2,
   psNombreArchivo 		 VARCHAR2,
   psFechaFacturacion  VARCHAR2,
   PSINDMODULO         VARCHAR2)
IS

  /* Definir Variables */
  lnOidPeriodo        CRA_PERIO.OID_PERI%TYPE;

  lnIdPais           SEG_PAIS.OID_PAIS%TYPE;
  lnIdCanal          SEG_CANAL.OID_CANA%TYPE;
  lnIdMarca          SEG_MARCA.OID_MARC%TYPE;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  /* Definir Cursores */
  CURSOR c_control
     IS
    SELECT PSCODIGOCANAL CODIGOCANAL,
           GECA.COD_PERI CODIGOPERIODO,
           TO_CHAR(GECA.FEC_FACT,'YYYYMMDD') fechaFacturacion
      FROM INT_TMP_GENER_SOLIC_CABEC GECA
     GROUP BY GECA.COD_PERI, GECA.FEC_FACT
     ORDER BY GECA.COD_PERI
      ;

  TYPE interfazRec IS RECORD
       (codigoCanal      SEG_CANAL.COD_CANA%TYPE,
        codigoPeriodo    SEG_PERIO_CORPO.COD_PERI%TYPE,
        fechaFacturacion VARCHAR2(8));

  TYPE interfazRecTab  IS TABLE OF interfazRec ;

  interfazRecord interfazRecTab;

BEGIN
  /* Instancia de Variables */

  lnOidPeriodo   := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2( PSCODIGOPERIODO );
  lbAbrirUtlFile := TRUE;

  /* Procedimiento inicial para generar interfaz */
  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(PSCODIGOPAIS, PSCODIGOSISTEMA, PSCODIGOINTERFAZ,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

  /* Generando Archivo de Texto (Detalle) */
  OPEN c_control;
    LOOP
    FETCH c_control BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

      /* Procedimiento inicial para generar interfaz */
      IF lbAbrirUtlFile THEN
        GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                              psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
        lbAbrirUtlFile := FALSE;
      END IF;

      IF interfazRecord.COUNT > 0 THEN
         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea := interfazRecord(x).codigoCanal    ||';'||
                        interfazRecord(x).codigoPeriodo  ||';'||
                        interfazRecord(x).fechaFacturacion;
             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
         END LOOP;
      END IF;
    EXIT WHEN c_control%NOTFOUND;
  END LOOP;
  CLOSE c_control;

  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_FECHA_CONTR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_FECHA_CONTR;

/*************************************************************************
Descripcion       : Genera Interfaz de Envio Control Cierres (DAT-36)
Fecha Creacion    : 25/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONTR_CIERR(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS

  CURSOR c_interfaz (vnIdPais NUMBER, vnIdMarca NUMBER, vnIdCanal NUMBER, lnIdPeriodo NUMBER, vdFechaUltimaActualizacion DATE) IS
   	SELECT pcor.cod_peri anioCampana,
           reg.cod_regi  codigoRegion,
           zon.cod_zona  codigoZona,
           '0'           flagImpresion,
           '0'           flagStatusFacturacion
      FROM (SELECT fcc.perd_oid_peri,
		               fcc.zorg_oid_regi,
		  	           COUNT(fcc.oid_ctrl)    num_proc_cier,
			             MAX(fcc.fec_ulti_actu) fec_ulti_actu
              FROM fac_contr_cierr fcc,
				           fac_tipos_cierr ftc
             WHERE fcc.perd_oid_peri = lnIdPeriodo
               AND fcc.pais_oid_pais = vnIdPais
               AND fcc.tcie_oid_tipo_cier = ftc.oid_tipo_cier
               AND fcc.val_resu_proc = 'OK'
               AND ftc.cod_tipo_cier = 'R'
             GROUP BY fcc.perd_oid_peri,
				              fcc.zorg_oid_regi ) cie_reg,
			     zon_zona zon,
           zon_regio reg,
			     cra_perio cper,
			     seg_perio_corpo pcor
     WHERE cie_reg.zorg_oid_regi = reg.oid_regi
       AND cie_reg.perd_oid_peri = cper.oid_peri
       AND cper.peri_oid_peri = pcor.oid_peri
       AND reg.oid_regi = zon.zorg_oid_regi
       AND reg.pais_oid_pais = vnIdPais
       AND reg.marc_oid_marc = vnIdMarca
       AND reg.cana_oid_cana = vnIdCanal
       AND zon.ind_acti = 1
       AND zon.ind_borr = 0
       AND cie_reg.num_proc_cier = (SELECT COUNT(fp.oid_proc_cier)
		                                  FROM fac_proce_cierr fp,
		  						                         fac_tipos_cierr ft
                                     WHERE fp.tcie_oid_tipo_cier = ft.oid_tipo_cier
			  					                     AND ft.cod_tipo_cier = 'R')
       AND cie_reg.fec_ulti_actu > vdFechaUltimaActualizacion;

  TYPE interfazRec IS RECORD(
    anioCampana	 		  	   seg_perio_corpo.cod_peri%TYPE,
    codigoRegion	 		     zon_regio.cod_regi%TYPE,
    codigoZona	 		       zon_zona.cod_zona%TYPE,
    flagImpresion	 		     VARCHAR2(1),
		flagStatusFacturacion	 VARCHAR2(1)
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle            UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile      BOOLEAN;

  lsLinea                     VARCHAR2(1000);
  lsNombreArchivo             VARCHAR2(50);
  lnIdPais   		              NUMBER;
  lnIdMarca 		              NUMBER;
  lnIdCanal                   NUMBER;
  lnIdPeriodo 		            NUMBER;
  ldFechaUltimaActualizacion  DATE;

BEGIN

	lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
	lnIdMarca      := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);
  lnIdCanal      := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);
	lnIdPeriodo    := gen_pkg_gener.gen_fn_devuelve_id_cra_perio2(psCodigoPeriodo);

	-- Se obtiene fecha ultima ejecucion correcta de la interfaz --
	SELECT MAX(fec_ipro)
    INTO ldFechaUltimaActualizacion
    FROM bas_histo_lotes
   WHERE pais_cod_pais = pscodigopais
     AND sist_cod_sist= pscodigosistema
     AND inte_cod_inte = pscodigointerfaz
     AND ind_loer ='N'
     AND fec_fpro IS NOT NULL;

  lbAbrirUtlFile := TRUE;

  /* Generando Archivo de Texto (Detalle) */
  OPEN c_interfaz (lnIdPais, lnIdMarca, lnIdCanal, lnIdPeriodo, ldFechaUltimaActualizacion);
	  LOOP
	    FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

			/* Procedimiento inicial para generar interfaz */
      IF lbAbrirUtlFile THEN
        GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                               psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
        lbAbrirUtlFile := FALSE;
      END IF;

      IF interfazRecord.COUNT > 0 THEN

        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		      lsLinea :=  interfazRecord(x).anioCampana             ||';'||
                      interfazRecord(x).codigoRegion            ||';'||
                      interfazRecord(x).codigoZona              ||';'||
                      interfazRecord(x).flagImpresion           ||';'||
                      interfazRecord(x).flagStatusFacturacion;

				  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		    END LOOP;

      ELSE
        lsLinea := 'XXXXXX'    ||';'||
                   ''          ||';'||
                   ''          ||';'||
                   ''          ||';'||
                   '';
        UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		  END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
	  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_CONTR_CIERR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CONTR_CIERR;

/************************************************************************************
Descripcion       : Genera interfaz de cabecera de pedidos para datamart (DAT-12)
Fecha Creacion    : 25/06/2012
Parametros: psCodigoPais       = Codigo de pais
            psCodigoPeriodo    = Periodo de facturacion
            psCodigoSistema    = Sistema de interfaz ( DAT )
            psCodigoInterfaz   = Codigo de interfaz ( DAT-12)
            psNombreArchivo    = Archivo de salida ( DAT-12-AAAAMMDDssss )
            psFechaFacturacion = Fecha de facturacion
            psCodigoAcceso     = Codigo de acceso
            psCodigoCanal      = Codigo de canal
Autor: CMori CSVD FFVV
*************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_BOLET_DESPA(
  psCodigoPais        VARCHAR2,
  psCodigoPeriodo     VARCHAR2,
  psCodigoSistema     VARCHAR2,
  psCodigoInterfaz    VARCHAR2,
  psNombreArchivo     VARCHAR2,
  psFechaFacturacion  VARCHAR2,
  psCodigoAcceso      VARCHAR2,
  psCodigoCanal       VARCHAR2)
IS

CURSOR c_Interfaz( lnIndCruce NUMBEr, lsProxiCampa VARCHAR2, lsFec_Proc VARCHAR2 ) IS
SELECT anioCampanaFacturacion,
            MIN(codigoCanal) codigocanal,
            MIN(codigoAcceso) codigoacceso,
            nroDocumentoFacturacion,
            MIN(codigoTerritorio) codigoterritorio,
            codigoCliente,
            MIN(fechaDocumento) fechadocumento,
            MAX(codigoClienteReceptor) codigoclientereceptor,
            MIN(flagAnulacion) flaganulacion,
            MIN(ventaFactura) ventafactura,
            MIN(montoFlete) montoflete,
            MIN(saldo) saldo,
            MIN(numeroClientes) numeroclientes,
--            MIN(codCanalIngreso) codcanalingreso, Ajuste HRG
            CASE WHEN MAX(codCanalIngreso) IS NOT NULL THEN MAX(codCanalIngreso) ELSE 'ND' END codcanalingreso,
            MIN(flagPRol) flagprol,
            MAX(fecprome) fecprome
 FROM
 (
    SELECT
           DECODE( geca.cod_pedi,'PR',geca.cod_peri_refe,geca.cod_peri ) anioCampanaFacturacion,
           DECODE( geca.cod_pedi,'PR',geca.cod_cana_refe,geca.cod_cana ) codigoCanal,
           DECODE( geca.cod_pedi,'PR',geca.cod_acce_refe,geca.cod_acce ) codigoAcceso,
           DECODE( geca.cod_pedi,'PR',geca.val_nume_soli_refe,geca.val_nume_soli ) nroDocumentoFacturacion,
           DECODE( geca.cod_pedi,'PR',geca.cod_terr_refe,geca.cod_terr ) codigoTerritorio,
           geca.cod_clie codigoCliente,
           DECODE(geca.cod_pedi,'PR',geca.fec_fact_refe,geca.fec_fact) fechaDocumento,
           CASE WHEN geca.cod_pedi in ('PN', 'PR') THEN 'N'
                     WHEN geca.cod_pedi ='PE' THEN 'E'
                    ELSE 'C'
            END codigoClienteReceptor,
           geca.ind_anul flagAnulacion,
           DECODE(geca.cod_pedi,'PR',geca.imp_vent_fact_refe,geca.imp_vent_fact) ventaFactura,
           DECODE(geca.cod_pedi,'PR',geca.imp_flet_refe,geca.imp_flet) montoFlete,
           clie.sal_deud_ante saldo,
           DECODE(geca.cod_pedi,'PR',geca.val_nume_clie_refe,geca.val_nume_clie) numeroClientes,
           DECODE(cain.cod_clie,NULL,geca.cod_cana_ingr,'MIX') codCanalIngreso,
           --DECODE(cain.cod_clie,NULL,geca.ind_rese_onli,0) flagPRol,
           DECODE(cain.cod_clie,NULL,CASE WHEN  ind_rese_onli NOT IN ('0','1') THEN '0' ELSE ind_rese_onli END,0) flagPRol,
           (SELECT max(segped.FEC) FROM ped_segui_pedid segped
             WHERE DECODE( geca.cod_pedi,'PR',geca.soca_oid_soli_cabe_refe,geca.soca_oid_soli_cabe )
                        =segped.soca_oid_soli_cabe) fecprome
      FROM int_tmp_gener_solic_cabec geca,
           mae_clien clie,
           (
            SELECT temp.cod_clie,
                   temp.cod_pedi,
                   COUNT(*) val_nume_regi
              FROM int_tmp_gener_solic_cabec temp
             WHERE temp.cod_pedi = 'PN'
             GROUP BY temp.cod_clie, temp.cod_pedi
            HAVING COUNT(*) > 1
           ) cain -- Nuevo
      WHERE geca.cod_clie = clie.cod_clie
       AND geca.cod_clie = cain.cod_clie(+)
        --
        AND geca.fec_fact <= TO_DATE(psfechafacturacion,'DD/MM/YYYY')
        AND psfechafacturacion = lsFec_Proc
       AND ( geca.cod_peri = pscodigoPeriodo OR (lnIndCruce = 0 AND geca.cod_peri = lsProxiCampa ))
       )
       GROUP BY anioCampanaFacturacion, nroDocumentoFacturacion, codigoCliente;


TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;
lsLinea         VARCHAR2(1000);
lsNombreArchivo VARCHAR2(50);
--
lnIndCruce      CRA_PERIO.Ind_Peri_Cruc%TYPE;
lsProxiCampa    SEG_PERIO_CORPO.Cod_Peri%TYPE;
lnIdCampa       CRA_PERIO.Oid_Peri%TYPE;
lsFec_proc      INT_TMP_DATAM_CTROL.FEC_PROC%TYPE;

BEGIN
  lbAbrirUtlFile := TRUE;
  lnIdCampa      := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2( psCodigoPeriodo );
  lsProxiCampa   := GEN_FN_CALCU_PERIO( psCodigoPeriodo, 1 );

  SELECT perd.ind_peri_cruc
    INTO lnIndCruce
    FROM cra_perio perd
   WHERE perd.oid_peri = lnIdCampa;

  SELECT max(FEC_PROC) INTO lsfec_proc FROM INT_TMP_DATAM_CTROL   ;

  -- Procedimiento inicial para generar interfaz
  IF lbAbrirUtlFile THEN
  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
     lbAbrirUtlFile := FALSE;
  END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz(lnIndCruce,lsProxiCampa, lsfec_proc);
    LOOP

      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      IF interfazRecord.COUNT > 0 THEN
         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

             lslinea := interfazrecord(x).anioCampanaFacturacion             ||';'||
                        interfazrecord(x).codigoCanal                        ||';'||
                        interfazrecord(x).codigoAcceso                       ||';'||
                        interfazrecord(x).nroDocumentoFacturacion            ||';'||
                        interfazrecord(x).codigoTerritorio                   ||';'||
                        CASE WHEN LENGTH( interfazrecord(x).codigoCliente ) > 10 THEN
                                  SUBSTR( interfazrecord(x).codigoCliente,
                                          LENGTH(interfazrecord(x).codigoCliente)-9,
                                          LENGTH(interfazrecord(x).codigoCliente) )
                             ELSE interfazrecord(x).codigoCliente
                        END                                                  ||';'||
                        TO_CHAR(interfazrecord(x).fechaDocumento,'YYYYMMDD') ||';'||
                        interfazrecord(x).codigoClienteReceptor              ||';'||
                        interfazrecord(x).flagAnulacion                      ||';'||
                        TRIM( TO_CHAR( NVL( interfazrecord(x).ventaFactura,0 ),'999999999990.99') ) ||';'||
                        TRIM( TO_CHAR( NVL( interfazrecord(x).montoFlete,0 ),'999999999990.99') )   ||';'||
                        TRIM( TO_CHAR( NVL( interfazrecord(x).saldo,0 ),'999999999990.99') )        ||';'||
                        interfazrecord(x).numeroClientes                                            ||';'||
                        interfazrecord(x).codCanalIngreso                                           ||';'||
                        interfazrecord(x).flagPRol                                                  ||';'||
                        TO_CHAR(interfazrecord(x).fecprome,'YYYYMMDD');

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

              END LOOP;
            END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     UTL_FILE.FCLOSE(V_HANDLE);
    GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_BOLET_DESPA: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_BOLET_DESPA;

/****************************************************************************
Descripcion       : Genera interfaz de cabecera de pedidos para datamart (DAT-24)
Fecha Creacion    : 25/06/2012
Parametros: psCodigoPais       = Codigo de pais
            psCodigoPeriodo    = Periodo de facturacion
            psCodigoSistema    = Sistema de interfaz ( DAT )
            psCodigoInterfaz   = Codigo de interfaz ( DAT-24)
            psNombreArchivo    = Archivo de salida ( DAT-24-AAAAMMDDssss )
            psFechaFacturacion = Fecha de facturacion
Autor: CMori CSVD FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRANS_CLIEN(
  psCodigoPais      VARCHAR2,
  psCodigoPeriodo   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFacturacion  VARCHAR2)
IS
CURSOR c_Interfaz( lnIndCruce NUMBEr, lsProxiCampa VARCHAR2, lsfec_proc VARCHAR2 ) IS
    SELECT geca.cod_peri anioCampaniaFacturacion,
           DECODE( geca.cod_pedi, 'PR', geca.cod_cana_refe, geca.cod_cana ) codigoCanalVenta,
           DECODE( geca.cod_pedi, 'PR', geca.cod_acce_refe, geca.cod_acce ) codigoAcceso,
           DECODE(gede.oid_deta_ofer_equi, NULL, gede.cod_prod, gede.cod_prod_equi ) codigoProducto,
           DECODE( geca.cod_pedi, 'PR', geca.cod_terr_refe, geca.cod_terr) codigoTerritorio,
           geca.cod_clie codigoConsultora,
           DECODE( gede.oid_deta_ofer_equi, NULL, gede.cod_tipo_ofert, gede.cod_tipo_ofert_equi ) codigoTipoOferta,
           DECODE( geca.cod_pedi, 'PR', geca.val_nume_soli_refe, geca.val_nume_soli) numeroSolicitud,
           DECODE( gede.oid_deta_ofer_equi, NULL, gede.val_codi_vent, gede.val_codi_vent_equi ) codigoVenta,
           gede.cod_peri_refe anioCampaniaVenta,
           geca.fec_fact fechaFacturacion,
           MAX(gede.val_porc_desc) val_porc_desc,
           SUM( gede.num_unid_vent ) unidadesAtendidas,
           SUM( gede.num_unid_falt ) unidadesNoAtendidas,
           SUM( gede.num_unid_devo ) unidadesDevueltas,
           SUM( gede.num_unid_anul ) unidadesAnuladas,
           SUM( gede.imp_neto_vent ) ventaNeta,
           SUM( gede.pre_fact_tota_loca ) ventaFactura,
           SUM( gede.imp_neto_falt ) ventaNetaFaltante,
           SUM( gede.imp_neto_devo ) valorNetoDevoluciones,
           SUM( gede.imp_neto_anul ) valorNetoAnulaciones,
           MAX(CASE WHEN geca.cod_pedi in ('PN', 'PR') THEN 'N'
                     WHEN geca.cod_pedi ='PE' THEN 'E'
                    ELSE 'C'
            END) tipoDocumento,
           SUM( gede.imp_opor_ahor ) oportunidadAhorro,
           SUM( gede.num_unid_reto ) unidadesRetorno,
           SUM( gede.num_unid_aten ) unidadesAtencion,
           SUM( gede.imp_neto_reto ) montoNetoRetorno,
           SUM( gede.imp_neto_aten ) montoNetoAtencion
      FROM int_tmp_gener_solic_cabec geca,
           int_tmp_gener_solic_detal gede
     WHERE geca.oid_soli_cabe = gede.oid_soli_cabe
       AND geca.cod_peri_refe = gede.cod_peri_refe
       --
       AND geca.fec_fact <= TO_DATE(psfechafacturacion,'DD/MM/YYYY')
       AND psfechafacturacion = lsFec_Proc
       AND ( geca.cod_peri = pscodigoPeriodo OR
             lnIndCruce = 0 AND geca.cod_peri = lsProxiCampa )
     GROUP BY
            geca.cod_peri,
           DECODE( geca.cod_pedi, 'PR', geca.cod_cana_refe, geca.cod_cana ),
           DECODE( geca.cod_pedi, 'PR', geca.cod_acce_refe, geca.cod_acce ),
              DECODE(gede.oid_deta_ofer_equi, NULL, gede.cod_prod, gede.cod_prod_equi ),
           DECODE( geca.cod_pedi, 'PR', geca.cod_terr_refe, geca.cod_terr),
              geca.cod_clie,
              DECODE( gede.oid_deta_ofer_equi, NULL, gede.cod_tipo_ofert, gede.cod_tipo_ofert_equi ),
           DECODE( geca.cod_pedi, 'PR', geca.val_nume_soli_refe, geca.val_nume_soli),
              DECODE( gede.oid_deta_ofer_equi, NULL, gede.val_codi_vent, gede.val_codi_vent_equi ),
           gede.cod_peri_refe,
           geca.fec_fact;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;
lsLinea         VARCHAR2(1000);
lsNombreArchivo VARCHAR2(50);
--
lnIndCruce      CRA_PERIO.Ind_Peri_Cruc%TYPE;
lsProxiCampa    SEG_PERIO_CORPO.Cod_Peri%TYPE;
lnIdCampa       CRA_PERIO.Oid_Peri%TYPE;
lsFec_proc      INT_TMP_DATAM_CTROL.FEC_PROC%TYPE;

BEGIN
  lbAbrirUtlFile := TRUE;
  lnIdCampa      := GEN_PKG_GENER.GEN_FN_DEVUELVE_ID_CRA_PERIO2( psCodigoPeriodo );
  lsProxiCampa   := GEN_FN_CALCU_PERIO( psCodigoPeriodo, 1 );

  SELECT perd.ind_peri_cruc
    INTO lnIndCruce
    FROM cra_perio perd
   WHERE perd.oid_peri = lnIdCampa;

  SELECT max(FEC_PROC) INTO lsfec_proc FROM INT_TMP_DATAM_CTROL   ;

  -- Procedimiento inicial para generar interfaz
  IF lbAbrirUtlFile THEN
  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
     lbAbrirUtlFile := FALSE;
  END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz(lnIndCruce,lsProxiCampa,lsfec_proc);
      LOOP

      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      IF interfazRecord.COUNT > 0 THEN

         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

             lsLinea := interfazRecord(x).anioCampaniaFacturacion              ||';'||
                        interfazRecord(x).codigoCanalVenta                     ||';'||
                        interfazRecord(x).codigoAcceso                         ||';'||
                        interfazRecord(x).codigoProducto                       ||';'||
                        interfazRecord(x).codigoTerritorio                     ||';'||
                        CASE WHEN LENGTH( interfazrecord(x).codigoConsultora ) > 10 THEN
                                  SUBSTR( interfazrecord(x).codigoConsultora,
                                          LENGTH(interfazrecord(x).codigoConsultora)-9,
                                          LENGTH(interfazrecord(x).codigoConsultora) )
                             ELSE interfazrecord(x).codigoConsultora
                        END                                                    ||';'||
                        interfazRecord(x).codigoTipoOferta                     ||';'||
                        interfazRecord(x).numeroSolicitud                      ||';'||
                        interfazRecord(x).codigoVenta                          ||';'||
                        interfazRecord(x).anioCampaniaVenta                    ||';'||
                        TO_CHAR(interfazRecord(x).fechaFacturacion,'YYYYMMDD') ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesAtendidas,0),'999999999990'))        ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesNoAtendidas,0),'999999999990'))      ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesDevueltas,0),'999999999990'))        ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesAnuladas,0),'999999999990'))         ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).ventaNeta,0),'999999999990.00'))             ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).ventaFactura,0),'999999999990.00'))          ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).ventaNetaFaltante,0),'999999999990.00'))     ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).valorNetoDevoluciones,0),'999999999990.00')) ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).valorNetoAnulaciones,0),'999999999990.00'))  ||';'||
                        interfazRecord(x).tipoDocumento                                                 ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).oportunidadAhorro,0),'999999999990.00'))     ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesRetorno,0),'999999999990'))          ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).unidadesAtencion,0),'999999999990'))         ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).montoNetoRetorno,0),'999999999990.00'))      ||';'||
                        TRIM(TO_CHAR(NVL(interfazRecord(x).montoNetoAtencion,0),'999999999990.00'))     ||';'||
                        interfazRecord(x).val_porc_desc;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;

      END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
    IF NOT lbAbrirUtlFile THEN
      utl_file.fclose(V_HANDLE);
      GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TRANS_CLIEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TRANS_CLIEN;

/*************************************************************************
  Descripcion       : Genera Interfaz de Envio Control Cierres (DAT-117)
Fecha Creacion    : 25/07/2011
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jose Luis Rodriguez
***************************************************************************/
PROCEDURE INT_PR_LET_ENVIO_PROYE_PROGR
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS

  CURSOR c_interfaz IS
    SELECT psCodigoPeriodo AS AnioCampana,
           lmlc.conc_cod_conc AS CodPrograma,
           lmlc.cod_lide AS CodLider,
           LPAD(lmlc.nico_nive_conc,2,'0') AS CodNivelProg,
             lmlc.obj_acum AS MetaPedidoBase,
           lmlc.met_pedi AS MetaNivelPedido
      FROM let_metas_lider_concu lmlc,
           let_param_concu_lider lpcl
     WHERE lmlc.pais_cod_pais = lpcl.pais_cod_pais
       AND lmlc.conc_cod_conc = lpcl.cod_conc
       AND psCodigoPeriodo BETWEEN lpcl.cam_inic AND lpcl.cam_fina;

  TYPE interfazRec IS RECORD(
    AnioCampana	 		let_metas_lider_concu.cam_inic%TYPE,
    CodPrograma	 		let_metas_lider_concu.conc_cod_conc%TYPE,
    CodLider	 		  let_metas_lider_concu.cod_lide%TYPE,
    CodNivelProg	 	VARCHAR2(2),
		MetaPedidoBase	let_metas_lider_concu.met_pedi%TYPE,
		MetaNivelPedido	let_metas_lider_concu.met_pedi%TYPE
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle            UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile      BOOLEAN;

  lsLinea                     VARCHAR2(1000);
  lsNombreArchivo             VARCHAR2(50);

BEGIN

  lbAbrirUtlFile := TRUE;

  /* Generando Archivo de Texto (Detalle) */
  OPEN c_interfaz;
	  LOOP
	    FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

			/* Procedimiento inicial para generar interfaz */
      IF lbAbrirUtlFile THEN
        GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                               psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
        lbAbrirUtlFile := FALSE;
      END IF;

      IF interfazRecord.COUNT > 0 THEN

        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		      lsLinea :=  interfazRecord(x).AnioCampana             ||';'||
                      interfazRecord(x).CodPrograma            ||';'||
                      interfazRecord(x).CodLider              ||';'||
                      interfazRecord(x).CodNivelProg           ||';'||
                      interfazRecord(x).MetaPedidoBase           ||';'||
                      interfazRecord(x).MetaNivelPedido;

				  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		    END LOOP;
		  END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
	  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_CONTR_CIERR: '||ls_sqlerrm);
END INT_PR_LET_ENVIO_PROYE_PROGR;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Canal de Ingreso del Pedido (DAT-119)
Fecha Creacion    : 27/03/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAL_PEDID
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS
CURSOR c_Interfaz IS
      SELECT 'CC' AS codCanalIngreso, 'CALL CENTER' AS desCanalIngreso FROM DUAL UNION
      SELECT 'DD' AS codCanalIngreso, 'DIGITACION DISTRIBUIDA' AS desCanalIngreso FROM DUAL UNION
      SELECT 'SC' AS codCanalIngreso, 'SISTEMA COMERCIAL' AS desCanalIngreso FROM DUAL UNION
      SELECT 'IVR' AS codCanalIngreso, 'VOZ' AS desCanalIngreso FROM DUAL UNION
      select 'SMS' as CODCANALINGRESO, 'SMS' as DESCANALINGRESO from DUAL union
      SELECT 'OCR' AS codCanalIngreso, 'OCR' AS desCanalIngreso FROM DUAL UNION
      SELECT 'OL' AS codCanalIngreso, 'ONLINE' AS desCanalIngreso FROM DUAL UNION
      SELECT 'WEB' AS codCanalIngreso, 'WEB' AS desCanalIngreso FROM DUAL UNION
      SELECT 'ND' AS codCanalIngreso, 'OTROS' AS desCanalIngreso FROM DUAL UNION
      SELECT 'CM' AS codCanalIngreso, 'CAPTURA MANUAL' AS desCanalIngreso FROM DUAL UNION
      select 'FAX' as CODCANALINGRESO, 'FAX' as DESCANALINGRESO from DUAL union
      SELECT 'MIX' AS codCanalIngreso, 'MIXTO SIN WEB' AS desCanalIngreso FROM DUAL UNION
      SELECT 'WMX' AS codCanalIngreso, 'MIXTO CON WEB' AS desCanalIngreso FROM DUAL;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;

lsLinea                     VARCHAR2(1000);
lsNombreArchivo             VARCHAR2(50);

-- Variables de Control
ln_sqlcode NUMBER(10);
ls_sqlerrm VARCHAR2(1500);
w_filas    NUMBER := 50000;

BEGIN
  lbAbrirUtlFile := TRUE;

  -- Procedimiento inicial para generar interfaz
  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord;

      IF interfazRecord.COUNT > 0 THEN
        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
          lsLinea :=  interfazRecord(x).codCanalIngreso ||';'||
                      interfazRecord(x).desCanalIngreso;

          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  -- Procedimiento final para generar interfaz
  utl_file.fclose(V_HANDLE);
  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_CANAL_PEDID: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CANAL_PEDID;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Impuestos ICE (DAT-118)
Fecha Creacion    : 02/04/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Jesse James Rios Franco
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_IMPUE(
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS
  CURSOR c_Interfaz(vnIdPais NUMBER,vnIdMarca NUMBER,vnIdCanal NUMBER,vnIdPeriodo NUMBER, vnIdTipoCierre NUMBER) IS
    SELECT
           H.COD_SAP,
           J.COD_TIPO_OFER,
           E.VAL_CODI_VENT CUV,
           l.cod_peri,
           TO_CHAR (A.FEC_FACT, 'yyyymm') MES,
           NVL (o.cod_peri, l.cod_peri) Periodo_REF,
           SUM
              (ABS(CASE
                  WHEN (
                  pt.num_unid_vend = 1
                  AND d.ind_oc = 1
                  AND e.val_prec_cata_unit_loca <> 0
                  )
                 THEN
                    NVL (b.imp_impu_tota_prod_naci, 0)
                 ELSE
                    0
              END)) AS ICE_VENTAS,
          SUM
                  (ABS(CASE
                      WHEN pt.num_unid_devu = 1
                      AND e.val_prec_cata_unit_loca <> 0
                         THEN
                              NVL (b.imp_impu_tota_prod_naci, 0)
                      ELSE 0
                   END
                  )) AS ICE_Devoluciones,
          SUM
                  (ABS(CASE
                      WHEN pt.num_unid_anul = 1
                      AND e.val_prec_cata_unit_loca <> 0
                         THEN
                              NVL (b.imp_impu_tota_prod_naci, 0)
                      ELSE 0
                   END
                  )) AS ICE_Anulaciones,
          SUM
                  (ABS(CASE
                      WHEN pt.num_unid_canj = 1
                      AND e.val_prec_cata_unit_loca <> 0
                         THEN
                              NVL (b.imp_impu_tota_prod_naci, 0)
                      ELSE 0
                   END
                  )) AS ICE_Retornos,
          SUM
                  (ABS(CASE
                      WHEN pt.num_unid_true = 1
                      AND e.val_prec_cata_unit_loca <> 0
                         THEN
                              NVL (b.imp_impu_tota_prod_naci, 0)
                      ELSE 0
                   END
                  )) AS ICE_Atenciones
      FROM fac_docum_conta_cabec a,
           fac_docum_conta_linea b,
           ped_solic_cabec c,
           ped_solic_cabec d,
           ped_solic_posic e,
           ped_tipo_solic_pais f,
           ped_tipo_solic g,
           mae_produ h,
           pre_ofert_detal i,
           pre_tipo_ofert j,
           cra_perio k,
           seg_perio_corpo l,
           ped_solic_cabec m,
           cra_perio n,
           seg_perio_corpo o,
           int_param_tipo_solic pt
     WHERE     a.oid_cabe = b.dcca_oid_cabe
           AND A.SOCA_OID_SOLI_CABE = C.OID_SOLI_CABE
           AND C.OID_SOLI_CABE = D.SOCA_OID_SOLI_CABE
           AND D.OID_SOLI_CABE = E.SOCA_OID_SOLI_CABE
           AND E.OID_SOLI_POSI = B.SOPO_OID_SOLI_POSI
           AND D.TSPA_OID_TIPO_SOLI_PAIS = F.OID_TIPO_SOLI_PAIS
           AND F.TSOL_OID_TIPO_SOLI = G.OID_TIPO_SOLI
           AND B.IMP_IMPU_TOTA_PROD_NACI IS NOT NULL
           AND D.PERD_OID_PERI = vnIdPeriodo -- Parametro
           AND E.PROD_OID_PROD = H.OID_PROD
           AND E.OFDE_OID_DETA_OFER = I.OID_DETA_OFER
           AND I.TOFE_OID_TIPO_OFER = J.OID_TIPO_OFER
           AND A.PERD_OID_PERI = K.OID_PERI
           AND K.PERI_OID_PERI = L.OID_PERI
           AND D.SOCA_OID_DOCU_REFE = M.OID_SOLI_CABE(+)
           AND M.PERD_OID_PERI = N.OID_PERI(+)
           AND N.PERI_OID_PERI = O.OID_PERI(+)
           AND pt.tspa_oid_tipo_soli_pais = f.oid_tipo_soli_pais
          AND d.ind_ts_no_conso = 1
          AND d.ind_pedi_prue = 0
          AND e.espo_oid_esta_posi <> 2
          AND (   (    pt.num_unid_vend = 1
                AND g.ind_anul = 0
                AND g.ind_devo = 0
                AND d.ind_oc = 1
               )
            OR (    (   pt.num_unid_devu = 1
                     OR pt.num_unid_anul = 1
                     OR pt.num_unid_canj = 1
                     OR pt.num_unid_true = 1
                    )
                AND fn_dat_validar_prod_soli_devo (d.oid_soli_cabe,
                                                   e.oid_soli_posi
                                                  ) > 0
               )
           )
  GROUP BY H.COD_SAP,
           J.COD_TIPO_OFER,
           E.VAL_CODI_VENT,
           l.cod_peri,
           TO_CHAR (A.FEC_FACT, 'yyyymm'),
           NVL (o.cod_peri, l.cod_peri);

  TYPE interfazRec IS RECORD(
    codigoSap 	 		  mae_produ.COD_SAP%TYPE,
    codigoTipoOferta	pre_tipo_ofert.Cod_Tipo_Ofer%TYPE,
    cuv	 		          ped_solic_posic.VAL_CODI_VENT%TYPE,
    codigoPeriodo	 	  seg_perio_corpo.Cod_Peri%TYPE,
		mes	              VARCHAR2(6),
		codigoPeriodoRef	seg_perio_corpo.Cod_Peri%TYPE,
    iceVentas         fac_docum_conta_linea.imp_impu_tota_prod_naci%TYPE,
    iceDevoluciones   fac_docum_conta_linea.imp_impu_tota_prod_naci%TYPE,
    iceAnulaciones    fac_docum_conta_linea.imp_impu_tota_prod_naci%TYPE,
    iceRetornos       fac_docum_conta_linea.imp_impu_tota_prod_naci%TYPE,
    iceAtenciones     fac_docum_conta_linea.imp_impu_tota_prod_naci%TYPE
	);

  TYPE c_Interfaz_t IS TABLE OF interfazRec;
  interfazRecord c_Interfaz_t;

  CURSOR C_IMPUESTOS_CONSOLIDADOS IS
  SELECT COD_SAP codigosap,
         COD_TIPO_OFER codigotipooferta,
         CUV,
         COD_PERI codigoPeriodo,
         MES,
         Periodo_REF codigoPeriodoref,
         SUM(ICE_VENTAS) iceventas,
         SUM(ICE_DEVOLUCIONES) icedevoluciones,
         SUM(ICE_ANULACIONES) iceanulaciones,
         SUM(ICE_RETORNOS) iceretornos,
         SUM(ICE_ATENCIONES) iceatenciones
  FROM DAT_GTT_IMPUE_ICE_CONSO
  GROUP BY COD_SAP,COD_TIPO_OFER,CUV,COD_PERI,MES,Periodo_REF;

  TYPE impuestosConsolidadosTab IS TABLE OF C_IMPUESTOS_CONSOLIDADOS%ROWTYPE INDEX BY BINARY_INTEGER;
  impuestosConsolidadosRecord impuestosConsolidadosTab;

  -- Variables usadas para la generacion del archivo de texto
  lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
  V_HANDLE        UTL_FILE.FILE_TYPE;

  lsLinea                     VARCHAR2(1000);
  lsNombreArchivo             VARCHAR2(50);

  -- Variables de Control
  ln_sqlcode NUMBER(10);
  ls_sqlerrm VARCHAR2(1500);
  w_filas    NUMBER := 50000;

  vsIndImpuestoAdici bas_param_pais.val_para%TYPE;
  lnIdTipoCierre fac_tipos_cierr.Oid_Tipo_Cier%TYPE;
  lnIdPais            NUMBER;
  lnIdPeriodo         NUMBER;
  lnIdMarca           NUMBER;
  lnIdCanal           NUMBER;
  lbAbrirUtlFile      BOOLEAN;
  vnIndEqui           BAS_PAIS.IND_EQUI%TYPE;
  vnEncotroDataEquiva NUMBER;
  vnEncontroCUV       NUMBER;
  vbGeneroArchivo     BOOLEAN;

BEGIN

  /* obteniendo id's */
  lnIdPais    := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);-- id del pais consultante
  lnIdMarca   := gen_pkg_gener.gen_fn_devuelve_id_marca(psCodigoMarca);-- id del marca consultante
  lnIdCanal   := gen_pkg_gener.gen_fn_devuelve_id_canal(psCodigoCanal);-- id del canal consultante
  lnIdPeriodo := gen_pkg_gener.GEN_FN_DEVUELVE_ID_CRA_PERIO2(psCodigoPeriodo);-- id del Periodo consultante

  BEGIN
    SELECT 1
  INTO vsIndImpuestoAdici
    FROM fac_contr_cierr fcc,
         fac_tipos_cierr ftc,
         cra_perio cpe
    WHERE ROWNUM = 1
    AND fcc.perd_oid_peri = cpe.oid_peri
    AND cpe.peri_oid_peri = GEN_PKG_GENER.gen_fn_devuelve_id_perio(psCodigoPeriodo)
    AND fcc.tcie_oid_tipo_cier = ftc.oid_tipo_cier
    AND FTC.COD_TIPO_CIER = 'P'
    AND (SELECT papa.val_para
  FROM bas_param_pais papa
         WHERE papa.cod_pais =  psCodigoPais
  AND papa.cod_sist = 'SAB'
         AND papa.cod_para = '001') = 1;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      vsIndImpuestoAdici := 0;
  END;

  SELECT IND_EQUI
  INTO vnIndEqui
  FROM BAS_PAIS
  WHERE COD_PAIS = psCodigoPais;

  select COUNT(1)
  INTO vnEncotroDataEquiva
  from pre_matri_factu_cabec a,
       pre_ofert b,
       pre_ofert_detal c,
       pre_matri_factu d,
       cra_perio e,
       seg_perio_corpo f,
       pre_ofert_detal g,
       pre_matri_factu h,
       pre_matri_codig_alter i,
       mae_produ j,
       mae_produ k,
       gen_i18n_sicc_pais l,
       gen_i18n_sicc_pais m,
       pre_tipo_ofert t,
       pre_tipo_ofert u,
       pre_prod_alter_ice equi
  where a.OID_CABE=b.MFCA_OID_CABE
  and b.OID_OFER=c.OFER_OID_OFER
  and c.OID_DETA_OFER=d.OFDE_OID_DETA_OFER
  and a.PERD_OID_PERI=e.OID_PERI
  and i.MAFA_OID_COD_PPAL=d.OID_MATR_FACT
  and i.MAFA_OID_COD_ALTE=h.OID_MATR_FACT
  and h.OFDE_OID_DETA_OFER=g.OID_DETA_OFER
  and f.OID_PERI=e.PERI_OID_PERI
  and c.PROD_OID_PROD=j.OID_PROD
  and j.OID_PROD=l.VAL_OID
  and l.ATTR_ENTI='MAE_PRODU'
  and g.PROD_OID_PROD=k.OID_PROD
  and k.OID_PROD=m.VAL_OID
  and m.ATTR_ENTI='MAE_PRODU'
  and g.tofe_oid_tipo_ofer=t.oid_tipo_ofer
  and c.tofe_oid_tipo_ofer=u.oid_tipo_ofer
  and j.COD_SAP = equi.COD_SAP_PPAL
  and f.COD_PERI = psCodigoPeriodo;

  -- Procedimiento inicial para generar interfaz
  GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,
                                         psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
  vbGeneroArchivo := FALSE;
  IF vsIndImpuestoAdici = 1 THEN

     IF vnIndEqui = 0 OR vnEncotroDataEquiva = 0 THEN

       OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo,lnIdTipoCierre);
         LOOP
          FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

          IF interfazRecord.COUNT > 0 THEN
            FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
              lsLinea :=  interfazRecord(x).codigoSap          ||';'||
                          interfazRecord(x).codigoTipoOferta   ||';'||
                          interfazRecord(x).cuv                ||';'||
                          interfazRecord(x).codigoPeriodo      ||';'||
                          interfazRecord(x).mes                ||';'||
                          interfazRecord(x).codigoPeriodoRef   ||';'||
                          interfazRecord(x).iceVentas          ||';'||
                          interfazRecord(x).iceDevoluciones    ||';'||
                          interfazRecord(x).iceAnulaciones     ||';'||
                          interfazRecord(x).iceRetornos        ||';'||
                          interfazRecord(x).iceAtenciones;

              UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
            END LOOP;
          END IF;
          EXIT WHEN c_interfaz%NOTFOUND;
         END LOOP;
       CLOSE c_interfaz;

       vbGeneroArchivo := TRUE;

     ELSE

       OPEN c_interfaz(lnIdPais,lnIdMarca,lnIdCanal,lnIdPeriodo,lnIdTipoCierre);
         LOOP
          FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

          IF interfazRecord.COUNT > 0 THEN
            FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

              select COUNT(1)
              into vnEncontroCUV
              from pre_matri_factu_cabec a,
                   pre_ofert b,
                   pre_ofert_detal c,
                   pre_matri_factu d,
                   cra_perio e,
                   seg_perio_corpo f,
                   pre_ofert_detal g,
                   pre_matri_factu h,
                   pre_matri_codig_alter i,
                   mae_produ j,
                   mae_produ k,
                   gen_i18n_sicc_pais l,
                   gen_i18n_sicc_pais m,
                   pre_tipo_ofert t,
                   pre_tipo_ofert u,
                   pre_prod_alter_ice equi
              where a.OID_CABE=b.MFCA_OID_CABE
              and b.OID_OFER=c.OFER_OID_OFER
              and c.OID_DETA_OFER=d.OFDE_OID_DETA_OFER
              and a.PERD_OID_PERI=e.OID_PERI
              and i.MAFA_OID_COD_PPAL=d.OID_MATR_FACT
              and i.MAFA_OID_COD_ALTE=h.OID_MATR_FACT
              and h.OFDE_OID_DETA_OFER=g.OID_DETA_OFER
              and f.OID_PERI=e.PERI_OID_PERI
              and c.PROD_OID_PROD=j.OID_PROD
              and j.OID_PROD=l.VAL_OID
              and l.ATTR_ENTI='MAE_PRODU'
              and g.PROD_OID_PROD=k.OID_PROD
              and k.OID_PROD=m.VAL_OID
              and m.ATTR_ENTI='MAE_PRODU'
              and g.tofe_oid_tipo_ofer=t.oid_tipo_ofer
              and c.tofe_oid_tipo_ofer=u.oid_tipo_ofer
              and j.COD_SAP = equi.COD_SAP_PPAL
              and f.COD_PERI = interfazRecord(x).codigoPeriodoRef
              and g.VAL_CODI_VENT = interfazRecord(x).cuv;

              IF vnEncontroCUV > 0 THEN

                  select DISTINCT c.VAL_CODI_VENT CUV_ORIGINAL,
                         j.COD_SAP PRODUCTO,
                         u.COD_TIPO_OFER
                  into   interfazRecord(x).cuv,
                         interfazRecord(x).codigoSap,
                         interfazRecord(x).codigoTipoOferta
                  from pre_matri_factu_cabec a,
                       pre_ofert b,
                       pre_ofert_detal c,
                       pre_matri_factu d,
                       cra_perio e,
                       seg_perio_corpo f,
                       pre_ofert_detal g,
                       pre_matri_factu h,
                       pre_matri_codig_alter i,
                       mae_produ j,
                       mae_produ k,
                       gen_i18n_sicc_pais l,
                       gen_i18n_sicc_pais m,
                       pre_tipo_ofert t,
                       pre_tipo_ofert u,
                       pre_prod_alter_ice equi
                  where a.OID_CABE=b.MFCA_OID_CABE
                  and b.OID_OFER=c.OFER_OID_OFER
                  and c.OID_DETA_OFER=d.OFDE_OID_DETA_OFER
                  and a.PERD_OID_PERI=e.OID_PERI
                  and i.MAFA_OID_COD_PPAL=d.OID_MATR_FACT
                  and i.MAFA_OID_COD_ALTE=h.OID_MATR_FACT
                  and h.OFDE_OID_DETA_OFER=g.OID_DETA_OFER
                  and f.OID_PERI=e.PERI_OID_PERI
                  and c.PROD_OID_PROD=j.OID_PROD
                  and j.OID_PROD=l.VAL_OID
                  and l.ATTR_ENTI='MAE_PRODU'
                  and g.PROD_OID_PROD=k.OID_PROD
                  and k.OID_PROD=m.VAL_OID
                  and m.ATTR_ENTI='MAE_PRODU'
                  and g.tofe_oid_tipo_ofer=t.oid_tipo_ofer
                  and c.tofe_oid_tipo_ofer=u.oid_tipo_ofer
                  and j.COD_SAP = equi.COD_SAP_PPAL
                  and f.COD_PERI = interfazRecord(x).codigoPeriodoRef
                  and g.VAL_CODI_VENT = interfazRecord(x).cuv;

              END IF;

              INSERT INTO DAT_GTT_IMPUE_ICE_CONSO VALUES interfazRecord(x);

            END LOOP;
          END IF;
          EXIT WHEN c_interfaz%NOTFOUND;
         END LOOP;
       CLOSE c_interfaz;

     END IF;

     IF NOT vbGeneroArchivo THEN
      OPEN C_IMPUESTOS_CONSOLIDADOS;

      LOOP
        FETCH C_IMPUESTOS_CONSOLIDADOS BULK COLLECT INTO impuestosConsolidadosRecord LIMIT W_FILAS;

        IF impuestosConsolidadosRecord.COUNT > 0 THEN

           FOR i IN impuestosConsolidadosRecord.FIRST .. impuestosConsolidadosRecord.LAST LOOP
               lsLinea := impuestosConsolidadosRecord(i).codigoSap          ||';'||
                          impuestosConsolidadosRecord(i).codigoTipoOferta   ||';'||
                          impuestosConsolidadosRecord(i).cuv                ||';'||
                          impuestosConsolidadosRecord(i).codigoPeriodo      ||';'||
                          impuestosConsolidadosRecord(i).mes                ||';'||
                          impuestosConsolidadosRecord(i).codigoPeriodoRef   ||';'||
                          impuestosConsolidadosRecord(i).iceVentas          ||';'||
                          impuestosConsolidadosRecord(i).iceDevoluciones    ||';'||
                          impuestosConsolidadosRecord(i).iceAnulaciones     ||';'||
                          impuestosConsolidadosRecord(i).iceRetornos        ||';'||
                          impuestosConsolidadosRecord(i).iceAtenciones;

              UTL_FILE.PUT_LINE (V_HANDLE, lslinea);
           END LOOP;

        END IF;

        EXIT WHEN C_IMPUESTOS_CONSOLIDADOS%NOTFOUND;
      END LOOP;

      CLOSE C_IMPUESTOS_CONSOLIDADOS;
     END IF;
  END IF;

  -- Procedimiento final para generar interfaz
  utl_file.fclose(V_HANDLE);
  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_IMPUE: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_IMPUE;


/****************************************************************************
Descripcion       : Genera Interfaz de Maestro Programa Nuevas (DAT-120)
Fecha Creacion    : 22/05/2012
Fecha Modificacion: 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Codigo Acceso
   psCodigoCanal    : Codigo Canal

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 )
IS

  --Cursor para interfaz
  CURSOR c_interfaz IS

   SELECT p.cod_prog codPrograma,
          p.cam_inic AnioCampanaIniVig,
          p.cam_fin AnioCampanaFinVig,
          CASE
            WHEN p.ind_prog_obli = '0' THEN 'E'
            WHEN p.ind_prog_obli IS NULL THEN 'E'
            WHEN p.ind_prog_obli = '1' THEN 'O'
          END  TipoPrograma,
          '1' FlagActivo,
          '1' Situacion
     FROM cup_prog_nueva_cupon p
    WHERE p.cod_pais = psCodigoPais
      AND nvl(p.est_prog,'N') = 'S'
      AND (
          (p.cam_inic <= psCodigoCampana AND p.cam_fin >= psCodigoCampana)
           OR EXISTS (SELECT NULL FROM cup_equiv_matr cupon_cuv  WHERE p.cod_prog = cupon_cuv.cod_prog AND cupon_cuv.cod_pais = psCodigoPais AND cupon_cuv.cod_peri = psCodigoCampana)
           OR EXISTS (SELECT NULL FROM cup_desp_prod despacho WHERE p.cod_prog = despacho.cod_prog AND despacho.sta_reg = '1' AND despacho.cod_pais = psCodigoPais AND despacho.cod_peri = psCodigoCampana)
          );


  --se define el formato de registro para cada linea de la interfaz
  TYPE interfazRec IS RECORD
  (
    codigoprograma                 VARCHAR2(3),
    campanainicio                  VARCHAR2(6),
    campanafin                     VARCHAR2(6),
    tipoprograma                   VARCHAR2(1),
    flagactvio                     VARCHAR2(1),
    situacion                      VARCHAR2(1)
  );

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  lnIdPais         NUMBER;
  lnCtdadEqui      NUMBER;
  lnLenght         NUMBER;
  lsIndEqui        VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).codigoprograma    ||';'||
                        interfazrecord(x).campanainicio     ||';'||
                        interfazrecord(x).campanafin        ||';'||
                        interfazrecord(x).tipoprograma      ||';'||
                        interfazrecord(x).flagactvio        ||';'||
                        interfazrecord(x).situacion;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MAEST_PRNVS: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MAEST_PRNVS;


/*****************************************************************************************
Descripcion       : Genera Interfaz de Cupones, Premios y Kit - Programa Nuevas (DAT-121)
Fecha Creacion    : 22/05/2012
Fecha Modificacion: 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Archivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Codigo Acceso
   psCodigoCanal    : Codigo Canal

Autor: CSVD - FFVV
******************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUPON_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 )
IS

--Cursor para interfaz
  CURSOR c_interfaz IS
     -- Cupones
     SELECT cupon.cod_prog codPrograma,
            cupon.cod_cupon codProductoNueva,
            CASE WHEN cupon.ind_prod_kit = '1' THEN 'K'
            ELSE 'OE' END tipoProductoNueva,
            CASE WHEN programa.num_vig =1 THEN to_number(cupon.cod_nivel) ELSE 0 END codNivel,
            CASE WHEN programa.num_vig <>1 THEN 0
              ELSE CASE WHEN programa.ind_cupo = 1 THEN to_number(cupon.cod_nivel) ELSE  nvl(cupon.cod_nivel,0) + nvl(1,0) END END numCampania,
            0 flagDeafault,
            CASE WHEN cupon.val_unid_maxi IS NULL THEN 1 ELSE cupon.val_unid_maxi END UniMax,
            programa.ind_const FlagConstancia,
            0 MontoMinPedido
       FROM
            cup_equiv_matr cupon
            JOIN
            cup_prog_nueva_cupon programa ON programa.cod_pais = cupon.cod_pais
                                         AND programa.cod_prog = cupon.cod_prog
      WHERE cupon.cod_pais = psCodigoPais
        AND cupon.cod_peri = psCodigoCampana
        AND NOT EXISTS (
                        SELECT NULL
                          FROM lov_equiv_matr premio
                         WHERE premio.cod_pais = cupon.cod_pais
                           AND premio.cod_prog = cupon.cod_prog
                           AND premio.cod_peri = cupon.cod_peri
                           AND premio.cod_nivel = cupon.cod_nivel
                           AND premio.cod_cupon = cupon.cod_cupon
                       )
     UNION
     -- Premios
     SELECT premio.cod_prog codPrograma,
            premio.cod_cupon codProductoNueva,
            'R' tipoProductoNueva,
            to_number(premio.cod_nivel) codNivel,
            CASE WHEN programa.ind_cupo = 1 THEN to_number(cupon.cod_nivel) ELSE  nvl(premio.cod_nivel,0) + nvl(1,0) END numCampania,
            CASE WHEN
                     EXISTS (SELECT NULL FROM lov_cupon_defec premio_default
                            WHERE
                                   premio_default.cod_pais = premio.cod_pais
                                   AND premio_default.cod_prog = premio.cod_prog
                                   AND premio_default.cod_peri = premio.cod_peri
                                   AND premio_default.cod_nivel = premio.cod_nivel
                                   AND premio_default.cod_cupo = premio.cod_cupon)
                 THEN 1 ELSE 0 END FlagDefault,
            CASE WHEN cupon.val_unid_maxi IS NULL THEN 1 ELSE cupon.val_unid_maxi END UniMax,
            programa.ind_cons_prem_elec FlagConstancia,
            0 MontoMinPedido
       FROM lov_equiv_matr premio JOIN cup_prog_nueva_cupon programa ON programa.cod_pais = premio.cod_pais AND programa.cod_prog = premio.cod_prog,
            cup_equiv_matr cupon
      WHERE premio.cod_pais = psCodigoPais
        AND premio.cod_peri = psCodigoCampana
        AND premio.cod_pais = cupon.cod_pais
        AND premio.cod_prog = cupon.cod_prog
        AND premio.cod_peri = cupon.cod_peri
        AND premio.cod_nivel = cupon.cod_nivel
        AND premio.cod_cupon = cupon.cod_cupon
     UNION
     --KIT
     SELECT despacho.cod_prog codPrograma,
            despacho.cod_venta codProductoNueva,
            CASE
              WHEN despacho.ind_prod_kit = 1 THEN 'K'
              WHEN despacho.ind_rega_pedi = 1 THEN 'RxP' END tipoProductoNueva,
            to_number(despacho.cod_nivel) codNivel,
            CASE WHEN programa.ind_cupo = 1 THEN to_number(despacho.cod_nivel) ELSE  nvl(despacho.cod_nivel,0) + nvl(1,0) END numCapania,
            0 flagDeafault,
            0 UniMax,
            CASE WHEN despacho.ind_prod_kit = 1 THEN to_char(nvl(programa.ind_cons_prem,0)) ELSE '0' END FlagConstancia,
            CASE WHEN despacho.ind_rega_pedi = 1 THEN programa.ped_mont_mini ELSE 0 END MontoMinPedido
       FROM cup_desp_prod despacho JOIN cup_prog_nueva_cupon programa ON programa.cod_pais = despacho.cod_pais AND programa.cod_prog = despacho.cod_prog
      WHERE despacho.cod_pais = psCodigoPais
        AND despacho.cod_peri = psCodigoCampana
        AND (despacho.ind_prod_kit = 1 OR despacho.ind_rega_pedi = 1);

  --se define el formato de registro para cada linea de la interfaz
  TYPE interfazRec IS RECORD
   (
    codigoprograma                 VARCHAR2(3),
    codigoProductoNueva            VARCHAR2(5),
    tipoProductoNueva              VARCHAR2(3),
    codigoNivel                    VARCHAR2(1),
    codigoNumPedido                VARCHAR2(1),
    flagDefault                    VARCHAR2(1),
    unidadMax                      cup_equiv_matr.val_unid_maxi%TYPE,
    flagconstancia                 VARCHAR2(1),
    MontoMinPedido                 cup_prog_nueva_cupon.ped_mont_mini%TYPE
   );

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  lnIdPais     NUMBER;
  lnCtdadEqui  NUMBER;
  lnLenght     NUMBER;
  lsIndEqui    VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).codigoprograma       ||';'||
                        interfazrecord(x).codigoProductoNueva  ||';'||
                        interfazrecord(x).tipoProductoNueva    ||';'||
                        interfazrecord(x).codigoNivel          ||';'||
                        interfazrecord(x).codigoNumPedido      ||';'||
                        interfazrecord(x).flagDefault          ||';'||
                        interfazrecord(x).unidadMax            ||';'||
                        interfazrecord(x).flagconstancia       ||';'||
                        interfazrecord(x).MontoMinPedido;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CUPON_PRNVS: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CUPON_PRNVS;


/*********************************************************************************************
Descripcion       : Genera Interfaz de Cupones, Premios y Kit - CUV Programa Nuevas (DAT-122)
Fecha Creacion    : 22/05/2012
Fecha Modifcacion : 22/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Cod Acceso
   psCodigoCanal    : Cod Canal

Autor: CSVD - FFVV
***********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUVPR_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 )
IS

--Cursor para interfaz
  CURSOR c_interfaz(pcOidCamp NUMBER) IS
     -- Cupones
     SELECT cupon.cod_peri anioCampana,
            cupon.cod_prog codPrograma,
            cupon.cod_cupon codProductoNueva,
            cupon.cod_venta codVenta,
            CASE WHEN cupon.ind_prod_kit = '1' THEN 'K'
            ELSE 'OE' END tipoProductoNueva,
            CASE WHEN estrategia.cod_estr = '002' THEN 1 ELSE 0 END flagPack
       FROM cup_equiv_matr cupon,
            cup_prog_nueva_cupon programa,
            (SELECT
                   c.val_codi_vent,
                   f.cod_estr,
                   c.ind_digi,
                   c.ind_impr_gp

            FROM   pre_matri_factu_cabec a,
                   pre_ofert b,
                   pre_ofert_detal c,
                   mae_produ d,
                   pre_matri_factu e,
                   pre_estra f
             WHERE a.oid_cabe = b.mfca_oid_cabe
               AND b.oid_ofer = c.ofer_oid_ofer
               AND c.prod_oid_prod = d.oid_prod
               AND c.oid_deta_ofer = e.ofde_oid_deta_ofer
               AND e.mfca_oid_cabe = a.oid_cabe
               AND b.coes_oid_estr = f.oid_estr
               AND a.perd_oid_peri = pcOidCamp
             )  estrategia
      WHERE cupon.cod_pais = psCodigoPais
        AND cupon.cod_peri = psCodigoCampana
        AND programa.cod_pais = cupon.cod_pais AND programa.cod_prog = cupon.cod_prog
        AND cupon.cod_venta = estrategia.val_codi_vent(+)
        AND NOT EXISTS (
                        SELECT NULL
                          FROM lov_equiv_matr premio
                         WHERE premio.cod_pais = cupon.cod_pais
                           AND premio.cod_prog = cupon.cod_prog
                           AND premio.cod_peri = cupon.cod_peri
                           AND premio.cod_nivel = cupon.cod_nivel
                           AND premio.cod_cupon = cupon.cod_cupon
                       )
     UNION
     -- Premios
     SELECT premio.cod_peri anioCampana,
            premio.cod_prog codPrograma,
            premio.cod_cupon codProductoNueva,
            premio.cod_venta codVenta,
            'R' tipoProductoNueva,
            CASE WHEN estrategia.cod_estr = '002' THEN 1 ELSE 0 END flagPack
       FROM lov_equiv_matr premio,
            cup_prog_nueva_cupon programa,
            cup_equiv_matr cupon,
            (
              SELECT
                     c.val_codi_vent,
                     f.cod_estr,
                     c.ind_digi,
                     c.ind_impr_gp

              FROM   pre_matri_factu_cabec a,
                     pre_ofert b,
                     pre_ofert_detal c,
                     mae_produ d,
                     pre_matri_factu e,
                     pre_estra f
               WHERE a.oid_cabe = b.mfca_oid_cabe
                 AND b.oid_ofer = c.ofer_oid_ofer
                 AND c.prod_oid_prod = d.oid_prod
                 AND c.oid_deta_ofer = e.ofde_oid_deta_ofer
                 AND e.mfca_oid_cabe = a.oid_cabe
                 AND b.coes_oid_estr = f.oid_estr
                 AND a.perd_oid_peri = pcOidCamp
             ) estrategia
      WHERE premio.cod_pais = psCodigoPais
        AND premio.cod_peri = psCodigoCampana
        AND programa.cod_pais = premio.cod_pais
        AND programa.cod_prog = premio.cod_prog
        AND premio.cod_pais = cupon.cod_pais
        AND premio.cod_prog = cupon.cod_prog
        AND premio.cod_peri = cupon.cod_peri
        AND premio.cod_nivel = cupon.cod_nivel
        AND premio.cod_cupon = cupon.cod_cupon
        AND premio.cod_venta = estrategia.val_codi_vent(+)
     UNION
     --KIT
     SELECT despacho.cod_peri anioCampana,
            despacho.cod_prog codPrograma,
            despacho.cod_venta codProductoNueva,
            despacho.cod_venta codVenta,
            CASE
              WHEN despacho.ind_prod_kit = 1 THEN 'K'
              WHEN despacho.ind_rega_pedi = 1 THEN 'RxP' END tipoProductoNueva,
            CASE WHEN estrategia.cod_estr = '002' THEN 1 ELSE 0 END flagPack
       FROM cup_desp_prod despacho,
            cup_prog_nueva_cupon programa,
            (
              SELECT
                     c.val_codi_vent,
                     f.cod_estr,
                     c.ind_digi,
                     c.ind_impr_gp

              FROM   pre_matri_factu_cabec a,
                     pre_ofert b,
                     pre_ofert_detal c,
                     mae_produ d,
                     pre_matri_factu e,
                     pre_estra f
               WHERE a.oid_cabe = b.mfca_oid_cabe
                 AND b.oid_ofer = c.ofer_oid_ofer
                 AND c.prod_oid_prod = d.oid_prod
                 AND c.oid_deta_ofer = e.ofde_oid_deta_ofer
                 AND e.mfca_oid_cabe = a.oid_cabe
                 AND b.coes_oid_estr = f.oid_estr
                 AND a.perd_oid_peri = pcOidCamp
             ) estrategia
      WHERE despacho.cod_pais = psCodigoPais
        AND despacho.cod_peri = psCodigoCampana
        AND programa.cod_pais = despacho.cod_pais
        AND programa.cod_prog = despacho.cod_prog
        AND (despacho.ind_prod_kit = 1 OR despacho.ind_rega_pedi = 1)
        AND despacho.cod_venta = estrategia.val_codi_vent(+);



  --se define el formato de registro para cada linea de la interfaz
  TYPE interfazRec IS RECORD
  (
    anioCampana                    VARCHAR2(6),
    codigoprograma                 VARCHAR2(3),
    codigoProductoNueva            VARCHAR2(5),
    codigoVenta                    VARCHAR2(6),
    tipoProductoNueva              VARCHAR2(3),
    flagPack                       VARCHAR2(1)
  );

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  lnIdPais     NUMBER;
  lnCtdadEqui  NUMBER;
  lnLenght     NUMBER;
  lsIndEqui    VARCHAR2(1);
  lnOidCampana  NUMBER(12);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  SELECT p.oid_peri INTO lnOidCampana FROM seg_perio_corpo c, cra_perio p WHERE c.oid_peri = p.peri_oid_peri AND c.cod_peri = psCodigoCampana;
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz(lnOidCampana);
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).anioCampana          ||';'||
                        interfazrecord(x).codigoprograma       ||';'||
                        interfazrecord(x).codigoProductoNueva  ||';'||
                        interfazrecord(x).codigoVenta          ||';'||
                        interfazrecord(x).tipoProductoNueva    ||';'||
                        interfazrecord(x).flagPack;

              utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CUVPR_PRNVS: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CUVPR_PRNVS;


/*******************************************************************************************
Descripcion       : Genera Interfaz de Unidades Administrativas - Programa Nuevas (DAT-123)
Fecha Creacion    : 04/05/2012
Fecha Modificacion: 04/05/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoPeriodo  : A?o Periodo
   psCodigoSistema  : Codigo Empresa
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Arcchivo
   pdFechaFact      : Fecha Facturacion
   psCodigoAcceso   : Cod Acceso
   psCodigoCanal    : Cod Canal

Autor: CSVD - FFVV
********************************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_UNADM_PRNVS
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoAcceso    VARCHAR2,
  psCodigoCanal     VARCHAR2
 )
IS

 --Cursor programa activo
 CURSOR c_programa IS

  SELECT p.cod_prog,
         p.cod_pais
    FROM cup_prog_nueva_cupon p
   WHERE p.cod_pais = psCodigoPais
     AND nvl(p.est_prog,'N') = 'S'
     AND (
         (p.cam_inic <= psCodigoCampana AND p.cam_fin >= psCodigoCampana)
          OR EXISTS (SELECT NULL FROM cup_equiv_matr cupon_cuv  WHERE p.cod_prog = cupon_cuv.cod_prog AND cupon_cuv.cod_pais = psCodigoPais AND cupon_cuv.cod_peri = psCodigoCampana)
          OR EXISTS (SELECT NULL FROM cup_desp_prod despacho WHERE p.cod_prog = despacho.cod_prog AND despacho.cod_pais = psCodigoPais AND despacho.cod_peri = psCodigoCampana)
         );

  TYPE programaRec IS RECORD
    (
      codigoPrograma cup_prog_nueva_cupon.cod_prog%TYPE,
      codigoPais  cup_prog_nueva_cupon.cod_pais%TYPE
    );

  TYPE t_programa IS TABLE OF c_programa%ROWTYPE;
  listaPrograma t_programa;

  --se define el formato de registro para cada linea de la interfaz
  TYPE interfazRec IS RECORD
  (
    codigoPrograma    cup_prog_nueva_cupon.cod_prog%TYPE,
    codigoZona        nvs_param_progr_unadm.cod_zona%TYPE
  );

  TYPE ezona IS REF CURSOR RETURN interfazRec;
  regInterfaz        interfazRec;
  c_interfaz1           ezona;

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  lnIdPais     NUMBER;
  lnCtdadEqui  NUMBER;
  lnLenght     NUMBER;
  lindTodoUA   NUMBER;
  lindTodoUARegion    NUMBER;


BEGIN
 lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
 lbAbrirUtlFile := TRUE;

 OPEN c_programa;
    LOOP
      FETCH c_programa BULK COLLECT INTO listaPrograma LIMIT W_FILAS;

          IF lbAbrirUtlFile THEN
            GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz, psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
            lbAbrirUtlFile := FALSE;
          END IF;

          IF listaPrograma.COUNT > 0 THEN
            FOR x IN listaPrograma.FIRST .. listaPrograma.LAST
            LOOP
              --SI EL PROGRAMA ACTIVO NO TIENE REGISTROS EN LA TABLA DE UA, ENTONCES SE CONSIDERA QUE TODAS LAS ZONAS ESTAN ASOCIADAS
              SELECT count(*) INTO lindTodoUA FROM NVS_PARAM_PROGR_UNADM pua WHERE pua.est_regi='1' AND pua.pais_cod_pais = listaPrograma(x).cod_pais AND pua.pnvs_cod_prog = listaPrograma(x).cod_prog;
               IF (lindTodoUA = 0 ) THEN
                 OPEN c_interfaz1 FOR SELECT  listaPrograma(x).cod_prog,z.cod_zona FROM  zon_zona z WHERE z.pais_oid_pais = lnIdPais AND z.ind_acti = 1;
                 LOOP
                  FETCH c_interfaz1 BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

                        IF interfazrecord.COUNT > 0 THEN
                          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP
                               lslinea := interfazRecord(x).codigoPrograma          ||';'||
                                          interfazRecord(x).codigoZona;
                           utl_file.put_line (v_handle, lslinea );

                          END LOOP;
                        END IF;
                  EXIT WHEN c_interfaz1%NOTFOUND;
                 END LOOP;
               END IF;

              --SI EL PROGRAMA ACTIVO TIENE REGISTRO DE TODA LA REGION SE CONSIDERA TODAS LAS ZONAS DE LA REGION
              SELECT count(*) INTO lindTodoUARegion FROM NVS_PARAM_PROGR_UNADM pua WHERE pua.pais_cod_pais = listaPrograma(x).cod_pais AND pua.pnvs_cod_prog = listaPrograma(x).cod_prog AND pua.cod_regi IS NOT NULL AND pua.cod_zona IS NULL;
               IF(lindTodoUARegion > 0) THEN
                OPEN c_interfaz1 FOR
                                  SELECT listaPrograma(x).cod_prog, z.cod_zona
                                  FROM zon_zona z JOIN zon_regio r ON z.zorg_oid_regi = r.oid_regi AND z.ind_acti = 1
                                  WHERE
                                       EXISTS (
                                                SELECT NULL FROM NVS_PARAM_PROGR_UNADM pua WHERE pua.est_regi = '1' AND pua.pais_cod_pais =  listaPrograma(x).cod_pais AND pua.pnvs_cod_prog = listaPrograma(x).cod_prog AND pua.cod_regi = r.cod_regi AND pua.cod_zona IS NULL
                                               );

                 LOOP
                    FETCH c_interfaz1 BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
                    IF interfazrecord.COUNT > 0 THEN
                     FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

                           lslinea := interfazRecord(x).codigoPrograma          ||';'||
                                          interfazRecord(x).codigoZona;

                           utl_file.put_line (v_handle, lslinea );
                      END LOOP;
                    END IF;

                    EXIT WHEN c_interfaz1%NOTFOUND;
                 END LOOP;
               END IF;

              --SI EL PROGRAMA ACTIVO TIENE REGISTRO DE ZONA EN PARTICULARES
              OPEN c_interfaz1 FOR
                                    SELECT listaPrograma(x).cod_prog, z.cod_zona
                                    FROM zon_zona z JOIN zon_regio r ON z.zorg_oid_regi = r.oid_regi AND z.ind_acti = 1
                                    WHERE
                                         EXISTS (
                                                  SELECT NULL FROM NVS_PARAM_PROGR_UNADM pua WHERE pua.est_regi= '1' AND pua.pais_cod_pais = listaPrograma(x).cod_pais AND pua.pnvs_cod_prog = listaPrograma(x).cod_prog AND pua.cod_regi = r.cod_regi AND pua.cod_zona = z.cod_zona
                                                 );
              LOOP
              FETCH c_interfaz1 BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
              IF interfazrecord.COUNT > 0 THEN
                 FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

                       lslinea := interfazRecord(x).codigoPrograma          ||';'||
                                  interfazRecord(x).codigoZona;
                       utl_file.put_line (v_handle, lslinea );
                  END LOOP;
              END IF;

              EXIT WHEN c_interfaz1%NOTFOUND;
              END LOOP;
            END LOOP;
          END IF;

     EXIT WHEN c_programa%NOTFOUND;
    END LOOP;
  CLOSE c_programa;

  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;

RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_UNADM_PRNVS: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_UNADM_PRNVS;

/****************************************************************************
Descripcion       : Genera Interfaz de Envio Cupones Usados (DAT-124)
Fecha Creacion    : 22/05/2012
Fecha Creacion    : 22/05/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : A?o Periodo
 psCodigoSistema  : Codigo Empresa
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CUPON_USADO
 (
  psCodigoPais      VARCHAR2,
  psCodigoPeriodo   VARCHAR2,
  psFechaFact       VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 )
IS

  --Cursor para interfaz
  CURSOR c_interfaz (pcOidCamp NUMBER, pcOidTipoSoliOCR NUMBER, pcOidTipoSoliRxP NUMBER)IS

      SELECT 'VD' codCanalVenta,
             psCodigoPeriodo anioCampana,
             territorio.cod_terr codTerritorio,
             consultora.cod_clie codCliente,
             consultora_nueva.cod_prog codPrograma,
             consultora_nueva.camp_ini_ccc anioCampanaIniProgNueva,
             1 flagProgramaNueva,
             cupon.cod_cupon codProductoNueva,
             CASE
               WHEN premio.cod_cupon IS NOT NULL
               THEN CASE WHEN NOT EXISTS (
                                      SELECT NULL
                                        FROM lov_histo_movim premio_marcado
                                       WHERE premio_marcado.cod_moti_acci = '01'
                                         AND premio_marcado.cod_peri = psCodigoPeriodo
                                         AND premio_default.cod_pais = premio_marcado.cod_pais
                                         AND premio_default.cod_prog = premio_marcado.cod_prog
                                         AND premio_default.cod_peri = premio_marcado.cod_peri
                                         AND premio_default.cod_cupo = premio_marcado.cod_cupo
                                         AND premio.cod_venta = premio_marcado.cod_vent
                                     )
                       THEN 1 ELSE 0 END
               ELSE 0 END FlagMarcoRegalo,
             CASE WHEN premio.cod_cupon IS NOT NULL THEN 0 ELSE 1 END FlagMarcoOE
        FROM ped_solic_cabec solicitud,
             ped_solic_posic posicion_solicitud,
             mae_clien consultora,
             mae_clien_unida_admin unidad_administrativa,
             zon_terri_admin territorio_administrativo,
             zon_terri territorio,
             cup_consu_nueva consultora_nueva,
             cup_equiv_matr cupon,
             lov_equiv_matr premio,
             lov_cupon_defec premio_default
       WHERE solicitud.oid_soli_cabe = posicion_solicitud.soca_oid_soli_cabe
         AND solicitud.clie_oid_clie = consultora.oid_clie
         AND consultora.cod_clie = consultora_nueva.cod_cons
         AND unidad_administrativa.clie_oid_clie = consultora.oid_clie
         AND unidad_administrativa.ztad_oid_terr_admi = territorio_administrativo.oid_terr_admi
         AND territorio_administrativo.terr_oid_terr = territorio.oid_terr
         AND unidad_administrativa.ind_acti = 1
         AND (consultora_nueva.camp_ini_ccc >= (to_number(psCodigoPeriodo) - 4) OR consultora_nueva.camp_ini_ccc<=to_number(psCodigoPeriodo))
         AND consultora_nueva.cod_pais = cupon.cod_pais
         AND consultora_nueva.cod_prog = cupon.cod_prog
         AND posicion_solicitud.val_codi_vent = cupon.cod_venta
         AND cupon.cod_peri = psCodigoPeriodo
         AND solicitud.tspa_oid_tipo_soli_pais = pcOidTipoSoliOCR
         AND solicitud.fec_fact = to_date(psFechaFact,'dd/mm/yyyy')
         --PREMIO
         AND premio.cod_pais   (+)= cupon.cod_pais
         AND premio.cod_prog   (+)= cupon.cod_prog
         AND premio.cod_cupon  (+)= cupon.cod_cupon
         AND premio.cod_peri   (+)= cupon.cod_peri
         AND premio.cod_nivel  (+)= cupon.cod_nivel
         --PREMIO DEFAULT
         AND premio.cod_pais = premio_default.cod_pais(+)
         AND premio.cod_prog = premio_default.cod_prog(+)
         AND premio.cod_peri = premio_default.cod_peri(+)
         AND premio.cod_nivel = premio_default.cod_nivel(+)
         AND premio.cod_cupon = premio_default.cod_cupo(+)
      UNION
      SELECT 'VD'codCanalVenta,
             psCodigoPeriodo anioCampana,
             territorio.cod_terr codTerritorio,
             consultora.cod_clie codCliente,
             consultora_nueva.cod_prog codPrograma,
             consultora_nueva.camp_ini_ccc anioCampanaIniProgNueva,
             1 flagProgramaNueva,
             posicion_solicitud.val_codi_vent codProductoNueva,
             0 flagMarcoRegalo,
             0 flagMarcoOE
        FROM ped_solic_cabec solicitud,
             ped_solic_posic posicion_solicitud,
             mae_clien_unida_admin unidad_administrativa,
             zon_terri_admin territorio_administrativo,
             zon_terri territorio,
             mae_clien consultora,
             cup_consu_nueva consultora_nueva
       WHERE solicitud.oid_soli_cabe = posicion_solicitud.soca_oid_soli_cabe
         AND solicitud.clie_oid_clie = consultora.oid_clie
         AND consultora.cod_clie = consultora_nueva.cod_cons
         AND unidad_administrativa.clie_oid_clie = consultora.oid_clie
         AND unidad_administrativa.ztad_oid_terr_admi = territorio_administrativo.oid_terr_admi
         AND territorio_administrativo.terr_oid_terr = territorio.oid_terr
         AND unidad_administrativa.ind_acti = 1
         AND (consultora_nueva.camp_ini_ccc >= (to_number(psCodigoPeriodo) - 4) OR consultora_nueva.camp_ini_ccc<=to_number(psCodigoPeriodo))
         AND solicitud.tspa_oid_tipo_soli_pais = pcOidTipoSoliRxP
         AND solicitud.perd_oid_peri = pcOidCamp
         AND solicitud.fec_fact = to_date(psFechaFact,'dd/mm/yyyy')
      UNION
      SELECT 'VD' codCanalVenta,
             psCodigoPeriodo anioCampana,
             territorio.cod_terr codTerritorio,
             consultora.cod_clie codCliente,
             NULL codPrograma,
             NULL anioCampanaIniProgNueva,
             0 flagProgramaNueva,
             NULL codProductoNueva,
             0 flagMarcoRegalo,
             0 flagMarcoOE
        FROM mae_clien consultora,
             mae_clien_unida_admin unidad_administrativa,
             zon_terri_admin territorio_administrativo,
             zon_terri territorio
       WHERE unidad_administrativa.clie_oid_clie = consultora.oid_clie
         AND unidad_administrativa.ztad_oid_terr_admi = territorio_administrativo.oid_terr_admi
         AND territorio_administrativo.terr_oid_terr = territorio.oid_terr
         AND unidad_administrativa.ind_acti = 1
         AND EXISTS(
                    SELECT NULL
                      FROM ped_solic_cabec solicitud
                     WHERE solicitud.tspa_oid_tipo_soli_pais = pcOidTipoSoliOCR
                       AND solicitud.perd_oid_peri = pcOidCamp
                       AND solicitud.fec_fact IS NOT NULL
                       AND consultora.oid_clie = solicitud.clie_oid_clie
                   )
         AND EXISTS(
                    SELECT NULL
                      FROM mae_clien_histo_estat nueva_sin_prog
                     WHERE consultora.oid_clie = nueva_sin_prog.clie_oid_clie
                       AND nueva_sin_prog.perd_oid_peri = pcOidCamp
                       AND nueva_sin_prog.esta_oid_esta_clie IN (1,7,2,8)
                   )
         AND EXISTS(
                    SELECT NULL
                      FROM mae_clien_tipo_subti mcts,
                           mae_subti_clien      msc,
                           mae_tipo_clien       mtc
                     WHERE mcts.clie_oid_clie = consultora.oid_clie
                       AND mcts.ticl_oid_tipo_clie = mtc.oid_tipo_clie
                       AND mtc.cod_tipo_clie = '02'
                       AND mcts.sbti_oid_subt_clie = msc.oid_subt_clie
                       AND msc.cod_subt_clie = '04'
                   )
         AND NOT EXISTS(
                        SELECT NULL
                          FROM cup_consu_nueva nueva
                         WHERE consultora.cod_clie = nueva.cod_cons
                       )
         UNION
      SELECT 'VD' codCanalVenta,
             psCodigoPeriodo anioCampana,
             territorio.cod_terr codTerritorio,
             consultora.cod_clie codCliente,
             consultora_nueva.cod_prog codPrograma,
             consultora_nueva.camp_ini_ccc anioCampanaIniProgNueva,
             1 flagProgramaNueva,
             (SELECT cod_venta FROM CUP_DESP_PROD
             WHERE IND_PROD_KIT =1
             AND COD_PERI=psCodigoPeriodo and rownum =1 ) codProductoNueva,
             0 FlagMarcoRegalo,
             0 FlagMarcoOE
        FROM ped_solic_cabec solicitud,
             ped_solic_posic posicion_solicitud,
             mae_clien consultora,
             mae_clien_unida_admin unidad_administrativa,
             zon_terri_admin territorio_administrativo,
             zon_terri territorio,
             cup_consu_nueva consultora_nueva,
             int_solic_conso_detal cd
       WHERE solicitud.oid_soli_cabe = posicion_solicitud.soca_oid_soli_cabe
         AND solicitud.clie_oid_clie = consultora.oid_clie
         AND consultora.cod_clie = consultora_nueva.cod_cons
         AND unidad_administrativa.clie_oid_clie = consultora.oid_clie
         AND unidad_administrativa.ztad_oid_terr_admi = territorio_administrativo.oid_terr_admi
         AND territorio_administrativo.terr_oid_terr = territorio.oid_terr
         AND unidad_administrativa.ind_acti = 1
         AND consultora_nueva.camp_ini_ccc >= (to_number(psCodigoPeriodo)-3)
         AND consultora_nueva.est_proc = 1
         AND solicitud.tspa_oid_tipo_soli_pais = pcOidTipoSoliOCR
         AND solicitud.fec_fact = to_date(psFechaFact,'dd/mm/yyyy')
         AND cd.cod_clie = consultora_nueva.cod_cons
         AND cd.cod_peri = psCodigoPeriodo
         AND cd.cod_vent = posicion_solicitud.val_codi_vent
         AND cd.cod_vent = (SELECT cod_venta FROM CUP_DESP_PROD
                           WHERE IND_PROD_KIT =1
                           AND COD_PERI= psCodigoPeriodo
                           AND COD_PROG = consultora_nueva.cod_prog)  ;


  --se define el formato de registro para cada linea de la interfaz
  TYPE interfazRec IS RECORD
  (
    codCanalVenta                VARCHAR2(4),
    anioCampana                  VARCHAR2(6),
    codTerritorio                VARCHAR2(10),
    codCliente                   VARCHAR2(15),
    codPrograma                  VARCHAR2(3),
    anioCampanaIniProgNueva      VARCHAR2(6),
    flagProgramaNueva            VARCHAR2(1),
    codProductoNueva             VARCHAR2(6),
    flagMarcoRegalo              VARCHAR2(1),
    flagMarcoOE                  VARCHAR2(1)
  );

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);

  lnIdPais     NUMBER;
  lnLenght     NUMBER;
  lsIndEqui    VARCHAR2(1);
  lnIdCampana  NUMBER(12);
  lnIdTipoSolicitudSOC NUMBER(12);
  lnIdTipoSolicitudRxP NUMBER(12);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);

  SELECT p.oid_peri INTO lnIdCampana FROM seg_perio_corpo c, cra_perio p WHERE c.oid_peri = p.peri_oid_peri AND c.cod_peri = psCodigoPeriodo;
  lbAbrirUtlFile := TRUE;
  SELECT tipo_solicitud_pais.oid_tipo_soli_pais INTO lnIdTipoSolicitudSOC
  FROM ped_tipo_solic_pais tipo_solicitud_pais ,ped_tipo_solic tipo_solicitud
  WHERE tipo_solicitud_pais.tsol_oid_tipo_soli = tipo_solicitud.oid_tipo_soli AND tipo_solicitud.cod_tipo_soli = 'SOC';

  SELECT g.val_para INTO lnIdTipoSolicitudRxP FROM nvs_param_gener g   WHERE g.cod_para = '01';


     /* GenerANDo Archivo de Texto (Detalle) */
    OPEN c_interfaz(lnIdCampana,lnIdTipoSolicitudSOC,lnIdTipoSolicitudRxP );
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).CodCanalVenta             ||';'||
                        interfazrecord(x).AnioCampana               ||';'||
                        interfazrecord(x).codTerritorio             ||';'||
                        interfazrecord(x).CodCliente                ||';'||
                        interfazrecord(x).codPrograma               ||';'||
                        interfazrecord(x).AnioCampanaIniProgNueva   ||';'||
                        interfazrecord(x).FlagProgramaNueva         ||';'||
                        interfazrecord(x).codProductoNueva          ||';'||
                        interfazrecord(x).FlagMarcoRegalo           ||';'||
                        interfazrecord(x).FlagMarcoOE;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     /* Procedimiento final para generar interfaz */
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CUPON_USADO: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CUPON_USADO;

/***************************************************************************
Descripcion       : Genera Interfaz de Envio Canal de Ingreso del Pedido (DAT-125)
Fecha Creacion    : 27/03/2012
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Periodo de facturacion
 psCodigoSistema  : Grupo de interfaz ( DAT, INC, etc )
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EJECU_NIVEL
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS
CURSOR c_Interfaz IS
    SELECT CASE WHEN cmni.cod_nive = 'AS' THEN 'A'
                WHEN cmni.cod_nive IN ('EJ','ES','EM') THEN SUBSTR( cmni.cod_nive, 2, 1 )
                ELSE '0'
           END codNivel,
           cmni.des_abre desNivel
      FROM com_nivel cmni
     WHERE cmni.cod_nive NOT IN ('TT');

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;

lsLinea                     VARCHAR2(1000);
lsNombreArchivo             VARCHAR2(50);

BEGIN
  lbAbrirUtlFile := TRUE;

  -- Procedimiento inicial para generar interfaz
  IF lbAbrirUtlFile THEN
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
    lbAbrirUtlFile := FALSE;
  END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord;

      IF interfazRecord.COUNT > 0 THEN
        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
          lsLinea :=  interfazRecord(x).codNivel ||';'||
                      interfazRecord(x).desNivel;

          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_EJECU_NIVEL: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_EJECU_NIVEL;

/***************************************************************************
Descripcion    : Enviar parametros del ciclo de ejecutivas ( DAT-126 )
Fecha Creacion : 04/07/2012
Parametros     :

Autor: CMori CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CICLO_EJECU
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS
CURSOR c_Interfaz IS
    SELECT ejca.cod_anio_inic || ejca.cod_rang codCiclo,
           'CICLO ' || ejca.cod_anio_inic desCiclo,
           ejca.cod_anio_inic || trej.cam_inic anioCampanaInicio,
           CASE
              WHEN trej.cam_inic > trej.cam_fina THEN
                   SUBSTR( GEN_FN_CALCU_PERIO( ejca.cod_anio_inic || '18', 1 ), 1, 4 ) || trej.cam_fina
              ELSE trej.cam_fina
           END anioCampanaFin,
           caca.num_como nroCampanasComodin1,
           caca.num_como_recu nroCampanasComodin2
      FROM (
            SELECT sejca.cod_pais,
                   --sejca.cod_comi,
                   MAX( sejca.cod_anio_inic ) cod_anio_inic,
                   MAX( sejca.cod_rang ) cod_rang
              FROM com_comis_ejcal_cabec sejca
             GROUP BY sejca.cod_pais
                      --sejca.cod_comi
           ) ejca,
           com_comis_calif_cabec caca,
           com_tramo_ejecu trej
     WHERE ejca.cod_pais = trej.cod_pais
       AND ejca.cod_rang = trej.cod_rang
       AND ejca.cod_pais = caca.cod_pais;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;

lsLinea                     VARCHAR2(1000);
lsNombreArchivo             VARCHAR2(50);

BEGIN
  lbAbrirUtlFile := TRUE;

  -- Procedimiento inicial para generar interfaz
  IF lbAbrirUtlFile THEN
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
    lbAbrirUtlFile := FALSE;
  END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord;

      IF interfazRecord.COUNT > 0 THEN
        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
          lsLinea :=  interfazRecord(x).codCiclo ||';'||
                      interfazRecord(x).desCiclo ||';'||
                      interfazRecord(x).anioCampanaInicio ||';'||
                      interfazRecord(x).anioCampanaFin ||';'||
                      interfazRecord(x).nroCampanasComodin1 ||';'||
                      interfazRecord(x).nroCampanasComodin2;

          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_CICLO_EJECU: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CICLO_EJECU;

/***************************************************************************
Descripcion    : Enviar resultado x Periodo de ejecutivas ( DAT-127 )
Fecha Creacion : 09/07/2012
Parametros     :

Autor: CMori CSVD - FFVV
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_EJECU
  (
  psCodigoPais 		  VARCHAR2,
  psCodigoMarca 		VARCHAR2,
  psCodigoCanal 		VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2,
  psCodigoIso       VARCHAR2)
IS
CURSOR c_Interfaz IS
    SELECT cicl.cod_anio_inic || cicl.cod_rang codCiclo,
           cicl.cod_camp anioCampana,
           ejca.cod_ejec codEjecutiva,
           CASE WHEN ejca.cod_nive = 'AS' THEN 'A'
                WHEN ejca.cod_nive IN ('EJ','ES','EM') THEN SUBSTR( ejca.cod_nive, 2, 1 )
                ELSE '0'
           END codNivelCiclo,
           CASE WHEN hvej.cod_nive = 'AS' THEN 'A'
                WHEN hvej.cod_nive IN ('EJ','ES','EM') THEN SUBSTR( hvej.cod_nive, 2, 1 )
                ELSE '0'
           END codNivelCampana,
           hvej.num_pedi nroPedidosAlcanzado,
           hvej.num_ingr_bica nroIngresosAlcanzado,
           ejca.val_moto_veta montoVentaMNAlcanzado,
           ejca.val_moto_comi montoMNComision21dias,
           0.00 montoMNComision31dias,
           ejca.val_moto_paga montoMNCobranza21dias,
           0.00 montoMNCobranza31dias,
           ejca.val_porc_recu porcRecuperacion21dias,
           0.00 porcRecuperacion31dias,
           (
             select sum(decode(ejca.VAL_MOTO_COMI,0,decode(ejca.COD_NIVE,'AS',de.VAL_MONT_CORE,de.VAL_MONT_COVE),0.00))
               from com_comis_ejcal_detal de
              where de.COD_EJEC = ejca.COD_EJEC
                and de.COD_CAMP = ejca.COD_CAMP
           ) comisionPerdida21dias,
           DECODE( ejca.ind_como, 'NO', 0, 1 ) flagUsoComodin1,
           DECODE( ejca.ind_como_recu, 'NO', 0, 1 ) flagUsoComodin2,
           DECODE( hitc.num_usos_como, NULL, 0 , hitc.num_usos_como ) nroCampanasUsoComodin1,
           DECODE( hitc.num_usos_como_recu, NULL, 0 , hitc.num_usos_como_recu ) nroCampanasUsoComodin2,
           CASE
              WHEN cade1.cod_zona IS NOT NULL THEN cade1.num_pedi_desd
              WHEN cade2.cod_regi IS NOT NULL THEN cade2.num_pedi_desd
              WHEN cade1.cod_zona IS NULL AND cade2.cod_regi IS NULL AND ejca.cod_nive <> 'AS' THEN cade3.num_pedi_desd
              ELSE 0
           END NroPedidosObjetivoDesde,
           CASE
              WHEN cade1.cod_zona IS NOT NULL THEN cade1.num_pedi_hast
              WHEN cade2.cod_regi IS NOT NULL THEN cade2.num_pedi_hast
              WHEN cade1.cod_zona IS NULL AND cade2.cod_regi IS NULL AND ejca.cod_nive <> 'AS' THEN cade3.num_pedi_hast
              ELSE 0
           END NroPedidosObjetivoHasta,
           CASE
              WHEN cade1.cod_zona IS NOT NULL THEN cade1.num_ingr_desd
              WHEN cade2.cod_regi IS NOT NULL THEN cade2.num_ingr_desd
              WHEN cade1.cod_zona IS NULL AND cade2.cod_regi IS NULL AND ejca.cod_nive <> 'AS' THEN cade3.num_ingr_desd
              ELSE 0
           END NroIngresosObjetivo
      FROM (
            SELECT sejca.cod_pais,
                   MAX( sejca.cod_anio_inic ) cod_anio_inic,
                   MAX( sejca.cod_rang ) cod_rang,
                   MAX( sejca.cod_camp ) cod_camp
              FROM com_comis_ejcal_cabec sejca
             GROUP BY sejca.cod_pais
           ) cicl,
           com_comis_ejcal_cabec ejca,
           com_histo_varia_ejcam hvej,
           com_histo_varia_ejetr_cabec hitc,
           com_comis_calif_detal cade1, -- para evaluacion por zona
           com_comis_calif_detal cade2, -- para evaluacion por region
           com_comis_calif_detal cade3 -- para evaluacion por calificacion + nivel
    WHERE cicl.cod_camp = ejca.cod_camp
      AND ejca.cod_ejec = hvej.cod_ejec
      AND ejca.cod_camp = hvej.cod_camp
      --
      AND ejca.cod_anio_inic = hitc.num_anio_inic(+)
      AND ejca.cod_rang = hitc.cod_rang(+)
      AND ejca.cod_ejec = hitc.cod_ejec(+)
      --
      AND ejca.cod_nive = cade1.cod_nive(+)
      AND ejca.cod_cali = cade1.cod_cali(+)
      AND ejca.cod_zona = cade1.cod_zona(+)
      --
      AND ejca.cod_nive = cade2.cod_nive(+)
      AND ejca.cod_cali = cade2.cod_cali(+)
      AND ejca.cod_regi = cade2.cod_regi(+)
      --
      AND ejca.cod_nive = cade3.cod_nive(+)
      AND ejca.cod_cali = cade3.cod_cali(+)
      --
      AND cade2.cod_zona(+) IS NULL
      --
      AND cade3.cod_zona(+) IS NULL
      AND cade3.cod_regi(+) IS NULL;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;

lsLinea                     VARCHAR2(1000);
lsNombreArchivo             VARCHAR2(50);

BEGIN
  lbAbrirUtlFile := TRUE;

  -- Procedimiento inicial para generar interfaz
  IF lbAbrirUtlFile THEN
    GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                           psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
    lbAbrirUtlFile := FALSE;
  END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord;

      IF interfazRecord.COUNT > 0 THEN
        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
          lsLinea :=  interfazRecord(x).codCiclo ||';'||
                      interfazRecord(x).AnioCampana ||';'||
                      interfazRecord(x).CodEjecutiva ||';'||
                      interfazRecord(x).CodNivelCiclo ||';'||
                      interfazRecord(x).CodNivelCampana ||';'||
                      interfazRecord(x).NroPedidosAlcanzado ||';'||
                      interfazRecord(x).NroIngresosAlcanzado ||';'||
                      TO_CHAR( NVL( interfazrecord(x).MontoVentaMNAlcanzado,0 ),'999999999990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).MontoMNComision21dias,0 ),'999999999990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).MontoMNComision31dias,0 ),'999999999990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).MontoMNCobranza21dias,0 ),'999999999990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).MontoMNCobranza31dias,0 ),'999999999990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).PorcRecuperacion21dias,0 ),'99990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).PorcRecuperacion31dias,0 ),'99990.99') ||';'||
                      TO_CHAR( NVL( interfazrecord(x).ComisionPerdida21dias,0 ),'999999999990.99') ||';'||
                      interfazRecord(x).FlagUsoComodin1 ||';'||
                      interfazRecord(x).FlagUsoComodin2 ||';'||
                      interfazRecord(x).NroCampanasUsoComodin1 ||';'||
                      interfazRecord(x).NroCampanasUsoComodin2 ||';'||
                      interfazRecord(x).NroPedidosObjetivoDesde ||';'||
                      interfazRecord(x).NroPedidosObjetivoHasta ||';'||
                      interfazRecord(x).NroIngresosObjetivo;

          UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_DAT_ENVIO_RESUL_EJECU: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_RESUL_EJECU;

/****************************************************************************
Descripcion       : Genera Interfaz de Maestro Programa de Reconocimiento Incentivos DAT-128)
Fecha Creacion    : 04/07/2012
Fecha Modificacion: 12/07/2012
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo Interfaz
   psNombreArchivo  : Nombre Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRREC
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 )
IS

  --Cursor para interfaz
  CURSOR c_interfaz IS
    SELECT
           programa.num_conc                        CodPrograma
          ,programa.val_nomb                        DesPrograma
          ,GEN_PKG_GENER.GEN_FN_DEVUELVE_DES_PERIO
           (programa.perd_oid_peri_desd)            AnioCampanaIni
          ,GEN_PKG_GENER.GEN_FN_DEVUELVE_DES_PERIO
           (programa.perd_oid_peri_hast)            AnioCampanaFin
          ,''                                       AnioCampanaEval
          ,puntaje.val_fact_conv                    EquivalenciaPuntaje
          ,moneda.cod_mone                          TipoMoneda
          ,pais.cod_pais                            CodPais
          ,''                                       AnioCampanaEfectivoIni
          ,''                                       AnioCampanaEfectivoFin
    FROM   inc_concu_param_gener programa
          ,inc_clasi_concu       clasificacion
          ,inc_obten_punto       puntaje
          ,seg_pais              pais
          ,seg_moned             moneda
    WHERE programa.oid_para_gral      = puntaje.copa_oid_para_gral
      AND programa.pais_oid_pais      = pais.oid_pais
      AND pais.mone_oid_mone          = moneda.oid_mone
      AND programa.ccon_oid_clas_conc = clasificacion.oid_clas_conc
      AND clasificacion.cod_clas_conc = 'T'
      AND programa.ind_acti           = '1';

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdPais         NUMBER;
  lnCtdadEqui      NUMBER;
  lnLenght         NUMBER;
  lsIndEqui        VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).CodPrograma            ||';'||
                        interfazrecord(x).DesPrograma            ||';'||
                        interfazrecord(x).AnioCampanaIni         ||';'||
                        interfazrecord(x).AnioCampanaFin         ||';'||
                        interfazrecord(x).AnioCampanaEval        ||';'||
                        interfazrecord(x).EquivalenciaPuntaje    ||';'||
                        interfazrecord(x).TipoMoneda             ||';'||
                        interfazrecord(x).CodPais                ||';'||
                        interfazrecord(x).AnioCampanaEfectivoIni ||';'||
                        interfazrecord(x).AnioCampanaEfectivoFin;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MAEST_PRREC: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MAEST_PRREC;

/****************************************************************************
Descripcion       : Genera Interfaz de Nivel por Programa de Reconocimiento Activo DAT-129)
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_PRNIV
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 )

IS

  --Cursor para interfaz
  CURSOR c_interfaz IS
    SELECT programa.num_conc                        CodPrograma
          ,nivel_detalle.num_nive                   NroNivel
          ,premio_detalle.val_desc_lote_prem_arti   DesNivel
          ,0                                        PuntajeReferencia
          ,nivel_detalle.num_cant_inic_punt         PuntajeRangoIni
          ,nivel_detalle.num_cant_fina_punt         PuntajeRangoFin
    FROM   inc_param_gener_premi     nivel
          ,inc_concu_param_gener     programa
          ,inc_clasi_concu           clasificacion
          ,inc_param_nivel_premi     nivel_detalle
          ,inc_premi_artic           premio
          ,inc_lote_premi_artic      premio_detalle
    WHERE
           programa.ccon_oid_clas_conc      = clasificacion.oid_clas_conc
      AND  clasificacion.cod_clas_conc      = 'T'
      AND  programa.ind_acti                = '1'
      AND  nivel.copa_oid_para_gral         = programa.oid_para_gral
      AND  nivel.oid_para_gene_prem         = nivel_detalle.pagp_oid_para_gene_prem
      AND  nivel_detalle.oid_para_nive_prem = premio.panp_oid_para_nive_prem(+)
      AND  premio.oid_prem_arti             = premio_detalle.prar_oid_prem_arti(+);

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdPais         NUMBER;
  lnCtdadEqui      NUMBER;
  lnLenght         NUMBER;
  lsIndEqui        VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP
						 lslinea := interfazrecord(x).CodPrograma            ||';'||
                        interfazrecord(x).NroNivel               ||';'||
                        interfazrecord(x).DesNivel               ||';'||
                        interfazrecord(x).PuntajeReferencia      ||';'||
                        interfazrecord(x).PuntajeRangoIni        ||';'||
                        interfazrecord(x).PuntajeRangoFin;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MAEST_PRNIV: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_MAEST_PRNIV;

/****************************************************************************
Descripcion       : Genera Interfaz con informacion sobre las consultoras que
                    lograron un nivel en el programa de reconocimiento(DAT-130)
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PRREC_PNTJE
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 )

IS

  --Cursor para interfaz
  CURSOR c_interfaz IS
    SELECT
           consultora_inc.concurso           CodPrograma
          ,consultora_inc.NroNivel_detalle   NroNivel
          ,consultora_inc.cliente            CodEbelista
          ,psCodigoCampana                   AnioCampana
          ,consultora_inc.total              PuntajeAlcanzado
          ,terr.cod_terr                     CodTerritorio
      FROM(
            SELECT  concurso
                   ,cliente
                   ,NroNivel_detalle
                   ,total
              FROM (
                    SELECT  programa.num_conc     concurso
                           ,c.cod_clie            cliente
                           ,SUM(cuenta.num_punt) total
                      FROM  inc_concu_param_gener     programa
                           ,inc_clasi_concu           clasificacion
                           ,inc_cuent_corri_punto     cuenta
                           ,mae_clien                 c
                      WHERE  programa.ccon_oid_clas_conc      =  clasificacion.oid_clas_conc
                        AND  clasificacion.cod_clas_conc      =  'T'
                        AND  programa.ind_acti                =  '1'
                        AND  programa.oid_para_gral           =  cuenta.copa_oid_para_gral
                        AND  cuenta.clie_oid_clie             =  c.oid_clie
                      GROUP BY  programa.num_conc
                            ,c.cod_clie
                   ) puntaje2
                  ,(
                      SELECT programa.num_conc                        CodPrograma
                            ,nivel.num_nive                           NroNivel
                            ,nivel_detalle.num_nive                   NroNivel_detalle
                            ,nivel_detalle.num_cant_inic_punt         PuntajeRangoIni
                            ,nivel_detalle.num_cant_fina_punt         programa2
                      FROM   inc_concu_param_gener     programa
                            ,inc_clasi_concu           clasificacion
                            ,inc_param_gener_premi     nivel
                            ,inc_param_nivel_premi     nivel_detalle
                      WHERE
                             programa.ccon_oid_clas_conc      = clasificacion.oid_clas_conc
                        AND  clasificacion.cod_clas_conc      = 'T'
                        AND  programa.ind_acti                = '1'
                        AND  programa.oid_para_gral           = nivel.copa_oid_para_gral
                        AND  nivel.oid_para_gene_prem         = nivel_detalle.pagp_oid_para_gene_prem
                   ) programa2
             WHERE
                   puntaje2.concurso = programa2.codprograma     (+)
               AND puntaje2.total   >= programa2.PuntajeRangoIni (+)
               AND puntaje2.total   <= programa2.programa2       (+)
          )consultora_inc
          ,mae_clien cliente
          ,mae_clien_unida_admin cuad
          ,zon_terri_admin ztad
          ,zon_secci zscc
          ,zon_terri terr
     WHERE cliente.cod_clie        = consultora_inc.cliente
       AND cliente.oid_clie        = cuad.clie_oid_clie
       AND cuad.ztad_oid_terr_admi = ztad.oid_terr_admi
       AND ztad.zscc_oid_secc      = zscc.oid_secc
       AND ztad.terr_oid_terr      = terr.oid_terr
       AND cuad.ind_acti           = '1'
     ORDER BY 1,2 DESC,5 DESC;

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdPais         NUMBER;
  lnCtdadEqui      NUMBER;
  lnLenght         NUMBER;
  lsIndEqui        VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP
						 lslinea := interfazrecord(x).CodPrograma            ||';'||
                        interfazrecord(x).NroNivel               ||';'||
                        interfazrecord(x).CodEbelista            ||';'||
                        interfazrecord(x).AnioCampana            ||';'||
                        interfazrecord(x).PuntajeAlcanzado       ||';'||
                        interfazrecord(x).CodTerritorio;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PRREC_PNTJE: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PRREC_PNTJE;

/****************************************************************************
Descripcion       : Genera Interfaz de con la informacion sobre el puntaje
                    alcanzado por la consultora en la Periodo(DAT-131).
Fecha Creacion    : 06/07/2012
Fecha Modificacion:
Parametros:
   psCodigoPais     : Codigo Pais
   psCodigoCampana  : A?o Periodo
   psCodigoSistema  : Codigo Sistema
   psCodigoInterfaz : Codigo de Interfaz
   psNombreArchivo  : Nombre de Archivo

Autor: CSVD - FFVV
*****************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONSU_RECON
 (
  psCodigoPais      VARCHAR2,
  psCodigoCampana   VARCHAR2,
  psCodigoSistema   VARCHAR2,
  psCodigoInterfaz  VARCHAR2,
  psNombreArchivo   VARCHAR2
 )

IS

  --Cursor para interfaz
  CURSOR c_interfaz IS
    SELECT concurso         CodPrograma
          ,NroNivel_detalle NroNivel
          ,cliente          CodEbelista
      FROM (
              SELECT  programa.num_conc     concurso
                   ,c.cod_clie            cliente
                   ,SUM(cuenta.num_punt) total
                FROM  inc_concu_param_gener     programa
                     ,inc_clasi_concu           clasificacion
                   ,inc_cuent_corri_punto     cuenta
                   ,mae_clien                 c
               WHERE  programa.ccon_oid_clas_conc      =  clasificacion.oid_clas_conc
                 AND  clasificacion.cod_clas_conc      =  'T'
                 AND  programa.ind_acti                =  '1'
                AND  programa.oid_para_gral           =  cuenta.copa_oid_para_gral
                AND  cuenta.clie_oid_clie             =  c.oid_clie
            GROUP BY  programa.num_conc
                    ,c.cod_clie
           ) puntaje2
          ,(
              SELECT  programa.num_conc                        CodPrograma
                     ,nivel.num_nive                           NroNivel
                     ,nivel_detalle.num_nive                   NroNivel_detalle
                     ,nivel_detalle.num_cant_inic_punt         PuntajeRangoIni
                     ,nivel_detalle.num_cant_fina_punt         programa2
                FROM  inc_concu_param_gener     programa
                     ,inc_clasi_concu           clasificacion
                     ,inc_param_gener_premi     nivel
                     ,inc_param_nivel_premi     nivel_detalle
               WHERE
                      programa.ccon_oid_clas_conc      = clasificacion.oid_clas_conc
                 AND  clasificacion.cod_clas_conc      = 'T'
                 AND  programa.ind_acti                = '1'
                 AND  programa.oid_para_gral           = nivel.copa_oid_para_gral
                 AND  nivel.oid_para_gene_prem         = nivel_detalle.pagp_oid_para_gene_prem
           ) programa2
     WHERE
           puntaje2.concurso = programa2.codprograma
       AND puntaje2.total   >= programa2.PuntajeRangoIni
       AND puntaje2.total   <= programa2.programa2
  ORDER BY 1,2 DESC;

  --se define un tipo de dato tipo Tabla de Registros de la interfaz
  TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
  --se define una variable de tipo de dato de tabla personalizada con el registro de cada linea de la interfaz
  interfazRecord interfazRecTab;
  --define variable del tipo de dato del campo DIR_TEMP de la tabla BAS_INTER
  lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
  --define variable manejador de archivos
  v_hANDle         UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile   BOOLEAN;
  lsLinea          VARCHAR2(1000);
  lsNombreArchivo  VARCHAR2(50);
  lnIdPais         NUMBER;
  lnCtdadEqui      NUMBER;
  lnLenght         NUMBER;
  lsIndEqui        VARCHAR2(1);

BEGIN

  lnIdPais       := gen_pkg_gener.gen_fn_devuelve_id_pais(psCodigoPais);
  lbAbrirUtlFile := TRUE;

     /* Generar Archivo de Texto (Detalle) */
    OPEN c_interfaz;
      LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
        /* Procedimiento inicial para generar interfaz */
        IF lbAbrirUtlFile THEN
          GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                                 psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
          lbAbrirUtlFile := FALSE;
        END IF;

        IF interfazrecord.COUNT > 0 THEN
          FOR x IN interfazrecord.FIRST .. interfazrecord.LAST LOOP

						 lslinea := interfazrecord(x).CodPrograma            ||';'||
                        interfazrecord(x).NroNivel               ||';'||
                        interfazrecord(x).CodEbelista;

             utl_file.put_line (v_handle, lslinea );

          END LOOP;
        END IF;

      EXIT WHEN c_interfaz%NOTFOUND;
      END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
       /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);

    RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CONSU_RECON: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CONSU_RECON;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Estados Lider  (DAT-133 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAT_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
IS
   CURSOR c_interfaz IS

        SELECT t1.cod_stat_lide,
               t1.des_stat_lide
          FROM INT_DAT_ESTAT_LIDER t1;


   TYPE interfazRec IS RECORD
       (
        codStatusLider         INT_DAT_ESTAT_LIDER.cod_stat_lide%TYPE,
        desStatusLider         INT_DAT_ESTAT_LIDER.des_stat_lide%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codStatusLider            ||';'||
                                  interfazRecord(x).desStatusLider            ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ESTAT_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ESTAT_LIDER;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Bajas Lider  (DAT-134 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TBAJA_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
IS
   CURSOR c_interfaz IS

      SELECT DISTINCT dat.CodBajaLider,dat.DesBajaLider
        FROM (SELECT CASE t1.cod_tipo_desv
                      WHEN 6 THEN 'C1'
                      WHEN 3 THEN 'C2'
                      WHEN 1 THEN 'C3'
                      ELSE 'C4'
                      END  CodBajaLider,
               CASE t1.cod_tipo_desv
                      WHEN 1 THEN 'Egresada'
                      WHEN 3 THEN 'Rezonificacion'
                WHEN 6 THEN 'Incumplimiento Pedidos'
                ELSE 'Otros'
                      END  DesBajaLider
        FROM ZON_TIPO_DESVI t1
        WHERE t1.est_regi <> '9'
              ) dat
      ORDER BY 1;


   TYPE interfazRec IS RECORD
       (
        CodBajaLider        ZON_TIPO_DESVI.COD_TIPO_DESV%TYPE,
        DesBajaLider        varchar2(100)
       );

   TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodBajaLider            ||';'||
                                  interfazRecord(x).DesBajaLider            ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TBAJA_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_TBAJA_LIDER;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Clasificaciones Lider  (DAT-135 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
IS
   CURSOR c_interfaz IS

        SELECT CASE t1.cod_clas_lide
                WHEN '01' THEN 'A1'
                WHEN '02' THEN 'A2'
                WHEN '03' THEN 'B1'
                END cod_clas_lide,
               CASE t1.cod_clas_lide
                WHEN '01' THEN 'Nueva Ingreso'
                WHEN '02' THEN 'Nueva Reingreso'
                WHEN '03' THEN 'Establecida'
                END  des_tipo_desv
        FROM ssicc_comun.let_corpo_clasi_lider t1;


   TYPE interfazRec IS RECORD
       (
        CodClasificacion        ssicc_comun.let_corpo_clasi_lider.cod_clas_lide%TYPE,
        DesClasificacion        varchar2(15)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodClasificacion           ||';'||
                                  interfazRecord(x).DesClasificacion            ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CLASI_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_CLASI_LIDER;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Programas Lider  (DAT-136 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

   SELECT cpp.cod_prog ,
          cpp.des_prog ,
          cpp.cam_inic ,
          cpp.cam_fin  ,
          cpp.num_mini_acti_secc ,
          CASE cpp.tip_eval_nive_exit
               WHEN '1' THEN 'E1'
               WHEN '2' THEN 'E2'
          END tip_eval_nive_exit,
          cpt.ind_acti_ingr_efec ,
          NVL(cpp.ind_rest_alca_ingr_efec,'0') FlagRestriccionIE,
          cpt.ind_acti_rete_33 ,
          cpt.ind_acti_rete_44
   FROM  LET_CORPO_PARAM_PROGR cpp,
         LET_CORPO_PARAM_TRAMO cpt
   WHERE cpp.IND_ACTI <> 9
   AND   cpt.ind_acti <> 9
   AND   cpp.cod_prog = cpt.cod_prog
   AND   cpp.cod_pais = psCodigoPais
   AND   cpt.cod_pais = psCodigoPais
   AND    psCodigoPeriodo >= cpp.cam_inic
   AND    (psCodigoPeriodo <= cpp.cam_fin OR cpp.cam_fin IS NULL)
   AND    psCodigoPeriodo >= cpt.cam_inic
   AND    (psCodigoPeriodo <= cpt.cam_fin OR cpt.cam_fin IS NULL);


   TYPE interfazRec IS RECORD
       (
        CodPrograma               VARCHAR2(6),
        DesPrograma               VARCHAR2(200),
        AnioCampaniaInicio        VARCHAR2(6),
        AnioCampaniaFin           VARCHAR2(6),
        NroActivasExigidasSeccion NUMBER(12),
        Escenario                 VARCHAR2(2),
        FlagIEActivo              VARCHAR2(1),
        FlagRestriccionIE         VARCHAR2(1),
        FlagRet3d3Activo          VARCHAR2(1),
        FlagRet4d4Activo          VARCHAR2(1)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodPrograma                          ||';'||
                                  interfazRecord(x).DesPrograma                          ||';'||
                                  interfazRecord(x).AnioCampaniaInicio                   ||';'||
                                  interfazRecord(x).AnioCampaniaFin                  	   ||';'||
                                  TO_CHAR(interfazRecord(x).NroActivasExigidasSeccion,'9999999')  ||';'||
                                  interfazRecord(x).Escenario                            ||';'||
                                  interfazRecord(x).FlagIEActivo                         ||';'||
                                  interfazRecord(x).FlagRestriccionIE                    ||';'||
                                  interfazRecord(x).FlagRet3d3Activo                     ||';'||
                                  interfazRecord(x).FlagRet4d4Activo                       ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PROGR_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_PROGR_LIDER;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider  (DAT- 137 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz (lnIdPeriodo NUMBER) IS

   SELECT zhg.gere , zhga.AnioCampania
   FROM ZON_HISTO_GEREN zhg,
     (SELECT gere, gen_pkg_gener.gen_fn_devuelve_des_perio(min(perd_oid_peri_desd)) as AnioCampania
      FROM ZON_HISTO_GEREN  WHERE
      cod_secc IS NOT NULL
      group by gere ) zhga
   WHERE zhg.cod_secc IS NOT NULL
   AND zhga.gere = zhg.gere
   AND   psCodigoPeriodo >=  gen_pkg_gener.gen_fn_devuelve_des_perio(zhg.perd_oid_peri_desd)
   AND ( psCodigoPeriodo <= gen_pkg_gener.gen_fn_devuelve_des_perio(zhg.perd_oid_peri_hast) OR perd_oid_peri_hast IS NULL);

   TYPE interfazRec IS RECORD
       (
        CodLider               VARCHAR2(10),
        AnioCampana            VARCHAR2(6)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
   lnIdPeriodo           NUMBER(12);
BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz(lnIdPeriodo);
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodLider                        ||';'||
                                  interfazRecord(x).AnioCampana               ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LIDER: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_LIDER;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Reten  (DAT-138 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_SECCI
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

   SELECT psCodigoPeriodo aniocampana,
          zz.cod_zona CodZona,
          zs.cod_secc CodSeccion,
          nvl(lider_actual.gere ,'XXXXXXXXX') codlider,
          '' CodSatusLider,
          decode(lider_actual.gere,NULL,0,1) FlagActiva,
          clasi_actual.cod_clas_lide codclasificacion,
          nvl(lider_actual.acfi_exig_secc_nomb,0) NroActExigSecNombramiento,
          decode(lider_actual.gere,NULL,'1','0')  FlagBajaLider,
          '' CodBajaLider,
        (  select pcm.cod_peri
             from zon_histo_geren zh,
                  cra_perio pr,
                  seg_perio_corpo pc,
                  ( select gm.gere,
                           min(gm.perd_oid_peri_desd) perdesd
                      from zon_histo_geren gm
                     where length(gm.ua) = 9
                  group by gm.gere
                  ) minc,
                  cra_perio prm,
                  seg_perio_corpo pcm
            where sgv.cod_subg_vent || zr.cod_regi || zz.cod_zona || zs.cod_secc = zh.ua
              and pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  psCodigoPeriodo
              and pr.oid_peri >= zh.perd_oid_peri_desd
              and (  pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
              and zh.gere = minc.gere
              and minc.perdesd = prm.oid_peri
              and prm.peri_oid_peri = pcm.oid_peri ) AnioCampanaInicio,
              '' AnioCampanaFin
          FROM zon_regio zr,
               zon_sub_geren_venta sgv,
               zon_zona zz,
               zon_secci zs,
               cra_perio pr,
               seg_perio_corpo pc,
               ( SELECT zh.gere,zh.cod_regi,
                        zh.cod_zona,
                        zh.cod_secc,
                        zh.acfi_exig_secc_nomb,
                        zh.perd_oid_peri_desd,
                        zh.perd_oid_peri_hast
                   FROM zon_histo_geren zh,
                        cra_perio pr,
                        seg_perio_corpo pc
                  WHERE zh.cod_secc IS NOT NULL
                    AND pr.peri_oid_peri = pc.oid_peri
                    AND pc.cod_peri = psCodigoPeriodo
                    AND pr.oid_peri >= zh.perd_oid_peri_desd
                    AND ( pr.oid_peri <= zh.perd_oid_peri_hast or zh.perd_oid_peri_hast is null)
               ) lider_actual,
               (SELECT  clc.cod_clie_lide,
                        CASE clc.cod_clas_lide
                        WHEN '01' THEN 'A1'
                        WHEN '02' THEN 'A2'
                        WHEN '03' THEN 'B1'
                        END cod_clas_lide
                  FROM let_corpo_lider_clasi clc
                 WHERE clc.cam_inic <= psCodigoPeriodo
                   AND nvl(clc.cam_fin,psCodigoPeriodo)>= psCodigoPeriodo
               ) clasi_actual
           WHERE zs.zzon_oid_zona = zz.oid_zona
             AND zz.zorg_oid_regi = zr.oid_regi
             AND zr.zsgv_oid_subg_vent = sgv.oid_subg_vent
             AND pr.peri_oid_peri = pc.oid_peri and pc.cod_peri =  psCodigoPeriodo
             AND ( pr.oid_peri >= zs.perd_oid_peri_inic or zs.perd_oid_peri_inic is null )
             AND ( pr.oid_peri <= zs.perd_oid_peri_fina or zs.perd_oid_peri_fina is null )
             AND zz.pais_oid_pais = zr.pais_oid_pais
             AND zz.marc_oid_marc = zr.marc_oid_marc
             AND zz.cana_oid_cana = zr.cana_oid_cana
             AND zr.pais_oid_pais = sgv.pais_oid_pais
             AND zr.marc_oid_marc = sgv.marc_oid_marc
             AND zr.cana_oid_cana = sgv.cana_oid_cana
             AND zr.cod_regi(+) = lider_actual.cod_regi
             AND zz.cod_zona(+) = lider_actual.cod_zona
             AND zs.cod_secc(+) = lider_actual.cod_secc
             AND lider_actual.gere(+) = clasi_actual.cod_clie_lide;

   TYPE interfazRec IS RECORD
       (
        AnioCampana                  VARCHAR2(6),
        CodZona                      zon_histo_geren.cod_zona%TYPE,
        CodSeccion                   zon_HISTO_GEREN.Cod_Secc%TYPE,
        CodLider                     ZON_HISTO_GEREN.GERE%TYPE,
        CodStatusLider               varchar2(2),
        FlagActiva                   varchar2(1),
        CodClasificacion             ZON_HISTO_GEREN.COD_LIDE_CLAS%TYPE,
        NroActExigSecNombramiento    ZON_HISTO_GEREN.ACFI_EXIG_SECC_NOMB%TYPE,
        FlagBajaLider                varchar2(1),
        CodBajaLider                 varchar2(2),
        AnioCampanaInicio            varchar2(6),
        AnioCampanaFin               varchar2(6)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana                   ||';'||
                                  interfazRecord(x).CodZona                       ||';'||
                                  interfazRecord(x).CodSeccion                    ||';'||
                                  interfazRecord(x).CodLider                      ||';'||
                                  interfazRecord(x).CodStatusLider                ||';'||
                                  interfazRecord(x).FlagActiva                    ||';'||
                                  interfazRecord(x).CodClasificacion              ||';'||
                                  TO_CHAR(interfazRecord(x).NroActExigSecNombramiento,'999999999') ||';'||
                                  interfazRecord(x).FlagBajaLider                 ||';'||
                                  interfazRecord(x).CodBajaLider                  ||';'||
                                  interfazRecord(x).AnioCampanaInicio             ||';'||
                                  interfazRecord(x).AnioCampanaFin                ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LIDER_SECCI: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_LIDER_SECCI;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Pedid  (DAT-139 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PEDID
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

      SELECT
             prn.cod_prog,
             prn.cod_nive,
             cne.des_nive,
             NVL(prn.num_pedi_inic,0),
             NVL(prn.num_pedi_fina,0),
             NVL(prn.num_pedi_plus,0),
             NVL(prn.num_pedi_tole,0),
             NVL(cpp.val_mont_gana_tole,0),
             NVL(prn.val_mont_gana,0),
             NVL(prn.val_mont_gana_sobr,0),
             NVL(prn.val_mont_gana_plus,0)
      FROM   LET_CORPO_PARAM_RANGO_NIVEL prn,
             SSICC_COMUN.LET_CORPO_NIVEL_EXITO cne,
             LET_CORPO_PARAM_PROGR cpp
      WHERE  prn.cod_nive = cne.cod_nive
      AND    prn.cod_pais = psCodigoPais
      AND    prn.cod_pais = cpp.cod_pais
      AND    prn.cod_prog = cpp.cod_prog
      AND    psCodigoPeriodo >= cpp.cam_inic
      AND    (psCodigoPeriodo <= cpp.cam_fin OR cpp.cam_fin IS NULL);


   TYPE interfazRec IS RECORD
       (
        CodPrograma           LET_CORPO_PARAM_RANGO_NIVEL.COD_PROG%TYPE,
        CodNivel              LET_CORPO_PARAM_RANGO_NIVEL.COD_NIVE%TYPE,
        DesNivel              SSICC_COMUN.LET_CORPO_NIVEL_EXITO.DES_NIVE%TYPE,
        RangoPedIni           LET_CORPO_PARAM_RANGO_NIVEL.NUM_PEDI_INIC%TYPE,
        RangoPedFin           LET_CORPO_PARAM_RANGO_NIVEL.NUM_PEDI_FINA%TYPE,
        SubRango              LET_CORPO_PARAM_RANGO_NIVEL.NUM_PEDI_PLUS%TYPE,
        Tolerancia            LET_CORPO_PARAM_RANGO_NIVEL.NUM_PEDI_TOLE%TYPE,
        DescPedidoMN          LET_CORPO_PARAM_PROGR.VAL_MONT_GANA_TOLE%TYPE,
        PagoXMetaPedMN        LET_CORPO_PARAM_RANGO_NIVEL.VAL_MONT_GANA%TYPE,
        PagoXPedExtraMN       LET_CORPO_PARAM_RANGO_NIVEL.VAL_MONT_GANA_SOBR%TYPE,
        PagoXPlus             LET_CORPO_PARAM_RANGO_NIVEL.VAL_MONT_GANA_PLUS%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodPrograma          ||';'||
                                  interfazRecord(x).CodNivel             ||';'||
                                  interfazRecord(x).DesNivel             ||';'||
                                  TO_CHAR(interfazRecord(x).RangoPedIni ,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).RangoPedFin ,'999999999')  ||';'||

                                  TO_CHAR(interfazRecord(x).SubRango  ,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).Tolerancia  ,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).DescPedidoMN  ,'9999999990.99')  ||';'||
                                  TO_CHAR(interfazRecord(x).PagoXMetaPedMN ,'9999999990.99')  ||';'||
                                  TO_CHAR(interfazRecord(x).PagoXPedExtraMN,'9999999990.99')  ||';'||
                                  TO_CHAR(interfazRecord(x).PagoXPlus,'9999999990.99')  ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL_PEDID: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_NIVEL_PEDID;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Reten  (DAT-140 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_RETEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

     SELECT
             crr.cod_prog,
             crr.num_ingr_inic,
             crr.num_ingr_fina,
             cpp.num_mini_ingr,--MinNroIngresos
             NVL(crr.val_porc_rete_22,0),
             NVL(crr.val_mont_gana,0),
             NVL(crr.val_porc_rete_33,0),
             NVL(crr.val_mont_gana_33,0),
             NVL(crr.val_porc_rete_44,0),
             NVL(crr.val_mont_gana_44,0)
      FROM   LET_CORPO_RANGO_RETEN crr,
             LET_CORPO_PARAM_PROGR cpp
      WHERE  crr.ind_acti <> '9'
      AND    cpp.ind_acti <> '9'
      AND    crr.cod_prog = cpp.cod_prog
      AND    crr.cod_pais = psCodigoPais
      AND    crr.cod_pais = cpp.cod_pais
      AND    psCodigoPeriodo >= cpp.cam_inic
      AND    (psCodigoPeriodo <= cpp.cam_fin OR cpp.cam_fin IS NULL);


   TYPE interfazRec IS RECORD
       (
        CodPrograma           LET_CORPO_RANGO_RETEN.COD_PROG%TYPE,
        RangoIngresos_Ini     LET_CORPO_RANGO_RETEN.NUM_INGR_INIC%TYPE,
        RangoIngresos_Fin     LET_CORPO_RANGO_RETEN.NUM_INGR_FINA%TYPE,
        MinNroIngresos        NUMBER(12),
        PorcRet2d2_Exigido    LET_CORPO_RANGO_RETEN.VAL_PORC_RETE_22%TYPE,
        PagoXIngEfecMN        LET_CORPO_RANGO_RETEN.VAL_MONT_GANA%TYPE,
        PorcRet3d3_Exigido    LET_CORPO_RANGO_RETEN.VAL_PORC_RETE_33%TYPE,
        PagoX3d3MN            LET_CORPO_RANGO_RETEN.VAL_MONT_GANA_33%TYPE,
        PorcRet4d4_Exigido    LET_CORPO_RANGO_RETEN.VAL_PORC_RETE_44%TYPE,
        PagoX4d4MN            LET_CORPO_RANGO_RETEN.VAL_MONT_GANA_44%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodPrograma           ||';'||
                                  TO_CHAR(interfazRecord(x).RangoIngresos_Ini     ,'9999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).RangoIngresos_Fin     ,'9999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).MinNroIngresos      ,'9999999999')   ||';'||
                                  TO_CHAR(interfazRecord(x).PorcRet2d2_Exigido ,'990.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).PagoXIngEfecMN ,'9999999990.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).PorcRet3d3_Exigido,'990.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).PagoX3d3MN ,'9999999990.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).PorcRet4d4_Exigido,'990.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).PagoX4d4MN ,'9999999990.99')   ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL_RETEN: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_NIVEL_RETEN;



/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider Result  (DAT-141 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_RESUL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

      SELECT
             psCodigoPeriodo                                 AnioCampana,
             csr.cod_prog                                    CodPrograma,
             csr.cod_clie_lide                               CodLider,
             csr.cod_zona||csr.cod_secc                      CodSeccion,
             NVL(cln.cod_nive, ' ')                          CodNivel,
             nvl(( SELECT nvl(rn.num_pedi_inic,0)
                 FROM let_corpo_param_rango_nivel rn
                WHERE rn.cod_prog = cpp.cod_prog AND
                      rn.cod_nive = cln.cod_nive
                  ),0
                 )                                           NumPedidos,
              ( SELECT COUNT(*)
                  FROM let_corpo_secci_resul r
                 WHERE r.cod_pais = csr.cod_pais
                   AND r.cod_prog = csr.cod_prog
                   AND r.cod_clie_lide = csr.cod_clie_lide
             ) NroCampanas,
             nvl(csr.num_ingr_real,0)                        RealNroActivas, --Real Nro Activas
             nvl(sop.num_pedi_obje,0)                        MetaPedidos,
             nvl(csr.num_pedi_real,0)                        RealNroPedidos,
             CASE csr.cod_esta_obje_pedi
                  WHEN '04' THEN '0' --No Asigna Resultado
                  WHEN '03' THEN '1' --Resultado tolerancia
                  WHEN '01' THEN '2' --Cumplimineto Objetivo
                  WHEN '02' THEN '3' --Sobrecumplimiento
                  ELSE NULL
             END                                             TipoGanancia,
             0                                               ExigenciaWeb,
             0                                               AccesoInternet,
             0                                               PocParametrizado,
             nvl((SELECT sum(val_mont_gana)
                    FROM LET_CORPO_LIDER_GANAN
             WHERE cod_clie_lide = csr.cod_clie_lide
             AND cam_gana = psCodigoPeriodo
                     AND cod_tipo_gana IN ('08')),0
                 ) AS                                        GanXPedMN,
             nvl((SELECT sum(val_mont_gana)
                    FROM LET_CORPO_LIDER_GANAN
             WHERE cod_clie_lide = csr.cod_clie_lide
             AND cam_gana = psCodigoPeriodo
                     AND cod_tipo_gana IN ('09','10','11')
                  ),0
                 ) AS                                        GanXCicloNuevasMN,

             nvl((SELECT val_mont_gana
                    FROM LET_CORPO_LIDER_GANAN
                   WHERE cod_clie_lide = csr.cod_clie_lide AND
                         cam_gana = psCodigoPeriodo AND
                         cod_tipo_gana = '05'
                  ),0) AS                                    GanXPlus,

             nvl((SELECT sum(val_mont_gana)
                    FROM LET_CORPO_LIDER_GANAN
             WHERE cod_clie_lide = csr.cod_clie_lide
             AND cam_gana = psCodigoPeriodo
                     AND cod_tipo_gana in ('08','05','09','10','11')
                  ),0) AS                                    GananciaSubTotal,
             nvl((SELECT sum(val_mont_gana)
                    FROM LET_CORPO_LIDER_GANAN
             WHERE cod_clie_lide = csr.cod_clie_lide
             AND cam_gana = psCodigoPeriodo
                     AND cod_tipo_gana in ('08','05','09','10','11')
                  ),0)                                       GananciaTotal,
             decode(csr.ind_prod,'E','P','N','C') CodRankingCampana,
             (SELECT max(cam_inic)
                FROM LET_CORPO_LIDER_NIVEL
               WHERE cod_clie_lide = csr.cod_clie_lide AND
                     ind_acti = '1'
             ) AS                                            CampanaUltimaAsignacionNiv,
             nvl(cpp.num_camp_mant_nive_exit,0)              NorCampanasMantenimiento,
             nvl(cpp.num_camp_gana_plus,0)                   NroCampanasPlus,
             0                                               Percentil

      FROM   LET_CORPO_SECCI_RESUL csr,
             LET_CORPO_LIDER_NIVEL cln,
             LET_CORPO_PARAM_PROGR cpp,
             LET_CORPO_SECCI_OBJET_PEDID sop

      WHERE  csr.cod_pais = psCodigoPais
      AND    csr.cod_clie_lide = cln.cod_clie_lide
      AND    cln.ind_tipo_nive = 'R'
      AND    cpp.cod_pais = csr.cod_pais
      AND    csr.cod_prog = cpp.cod_prog
      AND    psCodigoPeriodo >=  cpp.cam_inic
      AND    (psCodigoPeriodo <= cpp.cam_fin OR cpp.cam_fin IS NULL)
      AND    psCodigoPeriodo >=  cln.cam_inic
      AND    (psCodigoPeriodo <= cln.cam_fin OR cln.cam_fin IS NULL)
      AND    csr.cam_obje = psCodigoPeriodo
      AND    csr.cod_pais = sop.cod_pais
      AND    csr.cod_prog = sop.cod_prog
      AND    csr.cod_regi = sop.cod_regi
      AND    csr.cod_zona = sop.cod_zona
      AND    csr.cod_secc = sop.cod_secc
      AND    csr.cam_obje = sop.cam_obje;

   TYPE interfazRec IS RECORD
      (
        AnioCampana                  VARCHAR2(6),
        CodPrograma                  VARCHAR2(6),
        CodLider                     LET_CORPO_SECCI_RESUL.COD_CLIE_LIDE%TYPE,
        CodSeccion                   VARCHAR(5),
        CodNivel                     LET_CORPO_LIDER_NIVEL.COD_NIVE%TYPE,
        NumPedidos                   NUMBER(10) ,
        NroCampanas                  NUMBER(10) ,
        RealNroActivas               NUMBER(10) ,
        MetaPedidos                  LET_CORPO_SECCI_OBJET_PEDID.NUM_PEDI_OBJE%TYPE,
        RealNroPedidos               LET_CORPO_SECCI_RESUL.Num_Pedi_Real%TYPE,
        TipoGanancia                 VARCHAR2(1),
        ExigenciaWeb                 VARCHAR2(1),
        AccesoInternet               VARCHAR2(1),
        PocParametrizado             NUMBER(1,2),
        GanXPedMN                    LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        GanXCicloNuevasMN            LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        GanXPlus                     LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        GananciaSubTotal             LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        GananciaTotal                LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        CodRankingCampana            VARCHAR2(1),
        CampanaUltimaAsignacionNivel VARCHAR2(6),
        NroCampanasMantenimiento     NUMBER(10),
        NroCampanasPlus              NUMBER(10),
        Percentil                    NUMBER(10)
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana                   ||';'||
                                  interfazRecord(x).CodPrograma                   ||';'||
                                  interfazRecord(x).CodLider                      ||';'||
                                  interfazRecord(x).CodSeccion                    ||';'||
                                  interfazRecord(x).CodNivel                      ||';'||
                                  TO_CHAR(interfazRecord(x).NumPedidos,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).NroCampanas,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).RealNroActivas,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).MetaPedidos,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).RealNroPedidos,'999999999')  ||';'||
                                  interfazRecord(x).TipoGanancia                  ||';'||
                                  interfazRecord(x).ExigenciaWeb                  ||';'||
                                  interfazRecord(x).AccesoInternet                ||';'||
                                  interfazRecord(x).PocParametrizado              ||';'||
                                  TO_CHAR(interfazRecord(x).GanXPedMN,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).GanXCicloNuevasMN,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).GanXPlus,'999999999')   ||';'||
                                  TO_CHAR(interfazRecord(x).GananciaSubTotal,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).GananciaTotal,'999999999')  ||';'||
                                  interfazRecord(x).CodRankingCampana             ||';'||
                                  interfazRecord(x).CampanaUltimaAsignacionNivel  ||';'||
                                  TO_CHAR(interfazRecord(x).NroCampanasMantenimiento,'999999999')  ||';'||
                                  TO_CHAR(interfazRecord(x).NroCampanasPlus,'999999999')  ||';'||
                                  interfazRecord(x).Percentil                     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LIDER_RESUL: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_LIDER_RESUL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lider Reten  (DAT-142 )
Fecha Creacion    : 18/06/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LIDER_RETEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS
   CURSOR c_interfaz IS

      SELECT
             psCodigoPeriodo,
             csr.cod_prog,
             csr.cod_clie_lide,
             csr.cod_zona||csr.cod_secc,
             NVL(cln.cod_nive, ' '),
             nvl(cpp.num_mini_ingr,0),
             0 NroRecomendaciones,
             nvl(clo.num_ingr_efec_obje,0),
             nvl(csr.num_ingr_real,0),
             0 NroRecomendacionesAnt,
             nvl((SELECT val_mont_gana
                FROM LET_CORPO_LIDER_GANAN lg
             WHERE cod_clie_lide = csr.cod_clie_lide
             AND cam_gana = psCodigoPeriodo
                 AND cod_tipo_gana = '09'
               ),0) AS GanXIngEfectivosMN,
             nvl(cso.num_ingr_rete_33_obj,0),
             nvl(csr.num_ingr_33_real,0),
             0 NroIngSec_CampMenos2,
             nvl((SELECT val_mont_gana
                FROM LET_CORPO_LIDER_GANAN
               WHERE cod_clie_lide = csr.cod_clie_lide AND
                     cam_gana = psCodigoPeriodo AND
                     cod_tipo_gana = '10'
              ),0) AS GanX3d3MN,
             nvl(cso.num_ingr_rete_44_obj,0),
             nvl(csr.num_ingr_44_real,0),
             0 NroIngSec_CampMenos3,
             nvl((SELECT val_mont_gana
                    FROM LET_CORPO_LIDER_GANAN
                   WHERE cod_clie_lide = csr.cod_clie_lide AND
                         cam_gana = psCodigoPeriodo AND
                         cod_tipo_gana = '11'
                  ),0) AS GanX4d4MN,
             nvl((SELECT SUM(val_mont_gana)
                    FROM LET_CORPO_LIDER_GANAN
                   WHERE cod_clie_lide = csr.cod_clie_lide AND
                         cam_gana = psCodigoPeriodo AND
                         cod_tipo_gana IN ('09','10','11')
              ),0) AS GanXCicloNuevasMN

      FROM   LET_CORPO_SECCI_RESUL csr,
             LET_CORPO_LIDER_NIVEL cln,
             LET_CORPO_PARAM_PROGR cpp,
             LET_CORPO_LIDER_OBJET clo,
             LET_CORPO_SECCI_OBJET cso

      WHERE  csr.cod_pais = psCodigoPais
      AND    csr.cam_obje = psCodigoPeriodo
      AND    csr.cod_clie_lide = cln.cod_clie_lide
      AND    cln.ind_tipo_nive = 'R'
      AND    cpp.cod_pais = csr.cod_pais
      AND    cpp.cod_prog = csr.cod_prog
      AND    psCodigoPeriodo >=  cpp.cam_inic
      AND    (psCodigoPeriodo <= cpp.cam_fin OR cpp.cam_fin IS NULL)
      AND    psCodigoPeriodo >=  cln.cam_inic
      AND    (psCodigoPeriodo <= cln.cam_fin OR cln.cam_fin IS NULL)
      AND    csr.cod_pais = cso.cod_pais
      AND    csr.cod_prog = cso.cod_prog
      AND    csr.cod_regi = cso.cod_regi
      AND    csr.cod_zona = cso.cod_zona
      AND    csr.cod_secc = cso.cod_secc
      AND    csr.cam_obje = cso.cam_obje
      AND    csr.cod_clie_lide = clo.cod_clie_lide
      AND    csr.cam_obje = clo.cam_obje;

   TYPE interfazRec IS RECORD
      (
        AnioCampana                  VARCHAR2(6),
        CodPrograma                  VARCHAR2(6),
        CodLider                     LET_CORPO_SECCI_RESUL.COD_CLIE_LIDE%TYPE,
        CodSeccion                   VARCHAR2(5),
        CodNivel                     LET_CORPO_LIDER_NIVEL.COD_NIVE%TYPE,
        MinNroIngresos               LET_CORPO_PARAM_PROGR.num_mini_ingr%type ,
        NroRecomendaciones           NUMBER(10),
        MetaIngEfectivos             LET_CORPO_LIDER_OBJET.NUM_INGR_EFEC_OBJE%TYPE ,
        RealIngEfectivos             LET_CORPO_SECCI_RESUL.NUM_PEDI_REAL%TYPE,
        NroRecomendacionesAnt        NUMBER(10),
        GanXIngEfectivosMN           LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        Meta3d3                      LET_CORPO_SECCI_OBJET.NUM_INGR_RETE_33_OBJ%TYPE,
        Real3d3                      LET_CORPO_SECCI_RESUL.NUM_INGR_33_REAL%TYPE,
        NroIngSec_CampMenos2         NUMBER(10),
        GanX3d3MN                    LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        Meta4d4                      LET_CORPO_SECCI_OBJET.NUM_INGR_RETE_44_OBJ%TYPE,
        Real4d4                      LET_CORPO_SECCI_RESUL.NUM_INGR_44_REAL%TYPE,
        NroIngSec_CampMenos3         NUMBER(10),
        GanX4d4MN                    LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE,
        GanXCicloNuevasMN            LET_CORPO_LIDER_GANAN.VAL_MONT_GANA%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana                                 ||';'||
                                  interfazRecord(x).CodPrograma                                 ||';'||
                                  interfazRecord(x).CodLider                                    ||';'||
                                  interfazRecord(x).CodSeccion                                  ||';'||
                                  interfazRecord(x).CodNivel                         	          ||';'||
                                  TO_CHAR(interfazRecord(x).MinNroIngresos,'999999999')         ||';'||
                                  interfazRecord(x).NroRecomendaciones                          ||';'||
                                  TO_CHAR(interfazRecord(x).MetaIngEfectivos,'999999999')       ||';'||
                                  TO_CHAR(interfazRecord(x).RealIngEfectivos,'999999999')  	    ||';'||
                                  interfazRecord(x).NroRecomendacionesAnt       	              ||';'||
                                  TO_CHAR(interfazRecord(x).GanXIngEfectivosMN,'9999999990.99')  ||';'||
                                  TO_CHAR(interfazRecord(x).Meta3d3,'999999999')                ||';'||
                                  TO_CHAR(interfazRecord(x).Real3d3,'999999999')                ||';'||
                                  TO_CHAR(interfazRecord(x).NroIngSec_CampMenos2,'999999999')   ||';'||
                                  TO_CHAR(interfazRecord(x).GanX3d3MN,'9999999990.99')           ||';'||
                                  TO_CHAR(interfazRecord(x).Meta4d4,'999999999')                ||';'||
                                  TO_CHAR(interfazRecord(x).Real4d4,'999999999')                ||';'||
                                  TO_CHAR(interfazRecord(x).NroIngSec_CampMenos3,'999999999')   ||';'||
                                  TO_CHAR(interfazRecord(x).GanX4d4MN,'9999999990.99')           ||';'||
                                  TO_CHAR(interfazRecord(x).GanXCicloNuevasMN,'9999999990.99')   ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LIDER_RETEN: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_LIDER_RETEN;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Fases Programa  (DAT-143 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FASE_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS

 CURSOR c_interfaz IS

      SELECT fpr.cod_fase,
             'FASE ' || fpr.cod_fase as des_fase,
             fpr.cod_camp_inic,
             fpr.cod_camp_fina,
             0 AS NroCampanasCriticaFase
        FROM EJE_FASES_PROGR fpr,
             EJE_PROGR prg
       WHERE prg.ind_acti = 1
         AND fpr.ind_acti = 1
         AND prg.pais_cod_pais = psCodigoPais
         AND prg.pais_cod_pais = fpr.pais_cod_pais
         AND prg.cod_prog_ejec = fpr.cod_prog_ejec
         AND psCodigoPeriodo >= prg.cod_camp_inic
         AND (psCodigoPeriodo <= prg.cod_camp_fina OR prg.cod_camp_fina IS NULL);

   TYPE interfazRec IS RECORD
      (
        CodFase                      VARCHAR2(6),
        DesFase                      VARCHAR2(50),
        AnioCampanaInicio            VARCHAR2(6),
        AnioCampanaFin               VARCHAR2(6),
        NroCampanasCriticaFase       NUMBER(1)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */
             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodFase                                 ||';'||
                                  interfazRecord(x).DesFase                                 ||';'||
                                  interfazRecord(x).AnioCampanaInicio                       ||';'||
                                  interfazRecord(x).AnioCampanaFin                          ||';'||
                                  TO_CHAR(interfazRecord(x).NroCampanasCriticaFase,'9')     ;

                       UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_FASE_PROGR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_FASE_PROGR;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Nivel Programa  (DAT-144 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS

 CURSOR c_interfaz IS

      SELECT npr.cod_nive,
             npr.des_nive
        FROM EJE_NIVEL_PROGR npr,
             EJE_PROGR prg
       WHERE prg.ind_acti = 1
         AND npr.ind_acti = 1
         AND prg.pais_cod_pais = psCodigoPais
         AND prg.pais_cod_pais = npr.pais_cod_pais
         AND prg.cod_prog_ejec = npr.cod_prog_ejec
         AND psCodigoPeriodo >= prg.cod_camp_inic
         AND (psCodigoPeriodo <= prg.cod_camp_fina OR prg.cod_camp_fina IS NULL);


   TYPE interfazRec IS RECORD
      (
        CodNivel                      VARCHAR2(6),
        DesNivel                      VARCHAR2(50)

      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodNivel      ||';'||
                                  interfazRecord(x).DesNivel        ;
                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL_PROGR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_NIVEL_PROGR;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Parametros Programa  (DAT-145 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PARAM_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS

 CURSOR c_interfaz IS

      SELECT nrp.cod_fase,
             nrp.cod_nive,
             nrp.cod_rang,
             0 AS RangoMinPedido,
             0 AS RangoMaxPedido,
             nrp.val_porc_comi
        FROM EJE_NIVEL_RANGO_PROGR nrp,
             EJE_PROGR prg
       WHERE prg.ind_acti = 1
         AND prg.pais_cod_pais = psCodigoPais
         AND nrp.pais_cod_pais = prg.pais_cod_pais
         AND nrp.cod_prog_ejec = prg.cod_prog_ejec
         AND psCodigoPeriodo >= prg.cod_camp_inic
         AND (psCodigoPeriodo <= prg.cod_camp_fina
          OR prg.cod_camp_fina IS NULL);


   TYPE interfazRec IS RECORD
      (
        CodFase                       VARCHAR2(6),
        CodNivel                      VARCHAR2(2),
        CodRango                      VARCHAR2(2),
        RangoMinPedido                NUMBER(10),
        RangoMaxPedido                NUMBER(10),
        PorcComision                  NUMBER(12,2)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).CodFase          ||';'||
                                  interfazRecord(x).CodNivel         ||';'||
                                  interfazRecord(x).CodRango         ||';'||
                                  TO_CHAR(interfazRecord(x).RangoMinPedido,'9999999999')     ||';'||
                                  TO_CHAR(interfazRecord(x).RangoMaxPedido,'9999999999')     ||';'||
                                  TO_CHAR(interfazRecord(x).PorcComision,'9999999999.99')     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PARAM_PROGR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_PARAM_PROGR;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultados Ejecutiva  (DAT-146 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EJECU_RESUL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS

 CURSOR c_interfaz IS

      SELECT esc.cam_proc,
             nrp.cod_fase,
             mse.clie_cod_clie,
             esc.cod_nive,
             esc.val_real_pedi,
             esc.val_real_ingr,
             dms.val_mont_venta,
             esc.val_mont_comi,
             dms.val_mont_reca
        FROM EJE_NIVEL_RANGO_PROGR nrp,
             EJE_METAS_SECCI mse,
             EJE_EVALU_SECCI_CAMPA esc,
             EJE_DETAL_MOVIM_SECCI dms,
             EJE_PROGR prg
       WHERE prg.ind_acti = 1
         AND prg.pais_cod_pais = psCodigoPais
         AND nrp.pais_cod_pais = prg.pais_cod_pais
         AND nrp.cod_prog_ejec = prg.cod_prog_ejec
         AND prg.pais_cod_pais = mse.pais_cod_pais
         AND prg.cod_prog_ejec = mse.cod_prog_ejec
         AND mse.cam_proc = psCodigoPeriodo
         AND esc.pais_cod_pais = mse.pais_cod_pais
         AND esc.cod_prog_ejec = mse.cod_prog_ejec
         AND esc.cod_secc      = mse.cod_secc
         AND esc.cam_proc = mse.cam_proc
         AND dms.pais_cod_pais = esc.pais_cod_pais
         AND dms.cod_prog_ejec = esc.cod_prog_ejec
         AND dms.cod_secc      = esc.cod_secc
         AND dms.cam_proc = esc.cam_proc
         AND psCodigoPeriodo >= prg.cod_camp_inic
         AND (psCodigoPeriodo <= prg.cod_camp_fina OR prg.cod_camp_fina IS NULL);


   TYPE interfazRec IS RECORD
      (
        AnioCampana                   VARCHAR2(6),
        CodFase                       VARCHAR2(6),
        CodEjecutiva                  VARCHAR2(15),
        CodNivel                      VARCHAR2(2),
        NroPedidosAlcanzado           NUMBER(12),
        NroIngresosAlcanzado          NUMBER(12),
        MontoVentaMNAlcanzado         NUMBER(12,2),
        ComisionMN21dias              NUMBER(12,2),
        RecaudoMN21dias               NUMBER(12,2)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana                                	     ||';'||
                                  interfazRecord(x).CodFase                                          ||';'||
                                  interfazRecord(x).CodEjecutiva                                   	 ||';'||
                                  interfazRecord(x).CodNivel                                         ||';'||
                                  TO_CHAR(interfazRecord(x).NroPedidosAlcanzado,'999999999999')      ||';'||
                                  TO_CHAR(interfazRecord(x).NroIngresosAlcanzado,'999999999999')     ||';'||
                                  TO_CHAR(interfazRecord(x).MontoVentaMNAlcanzado,'9999999999.99')   ||';'||
                                  TO_CHAR(interfazRecord(x).ComisionMN21dias,'9999999999.99')        ||';'||
                                  TO_CHAR(interfazRecord(x).RecaudoMN21dias,'9999999999.99')         ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_EJECU_RESUL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_EJECU_RESUL;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Metas Seccion  (DAT-147 )
Fecha Creacion    : 01/07/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo: Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_META_SECCI
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
IS

 CURSOR c_interfaz IS

      SELECT mse.cam_proc ,
             fpr.cod_fase,
             mse.clie_cod_clie,
             mse.val_meta_pedi,
             mse.val_meta_ingr
        FROM EJE_METAS_SECCI mse,
             EJE_FASES_PROGR fpr
       WHERE fpr.ind_acti = 1
         AND fpr.pais_cod_pais = psCodigoPais
         AND fpr.pais_cod_pais = mse.pais_cod_pais
         AND fpr.cod_prog_ejec = mse.cod_prog_ejec
         AND mse.cam_proc = psCodigoPeriodo
         AND psCodigoPeriodo >= fpr.cod_camp_inic
         AND (psCodigoPeriodo <= fpr.cod_camp_fina OR fpr.cod_camp_fina IS NULL);
	 TYPE interfazRec IS RECORD
      (
        AnioCampana             VARCHAR2(6),
        CodFase                 VARCHAR2(6),
        CodEjecutiva            VARCHAR2(10),
        NroPedidosObjetivo      NUMBER(10),
        NroIngresosObjetivo     NUMBER(10)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana         ||';'||
                                  interfazRecord(x).CodFase             ||';'||
                                  interfazRecord(x).CodEjecutiva        ||';'||
                                  TO_CHAR(interfazRecord(x).NroPedidosObjetivo,'9999999999') ||';'||
                                  TO_CHAR(interfazRecord(x).NroIngresosObjetivo,'99999999999') ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_META_SECCI: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_META_SECCI;


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Roles  (DAT-212)
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ROL_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
is
CURSOR c_interfaz IS


   SELECT cod_rol,
          des_rol
   FROM   zon_direc_rol
   WHERE  est_regi <> 9;

	 TYPE interfazRec IS RECORD
      (
        codRol            VARCHAR2(2),
        desRol            VARCHAR2(50)

      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codRol     ||';'||
                                  interfazRecord(x).desRol         ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_ROL_DIREC: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_ROL_DIREC;


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Perfiles  (DAT-213 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PERFI_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
is
CURSOR c_interfaz IS


   SELECT cod_perf,
          des_perf
   FROM   zon_direc_perfi
   WHERE  est_regi <> 9;

	 TYPE interfazRec IS RECORD
      (
        codPerfi            VARCHAR2(3),
        desPerfi            VARCHAR2(50)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPerfi     ||';'||
                                  interfazRecord(x).desPerfi         ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PERFI_DIREC: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_PERFI_DIREC;


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Cargo  (DAT-214 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_CARGO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
  IS

CURSOR c_interfaz IS


     SELECT cod_tipo_carg,
            des_tipo_carg,
            rol_cod_rol,
            perf_cod_perf
     FROM   zon_tipo_cargo
     WHERE  est_regi <> 9;

	 TYPE interfazRec IS RECORD
      (
        codCargo            VARCHAR2(3),
        desCargo            VARCHAR2(50),
        codRol              VARCHAR2(2),
        codPerfil           VARCHAR2(3)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codCargo     ||';'||
                                  interfazRecord(x).desCargo     ||';'||
                                  interfazRecord(x).codRol       ||';'||
                                  interfazRecord(x).codPerfil    ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_CARGO: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TIPO_CARGO;


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Operacion  (DAT-216 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_OPERA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
  IS

CURSOR c_interfaz IS


     SELECT cod_tipo_oper,
            des_tipo_oper
     FROM   zon_tipo_opera
     WHERE  est_regi <> 9;

	 TYPE interfazRec IS RECORD
      (
        codTipoOper           VARCHAR2(2),
        desTipoOper           VARCHAR2(50)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codTipoOper     ||';'||
                                  interfazRecord(x).desTipoOper    ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_OPERA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TIPO_OPERA;


 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo licencia  (DAT-215 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_LICEN
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
  IS

CURSOR c_interfaz IS


      SELECT cod_moti_lice,
             des_moti_lice
      FROM  zon_motiv_licen
      WHERE est_regi <> 9;


	 TYPE interfazRec IS RECORD
      (
        codMotiLicen           VARCHAR2(2),
        desMotiLicen           VARCHAR2(50)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codMotiLicen     ||';'||
                                  interfazRecord(x).desMotiLicen     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_LICEN: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TIPO_LICEN;

 /***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Clientes (DAT- 217)
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLIEN_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)

 IS

CURSOR c_interfaz IS

SELECT DISTINCT
       mc.cod_clie,
       mcd.cod_cub,
       mc.val_ape1 || nvl2(mc.val_ape2,' ','') || mc.val_ape2 || nvl2(mc.val_nom1,' ','') ||  mc.val_nom1 || nvl2(mc.val_nom2,' ','') ||  mc.val_nom2 AS  desApeNom ,
       (SELECT num_docu_iden FROM mae_clien_ident
       WHERE val_iden_docu_prin = 1
       AND clie_oid_clie = mc.oid_clie) AS nro_documento,
       mcd.cod_empl,
       (SELECT MIN(zdvc.FEC_REGI) FROM zon_direc_venta_cabec zdvc
       WHERE zdvc.tiop_cod_tipo_oper = 'IN'
       AND cod_clie = mc.cod_clie) AS fec_ing_dir ,
       (SELECT MIN(zdvc.CAM_PROC) FROM zon_direc_venta_cabec zdvc
       WHERE zdvc.tiop_cod_tipo_oper = 'IN'
       AND cod_clie = mc.cod_clie) AS cam_ing_dir,
       (SELECT VAL_TEXT_COMU FROM MAE_CLIEN_COMUN
       WHERE  CLIE_OID_CLIE = mc.oid_clie
       AND TICM_OID_TIPO_COMU = 2006 ) AS mail_belcorp ,
       (SELECT VAL_TEXT_COMU FROM MAE_CLIEN_COMUN
       WHERE  CLIE_OID_CLIE = mc.oid_clie
       AND TICM_OID_TIPO_COMU = 3 ) AS mail_personal  ,
       (SELECT SUBSTR(VAL_TEXT_COMU,1,30) FROM MAE_CLIEN_COMUN
       WHERE  CLIE_OID_CLIE = mc.oid_clie
       AND TICM_OID_TIPO_COMU = 1 ) AS telefono,
       (SELECT SUBSTR(VAL_TEXT_COMU,1,30) FROM MAE_CLIEN_COMUN
       WHERE  CLIE_OID_CLIE = mc.oid_clie
       AND TICM_OID_TIPO_COMU = 6 ) AS celular
  FROM MAE_CLIEN mc,
       MAE_CLIEN_DATOS_ADICI mcd,
       zon_direc_venta_cabec zdc
 WHERE mc.oid_clie = mcd.clie_oid_clie
   AND zdc.cod_clie = mc.cod_clie
   AND zdc.ind_esta <> 'I'
   AND zdc.est_regi = 1;

CURSOR c_interfaz_fox IS


SELECT DISTINCT
       zc.cod_clie,
       zc.cod_cub,
       zc.ape_pate || nvl2(zc.ape_mate,' ','') || zc.ape_mate || nvl2(zc.val_nom1,' ','') ||  zc.val_nom1 || nvl2(zc.val_nom2,' ','') ||  zc.val_nom2 AS  desApeNom ,
       zc.num_docu AS nro_documento,
       zc.cod_empl,
       (SELECT MIN(zdvc.FEC_REGI) FROM zon_direc_venta_cabec zdvc
       WHERE zdvc.tiop_cod_tipo_oper = 'IN'
       AND cod_clie = zc.cod_clie) AS fec_ing_dir ,
       (SELECT MIN(zdvc.CAM_PROC) FROM zon_direc_venta_cabec zdvc
       WHERE zdvc.tiop_cod_tipo_oper = 'IN'
       AND cod_clie = zc.cod_clie) AS cam_ing_dir,
       zc.dir_mail_belc AS mail_belcorp ,
       zc.dir_mail AS mail_personal  ,
       zc.num_telf_casa AS telefono,
       zc.num_telf_celu AS celular
  FROM ZON_DIREC_CLIEN zc,
       zon_direc_venta_cabec zdc
 WHERE zdc.cod_clie = zc.cod_clie
   AND zdc.ind_esta <> 'I'
   AND zdc.est_regi = 1
   AND zc.pais_cod_pais = psCodigoPais
   AND zc.pais_cod_pais = zdc.pais_cod_pais ;

	 TYPE interfazRec IS RECORD
      (
        codCliente           VARCHAR2(10),
        codCub               VARCHAR2(20),
        desApeNom            VARCHAR2(100),
        docIdentidad         VARCHAR2(30),
        codPlanilla          VARCHAR2(10),
        fecIngDir            DATE,
        camIngDir            VARCHAR2(6),
        mailBelcorp          VARCHAR2(100),
        mailPersonal         VARCHAR2(100),
        telCasa              VARCHAR2(30),
        telCelular           VARCHAR2(30)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
   lsTipoPais          VARCHAR2(8);


BEGIN

    lbAbrirUtlFile:= TRUE;

    SELECT TCON_COD_TCON
    INTO lsTipoPais
    FROM  BAS_PAIS
    WHERE COD_PAIS =  psCodigoPais;

    /* Generando Archivo de Texto  */


    IF lsTipoPais = 'ORA' THEN

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codCliente     ||';'||
                                  interfazRecord(x).codCub         ||';'||
                                  interfazRecord(x).desApeNom      ||';'||
                                  interfazRecord(x).docIdentidad   ||';'||
                                  interfazRecord(x).codPlanilla    ||';'||
                                  TO_CHAR(interfazRecord(x).fecIngDir,'dd/mm/yyyy')  ||';'||
                                  interfazRecord(x).camIngDir      ||';'||
                                  interfazRecord(x).mailBelcorp    ||';'||
                                  interfazRecord(x).mailPersonal   ||';'||
                                  interfazRecord(x).telCasa        ||';'||
                                  interfazRecord(x).telCelular     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    ELSE

     OPEN c_interfaz_fox;
        LOOP
           FETCH c_interfaz_fox BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codCliente     ||';'||
                                  interfazRecord(x).codCub         ||';'||
                                  interfazRecord(x).desApeNom      ||';'||
                                  interfazRecord(x).docIdentidad   ||';'||
                                  interfazRecord(x).codPlanilla    ||';'||
                                  TO_CHAR(interfazRecord(x).fecIngDir,'dd/mm/yyyy')  ||';'||
                                  interfazRecord(x).camIngDir      ||';'||
                                  interfazRecord(x).mailBelcorp    ||';'||
                                  interfazRecord(x).mailPersonal   ||';'||
                                  interfazRecord(x).telCasa        ||';'||
                                  interfazRecord(x).telCelular     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz_fox%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz_fox;

    END IF;



    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CLIEN_DIREC : '||ls_sqlerrm);


END INT_PR_DAT_ENVIO_CLIEN_DIREC;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Operaciones (DAT-218 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_OPERA_DIREC
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

 IS

CURSOR c_repetidas (lsCamProc VARCHAR2, lsCodCliente VARCHAR2 , lsCodRegi VARCHAR2, lsCodZona VARCHAR2 ) IS
    WITH zon_direc_repe as (
                         SELECT DT.PAIS_COD_PAIS, dt.cod_regi, NVL(dt.cod_zona,'XXXX') AS cod_zona,  dt.cod_clie --, count(*)
                         FROM  zon_direc_venta_DETAL dt,
                               zon_direc_venta_cabec cb
                         WHERE cb.pais_cod_pais = dt.pais_cod_pais
                           AND cb.cor_dire_vent = dt.dica_cor_dire_vent
                           AND cb.tiop_cod_tipo_oper = dt.tiop_cod_tipo_oper
                           AND cb.tica_cod_tipo_carg = dt.tica_cod_tipo_carg
                           AND cb.cod_clie           = dt.cod_clie
                           AND (dt.est_regi = '1' or dt.est_regi is null)
                           AND (cb.EST_REGI = '1' or cb.est_regi is null)
                           AND lsCamProc >= cb.cam_proc
                           AND cb.pais_cod_pais = psCodigoPais
                           AND dt.tica_cod_tipo_carg in ('GZ','GR','APR','APZ', 'YRF', 'YZF','MVR','MVZ')
                           AND  cb.esca_cod_esta_carg <> 'I'
                           GROUP BY DT.PAIS_COD_PAIS, dt.cod_regi, dt.cod_zona,  dt.cod_clie
                           HAVING (count(*)>1)

           ) ,
           zon_direc_consu as (
                         SELECT zdt.PAIS_COD_PAIS, zdt.cod_regi, NVL(zdt.cod_zona,'XXXX') as cod_zona,  zdt.cod_clie , zdt.tica_cod_tipo_carg
                         FROM  zon_direc_venta_DETAL zdt,
                               zon_direc_venta_cabec zcb
                         WHERE zcb.pais_cod_pais = zdt.pais_cod_pais
                           AND zcb.cor_dire_vent = zdt.dica_cor_dire_vent
                           AND zcb.tiop_cod_tipo_oper = zdt.tiop_cod_tipo_oper
                           AND zcb.tica_cod_tipo_carg = zdt.tica_cod_tipo_carg
                           AND zcb.cod_clie           = zdt.cod_clie
                           AND (zdt.est_regi = '1' or zdt.est_regi is null)
                           AND (zcb.EST_REGI = '1' or zcb.est_regi is null)
                           AND lsCamProc >= zcb.cam_proc
                           AND zcb.pais_cod_pais = psCodigoPais
                           AND zdt.tica_cod_tipo_carg in ('GZ','GR','APR','APZ', 'YRF', 'YZF','MVR','MVZ')
                           AND zcb.esca_cod_esta_carg <> 'I'

           )

                    SELECT   zdc.PAIS_COD_PAIS, zdc.cod_regi, zdc.cod_zona,  zdc.cod_clie , zdc.tica_cod_tipo_carg
                     FROM    zon_direc_consu       zdc ,
                             ZON_DIREC_REPE        zdr
                     WHERE   zdc.PAIS_COD_PAIS =  zdr.PAIS_COD_PAIS
                       AND   zdc.cod_regi = zdr.cod_regi
                       AND   (zdc.cod_zona = zdr.cod_zona )
                       AND   zdc.cod_clie = zdr.cod_clie
                       AND   zdc.cod_CLIE = lsCodCliente
                       AND   zdc.cod_regi = lsCodRegi
                       AND   zdc.cod_zona = lsCodZona
                       AND   ( zdc.tica_cod_tipo_carg NOT IN ('GZ', 'GR') AND
                               zdc.tica_cod_tipo_carg IN ('APR','APZ', 'YRF', 'YZF'))

                    UNION
                   SELECT   zc.PAIS_COD_PAIS, zc.cod_regi, zc.cod_zona,  zc.cod_clie , zc.tica_cod_tipo_carg
                     FROM   zon_direc_consu       zc ,
                            ZON_DIREC_REPE        zr
                     WHERE   zc.PAIS_COD_PAIS =  zr.PAIS_COD_PAIS
                       AND   zc.cod_regi = zr.cod_regi
                       AND   (zc.cod_zona = zr.cod_zona )
                       AND   zc.cod_clie = zr.cod_clie
                       AND   zc.cod_CLIE = lsCodCliente
                       AND   zc.cod_regi = lsCodRegi
                       AND   zc.cod_zona = lsCodZona
                       AND   (zc.tica_cod_tipo_carg  IN ('MVZ', 'MVR') AND zc.tica_cod_tipo_carg NOT IN
                               ('APR','APZ', 'YRF', 'YZF'))
                       ORDER BY 1,2,3,4;

CURSOR c_interfaz (lsCamAct VARCHAR2) IS

      SELECT TAB.*
        FROM (SELECT   lsCamAct AS cod_peri ,
                       d.cod_regi,
                       NVL(d.cod_zona,'XXXX'),
                       c.cod_clie,
                       (SELECT p.cod_perf
                        FROM zon_tipo_cargo        tcar,
                             zon_direc_venta_cabec c,
                             zon_direc_perfi       p
                       WHERE tcar.cod_tipo_carg = c.tica_cod_tipo_carg
                         and p.cod_perf = tcar.perf_cod_perf
                         and c.cor_dire_vent = d.dica_cor_dire_vent
                         AND C.EST_REGI=1) PERFIL  ,
                       (SELECT r.cod_rol
                        FROM zon_tipo_cargo        tcar,
                             zon_direc_venta_cabec c,
                             zon_direc_rol r
                       WHERE tcar.cod_tipo_carg = c.tica_cod_tipo_carg
                         and r.cod_rol = tcar.rol_cod_rol
                         and c.cor_dire_vent = d.dica_cor_dire_vent
                         AND c.est_regi=1) ROL,
                       c.tica_cod_tipo_carg,
                       c.tiop_cod_tipo_oper,
                       e.COD_ESTA_CARG,
                       c.moti_cod_moti_lice,
                       TO_CHAR(c.fec_regi , 'dd/mm/yyyy') fecha_regi,
                       TO_CHAR(c.fec_regi_fin, 'dd/mm/yyyy') fecha_fin
                FROM zon_direc_venta_cabec c,
                     zon_direc_venta_detal d,
                     zon_estat_cargo       e

               WHERE c.pais_cod_pais = d.pais_cod_pais(+)
                 AND c.cor_dire_vent = d.dica_cor_dire_vent(+)
                 AND c.tiop_cod_tipo_oper = d.tiop_cod_tipo_oper(+)
                 AND c.tica_cod_tipo_carg = d.tica_cod_tipo_carg(+)
                 AND c.cod_clie = d.cod_clie(+)
                 AND c.esca_cod_esta_carg = e.cod_esta_carg
                 AND c.esca_cod_esta_carg <> 'I'
                 AND (d.est_regi = '1' or d.est_regi is null)
                 AND (c.EST_REGI = '1' or c.est_regi is null)
                 AND c.pais_cod_pais = psCodigoPais
                 AND lsCamAct  >= c.cam_proc
             UNION
              SELECT   cm.cod_peri,
                       d.cod_regi,
                         NVL(d.cod_zona,'XXXX'),
                       c.cod_clie,
                       (SELECT p.cod_perf
                        FROM zon_tipo_cargo        tcar,
                             zon_direc_venta_cabec c,
                               zon_direc_perfi       p
                       WHERE tcar.cod_tipo_carg = c.tica_cod_tipo_carg
                         and p.cod_perf = tcar.perf_cod_perf
                         and c.cor_dire_vent = d.dica_cor_dire_vent
                         AND C.EST_REGI=1) PERFIL  ,
                       (SELECT r.cod_rol
                        FROM zon_tipo_cargo        tcar,
                             zon_direc_venta_cabec c,
                               zon_direc_rol r
                       WHERE tcar.cod_tipo_carg = c.tica_cod_tipo_carg
                         and r.cod_rol = tcar.rol_cod_rol
                         and c.cor_dire_vent = d.dica_cor_dire_vent
                         AND c.est_regi=1) ROL,
                       c.tica_cod_tipo_carg,
                       c.tiop_cod_tipo_oper,
                       e.COD_ESTA_CARG,
                       c.moti_cod_moti_lice,
                       TO_CHAR(c.fec_regi , 'dd/mm/yyyy') fecha_regi,
                       TO_CHAR(c.fec_regi_fin, 'dd/mm/yyyy') fecha_fin
                  FROM zon_direc_venta_cabec c,
                       zon_direc_venta_detal d,
                       zon_estat_cargo       e,
                     (SELECT
                      GEN_PKG_GENER.gen_fn_perio_nsigu(psCodigoPais , lsCamAct ,1)
                      AS cod_peri
                      FROM DUAL) cm
               WHERE c.pais_cod_pais = d.pais_cod_pais(+)
                 AND c.cor_dire_vent = d.dica_cor_dire_vent(+)
                 AND c.tiop_cod_tipo_oper = d.tiop_cod_tipo_oper(+)
                 AND c.tica_cod_tipo_carg = d.tica_cod_tipo_carg(+)
                 AND c.cod_clie = d.cod_clie(+)
                 AND c.esca_cod_esta_carg = e.cod_esta_carg
                 AND c.esca_cod_esta_carg <> 'I'
                 AND (d.est_regi = '1' or d.est_regi is null)
                 AND (c.EST_REGI = '1' or c.est_regi is null)
                 AND c.pais_cod_pais = psCodigoPais
                 AND cm.cod_peri = c.cam_proc
              ) TAB
      WHERE 1 = 1
      ORDER BY TAB.cod_peri ASC;

TYPE interfazRec IS RECORD
      (
        codCamp             VARCHAR2(6),
        codRegion           VARCHAR2(3),
        codZona             VARCHAR2(6),
        codCliente          VARCHAR2(10),
        codPerfil           VARCHAR2(3),
        codRol              VARCHAR2(2),
        codCargo            VARCHAR2(3),
        codTipoOpera        VARCHAR2(2),
        codEstado           VARCHAR2(2),
        codMotivLicen       VARCHAR2(2),
        fecIniAsig          VARCHAR2(10),
        fecFinAsig          VARCHAR2(10)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
   lsCamAct            VARCHAR2(6);
   lsTipoPais          VARCHAR2(8);
   lbRepeticion        BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

/*     select cod_peri
      into  lsCamAct
                from bas_ctrl_fact
                where sta_camp = 0
                and  ind_camp_act = 1;*/

    SELECT TCON_COD_TCON
    INTO lsTipoPais
    FROM  BAS_PAIS
    WHERE COD_PAIS =  psCodigoPais;

    lsCamAct := psCodigoPeriodo;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz( lsCamAct );
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lbRepeticion := FALSE;

                      FOR cREP IN c_repetidas(lsCamAct, interfazRecord(x).codCliente, interfazRecord(x).codRegion, interfazRecord(x).codZona  ) LOOP
                           IF (interfazRecord(x).codCargo = cREP.tica_cod_tipo_carg AND interfazRecord(x).codCamp = lsCamAct  ) THEN
                            lbRepeticion := TRUE;
                           END IF;
                      END LOOP;

                       IF  (lbRepeticion = FALSE) THEN
                    IF lsTipoPais = 'FOX' THEN
                       interfazRecord(x).codRegion := '1' || interfazRecord(x).codRegion ;
                       IF interfazRecord(x).codZona <> 'XXXX' THEN
                         interfazRecord(x).codZona := interfazRecord(x).codZona || '00';
                       END IF;
                    END IF;

                      lsLinea :=  interfazRecord(x).codCamp      ||';'||
                                  interfazRecord(x).codRegion    ||';'||
                                  interfazRecord(x).codZona      ||';'||
                                  interfazRecord(x).codCliente   ||';'||
                                  interfazRecord(x).codPerfil    ||';'||
                                  interfazRecord(x).codRol       ||';'||
                                  interfazRecord(x).codCargo     ||';'||
                                  interfazRecord(x).codTipoOpera   ||';'||
                                  interfazRecord(x).codEstado      ||';'||
                                  interfazRecord(x).codMotivLicen  ||';'||
                                  interfazRecord(x).fecIniAsig     ||';'||
                                  interfazRecord(x).fecFinAsig     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                        END IF;
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_OPERA_DIREC : '||ls_sqlerrm);

end INT_PR_DAT_ENVIO_OPERA_DIREC;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Programas LET (DAT-143 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_PROGR
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
   SELECT pr.cod_prog,
          pr.nom_prog,
          pr.cam_inic,
          pr.cam_fin,
          pr.ind_prog_reco,
          pr.num_acti_secc_apta,
          CASE pr.ind_tipo_orig_pedi
             WHEN 'W' THEN '1'
             ELSE  '0'
          END,
          pr.ind_acti_obje_cobr,
          pr.num_camp_eval,
          (SELECT d.ran_inic||'-'||d.ran_fin from lec_progr_desem d
           WHERE d.pais_cod_pais = pr.pais_cod_pais
           AND   d.lpro_cod_prog = pr.cod_prog
           AND   d.ltde_cod_tipo_dese = '03'),
           (SELECT d.ran_inic||'-'||d.ran_fin from lec_progr_desem d
           WHERE d.pais_cod_pais = pr.pais_cod_pais
           AND   d.lpro_cod_prog = pr.cod_prog
           AND   d.ltde_cod_tipo_dese = '05'),
           (SELECT d.ran_inic||'-'||d.ran_fin from lec_progr_desem d
           WHERE d.pais_cod_pais = pr.pais_cod_pais
           AND   d.lpro_cod_prog = pr.cod_prog
           AND   d.ltde_cod_tipo_dese = '04'),
          pr.num_baja_auto,
          pr.ind_exig_curs,
          '1',
          nvl(pr.ind_dese_ingr_capi,0)
     FROM lec_progr pr
    WHERE pr.pais_cod_pais = psCodigoPais
   AND     pr.cam_inic <= psCodigoPeriodo
      AND (pr.cam_fin     >= psCodigoPeriodo or pr.cam_fin is null)
      AND pr.ind_acti      = '1';

	 TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR.COD_PROG%TYPE,
        desPrograma          LEC_PROGR.NOM_PROG%TYPE,
        campanaIni           LEC_PROGR.CAM_INIC%TYPE,
        campanaFin           LEC_PROGR.CAM_FIN%TYPE,
        flagProgRecon        LEC_PROGR.IND_PROG_RECO%TYPE,
        nroActivasSec        LEC_PROGR.NUM_ACTI_SECC_APTA%TYPE,
        flagLetPedWeb        CHAR(1),
        flagObjeCobra        LEC_PROGR.IND_ACTI_OBJE_COBR%TYPE,
        nroCamEtapa          VARCHAR(20),
        nroCamProduc         VARCHAR(20),
        nroCamCritica         VARCHAR(20),
        nroCamEstable         VARCHAR(20),
        nroLiderBaja         LEC_PROGR.NUM_BAJA_AUTO%TYPE,
        flagExigCurso        LEC_PROGR.IND_EXIG_CURS%TYPE,
        FlagEstatusPed       LEC_PROGR.IND_DESE_META_INGR%TYPE,
        FlagEstatusIngr      LEC_PROGR.IND_DESE_META_INGR%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;


     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma     ||';'||
                                  interfazRecord(x).desPrograma     ||';'||
                                  interfazRecord(x).campanaIni      ||';'||
                                  interfazRecord(x).campanaFin      ||';'||
                                  interfazRecord(x).flagProgRecon   ||';'||
                                  interfazRecord(x).nroActivasSec   ||';'||
                                  interfazRecord(x).flagLetPedWeb   ||';'||
                                  interfazRecord(x).flagObjeCobra   ||';'||
                                  interfazRecord(x).nroCamEtapa     ||';'||
                                  interfazRecord(x).nroCamProduc    ||';'||
                                  interfazRecord(x).nroCamCritica   ||';'||
                                  interfazRecord(x).nroCamEstable   ||';'||
                                  interfazRecord(x).flagExigCurso   ||';'||
                                  interfazRecord(x).FlagEstatusPed   ||';'||
                                  interfazRecord(x).FlagEstatusIngr
                                  ;


                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_PROGR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_PROGR;



/***********************************************************************
Descripcion       : Genera Interfaz de Envio Inicio Cursos y Ejecucion de Bonos LET (DAT-144)
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CURSO_BONO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
   CURSOR c_interfaz IS

   SELECT ce.lpro_cod_prog,
          ce.cam_inic,
          CASE ce.ind_tipo_exig
              WHEN 'C' THEN '1'
              WHEN 'N' THEN '2'
              WHEN 'W' THEN '3' -- Nuevo
          END
   FROM   LEC_PROGR_CAMPA_EXIGE ce,
          LEC_PROGR p
   WHERE   p.pais_cod_pais =  ce.pais_cod_pais
   AND     p.cod_prog = ce.lpro_cod_prog
   AND     p.cam_inic <= psCodigoPeriodo
   AND     (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
   AND     ce.ind_acti = 1;


	 TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR_CAMPA_EXIGE.LPRO_COD_PROG%type,
        campanaInicio        LEC_PROGR_CAMPA_EXIGE.CAM_INIC%type,
        tipo                 LEC_PROGR_CAMPA_EXIGE.IND_TIPO_EXIG%type
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;

   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

   BEGIN

    lbAbrirUtlFile:= TRUE;
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;
             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma     ||';'||
                                  interfazRecord(x).campanaInicio   ||';'||
                                  interfazRecord(x).tipo             ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CURSO_BONO: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CURSO_BONO;



/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Tipo Premio (DAT-145 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_PREMIO
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2)
  IS

   CURSOR c_interfaz IS
   SELECT  ti.cod_tipo_incen,
           ti.des_tipo_incen
   FROM    LEC_TIPO_INCEN ti
   WHERE   ti.ind_acti = '1';

	 TYPE interfazRec IS RECORD
      (
        codTipoIncen          LEC_TIPO_INCEN.COD_TIPO_INCEN%type,
        desTipoIncen          LEC_TIPO_INCEN.DES_TIPO_INCEN%type
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codTipoIncen   ||';'||
                                  interfazRecord(x).desTipoIncen    ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_PREMIO: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TIPO_PREMIO;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Niveles LET (DAT-146 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_NIVEL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

    CURSOR c_interfaz IS
    SELECT PN.LPRO_COD_PROG CodPrograma,
           PN.LNIV_COD_NIVE CodNivel,
           N.DES_NIVE DesNivel,
           PN.NUM_MINI_PEDI RangoPedIni,
           PN.NUM_MAXI_PEDI RangoPedFin,
           PN.TOL_PEDI Tolerancia,
           NVL((CASE WHEN p.ltco_cod_tipo_comi = '01' THEN
                    CASE WHEN ( pn.mon_pedi_cons IS NOT NULL AND
                               (
                                SELECT COUNT(*)
                                  FROM lec_progr_canas_premi cpr
                                 WHERE cpr.pais_cod_pais      = p.pais_cod_pais AND
                                       cpr.lpro_cod_prog      = p.cod_prog AND
                                       cpr.ltcn_cod_tipo_cana = '01' AND
                                       cpr.lniv_cod_nive      = pn.lniv_cod_nive AND
                                       cpr.ind_acti           = '1'
                                ) > 0
                               ) THEN '06'
                          WHEN ( pn.mon_pedi_cons IS NULL AND
                               (
                                SELECT COUNT(*)
                                  FROM lec_progr_canas_premi cpr
                                 WHERE cpr.pais_cod_pais      = p.pais_cod_pais AND
                                       cpr.lpro_cod_prog      = p.cod_prog AND
                                       cpr.ltcn_cod_tipo_cana = '01' AND
                                       cpr.lniv_cod_nive      = pn.lniv_cod_nive AND
                                       cpr.ind_acti           = '1'
                                ) > 0
                               ) THEN '01'
                         WHEN ( pn.mon_pedi_cons IS NOT NULL AND
                               (
                                SELECT COUNT(*)
                                  FROM lec_progr_canas_premi cpr
                                 WHERE cpr.pais_cod_pais      = p.pais_cod_pais AND
                                       cpr.lpro_cod_prog      = p.cod_prog AND
                                       cpr.ltcn_cod_tipo_cana = '01' AND
                                       cpr.lniv_cod_nive      = pn.lniv_cod_nive AND
                                       cpr.ind_acti           = '1'
                                ) = 0
                               ) THEN '04'
                               ELSE NULL END
                ELSE NULL END),0) CodTipoPremioPedido,
           PN.MON_PEDI_CONS PagoPedConsecutivo,
           PN.MON_PEDI_NCON PagoPedNoConsecutivo,
           PN.MON_TOLE PagoPedTolerancia,
           NVL((SELECT BN.MON_PREM
              FROM lec_PROGR_BONO_NIVEL BN, lec_TIPO_BONO TB
             WHERE TB.COD_TIPO_BONO = BN.LTBO_COD_TIPO_BONO
               AND TB.COD_TIPO_BONO = '09'
               AND BN.LNIV_COD_NIVE = PN.LNIV_COD_NIVE
               AND BN.Ind_Acti = 1
               AND BN.LPRO_COD_PROG = PN.LPRO_COD_PROG),0) PagoPerGracia,
           P.NUM_CAMP_GRAC NroCampPerGracia,
          (
          SELECT CASE WHEN bn.ltpr_cod_tipo_prem = '01' THEN '04'
                      WHEN bn.ltpr_cod_tipo_prem = '02' THEN '01'
                      ELSE NULL END
            FROM lec_progr_bono_nivel bn
           WHERE bn.pais_cod_pais      = pn.pais_cod_pais AND
                 bn.lpro_cod_prog      = pn.lpro_cod_prog AND
                 bn.ltbo_cod_tipo_bono = '09' AND
                 bn.lniv_cod_nive      = pn.lniv_cod_nive AND
                 bn.ind_acti           = '1'
          ) CodTipoPremioPerGracia,
           (SELECT NVL(BN.MON_PREM, 0)
              FROM lec_PROGR_BONO_NIVEL BN, lec_TIPO_BONO TB
             WHERE TB.COD_TIPO_BONO = BN.LTBO_COD_TIPO_BONO
               AND TB.COD_TIPO_BONO = '08'
               AND BN.LNIV_COD_NIVE = PN.LNIV_COD_NIVE
               AND BN.Ind_Acti = 1
               AND BN.LPRO_COD_PROG = PN.LPRO_COD_PROG) PagoCambioNivelAcelerado,
           PN.NUM_MINI_PEDI IncrementoMinPedidos,

           (SELECT NVL(BN.NUM_CAMP_MAXI_CAMB, 0)
              FROM lec_PROGR_BONO_NIVEL BN, lec_TIPO_BONO TB
             WHERE TB.COD_TIPO_BONO = BN.LTBO_COD_TIPO_BONO
               AND TB.COD_TIPO_BONO = '08'
               AND BN.LNIV_COD_NIVE = PN.LNIV_COD_NIVE
               AND BN.Ind_Acti = 1
               AND BN.LPRO_COD_PROG = PN.LPRO_COD_PROG) TiempoMaxNivel,
           (
            SELECT CASE WHEN bn.ltpr_cod_tipo_prem = '01' THEN '04'
                        WHEN bn.ltpr_cod_tipo_prem = '02' THEN '01'
                        ELSE NULL END
              FROM lec_progr_bono_nivel bn
             WHERE bn.pais_cod_pais      = pn.pais_cod_pais AND
                   bn.lpro_cod_prog      = pn.lpro_cod_prog AND
                   bn.ltbo_cod_tipo_bono = '08' AND
                   bn.lniv_cod_nive      = pn.lniv_cod_nive AND
                   bn.ind_acti           = '1'
          ) CodTipoPremioNivelAcelerado,
          pn.mon_mini_vent_cata VentaMinima,
          --p.num_camp_eval NroEtapasLiderCritica -- Nuevo
          (
           SELECT MAX(pntr.val_porc_comi_tole)
             FROM lec_progr_nivel_tramo pntr
            WHERE pntr.pais_cod_pais = pn.pais_cod_pais
              AND pntr.lpro_cod_prog = pn.lpro_cod_prog
              AND pntr.lniv_cod_nive = pn.lniv_cod_nive
              AND pntr.ind_acti = 1
              AND pntr.cod_tram = 1 -- Este valor es fijo actualmente porque solo se paga comision por tramo 1
          ) PorcPagoVentaRetail ,
          PN.Ind_Tipo_Meta  IndMetaPedido,
          nvl(PN.Val_Mont_Tole_Vent,0) ToleObjeVenta,
          NVL(PN.NUM_META_INGR,0) MetaIngreso,
          nvl(pn.num_meta_capi,0) MetaCapit
      FROM lec_NIVEL N,
           lec_PROGR_NIVEL PN,
           lec_PROGR P
     WHERE PN.LNIV_COD_NIVE = N.COD_NIVE
       AND PN.PAIS_COD_PAIS = P.PAIS_COD_PAIS
       AND PN.LPRO_COD_PROG = P.COD_PROG
       AND PN.PAIS_COD_PAIS = psCodigoPais
       AND PN.Ind_Acti = 1
       AND N.IND_ACTI = 1
       AND P.Ind_Acti = 1
       AND (P.CAM_INIC <= psCodigoPeriodo AND
           (P.CAM_FIN      >= psCodigoPeriodo OR P.CAM_FIN IS NULL))
       AND n.val_peso_nive > 0;


   	 TYPE interfazRec IS RECORD
      (
        codPrograma       LEC_PROGR_NIVEL.LPRO_COD_PROG%TYPE,
        codNivel          LEC_PROGR_NIVEL.LNIV_COD_NIVE%TYPE,
        desNivel          LEC_NIVEL.DES_NIVE%TYPE,
        rangoPedIni       LEC_PROGR_NIVEL.NUM_MINI_PEDI%TYPE,
        rangoPedFin       LEC_PROGR_NIVEL.NUM_MAXI_PEDI%TYPE,
        tolerancia        LEC_PROGR_NIVEL.TOL_PEDI%TYPE,
        codTipoPremioPed  LEC_TIPO_PREMI.COD_TIPO_PREM%TYPE,
        pagoPedCons       LEC_PROGR_NIVEL.Mon_Pedi_Cons%TYPE,
        pagoPedNoCons     LEC_PROGR_NIVEL.MON_PEDI_NCON%TYPE,
        pagoPedTole       LEC_PROGR_NIVEL.Mon_Tole%TYPE,
        pagoPerGracia     lec_progr_bono_nivel.mon_prem%type,
        nroCampGracia     LEC_PROGR.NUM_CAMP_GRAC%TYPE ,
        codTipoGracia     LEC_TIPO_PREMI.COD_TIPO_PREM%TYPE,
        pagoCambAcel      LEC_PROGR_BONO_NIVEL.MON_PREM%TYPE,
        incMinPedid       LEC_PROGR_NIVEL.NUM_MINI_PEDI%TYPE,
        tiemMaxNivel      LEC_PROGR_BONO_NIVEL.NUM_CAMP_MAXI_CAMB%TYPE,
        codTipoAcel      LEC_TIPO_PREMI.COD_TIPO_PREM%TYPE,
        VentaMinima      LEC_PROGR_NIVEL.MON_MINI_VENT_CATA%TYPE,
        PorcPagoVentaRetail LEC_PROGR_NIVEL_TRAMO.VAL_PORC_COMI_TOLE%TYPE,
        IndMetaPedido    LEC_PROGR_NIVEL.Ind_Tipo_Meta%TYPE,
        ToleObjeVenta    LEC_PROGR_NIVEL.Val_Mont_Tole_Vent%TYPE,
        MetaIngreso      LEC_PROGR_NIVEL.NUM_META_INGR%TYPE,
        MetaCapit        LEC_PROGR_NIVEL.Num_Meta_Capi%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

       /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
     OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codNivel           ||';'||
                                  interfazRecord(x).desNivel           ||';'||
                                  interfazRecord(x).rangoPedIni        ||';'||
                                  interfazRecord(x).rangoPedFin        ||';'||
                                  interfazRecord(x).tolerancia         ||';'||
                                  interfazRecord(x).codTipoPremioPed   ||';'||
                                  interfazRecord(x).pagoPedCons        ||';'||
                                  interfazRecord(x).pagoPedNoCons      ||';'||
                                  interfazRecord(x).pagoPedTole        ||';'||
                                  interfazRecord(x).pagoPerGracia      ||';'||
                                  interfazRecord(x).nroCampGracia      ||';'||
                                  interfazRecord(x).codTipoGracia      ||';'||
                                  interfazRecord(x).pagoCambAcel       ||';'||
                                  interfazRecord(x).incMinPedid        ||';'||
                                  interfazRecord(x).tiemMaxNivel       ||';'||
                                  interfazRecord(x).codTipoAcel        ||';'||
                                  interfazRecord(x).VentaMinima        ||';'||
                                  interfazRecord(x).PorcPagoVentaRetail ||';'||
                                  interfazRecord(x).IndMetaPedido       ||';'||
                                  interfazRecord(x).ToleObjeVenta       ||';'||
                                  interfazRecord(x).MetaIngreso         ||';'||
                                  interfazRecord(x).MetaCapit
                                  ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_NIVEL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_NIVEL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lanzamiento Estrategico (DAT-147 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LANZA_ESTRA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
     CURSOR c_interfaz IS
     SELECT bl.lpro_cod_prog codPrograma,
            bl.num_lanz codLanEst,
            to_char(bl.num_lanz, '999999') desLanEst, --desLanzamiento
            bl.lpbc_cam_lanz camLanza,
            (SELECT tm.des_tipo_medi from lec_tipo_medic tm
             WHERE tm.cod_tipo_medi = bl.ltme_cod_tipo_medi) medProd
      FROM  LEC_PROGR_BONO_LANZA bl,
            LEC_PROGR p
      WHERE p.PAIS_COD_PAIS = bl.pais_cod_pais
      AND   p.cod_prog = bl.lpro_cod_prog
      AND   p.pais_cod_pais = psCodigoPais
      AND   p.cam_inic <= psCodigoPeriodo
      AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
      AND   bl.ind_acti = 1
      AND   p.ind_acti = 1;

	 TYPE interfazRec IS RECORD
      (codPrograma      LEC_PROGR.COD_PROG%TYPE,
       codLanEst        LEC_PROGR_BONO_LANZA.NUM_LANZ%TYPE,
       desLanEst        VARCHAR2(100),
       camLanza         LEC_PROGR.CAM_INIC%TYPE,
       medProd          LEC_TIPO_MEDIC.DES_TIPO_MEDI%TYPE,
       codTipoLanz      LEC_TIPO_PREMI.DES_TIPO_PREMI%TYPE
       );

   TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

      OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codLanEst          ||';'||
                                  interfazRecord(x).desLanEst          ||';'||
                                  interfazRecord(x).camLanza           ||';'||
                                  interfazRecord(x).medProd	          ;-- ||';'||
                                  --interfazRecord(x).codTipoLanz        ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LANZA_ESTRA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_LANZA_ESTRA;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Lanzamiento Estrategico (DAT-148 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DETAL_LANZA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

    CURSOR c_interfaz IS
    SELECT bp.lpro_cod_prog,
           bp.lpbl_num_lanz,
           bp.lpbc_cam_lanz,
           bp.cod_sap
    FROM lec_progr_bono_lanza_produ bp,
         LEC_PROGR_BONO_LANZA bl,
         LEC_PROGR p
    WHERE p.pais_cod_pais = bl.pais_cod_pais
    AND   p.cod_prog = bl.lpro_cod_prog
    AND   bp.pais_cod_pais = bl.pais_cod_pais
    AND   bp.lpro_cod_prog = bl.lpro_cod_prog
    AND   bp.lpbl_num_lanz = bl.num_lanz
     AND   bp.lpbc_cam_lanz = bl.lpbc_cam_lanz
    AND   p.cam_inic <= psCodigoPeriodo
    AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
    AND   bp.ind_acti = 1
    AND   bl.ind_acti = 1
    AND   p.ind_acti = 1;

    TYPE interfazRec IS RECORD
    (codPrograma      LEC_PROGR.COD_PROG%TYPE,
     codLanEst        LEC_PROGR_BONO_LANZA.NUM_LANZ%TYPE,
     camLanza         LEC_PROGR.CAM_INIC%TYPE,
     codSap           LEC_PROGR_BONO_LANZA_PRODU.COD_SAP%TYPE
     );

     TYPE interfazRecTab  IS TABLE OF interfazRec;
     interfazRecord interfazRecTab;


     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

      OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codLanEst          ||';'||
                                  interfazRecord(x).camLanza           ||';'||
                                  interfazRecord(x).codSap	        ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_DETAL_LANZA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_DETAL_LANZA;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Lanzamiento Estrategico (DAT-149 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LANZA_NIVEL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

  CURSOR c_interfaz IS
      SELECT bi.lpro_cod_prog codPrograma,
             bi.lpbl_num_lanz codLanEst,
             bi.lpbc_cam_lanz camLanza,
             bi.lniv_cod_nive codNivel,
           (SELECT bn.val_porc_obje
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('01','03') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) exigencia,
          (SELECT bn.val_porc_obje
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('02','04') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) sobExigencia,
          (SELECT CASE
                  WHEN bn.ltpr_cod_tipo_prem = '01' THEN '04'
                  WHEN bn.ltpr_cod_tipo_prem = '02' THEN '01'
                   ELSE NULL END
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('01','03') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) tipoPremExig --tipo de pago exigencia
            ,
          (SELECT bn.mon_prem
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('01','03') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) pagExigencia,
          (SELECT CASE
                  WHEN bn.ltpr_cod_tipo_prem = '01' THEN '04'
                  WHEN bn.ltpr_cod_tipo_prem = '02' THEN '01'
                   ELSE NULL END
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('02','04') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) tipoPremSobrExig--tipo de pago sobreexigencia
            ,
          (SELECT bn.mon_prem
             FROM LEC_PROGR_BONO_NIVEL bn
            WHERE bn.ltbo_cod_tipo_bono IN ('02','04') AND
                  bn.lniv_cod_nive = bi.lniv_cod_nive AND
                  bn.lpbc_cam_lanz = bi.lpbc_cam_lanz AND
                  bn.lpbl_num_lanz = bi.lpbl_num_lanz AND
                  bn.ind_acti = 1
            ) pagSobExigencia
    FROM
        (  select t.pais_cod_pais,
                  t.lpro_cod_prog,
                  t.lpbl_num_lanz,
                  t.lpbc_cam_lanz,
                  t.lniv_cod_nive
             FROM LEC_PROGR_BONO_NIVEL t
            WHERE t.ltbo_cod_tipo_bono IN ('01','02','03','04')
            AND   t.ind_acti = 1
         GROUP BY t.pais_cod_pais,
                  t.lpro_cod_prog,
                  t.lpbl_num_lanz,
                  t.lpbc_cam_lanz,
                  t.lniv_cod_nive
        ) bi,
         LEC_PROGR p
 WHERE p.pais_cod_pais = bi.pais_cod_pais
   AND p.cod_prog      = bi.lpro_cod_prog
    AND   p.cam_inic <= psCodigoPeriodo
    AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
    AND  p.ind_acti = 1;


    TYPE interfazRec IS RECORD
    (codPrograma      LEC_PROGR.COD_PROG%TYPE,
     codLanEst        LEC_PROGR_BONO_NIVEL.LPBL_NUM_LANZ%TYPE,
     camLanza         LEC_PROGR_BONO_NIVEL.LPBC_CAM_LANZ%TYPE,
     codNivel         LEC_PROGR_BONO_NIVEL.LNIV_COD_NIVE%TYPE,
     exigencia        LEC_PROGR_BONO_NIVEL.VAL_PORC_OBJE%TYPE,
     sobExigencia     LEC_PROGR_BONO_NIVEL.VAL_PORC_SOBR_OBJE%TYPE,
     tipoPremExig     LEC_PROGR_BONO_NIVEL.LTPR_COD_TIPO_PREM%TYPE,
     pagExigencia     LEC_PROGR_BONO_NIVEL.MON_PREM%TYPE,
     tipoPremSobrExig LEC_PROGR_BONO_NIVEL.LTPR_COD_TIPO_PREM%TYPE,
     pagSobExigencia  LEC_PROGR_BONO_NIVEL.MON_PREM%TYPE
     );

     TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
     interfazRecord interfazRecTab;


     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codLanEst          ||';'||
                                  interfazRecord(x).camLanza           ||';'||
                                  interfazRecord(x).codNivel 	         ||';'||
                                  interfazRecord(x).exigencia 	       ||';'||
                                  interfazRecord(x).sobExigencia 	     ||';'||
                                  interfazRecord(x).TipoPremExig	     ||';'||
                                  interfazRecord(x).pagExigencia 	     ||';'||
                                  interfazRecord(x).TipoPremSobrExig 	 ||';'||
                                  interfazRecord(x).pagSobExigencia        ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_LANZA_NIVEL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_LANZA_NIVEL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Lanzamiento LET (DAT-150 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_LANZA
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
       CURSOR c_interfaz IS
       SELECT psCodigoPeriodo,
              lb.lpro_cod_prog,
              lb.lpbl_num_lanz,
              lb.lpbc_cam_lanz,
              n.lniv_cod_nive,
              lb.cod_lide,
              lb.cod_zona||lb.cod_secc,
              (
              SELECT l.val_obje_bono
                FROM lec_progr_bono_lanza bl,
                     lec_progr_bono_nivel bn,
                     lec_lider_secci_objet_bono l
               WHERE bl.pais_cod_pais      = bn.pais_cod_pais
                 AND bl.lpro_cod_prog      = bn.lpro_cod_prog
                 AND bn.ltbo_cod_tipo_bono IN ('01','03')
                 AND bl.lpbc_cam_lanz      = bn.lpbc_cam_lanz
                 AND bl.num_lanz           = bn.lpbl_num_lanz
                 AND bn.pais_cod_pais      = l.pais_cod_pais
                 AND bn.lpro_cod_prog      = l.lpro_cod_prog
                 AND bn.ltbo_cod_tipo_bono = l.ltbo_cod_tipo_bono
                 AND bn.lniv_cod_nive      = l.lniv_cod_nive
                 AND bn.sec_bono_nive      = l.lpbn_sec_bono_nive
                 AND l.pais_cod_pais       = lb.pais_cod_pais
                 AND l.lpro_cod_prog       = lb.lpro_cod_prog
                 AND l.cod_regi            = lb.cod_regi
                 AND l.cod_zona            = lb.cod_zona
                 AND l.cod_secc            = lb.cod_secc
                 AND l.lniv_cod_nive       = n.lniv_cod_nive
                 AND l.ltbo_cod_tipo_bono  IN ('01','03')
                 AND bn.lpbl_num_lanz      = lb.lpbl_num_lanz
                 AND l.cam_obje            = psCodigoPeriodo
               ) ,
              (
              SELECT l.val_obje_bono
                FROM lec_progr_bono_lanza bl,
                     lec_progr_bono_nivel bn,
                     lec_lider_secci_objet_bono l
               WHERE bl.pais_cod_pais      = bn.pais_cod_pais
                 AND bl.lpro_cod_prog      = bn.lpro_cod_prog
                 AND bn.ltbo_cod_tipo_bono IN ('02','04')
                 AND bl.lpbc_cam_lanz      = bn.lpbc_cam_lanz
                 AND bl.num_lanz           = bn.lpbl_num_lanz
                 AND bn.pais_cod_pais      = l.pais_cod_pais
                 AND bn.lpro_cod_prog      = l.lpro_cod_prog
                 AND bn.ltbo_cod_tipo_bono = l.ltbo_cod_tipo_bono
                 AND bn.lniv_cod_nive      = l.lniv_cod_nive
                 AND bn.sec_bono_nive      = l.lpbn_sec_bono_nive
                 AND l.pais_cod_pais       = lb.pais_cod_pais
                 AND l.lpro_cod_prog       = lb.lpro_cod_prog
                 AND l.cod_regi            = lb.cod_regi
                 AND l.cod_zona            = lb.cod_zona
                 AND l.cod_secc            = lb.cod_secc
                 AND l.lniv_cod_nive       = n.lniv_cod_nive
                 AND l.ltbo_cod_tipo_bono  IN ('02','04')
                 AND bn.lpbl_num_lanz      = lb.lpbl_num_lanz
                 AND l.cam_obje            = psCodigoPeriodo
               ),
              lb.num_pedi_secc_lanz,
              lb.num_unid_lanz_real,
              CASE WHEN lb.leob_cod_esta_obje = '06' THEN 0
                   WHEN lb.leob_cod_esta_obje = '04' THEN 1
                   WHEN lb.leob_cod_esta_obje = '05' THEN 2
                   ELSE NULL
              END,
              nvl(ga.mon_gana,0),
              CASE
              (SELECT COUNT(1)
                 FROM lec_lider_canas v
                WHERE v.cod_regi = lb.cod_regi
                  AND v.cod_zona = lb.cod_zona
                  AND v.cod_secc = lb.cod_secc
                  AND v.cod_lide = lb.cod_lide
                  AND v.cam_cana = GEN_PKG_GENER.gen_fn_perio_nsigu(psCodigoPais,lb.cam_resu,1)
                  AND v.lpbc_cam_lanz = lb.LPBC_CAM_LANZ
                  AND v.lpbl_num_lanz = lb.LPBL_NUM_LANZ
                  AND v.ltcn_cod_tipo_cana in ('02','03','04','05')
               )
              WHEN 0 THEN '0'
              ELSE '1'
              END,
              (
               SELECT v.ltcn_cod_tipo_cana
                 FROM lec_lider_canas v
                WHERE v.cod_regi = lb.cod_regi
                  AND v.cod_zona = lb.cod_zona
                  AND v.cod_secc = lb.cod_secc
                  AND v.cod_lide = lb.cod_lide
                  AND v.cam_cana = GEN_PKG_GENER.gen_fn_perio_nsigu(psCodigoPais,lb.cam_resu,1)
                  AND v.lpbc_cam_lanz = lb.LPBC_CAM_LANZ
                  AND v.lpbl_num_lanz = lb.LPBL_NUM_LANZ
                  AND v.ltcn_cod_tipo_cana in ('02','03','04','05')
               )
       FROM  lec_lider_secci_resul_bono lb,
             lec_lider_nivel n,
             lec_lider_ganan ga
       WHERE lb.cam_resu            = psCodigoPeriodo
         AND lb.pais_cod_pais       = ga.pais_cod_pais (+)
         AND lb.lpro_cod_prog       = ga.lpro_cod_prog (+)
         AND lb.cod_regi            = ga.cod_regi      (+)
         AND lb.cod_zona            = ga.cod_zona      (+)
         AND lb.cod_secc            = ga.cod_secc      (+)
         AND lb.cam_resu            = ga.cam_gana      (+)
         AND lb.cod_lide            = ga.cod_lide      (+)
         AND ga.ltga_cod_tipo_gana(+)  IN ('05','06','07','08')
         AND lb.ltbo_cod_tipo_bono  in ('01','02','03','04')
         AND n.pais_cod_pais        = lb.pais_cod_pais
         AND n.lpro_cod_prog        = lb.lpro_cod_prog
         AND n.cod_lide             = lb.cod_lide
         AND n.ind_tipo_nive        = 'R'
         AND n.cam_inic            <= psCodigoPeriodo
         AND LB.LPBL_NUM_LANZ       =  GA.LPBL_NUM_LANZ(+)
         AND (n.cam_fin >= psCodigoPeriodo OR n.cam_fin IS NULL);




   TYPE interfazRec IS RECORD
      (
        anioCampana          CHAR(6),
        codPrograma          lec_lider_secci_resul.lpro_cod_prog%TYPE,
        codLanzEst           lec_lider_secci_resul_bono.lpbl_num_lanz%TYPE,
        campLanz             lec_lider_secci_resul_bono.lpbc_cam_lanz%TYPE,
        codNivel             lec_lider_nivel.lniv_cod_nive%TYPE,
        codLider             lec_lider_secci_resul.cod_lide%TYPE,
        codSeccion           VARCHAR2(5),
        objExiLanz           lec_lider_secci_objet_bono.val_obje_bono%TYPE,
        objSobExiLanz        lec_lider_secci_objet_bono.val_sobr_obje_bono%TYPE,
        nroPedLanz           lec_lider_secci_resul_bono.num_pedi_secc_lanz%TYPE,
        nroUnidLanz          lec_lider_secci_resul_bono.num_unid_lanz_real%TYPE,
        tipoGananLanz        lec_lider_ganan.ltga_cod_tipo_gana%TYPE,
        gananLanz            lec_lider_ganan.mon_gana%TYPE,
        canasLanz            CHAR(1),
        codCanasLanz         LEC_TIPO_CANAS.COD_TIPO_CANA%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;



     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).anioCampana    ||';'||
                                  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codLanzEst     ||';'||
                                  interfazRecord(x).campLanz       ||';'||
                                  interfazRecord(x).codNivel       ||';'||
                                  interfazRecord(x).codLider       ||';'||
                                  interfazRecord(x).codSeccion     ||';'||
                                  interfazRecord(x).objExiLanz     ||';'||
                                  interfazRecord(x).objSobExiLanz  ||';'||
                                  interfazRecord(x).nroPedLanz     ||';'||
                                  interfazRecord(x).nroUnidLanz    ||';'||
                                  interfazRecord(x).tipoGananLanz  ||';'||
                                  interfazRecord(x).gananLanz      ||';'||
                                  interfazRecord(x).canasLanz      ||';'||
                                  interfazRecord(x).codCanasLanz   ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RESUL_LANZA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_RESUL_LANZA;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Tipo Canastas (DAT-151 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_CANAS
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)
  IS

CURSOR c_interfaz IS
  SELECT P.COD_PROG,
         TC.COD_TIPO_CANA,
         tc.des_tipo_cana
    FROM LEC_PROGR  p,
         LEC_TIPO_CANAS tc
   WHERE p.cam_inic <= psCodigoPeriodo
     AND (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
     AND P.IND_ACTI = 1;

	 TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR_CANAS.LPRO_COD_PROG%TYPE,
        codCanasta           LEC_TIPO_CANAS.COD_TIPO_CANA%TYPE,
        desCanasta           LEC_TIPO_CANAS.DES_TIPO_CANA%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codCanasta     ||';'||
                                  interfazRecord(x).desCanasta     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_CANAS: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TIPO_CANAS;



/***********************************************************************
Descripcion       : Genera Interfaz de Envio Canasta por Niveles LET (DAT-152 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAS_NIVEL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
   SELECT  cn.lpro_cod_prog,
           cp.ltcn_cod_tipo_cana,
          pm.cod_peri,
          CN.CAM_ACTI,
          cp.lniv_cod_nive, --  antes LPNI_COD_NIVE_PEDI,
           cn.val_cana,
           cn.nom_cana,
           cn.num_prod -- crear
   FROM    LEC_PROGR_CANAS cn,
           LEC_PROGR_CANAS_PREMI cp,
          LEC_PROGR p,
          cra_perio cm,
          seg_perio_corpo pm
   WHERE   cn.pais_cod_pais = cp.pais_cod_pais
   AND     cn.lpro_cod_prog = cp.lpro_cod_prog
      AND cn.sec_cana      = cp.lpcn_sec_cana
   AND     cp.pais_cod_pais =  psCodigoPais
   AND     p.pais_cod_pais = cn.pais_cod_pais
   AND     p.cod_prog = cn.lpro_cod_prog
   AND     p.cam_inic <= psCodigoPeriodo
      AND (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
      AND cm.fec_inic <= NVL(cn.fec_modi,SYSDATE)
      AND cm.fec_fina >= nvl(cn.fec_modi,SYSDATE)
      AND cm.peri_oid_peri = pm.oid_peri
      and  CN.IND_ACTI = 1
      and  cp.ind_acti = 1 ;

   TYPE interfazRec IS RECORD
      (
        codPrograma         LEC_PROGR_CANAS.LPRO_COD_PROG%TYPE,
        codCanasta          LEC_PROGR_CANAS_PREMI.ltcn_cod_tipo_cana%TYPE,
        campUltMod          CHAR(6),
        campIns             CHAR(6),
        codNivel            LEC_PROGR_CANAS_PREMI.LNIV_COD_NIVE%TYPE,
        valorCanas          LEC_PROGR_CANAS.VAL_CANA%TYPE,
        nomCanas            LEC_PROGR_CANAS.NOM_CANA%TYPE,
        nroProd             LEC_PROGR_CANAS.NUM_PROD%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

   BEGIN

    lbAbrirUtlFile:= TRUE;

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codCanasta     ||';'||
                                  interfazRecord(x).campUltMod     ||';'||
                                  interfazRecord(x).campIns         ||';'||
                                  interfazRecord(x).codNivel       ||';'||
                                  interfazRecord(x).valorCanas     ||';'||
                                  interfazRecord(x).nomCanas       ||';'||
                                  interfazRecord(x).nroProd       ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CANAS_NIVEL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CANAS_NIVEL;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Canasta por Niveles LET (DAT-153 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CANAS_DETAL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
   SELECT  cn.lpro_cod_prog,
           cp.ltcn_cod_tipo_cana,
          pm.cod_peri,
          cp.lniv_cod_nive,
           cd.cod_sap
   FROM    LEC_PROGR_CANAS cn,
           LEC_PROGR_CANAS_DETAL cd,
           LEC_PROGR_CANAS_PREMI cp,
          LEC_PROGR p,
          cra_perio cm,
          seg_perio_corpo pm
   WHERE   cn.pais_cod_pais = cp.pais_cod_pais
   AND     cn.lpro_cod_prog = cp.lpro_cod_prog
      AND CN.SEC_CANA         = CP.LPCN_SEC_CANA
   AND     cp.pais_cod_pais =  psCodigoPais
   AND     p.pais_cod_pais = cn.pais_cod_pais
   AND     p.cod_prog = cn.lpro_cod_prog
   AND     cd.pais_cod_pais = cn.pais_cod_pais
   AND     cd.lpro_cod_prog = cn.lpro_cod_prog
   AND CD.LPCN_SEC_CANA    = CN.SEC_CANA
   AND     cp.ind_acti = 1
   AND     cd.ind_acti = 1
   AND     p.cam_inic <= psCodigoPeriodo
      AND (p.cam_fin         >= psCodigoPeriodo or p.cam_fin is null)
      AND cm.fec_inic        <= cn.fec_modi
      AND cm.fec_fina        >= nvl(cn.fec_modi,SYSDATE)
      AND cm.peri_oid_peri    = pm.oid_peri;


   TYPE interfazRec IS RECORD
      (
        codPrograma         LEC_PROGR_CANAS.LPRO_COD_PROG%TYPE,
        codCanasta          LEC_PROGR_CANAS_PREMI.LTCN_COD_TIPO_CANA%TYPE,
        campUltMod          CHAR(6),
        codNivel            LEC_PROGR_CANAS_PREMI.LNIV_COD_NIVE%TYPE,
        codProdSap          LEC_PROGR_CANAS_DETAL.COD_SAP%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

   BEGIN

    lbAbrirUtlFile:= TRUE;

    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codCanasta     ||';'||
                                  interfazRecord(x).campUltMod     ||';'||
                                  interfazRecord(x).codNivel       ||';'||
                                  interfazRecord(x).codProdSap       ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CANAS_DETAL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CANAS_DETAL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Detalle Canasta por Niveles LET (DAT-154 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TRAMO

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
 SELECT DISTINCT T.LPRO_COD_PROG,
        T.LPCT_COD_TRAM,
         CASE WHEN t.ltmc_cod_tipo_medi_cobr = '01' OR
              t.ltmc_cod_tipo_medi_cobr = '03'
            THEN TM.DES_TIPO_MEDI_COBR ELSE to_char(nvl(T.NUM_DIAS,0)) END,
        nvl(o.num_dias_extr,0),
        '04',
            '1'
   FROM LEC_PROGR P,
        lec_progr_cobra_objet o,
        LEC_PROGR_COBRA_OBJET_TRAMO T,
        LEC_TIPO_MEDIC_COBRA TM

  WHERE p.pais_cod_pais       = o.pais_cod_pais
    AND p.cod_prog            = o.lpro_cod_prog
    AND o.PAIS_COD_PAIS       = T.PAIS_COD_PAIS
    AND o.lpro_cod_prog       = T.LPRO_COD_PROG
    AND o.lpag_sec_ambi_geog  = t.lpag_sec_ambi_geog
    AND o.ltug_cod_tipo_uso_geog = t.ltug_cod_tipo_uso_geog
    AND o.ltmc_cod_tipo_medi_cobr = t.ltmc_cod_tipo_medi_cobr
    AND TM.COD_TIPO_MEDI_COBR = T.LTMC_COD_TIPO_MEDI_COBR
    AND P.PAIS_COD_PAIS       = PSCODIGOPAIS
    AND P.CAM_INIC           <= PSCODIGOPERIODO
    AND (P.CAM_FIN           >= PSCODIGOPERIODO OR P.CAM_FIN IS NULL)
    AND  p.ind_acti = 1
    AND O.IND_ACTI = 1
    AND T.IND_ACTI = 1;

   TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR_COBRA_OBJET_TRAMO.LPRO_COD_PROG%TYPE,
        codTramo             LEC_PROGR_COBRA_OBJET_TRAMO.LPCT_COD_TRAM%TYPE,
        tipMedTramo          LEC_TIPO_MEDIC_COBRA.DES_TIPO_MEDI_COBR%TYPE,
        numDias              LEC_PROGR_COBRA_OBJET_TRAMO.NUM_DIAS%TYPE,
        codTipoPedCob        LEC_PROGR_COBRA_OBJET_TRAMO.LTPR_COD_TIPO_PREM%TYPE,
        flagActivo           LEC_PROGR_COBRA_OBJET_TRAMO.IND_ACTI%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codTramo       ||';'||
                                  interfazRecord(x).tipMedTramo    ||';'||
                                  interfazRecord(x).numDias        ||';'||
                                  interfazRecord(x).codTipoPedCob  ||';'||
                                  interfazRecord(x).flagActivo     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_TRAMO: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_TRAMO;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Cobranza por Tramo LET (DAT-155 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo

************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_COBRA_TRAMO

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
   CURSOR c_interfaz IS
   SELECT   t.lpro_cod_prog,
            t.lpct_cod_tram,
            CASE ag.ind_pais
           WHEN '1' THEN '1'
                 ELSE '0'
            END,
            ag.cod_regi,
            ag.cod_zona,
            t.val_porc_mini_cobr,
            t.val_porc_cobr
    FROM LEC_PROGR p,
         LEC_PROGR_AMBIT_GEOGR ag,
            LEC_PROGR_COBRA_OBJET co,
         LEC_PROGR_COBRA_OBJET_TRAMO t
   WHERE p.pais_cod_pais           = ag.pais_cod_pais
     AND p.cod_prog                = ag.lpro_cod_prog
     AND ag.ltug_cod_tipo_uso_geog = '01'
     AND ag.pais_cod_pais          = co.pais_cod_pais
     AND ag.lpro_cod_prog          = co.lpro_cod_prog
     AND ag.ltug_cod_tipo_uso_geog = co.ltug_cod_tipo_uso_geog
     AND ag.sec_ambi_geog          = co.lpag_sec_ambi_geog
     AND co.pais_cod_pais          = t.pais_cod_pais
     AND co.lpro_cod_prog          = t.lpro_cod_prog
     AND co.ltug_cod_tipo_uso_geog = t.ltug_cod_tipo_uso_geog
     AND co.lpag_sec_ambi_geog     = t.lpag_sec_ambi_geog
     AND p.pais_cod_pais           = psCodigoPais
     AND AG.IND_ACTI = 1
     AND CO.IND_ACTI = 1
     AND t.ind_acti = 1
   AND      p.cam_inic   <= psCodigoPeriodo
     AND (p.cam_fin               >= psCodigoPeriodo or p.cam_fin is null);

   TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR_COBRA_OBJET_TRAMO.lpro_cod_prog%TYPE,
        codTramo             LEC_PROGR_COBRA_OBJET_TRAMO.LPCT_COD_TRAM%TYPE,
        flagPais             LEC_PROGR_AMBIT_GEOGR.IND_PAIS%TYPE,
        codRegi              LEC_PROGR_AMBIT_GEOGR.COD_REGI%TYPE ,
        codZona              LEC_PROGR_AMBIT_GEOGR.COD_ZONA%TYPE,
        porcMinCobr          LEC_PROGR_COBRA_OBJET_TRAMO.VAL_PORC_MINI_COBR%TYPE,
        porcCobr             LEC_PROGR_COBRA_OBJET_TRAMO.VAL_PORC_COBR%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=
                                  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codTramo          ||';'||
                                  interfazRecord(x).flagPais          ||';'||
                                  interfazRecord(x).codRegi           ||';'||
                                  interfazRecord(x).codZona           ||';'||
                                  interfazRecord(x).porcMinCobr       ||';'||
                                  interfazRecord(x).porcCobr           ;


                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_COBRA_TRAMO: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_COBRA_TRAMO;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Cobranza por Tramo LET (DAT-156 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Modificado        : Carlos Mori (30/04/2015)
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_COBRA
(
  psCodigoPais     VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
  psCampanaProceso VARCHAR2
)

IS

CURSOR c_interfaz( vsCodigoPrograma VARCHAR2, vsCampanaRecaudo VARCHAR2 ) IS

SELECT psCampanaProceso AnioCampana,
       lsrr.lpro_cod_prog CodPrograma,
       lrrt.lpct_cod_tram CodTramo,
       lsrr.cod_lide CodLider,
       lsrr.cod_zona || lsrr.cod_secc CodSeccion,
       llni.lniv_cod_nive CodNivel,
       --( NVL(lsrr.val_mont_carg,0) - ( NVL(lsrr.val_mont_cdrs,0) + NVL(lsrr.val_mont_abon_pdte,0) ) ) MontoMNVenta,
       ( pedi.MontoMNVentaConsecutivo + pedi.MontoMNVentaNoConsecutivo ) MontoMNVenta,
       CASE WHEN lrrt.lpct_cod_tram = 1 THEN
                 NVL(lrrt.val_mont_recu,0)
            ELSE
                 (
                   SELECT SUM( NVL(x.val_mont_recu,0) )
                     FROM lec_lider_secci_recup_tramo x
                    WHERE x.pais_cod_pais = lrrt.pais_cod_pais
                      AND x.lpro_cod_prog = lrrt.lpro_cod_prog
                      AND x.cod_regi = lrrt.cod_regi
                      AND x.cod_zona = lrrt.cod_zona
                      AND x.cod_secc = lrrt.cod_secc
                      AND x.cod_lide = lrrt.cod_lide
                      AND x.cam_recu = lrrt.cam_recu
                    GROUP BY x.pais_cod_pais,
                             x.lpro_cod_prog,
                             x.cod_regi,
                             x.cod_zona,
                             x.cod_secc,
                             x.cod_lide,
                             x.cam_recu
                 )
       END MontoMNRecaudoTramo,
       PEDI.MontoMNRecaudoConsecutivo,
       PEDI.MontoMNRecaudoNoConsecutivo,
       lsrr.cam_recu CampanaRecaudo,
       PEDI.PorRecaudoTramo,
       CASE
         WHEN lrrt.leob_cod_esta_obje = '01' AND NVL(gana.mon_gana_pedi,0) > 0 THEN '2'
         WHEN lrrt.leob_cod_esta_obje = '02' AND NVL(gana.mon_gana_pedi,0) > 0 THEN '1'
         ELSE '0'
       END TipoGananciaPedidoCobranza,
       NVL(gana.mon_gana_pedi,0) GananciaPedidosTramo,
       NVL(gana.mon_gana_pedi_cons,0) GanPedConsecutivoTramo,
       NVL(gana.mon_gana_pedi_ncon,0) GanPedNoCansecutivoTramo,
       0 CanastaPedidosTramo,
       NULL CodCanasta,
       ( nvl(LSRR.VAL_MONT_CARG_TOTA,0) -( nvl(LSRR.VAL_MONT_CDRS_TOTA,0) + nvl(lsrr.val_mont_abon_pdte_tota,0  )) ) MontoMnVentaTotal,
       nvl(LRRT.VAL_MONT_RECU_TOTA,0) MontoMNRecaudoTotal,
       PEDI.GanPedConsecutivoTramo_AV,
       PEDI.GanPedConsecutivoTramo_BV,
       PEDI.MontoMNVentaConsecutivo,
       PEDI.MontoMNVentaNoConsecutivo,
       PEDI.MontoMNVentaConsecutivo_AV,
       PEDI.MontoMNVentaConsecutivo_BV,
       PEDI.MontoMNRecaudoConsecutivo_AV,
       PEDI.MontoMNRecaudoConsecutivo_BV

  FROM lec_lider_secci_resul_recup lsrr,
       lec_lider_secci_recup_tramo lrrt,
       lec_lider_nivel llni,
       (
         SELECT llga.pais_cod_pais,
                llga.lpro_cod_prog,
                llga.cod_lide,
                llga.cam_refe,
                llga.cam_gana,
                NVL(llga.lcpt_cod_tram,0) lcpt_cod_tram,
                SUM( CASE WHEN llga.ltga_cod_tipo_gana IN ('16') THEN NVL(llga.mon_gana,0) ELSE 0 END ) mon_gana_pedi,
                SUM( CASE WHEN llga.ltga_cod_tipo_gana = '14' THEN NVL(llga.mon_gana,0) ELSE 0 END ) mon_gana_pedi_cons,
                SUM( CASE WHEN llga.ltga_cod_tipo_gana = '15' THEN NVL(llga.mon_gana,0) ELSE 0 END ) mon_gana_pedi_ncon
           FROM lec_lider_ganan llga,
                ssicc_comun.lec_tipo_ganan ltga
          WHERE llga.ltga_cod_tipo_gana = ltga.cod_tipo_gana
            AND llga.pais_cod_pais = psCodigoPais
            AND llga.cam_gana = vsCampanaRecaudo
         GROUP BY llga.pais_cod_pais,
                  llga.lpro_cod_prog,
                  llga.cod_lide,
                  llga.cam_refe,
                  llga.cam_gana,
                  llga.lcpt_cod_tram
       ) gana,
       ( SELECT 
               x.cod_regi,
               x.cod_zona,
               x.cod_secc,
               SUM(x.VAL_MONT_COBR_NETO_CONS) MontoMNRecaudoConsecutivo,
               SUM(x.VAL_MONT_COBR_NETO_NCON) MontoMNRecaudoNoConsecutivo,
               MAX(x.VAL_PORC_META_RECUP) PorRecaudoTramo,
               SUM(CASE WHEN y.cod_nive_rang = 'A' THEN x.VAL_IMPO_COMI_BASE_CONS ELSE 0 END) GanPedConsecutivoTramo_AV,
               SUM(CASE WHEN y.cod_nive_rang = 'B' THEN x.VAL_IMPO_COMI_BASE_CONS ELSE 0 END) GanPedConsecutivoTramo_BV,
               SUM(x.VAL_MONT_VENT_FACT_CONS) MontoMNVentaConsecutivo,
               SUM(x.VAL_MONT_VENT_FACT_NCON) MontoMNVentaNoConsecutivo,
               SUM(CASE WHEN y.cod_nive_rang = 'A' THEN x.VAL_MONT_VENT_FACT_CONS ELSE 0 END) MontoMNVentaConsecutivo_AV,
               SUM(CASE WHEN y.cod_nive_rang = 'B' THEN x.VAL_MONT_VENT_FACT_CONS ELSE 0 END) MontoMNVentaConsecutivo_BV,  
               SUM(CASE WHEN y.cod_nive_rang = 'A' THEN x.VAL_MONT_COBR_NETO_CONS ELSE 0 END) MontoMNRecaudoConsecutivo_AV,
               SUM(CASE WHEN y.cod_nive_rang = 'B' THEN x.VAL_MONT_COBR_NETO_CONS ELSE 0 END) MontoMNRecaudoConsecutivo_BV      
               
         FROM LEC_LIDER_RESUM_RECUP X,
              LEC_PROGR_NIVEL_RANGO Y
                WHERE X.PAIS_COD_PAIS = psCodigoPais
                  AND x.CAM_RECA = psCampanaProceso
                  AND y.pais_cod_pais = x.pais_cod_pais
                  AND y.lpro_cod_prog = x.LPRO_COD_PROG
                  AND y.cod_rang = x.pnra_cod_rang
             GROUP BY x.cod_regi,
                      x.cod_zona,
                      x.cod_secc
       ) PEDI
 WHERE lsrr.pais_cod_pais = lrrt.pais_cod_pais(+)
   AND lsrr.lpro_cod_prog = lrrt.lpro_cod_prog(+)
   AND lsrr.cod_regi = lrrt.cod_regi(+)
   AND lsrr.cod_zona = lrrt.cod_zona(+)
   AND lsrr.cod_secc = lrrt.cod_secc(+)
   AND lsrr.cod_lide = lrrt.cod_lide(+)
   AND lsrr.cam_recu = lrrt.cam_recu(+)
   AND lsrr.cam_recu = vsCampanaRecaudo
    --
   AND lsrr.pais_cod_pais = llni.pais_cod_pais(+)
   AND lsrr.lpro_cod_prog = llni.lpro_cod_prog(+)
   AND lsrr.cod_lide = llni.cod_lide(+)
   AND llni.ind_tipo_nive(+) = 'R'
   AND vsCampanaRecaudo BETWEEN llni.cam_inic(+) AND NVL(llni.cam_fin(+),vsCampanaRecaudo)
   --
   AND lrrt.pais_cod_pais = gana.pais_cod_pais(+)
   AND lrrt.lpro_cod_prog = gana.lpro_cod_prog(+)
   AND lrrt.cam_recu = gana.cam_gana(+)
   AND lrrt.lpct_cod_tram = gana.lcpt_cod_tram(+)
   AND lrrt.cod_lide = gana.cod_lide(+)
   
   AND lsrr.cod_regi = PEDI.cod_regi (+) 
   AND lsrr.cod_ZONA = PEDI.cod_ZONA (+) 
   AND lsrr.cod_SECC = PEDI.cod_SECC (+)
      ;

TYPE interfazRecTab IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;
--
   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

lsCodigoPrograma lec_progr.cod_prog%TYPE;
lsCampanaRecaudo seg_perio_corpo.cod_peri%TYPE;
lnIndcampaAnte   NUMBER;
w_filas number:=500;
BEGIN

    lbAbrirUtlFile:= TRUE;

-- Obtener parmetro de diferencia de das
    BEGIN
      SELECT TO_NUMBER(VAL_PARA)
        INTO lnIndCampaAnte
        FROM BAS_PARAM_PAIS
       WHERE COD_PAIS = psCodigoPais
         AND COD_SIST = 'LET'
         AND UPPER(NOM_PARA) = 'INDCAMPAANTE';
    EXCEPTION WHEN NO_DATA_FOUND THEN
      lnIndCampaAnte :=0;
    END;

-- Calcular campaa de recaudo
    lsCampanaRecaudo := GEN_FN_CALCU_PERIO ( psCampanaProceso, -( lnIndCampaAnte ) );

-- Obtener programa Activo
    BEGIN
      SELECT prog.cod_prog
        INTO lsCodigoPrograma
        FROM lec_progr prog
       WHERE 1=1
         AND lsCampanaRecaudo BETWEEN prog.cam_inic AND NVL(prog.cam_fin,lsCampanaRecaudo)
         AND prog.ind_acti = '1';
    EXCEPTION WHEN NO_DATA_FOUND THEN
      lsCodigoPrograma := NULL;
    END;

    OPEN c_interfaz( lsCodigoPrograma,lsCampanaRecaudo );
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

           /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).AnioCampana        ||';'||
                                  interfazRecord(x).CodPrograma        ||';'||
                                  interfazRecord(x).CodTramo           ||';'||
                                  interfazRecord(x).CodLider           ||';'||
                                  interfazRecord(x).CodSeccion         ||';'||
                                  interfazRecord(x).codNivel           ||';'||
                                  trim(to_char(interfazRecord(x).MontoMNVenta                  ,'999999999.99')) ||';'||
                                  trim(to_char(interfazRecord(x).MontoMNRecaudoTramo           ,'999999999.99')) ||';'||
                                  trim(to_char(interfazRecord(x).MontoMNRecaudoConsecutivo     ,'999999999.99')) ||';'||
                                  trim(to_char(interfazRecord(x).MontoMNRecaudoNoConsecutivo   ,'999999999.99')) ||';'||
                                  interfazRecord(x).CampanaRecaudo             ||';'||
                                  trim(to_char(interfazRecord(x).PorRecaudoTramo         ,'999999999.99'))       ||';'||
                                  interfazRecord(x).TipoGananciaPedidoCobranza       ||';'||
                                  trim(to_char(interfazRecord(x).GananciaPedidosTramo      ,'999999999.99'))     ||';'||
                                  trim(to_char(interfazRecord(x).GanPedConsecutivoTramo   ,'999999999.99'))      ||';'||
                                  trim(to_char(interfazRecord(x).GanPedNoCansecutivoTramo ,'999999999.99'))      ||';'||
                                  interfazRecord(x).CanastaPedidosTramo         ||';'||
                                  interfazRecord(x).CodCanasta   ||';'||
                                  trim(to_char(interfazRecord(x).MontoMNVentaTotal   , '999999999.99'))          ||';'||
                                  trim(to_char(interfazRecord(x).MontoMnRecaudoTotal , '999999999.99'))          ||';'||  
                                  trim(to_char(interfazRecord(x).GanPedConsecutivoTramo_AV    , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).GanPedConsecutivoTramo_BV    , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNVentaConsecutivo      , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNVentaNoConsecutivo    , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNVentaConsecutivo_AV   , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNVentaConsecutivo_BV   , '999999999.99'))||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNRecaudoConsecutivo_AV , '999999999.99')) ||';'|| 
                                  trim(to_char(interfazRecord(x).MontoMNRecaudoConsecutivo_BV , '999999999.99'))     ;
                                  
                                  --trim(to_char(interfazRecord(x).PorcComision, '999999999.99'))  ||';'||
                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RESUL_COBRA: '||ls_sqlerrm);


END INT_PR_DAT_ENVIO_RESUL_COBRA;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Cobranza por Tramo LET (DAT-157 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CICLO_VIDA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
 select pb.lpro_cod_prog codPrograma,
        pb.ltbo_cod_tipo_bono codCicloVida,
        tb.des_tipo_bono tipoCicloVida,
        pb.IND_ACTI flagPremio
    from lec_progr_bono pb,
         lec_tipo_bono tb,
         lec_progr p
    where p.cod_prog = pb.lpro_cod_prog
    and   p.pais_cod_pais = pb.pais_cod_pais
    and   tb.cod_tipo_bono = pb.ltbo_cod_tipo_bono
     AND TB.COD_TIPO_BONO  IN ('05','06','07')
    and   p.pais_cod_pais =   psCodigoPais
    AND   p.cam_inic <= psCodigoPeriodo
    AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null);




   TYPE interfazRec IS RECORD
      (
        codPrograma          lec_progr.cod_prog%TYPE,
        codCicloVida         LEC_TIPO_BONO.COD_TIPO_BONO%TYPE,
        tipoCicloVida        LEC_TIPO_BONO.DES_TIPO_BONO%TYPE,
       -- codTipoPremio        LEC_TIPO_PREMI.COD_TIPO_PREM%TYPE ,
        flagPremio           LEC_PROGR_BONO.IND_ACTI%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codCicloVida       ||';'||
                                  interfazRecord(x).tipoCicloVida      ||';'||
                               --   interfazRecord(x).codTipoPremio      ||';'||
                                  interfazRecord(x).flagPremio          ;
                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CICL_VIDA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CICLO_VIDA;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Ciclo Vida por Nivel LET (DAT-158 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CVIDA_NIVEL

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

    CURSOR c_interfaz IS
   SELECT BN.LPRO_COD_PROG codPrograma,
          BN.LTBO_COD_TIPO_BONO codCicloVida,
          BN.LNIV_COD_NIVE codNivel,
          BN.Num_Mini_Ingr minIngreso,
          BN.Num_Maxi_Ingr maxIngreso,
          BN.Num_Mini_Rete minRetencion,
          BN.Num_Maxi_Rete maxRetencion,
          BN.MON_PREM pagCicloVida,
          CASE
            WHEN bn.ltpr_cod_tipo_prem = '01' THEN '04'
            WHEN bn.ltpr_cod_tipo_prem = '02' THEN '01'
            ELSE NULL END tipoPrem
     FROM LEC_PROGR_BONO_NIVEL BN,
          LEC_PROGR P
    WHERE P.COD_PROG             = BN.LPRO_COD_PROG
      AND P.PAIS_COD_PAIS        = BN.PAIS_COD_PAIS
      AND P.PAIS_COD_PAIS        = PSCODIGOPAIS
      AND P.CAM_INIC            <= PSCODIGOPeriodo
      AND (P.CAM_FIN            >= PSCODIGOPeriodo OR P.CAM_FIN IS NULL)
      AND BN.LTBO_COD_TIPO_BONO IN ('05', '06', '07')
      AND bn.ind_acti = 1
      order by BN.LTBO_COD_TIPO_BONO, BN.LNIV_COD_NIVE ;


   TYPE interfazRec IS RECORD
      (
        codPrograma          lec_progr_bono_nivel.lpro_cod_prog%TYPE,
        codCicloVida         lec_progr_bono_nivel.ltbo_cod_tipo_bono%TYPE,
        codNivel             lec_progr_bono_nivel.lniv_cod_nive%TYPE,
        minIngreso           lec_progr_bono_nivel.num_mini_ingr%TYPE,
        maxIngreso            lec_progr_bono_nivel.num_maxi_ingr%TYPE ,
        minRetencion         lec_progr_bono_nivel.num_mini_rete%TYPE,
        maxRetencion         lec_progr_bono_nivel.num_maxi_rete%TYPE,
        pagCicloVida         lec_progr_bono_nivel.mon_prem%TYPE,
        tipoPrem             lec_progr_bono_nivel.Ltpr_Cod_Tipo_Prem%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF c_interfaz%ROWTYPE;
   interfazRecord interfazRecTab;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma        ||';'||
                                  interfazRecord(x).codCicloVida       ||';'||
                                  interfazRecord(x).codNivel           ||';'||
                                  interfazRecord(x).minIngreso         ||';'||
                                  interfazRecord(x).maxIngreso         ||';'||
                                  interfazRecord(x).minRetencion       ||';'||
                                  interfazRecord(x).maxRetencion       ||';'||
                                  interfazRecord(x).pagCicloVida       ||';'||
                                  interfazRecord(x).tipoPrem       ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CVIDA_NIVEL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CVIDA_NIVEL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Resultado Pedido (DAT-159 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Modificado        : C.Mori (11.03.2015)
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RESUL_PEDID

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

 CURSOR c_interfaz IS

SELECT
       psCodigoPeriodo AnioCampana,
       r.lpro_cod_prog CodPrograma,
       r.cod_lide CodLider,
       r.cod_zona || r.cod_secc CodSeccion,
          (SELECT n.lniv_cod_nive
          FROM LEC_lider_nivel n
             WHERE n.lpro_cod_prog = r.lpro_cod_prog
             AND n.cod_lide = r.cod_lide
             AND n.cam_inic <= r.cam_resu
           AND (n.cam_fin IS NULL OR r.cam_resu <= n.cam_fin)
           AND n.ind_tipo_nive = 'R') CodNivel,
       0 PedidosWebSeccion,
       ( pedi.pedConsecutivos + pedi.pedNConsecutivos ) PedSeccion,
       pedi.pedConsecutivos PedSeccionConsecutivos,
       pedi.pedNConsecutivos PedSeccionNoConsecutivos,
       --NVL(r.num_pedi, 0) PedSeccion,
       --NVL(r.num_pedi_cons, 0) PedSeccionConsecutivos,
       --NVL(r.num_pedi_ncon, 0) PedSeccionNoConsecutivos,
       s.num_pedi_obje_fina ObjetivoPedidos,
          CASE p.ind_gana_pedi
         WHEN '1' THEN
          (CASE r.leob_cod_esta_obje
            WHEN '03' THEN
             0
            WHEN '02' THEN
             1
            WHEN '01' THEN
             2
                          END)
         ELSE
          0
       END TipoGananciaPedidos,
          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '03'
              AND r.leob_cod_esta_obje <> '03'),
           0) GananciaPedidos,
          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '01'),
           0) GanPedConsecutivo,
          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '02'),
           0) GanPedNoCansecutivo,
       CASE (SELECT COUNT(1)
           FROM LEC_lider_canas f
          WHERE f.ltcn_cod_tipo_cana = '01'
            AND f.lpro_cod_prog = r.lpro_cod_prog
            AND f.cod_regi = r.cod_regi
            AND f.cod_zona = r.cod_zona
            AND f.cod_secc = r.cod_secc
            AND f.cod_lide = r.cod_lide
            AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
       END CanastaPedidos,
       NVL((CASE
             WHEN p.ltco_cod_tipo_comi = '01' AND
                  (SELECT COUNT(1)
                     FROM LEC_lider_canas f
                    WHERE f.ltcn_cod_tipo_cana = '01'
                      AND f.lpro_cod_prog = r.lpro_cod_prog
                      AND f.cod_regi = r.cod_regi
                      AND f.cod_zona = r.cod_zona
                      AND f.cod_secc = r.cod_secc
                      AND f.cod_lide = r.cod_lide
                      AND f.Cam_Refe = r.cam_resu) > 0 THEN
              '01'
             ELSE
              NULL
           END),
           0) CodCanastaPedido,
       r.IND_PEDI_PERS_LIDE FlagPedidoLider,
       r.ind_pedi_web FlagPedidoLiderWeb,
              CASE d.ltde_cod_tipo_dese
         WHEN '01' THEN
          'E'
         ELSE
          'NE'
       END EstatusCampana,
          CASE (SELECT LD.LTDE_COD_TIPO_DESE
           FROM LEC_LIDER_DESEM LD
                 WHERE ld.lpro_cod_prog = r.lpro_cod_prog
                   AND ld.lpec_cam_eval = r.cam_resu
                   AND ld.cod_regi = r.cod_regi
                   AND ld.cod_zona = r.cod_zona
                   AND ld.cod_secc = r.cod_secc
                   AND ld.cod_lide = r.cod_lide
            AND ld.ind_tipo_dese = 'E')
         WHEN '03' THEN
          'P'
         WHEN '04' THEN
          'E'
         WHEN '05' THEN
          'C'
         ELSE
             ''
       END EstatusEtapa,
       NVL((SELECT SUM(nvl(l.mon_gana, 0))
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana IN ('05', '06', '07', '08')),
           0) GananciaTotalLanzEst,

          (SELECT rb.num_ingr_secc
          FROM LEC_LIDER_SECCI_RESUL_BONO rb
           WHERE rb.ltbo_cod_tipo_bono = '05'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
           AND rb.cam_resu = r.cam_resu) IngresosSeccionCX_1,

          (SELECT rb.val_rete_secc
          FROM LEC_LIDER_SECCI_RESUL_BONO rb
           WHERE rb.ltbo_cod_tipo_bono = '05'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
           AND rb.cam_resu = r.cam_resu) Retencion2d2,

          (SELECT OB.VAL_OBJE_BONO
          FROM LEC_LIDER_SECCI_OBJET_BONO ob
             WHERE ob.lpro_cod_prog = r.lpro_cod_prog
             AND   ob.cod_regi = r.cod_regi
             AND   ob.cod_zona = r.cod_zona
             AND   ob.cod_secc = r.cod_secc
             AND   ob.cam_obje = psCodigoPeriodo
              AND OB.LNIV_COD_NIVE = n.lniv_cod_nive
           AND ob.ltbo_cod_tipo_bono = '05') ObjetivoRetencion2d2,

          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '09'),
           0) Ganancia2d2,
       CASE (
             SELECT bn.ltpr_cod_tipo_prem
               FROM LEC_progr_bono_nivel bn
          WHERE bn.pais_cod_pais = p.pais_cod_pais
            AND bn.lpro_cod_prog = p.cod_prog
            AND bn.ltbo_cod_tipo_bono = '05'
                AND bn.lniv_cod_nive = n.lniv_cod_nive
                AND bn.ind_acti = '1'
                AND NVL(
                        (
                          SELECT rb.val_rete_secc
                            FROM lec_lider_secci_resul_bono rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.lpro_cod_prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                 AND NVL(
                        (
                          SELECT rb.num_ingr_secc
                            FROM lec_lider_secci_resul_bono rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.lpro_cod_prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
         WHEN '02' THEN
          (CASE (SELECT COUNT(1)
               FROM LEC_lider_canas f
              WHERE f.ltcn_cod_tipo_cana = '06'
                AND f.lpro_cod_prog = r.lpro_cod_prog
                AND f.cod_regi = r.cod_regi
                AND f.cod_zona = r.cod_zona
                AND f.cod_secc = r.cod_secc
                AND f.cod_lide = r.cod_lide
                AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
          END)
         ELSE
          '0'
       END Canasta2d2,

       NVL(( CASE (
                   SELECT bn.ltpr_cod_tipo_prem
                     FROM LEC_progr_bono_nivel bn
               WHERE bn.pais_cod_pais = p.pais_cod_pais
                 AND bn.lpro_cod_prog = p.cod_prog
                 AND bn.ltbo_cod_tipo_bono = '05'
                      AND bn.lniv_cod_nive = n.lniv_cod_nive
                      AND bn.ind_acti = '1'
                      AND NVL(
                              (
                                SELECT rb.val_rete_secc
                                  FROM LEC_LIDER_SECCI_RESUL_BONO rb
                                 WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                                   AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                                   AND rb.cod_regi = r.cod_regi
                                   AND rb.cod_zona = r.cod_zona
                                   AND rb.cod_secc = r.cod_secc
                                   AND rb.cod_lide = r.cod_lide
                                   AND rb.cam_resu = r.cam_resu ),0)
                                  BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                      AND NVL(
                              (
                                SELECT rb.num_ingr_secc
                                  FROM LEC_LIDER_SECCI_RESUL_BONO rb
                                 WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                                   AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                                   AND rb.cod_regi = r.cod_regi
                                   AND rb.cod_zona = r.cod_zona
                                   AND rb.cod_secc = r.cod_secc
                                   AND rb.cod_lide = r.cod_lide
                                   AND rb.cam_resu = r.cam_resu ),0)
                                  BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
             WHEN '02' THEN
              '06'
             ELSE
              NULL
           END),
           0) CodCanasta2d2,

         NVL((SELECT rb.num_ingr_secc
             FROM LEC_LIDER_SECCI_RESUL_BONO rb
           WHERE rb.ltbo_cod_tipo_bono = '06'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
              AND rb.cam_resu = r.cam_resu),
           0) IngresosSeccionCX_2,

         NVL((SELECT rb.val_rete_secc
             FROM LEC_LIDER_SECCI_RESUL_BONO rb
           WHERE rb.ltbo_cod_tipo_bono = '06'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
              AND rb.cam_resu = r.cam_resu),
           0) Retencion3d3,

          (SELECT OB.VAL_OBJE_BONO
          FROM LEC_LIDER_SECCI_OBJET_BONO ob
             WHERE ob.lpro_cod_prog = r.lpro_cod_prog
             AND   ob.cod_regi = r.cod_regi
             AND   ob.cod_zona = r.cod_zona
             AND   ob.cod_secc = r.cod_secc
             AND   ob.cam_obje = psCodigoPeriodo
              AND ob.ltbo_cod_tipo_bono = '06'
           AND OB.LNIV_COD_NIVE = n.lniv_cod_nive) ObjetivoRetencion3d3,

          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '10'),
           0) Ganancia3d3,

       CASE (
             SELECT bn.ltpr_cod_tipo_prem
               FROM LEC_progr_bono_nivel bn
          WHERE bn.pais_cod_pais = p.pais_cod_pais
            AND bn.lpro_cod_prog = p.cod_prog
            AND bn.ltbo_cod_tipo_bono = '06'
                AND bn.lniv_cod_nive = n.lniv_cod_nive
                AND bn.ind_acti = '1'
                AND NVL(
                        (
                          SELECT rb.val_rete_secc
                            FROM LEC_LIDER_SECCI_RESUL_BONO rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                AND NVL(
                          (
                            SELECT rb.num_ingr_secc
                              FROM LEC_LIDER_SECCI_RESUL_BONO rb
                             WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                               AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                               AND rb.cod_regi = r.cod_regi
                               AND rb.cod_zona = r.cod_zona
                               AND rb.cod_secc = r.cod_secc
                               AND rb.cod_lide = r.cod_lide
                               AND rb.cam_resu = r.cam_resu ),0)
                              BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
         WHEN '02' THEN
          (CASE (SELECT COUNT(1)
               FROM LEC_lider_canas f
              WHERE f.ltcn_cod_tipo_cana = '07'
                AND f.lpro_cod_prog = r.lpro_cod_prog
                AND f.cod_regi = r.cod_regi
                AND f.cod_zona = r.cod_zona
                AND f.cod_secc = r.cod_secc
                AND f.cod_lide = r.cod_lide
                AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
          END)
         ELSE
          '0'
       END Canasta3d3,

       NVL((CASE (
             SELECT bn.ltpr_cod_tipo_prem
               FROM LEC_progr_bono_nivel bn
               WHERE bn.pais_cod_pais = p.pais_cod_pais
                 AND bn.lpro_cod_prog = p.cod_prog
                 AND bn.ltbo_cod_tipo_bono = '06'
                AND bn.lniv_cod_nive = n.lniv_cod_nive
                AND bn.ind_acti = '1'
                AND NVL(
                        (
                          SELECT rb.val_rete_secc
                            FROM LEC_LIDER_SECCI_RESUL_BONO rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                AND NVL(
                          (
                            SELECT rb.num_ingr_secc
                              FROM LEC_LIDER_SECCI_RESUL_BONO rb
                             WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                               AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                               AND rb.cod_regi = r.cod_regi
                               AND rb.cod_zona = r.cod_zona
                               AND rb.cod_secc = r.cod_secc
                               AND rb.cod_lide = r.cod_lide
                               AND rb.cam_resu = r.cam_resu ),0)
                              BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
             WHEN '02' THEN
              '07'
             ELSE
              NULL
           END),
           0) CodCanasta3d3,

          NVL((SELECT rb.num_ingr_secc
             FROM LEC_LIDER_SECCI_RESUL_BONO rb
           WHERE rb.ltbo_cod_tipo_bono = '07'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
              AND rb.cam_resu = r.cam_resu),
           0) IngresosSeccionCX_3,

          NVL((SELECT rb.val_rete_secc
             FROM LEC_LIDER_SECCI_RESUL_BONO rb
            WHERE rb.ltbo_cod_tipo_bono = '07'
           AND   rb.Lpro_Cod_Prog= r.lpro_cod_prog
           AND   rb.cod_regi= r.cod_regi
           AND   rb.cod_zona= r.cod_zona
           AND   rb.cod_secc= r.cod_secc
           AND   rb.cod_lide= r.cod_lide
              AND rb.cam_resu = r.cam_resu),
           0) Retencion4d4,

          NVL((SELECT OB.VAL_OBJE_BONO
             FROM LEC_LIDER_SECCI_OBJET_BONO ob
                WHERE ob.lpro_cod_prog = r.lpro_cod_prog
                  AND ob.cod_regi = r.cod_regi
                  AND ob.cod_zona = r.cod_zona
                  AND ob.cod_secc = r.cod_secc
                  AND ob.cam_obje = psCodigoPeriodo
                  AND OB.LNIV_COD_NIVE = n.lniv_cod_nive
              AND ob.ltbo_cod_tipo_bono = '07'),
           0) ObjetivoRetencion4d4,

          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '11'),
           0) Ganancia4d4,

       CASE (
             SELECT bn.ltpr_cod_tipo_prem
               FROM LEC_progr_bono_nivel bn
          WHERE bn.pais_cod_pais = p.pais_cod_pais
            AND bn.lpro_cod_prog = p.cod_prog
            AND bn.ltbo_cod_tipo_bono = '07'
                AND bn.lniv_cod_nive = n.lniv_cod_nive
                AND bn.ind_acti = '1'
                AND NVL(
                        (
                          SELECT rb.val_rete_secc
                            FROM LEC_LIDER_SECCI_RESUL_BONO rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                AND NVL(
                          (
                            SELECT rb.num_ingr_secc
                              FROM LEC_LIDER_SECCI_RESUL_BONO rb
                             WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                               AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                               AND rb.cod_regi = r.cod_regi
                               AND rb.cod_zona = r.cod_zona
                               AND rb.cod_secc = r.cod_secc
                               AND rb.cod_lide = r.cod_lide
                               AND rb.cam_resu = r.cam_resu ),0)
                              BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
         WHEN '02' THEN
          (CASE (SELECT COUNT(1)
               FROM LEC_lider_canas f
              WHERE f.ltcn_cod_tipo_cana = '08'
                AND f.lpro_cod_prog = r.lpro_cod_prog
                AND f.cod_regi = r.cod_regi
                AND f.cod_zona = r.cod_zona
                AND f.cod_secc = r.cod_secc
                AND f.cod_lide = r.cod_lide
                AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
          END)
         ELSE
          '0'
       END Canasta4d4,

       NVL((CASE (
             SELECT bn.ltpr_cod_tipo_prem
               FROM LEC_progr_bono_nivel bn
               WHERE bn.pais_cod_pais = p.pais_cod_pais
                 AND bn.lpro_cod_prog = p.cod_prog
                 AND bn.ltbo_cod_tipo_bono = '07'
                AND bn.lniv_cod_nive = n.lniv_cod_nive
                AND bn.ind_acti = '1'
                AND NVL(
                        (
                          SELECT rb.val_rete_secc
                            FROM LEC_LIDER_SECCI_RESUL_BONO rb
                           WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                             AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                             AND rb.cod_regi = r.cod_regi
                             AND rb.cod_zona = r.cod_zona
                             AND rb.cod_secc = r.cod_secc
                             AND rb.cod_lide = r.cod_lide
                             AND rb.cam_resu = r.cam_resu ),0)
                            BETWEEN bn.num_mini_rete AND bn.num_maxi_rete
                AND NVL(
                          (
                            SELECT rb.num_ingr_secc
                              FROM LEC_LIDER_SECCI_RESUL_BONO rb
                             WHERE rb.ltbo_cod_tipo_bono = bn.ltbo_cod_tipo_bono
                               AND rb.Lpro_Cod_Prog = r.lpro_cod_prog
                               AND rb.cod_regi = r.cod_regi
                               AND rb.cod_zona = r.cod_zona
                               AND rb.cod_secc = r.cod_secc
                               AND rb.cod_lide = r.cod_lide
                               AND rb.cam_resu = r.cam_resu ),0)
                              BETWEEN bn.num_mini_ingr AND bn.num_maxi_ingr )
             WHEN '02' THEN
              '08'
             ELSE
              NULL
           END),
           0) CodCanasta4d4,

          NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '12'),
           0) GananciaCambioNivel,

          CASE ( SELECT bn.ltpr_cod_tipo_prem
           FROM LEC_progr_bono_nivel bn
          WHERE bn.pais_cod_pais = p.pais_cod_pais
            AND bn.lpro_cod_prog = p.cod_prog
            AND bn.ltbo_cod_tipo_bono = '08'
            AND bn.lniv_cod_nive = n.lniv_cod_nive)
         WHEN '02' THEN
          (CASE (SELECT COUNT(1)
               FROM LEC_lider_canas f
              WHERE f.ltcn_cod_tipo_cana = '09'
                AND f.lpro_cod_prog = r.lpro_cod_prog
                AND f.cod_regi = r.cod_regi
                AND f.cod_zona = r.cod_zona
                AND f.cod_secc = r.cod_secc
                AND f.cod_lide = r.cod_lide
                AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
          END)
         ELSE
          '0'
       END CanastaCambioNivel,
       NVL((CASE (SELECT bn.ltpr_cod_tipo_prem
                FROM LEC_progr_bono_nivel bn
               WHERE bn.pais_cod_pais = p.pais_cod_pais
                 AND bn.lpro_cod_prog = p.cod_prog
                 AND bn.ltbo_cod_tipo_bono = '08'
                 AND bn.lniv_cod_nive = n.lniv_cod_nive)
             WHEN '02' THEN
              '09'
             ELSE
              NULL
           END),
           0) CodCanastaCambioNivel,
       n.lniv_cod_nive CodNivelProyectado,
          (NVL((SELECT l.mon_gana
              FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
               AND l.ltga_cod_tipo_gana = '13'),
            0)) GananciaPerGracia,
          CASE ( SELECT bn.ltpr_cod_tipo_prem
           FROM LEC_progr_bono_nivel bn
          WHERE bn.pais_cod_pais = p.pais_cod_pais
            AND bn.lpro_cod_prog = p.cod_prog
            AND bn.ltbo_cod_tipo_bono = '09'
            AND bn.lniv_cod_nive = n.lniv_cod_nive)
         WHEN '02' THEN
          (CASE (SELECT COUNT(1)
               FROM LEC_lider_canas f
              WHERE f.ltcn_cod_tipo_cana = '10'
                AND f.lpro_cod_prog = r.lpro_cod_prog
                AND f.cod_regi = r.cod_regi
                AND f.cod_zona = r.cod_zona
                AND f.cod_secc = r.cod_secc
                AND f.cod_lide = r.cod_lide
                AND f.Cam_Refe = r.cam_resu)
            WHEN 0 THEN
             '0'
            ELSE
             '1'
          END)
         ELSE
          '0'
       END CanastaPerGracia,
          Nvl((CASE ( SELECT bn.ltpr_cod_tipo_prem
                FROM LEC_progr_bono_nivel bn
               WHERE bn.pais_cod_pais = p.pais_cod_pais
                 AND bn.lpro_cod_prog = p.cod_prog
                 AND bn.ltbo_cod_tipo_bono = '09'
                 AND bn.lniv_cod_nive = n.lniv_cod_nive)
             WHEN '02' THEN
              '10'
             ELSE
              NULL
           END),
           0) CodCanastaPerGracia,
      CASE  (SELECT count(1)
          FROM LEC_lider_nivel n,
               LEC_NIVEL nin,
               LEC_PROGR_CURSO cu,
               LEC_NIVEL nic
         WHERE n.lpro_cod_prog = r.lpro_cod_prog
           AND n.cod_lide = r.cod_lide
           AND n.cam_inic <= r.cam_resu
           AND (n.cam_fin IS NULL OR r.cam_resu <= n.cam_fin)
           AND n.ind_tipo_nive = 'R'
           AND n.lniv_cod_nive = nin.cod_nive
           AND r.cod_lide = cu.cod_cons_lide
           and cu.lniv_cod_nive = nic.cod_nive
           and nic.val_peso_nive > nin.val_peso_nive
           and cu.cam_regi <= psCodigoPeriodo )
       WHEN 0 THEN '0'
       ELSE '1'
       END CumpleCurso 
       ,
       (gen_pkg_gener.GEN_FN_DEVUE_DIFER_PERIO(N.CAM_INIC, psCodigoPeriodo) + 1) NroCampanaEnNivel,
       NVL((SELECT n.mont_vent_rtal
             FROM LEC_lider_nivel n
             WHERE n.lpro_cod_prog = r.lpro_cod_prog
             AND n.cod_lide = r.cod_lide
             AND n.cam_inic = r.cam_resu
              AND n.ind_tipo_nive = 'P'),
           0) VentaRetail,
       NVL((SELECT l.mon_gana
             FROM LEC_LIDER_GANAN l
            WHERE l.lpro_cod_prog = r.lpro_cod_prog
              AND l.cod_regi = r.cod_regi
              AND l.cod_zona = r.cod_zona
              AND l.cod_secc = r.cod_secc
              AND l.cod_lide = r.cod_lide
              AND l.cam_gana = r.cam_resu
              AND l.ltga_cod_tipo_gana = '18'),
           0) GananciaRetail,
       (SELECT n.mon_vent_cata
          FROM LEC_lider_nivel n
         WHERE n.lpro_cod_prog = r.lpro_cod_prog
           AND n.cod_lide = r.cod_lide
           AND n.cam_inic <= r.cam_resu
           AND (n.cam_fin IS NULL OR r.cam_resu <= n.cam_fin)
           AND n.ind_tipo_nive = 'P') VentaCatalogoD,
        nvl(s.val_obje_vent,0) MontoMnVentaObje,
        nvl(r.num_ingr_secc,0) IngreSeccion,
        nvl(r.num_ingr_secc,0) + nvl(r.num_rein_secc,0) - nvl(r.num_egre_secc,0) CapitSeccion,
        pedi.PedSeccionConsecutivos_AV      ,
        pedi.PedSeccionConsecutivos_BV      ,
        0 IngresosSeccionCX_4            ,
        0 Retencion5d5                   ,
        0 ObjetivoRetencion5d5           ,
        0 Ganancia5d5                    ,
        0 Canasta5d5                     ,
        '0' CodCanasta5d5                  ,
        0 IngresosSeccionCX_5            ,
        0 Retencion6d6                   ,
        0 ObjetivoRetencion6d6           ,
        0 Ganancia6d6                    ,
        0 Canasta6d6                     ,
        '0' CodCanasta6d6                  ,
        0 BonoTactico                    ,
        pedi.VentaCatalogoDConsecutivo      ,
        pedi.VentaCatalogoDNoConsecutivo    ,
        pedi.VentaCatalogoDConsecutivo_AV   ,
        pedi.VentaCatalogoDConsecutivo_BV   ,
        '0' CampUsoTolerancia

  FROM LEC_Progr                   p,
       LEC_LIDER_SECCI_RESUL       r,
       LEC_LIDER_SECCI_OBJET_PEDID s,
       LEC_LIDER_DESEM             d,
       LEC_LIDER_NIVEL             N,
       (
        SELECT x.cod_regi,
               x.cod_zona,
               x.cod_secc,
               SUM(CASE WHEN y.cod_nive_rang = 'A' THEN x.val_nume_pedi_cons ELSE 0 END) PedSeccionConsecutivos_AV,
               SUM(CASE WHEN y.cod_nive_rang = 'B' THEN x.val_nume_pedi_cons ELSE 0 END) PedSeccionConsecutivos_BV,
               SUM(x.val_mont_vent_cata_cons) VentaCatalogoDConsecutivo,
               SUM(x.val_mont_vent_cata_ncon) VentaCatalogoDNoConsecutivo,
               SUM(CASE WHEN y.cod_nive_rang = 'A' THEN x.val_mont_vent_cata_cons ELSE 0 END) VentaCatalogoDConsecutivo_AV,
               SUM(CASE WHEN y.cod_nive_rang = 'B' THEN x.val_mont_vent_cata_cons ELSE 0 END) VentaCatalogoDConsecutivo_BV,
               SUM(x.val_nume_pedi_cons) pedConsecutivos,
               SUM(x.val_nume_pedi_ncon) PedNConsecutivos               
         FROM lec_lider_resum_recup x,
              lec_progr_nivel_rango y
         WHERE x.pais_cod_pais = psCodigoPais
           AND x.cam_reca = psCodigoPeriodo
           AND y.pais_cod_pais = x.pais_cod_pais
           AND y.lpro_cod_prog = x.lpro_cod_prog
           AND y.cod_rang = x.pnra_cod_rang
         GROUP BY x.cod_regi,
                  x.cod_zona,
                  x.cod_secc
       ) PEDI
   WHERE p.pais_cod_pais  = r.pais_cod_pais
     AND p.cod_prog       = r.lpro_cod_prog
     AND r.pais_cod_pais  = s.lpro_cod_pais
     AND r.lpro_cod_prog  = s.lpro_cod_prog
     AND r.cod_regi       = s.cod_regi
     AND r.cod_zona       = s.cod_zona
     AND r.cod_secc        = s.cod_secc
     AND r.cam_resu       = s.cam_obje
   AND      r.pais_cod_pais =  psCodigoPais
     AND d.lpro_cod_prog  = r.lpro_cod_prog
     AND d.lpec_cam_eval  = r.cam_resu
     AND d.cod_regi       = r.cod_regi
     AND d.cod_zona       = r.cod_zona
     AND d.cod_secc       = r.cod_secc
     AND d.cod_lide       = r.cod_lide
     AND r.cam_resu       = psCodigoPeriodo
      AND n.lpro_cod_prog = r.lpro_cod_prog
     AND n.cod_lide       = r.cod_lide
     AND n.cam_inic      <= r.cam_resu
   AND (n.cam_fin IS NULL OR r.cam_resu <= n.cam_fin)
     AND n.ind_tipo_nive  = 'R'
   AND d.ind_tipo_dese = 'C'
   AND R.cod_regi = PEDI.cod_regi (+)
   AND R.cod_ZONA = PEDI.cod_ZONA (+)
   AND R.cod_SECC = PEDI.cod_SECC (+)  ;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(4000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER02(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE, 4000);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).ANIOCAMPANA                    ||';'||
                                  interfazRecord(x).CODPROGRAMA                    ||';'||
                                  interfazRecord(x).CODLIDER                       ||';'||
                                  interfazRecord(x).CODSECCION                     ||';'||
                                  interfazRecord(x).CODNIVEL                       ||';'||
                                  interfazRecord(x).PEDIDOSWEBSECCION              ||';'||
                                  interfazRecord(x).PEDSECCION                     ||';'||
                                  interfazRecord(x).PEDSECCIONCONSECUTIVOS         ||';'||
                                  interfazRecord(x).PEDSECCIONNOCONSECUTIVOS       ||';'||
                                  interfazRecord(x).OBJETIVOPEDIDOS                ||';'||
                                  interfazRecord(x).TIPOGANANCIAPEDIDOS            ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIAPEDIDOS     , '999999999.99'))            ||';'||
                                  trim(to_char(interfazRecord(x).GANPEDCONSECUTIVO   , '999999999.99'))            ||';'||
                                  trim(to_char(interfazRecord(x).GANPEDNOCANSECUTIVO , '999999999.99'))            ||';'||
                                  interfazRecord(x).CANASTAPEDIDOS                 ||';'||
                                  interfazRecord(x).CODCANASTAPEDIDO               ||';'||
                                  interfazRecord(x).FLAGPEDIDOLIDER                ||';'||
                                  interfazRecord(x).FLAGPEDIDOLIDERWEB             ||';'||
                                  interfazRecord(x).ESTATUSCAMPANA                 ||';'||
                                  interfazRecord(x).ESTATUSETAPA                   ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIATOTALLANZEST, '999999999.99'))           ||';'||
                                  interfazRecord(x).INGRESOSSECCIONCX_1            ||';'||
                                  interfazRecord(x).RETENCION2D2                   ||';'||
                                  interfazRecord(x).OBJETIVORETENCION2D2           ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIA2D2, '999999999.99'))                     ||';'||
                                  interfazRecord(x).CANASTA2D2                     ||';'||
                                  interfazRecord(x).CODCANASTA2D2                  ||';'||
                                  interfazRecord(x).INGRESOSSECCIONCX_2            ||';'||
                                  interfazRecord(x).RETENCION3D3                   ||';'||
                                  interfazRecord(x).OBJETIVORETENCION3D3           ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIA3D3 , '999999999.99'))                    ||';'||
                                  interfazRecord(x).CANASTA3D3                     ||';'||
                                  interfazRecord(x).CODCANASTA3D3                  ||';'||
                                  interfazRecord(x).INGRESOSSECCIONCX_3            ||';'||
                                  interfazRecord(x).RETENCION4D4                   ||';'||
                                  interfazRecord(x).OBJETIVORETENCION4D4           ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIA4D4 , '999999999.99'))                    ||';'||
                                  interfazRecord(x).CANASTA4D4                     ||';'||
                                  interfazRecord(x).CODCANASTA4D4                  ||';'||
                                  interfazRecord(x).GANANCIACAMBIONIVEL            ||';'||
                                  interfazRecord(x).CANASTACAMBIONIVEL             ||';'||
                                  interfazRecord(x).CODCANASTACAMBIONIVEL          ||';'||
                                  interfazRecord(x).CODNIVELPROYECTADO             ||';'||
                                  interfazRecord(x).GANANCIAPERGRACIA              ||';'||
                                  interfazRecord(x).CANASTAPERGRACIA               ||';'||
                                  interfazRecord(x).CODCANASTAPERGRACIA            ||';'||
                                  interfazRecord(x).CUMPLECURSO                    ||';'||
                                  interfazRecord(x).NROCAMPANAENNIVEL              ||';'||
                                  trim(to_char(interfazRecord(x).VENTARETAIL      , '999999999.99'))               ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIARETAIL   , '999999999.99'))               ||';'||
                                  trim(to_char(interfazRecord(x).VENTACATALOGOD   , '999999999.99'))               ||';'||
                                  trim(to_char(interfazRecord(x).MONTOMNVENTAOBJE , '999999999.99'))               ||';'||
                                  interfazRecord(x).INGRESECCION                   ||';'||
                                  interfazRecord(x).CAPITSECCION                   ||';'||
                                  interfazRecord(x).PEDSECCIONCONSECUTIVOS_AV      ||';'||
                                  interfazRecord(x).PEDSECCIONCONSECUTIVOS_BV      ||';'||
                                  interfazRecord(x).INGRESOSSECCIONCX_4            ||';'||
                                  interfazRecord(x).RETENCION5D5                   ||';'||
                                  interfazRecord(x).OBJETIVORETENCION5D5           ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIA5D5 , '999999999.99'))                    ||';'||
                                  interfazRecord(x).CANASTA5D5                     ||';'||
                                  interfazRecord(x).CODCANASTA5D5                  ||';'||
                                  interfazRecord(x).INGRESOSSECCIONCX_5            ||';'||
                                  interfazRecord(x).RETENCION6D6                   ||';'||
                                  interfazRecord(x).OBJETIVORETENCION6D6           ||';'||
                                  trim(to_char(interfazRecord(x).GANANCIA6D6 , '999999999.99'))                    ||';'||
                                  interfazRecord(x).CANASTA6D6                     ||';'||
                                  interfazRecord(x).CODCANASTA6D6                  ||';'||
                                  trim(to_char(interfazRecord(x).BONOTACTICO , '999999999.99'))                   ||';'||
                                  trim(to_char(interfazRecord(x).VENTACATALOGODCONSECUTIVO , '999999999.99'))     ||';'||
                                  trim(to_char(interfazRecord(x).VENTACATALOGODNOCONSECUTIVO, '999999999.99'))    ||';'||
                                  trim(to_char(interfazRecord(x).VENTACATALOGODCONSECUTIVO_AV , '999999999.99'))  ||';'||
                                  trim(to_char(interfazRecord(x).VENTACATALOGODCONSECUTIVO_BV , '999999999.99'))  ||';'||
                                  interfazRecord(x).CAMPUSOTOLERANCIA;
       

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;



    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RESUL_PEDID: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_RESUL_PEDID;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lideres (DAT-160 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_MAEST_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

  CURSOR c_interfaz IS

    SELECT z.gere,
           GEN_PKG_GENER.gen_fn_devuelve_des_perio(min(z.perd_oid_peri_desd))
    FROM   zon_histo_geren z
    WHERE   GEN_PKG_GENER.gen_fn_devuelve_des_perio(z.perd_oid_peri_desd)<= psCodigoPeriodo
    AND    (GEN_PKG_GENER.gen_fn_devuelve_des_perio(z.perd_oid_peri_hast)>= psCodigoPeriodo
           OR z.perd_oid_peri_hast is null)
    AND    z.cod_secc IS NOT NULL
    GROUP BY z.gere;

   TYPE interfazRec IS RECORD
      (
        codLider             ZON_HISTO_GEREN.GERE%TYPE,
        anioCampana          VARCHAR2(6)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codLider      ||';'||
                                  interfazRecord(x).anioCampana       ;
                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_MAEST_LIDER: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_MAEST_LIDER;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro Clasificaciones LET (DAT-161 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CLASI_SUBCL
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

  IS

CURSOR c_interfaz IS

    SELECT p.cod_prog,
       lc.cod_clas,
       ls.cod_subc,
       lc.des_clas,
       ls.des_subc
FROM
       LEC_SUBCL ls,
           LEC_CLASI lc,
           LEC_PROGR p
    WHERE  ls.lccl_cod_clas = lc.cod_clas
    AND    p.cam_inic <= psCodigoPeriodo
    AND    (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null);

	 TYPE interfazRec IS RECORD
      (
        codPrograma           LEC_PROGR.COD_PROG%TYPE ,
        codClasificacion      LEC_CLASI.COD_CLAS%TYPE ,
        codSubClasificacion   LEC_SUBCL.COD_SUBC%TYPE ,
        desClasificacion      LEC_CLASI.DES_CLAS%TYPE ,
        desSubClasificacion   LEC_SUBCL.DES_SUBC%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

   /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;

BEGIN

    lbAbrirUtlFile:= TRUE;
    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma          ||';'||
                                  interfazRecord(x).codClasificacion     ||';'||
                                  interfazRecord(x).codSubClasificacion  ||';'||
                                  interfazRecord(x).desClasificacion     ||';'||
                                  interfazRecord(x).desSubClasificacion  ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CLASI_SUBCL: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CLASI_SUBCL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Lideres (DAT-162 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psCodigoPeriodo : Codigo Periodo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_SECCI_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

  CURSOR c_interfaz IS

    SELECT psCodigoPeriodo,
           z.cod_zona,
           z.cod_zona||z.cod_secc,
           z.gere,
           '1', --SIEMPRE ACTIVAS
           lc.lccl_cod_clas,
           lc.lscl_cod_subc,
           GEN_PKG_GENER.gen_fn_devuelve_des_perio(z.perd_oid_peri_desd ),
           CASE
             WHEN z.ind_orig_regi = 'C' THEN '1'
             WHEN z.ind_orig_regi = 'W' THEN '2'
             ELSE 'C'
           END CodCanalIngreso, -- Nuevo
           CASE
             WHEN z.ind_orig_regi = 'C' THEN 'SISTEMA COMERCIAL'
             WHEN z.ind_orig_regi = 'W' THEN 'WEB'
             ELSE 'SISTEMA COMERCIAL'
           END DesCanalIngreso -- Nuevo
    FROM   zon_histo_geren z,
           LEC_LIDER_CLASI lc
    WHERE   GEN_PKG_GENER.gen_fn_devuelve_des_perio(z.perd_oid_peri_desd)<= psCodigoPeriodo
    AND    (GEN_PKG_GENER.gen_fn_devuelve_des_perio(z.perd_oid_peri_hast)>= psCodigoPeriodo
           OR z.perd_oid_peri_hast is null)
    AND    z.cod_secc IS NOT NULL
    AND    z.GERE = lc.cod_lide
    AND    (lc.cam_inic <=  psCodigoPeriodo  AND (psCodigoPeriodo <=lc.cam_fin  OR lc.cam_fin IS NULL ));

   TYPE interfazRec IS RECORD
      (
        anioCampana          CHAR(6),
        codZona              zon_histo_geren.cod_zona%TYPE,
        codSeccion           VARCHAR2(5),
        codLider             zon_histo_geren.gere%TYPE,
        flagActiva           CHAR(1),
        codClasi             zon_histo_geren.cod_lide_clas%TYPE,
        codSubClas           CHAR(4),
        camInicio            CHAR(6),
        CodCanalIngreso      VARCHAR2(1), -- Nuevo
        DesCanalIngreso      VARCHAR2(20) -- Nuevo
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).anioCampana   ||';'||
                                  interfazRecord(x).codZona       ||';'||
                                  interfazRecord(x).codSeccion    ||';'||
                                  interfazRecord(x).codLider      ||';'||
                                  interfazRecord(x).flagActiva    ||';'||
                                  interfazRecord(x).codClasi      ||';'||
                                  interfazRecord(x).codSubClas    ||';'||
                                  interfazRecord(x).camInicio       ||';'||
                                  interfazRecord(x).CodCanalIngreso ||';'||
                                  interfazRecord(x).DesCanalIngreso;
                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_SECCI_LIDER: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_SECCI_LIDER;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Maestro de Bajas(DAT-163 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_BAJA_LIDER

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

 CURSOR c_interfaz IS
    SELECT b.lpro_cod_prog,
           b.cod_zona||b.cod_secc,
           b.cod_lide,
           b.cam_baja,
           d.des_tipo_desv,
           b.ltde_cod_tipo_desv
    FROM   LEC_LIDER_BAJA b,
           ZON_TIPO_DESVI d,
           LEC_PROGR p
    WHERE d.cod_tipo_desv = b.ltde_cod_tipo_desv
    AND   b.lpro_cod_prog = p.cod_prog
    AND   p.pais_cod_pais = b.pais_cod_pais
    AND   p.pais_cod_pais = psCodigoPais
    AND   p.cam_inic <= psCodigoPeriodo
    AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null);

   	TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_LIDER_BAJA.LPRO_COD_PROG%TYPE,
        codSeccion           varchar2(5),
        codLider             LEC_LIDER_BAJA.COD_LIDE%TYPE,
        campBaja             LEC_LIDER_BAJA.CAM_BAJA%TYPE,
        desTipoBaja          ZON_TIPO_DESVI.DES_TIPO_DESV%TYPE,
        codTipoBaja          ZON_TIPO_DESVI.COD_TIPO_DESV%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

    /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma     ||';'||
                                  interfazRecord(x).codSeccion      ||';'||
                                  interfazRecord(x).codLider        ||';'||
                                  interfazRecord(x).campBaja        ||';'||
                                  interfazRecord(x).desTipoBaja     ||';'||
                                  interfazRecord(x).codTipoBaja     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_BAJA_LIDER: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_BAJA_LIDER;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Calendario Cobranza (DAT-164 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CALEN_COBRA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
   CURSOR c_interfaz IS
   SELECT  p.cod_prog,
           '1',
           '',
           '',
        TO_CHAR(bc.fec_cale,'YYYYMMDD')
   FROM BAS_CALEN bc,
        LEC_PROGR p
   WHERE p.cam_inic <= psCodigoPeriodo
   AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
   AND   SUBSTR(psCodigoPeriodo,1,4) = bc.cod_anio
   AND   bc.ind_feri= 'S'
   UNION
   SELECT p.cod_prog,'0',r.cod_regi, v.cod_zona, TO_CHAR(v.fec_cale,'YYYYMMDD')
   FROM   VEN_FERIA_ZONA v,
          LEC_PROGR p,
          ZON_ZONA z,
          ZON_REGIO r
   WHERE p.cam_inic <= psCodigoPeriodo
   AND   (p.cam_fin >= psCodigoPeriodo or p.cam_fin is null)
   AND   SUBSTR(psCodigoPeriodo,1,4) = v.cod_anio
   AND   z.cod_zona = v.cod_zona
   AND   z.zorg_oid_regi = r.oid_regi  ;

   TYPE interfazRec IS RECORD
      (
        codPrograma          LEC_PROGR.COD_PROG%TYPE,
        flagPais             CHAR(1),
        codRegion            ZON_REGIO.COD_REGI%TYPE,
        codZona              ZON_ZONA.COD_ZONA%TYPE,
        fechaFeriado         VARCHAR2(10)
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;

  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).flagPais       ||';'||
                                  interfazRecord(x).codRegion      ||';'||
                                  interfazRecord(x).codZona        ||';'||
                                  interfazRecord(x).fechaFeriado     ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;

EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_CALEN_COBRA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_CALEN_COBRA;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio MAestro Exigencia Web por Geografia (DAT-165 )
Fecha Creacion    : 22/11/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_EXIGE_GEOGR

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
   SELECT  ge.lpro_cod_prog,
            (SELECT CASE U.COD_TIPO_USO_GEOG
                      WHEN '01' THEN
                       '1'
                      WHEN '02' THEN
                       '2'
                      WHEN '03' THEN
                       '3'
                   END
           FROM  lec_tipo_uso_geog u
           WHERE u.cod_tipo_uso_geog = ge.ltug_cod_tipo_uso_geog),
            nvl(ge.ind_pais, 0),
           ge.cod_regi,
           ge.cod_zona
     FROM  Lec_Progr_Ambit_Geogr ge,
           lec_progr pr
     WHERE pr.pais_cod_pais = ge.pais_cod_pais
     AND   pr.cod_prog = ge.lpro_cod_prog
        AND ge.ltug_cod_tipo_uso_geog IN ('02','03')
     AND   pr.pais_cod_pais = psCodigoPais
     AND   pr.cam_inic <= psCodigoPeriodo
     AND ge.ind_acti = 1
     AND  (pr.cam_fin >= psCodigoPeriodo or pr.cam_fin is null);

   TYPE interfazRec IS RECORD
      (
        codPrograma          Lec_Progr_Ambit_Geogr.Lpro_Cod_Prog%TYPE,
        tipo                 VARCHAR2(1),
        flagPais             Lec_Progr_Ambit_Geogr.Ind_Pais%TYPE,
        codRegion            Lec_Progr_Ambit_Geogr.Cod_Regi%TYPE,
        codZona              Lec_Progr_Ambit_Geogr.Cod_Zona%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
   lsMontoAlto         VARCHAR2(50);
   lnMontoAlto         LEC_PROGR_NIVEL_RANGO.Val_Mont_Maxi%TYPE;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).tipo           ||';'||
                                  interfazRecord(x).flagPais       ||';'||
                                  interfazRecord(x).codRegion      ||';'||
                                  interfazRecord(x).codZona               ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_EXIGE_GEOGR: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_EXIGE_GEOGR;

/***************************************************************************
Descripcion : Interfaz que envia Maestro Tipo Reemplazo
Fecha Creacion : 05/05/2014
Autor : Sebastian Guerra
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Arcchivo
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_TIPO_REEMP
 (psCodigoPais            VARCHAR2,
  psCodigoSistema       VARCHAR2,
  psCodigoInterfaz      VARCHAR2,
  psNombreArchivo      VARCHAR2)
IS
  CURSOR c_interfaz IS
    SELECT COD_TIPO_REEM codigoTipoReemplazo,
                 DES_TIPO_REEM descripcionTipoReemplazo
    FROM PRE_TIPO_REEMP
    ORDER BY COD_TIPO_REEM;

  TYPE interfazTipo IS RECORD(
    codigoTipoReemplazo                    PRE_TIPO_REEMP.COD_TIPO_REEM%TYPE,
    descripcionTipoReemplazo             PRE_TIPO_REEMP.DES_TIPO_REEM%TYPE
  );

  TYPE interfazTab IS TABLE OF interfazTipo ;
  interfazRecord interfazTab;

 /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
  w_filas NUMBER := 1000 ;
  v_handle UTL_FILE.FILE_TYPE;
  lsLinea VARCHAR2(1000);
  lbAbrirUtlFile BOOLEAN;
  lsNombreArchivo VARCHAR2(50);

BEGIN
 /* Generando Archivo de Texto (Detalle) */
 lbAbrirUtlFile := TRUE;
 OPEN c_interfaz;
 LOOP
   FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

 /* Procedimiento inicial para generar interfaz */
  IF lbAbrirUtlFile THEN
    gen_pkg_inter_archi.gen_pr_inici_inter(psCodigoPais, psCodigoSistema, psCodigoInterfaz, psNombreArchivo, lsDirTempo, lsNombreArchivo, v_handle);
    lbAbrirUtlFile := FALSE;
  END IF;

  IF interfazRecord.COUNT > 0 THEN
    FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
      lsLinea := interfazRecord(x).codigoTipoReemplazo ||';'|| interfazRecord(x).descripcionTipoReemplazo;
      utl_file.put_line(v_handle, lslinea);
    END LOOP;
  END IF;
 EXIT WHEN c_interfaz%NOTFOUND;
 END LOOP;
 CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
   utl_file.fclose(v_handle);
   /* Procedimiento final para generar interfaz */
   gen_pkg_inter_archi.gen_pr_final_inter('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
 END IF;
 RETURN;

 EXCEPTION
 WHEN OTHERS THEN
    ln_sqlcode := sqlcode;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_TIPO_REEMP: '||ls_sqlerrm);
 END INT_PR_DAT_ENVIO_TIPO_REEMP;


/***************************************************************************
Descripcion : Interfaz que envia interface de control que confirme la
              correcta ejecucion del paquete DATAMART - VENTAS
Fecha Creacion : 10/07/2014
Autor : Sergio Apaza
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_LOTE_CONTR
 (psCodigoPais            VARCHAR2,
  psCodigoSistema         VARCHAR2,
  psCodigoInterfaz        VARCHAR2,
  psNombreArchivo         VARCHAR2,
  psFechaProceso          VARCHAR2,
  psCodigoPaquete         VARCHAR2)
IS

 /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo BAS_INTER.DIR_TEMP%TYPE;
  w_filas NUMBER := 1000 ;
  v_handle UTL_FILE.FILE_TYPE;
  lsLinea VARCHAR2(1000);
  lbAbrirUtlFile BOOLEAN;
  lsNombreArchivo VARCHAR2(50);
  lsFechaProceso  VARCHAR2(8);
  lsNumeroLote    VARCHAR2(20);
  lnConError      NUMBER;

BEGIN
  lsFechaProceso := TO_CHAR(TO_DATE(psFechaProceso,'dd/MM/yyyy'),'yyyyMMdd');

  --Obtenemos el ultimo Numero de Lote generado
  BEGIN
    SELECT MAX(NUM_LOTE)
      INTO lsNumeroLote
      FROM BAS_HISTO_LOTES
     WHERE PAIS_COD_PAIS = psCodigoPais
       AND INPA_COD_INTE = psCodigoPaquete;
      -- AND SUBSTR(NUM_LOTE,1,8) = lsFechaProceso;
  EXCEPTION
    WHEN OTHERS THEN
      lsNumeroLote := NULL;
  END;

  --Validamos si todas las Interfaces del paquete se ejecutaron correctamente - SIN ERRORES
  SELECT COUNT(1)
    INTO lnConError
    FROM BAS_HISTO_LOTES
   WHERE PAIS_COD_PAIS = psCodigoPais
     AND SIST_COD_SIST = 'DAT'
     AND INPA_COD_INTE = psCodigoPaquete
     AND NUM_LOTE = lsNumeroLote
     AND (IND_LOER = 'S' OR DES_ERRO IS NOT NULL);

  lbAbrirUtlFile := TRUE;
  /* Procedimiento inicial para generar interfaz */
  IF lbAbrirUtlFile THEN
    gen_pkg_inter_archi.gen_pr_inici_inter(psCodigoPais, psCodigoSistema, psCodigoInterfaz, psNombreArchivo, lsDirTempo, lsNombreArchivo, v_handle);
    lbAbrirUtlFile := FALSE;
  END IF;

  IF((lsNumeroLote IS NOT NULL) AND (lnConError=0)) THEN
    /* Generando Archivo de Texto (Detalle) */

    lsLinea := lsNumeroLote;
    utl_file.put_line(v_handle, lsLinea);

  END IF;

  IF NOT lbAbrirUtlFile THEN
   utl_file.fclose(v_handle);
   /* Procedimiento final para generar interfaz */
   gen_pkg_inter_archi.gen_pr_final_inter('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;

  EXCEPTION
    WHEN OTHERS THEN
      ln_sqlcode := sqlcode;
      ls_sqlerrm := substr(sqlerrm,1,1000);
      raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_LOTE_CONTR: '||ls_sqlerrm);
  END INT_PR_DAT_ENVIO_LOTE_CONTR;

/***************************************************************************
Descripcion : Interfaz que envia parametros de Ranking de LET 2014 (DAT-167)
Fecha Creacion : 23/07/2013
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RANKI_NIVEL
 ( psCodigoPais            VARCHAR2,
   psCodigoPeriodo         VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 )
IS
CURSOR c_Interfaz (vsCodigoPrograma VARCHAR2) IS
SELECT lprk.pais_cod_pais CodPais,
       lprk.cam_inic AnioCampanaIni,
       lprk.cam_fina AnioCampanaFin,
       TRIM(TO_CHAR(TO_NUMBER(lprk.cod_tipo_medi))) TipoOrden,
       TRIM(TO_CHAR(TO_NUMBER(lprk.ltrk_cod_tipo_rank))) TipoDesempenio,
       DECODE(lprk.cod_tipo_medi,'01','CUMPLIMIENTO','02','SOBRECUMPLIMIENTO') DesTipoOrden,
       ltrk.des_tipo_rank DesTipoDesempenio,
       lprn.cod_nive_mini MinCodNivel,
       lprn.cod_nive_maxi MaxCodNivel,
       lprk.num_camp_incu NroCampIncumpliendo
  FROM lec_progr_ranki lprk,
       (
        SELECT pais_cod_pais,
               lpro_cod_prog,
               ltrk_cod_tipo_rank,
               lprk_num_secu,
               MIN(lniv_cod_nive) cod_nive_mini,
               MAX(lniv_cod_nive) cod_nive_maxi
          FROM lec_progr_ranki_nivel
         GROUP BY pais_cod_pais,
                  lpro_cod_prog,
                  ltrk_cod_tipo_rank,
                  lprk_num_secu
       ) lprn,
       lec_tipo_ranki ltrk
 WHERE lprk.pais_cod_pais = lprn.pais_cod_pais
   AND lprk.lpro_cod_prog = lprn.lpro_cod_prog
   AND lprk.ltrk_cod_tipo_rank = lprn.ltrk_cod_tipo_rank
   AND lprk.num_secu = lprn.lprk_num_secu
   AND lprk.ltrk_cod_tipo_rank = ltrk.cod_tipo_rank
   --
   AND lprk.ind_acti = '1'
   AND lprk.pais_cod_pais = psCodigoPais
   AND lprk.lpro_cod_prog = vsCodigoPrograma
     ;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;
lsLinea         VARCHAR2(1000);
lsNombreArchivo VARCHAR2(50);
lsCodigoPrograma lec_progr.cod_prog%TYPE;

BEGIN
-- Inicializa variables
  lbAbrirUtlFile := TRUE;

-- Obtiene programa activo
BEGIN
   SELECT lpro.cod_prog
     INTO lsCodigoPrograma
     FROM lec_progr lpro
    WHERE psCodigoPeriodo BETWEEN lpro.cam_inic AND NVL(lpro.cam_fin,psCodigoPeriodo)
      AND lpro.ind_acti = '1'
        ;
EXCEPTION WHEN OTHERS THEN
   lsCodigoPrograma := '';
END;

-- Procedimiento inicial para generar interfaz
   IF lbAbrirUtlFile THEN
       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER( psCodigoPais,
                                               psCodigosistema,
                                               psCodigoInterfaz,
                                               psNombreArchivo,
                                               lsDirTempo,
                                               lsNombreArchivo,
                                               V_HANDLE );
       lbAbrirUtlFile := FALSE;
   END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz(lsCodigoPrograma);
    LOOP

      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      IF interfazRecord.COUNT > 0 THEN

         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

             lsLinea := interfazRecord(x).CodPais ||';'||
                        interfazRecord(x).AnioCampanaIni ||';'||
                        interfazRecord(x).AnioCampanaFin ||';'||
                        interfazRecord(x).TipoOrden ||';'||
                        interfazRecord(x).TipoDesempenio ||';'||
                        interfazRecord(x).DesTipoOrden ||';'||
                        interfazRecord(x).DesTipoDesempenio ||';'||
                        interfazRecord(x).MinCodNivel ||';'||
                        interfazRecord(x).MaxCodNivel ||';'||
                        interfazRecord(x).NroCampIncumpliendo;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

        END LOOP;
      END IF;

      EXIT WHEN c_interfaz%NOTFOUND;

    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
  EXCEPTION
    WHEN OTHERS THEN
      ln_sqlcode := sqlcode;
      ls_sqlerrm := substr(sqlerrm,1,1000);
      raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_RANKI_NIVEL: '||ls_sqlerrm);
  END INT_PR_DAT_ENVIO_RANKI_NIVEL;

/***********************************************************************
Descripcion       : Genera Interfaz de Envio Descuentos Nuevas (DAT-168 )
Fecha Creacion    : 22/08/2013
Autor             : Juan Gutierrez
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Sistema
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_DESCU_NUEVA

  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS

   CURSOR c_interfaz IS
       SELECT NV.PROG_COD_PROG,
            NV.COD_CLIE,
            NV.CAM_ASIG,
            NV.MON_DESC,
            PD.MON_VENT_EXIG,
            NV.EST_DESC
       FROM NVS_CLIEN_DESCU NV,
            NVS_PARAM_DESCU PD
      WHERE PD.PROG_COD_PROG = NV.PROG_COD_PROG
        AND NV.NIVE_COD_NIVE = PD.NIVE_COD_NIVE
        AND NV.CAM_PROC =  psCodigoPeriodo
        AND NV.EST_REGI <> 9;

   TYPE interfazRec IS RECORD
      (
        codPrograma         NVS_CLIEN_DESCU.PROG_COD_PROG%TYPE,
        codCliente          NVS_CLIEN_DESCU.COD_CLIE%TYPE ,
        camAsign            NVS_CLIEN_DESCU.Cam_Asig%TYPE,
        monDescu            NVS_CLIEN_DESCU.Mon_Desc%TYPE,
        monVtaExig          NVS_PARAM_DESCU.Mon_Vent_Exig%TYPE,
        estDescu            NVS_CLIEN_DESCU.EST_DESC%TYPE
      );

   TYPE interfazRecTab  IS TABLE OF interfazRec;
   interfazRecord interfazRecTab;

     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      lsLinea :=  interfazRecord(x).codPrograma    ||';'||
                                  interfazRecord(x).codCliente     ||';'||
                                  interfazRecord(x).camAsign       ||';'||
                                  interfazRecord(x).monDescu       ||';'||
                                  interfazRecord(x).monVtaExig     ||';'||
                                  interfazRecord(x).estDescu       ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_DESCU_NUEVA: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_DESCU_NUEVA;

/***************************************************************************
Descripcion : Interfaz que envia consultoras excluidas LET 2014 (DAT-169)
Fecha Creacion : 29/08/2014
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_CONSU_EXCLU
 ( psCodigoPais            VARCHAR2,
   psCodigoPeriodo         VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 )
IS

CURSOR c_Interfaz (vsCodigoPrograma VARCHAR2) IS

SELECT psCodigoPeriodo AnioCampana,
       lpex.cod_cons CodEbelista
  FROM lec_progr_lista_exclu lpex
 WHERE lpex.pais_cod_pais = psCodigoPais
   AND lpex.lpro_cod_prog = vsCodigoPrograma
   AND psCodigoPeriodo BETWEEN lpex.cam_inic_vige AND lpex.cam_fin_vige
     ;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo      BAS_INTER.DIR_TEMP%TYPE;
v_hANDle        UTL_FILE.FILE_TYPE;
lbAbrirUtlFile  BOOLEAN;
lsLinea         VARCHAR2(1000);
lsNombreArchivo VARCHAR2(50);
lsCodigoPrograma lec_progr.cod_prog%TYPE;

BEGIN
-- Inicializa variables
  lbAbrirUtlFile := TRUE;

-- Obtiene programa activo
BEGIN
   SELECT lpro.cod_prog
     INTO lsCodigoPrograma
     FROM lec_progr lpro
    WHERE psCodigoPeriodo BETWEEN lpro.cam_inic AND NVL(lpro.cam_fin,psCodigoPeriodo)
      AND lpro.ind_acti = '1'
        ;
EXCEPTION WHEN OTHERS THEN
   lsCodigoPrograma := '';
END;

-- Procedimiento inicial para generar interfaz
   IF lbAbrirUtlFile THEN
       GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER( psCodigoPais,
                                               psCodigosistema,
                                               psCodigoInterfaz,
                                               psNombreArchivo,
                                               lsDirTempo,
                                               lsNombreArchivo,
                                               V_HANDLE );
       lbAbrirUtlFile := FALSE;
   END IF;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz(lsCodigoPrograma);
    LOOP

      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      IF interfazRecord.COUNT > 0 THEN

         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

             lsLinea := interfazRecord(x).AnioCampana ||';'||
                        interfazRecord(x).CodEbelista
                        ;

             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );

        END LOOP;
      END IF;

      EXIT WHEN c_interfaz%NOTFOUND;

    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
  EXCEPTION
    WHEN OTHERS THEN
      ln_sqlcode := sqlcode;
      ls_sqlerrm := substr(sqlerrm,1,1000);
      raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_CONSU_EXCLU: '||ls_sqlerrm);
  END INT_PR_DAT_ENVIO_CONSU_EXCLU;

/***************************************************************************
Descripcion : Interfaz que envia Fechas de Entrega Exactas (DAT-170)
Fecha Creacion : 10/09/2014
Autor : Carlos Bazalar
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_FECHA_ENTRE
 ( psCodigoPais            VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2 )
IS

CURSOR c_Interfaz IS
SELECT
  num_docu ,
  TO_CHAR(fec_proc,'YYYYMMDD') fec_proc
FROM
 (SELECT ot.num_docu,
         ot.fec_proc,
         dd.fec_digi,
             Max(dd.fec_digi) Over(Partition By ot.num_docu) As max_fec_digi
    from (
               SELECT *
               FROM int_solic_conso_orden_trans
               UNION
               SELECT s.*
               FROM int_histo_conso_orden_trans s) ot,
                     (SELECT *
                      FROM sto_docum_digit
                      UNION
                      SELECT *
                      FROM sto_histo_docum_digit) dd
               where dd.sec_nume_docu = ot.sec_nume_docu
                 AND dd.cod_tipo_docu = 'OT'
                 AND dd.ind_envi IN (SELECT val_param
                                       FROM sto_param_gener_occrr
                                      WHERE cod_para LIKE 'STO_IND_OT%')

                 and dd.ind_rech = 0
                 and ot.cod_clie is not null
                     AND (trunc(dd.fec_digi) >=  to_date(psFechaProceso,'dd/mm/yyyy') - 4)
              AND trunc(dd.fec_digi) <= to_date(psFechaProceso,'dd/mm/yyyy')
   )
WHERE
  fec_digi = max_fec_digi ;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
v_hANDle         UTL_FILE.FILE_TYPE;
lbAbrirUtlFile   BOOLEAN;
lsLinea          VARCHAR2(1000);
lsNombreArchivo  VARCHAR2(50);
lsCodigoPrograma lec_progr.cod_prog%TYPE;
wexiste          NUMBER;

BEGIN
  -- Inicializa variables
  lbAbrirUtlFile := TRUE;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz;
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      -- Procedimiento inicial para generar interfaz
      IF lbAbrirUtlFile THEN
           GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER( psCodigoPais,
                                                   psCodigosistema,
                                                   psCodigoInterfaz,
                                                   psNombreArchivo,
                                                   lsDirTempo,
                                                   lsNombreArchivo,
                                                   V_HANDLE );
           lbAbrirUtlFile := FALSE;
      END IF;
      IF interfazRecord.COUNT > 0 THEN
         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP

             /* condicion de validacion de documento  */
             wexiste := 0;
             select count(1)
             into wexiste
             from
                ped_solic_cabec sc,
                ped_solic_cabec con,
                ped_tipo_solic ts,
                ped_tipo_solic_pais tsp
              where sc.soca_oid_soli_cabe=con.oid_soli_cabe
                      and tsp.tsol_oid_tipo_soli = ts.oid_tipo_soli
                      and ts.cod_tipo_soli='SOC'
                      and sc.tspa_oid_tipo_soli_pais = tsp.oid_tipo_soli_pais
                      and con.fec_fact is not null
                      and sc.perd_oid_peri = con.perd_oid_peri
                      and con.val_nume_soli = interfazRecord(x).num_docu;

             /* Insertando Linea */
             IF (wexiste > 0) THEN
             lsLinea := interfazRecord(x).num_docu ||';'||
                            interfazRecord(x).fec_proc ;
             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
             END IF;
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
WHEN OTHERS THEN
      ln_sqlcode := sqlcode;
      ls_sqlerrm := substr(sqlerrm,1,1000);
      raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_FECHA_ENTRE: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_FECHA_ENTRE;

/***************************************************************************
Descripcion : Interfaz que envia Estado de Programas (DAT-xxx)
Fecha Creacion : 13/07/2015
Autor : Carlos Mori
Parametros:
 psCodigoPais : Codigo de Pais
 psCodigoSistema : Codigo de Empresa
 psCodigoInterfaz : Codigo de Interfaz
 psNombreArchivo : Nombre Archivo
 psFechaProceso : Fecha Proceso
***************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_ESTAD_PROGR
 ( psCodigoPais            VARCHAR2,
   psCodigoSistema         VARCHAR2,
   psCodigoInterfaz        VARCHAR2,
   psNombreArchivo         VARCHAR2,
   psFechaProceso          VARCHAR2
 )
IS

CURSOR c_Interfaz (vsIndProgActi VARCHAR2) IS
SELECT '001' codPrograma,
       'Estimados FFVV Seccin' desPrograma,
       vsIndProgActi estadoPrograma
  FROM DUAL;

TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
interfazRecord c_Interfaz_t;

-- Variables usadas para la generacion del archivo de texto
lsDirTempo       BAS_INTER.DIR_TEMP%TYPE;
v_hANDle         UTL_FILE.FILE_TYPE;
lbAbrirUtlFile   BOOLEAN;
lsLinea          VARCHAR2(1000);
lsNombreArchivo  VARCHAR2(50);
lsCodigoPrograma lec_progr.cod_prog%TYPE;
lsindProgActi    VARCHAR2(1);

BEGIN
  -- Inicializa variables
  lbAbrirUtlFile := TRUE;

  -- Busca valor de indicador de programa activo en el pas
    BEGIN
      SELECT VAL_PARA
        INTO lsindProgActi
        FROM BAS_PARAM_PAIS
       WHERE COD_PAIS = psCodigoPais
         AND COD_SIST = 'FVP'
         AND UPPER(NOM_PARA) = 'INDPROGACTI';
    EXCEPTION WHEN NO_DATA_FOUND THEN
      lsindProgActi :='0';
    END;

  -- Generando Archivo de Texto (Detalle)
  OPEN c_interfaz(lsindProgActi);
    LOOP
      FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT w_filas;

      -- Procedimiento inicial para generar interfaz
      IF lbAbrirUtlFile THEN
           GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER( psCodigoPais,
                                                   psCodigosistema,
                                                   psCodigoInterfaz,
                                                   psNombreArchivo,
                                                   lsDirTempo,
                                                   lsNombreArchivo,
                                                   V_HANDLE );
           lbAbrirUtlFile := FALSE;
      END IF;
      IF interfazRecord.COUNT > 0 THEN
         FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
             lsLinea := interfazRecord(x).codPrograma ||';'||
                        interfazRecord(x).desPrograma ||';'||
                        interfazRecord(x).estadoPrograma
                        ;
             UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
        END LOOP;
      END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
    END LOOP;
  CLOSE c_interfaz;

  /* Procedimiento final para generar interfaz */
  IF NOT lbAbrirUtlFile THEN
     utl_file.fclose(V_HANDLE);
     GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
  END IF;
EXCEPTION
WHEN OTHERS THEN
      ln_sqlcode := sqlcode;
      ls_sqlerrm := substr(sqlerrm,1,1000);
      raise_application_error(-20123, 'ERROR INT_PR_DAT_ENVIO_ESTAD_PROGR: '||ls_sqlerrm);
END INT_PR_DAT_ENVIO_ESTAD_PROGR;





/*************************************************************************
  Descripcion       : Genera Interfaz de Envio Recuperacion Cobranza (DAT-176)
Fecha Creacion    : 29/08/2015
Parametros:
 psCodigoPais     : Codigo Pais
 psCodigoPeriodo  : Anho Periodo
 psCodigoSistema  : Codigo Sistema
 psCodigoInterfaz : Codigo Interfaz
 psNombreArchivo  : Nombre Archivo

Autor: Juan Carlos Gutirrez
***************************************************************************/
PROCEDURE INT_PR_LET_ENVIO_RECUP_COBRA(
  psCodigoPais 		  VARCHAR2,
  psCodigoPeriodo	  VARCHAR2,
  psCodigoSistema 	VARCHAR2,
  psCodigoInterfaz 	VARCHAR2,
  psNombreArchivo 	VARCHAR2)
IS

  CURSOR c_interfaz IS

    SELECT cbz.cod_peri,
         cbz.cod_regi,
         cbz.cod_zona,
         cbz.cod_secc,
         SUM(cbz.imp_fact_neto) imp_fact_neto,
         SUM(cbz.cob_dias_21) cob21,
         SUM(CASE
               WHEN cbz.fec_cier_vent IS NULL THEN
                cbz.cob_dias_31
               ELSE
                cbz.cob_dias_vent
             END) cob31,
         SUM(cbz.cob_dias_36) cob36
    from cob_repor_estad_recup_cobra cbz
    WHERE cbz.cod_peri >=
         cup_pkg_prog_nuevas.gen_fn_dev_nsgte_campa((SELECT COD_PERI
                                                      FROM BAS_CTRL_FACT
                                                     WHERE STA_CAMP = 0
                                                       AND IND_CAMP_ACT = 1)
                                                       , -3)
    GROUP BY cbz.cod_peri, cbz.cod_regi, cbz.cod_zona, cbz.cod_secc
    ORDER BY 1, 2, 3, 4 ASC;

  TYPE interfazRec IS RECORD(
    CodPeri	 		  cob_repor_estad_recup_cobra.Cod_Peri%TYPE,
    CodRegio	 		cob_repor_estad_recup_cobra.cod_regi%TYPE,
    CodZona       cob_repor_estad_recup_cobra.Cod_Zona%TYPE,
    CodSecci      cob_repor_estad_recup_cobra.Cod_Secc%TYPE,
    ImpNeto	 		  cob_repor_estad_recup_cobra.Imp_Fact_Neto%TYPE,
    ImpCob21      cob_repor_estad_recup_cobra.cob_dias_21%TYPE,
    ImpCob31      cob_repor_estad_recup_cobra.cob_dias_31%TYPE,
    ImpCob36      cob_repor_estad_recup_cobra.cob_dias_36%TYPE
	);

  TYPE interfazRecTab  IS TABLE OF interfazRec ;
  interfazRecord interfazRecTab;

  /* Variables usadas para la generacion del archivo de texto */
  lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
  v_hANDle            UTL_FILE.FILE_TYPE;
  lbAbrirUtlFile      BOOLEAN;

  lsLinea                     VARCHAR2(1000);
  lsNombreArchivo             VARCHAR2(50);

BEGIN

  lbAbrirUtlFile := TRUE;

  /* Generando Archivo de Texto (Detalle) */
  OPEN c_interfaz;
	  LOOP
	    FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;

			/* Procedimiento inicial para generar interfaz */
      IF lbAbrirUtlFile THEN
        GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigoSistema, psCodigoInterfaz,
                                               psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
        lbAbrirUtlFile := FALSE;
      END IF;

      IF interfazRecord.COUNT > 0 THEN

        FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
		      lsLinea :=  interfazRecord(x).CodPeri             ||';'||
                      interfazRecord(x).CodRegio            ||';'||
                      interfazRecord(x).CodZona             ||';'||
                      interfazRecord(x).CodSecci            ||';'||
                      interfazRecord(x).ImpNeto             ||';'||
                      interfazRecord(x).ImpCob21            ||';'||
                      interfazRecord(x).ImpCob31            ||';'||
                      interfazRecord(x).ImpCob36            ;

				  UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
		    END LOOP;
		  END IF;
      EXIT WHEN c_interfaz%NOTFOUND;
	  END LOOP;
  CLOSE c_interfaz;

  IF NOT lbAbrirUtlFile THEN
	  utl_file.fclose(V_HANDLE);
	  /* Procedimiento final para generar interfaz */
	  GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DIR', lsDirTempo, psNombreArchivo, lsNombreArchivo);
	END IF;

  RETURN;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(sqlerrm,1,1000);
    RAISE_APPLICATION_ERROR(-20123, 'INT_PR_LET_ENVIO_RECUP_COBRA: '||ls_sqlerrm);



END INT_PR_LET_ENVIO_RECUP_COBRA;

/**************************************************************************
  Descripcion       : Ejecuta Validaciones Previas a la ejecucion de interfaces
  Fecha Creacion    : 13/01/2016
  Parametros Entrada:
  psCodigoPais   : Codigo de pais
  Autor             : Jose Cairampoma
  ***************************************************************************/
FUNCTION int_fn_dat_valid_previ(pscodigopais VARCHAR2) RETURN VARCHAR2 IS

  CURSOR c_validacion IS
    SELECT cod_para,
           val_para
      FROM bas_param_pais
     WHERE cod_pais = pscodigopais
       AND cod_sist = 'DAT'
       AND nom_para = 'validacionDAT';

  TYPE t_cod_para IS TABLE OF bas_param_pais.cod_para%TYPE;
  TYPE t_val_para IS TABLE OF bas_param_pais.val_para%TYPE;

  v_cod_para t_cod_para;
  v_val_para t_val_para;

  rows NATURAL := 5000; -- Numero de filas a procesar cada vez
  i    BINARY_INTEGER := 0;

  lnunidadmiduplicada NUMBER;

  lsvalor VARCHAR2(4000) := NULL;

BEGIN

  OPEN c_validacion;
  LOOP
    FETCH c_validacion BULK COLLECT
      INTO v_cod_para,
           v_val_para LIMIT w_filas;

    IF v_cod_para.count > 0 THEN

      -- Actualizamos Documentos Validados OK
      FOR i IN v_cod_para.first .. v_cod_para.last
      LOOP
        --- Valida que no existan UA activas duplicadas
        IF v_cod_para(i) = '001' THEN

          SELECT COUNT(1)
            INTO lnunidadmiduplicada
            FROM (SELECT clie_oid_clie,
                         SUM(ind_acti)
                    FROM mae_clien_unida_admin
                   GROUP BY clie_oid_clie
                  HAVING SUM(ind_acti) > 1);

          SELECT COUNT(1)
            INTO lnunidadmiduplicada
            FROM (SELECT clie_oid_clie
                    FROM mae_clien_unida_admin
                   WHERE ind_acti = 1
                   GROUP BY clie_oid_clie
                  HAVING COUNT(1) > 1);

          IF lnunidadmiduplicada > 0 THEN
            RETURN v_val_para(i);

          END IF;
        END IF;

      END LOOP;
    END IF;
    EXIT WHEN c_validacion%NOTFOUND;

  END LOOP;
  CLOSE c_validacion;

  RETURN lsvalor;

EXCEPTION
  WHEN OTHERS THEN
    ln_sqlcode := SQLCODE;
    ls_sqlerrm := substr(SQLERRM, 1, 1000);
    raise_application_error(-20123,
                            'ERROR INT_FN_DAT_VALID_PREVI: ' || ls_sqlerrm);
END int_fn_dat_valid_previ;


/***********************************************************************
Descripcion       : Genera Interfaz de Envio Rango de Comisiones (DAT-177 )
Fecha Creacion    : 09/02/2016
Autor             : Carlos Bazalar
************************************************************************/
PROCEDURE INT_PR_DAT_ENVIO_RANGO_COMIS
  (psCodigoPais             VARCHAR2,
   psCodigoSistema          VARCHAR2,
   psCodigoInterfaz         VARCHAR2,
   psNombreArchivo          VARCHAR2,
   psCodigoPeriodo          VARCHAR2)

IS
   CURSOR c_interfaz IS
     SELECT pnra.lpro_cod_prog CodPrograma,
           pntr.lniv_cod_nive CodNivel,
           CASE
              WHEN pnra.cod_nive_rang = 'A' THEN 'ALTO'
              WHEN pnra.cod_nive_rang = 'B' THEN 'BAJO'
              ELSE NULL
           END TipoValor,
           TO_NUMBER( pnra.cod_rang ) CodRango,
           pntr.val_porc_comi_pedi_cons PorcComision,
           pnra.val_mont_mini MontoIni,
           pnra.val_mont_maxi MontoFin
      FROM LEC_PROGR_NIVEL_TRAMO pntr,
           LEC_PROGR_NIVEL_RANGO pnra,
           LEC_PROGR lpro
    WHERE  pntr.pais_cod_pais = pnra.pais_cod_pais
       AND pntr.lpro_cod_prog = pnra.lpro_cod_prog
       AND pntr.pnra_cod_rang = pnra.cod_rang
       --
       AND pnra.pais_cod_pais = lpro.pais_cod_pais
       AND pnra.lpro_cod_prog = lpro.cod_prog
       --
       AND psCodigoPeriodo BETWEEN lpro.cam_inic AND NVL( lpro.cam_fin, psCodigoPeriodo )
       AND lpro.ind_acti = '1'
    ORDER BY 1,2,3, 6;

   TYPE c_Interfaz_t IS TABLE OF c_Interfaz%ROWTYPE INDEX BY BINARY_INTEGER;
   interfazRecord c_Interfaz_t;
   
     /* Variables usadas para la generacion del archivo de texto */
   lsDirTempo          BAS_INTER.DIR_TEMP%TYPE;
   v_handle            UTL_FILE.FILE_TYPE;

   lsLinea             VARCHAR2(1000);
   lsNombreArchivo     VARCHAR2(50);
   lbAbrirUtlFile      BOOLEAN;
   lsMontoAlto         VARCHAR2(50);
   lnMontoAlto         LEC_PROGR_NIVEL_RANGO.Val_Mont_Maxi%TYPE;
   lsCodigoPrograma    VARCHAR2(100);
   lsCodNivel          VARCHAR2(100);
   lsTipoValor         VARCHAR2(100);
   lnSecuencia         NUMBER;
BEGIN

    lbAbrirUtlFile:= TRUE;
  /* Generando Archivo de Texto (Detalle) */
    lsCodigoPrograma := '-1';
    lsCodNivel := '-1';
    lsTipoValor := '-1';
    lnSecuencia := 1;
    OPEN c_interfaz;
        LOOP
           FETCH c_interfaz BULK COLLECT INTO interfazRecord LIMIT W_FILAS;             /* Procedimiento inicial para generar interfaz */

             IF lbAbrirUtlFile THEN
               GEN_PKG_INTER_ARCHI.GEN_PR_INICI_INTER(psCodigoPais, psCodigosistema, psCodigoInterfaz,psNombreArchivo, lsDirTempo, lsNombreArchivo, V_HANDLE);
               lbAbrirUtlFile := FALSE;
             END IF;

               IF interfazRecord.COUNT > 0 THEN
                  
                  FOR x IN interfazRecord.FIRST .. interfazRecord.LAST LOOP
                      IF (lsCodigoPrograma != interfazRecord(x).CodPrograma OR
                          lsCodNivel != interfazRecord(x).CodNivel OR
                          lsTipoValor != interfazRecord(x).TipoValor) THEN
                          
                          lsCodigoPrograma := interfazRecord(x).CodPrograma;
                          lsCodNivel := interfazRecord(x).CodNivel;
                          lsTipoValor := interfazRecord(x).TipoValor;
                          lnSecuencia := 1;
                          
                      END IF;
                      lsLinea :=  interfazRecord(x).CodPrograma   ||';'||
                                  interfazRecord(x).CodNivel      ||';'||
                                  interfazRecord(x).TipoValor     ||';'||
                                  lnSecuencia      ||';'||
                                  trim(to_char(interfazRecord(x).PorcComision, '999999999.99'))  ||';'||
                                  trim(to_char(interfazRecord(x).MontoIni, '999999999.99'))      ||';'||
                                  trim(to_char(interfazRecord(x).MontoFin, '999999999.99'))         ;

                      UTL_FILE.PUT_LINE (V_HANDLE, lslinea );
                      lnSecuencia := lnSecuencia + 1;
                  END LOOP;
               END IF;
           EXIT WHEN c_interfaz%NOTFOUND;
        END LOOP;
    CLOSE c_interfaz;

    IF NOT lbAbrirUtlFile THEN
       utl_file.fclose(V_HANDLE);
    /* Procedimiento final para generar interfaz */
       GEN_PKG_INTER_ARCHI.GEN_PR_FINAL_INTER('SICC_DAT', lsDirTempo, psNombreArchivo, lsNombreArchivo);
    END IF;


EXCEPTION
WHEN OTHERS THEN
     ln_sqlcode := SQLCODE;
     ls_sqlerrm := substr(sqlerrm,1,1000);
     RAISE_APPLICATION_ERROR(-20123, 'ERROR INT_PR_DAT_ENVIO_RANGO_COMIS: '||ls_sqlerrm);

END INT_PR_DAT_ENVIO_RANGO_COMIS;

END INT_PKG_DATAM;
/
